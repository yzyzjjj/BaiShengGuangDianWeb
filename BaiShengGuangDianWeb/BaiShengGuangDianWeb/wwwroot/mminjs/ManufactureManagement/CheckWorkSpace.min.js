function pageReady(){_permissionList[400]={uIds:["getCheckTaskBtn"]};_permissionList[401]={uIds:["startBtn"]};_permissionList[402]={uIds:["pauseBtn"]};_permissionList[403]={uIds:[]};_permissionList[404]={uIds:["getAccountCheckTaskBox"]};_permissionList=checkPermissionUi(_permissionList);_have404=_permissionList[404].have;$(".ms2").select2();$(".table-bordered td").css("border","1px solid");_have404?getGroup():getCheckTask();$("#imgOldList").on("click",".delImg",function(){$(this).parents(".imgOption").remove();var n=$(this).val();_imgNameData.splice(_imgNameData.indexOf(n),1)});$("#groupSelect").on("select2:select",function(){getProcessor(!1)})}function getGroup(){var n={};n.opType=1077;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$("#groupSelect").empty();var r=n.datas,u="";for(t=0,f=r.length;t<f;t++)i=r[t],u+='<option value = "{0}">{1}<\/option>'.format(i.Id,i.Group);$("#groupSelect").append(u);getProcessor(!0)})}function getProcessor(n){var i=$("#groupSelect").val(),t={};t.opType=1081;t.opData=JSON.stringify({groupId:i,menu:!0});ajaxPost("/Relay/Post",t,function(t){var i,e,r;if(t.errno!=0){layer.msg(t.errmsg);return}$("#processorSelect").empty();var u=t.datas,f="";for(i=0,e=u.length;i<e;i++)r=u[i],f+='<option value="{0}">{1}<\/option>'.format(r.Account,r.Processor);$("#processorSelect").append(f);n&&getCheckTask()})}function getCheckTask(){var n,t,i;if(_have404){if(n=$("#processorSelect").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择操作员");return}t=$("#groupSelect").val()||0}else n=_admin,t=0;_taskData={Account:n,GId:t};i={};i.opType=1012;i.opData=JSON.stringify({account:n,gId:t});ajaxPost("/Relay/Post",i,function(n){var t,i;if(getCheckList(0,"#waitCheckList"),getCheckList(1,"#passCheckList"),getCheckList(2,"#redoCheckList"),getCheckList(3,"#blockCheckList"),$("#checkDetailBox").removeClass("hidden"),n.errno!=0){layer.msg(n.errmsg);$("#startBtn,#pauseBtn,#boxContext").addClass("hidden");return}$("#startBtn,#pauseBtn,#boxContext").removeClass("hidden");t=n.datas[0];_taskData.TaskId=t.Id;i=t.State;$("#startBtn").prop("disabled",!(i==2||i==7));$("#pauseBtn").prop("disabled",i!=8);i==8&&_permissionList[403].have?$(".finish").removeClass("hidden"):$(".finish").addClass("hidden");$("#check").text(t.Check);$("#plan").text(t.Plan);$("#item").text(t.Item);$("#processor").text(t.Processor);$("#checkProcessor").text(t.CheckProcessor);$("#estimatedTime").text(t.EstimatedTime);$("#actualStartTime").text(noShowSecond(t.ActualStartTime));$("#actualEndTime").text(noShowSecond(t.ActualEndTime));$("#score").text(t.Score);$("#actualTime").text(t.ActualTime);var r=function(n,t,i,r){return r.row+1},u=function(n){return`<textarea class="form-control desc" style="resize: vertical;margin:auto;width:200px" ${i!=8?"disabled":""}>${n==null?"":n}</textarea>`},f=function(n){var t=n.Result;return'<button type="button" class="btn btn-primary btn-{1} btn-sm" onclick="updateCheckTask.call(this,{0},1)" {3}>通过<\/button><button type="button" class="btn btn-primary btn-{2} btn-sm" onclick = "updateCheckTask.call(this,{0},2)" {3}>不通过<\/button>'.format(n.Id,t==1?"success":"info",t==2?"danger":"info",i!=8?"disabled":"")},e=function(){return`<input type="text" class="form_date form-control text-center checkTime" style="width:120px;cursor: pointer" ${i!=8?"disabled":""}>`},o=function(n){return`<button type="button" class="btn btn-primary btn-sm" onclick="showImgModel('${n.ImageList}',${n.Id})" ${i!=8?"disabled":""}>查看</button>`};$("#checkTaskList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.Items,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:r},{data:"Item",title:"检验流程"},{data:"Method",title:"检验要求"},{data:"Desc",title:"检验说明",render:u,sClass:"no-padding"},{data:null,title:"检验时间",render:e},{data:null,title:"检验结果",render:f},{data:null,title:"图片",render:o}],createdRow:function(n,t){var i=t.CheckTime;i=i.slice(0,i.indexOf(" "));$(n).find(".form_date").attr("readonly",!0).val(i=="0001-01-01"?"":i).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0})}})})}function checkTaskHandle(n,t){var i=null,r;switch(n){case 0:i=1017;break;case 1:i=1018;break;case 2:i=1019;_taskData.CheckResult=t}r={};r.opType=i;r.opData=JSON.stringify(_taskData);ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);n.errno==0&&getCheckTask()})}function updateCheckTask(n,t){var u=$(this).parents("tr"),f=u.find(".desc").val(),i=u.find(".checkTime").val(),r;i=isStrEmptyOrUndefined(i)?getFullTime():`${i} 00:00:00`;r={};r.opType=1020;r.opData=JSON.stringify({CheckTime:i,Desc:f,Result:t,Id:n,ItemId:_taskData.TaskId});ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);n.errno==0&&getCheckTask()})}function showImgModel(n,t){if(_updateFirmwareUpload==null&&(_updateFirmwareUpload=initFileInputMultiple("addImg",fileEnum.Manufacture)),$("#addImg").fileinput("clear"),t!=null?($("#checkId").text(t),$(".noDetail").removeClass("hidden")):$(".noDetail").addClass("hidden"),$("#imgOld").empty(),$("#imgOldList").empty(),_imgNameData=[],isStrEmptyOrUndefined(n))$("#imgOld").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgOld").append("图片：");n=n.split(",");_imgNameData=n;var i={type:fileEnum.Manufacture,files:JSON.stringify(n)};ajaxPost("/Upload/Path",i,function(i){var f,u,r;if(i.errno!=0){layer.msg(i.errmsg);return}for(f=`<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6">
                    <div class="thumbnail">
                    <img src={0} style="height:200px">
                    <div class="caption text-center ${t==null?"hidden":""}">
                    <button type="button" class="btn btn-default glyphicon glyphicon-trash delImg" value="{1}"></button>
                    </div>
                    </div>
                    </div>`,u="",r=0;r<i.data.length;r++)u+=f.format(i.data[r].path,n[r]);$("#imgOldList").append(u)})}$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");$("#showImgModel").modal("show")}function updateImg(){fileCallBack[fileEnum.Manufacture]=function(n){var r,u,t,f,i;if(n.errno==0){r=[];for(u in n.data)r.push(n.data[u].newName);t=_imgNameData.concat(r);t=JSON.stringify(t);f=$("#checkId").text();i={};i.opType=1020;i.opData=JSON.stringify({Images:t,Id:f,ItemId:_taskData.TaskId});ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);$("#showImgModel").modal("hide");n.errno==0&&getCheckTask()})}};var n=function(){$("#addImg").fileinput("upload")};showConfirm("操作",n)}function getCheckList(n,t){var i=null,r;switch(n){case 0:i=1013;break;case 1:i=1014;break;case 2:i=1015;break;case 3:i=1016}r={};r.opType=i;r.opData=JSON.stringify({account:_taskData.Account,limit:10,gId:_taskData.GId});ajaxPost("/Relay/Post",r,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var i=n.datas,r=function(n,t,i,r){return r.row+1},u=function(n){return`<button type="button" class="btn btn-primary btn-sm" onclick="showDetailModel(${n})">查看</button>`};$(t).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:r},{data:"Item",title:"检验单名称"},{data:"Plan",title:"所属计划号"},{data:"Score",title:"任务绩效分"},{data:"Surveyor",title:"任务完成人"},{data:"Id",title:"任务流程",render:u}]})})}function showDetailModel(n){var t={};t.opType=1021;t.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=n.datas,i=function(n,t,i,r){return r.row+1},r=function(n){return noShowSecond(n)},u=function(n){return n.Result==0?n.ResultDesc:n.Result==1?"通过":"不通过"},f=function(n){return`<button type="button" class="btn btn-primary btn-sm" onclick="showImgModel('${n}')">查看</button>`};$("#showDetailList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:i},{data:"Item",title:"检验流程"},{data:"Method",title:"检验要求"},{data:"Desc",title:"检验说明"},{data:"CheckTime",title:"检验时间",render:r},{data:null,title:"检验结果",render:u},{data:"ImageList",title:"图片",render:f}]});$("#showDetailModel").modal("show")})}var _admin=getCookieTokenInfo().account,_permissionList=[],_have404=null,_taskData=null,_updateFirmwareUpload=null,_imgNameData=null;