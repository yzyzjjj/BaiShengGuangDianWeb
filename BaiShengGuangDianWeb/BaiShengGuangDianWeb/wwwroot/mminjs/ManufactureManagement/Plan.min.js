function pageReady(){_permissionList[419]={uIds:["showPlanModalBtn"]};_permissionList[453]={uIds:["addPlanBtn"]};_permissionList[454]={uIds:["planReuse"]};_permissionList[455]={uIds:["delPlanSelectBtn"]};_permissionList[420]={uIds:["delPlanConfigBtn"]};_permissionList[421]={uIds:["updatePlanConfigBtn"]};_permissionList[422]={uIds:[]};_permissionList[423]={uIds:[]};_permissionList[424]={uIds:["updatePlanTaskItemBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();getTaskConfig();getTaskState();var n=getMonthScope();$("#startTime").val(n.start).datepicker("update");$("#endTime").val(n.end).datepicker("update");window.onload=()=>{$("#startTime,#endTime").removeAttr("readonly")};$("#planConfigList").on("ifChanged",".isEnable",function(){var n=$(this).parents("tr"),u=$(this).val(),t,i,r;$(this).is(":checked")?(_planIdData.push(u),t=_planConfigData[u],n.find(".planName").val(t.Plan),i=t.PlannedStartTime,i=i.slice(0,i.indexOf(" ")),i=="0001-01-01"&&(i=""),r=t.PlannedEndTime,r=r.slice(0,r.indexOf(" ")),r=="0001-01-01"&&(r=""),n.find(".sTime").val(i).datepicker("update"),n.find(".eTime").val(r).datepicker("update"),n.find(".hour").val(t.EstimatedHour),n.find(".minute").val(t.EstimatedMin),n.find(".taskConfig").val(t.TaskId),n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden")):(_planIdData.splice(_planIdData.indexOf(u),1),n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"))});$("#planConfigList").on("change",".taskConfig",function(){var t=$(this).parents("tr").find(".isEnable").val(),n;$("#planItem").is(":hidden")||$("#planText").attr("planid")!=t||(n=$(this).val(),isStrEmptyOrUndefined(n)?$("#planItemList").empty():getTaskConfigItem(n,"#planItemList",0))});$("#planConfigList,#planItemList,#addPlanTaskList,#planTime").on("focus",".toZero",function(){var n=$(this).val();n==0&&$(this).val("")});$("#planConfigList,#planItemList,#addPlanTaskList,#planTime").on("blur",".toZero",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#planConfigList,#planItemList,#addPlanTaskList,#planTime").on("input",".minute",function(){var n=$(this).val();parseInt(n)>59&&$(this).val(59)});$("#planItemList,#addPlanTaskList").on("ifChanged",".isEnable",function(){var n=$(this).parents("tr"),t=$(this).val(),i=$("#showPlanModal").is(":hidden")?_planTaskItem[t]:_reusePlanTaskItem[t];$(this).is(":checked")?(n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden"),dataSetTr(n,i)):n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden")});$("#planItemList,#addPlanTaskList").on("select2:select",".group",function(){var n=$(this).val(),t=$(this).parents("tr").find(".processor");setProcessorSelect(n,t)});$("#planItemList,#addPlanTaskList").on("select2:select",".module",function(){var t=$(this).find("option:selected").attr("isCheck"),n=$(this).parents("tr");parseInt(t)?n.find(".taskName").addClass("hidden").siblings().removeClass("hidden"):n.find(".taskNameSelect").parent().addClass("hidden").siblings().removeClass("hidden")});$("#planItemList,#addPlanTaskList").on("click",".moveUp",function(){var n,f,i,c,s;_isUpMove=!1;var a=$(this).parents("tbody").prop("id"),t=$(this).parents("tr"),h=t.find(".relation"),v=h.is(":hidden"),u=v?t.find(".relationText").text():h.val();if(u=parseInt(u),n=t.find(".num").text(),n=parseInt(n),u+1==n){layer.msg("不能上移到关联任务前");return}for(f=t.nextAll(),i=0,c=f.length;i<c;i++){var l=f.eq(i),e=l.find(".relationText"),o=l.find(".relation"),r=n-1;switch(parseInt(e.text())){case n:e.text(r);break;case r:e.text(n)}switch(parseInt(o.val())){case n:o.val(r);break;case r:o.val(n)}}if(s=t.prev(),s.find(".taskState").text()=="已下发"){layer.msg("不能上移到已下发任务前");return}s.before(t);setTableStyle(`#${a}`,!0)});$("#planItemList,#addPlanTaskList").on("input",".relation",function(){var t=$(this).val(),i=$(this).parents("tr"),n=i.find(".num").text();n=(n>>0)-1;t>>0>n&&$(this).val(t.slice(0,-1))});$("#planItemList,#addPlanTaskList").on("click",".delPlanItem",function(){for(var o=$(this).parents("tbody").prop("id"),n=$(this).parents("tr"),i=n.find(".num").text(),r=n.nextAll(),t=0,s=r.length;t<s;t++){var u=r.eq(t),f=u.find(".relationText"),e=u.find(".relation");f.text()==i&&f.text(0);e.val()==i&&e.val(0)}n.remove();setTableStyle(`#${o}`,!0)});$("#planReuse").on("click",function(){var n=$("#planSelect").val(),t,i;if(isStrEmptyOrUndefined(n)){layer.msg("请选择计划再复用");return}t=$("#planSelect option:selected").text();i=function(){reusePlanTask(n)};showConfirm(`复用计划：${t}`,i)});$("#planSelect").on("change",function(){$("#newPlan").val($(this).find("option:checked").text());$("#taskConfig").val($(this).find("option:checked").attr("taskid")).trigger("change")});$("#taskConfig").on("change",function(){var n=$(this).val();isStrEmptyOrUndefined(n)?$("#addPlanTaskList").empty():getTaskConfigItem(n,"#addPlanTaskList",1)});$("#planConfigList").on("input",".minute,.hour",function(){var n=$(this).parents("tr");planEndTimeCount(n)});$("#planConfigList").on("changeDate",".sTime",function(){var n=$(this).parents("tr");planEndTimeCount(n)});$("#planTime .toZero").on("input",function(){planEndTimeCount($("#planTime"))});$("#planStartTime").on("changeDate",function(){planEndTimeCount($("#planTime"))});$("#addPlanTaskList").on("input",".minute,.hour",function(){getTotalTime();planEndTimeCount($("#planTime"))});$("#addPlanTaskList").on("click",".delPlanItem",function(){getTotalTime();planEndTimeCount($("#planTime"))});$("#taskState").on("change",function(){var r=$(this).val(),i=$("#planItemList tr"),n,u,t;if(r==0)i.removeClass("hidden");else for(n=0,u=i.length;n<u;n++)t=i.eq(n),t.find(".taskState").text()==r?t.removeClass("hidden"):t.addClass("hidden");$("#planItemList .moveUp").removeClass("hidden");$("#planItemList tr:not(.hidden):first .moveUp").addClass("hidden")});$(".maxHeight").css("maxHeight",innerHeight*.7)}function getTotalTime(){for(var e,n,o=$("#addPlanTaskList tr"),r=0,t=0,u=0,c=o.length;u<c;u++){var f=o.eq(u),s=f.find(".isEnable").val(),h=f.find(".hour"),i=h.is(":hidden")?_reusePlanTaskItem[s].EstimatedHour:h.val();isStrEmptyOrUndefined(i)&&(i=0);i=parseInt(i);r+=i;e=f.find(".minute");n=e.is(":hidden")?_reusePlanTaskItem[s].EstimatedMin:e.val();isStrEmptyOrUndefined(n)&&(n=0);n=parseInt(n);t+=n}r+=Math.floor(t/60);t=t%60;$("#planHour").val(r);$("#planMinute").val(t)}function planEndTimeCount(n){var t=n.find(".hour").val(),i,r,u,f;isStrEmptyOrUndefined(t)&&(t=0);t=parseInt(t);i=n.find(".minute").val();isStrEmptyOrUndefined(i)&&(i=0);i=parseInt(i);r=new Date(n.find(".sTime").val());u=Math.ceil(t/8);t%8==0&&i!=0&&(u+=1);f=new Date(r.setDate(r.getDate()+u)).format("yyyy-MM-dd");n.find(".eTime").val(f).datepicker("update")}function reusePlanTask(n){_isUpMove=!0;var t={};t.opType=1040;t.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",t,function(n){var r,u,i,f,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(r=n.datas,$("#addPlanTaskList").empty(),_reusePlanTaskItem={},u="",i=0,f=r.length;i<f;i++)t=r[i],_reusePlanTaskItem[t.Id]=t,u+=_planTaskTr.format(t.Id,t.Id,t.Processor,t.Module,t.Item,t.EstimatedTime,t.Score,t.Desc,t.Relation);$("#addPlanTaskList").append(u);setTableStyle("#addPlanTaskList");getTotalTime();planEndTimeCount($("#planTime"))})}function setProcessorSelect(n,t){var f,u,i,e,r;for(t.empty(),f='<option value = "{0}">{1}<\/option>',u="",i=0,e=_processor.length;i<e;i++)r=_processor[i],n==r.GroupId&&(u+=f.format(r.Id,r.Processor));t.append(u)}function getTaskState(){var n={};n.opType=1038;ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$("#selectState").empty();var r=n.datas,u='<option value="0">所有状态<\/option>';for(t=0,f=r.length;t<f;t++)i=r[t],u+='<option value="{0}">{1}<\/option>'.format(i.Id,i.State);$("#selectState").append(u);getPlanConfig()})}function getTaskConfig(){var n={};n.opType=1051;ajaxPost("/Relay/Post",n,function(n){var i,u,t,f,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(i=n.datas,u='<option value = "{0}">{1}<\/option>',_taskConfigOp="",t=0,f=i.length;t<f;t++)r=i[t],_taskConfigOp+=u.format(r.Id,r.Task)})}function getTaskConfigItem(n,t,i){_isUpMove=!0;var r={};r.opType=1055;r.opData=JSON.stringify({taskId:n});ajaxPost("/Relay/Post",r,function(n){var e,u,o,f,s,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(e=n.datas,$(t).empty(),u={},o="",f=0,s=e.length;f<s;f++)r=e[f],u[r.Id]=r,o+=_planTaskTr.format(r.Id,0,r.Processor,r.Module,r.Item,r.EstimatedTime,r.Score,r.Desc,r.Relation);$(t).append(o);setTableStyle(t);i?(_reusePlanTaskItem=u,getTotalTime(),planEndTimeCount($("#planTime"))):(_planTaskItem=u,_isUpMove=!1,$(t).find(".showLogModel").addClass("hidden"))})}function getPlanConfig(n){var r,t,u,f,i;if(_planIdData=[],r=$("#selectState").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择状态");return}t={state:r,menu:!1};u=$("#startTime").val();isStrEmptyOrUndefined(u)||(t.sTime=`${u} 00:00:00`);f=$("#endTime").val();isStrEmptyOrUndefined(f)||(t.eTime=`${f} 23:59:59`);i={};i.opType=1039;i.opData=JSON.stringify(t);ajaxPost("/Relay/Post",i,function(t){var i,e,u;if(t.errno!=0){layer.msg(t.errmsg);return}var s=_permissionList[420].have,h=_permissionList[421].have,c=_permissionList[422].have,f=_permissionList[423].have,r=t.datas;for(_planConfigData={},i=0,e=r.length;i<e;i++)u=r[i],_planConfigData[u.Id]=u;var o=s||h,l=function(n){return n.State==1&&o?`<input type="checkbox" class="icb_minimal isEnable" value=${n.Id}>`:""},a=function(n,t,i,r){return r.row+1},v=function(n){return n.State==1?`<span class="textOn">${n.Plan}</span><input type="text" class="form-control text-center textIn planName hidden" maxlength="20" style="width:120px">`:n.Plan},y=function(n){var t=n.PlannedStartTime,i=t=="0001-01-01 00:00:00"?"":t.slice(0,t.indexOf(" "));return n.State==1?`<span class="textOn">${i}</span><input type="text" class="form_date form-control text-center textIn sTime hidden" style="width:120px;cursor: pointer">`:i},p=function(n){var t=n.PlannedEndTime,i=t=="0001-01-01 00:00:00"?"":t.slice(0,t.indexOf(" "));return n.State==1?`<span class="textOn">${i}</span><input type="text" class="form_date form-control text-center textIn eTime hidden" style="width:120px;cursor: pointer">`:i},w=function(n){return n.State==1?`<span class="textOn">${n.EstimatedTime}</span>
            <div class="flexStyle textIn hidden" style="justify-content:center">
            <input type="text" class="form-control text-center hour toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:50px">
            <label class="control-label" style="white-space: nowrap; margin: 0">小时</label>
            <input type="text" class="form-control text-center minute toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:50px">
            <label class="control-label" style="white-space: nowrap; margin: 0">分</label>
            </div>`:n.EstimatedTime},b=function(n){return n.State==1?`<span class="textOn">${n.Task}</span><div class="textIn hidden" style="width:120px;margin:auto"><select class="form-control taskConfig">${_taskConfigOp}</select></div>`:n.Task},k=["","#838a9d","black","#6ee66e","green"],d=function(n){var t=n.State==1&&c?`<button type="button" class="btn btn-info btn-sm" onclick="issuePlan(${n.Id})">下发</button>`:"";return`<span style="padding-right:5px;vertical-align:middle;color:${k[n.State]}">${n.StateDesc}</span>${t}`},g=function(n){return`<button type="button" class="btn btn-primary btn-sm" onclick="planTaskDetail(${n.Id},'${n.Plan}')">查看任务</button>`},nt=function(n){return f?`<button type="button" class="btn btn-success btn-sm" onclick="showLogModel(${n.Id})">查看</button>`:""};_planConfigTab=$("#planConfigList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:r,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"选择",render:l,orderable:!1,visible:o},{data:null,title:"序号",render:a},{data:null,title:"计划号",render:v},{data:null,title:"开始时间",render:y},{data:null,title:"结束时间",render:p},{data:null,title:"预计用时",render:w},{data:null,title:"任务配置",render:b},{data:null,title:"状态",render:d},{data:null,title:"详情",render:g,orderable:!1},{data:null,title:"日志",render:nt,orderable:!1,visible:f}],drawCallback:function(){$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"});$(this).find(".form_date").attr("readonly",!0).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0})}});$("#planItem").is(":hidden")||n||($("#planItemList").empty(),$("#planItem").addClass("hidden"))})}function issuePlan(n){var t=_planConfigData[n].Plan,i=function(){var t={};t.opType=1041;t.opData=JSON.stringify({PlanId:n});ajaxPost("/Relay/Post",t,function(t){layer.msg(t.errmsg);t.errno==0&&(getPlanConfig(),$("#planItem").is(":hidden")||$("#planText").attr("planid")!=n||resetPlanItemList())})};showConfirm(`下发计划：${t}`,i)}function getGroup(n){var t={};t.opType=1077;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var i,e,r;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,f="";for(i=0,e=u.length;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Group);n!=null&&n(f)},0)}function getProcessor(n){var t={};t.opType=1081;t.opData=JSON.stringify({groupId:0,menu:!0});ajaxPost("/Relay/Post",t,function(t){var f,r,i,e,u;if(t.errno!=0){layer.msg(t.errmsg);return}for(_processor=t.datas,f='<option value = "{0}">{1}<\/option>',r="",i=0,e=_processor.length;i<e;i++)u=_processor[i],r+=f.format(u.Id,u.Processor);n!=null&&n(r)},0)}function getModule(n){var t={};t.opType=1058;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var i,e,r;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,f="";for(i=0,e=u.length;i<e;i++)r=u[i],f+='<option value = "{0}" isCheck = "{2}">{1}<\/option>'.format(r.Id,r.Module,r.IsCheck);n!=null&&n(f)},0)}function getTaskName(n){var t={};t.opType=1066;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var r,e,u;if(t.errno!=0){layer.msg(t.errmsg);return}var f=t.datas,i="";for(r=0,e=f.length;r<e;r++)u=f[r],i+='<option value = "{0}">{1}<\/option>'.format(u.Id,u.Check);i=`<select class="ms2 form-control taskNameSelect">${i}</select>`;n!=null&&n(i)},0)}function planTaskTr(n,t){var i=new Promise(n=>getGroup(n)),r=new Promise(n=>getProcessor(n)),u=new Promise(n=>getModule(n)),f=new Promise(n=>getTaskName(n));Promise.all([i,r,u,f]).then(function(i){_planTaskDetailTr=`<tr>
            <td><input type="checkbox" class="icb_minimal isEnable" value={0} trid={0}></td>
            <td class="num"></td>
            <td><span class="textOn">{1}</span><div class="textIn hidden" style="width: 120px;margin:auto"><input type="text" class="form-control text-center taskName" maxlength="10"><div>${i[3]}</div></div></td>
            <td>
            <span class="textOn">{2}</span>
            <div class="flexStyle textIn hidden" style="width: 240px;margin:auto"><select class="ms2 form-control group">${i[0]}</select><select class="ms2 form-control processor">${i[1]}</select></div>
            </td>
            <td><span class="textOn">{3}</span><div class="textIn hidden" style="width: 120px;margin:auto"><select class="ms2 form-control module">${i[2]}</select></div></td>
            <td>
                <span class="textOn">{4}</span>
                <div class="flexStyle textIn hidden" style="width:140px;margin:auto">
                    <input type="text" class="form-control text-center hour toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)">
                    <label class="control-label" style="white-space: nowrap; margin: 0">小时</label>
                    <input type="text" class="form-control text-center minute toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)">
                    <label class="control-label" style="white-space: nowrap; margin: 0">分</label>
                </div>
            </td>
            <td><span class="textOn">{5}</span><input type="text" class="form-control text-center textIn hidden score toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto"></td>
            <td class="no-padding"><span class="textOn">{6}</span><textarea class="form-control textIn hidden desc" maxlength="500" style="resize: vertical;width:180px;margin:auto"></textarea></td>
            <td class="taskState">{7}</td>
            <td><span class="textOn relationText">{8}</span><input type="text" class="form-control text-center textIn hidden relation toZero" oninput="onInput(this, 10, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto"></td>
            <td><button type="button" class="btn btn-primary btn-sm moveUp isAdd">上移</button></td>
            <td>
                <button class="btn btn-primary btn-sm copy isAdd" onclick="copyTr.call(this)" title="复制"><i class="fa fa-copy"></i></button>
                <button class="btn btn-success btn-sm showLogModel isAdd" onclick="showLogModel({9},{0})">日志</button>
                <button class="btn btn-danger btn-sm delPlanItem"><i class="fa fa-minus"></i></button>
            </td>
            </tr>`;_planTaskTr=`<tr>
            <td class="isIssue"><input type="checkbox" class="icb_minimal isEnable" value={0} trid={1}></td>
            <td class="num"></td>
            <td>
            <span class="textOn">{2}</span>
            <div class="flexStyle textIn hidden" style="width: 240px;margin:auto"><select class="ms2 form-control group">${i[0]}</select><select class="ms2 form-control processor">${i[1]}</select></div>
            </td>
            <td><span class="textOn">{3}</span><div class="textIn hidden" style="width: 120px;margin:auto"><select class="ms2 form-control module">${i[2]}</select></div></td>
            <td><span class="textOn">{4}</span><div class="textIn hidden" style="width: 120px;margin:auto"><input type="text" class="form-control text-center taskName" maxlength="10"><div>${i[3]}</div></div></td>
            <td><span class="textOn">{5}</span>
            <div class="flexStyle textIn hidden" style="width:140px;margin:auto">
            <input type="text" class="form-control text-center hour toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)">
            <label class="control-label" style="white-space: nowrap; margin: 0">小时</label>
            <input type="text" class="form-control text-center minute toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)">
            <label class="control-label" style="white-space: nowrap; margin: 0">分</label>
            </div>
            </td>
            <td><span class="textOn">{6}</span><input type="text" class="form-control text-center textIn hidden score toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto"></td>
            <td class="no-padding"><span class="textOn">{7}</span><textarea class="form-control textIn hidden desc" maxlength="500" style="resize: vertical;width:180px;margin:auto"></textarea></td>
            <td><span class="textOn relationText">{8}</span><input type="text" class="form-control text-center textIn hidden relation toZero" oninput="onInput(this, 10, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto"></td>
            <td class="isIssue"><button type="button" class="btn btn-primary btn-sm moveUp">上移</button></td>
            ${t?"":'<td><button type="button" class="btn btn-success btn-sm showLogModel" onclick="showLogModel({9},{0})">日志<\/button><\/td>'}
            <td class="isIssue"><button type="button" class="btn btn-danger btn-sm delPlanItem"><i class="fa fa-minus"></i></button></td>
            </tr>`;_addPlanTaskTr=`<tr>
            <td></td>
            <td class="num"></td>
            <td>
            <div class="flexStyle" style="width: 240px;margin:auto"><select class="ms2 form-control group">${i[0]}</select><select class="ms2 form-control processor">${i[1]}</select></div>
            </td>
            <td><div style="width: 120px;margin:auto"><select class="ms2 form-control module">${i[2]}</select></div></td>
            <td><div style="width: 120px;margin:auto"><input type="text" class="form-control text-center taskName" maxlength="10"><div class="hidden">${i[3]}</div></div></td>
            <td>
            <div class="flexStyle" style="width:140px;margin:auto">
            <input type="text" class="form-control text-center hour toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)" value="0">
            <label class="control-label" style="white-space: nowrap; margin: 0">小时</label>
            <input type="text" class="form-control text-center minute toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)" value="0">
            <label class="control-label" style="white-space: nowrap; margin: 0">分</label>
            </div>
            </td>
            <td><input type="text" class="form-control text-center score toZero" oninput="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto" value="0"></td>
            <td class="no-padding"><textarea class="form-control desc" maxlength="500" style="resize: vertical;width:180px;margin:auto"></textarea></td>
            <td><input type="text" class="form-control text-center relation toZero" oninput="onInput(this, 10, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto" value="0"></td>
            <td><button type="button" class="btn btn-primary btn-sm moveUp">上移</button></td>
            ${t?"":"<td><\/td>"}
            <td><button type="button" class="btn btn-danger btn-sm delPlanItem"><i class="fa fa-minus"></i></button></td>
            </tr>`;n("success")})}function copyTr(){var n,t,i,r;$("#planItemList").append(_planTaskDetailTr);n=$(this).parents("tr");t=$("#planItemList tr:last");setPlanTaskTr(t);n.find(".isEnable").is(":checked")?(i={GroupId:n.find(".group").val(),Person:n.find(".processor").val(),ModuleId:n.find(".module").val(),IsCheck:n.find(".module :selected").attr("ischeck")>>0,CheckId:n.find(".taskNameSelect").val(),Item:n.find(".taskName").val().trim(),EstimatedHour:n.find(".hour").val().trim(),EstimatedMin:n.find(".minute").val().trim(),Score:n.find(".score").val().trim(),Desc:n.find(".desc").val().trim()},r=n.find(".relation").val().trim()):(i=_planTaskItem[n.find(".isEnable").val()],r=n.find(".relationText").text());dataSetTr(t,i,r)}function dataSetTr(n,t,i){var u=t.GroupId,r;n.find(".group").val(u).trigger("change");r=n.find(".processor");setProcessorSelect(u,r);r.val(t.Person).trigger("change");n.find(".module").val(t.ModuleId).trigger("change");t.IsCheck?(n.find(".taskName").addClass("hidden").siblings().removeClass("hidden"),n.find(".taskNameSelect").val(t.CheckId).trigger("change")):n.find(".taskNameSelect").parent().addClass("hidden").siblings().removeClass("hidden");n.find(".taskName").val(t.Item);n.find(".hour").val(t.EstimatedHour);n.find(".minute").val(t.EstimatedMin);n.find(".score").val(t.Score);n.find(".desc").val(t.Desc);n.find(".relation").val(n.find(".relationText").text()||i)}function planTaskDetail(n,t){_isUpMove=!0;$("#planText").text(t).attr("planid",n);var i={};i.opType=1040;i.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",i,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}new Promise(function(n){planTaskTr(n,0)}).then(()=>{var u=n.datas,f,i,r,t,e;for($("#planItemList").empty(),_planTaskItem={},f="",i=0,r=u.length;i<r;i++)t=u[i],_planTaskItem[t.Id]=t,e=t.State==-1?"#ff9900d8":"black",f+=_planTaskDetailTr.format(t.Id,t.Item,t.Processor,t.Module,t.EstimatedTime,t.Score,t.Desc,`<span style="color:${e}">${t.StateDesc}</span>`,t.Relation==0?"":t.Relation,t.PlanId);$("#planItemList").append(f);setTableStyle("#planItemList");var o=$("#planItemList .isEnable"),s=$("#planItemList .moveUp"),h=$("#planItemList .delPlanItem");for(i=0,r=o.length;i<r;i++)u[i].State!=-1&&(o.eq(i).parent().addClass("hidden"),s.eq(i).remove(),h.eq(i).remove());$("#planItem").removeClass("hidden")})})}function resetPlanItemList(){var n=$("#planText").attr("planid");planTaskDetail(n,$("#planText").text())}function addPlanTaskTr(){$("#planItemList").append(_planTaskDetailTr);var n=$("#planItemList tr:last"),t=n.find(".module option:selected").attr("ischeck");parseInt(t)?n.find(".taskName").addClass("hidden").siblings().removeClass("hidden"):n.find(".taskName").removeClass("hidden").siblings().addClass("hidden");setPlanTaskTr(n);$("#planItemTable").scrollTop($("#planItemTable")[0].scrollHeight)}function setPlanTaskTr(n){setTableStyle("#planItemList",!0);n.find(".group").trigger("select2:select");n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");n.find(".taskState").html('<span style="color:#ff9900d8">待下发<\/span>');n.find(".isAdd").remove().end().find(".delPlanItem").removeClass("hidden");n.find(".isEnable").remove();n.find(".textOn").remove()}function planTaskData(n,t){var rt=[],u,c=$(`${n} tr`).length,ut=$(`${n} .isEnable`).is(":checked"),ft=$(`${n} .isEnable`).length,w,p,k,l,a,f,v,o,s,h,d,g,e,nt,tt,r,it;if(t&&(w=Object.keys(_planTaskItem).length,!c&&c==w||ft==c&&!ut&&_isUpMove&&c==w))return layer.msg("请先修改数据"),1;for(u=0;u<c;u++){var i=$(`${n} tr`).eq(u),y=i.find(".isEnable"),b=y.attr("trid");if(isStrEmptyOrUndefined(b)&&(b=0),!y.length||y.is(":checked")){if(nt=i.find(".processor"),p=nt.val(),isStrEmptyOrUndefined(p))return layer.msg(`序列${u+1}：请选择操作员`),1;if(k=nt.find("option:selected").text(),l=i.find(".module").val(),isStrEmptyOrUndefined(l))return layer.msg(`序列${u+1}：请选择模块名`),1;if(a=!!parseInt(i.find(".module").find(`option[value=${l}]`).attr("isCheck")),a){if(f=i.find(".taskNameSelect").val(),isStrEmptyOrUndefined(f))return layer.msg(`序列${u+1}：请选择检验任务`),1;v=i.find(`.taskNameSelect option[value=${f}]`).text();f=parseInt(f)}else if(f=0,v=i.find(".taskName").val(),isStrEmptyOrUndefined(v))return layer.msg(`序列${u+1}：任务名不能为空`),1;if(o=i.find(".hour").val(),isStrEmptyOrUndefined(o)&&(o=0),o=parseInt(o),s=i.find(".minute").val(),isStrEmptyOrUndefined(s)&&(s=0),s=parseInt(s),h=i.find(".score").val(),isStrEmptyOrUndefined(h)&&(h=0),h=parseInt(h),d=i.find(".desc").val(),t&&(g=i.find(".taskState").text()=="已下发"?0:-1),e=i.find(".relation").val(),e>>0==0&&a)return layer.msg(`序列${u+1}：检验单需先关联任务`),1}else tt=y.val(),r=t?_planTaskItem[tt]:_reusePlanTaskItem[tt],p=r.Person,k=r.Processor,l=r.ModuleId,a=r.IsCheck,f=r.CheckId,v=r.Item,o=r.EstimatedHour,s=r.EstimatedMin,h=r.Score,d=r.Desc,t&&(g=r.State),e=i.find(".relationText").text();isStrEmptyOrUndefined(e)&&(e=0);e=parseInt(e);it={Order:u+1,Person:p,Processor:k,ModuleId:l,IsCheck:a,CheckId:f,Item:v,EstimatedHour:o,EstimatedMin:s,Score:h,Desc:d,Relation:e,Id:b};t&&(it.State=g);rt.push(it)}return rt}function updatePlanTaskItem(){var u=$("#planText").attr("planid"),f=_planConfigData[u],n={Id:u,TaskId:f.TaskId,State:f.State,Plan:f.Plan},t=planTaskData("#planItemList",!0),e,i,r,s,o,h;if(t.length){for(n.Items=t,e=0,i=0,r=0,s=t.length;r<s;r++)o=t[r],e+=o.EstimatedHour,i+=o.EstimatedMin;n.EstimatedHour=e+Math.floor(i/60);n.EstimatedMin=i%60;h=function(){var t={};t.opType=1042;t.opData=JSON.stringify([n]);ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&(planTaskDetail(u,$("#planText").text()),getPlanConfig(!0))})};showConfirm("保存",h)}}function issuePlanTask(){for(var n,s=$("#planText").attr("planid"),u=$("#planItemList .isEnable"),t=[],f=[],i=0,h=u.length;i<h;i++){var e=u.eq(i),o=e.val(),r=_planTaskItem[o];if(e.is(":checked"))t.push(o),r.IsCheck&&f.push(r.Order);else if(f.indexOf(r.Relation)!=-1){layer.msg("请选择关联任务一起下发");return}}if(!t.length){layer.msg("请选择需要下发的任务");return}n={};n.opType=1041;n.opData=JSON.stringify({PlanId:s,TaskIds:t.join()});ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&(resetPlanItemList(),getPlanConfig())})}function setTableStyle(n,t){var r,i,u;for(t||$(n).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"}),r=$(`${n} tr .num`),i=0,u=r.length;i<u;i++)r.eq(i).text(i+1);$(n).find(".ms2").select2();$(`${n} .moveUp`).removeClass("hidden");$(`${n} tr:not(.hidden):first .moveUp`).addClass("hidden")}function showLogModel(n,t){var r={planId:n},i;isStrEmptyOrUndefined(t)||(r.itemId=t);i={};i.opType=1088;i.opData=JSON.stringify(r);ajaxPost("/Relay/Post",i,function(n){var r,u,t,o,i;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#planTaskLog").empty(),r=n.datas,u="",t=0,o=r.length;t<o;t++){var f=r[t],s=f.Items.length,e="";if(s)for(i=0;i<s;i++)e+=`<li>${f.Items[i]}</li>`;u+=`<div class="box box-solid noShadow collapsed-box" style="margin-bottom: 0;">
            <div class="box-header no-padding">
                <span><font style="font-weight:bold">${t+1}</font>.${f.Log}</span>
                <button type="button" style="padding:0;border:1px solid;width:18px;background:#E5E5E5" class="btn btn-box-tool ${e==""?"hidden":""}" data-widget="collapse"><i class="on_i fa fa-plus"></i></button>
            </div>
            <div class="box-body no-padding">
                <ul class="on_ul nav nav-pills nav-stacked mli" style="text-indent: 2em">${e}</ul>
            </div>
        </div>`}$("#planTaskLog").append(u);$("#showLogModal").modal("show")})}function delPlanConfig(){var r=_planIdData.length,t,n,u,f,e,o,i,s;if(!r){layer.msg("请选择需要删除的数据");return}for(t=_planConfigTab.context[0].aoData,u=t.length,n=0;n<u;n++)if(f=t[n].nTr,e=$(f).find(".isEnable"),e.is(":checked")&&(o=t[n]._aData.State,o!=1)){layer.msg(`序号${n+1}：非待下发计划不能删除`);return}for(i=[],n=0;n<r;n++)i.push(_planConfigData[_planIdData[n]].Plan);s=function(){var n={};n.opType=1044;n.opData=JSON.stringify({ids:_planIdData});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&($("#planItem").is(":hidden")||_planIdData.indexOf($("#planText").attr("planid"))==-1||($("#planItemList").empty(),$("#planItem").addClass("hidden")),getPlanConfig())})};showConfirm(`删除以下计划:<pre style='color:red'>${i.join("<br>")}</pre>`,s)}function updatePlanConfig(){var o=_planIdData.length,i,s,n,t,h,a,v,c,r,u,f,e,l,y;if(!o){layer.msg("请选择需要修改的数据");return}for(i=_planConfigTab.context[0].aoData,o=i.length,s=[],n=0;n<o;n++)if(t=i[n].nTr,h=$(t).find(".isEnable"),h.is(":checked")){if(a=i[n]._aData.State,a!=1){layer.msg(`序号${n+1}：非待下发计划不能修改`);return}if(v=h.val(),c=$(t).find(".planName").val(),isStrEmptyOrUndefined(c)){layer.msg(`序号${n+1}：计划号不能为空`);return}if(r=$(t).find(".sTime").val(),isStrEmptyOrUndefined(r)){layer.msg(`序号${n+1}：请选择开始时间`);return}if(u=$(t).find(".eTime").val(),isStrEmptyOrUndefined(u)){layer.msg(`序号${n+1}：请选择结束时间`);return}if(compareDate(r,u)){layer.msg(`序号${n+1}：开始时间不能大于结束时间`);return}if(f=$(t).find(".hour").val(),isStrEmptyOrUndefined(f)&&(f=0),e=$(t).find(".minute").val(),isStrEmptyOrUndefined(e)&&(e=0),l=$(t).find(".taskConfig").val(),isStrEmptyOrUndefined(l)){layer.msg(`序号${n+1}：请选择人物配置`);return}s.push({Id:v,Plan:c,PlannedStartTime:r,PlannedEndTime:u,EstimatedHour:f,EstimatedMin:e,TaskId:l})}y=function(){var n={};n.opType=1042;n.opData=JSON.stringify(s);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getPlanConfig()})};showConfirm("保存",y)}function getPlanSelect(){var n={};n.opType=1039;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,function(n){var i,f,t;if(n.errno!=0){layer.msg(n.errmsg);return}$("#planSelect").empty();var r=n.datas,u="";for(_planName=[],i=0,f=r.length;i<f;i++)t=r[i],_planName.push(t.Plan),u+='<option value = "{0}" taskid = "{2}" state="{3}">{1}<\/option>'.format(t.Id,t.Plan,t.TaskId,t.State);$("#planSelect").append(u);$("#planSelect").val(0)},0)}function showPlanModal(){getPlanSelect();$("#taskConfig").empty();$("#taskConfig").append(_taskConfigOp);$("#taskConfig").val(0);$("#newPlan").val("");$("#planStartTime").val(getDate()).datepicker("update");$("#planEndTime").val(getDate()).datepicker("update");$("#planHour").val(0);$("#planMinute").val(0);$("#addPlanTaskList").empty();new Promise(n=>planTaskTr(n,1)).then(()=>$("#showPlanModal").modal("show"))}function delPlanSelect(){var n=$("#planSelect"),t=n.val(),i,r;if(isStrEmptyOrUndefined(t)){layer.msg("请选择计划");return}if(i=n.find("option:selected").attr("state"),i!=1){layer.msg("非待下发计划不能删除");return}r=function(){var n={};n.opType=1044;n.opData=JSON.stringify({ids:[t]});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getPlanSelect()})};showConfirm(`删除计划：${n.find("option:selected").text()}`,r)}function addPlanTaskConTr(){$("#addPlanTaskList").append(_addPlanTaskTr);var n=$("#addPlanTaskList tr:last"),t=n.find(".module option:selected").attr("ischeck");parseInt(t)?n.find(".taskName").addClass("hidden").siblings().removeClass("hidden"):n.find(".taskName").removeClass("hidden").siblings().addClass("hidden");setTableStyle("#addPlanTaskList");n.find(".group").trigger("select2:select");$("#addPlanTaskTable").scrollTop($("#addPlanTaskTable")[0].scrollHeight)}function addPlan(){var n=$("#newPlan").val().trim(),e,t,i,r,u,o,f,s;if(isStrEmptyOrUndefined(n)){layer.msg("新计划不能为空");return}if(_planName.includes(n)){layer.msg("新计划已存在");return}if(e=$("#taskConfig").val(),isStrEmptyOrUndefined(e)){layer.msg("请选择任务配置");return}if(t=$("#planStartTime").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择开始时间");return}if(i=$("#planEndTime").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择结束时间");return}compareDate(t,i)||(r=$("#planHour").val(),isStrEmptyOrUndefined(r)&&(r=0),u=$("#planMinute").val(),isStrEmptyOrUndefined(u)&&(u=0),o={Plan:n,TaskId:e,PlannedStartTime:t,PlannedEndTime:i,EstimatedHour:r,EstimatedMin:u},f=planTaskData("#addPlanTaskList",!1),f!==1)&&(f.length&&(o.Items=f),s=function(){var n={};n.opType=1043;n.opData=JSON.stringify(o);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&($("#showPlanModal").modal("hide"),getPlanConfig())})},showConfirm(`新增计划：${n}`,s))}var _permissionList=[],_reusePlanTaskItem=null,_taskConfigOp=null,_planConfigData=null,_planConfigTab=null,_processor=null,_planTaskDetailTr=null,_planTaskTr=null,_planTaskItem=null,_addPlanTaskTr=null,_isUpMove=!0,_planIdData=[],_planName=null;