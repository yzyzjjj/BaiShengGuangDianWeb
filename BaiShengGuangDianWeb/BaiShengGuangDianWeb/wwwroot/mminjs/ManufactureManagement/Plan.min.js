function pageReady(){$(".ms2").select2();getTaskConfig();getTaskState();$("#startTime").val(getDate()).datepicker("update");$("#endTime").val(getDate()).datepicker("update");$("#planConfigList").on("ifChanged",".isEnable",function(){var n=$(this).parents("tr"),u=$(this).val(),t,i,r;$(this).is(":checked")?(_planIdData.push(u),t=_planConfigData[u],n.find(".planName").val(t.Plan),i=t.PlannedStartTime,i=i.slice(0,i.indexOf(" ")),i=="0001-01-01"&&(i=""),r=t.PlannedEndTime,r=r.slice(0,r.indexOf(" ")),r=="0001-01-01"&&(r=""),n.find(".sTime").val(i).datepicker("update"),n.find(".eTime").val(r).datepicker("update"),n.find(".hour").val(t.EstimatedHour),n.find(".minute").val(t.EstimatedMin),n.find(".taskConfig").val(t.TaskId).trigger("change"),n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden")):(_planIdData.splice(_planIdData.indexOf(u),1),n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"))});$("#planReuse").on("ifChanged",function(){$(this).is(":checked")?$("#updatePlanBtn").attr("disabled","disabled"):$("#updatePlanBtn").removeAttr("disabled")})}function getTaskState(){var t=1038,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$("#selectState").empty();var r=n.datas,u="<option value=0>所有状态<\/option>";for(t=0,f=r.length;t<f;t++)i=r[t],u+='<option value="{0}">{1}<\/option>'.format(i.Id,i.State);$("#selectState").append(u)})}function getTaskConfig(){var t=1051,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var i,u,t,f,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(i=n.datas,u='<option value = "{0}">{1}<\/option>',_taskConfigOp="",t=0,f=i.length;t<f;t++)r=i[t],_taskConfigOp+=u.format(r.Id,r.Task)})}function getPlanConfig(){var u=1039,r,n,t,i;if(!checkPermission(u)){layer.msg("没有权限");return}if(_planIdData=[],r=$("#selectState").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择状态");return}if(n=$("#startTime").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择开始时间");return}if(t=$("#endTime").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择结束时间");return}comTimeDay(n,t)||(i={},i.opType=u,i.opData=JSON.stringify({state:r,sTime:n,eTime:t,menu:!1}),ajaxPost("/Relay/Post",i,function(n){var t,i,u,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(t=n.datas,_planConfigData={},i=0,u=t.length;i<u;i++)r=t[i],_planConfigData[r.Id]=r;var f=function(n){return`<input type="checkbox" class="icb_minimal isEnable" value=${n.Id}>`},e=function(n,t,i,r){return r.row+1},o=function(n){return`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn planName hidden" maxlength="20" style="width:120px">`},s=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"&&(t=""),`<span class="textOn">${t}</span><input type="text" class="form_date form-control text-center textIn sTime hidden" style="width:120px;cursor: pointer">`},h=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"&&(t=""),`<span class="textOn">${t}</span><input type="text" class="form_date form-control text-center textIn eTime hidden" style="width:120px;cursor: pointer">`},c=function(n){return`<span class="textOn">${n.EstimatedTime}</span>
            <div class="flexStyle textIn hidden">
            <input type="text" class="form-control text-center hour toZero" maxlength="3" oninput="value=value.replace(/[^\d]/g,'')" style="width:50px">
            <label class="control-label" style="white-space: nowrap; margin: 0">小时</label>
            <input type="text" class="form-control text-center minute toZero" maxlength="3" oninput="value=value.replace(/[^\d]/g,'')" style="width:50px">
            <label class="control-label" style="white-space: nowrap; margin: 0">分</label>
            </div>`},l=function(n){return`<span class="textOn">${n}</span><div class="textIn hidden" style="width:120px;margin:auto"><select class="ms2 form-control taskConfig">${_taskConfigOp}</select></div>`},a=function(n){return n.State=="待下发"?`<button type="button" class="btn btn-info btn-sm" onclick="issue(${n.Id})">下发</button>`:""},v=function(n){return`<button type="button" class="btn btn-primary btn-sm" onclick="planTaskDetail(${n.TaskId})">查看任务</button>`},y=function(n){return`<button type="button" class="btn btn-success btn-sm" onclick="showLogModel(${n.Id})">查看</button>`};$("#planConfigList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"选择",render:f,orderable:!1},{data:null,title:"序号",render:e},{data:"Plan",title:"计划号",render:o},{data:"PlannedStartTime",title:"开始时间",render:s},{data:"PlannedEndTime",title:"结束时间",render:h},{data:null,title:"预计用时",render:c},{data:"Task",title:"任务配置",render:l},{data:null,title:"实施",render:a},{data:"State",title:"状态"},{data:null,title:"详情",render:v,orderable:!1},{data:null,title:"日志",render:y,orderable:!1}],drawCallback:function(){$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"});$(this).find(".form_date").attr("readonly",!0).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});$(this).find(".ms2").select2()}})}))}function planTaskDetail(){}function showLogModel(){}function delPlanConfig(){var r=1044,t,i,n,u;if(!checkPermission(r)){layer.msg("没有权限");return}if(t=_planIdData.length,!t){layer.msg("请选择需要删除的数据");return}for(i=[],n=0;n<t;n++)i.push(_planConfigData[_planIdData[n]].Plan);u=function(){var n={};n.opType=r;n.opData=JSON.stringify({ids:_planIdData});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getPlanConfig()})};showConfirm(`删除以下计划:<pre style='color:red'>${i.join("<br>")}</pre>`,u)}function updatePlanConfig(){var n;if(!checkPermission(1042)){layer.msg("没有权限");return}if(n=_planIdData.length,!n){layer.msg("请选择需要修改的数据");return}}function showPlanModal(){$("#showPlanModal").modal("show")}var _taskConfigOp=null,_planConfigData=null,_planIdData=[];