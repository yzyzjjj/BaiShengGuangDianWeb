function pageReady(){$(".ms2").select2();$(".table-bordered td").css("border","1px solid");$("#startTime").val(getDate()).datepicker("update");$("#endTime").val(getDate()).datepicker("update");getPlan();getGroup();getState();$("#groupSelect").on("select2:select",function(){getProcessor()});$("#updateTask").on("click",function(){if(_isClick=!_isClick,_isClick){$("#taskEstimatedTime .textOn").addClass("hidden").siblings(".textIn").removeClass("hidden");$("#taskScore .textOn").addClass("hidden").siblings(".textIn").removeClass("hidden");$("#taskEstimatedTime .hour").val(_taskDetailData.EstimatedHour);$("#taskEstimatedTime .minute").val(_taskDetailData.EstimatedMin);$("#taskScore .score").val(_taskDetailData.Score);var n=$(this).val();n==3&&($("#taskActualTime .textOn").addClass("hidden").siblings(".textIn").removeClass("hidden"),$("#taskActualScore .textOn").addClass("hidden").siblings(".textIn").removeClass("hidden"),$("#taskActualTime .hour").val(_taskDetailData.ActualHour),$("#taskActualTime .minute").val(_taskDetailData.ActualMin),$("#taskActualScore .score").val(_taskDetailData.ActualScore))}else $("#taskDesc").val(_taskDetailData.Desc),$("#taskDetailTable .textOn").removeClass("hidden").siblings(".textIn").addClass("hidden");$("#taskDesc").prop("disabled",!_isClick)});$("#updateCheck").on("click",function(){if(_isClick=!_isClick,_isClick){$("#checkDetailTable .textOn").addClass("hidden").siblings(".textIn").removeClass("hidden");$("#checkEstimatedTime .hour").val(_taskDetailData.EstimatedHour);$("#checkEstimatedTime .minute").val(_taskDetailData.EstimatedMin);$("#checkScore .score").val(_taskDetailData.Score);var n=$(this).val();n==3?($("#checkActualTime .hour").val(_taskDetailData.ActualHour),$("#checkActualTime .minute").val(_taskDetailData.ActualMin),$("#checkActualScore .score").val(_taskDetailData.ActualScore),$("#checkResultDesc .checkResult").val(_taskDetailData.CheckResultDesc)):($("#checkActualTime .textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"),$("#checkActualScore .textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"),$("#checkResultDesc .textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"))}else $("#checkDesc").val(_taskDetailData.Desc),$("#checkDetailTable .textOn").removeClass("hidden").siblings(".textIn").addClass("hidden");$("#checkDesc").prop("disabled",!_isClick)});$(".minute").on("input",function(){var n=$(this).val();parseInt(n)>59&&$(this).val(59)});$(".toZero").on("focus",function(){var n=$(this).val();n==0&&$(this).val("")});$(".toZero").on("blur",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#taskTable").css("maxHeight",innerHeight*.7)}function getPlan(){var t=1025,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$("#planSelect").empty();var r=n.datas,u="<option value=0 task=0>所有计划<\/option>";for(t=0,f=r.length;t<f;t++)i=r[t],u+='<option value="{0}" task="{2}">{1}<\/option>'.format(i.Id,i.Plan,i.TaskId);$("#planSelect").append(u)})}function getGroup(){var t=1077,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$("#groupSelect").empty();var r=n.datas,u="<option value=0>所有分组<\/option>";for(t=0,f=r.length;t<f;t++)i=r[t],u+='<option value="{0}">{1}<\/option>'.format(i.Id,i.Group);$("#groupSelect").append(u);getProcessor()})}function getProcessor(){var i=1081,t,n;if(!checkPermission(i)){layer.msg("没有权限");return}(t=$("#groupSelect").val(),isStrEmptyOrUndefined(t))||(n={},n.opType=i,n.opData=JSON.stringify({groupId:t,menu:!0}),ajaxPost("/Relay/Post",n,function(n){var i,r,e,u,t,f;if(n.errno!=0){layer.msg(n.errmsg);return}if($("#processorSelect").empty(),i=n.datas,r=i.length,r){for(e='<option value="{0}">{1}<\/option>',u="<option value=0>所有人<\/option>",t=0;t<r;t++)f=i[t],u+=e.format(f.ProcessorId,f.Processor);$("#processorSelect").append(u)}}))}function getState(){var t=1024,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$("#stateSelect").empty();var r=n.datas,u="<option value=0>所有进度<\/option>";for(t=0,f=r.length;t<f;t++)i=r[t],u+='<option value="{0}">{1}<\/option>'.format(i.Id,i.State);$("#stateSelect").append(u)})}function showLogModel(){var i=1088,t,n;if(!checkPermission(i)){layer.msg("没有权限");return}if(t=$("#planSelect").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择计划号");return}$("#planName").text($("#planSelect option:selected").text());n={};n.opType=i;n.opData=JSON.stringify({planId:t});ajaxPost("/Relay/Post",n,function(n){var r,u,t,o,i;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#planTaskLog").empty(),r=n.datas,u="",t=0,o=r.length;t<o;t++){var f=r[t],s=f.Items.length,e="";if(s)for(i=0;i<s;i++)e+=`<li>${f.Items[i]}</li>`;u+=`<div class="box box-solid noShadow collapsed-box" style="margin-bottom: 0;">
            <div class="box-header no-padding">
                <span><font style="font-weight:bold">${t+1}</font>.${f.Log}</span>
                <button type="button" style="padding:0;border:1px solid;width:18px;background:#E5E5E5" class="btn btn-box-tool ${e==""?"hidden":""}" data-widget="collapse"><i class="on_i fa fa-plus"></i></button>
            </div>
            <div class="box-body no-padding">
                <ul class="on_ul nav nav-pills nav-stacked mli" style="text-indent: 2em">${e}</ul>
            </div>
        </div>`}$("#planTaskLog").append(u);$("#showLogModal").modal("show")})}function getTaskList(){var e=1026,u,f,n,t,i,r;if(!checkPermission(e)){layer.msg("没有权限");return}if(u=$("#planSelect").val(),isStrEmptyOrUndefined(u)){layer.msg("请选择计划号");return}if(f=$("#processorSelect").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择操作员");return}if(n=$("#stateSelect").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择进度");return}if(t=$("#startTime").val(),i=$("#endTime").val(),isStrEmptyOrUndefined(i)||isStrEmptyOrUndefined(t)){layer.msg("请选择实际开始时间");return}comTimeDay(t,i)||(r={},r.opType=e,r.opData=JSON.stringify({planId:u,pId:f,state:n,sTime:t,eTime:i}),ajaxPost("/Relay/Post",r,function(t){var u,r,f,e,i,o;if(t.errno!=0){layer.msg(t.errmsg);return}if($("#taskList").empty(),u=t.datas,f=u.length,!f){$("#taskTable").addClass("hidden");layer.msg("无数据");return}for(e="",r=0;r<f;r++)i=u[r],n=i.State,o=`<tr>
                    <td class="num">${r+1}</td>
                    <td>${i.Processor}</td>
                    <td>${i.Plan}</td>
                    <td>${i.StateDesc}</td>
                    <td>${i.Module}</td>
                    <td>${i.Item}</td>
                    <td>${i.TotalOrder}</td>
                    <td>${i.Order}</td>
                    <td>${i.Relation}</td>
                    <td>${n==0&&r!=0?'<button type="button" class="btn btn-primary btn-sm" onclick="upTask()">上移<\/button>':""}</td>
                    <td>${i.EstimatedTime}</td>
                    <td>${i.Score}</td>
                    <td>${i.ActualStartTime}</td>
                    <td>${i.ActualTime}</td>
                    <td>${i.ActualScore}</td>
                    <td><button type="button" class="btn btn-info btn-sm" onclick="showDetailModal(${i.Id})">详情</button></td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm"><i class="fa fa-plus"></i></button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="delTask(${i.Id},'${i.Item}')"><i class="fa fa-minus"></i></button>
                        ${n==3?"":n==4?'<button type="button" class="btn btn-primary btn-sm" onclick="taskStartStop(1,{0},\'{1}\')">启动<\/button>'.format(i.Id,i.Item):'<button type="button" class="btn btn-warning btn-sm" onclick="taskStartStop(0,{0},\'{1}\')">停止<\/button>'.format(i.Id,i.Item)}
                    </td>
                </tr>`,e+=o;$("#taskList").append(e);$("#taskTable").removeClass("hidden")}))}function showDetailModal(n){var i=1027,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;t.opData=JSON.stringify({tId:n});ajaxPost("/Relay/Post",t,function(t){var i,u,r,o;if(t.errno!=0){layer.msg(t.errmsg);return}if(_isClick=!1,i=t.datas[0],_taskDetailData=i,_taskDetailId=n,i.IsCheck){$("#checkDesc").prop("disabled",!0);$("#checkDetailTable .textOn").removeClass("hidden").siblings(".textIn").addClass("hidden");u=i.State;$("#updateCheck").val(u);$("#checkName").text(i.Check);$("#checkPlan").text(i.Plan);$("#checkTaskName").text(i.Item);$("#checkTaskProcessor").text(i.Processor);$("#checkRedo").text(i.IsRedo?"已返工":"未返工");$("#checkResultDesc .textOn").text(i.CheckResultDesc);$("#checkProcessor").text(i.CheckProcessor);$("#checkAssignor").text(i.Assignor);$("#checkEstimatedTime .textOn").text(i.EstimatedTime);$("#checkScore .textOn").text(i.Score);$("#checkActualStartTime").text(i.ActualStartTime);$("#checkActualEndTime").text(i.ActualEndTime);$("#checkActualTime .textOn").text(i.ActualTime);$("#checkActualScore .textOn").text(i.ActualScore);$("#checkDesc").val(i.Desc);var s=function(n){return`<input type="checkbox" class="icb_minimal isEnable" value=${n}>`},h=function(n,t,i,r){return r.row+1},c=function(n){return`<span class="textOn">${n==null?"":n}</span><textarea class="form-control desc textIn hidden" style="resize: vertical;margin:auto;width:200px"></textarea>`},l=function(n){return`<span class="textOn">${n=="0001-01-01 00:00:00"?"":n.slice(0,n.indexOf(" "))}</span><input type="text" class="form_date form-control text-center checkTime textIn hidden" style="width:120px;cursor: pointer">`},a=function(n){var t=n.Result;return'<button type="button" class="btn btn-primary btn-{1} btn-sm result" onclick="updateCheckTask.call(this,{0},1)" disabled>通过<\/button><button type="button" class="btn btn-primary btn-{2} btn-sm result" onclick = "updateCheckTask.call(this,{0},2)" disabled>不通过<\/button>'.format(n.Id,t==1?"success":"info",t==2?"danger":"info")},v=function(n){return`<button type="button" class="btn btn-primary btn-sm" onclick="showImgModel('${n.ImageList}')"}>查看</button>`},f=i.Items,e={};for(r=0,o=f.length;r<o;r++)i=f[r],e[i.Id]=i;$("#checkDetailList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:f,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:"Id",title:"选择",render:s},{data:null,title:"序号",render:h},{data:"Item",title:"检验流程"},{data:"Method",title:"检验方法"},{data:"Desc",title:"检验说明",render:c},{data:"CheckTime",title:"检验时间",render:l},{data:null,title:"检验结果",render:a},{data:null,title:"图片",render:v}],drawCallback:function(){$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"});u!=3&&$(this).find(".isEnable").iCheck("disable");$(this).find(".form_date").attr("readonly",!0).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});$(this).find(".desc").parents("td").addClass("no-padding");$("#checkDetailList .isEnable").on("ifChanged",function(){var t=$(this).parents("tr"),r=$(this).is(":checked"),u,i,n;r?(u=$(this).val(),i=e[u],t.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden"),t.find(".desc").val(i.Desc),n=i.CheckTime,n=n=="0001-01-01 00:00:00"?"":n.slice(0,n.indexOf(" ")),t.find(".checkTime").val(n).datepicker("update")):t.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden");t.find(".result").prop("disabled",!r)})}});$("#showCheckModal").modal("show")}else $("#taskDesc").prop("disabled",!0),$("#taskDetailTable .textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"),$("#updateTask").val(i.State),$("#taskName").text(i.Item),$("#taskPlan").text(i.Plan),$("#taskProcessor").text(i.Processor),$("#taskAssignor").text(i.Assignor),$("#taskState").text(i.StateDesc),$("#taskRedo").text(i.IsRedo?"已返工":"未返工"),$("#taskEstimatedTime .textOn").text(i.EstimatedTime),$("#taskScore .textOn").text(i.Score),$("#taskActualStartTime").text(i.ActualStartTime),$("#taskActualEndTime").text(i.ActualEndTime),$("#taskActualTime .textOn").text(i.ActualTime),$("#taskActualScore .textOn").text(i.ActualScore),$("#taskDesc").val(i.Desc),$("#showTaskModal").modal("show")})}function updateCheckTask(n,t){var u=1028,r;if(!checkPermission(u)){layer.msg("没有权限");return}var f=$(this).parents("tr"),e=f.find(".desc").val(),i=f.find(".checkTime").val();i=isStrEmptyOrUndefined(i)?getFullTime():`${i} 00:00:00`;r={};r.opType=u;r.opData=JSON.stringify({Id:_taskDetailId,Items:[{CheckTime:i,Desc:e,Result:t,Id:n}]});ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);n.errno==0&&showDetailModal(_taskDetailId)})}function showImgModel(n){if($("#imgOld").empty(),$("#imgOldList").empty(),isStrEmptyOrUndefined(n))$("#imgOld").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgOld").append("图片：");n=n.split(",");var t={type:fileEnum.Manufacture,files:JSON.stringify(n)};ajaxPost("/Upload/Path",t,function(n){var i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(i="",t=0;t<n.data.length;t++)i+=`<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6">
                    <div class="thumbnail">
                    <img src=${n.data[t].path} style="height:200px">
                    </div>
                    </div>`;$("#imgOldList").append(i)})}$("#showImgModel").modal("show")}function updateTaskDetail(){var o=1028,s,t,i,r,n,u,f,e,h,c;if(!checkPermission(o)){layer.msg("没有权限");return}if(!_isClick){layer.msg("请先修改数据");return}s=$("#taskDesc").val();t=$("#taskEstimatedTime .hour").val();isStrEmptyOrUndefined(t)&&(t=0);i=$("#taskEstimatedTime .minute").val();isStrEmptyOrUndefined(i)&&(i=0);r=$("#taskActualScore .score").val();isStrEmptyOrUndefined(r)&&(r=0);n={Id:_taskDetailId,EstimatedHour:t,EstimatedMin:i,Score:r,Desc:s};u=$("#taskActualTime .hour").val();isStrEmptyOrUndefined(u)&&(u=0);f=$("#taskActualTime .minute").val();isStrEmptyOrUndefined(f)&&(f=0);e=$("#taskActualScore .score").val();isStrEmptyOrUndefined(e)&&(e=0);h=$("#updateCheck").val();h==3&&(n.ActualHour=u,n.ActualMin=f,n.ActualScore=e);c=function(){var t={};t.opType=o;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&showDetailModal(_taskDetailId)})};showConfirm("保存",c)}function updateCheckDetail(){var s=1028,h,t,i,r,n,u,f,e,o,c,l;if(!checkPermission(s)){layer.msg("没有权限");return}if(!_isClick){layer.msg("请先修改数据");return}if(h=$("#checkDesc").val(),t=$("#checkEstimatedTime .hour").val(),isStrEmptyOrUndefined(t)&&(t=0),i=$("#checkEstimatedTime .minute").val(),isStrEmptyOrUndefined(i)&&(i=0),r=$("#checkScore .score").val(),isStrEmptyOrUndefined(r)&&(r=0),n={Id:_taskDetailId,EstimatedHour:t,EstimatedMin:i,Score:r,Desc:h},u=$("#checkActualTime .hour").val(),isStrEmptyOrUndefined(u)&&(u=0),f=$("#checkActualTime .minute").val(),isStrEmptyOrUndefined(f)&&(f=0),e=$("#checkActualScore .score").val(),isStrEmptyOrUndefined(e)&&(e=0),o=$("#checkResultDesc .checkResult").val(),isStrEmptyOrUndefined(o)){layer.msg("请填写检验情况");return}c=$("#updateTask").val();c==3&&(n.ActualHour=u,n.ActualMin=f,n.ActualScore=e,n.CheckResultDesc=o);l=function(){var t={};t.opType=s;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&showDetailModal(_taskDetailId)})};showConfirm("保存",l)}function taskStartStop(n,t,i){var r=n?1032:1033,u;if(!checkPermission(r)){layer.msg("没有权限");return}u=function(){var n={};n.opType=r;n.opData=JSON.stringify({tId:t});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getTaskList()})};showConfirm(`${n?"启动":"停止"}任务：${i}`,u)}function delTask(n,t){var i=1030,r;if(!checkPermission(i)){layer.msg("没有权限");return}r=function(){var t={};t.opType=i;t.opData=JSON.stringify({tId:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getTaskList()})};showConfirm(`删除任务：${t}`,r)}function upTask(){}function addTask(){}var _isClick=!1,_taskDetailData=null,_taskDetailId=null;