function pageReady(){var n,t;$(".ms2").select2();getWorkGroup();n=getMonthScope();$("#sTime,#plansTime,#tasksTime").val(n.start).datepicker("update");$("#eTime,#planeTime,#taskeTime").val(n.end).datepicker("update");$("#monthTime").val(getNowMonth()).datepicker("update");t=0;$("#performance_chart,#plan_chart,#task_chart").on("resize",n=>{clearTimeout(t),t=setTimeout(()=>echarts.init($(`#${n.target.id}`)[0]).resize(),200)});$("#plan_li").one("click",()=>getPlan("#planItem"));$("#planAll").on("ifChanged",function(){$(this).is(":checked")?$("#planItem .icb_minimal").iCheck("check"):_planTime.length==$("#planItem").children().length&&$("#planItem .icb_minimal").iCheck("uncheck")});$("#planItem").on("ifChanged",".icb_minimal",function(){var n=$(this).val();$(this).is(":checked")?(_planTime.push(n),_planTime.length==$("#planItem").children().length&&$("#planAll").iCheck("check")):(_planTime.splice(_planTime.indexOf(n),1),_planTime.length==$("#planItem").children().length-1&&$("#planAll").iCheck("uncheck"))});$("#task_li").one("click",()=>getPlan("#taskItem"));$("#taskAll").on("ifChanged",function(){$(this).is(":checked")?$("#taskItem .icb_minimal").iCheck("check"):_taskTime.length==$("#taskItem").children().length&&$("#taskItem .icb_minimal").iCheck("uncheck")});$("#taskItem").on("ifChanged",".icb_minimal",function(){var n=$(this).val();$(this).is(":checked")?(_taskTime.push(n),_taskTime.length==$("#taskItem").children().length&&$("#taskAll").iCheck("check")):(_taskTime.splice(_taskTime.indexOf(n),1),_taskTime.length==$("#taskItem").children().length-1&&$("#taskAll").iCheck("uncheck"))});$("#finish_li").one("click",()=>getProcessor());$("#finishGroupSelect").on("select2:select",()=>getProcessor());echarts.init($("#finish_chart")[0]).on("click",n=>{var t=n.value,i;t[1]>4&&(i=_finishList[t[0]],$("#finishTime").text(t[0]),$("#finishProcessor").text(_finishProcessor),$("#finishList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"item",title:"任务名"},{data:"actualTime",title:"任务用时"}]}),$("#showFinishModel").modal("show"))})}function setChart(n,t,i,r,u){for(var o,f,s=[],h=[],e=0,c=n.length;e<c;e++)o=n[e],s.push(o[t]),h.push(o[i]);f=$.extend(!0,{},_option);f.xAxis.data=s;f.series.data=h;f.series.name=r;echarts.init($(u)[0]).setOption(f,!0)}function foldList(n){$(n).toggleClass("hidden");$(this).toggleClass("glyphicon-triangle-left glyphicon-triangle-right").prop("title",$(n).is(":hidden")?"展开":"收起")}function getWorkGroup(){var n={};n.opType=1077;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,n=>{var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$(".work-group").empty();var r=n.datas,u='<option value="0">所有<\/option>';for(t=0,f=r.length;t<f;t++)i=r[t],u+='<option value="{0}">{1}<\/option>'.format(i.Id,i.Group);$(".work-group").append(u)})}function getProcessor(){var t=$("#finishGroupSelect").val(),n={};n.opType=1081;n.opData=JSON.stringify({groupId:t,menu:!0});ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}$("#finishItem").empty();var r=n.datas,u="";for(t=0,f=r.length;t<f;t++)i=r[t],u+='<label class="flexStyle pointer"><input type="radio" class="icb_minimal" name="radio" value="{0}"><span class="textOverTop" style="margin-left: 5px" title="{1}">{1}<\/span><\/label>'.format(i.Account,i.Processor);$("#finishItem").append(u);$("#finishItem .icb_minimal").iCheck({handle:"radio",radioClass:"iradio_minimal-green",increaseArea:"20%"})})}function getPlan(n){var t={};t.opType=1039;ajaxPost("/Relay/Post",t,t=>{var i,e,r;if(t.errno!=0){layer.msg(t.errmsg);return}$(n).empty();var u=t.datas,f="";for(i=0,e=u.length;i<e;i++)r=u[i],f+='<label class="flexStyle pointer"><input type="checkbox" class="icb_minimal" value="{0}"><span class="textOverTop" style="margin-left: 5px" title="{1}">{1}<\/span><\/label>'.format(r.Id,r.Plan);$(n).append(f);$(`${n} .icb_minimal`).iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"})})}function getPerformanceChart(){var r=$("#workGroupSelect").val(),n,t,i;if(isStrEmptyOrUndefined(r)){layer.msg("请选择工作组");return}if(n=$("#sTime").val().trim(),t=$("#eTime").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请选择开始时间");return}if(isStrEmptyOrUndefined(t)){layer.msg("请选择结束时间");return}if(compareDate(n,t)){layer.msg("开始时间不能大于结束时间");return}n=`${n} 00:00:00`;t=`${t} 23:59:59`;i={};i.opType=1098;i.opData=JSON.stringify({gId:r,sTime:n,eTime:t});ajaxPost("/Relay/Post",i,n=>{if(n.errno!=0){layer.msg(n.errmsg);$("#performance_chart").addClass("hidden");return}$("#performance_chart").removeClass("hidden");setChart(n.datas,"Processor","Score","绩效","#performance_chart")})}function getPlanTimeChart(){var r=$("#planGroupSelect").val(),n,t,u,i;if(isStrEmptyOrUndefined(r)){layer.msg("请选择工作组");return}if(n=$("#plansTime").val().trim(),t=$("#planeTime").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请选择开始时间");return}if(isStrEmptyOrUndefined(t)){layer.msg("请选择结束时间");return}if(compareDate(n,t)){layer.msg("开始时间不能大于结束时间");return}if(n=`${n} 00:00:00`,t=`${t} 23:59:59`,!_planTime.length){layer.msg("请勾选计划号");return}u=_planTime.join(",");i={};i.opType=1099;i.opData=JSON.stringify({gId:r,sTime:n,eTime:t,planId:u});ajaxPost("/Relay/Post",i,n=>{if(n.errno!=0){layer.msg(n.errmsg);$("#plan_chart").addClass("hidden");return}$("#plan_chart").removeClass("hidden");setChart(n.datas,"Plan","Consume","实际用时","#plan_chart")})}function getTaskTimeChart(){var r=$("#taskGroupSelect").val(),n,t,u,i;if(isStrEmptyOrUndefined(r)){layer.msg("请选择工作组");return}if(n=$("#tasksTime").val().trim(),t=$("#taskeTime").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请选择开始时间");return}if(isStrEmptyOrUndefined(t)){layer.msg("请选择结束时间");return}if(compareDate(n,t)){layer.msg("开始时间不能大于结束时间");return}if(n=`${n} 00:00:00`,t=`${t} 23:59:59`,!_taskTime.length){layer.msg("请勾选计划号");return}u=_taskTime.join(",");i={};i.opType=1100;i.opData=JSON.stringify({gId:r,sTime:n,eTime:t,planId:u});ajaxPost("/Relay/Post",i,n=>{if(n.errno!=0){layer.msg(n.errmsg);$("#task_chart").addClass("hidden");return}$("#task_chart").removeClass("hidden");setChart(n.datas,"Item","Avg","平均用时","#task_chart")})}function getMonthDay(n){var t=n.split("-"),i=t[0]>>0,r=t[1]>>0,u=new Date(i,r,0).getDate();return{sTime:`${n}-01`,eTime:`${n}-${u}`}}function getTaskFinishChart(){var n=$("#monthTime").val().trim(),i,t;if(isStrEmptyOrUndefined(n)){layer.msg("请选择月份");return}var r=getMonthDay(n),f=r.sTime,e=r.eTime,u=$("#finishGroupSelect").val();if(isStrEmptyOrUndefined(u)){layer.msg("请选择工作组");return}if(i=$("#finishItem .icb_minimal:checked").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择操作员");return}_finishProcessor=$("#finishItem .icb_minimal:checked").parent().next().text();t={};t.opType=1101;t.opData=JSON.stringify({gId:u,sTime:`${f} 00:00:00`,eTime:`${e} 23:59:59`,account:i});ajaxPost("/Relay/Post",t,t=>{var h,f,v,y;if(t.errno!=0){layer.msg(t.errmsg);$("#finish_chart").addClass("hidden");return}$("#finish_chart").removeClass("hidden");for(var c=t.datas,r={},i=0,o=c.length;i<o;i++){var u=c[i],p=`${u.ActualHour==0?"":u.ActualHour+"h"}${u.ActualHour!=0&&u.ActualMin==0?"":u.ActualMin+"m"}`,s=u.ActualEndTime.split(" ")[0],l={item:u.Item,actualTime:p};r[s]?r[s].push(l):r[s]=[l]}_finishList=$.extend(!0,{},r);var w=getChartData(n,r),a=[],e=1;for(h in r)f=r[h],e=f.length>e?f.length:e,f.unshift(h,1),a.push(f);v=["一","二","三","四","五","六","七","八","九","十","十一","十二"];y={tooltip:{show:!1},visualMap:{show:!1,min:0,max:e,inRange:{color:["#fff","rgba(0,169,252,.1)"]}},calendar:{top:40,left:"center",cellSize:[180,100],range:n,itemStyle:{borderWidth:1},yearLabel:{show:!1},monthLabel:{show:!1},orient:"vertical",dayLabel:{margin:20,firstDay:1,nameMap:["周日","周一","周二","周三","周四","周五","周六"],fontSize:15,fontWeight:700},splitLine:{show:!1}},series:[{type:"scatter",coordinateSystem:"calendar",symbolSize:1,label:{show:!0,formatter:n=>{var t=n.value,r="";for(i=2,o=t.length;i<o;i++){if(i==6){r+="\n{more|点击查看更多}";break}r+=`
{time|${t[i].actualTime}}${t[i].item.length>7?t[i].item.slice(0,7)+"...":t[i].item}`}return r},fontSize:14,color:"#000",align:"left",offset:[-80,0],lineHeight:17,rich:{time:{color:"#00da88",fontSize:13,fontWeight:500,width:50},more:{color:"#ff5d5d",fontSize:12,padding:[0,0,0,42]}}},data:a},{type:"heatmap",coordinateSystem:"calendar",label:{show:!0,formatter:n=>{var i=echarts.number.parseDate(n.value[0]),t=i.getDate();return t==1&&(t=`{mon|${v[i.getMonth()]}月}${t}`),t},fontSize:14,fontWeight:700,color:"#000",position:"insideTopRight",rich:{mon:{backgroundColor:"#838a9d",color:"#fff",padding:5,borderRadius:50,fontWeight:800,lineHeight:0,fontSize:12}}},data:w}]};echarts.init($("#finish_chart")[0]).setOption(y,!0)})}function getChartData(n,t={}){for(var i,u=n.split("-"),e=+echarts.number.parseDate(n),o=+echarts.number.parseDate(`${u[0]}-${(u[1]>>0)+1}`),f=[],r=e;r<o;r+=864e5)i=echarts.format.formatTime("yyyy-MM-dd",r),f.push([i,t[i]?t[i].length:0]);return f}var _option={color:["#3398DB"],tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"3%",top:"6%",bottom:"8%",containLabel:!0},xAxis:{type:"category"},yAxis:{type:"value"},series:{type:"bar",barWidth:"60%",label:{show:!0,position:"top",formatter:n=>(n.value+"").indexOf(".")==-1?n.value:n.value.toFixed(2)}},dataZoom:[{type:"inside"},{handleIcon:_handleIcon,handleSize:"80%",handleStyle:{color:"#fff",shadowBlur:3,shadowColor:"rgba(0, 0, 0, 0.6)",shadowOffsetX:2,shadowOffsetY:2}}],toolbox:{left:"center",feature:{dataZoom:{yAxisIndex:"none"},restore:{}}}},_planTime=[],_taskTime=[],_finishProcessor=null,_finishList=null;