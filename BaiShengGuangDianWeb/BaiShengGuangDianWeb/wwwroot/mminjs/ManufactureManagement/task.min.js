function pageReady(){_permissionList[429]={uIds:["taskConfigModalBtn"]};_permissionList[460]={uIds:["addConfigBtn"]};_permissionList[461]={uIds:["updateConfigBtn"]};_permissionList[462]={uIds:["delConfigBtn"]};_permissionList[430]={uIds:["taskModuleModalBtn"]};_permissionList[467]={uIds:["addUpModuleBtn"]};_permissionList[468]={uIds:["updateModuleBtn"]};_permissionList[469]={uIds:["delModuleBtn"]};_permissionList[431]={uIds:["delTaskItemBtn"]};_permissionList[432]={uIds:["resetTaskBtn"]};_permissionList[433]={uIds:["updateTaskBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();getTaskConfig();$("#configItem").on("ifChanged",".isEnable",function(){var n=$(this).parents("tr"),i=$(this).val(),t=_taskItem[i],r,u;$(this).is(":checked")?(n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden"),r=t.GroupId,n.find(".group").val(r).trigger("change"),u=n.find(".processor"),setProcessorSelect(r,u),u.val(t.Person).trigger("change"),n.find(".module").val(t.ModuleId).trigger("change"),t.IsCheck?(n.find(".taskName").addClass("hidden").siblings().removeClass("hidden"),n.find(".taskNameSelect").val(t.CheckId).trigger("change")):n.find(".taskNameSelect").parent().addClass("hidden").siblings().removeClass("hidden"),n.find(".taskName").val(t.Item),n.find(".hour").val(t.EstimatedHour),n.find(".minute").val(t.EstimatedMin),n.find(".score").val(t.Score),n.find(".desc").val(t.Desc),n.find(".relation").val(n.find(".relationText").text()),_taskItemId.push(i)):(n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"),_taskItemId.splice(_taskItemId.indexOf(i),1))});$("#configItem").on("select2:select",".group",function(){var n=$(this).val(),t=$(this).parents("tr").find(".processor");setProcessorSelect(n,t)});$("#configItem").on("select2:select",".module",function(){var t=$(this).val(),i=$(this).find(`option[value=${t}]`).attr("isCheck"),n=$(this).parents("tr");parseInt(i)?n.find(".taskName").addClass("hidden").siblings().removeClass("hidden"):n.find(".taskNameSelect").parent().addClass("hidden").siblings().removeClass("hidden")});$("#selectConfig").on("select2:select",function(){getTaskConfigItem()});$("#configItem").on("input",".minute",function(){var n=$(this).val();parseInt(n)>59&&$(this).val(59)});$("#configItem").on("focus",".toZero",function(){var n=$(this).val();n==0&&$(this).val("")});$("#configItem").on("blur",".toZero",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#configItem").on("click",".moveUp",function(){var n,f,i,h,l;_isUpMove=!1;var t=$(this).parents("tr"),s=t.find(".relation"),a=s.is(":hidden"),u=a?t.find(".relationText").text():s.val();if(u=parseInt(u),n=t.find(".num").text(),n=parseInt(n),u+1==n){layer.msg("不能上移到关联任务前");return}for(f=t.nextAll(),i=0,h=f.length;i<h;i++){var c=f.eq(i),e=c.find(".relationText"),o=c.find(".relation"),r=n-1;switch(parseInt(e.text())){case n:e.text(r);break;case r:e.text(n)}switch(parseInt(o.val())){case n:o.val(r);break;case r:o.val(n)}}l=t.prev();l.before(t);setTableStyle()});$("#configItem").on("input",".relation",function(){var t=$(this).val(),i=$(this).parents("tr"),n=i.find(".num").text();n=(n>>0)-1;t>>0>n&&$(this).val(t.slice(0,-1))});$("#configSelect").on("select2:select",function(){$("#newConfig").val($(this).find("option:checked").text())});$("#configReuse").on("ifChanged",function(){$(this).is(":checked")?$("#updateConfigBtn").attr("disabled","disabled"):$("#updateConfigBtn").removeAttr("disabled")});$("#moduleSelect").on("select2:select",function(){$("#newModule").val($(this).find("option:checked").text())});$(".maxHeight").css("maxHeight",innerHeight*.7)}function setProcessorSelect(n,t){var f,u,i,e,r;for(t.empty(),f='<option value = "{0}">{1}<\/option>',u="",i=0,e=_processor.length;i<e;i++)r=_processor[i],n==r.GroupId&&(u+=f.format(r.Id,r.Processor));t.append(u)}function getTaskConfig(){var n={};n.opType=1051;ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}var r=n.datas,u="";for(_taskConfigName=[],t=0,f=r.length;t<f;t++)i=r[t],_taskConfigName.push(i.Task),u+='<option value = "{0}">{1}<\/option>'.format(i.Id,i.Task);$(".selectConfig").empty();$(".selectConfig").append(u);$("#configSelect").val(0).trigger("change");taskTrData()})}function getGroup(n){var t={};t.opType=1077;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var i,e,r;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,f="";for(i=0,e=u.length;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Group);n!=null&&n(f)})}function getProcessor(n){var t={};t.opType=1081;t.opData=JSON.stringify({groupId:0,menu:!0});ajaxPost("/Relay/Post",t,function(t){var f,r,i,e,u;if(t.errno!=0){layer.msg(t.errmsg);return}for(_processor=t.datas,f='<option value = "{0}">{1}<\/option>',r="",i=0,e=_processor.length;i<e;i++)u=_processor[i],r+=f.format(u.Id,u.Processor);n!=null&&n(r)})}function getModule(n){var t={};t.opType=1058;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var r,e,i;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,f="";for(_moduleName=[],r=0,e=u.length;r<e;r++)i=u[r],_moduleName.push(i.Module),f+='<option value = "{0}" isCheck = "{2}">{1}<\/option>'.format(i.Id,i.Module,i.IsCheck);n!=null&&n(f)})}function getTaskName(n){var t={};t.opType=1066;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var r,e,u;if(t.errno!=0){layer.msg(t.errmsg);return}var f=t.datas,i="";for(r=0,e=f.length;r<e;r++)u=f[r],i+='<option value = "{0}">{1}<\/option>'.format(u.Id,u.Check);i=`<select class="ms2 form-control taskNameSelect">${i}</select>`;n!=null&&n(i)})}function setTableStyle(){for(var t=$("#configItem tr .num"),n=0,i=t.length;n<i;n++)t.eq(n).text(n+1);$("#configItem").find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"});$("#configItem").find(".ms2").select2();$("#configItem .moveUp").removeClass("hidden");$("#configItem .moveUp").eq(0).addClass("hidden")}function taskTrData(){var n=new Promise(function(n){getGroup(n)}),t=new Promise(function(n){getProcessor(n)}),i=new Promise(function(n){getModule(n)}),r=new Promise(function(n){getTaskName(n)});Promise.all([n,t,i,r]).then(function(n){_taskTrData=`<tr>
            <td><input type="checkbox" class="icb_minimal isEnable" value={0}></td>
            <td class="num"></td>
            <td>
            <span class="textOn">{1}</span>
            <div class="flexStyle textIn hidden" style="width: 240px;margin:auto"><select class="ms2 form-control group">${n[0]}</select><select class="ms2 form-control processor">${n[1]}</select></div>
            </td>
            <td><span class="textOn">{2}</span><div class="textIn hidden" style="width: 120px;margin:auto"><select class="ms2 form-control module">${n[2]}</select></div></td>
            <td><span class="textOn">{3}</span><div class="textIn hidden" style="width: 120px;margin:auto"><input type="text" class="form-control text-center taskName" maxlength="20"><div>${n[3]}</div></div></td>
            <td><span class="textOn">{4}</span>
            <div class="flexStyle textIn hidden" style="width:140px;margin:auto">
            <input type="text" class="form-control text-center hour toZero" maxlength="3" onkeyup="onInput(this, 3, 0)" onblur="onInputEnd(this)">
            <label class="control-label" style="white-space: nowrap; margin: 0">小时</label>
            <input type="text" class="form-control text-center minute toZero" maxlength="3" onkeyup="onInput(this, 2, 0)" onblur="onInputEnd(this)">
            <label class="control-label" style="white-space: nowrap; margin: 0">分</label>
            </div>
            </td>
            <td><span class="textOn">{5}</span><input type="text" class="form-control text-center textIn hidden score toZero" maxlength="3" onkeyup="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto"></td>
            <td class="no-padding"><span class="textOn">{6}</span><textarea class="form-control textIn hidden desc" maxlength="500" style="resize: vertical;width:180px;margin:auto"></textarea></td>
            <td><span class="textOn relationText">{7}</span><input type="text" class="form-control text-center textIn hidden relation toZero" maxlength="10" onkeyup="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto"></td>
            <td><button type="button" class="btn btn-primary btn-sm moveUp">上移</button></td>
            </tr>`;_addTaskTr=`<tr>
            <td></td>
            <td class="num"></td>
            <td>
            <div class="flexStyle" style="width: 240px;margin:auto"><select class="ms2 form-control group">${n[0]}</select><select class="ms2 form-control processor">${n[1]}</select></div>
            </td>
            <td><div style="width: 120px;margin:auto"><select class="ms2 form-control module">${n[2]}</select></div></td>
            <td><div style="width: 120px;margin:auto"><input type="text" class="form-control text-center taskName" maxlength="20"><div class="hidden">${n[3]}</div></div></td>
            <td>
            <div class="flexStyle" style="width:140px;margin:auto">
            <input type="text" class="form-control text-center hour toZero" maxlength="3" onkeyup="onInput(this, 3, 0)" onblur="onInputEnd(this)" value="0">
            <label class="control-label" style="white-space: nowrap; margin: 0">小时</label>
            <input type="text" class="form-control text-center minute toZero" maxlength="3" onkeyup="onInput(this, 2, 0)" onblur="onInputEnd(this)" value="0">
            <label class="control-label" style="white-space: nowrap; margin: 0">分</label>
            </div>
            </td>
            <td><input type="text" class="form-control text-center score toZero" maxlength="3" onkeyup="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto" value="0"></td>
            <td class="no-padding"><textarea class="form-control desc" maxlength="500" style="resize: vertical;width:180px;margin:auto"></textarea></td>
            <td><input type="text" class="form-control text-center relation toZero" maxlength="10" onkeyup="onInput(this, 3, 0)" onblur="onInputEnd(this)" style="width:80px;margin:auto" value="0"></td>
            <td><button type="button" class="btn btn-primary btn-sm moveUp">上移</button></td>
            </tr>`;getTaskConfigItem()})}function getTaskConfigItem(){var t,n;(_taskItemId=[],t=$("#selectConfig").val(),isStrEmptyOrUndefined(t))||(n={},n.opType=1055,n.opData=JSON.stringify({taskId:t}),ajaxPost("/Relay/Post",n,function(t){var u,r,f,i;if(t.errno!=0){layer.msg(t.errmsg);return}for($("#configItem").empty(),n=t.datas,_taskItem={},u="",r=0,f=n.length;r<f;r++)i=n[r],_taskItem[i.Id]=i,u+=_taskTrData.format(i.Id,i.Processor,i.Module,i.Item,i.EstimatedTime,i.Score,i.Desc,i.Relation==0?"":i.Relation);$("#configItem").append(u);setTableStyle()}))}function updateTask(){var b=$("#selectConfig").val(),l,y,h,a,r,c,u,f,e,p,o,w,t,g;if(isStrEmptyOrUndefined(b)){layer.msg("请选择配置");return}var k=[],i,v=$("#configItem tr").length,nt=$("#configItem .isEnable").is(":checked"),tt=$("#configItem .isEnable").length;if(!v||tt==v&&!nt&&_isUpMove){layer.msg("请先修改数据");return}for(i=0;i<v;i++){var n=$("#configItem tr").eq(i),d=n.find(".isEnable"),s=d.val();if(isStrEmptyOrUndefined(s)&&(s=0),d.is(":checked")||s==0){if(w=n.find(".processor"),l=w.val(),isStrEmptyOrUndefined(l)){layer.msg(`序列${i+1}：请选择操作员`);return}if(y=w.find("option:selected").text(),h=n.find(".module").val(),isStrEmptyOrUndefined(h)){layer.msg(`序列${i+1}：请选择模块名`);return}if(a=!!parseInt(n.find(".module").find(`option[value=${h}]`).attr("isCheck")),a){if(r=n.find(".taskNameSelect").val(),isStrEmptyOrUndefined(r)){layer.msg(`序列${i+1}：请选择检验任务`);return}c=n.find(`.taskNameSelect option[value=${r}]`).text();r=parseInt(r)}else if(r=0,c=n.find(".taskName").val(),isStrEmptyOrUndefined(c)){layer.msg(`序列${i+1}：任务名不能为空`);return}u=n.find(".hour").val();isStrEmptyOrUndefined(u)&&(u=0);u=parseInt(u);f=n.find(".minute").val();isStrEmptyOrUndefined(f)&&(f=0);f=parseInt(f);e=n.find(".score").val();isStrEmptyOrUndefined(e)&&(e=0);e=parseInt(e);p=n.find(".desc").val();o=n.find(".relation").val()}else t=_taskItem[s],l=t.Person,y=t.Processor,h=t.ModuleId,a=t.IsCheck,r=t.CheckId,c=t.Item,u=t.EstimatedHour,f=t.EstimatedMin,e=t.Score,p=t.Desc,o=n.find(".relationText").text();isStrEmptyOrUndefined(o)&&(o=0);o=parseInt(o);k.push({TaskId:b,Order:i+1,Person:l,Processor:y,ModuleId:h,IsCheck:a,CheckId:r,Item:c,EstimatedHour:u,EstimatedMin:f,Score:e,Desc:p,Relation:o,Id:s})}g=function(){var n={};n.opType=1056;n.opData=JSON.stringify(k);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getTaskConfigItem()})};showConfirm("保存",g)}function addTask(){$("#configItem").append(_addTaskTr);var n=$("#configItem tr:last"),t=n.find(".module option:selected").attr("ischeck");parseInt(t)?n.find(".taskName").addClass("hidden").siblings().removeClass("hidden"):n.find(".taskName").removeClass("hidden").siblings().addClass("hidden");setTableStyle();n.find(".group").trigger("select2:select");$("#configTable").scrollTop($("#configTable")[0].scrollHeight)}function delTaskItem(){var i=_taskItemId.length,t,n,r;if(!i){layer.msg("请选择需要删除的数据");return}for(t=[],n=0;n<i;n++)t.push(_taskItem[_taskItemId[n]].Item);r=function(){var n={};n.opType=1057;n.opData=JSON.stringify({ids:_taskItemId});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getTaskConfigItem()})};showConfirm(`删除以下任务配置项:<pre style='color:red'>${t.join("<br>")}</pre>`,r)}function resetTask(){getTaskConfigItem()}function taskConfigModal(){$("#configSelect").val(0).trigger("change");$("#newConfig").val("");$("#configReuse").iCheck("uncheck");$("#taskConfigModal").modal("show")}function delConfig(){var n=$("#configSelect").val(),t;if(isStrEmptyOrUndefined(n)){layer.msg("请选择配置");return}t=function(){var t={};t.opType=1054;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getTaskConfig()})};showConfirm("删除配置："+$("#configSelect option:selected").text(),t)}function addConfig(){var n=$("#newConfig").val().trim(),t,i,r;if(isStrEmptyOrUndefined(n)){layer.msg("新配置不能为空");return}if(t=$("#configSelect").val(),i=$("#configReuse").is(":checked"),i&&isStrEmptyOrUndefined(t)){layer.msg("请选择配置");return}if(_taskConfigName.includes(n)){layer.msg("新配置已存在");return}r=function(){var r={};r.opType=1053;r.opData=JSON.stringify({Task:n,CopyId:i?t:0});ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);n.errno==0&&(getTaskConfig(),$("#newConfig").val(""),$("#configReuse").iCheck("uncheck"))})};showConfirm("新增配置："+n,r)}function updateConfig(){var n=$("#newConfig").val().trim(),r=$("#configSelect option:selected").text(),t=$("#configSelect").val(),i;if(isStrEmptyOrUndefined(t)){layer.msg("请选择配置");return}if(isStrEmptyOrUndefined(n)){layer.msg("新配置不能为空");return}if(_taskConfigName.includes(n)){layer.msg("新配置已存在");return}i=function(){var i={};i.opType=1052;i.opData=JSON.stringify({Id:t,Task:n});ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);n.errno==0&&(getTaskConfig(),$("#newConfig").val(""),$("#configReuse").iCheck("uncheck"))})};showConfirm("修改配置："+r,i)}function taskModuleModal(){$("#moduleSelect").empty();new Promise(function(n){getModule(n)}).then(n=>{$("#moduleSelect").append(n),$("#moduleSelect").val(0).trigger("change")});$("#newModule").val("");$("#isCheckout").iCheck("uncheck");$("#taskModuleModal").modal("show")}function delModule(){var n=$("#moduleSelect").val(),t;if(isStrEmptyOrUndefined(n)){layer.msg("请选择模块");return}t=function(){var t={};t.opType=1061;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&(taskModuleModal(),taskTrData())})};showConfirm("删除模块："+$("#moduleSelect option:selected").text(),t)}function addUpModule(n){var f=n?1059:1060,t=$("#newModule").val().trim(),r=$("#moduleSelect").val(),e=$("#moduleSelect option:selected").text(),o=$("#isCheckout").is(":checked"),i,u;if(n&&isStrEmptyOrUndefined(r)){layer.msg("请选择模块");return}if(isStrEmptyOrUndefined(t)){layer.msg("新模块不能为空");return}if(_moduleName.includes(t)){layer.msg("新模块已存在");return}i={Module:t,IsCheck:o};n&&(i.Id=r);u=function(){var n={};n.opType=f;n.opData=JSON.stringify(i);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&(taskModuleModal(),taskTrData())})};showConfirm(`${n?"修改":"新增"}模块：${n?e:t}`,u)}var _permissionList=[],_taskConfigName=null,_processor=null,_moduleName=null,_taskTrData=null,_taskItem=null,_isUpMove=!0,_addTaskTr=null,_taskItemId=[];