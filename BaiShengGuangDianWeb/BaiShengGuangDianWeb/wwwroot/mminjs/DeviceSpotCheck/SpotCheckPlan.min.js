function pageReady(){$(".ms2").select2();getSpotPlan();$("#spotPlanSelect").on("select2:select",function(){_planId=$(this).val();getSpotCheckList()});$("#addSpotPlanBody").on("click",".delSpotCheckTr",function(){_spotCheckCount--;var n=$(this).parents("tr");n.remove();_spotCheckCount?setTableTrCount($("#addSpotPlanBody"),_spotCheckCount):($("#addSpotPlanCheckBtn").removeClass("hidden"),$("#addSpotPlanCheckTable").addClass("hidden"))});$("#addSpotPlanBody").on("click",".addSpotCheckTr",function(){_spotCheckCount++;var n=$(this).parents("tr"),t=setSpotCheckOption(_spotCheckCount);n.after(t);$("#addSpotPlanBody").find(".radio1").iCheck("check");setTableStyle($("#addSpotPlanBody"));setTableTrCount($("#addSpotPlanBody"),_spotCheckCount)});$("#addSpotPlanBody").on("ifChecked",".radioSelect",function(){var n=$(this).parents("td");setStatus(n)});$("#addSpotPlanBody, #spotCheckList").on("focusin",".numVal",function(){var n=$(this).val();n==0&&$(this).val("")});$("#addSpotPlanBody, #spotCheckList").on("focusout",".numVal",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#addSpotPlanCheckBtn").on("click",function(){$(this).addClass("hidden");$("#addSpotPlanCheckTable").removeClass("hidden");setOneSpotPlanCheckTr()})}function getSpotPlan(){var t=600,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var i;if(n.errno!=0){layer.msg(n.errmsg);return}$(".spotPlanSelect").empty();for(var r=n.datas,f=r.length,u="",t=0;t<f;t++)i=r[t],u+='<option value="{0}">{1}<\/option>'.format(i.Id,i.Plan);if($(".spotPlanSelect").append(u),_planId){$("#spotPlanSelect").val(_planId).trigger("change");return}getSpotCheckList()})}function remindIntervalOption(){for(var t=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],i='<option value="{0}">{1}<\/option>',r="",u="",n=0;n<24;n++)u+=i.format(n,`${n}:00`),t[n]&&(r+=i.format(n,t[n]));return{weekOp:r,hourOp:u,op:'<div style="display:flex;justify-content:center;align-items:center"><input type="radio" class="icb_minimal radio1 radioSelect icb_check" name="{2}"><span>设置1：<\/span><input class="form-control numTime radioOp1" maxlength="2" oninput="value=value.replace(/[^\\d]/g,\'\')" style="width:50px" value="1"><select class="form-control timeSelect radioOp1" style="width:60px"><option value="0">日<\/option><option value="1">月<\/option><\/select><select class="form-control normalHour radioOp1" style="width:80px">{0}<\/select><\/div><div style="display:flex;justify-content:center;align-items:center"><input type="radio" class="icb_minimal radio2 radioSelect icb_check" name="{2}"><span>设置2：<\/span><select class="form-control weekSelect radioOp2" style="width:110px">{1}<\/select><select class="form-control weekHour radioOp2" style="width:80px">{0}<\/select><\/div>'}}function getSpotCheckList(){var t,n;if(_spotCheckBodyRow=0,_spotCheckIdData=[],_spotCheckNameData=[],t=605,!checkPermission(t)){layer.msg("没有权限");return}(_planId=$("#spotPlanSelect").val(),isStrEmptyOrUndefined(_planId))||(n={},n.opType=t,n.opData=JSON.stringify({qId:_planId}),ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var i=n.datas,r=-1,f=function(n){return r++,`<input type="checkbox" class="icb_minimal isEnable" id=${r} value=${n}>`},e=0,o=function(){return++e},s=function(n){return`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn item hidden" maxlength="10" style="width:100px" value=${n}>`},h=function(){return'<input type="checkbox" class="icb_minimal using icb_check prominent">'},c=function(){return'<input type="checkbox" class="icb_minimal remind icb_check prominent">'},l=function(n){return`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn min numVal hidden" maxlength="10" oninput="value=value.replace(/[^\d]/g,'')" style="width:80px" value=${n}>`},a=function(n){return`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn max numVal hidden" maxlength="10" oninput="value=value.replace(/[^\d]/g,'')" style="width:80px" value=${n}>`},v=function(n){return`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn unit hidden" maxlength="5" style="width:80px" value=${n}>`},y=function(n){return`<span class="textOn">${n}</span><textarea class="form-control textIn reference hidden" maxlength="500" style="resize: vertical;width:180px">${n}</textarea>`},p=function(n){return`<span class="textOn">${n}</span><textarea class="form-control textIn remarks hidden" maxlength="500" style="resize: vertical;width:180px">${n}</textarea>`},t=remindIntervalOption(),u=0,w=function(n){var o,i,s,h;u++;o=n.Interval;i="";switch(o){case 1:var f=n.Day,e=n.Month,r=n.NormalHour;f||e?(f&&(i=f==1?`每日${r}点`:`每${f}日${r}点`),e&&(i=e==1?`每月${r}点`:`每${e}月${r}点`)):i=`每日${r}点`;break;case 2:s="日一二三四五六";i=`每周${s[n.Week]}${n.WeekHour}点`;break;default:i=""}return h=t.op.format(t.hourOp,t.weekOp,`spotCheck${u}`),`<span class="textOn">${i}</span><div class="textIn hidden">${h}</div>`};$("#spotCheckList").DataTable({destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"选择",render:f},{data:null,title:"序号",render:o},{data:"Item",title:"名称",render:s},{data:"Enable",title:"启用",render:h},{data:"Remind",title:"提醒",render:c},{data:"Min",title:"下限",render:l},{data:"Max",title:"上限",render:a},{data:"Unit",title:"单位",render:v},{data:"Reference",title:"参考标准",render:y},{data:"Remarks",title:"备注",render:p},{data:null,title:"提醒间隔",render:w}],columnDefs:[{orderable:!1,targets:0}],createdRow:function(n,t){_spotCheckBodyRow++;t.Enable?$(n).find(".using").iCheck("check"):$(n).find(".using").iCheck("uncheck");t.Remind?$(n).find(".remind").iCheck("check"):$(n).find(".remind").iCheck("uncheck")},drawCallback:function(){var n,r,t,u;setTableStyle($("#spotCheckList"));$("#spotCheckList .isEnable").on("ifChanged",function(){var n=$(this).parents("tr"),f,t,r,u,e,o;setUpdateStatus($(this),n);f=parseInt($(this).attr("id"));t=i[f];n.find(".item").val(t.Item);t.Enable?n.find(".using").iCheck("check"):n.find(".using").iCheck("uncheck");t.Remind?n.find(".remind").iCheck("check"):n.find(".remind").iCheck("uncheck");n.find(".min").val(t.Min);n.find(".max").val(t.Max);n.find(".unit").val(t.Unit);n.find(".reference").val(t.Reference);n.find(".remarks").val(t.Remarks);switch(t.Interval){case 1:n.find(".radio1").iCheck("check");t.Day&&(n.find(".numTime").val(t.Day),n.find(".timeSelect").val(0));t.Month&&(n.find(".numTime").val(t.Month),n.find(".timeSelect").val(1));n.find(".normalHour").val(t.NormalHour);n.find(".weekSelect").val(0);n.find(".weekHour").val(0);break;case 2:n.find(".radio2").iCheck("check");n.find(".weekSelect").val(t.Week);n.find(".weekHour").val(t.WeekHour);n.find(".numTime").val(1);n.find(".timeSelect").val(0);n.find(".normalHour").val(0);break;default:n.find(".radio1").iCheck("uncheck");n.find(".radio2").iCheck("uncheck")}r=$(this).val();u=t.Item;$(this).is(":checked")?(n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden"),_spotCheckIdData.push(r),_spotCheckNameData.push(u)):(e=_spotCheckIdData.indexOf(r),o=_spotCheckNameData.indexOf(u),_spotCheckIdData.splice(e,1),_spotCheckNameData.splice(o,1),n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"))});$("#spotCheckList .radioSelect").on("ifChecked",function(){var n=$(this).parents("td");setStatus(n)});for(r=$("#spotCheckList .isEnable").length,n=0;n<r;n++)t=$("#spotCheckList .isEnable").eq(n),u=t.parents("tr"),setUpdateStatus(t,u)}})}))}function setStatus(n){n.find(".icb_check").iCheck("enable");n.find(".textIn").attr("disabled",!1);n.find(".radioOp1,.radioOp2").attr("disabled",!0);n.find(".radio1").is(":checked")&&n.find(".radioOp1").attr("disabled",!1);n.find(".radio2").is(":checked")&&n.find(".radioOp2").attr("disabled",!1)}function setUpdateStatus(n,t){n.is(":checked")?setStatus(t):(t.find(".icb_check").iCheck("disable"),t.find(".radioOp1, .radioOp2, .textIn").attr("disabled",!0))}function showUpdateSpotPlan(){_planId&&$("#updateSpotPlanSelect").val(_planId).trigger("change");var n=$("#updateSpotPlanSelect").find(`[value=${_planId}]`).text();$("#updateSpotPlan").val(n);$("#updateSpotPlanModal").modal("show")}function updateSpotPlan(){var i=601,n,t,r;if(!checkPermission(i)){layer.msg("没有权限");return}if(n=parseInt($("#updateSpotPlanSelect").val()),isStrEmptyOrUndefined(n)){layer.msg("请选择点检计划");return}if(t=$("#updateSpotPlan").val().trim(),isStrEmptyOrUndefined(t)){layer.msg("计划名不能为空");return}r=function(){var r={};r.opType=i;r.opData=JSON.stringify({id:n,Plan:t});ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);$("#updateSpotPlanModal").modal("hide");n.errno==0&&getSpotPlan()})};showConfirm("修改",r)}function setSpotCheckOption(n){var t=remindIntervalOption();return t=t.op.format(t.hourOp,t.weekOp,`addSpotCheck${n}`),'<tr><td class="num" style="font-weight:bold"><\/td><td><input type="text" class="form-control text-center item" maxlength="10" style="width:170px"><\/td><td><input type="checkbox" class="icb_minimal using prominent"><\/td><td><input type="checkbox" class="icb_minimal remind prominent"><\/td><td><input type="text" class="form-control text-center min numVal" value="0" oninput="value=value.replace(/[^\\d]/g,\'\')" maxlength="10" style="width:80px"><\/td><td><input type="text" class="form-control text-center max numVal" value="0" oninput="value=value.replace(/[^\\d]/g,\'\')" maxlength="10" style="width:80px"><\/td><td><input type="text" class="form-control text-center unit" maxlength="5" style="width:80px"><\/td><td><textarea class="form-control reference" maxlength="500" style="resize:vertical;width:400px"><\/textarea><\/td><td><textarea class="form-control remarks" maxlength="500" style="resize:vertical;width:400px"><\/textarea><\/td><td>{0}<\/td><td style="width:100px"><button type="button" class="btn btn-danger delSpotCheckTr"><i class="fa fa-minus"><\/i><\/button><button type="button" class="btn btn-success addSpotCheckTr" style="margin-left:5px"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>'.format(t)}function setTableTrCount(n,t){for(var i=0;i<t;i++)n.find(".num").eq(i).text(i+1)}function setTableStyle(n){n.find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"});n.find(".prominent").iCheck({handle:"checkbox",checkboxClass:"icheckbox_polaris",increaseArea:"20%"})}function setOneSpotPlanCheckTr(){_spotCheckCount++;$("#addSpotPlanBody").empty();var n=setSpotCheckOption(_spotCheckCount);$("#addSpotPlanBody").append(n);setTableTrCount($("#addSpotPlanBody"),_spotCheckCount);setTableStyle($("#addSpotPlanBody"));$("#addSpotPlanBody").find(".radio1").iCheck("check")}function addSpotPlanCheckModal(n){_spotCheckCount=0;_isPlanOP=n;$("#addSpotPlan").val("");$("#addSpotPlanCheck").val(_planId).trigger("change");$("#addSpotPlanModal").find(".planCheckOp").eq(n).removeClass("hidden").siblings(".planCheckOp").addClass("hidden");n?($("#addSpotPlanModalTitle").text("添加新点检项"),$("#addSpotPlanCheckBtn").addClass("hidden"),$("#addSpotPlanCheckTable").removeClass("hidden"),setOneSpotPlanCheckTr()):($("#addSpotPlanModalTitle").text("添加新计划"),$("#addSpotPlanCheckBtn").removeClass("hidden"),$("#addSpotPlanCheckTable").addClass("hidden"),$("#addSpotPlanBody").empty());$("#addSpotPlanModal").modal("show")}function getSpotCheckData(n,t){var i=n.find("tr").eq(t),e=i.find(".item").val().trim();if(isStrEmptyOrUndefined(e))return layer.msg("点检名称不能为空"),1;var c=i.find(".using").is(":checked"),l=i.find(".remind").is(":checked"),a=i.find(".min").val().trim(),v=i.find(".max").val().trim(),y=i.find(".unit").val().trim(),p=i.find(".reference").val().trim(),w=i.find(".remarks").val().trim(),f,r=0,u=0,o=0,s=0,h=0;if(i.find(".radio1").is(":checked")){if(f=1,i.find(".timeSelect").val()==1){if(u=i.find(".numTime").val().trim(),isStrEmptyOrUndefined(u))return layer.msg("请输入月数"),1;if(u==0)return layer.msg("月数不能为零"),1}else{if(r=i.find(".numTime").val().trim(),isStrEmptyOrUndefined(r))return layer.msg("请输入天数"),1;if(r==0)return layer.msg("天数不能为零"),1}o=i.find(".normalHour").val()}else f=2,s=i.find(".weekSelect").val(),h=i.find(".weekHour").val();return{Item:e,Enable:c,Remind:l,Min:parseInt(a),Max:parseInt(v),Unit:y,Reference:p,Remarks:w,Interval:f,Day:parseInt(r),Month:parseInt(u),NormalHour:o,Week:s,WeekHour:h}}function addSpotPlan(){var i,r=[],u,f,t=0,n,e,o;if(_isPlanOP){if(i=607,!checkPermission(i)){layer.msg("没有权限");return}if(f=$("#addSpotPlanCheck").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择点检计划");return}if(!_spotCheckCount){layer.msg("至少设置一条计划点检项");return}for(;t<_spotCheckCount;t++){if(n=getSpotCheckData($("#addSpotPlanBody"),t),n==1)return;n.PlanId=f;r.push(n)}u=r}else{if(i=602,!checkPermission(i)){layer.msg("没有权限");return}if(u={},e=$("#addSpotPlan").val().trim(),isStrEmptyOrUndefined(e)){layer.msg("新计划不能为空");return}for(u.Plan=e;t<_spotCheckCount;t++){if(n=getSpotCheckData($("#addSpotPlanBody"),t),n==1)return;r.push(n)}r.length&&(u.SpotCheckItems=r)}o=function(){var n={};n.opType=i;n.opData=JSON.stringify(u);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);$("#addSpotPlanModal").modal("hide");n.errno==0&&(getSpotPlan(),_isPlanOP&&_planId==f&&getSpotCheckList())})};showConfirm("添加",o)}function delSpotPlan(){var t=603,n,i,r;if(!checkPermission(t)){layer.msg("没有权限");return}if(n=_planId,isStrEmptyOrUndefined(n)){layer.msg("请选择点检计划");return}i=$("#spotPlanSelect").find(`[value=${n}]`).text();r=function(){var i={};i.opType=t;i.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);n.errno==0&&(_planId=null,getSpotPlan())})};showConfirm("删除点检计划："+i,r)}function updateSportPlanCheck(){var f=606,e,r,i,u,n,t,o,s;if(!checkPermission(f)){layer.msg("没有权限");return}if(e=_planId,r=$("#spotCheckList tbody"),!_spotCheckBodyRow){layer.msg("未检测到点检项数据");return}for(i=[],u=r.find(".isEnable"),n=0;n<_spotCheckBodyRow;n++)if(u.eq(n).is(":checked")){if(t=getSpotCheckData(r,n),t==1)return;t.PlanId=e;o=u.eq(n).val();t.id=o;i.push(t)}if(!i.length){layer.msg("请选择需要修改的数据");return}s=function(){var n={};n.opType=f;n.opData=JSON.stringify(i);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getSpotCheckList()})};showConfirm("修改",s)}function delSpotPlanCheck(){var n=608,t,i;if(!checkPermission(n)){layer.msg("没有权限");return}if(!_spotCheckIdData.length){layer.msg("请选择要删除的点检项");return}t=_spotCheckNameData.join("<br>");i=function(){var t={};t.opType=n;t.opData=JSON.stringify({ids:_spotCheckIdData});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getSpotCheckList()})};showConfirm(`删除以下点检项：<pre style="color:red">${t}</pre>`,i)}var _planId=null,_spotCheckCount=0,_isPlanOP=null,_spotCheckBodyRow=0,_spotCheckIdData=[],_spotCheckNameData=[];