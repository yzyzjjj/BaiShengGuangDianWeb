function pageReady(){$(".ms2").select2();$("ul .setTitle").on("click",function(){var n=$(this).text();$("#pageTitle").text(`${n}点检计划`)});getWorkShop();$("#workShopRecent").on("select2:select",function(){var n=$(this).val();getWorkShopDevice(n,$("#workShopDeviceRecent"),0);$("#workShopDetail").val(n).trigger("change");getWorkShopDevice(n,$("#workShopDeviceDetail"),!0)});$("#workShopDeviceRecent, #spotPlanRecent").on("select2:select",function(){getThisCheckList();getNextExamineList()});$("#workShopDetail").on("select2:select",function(){var n=$(this).val();getWorkShopDevice(n,$("#workShopDeviceDetail"),1)});$("#workShopDeviceDetail, #spotPlanDetail").on("select2:select",function(){detailPage(null,null,!0)});$("#startTime").val(getDate()).datepicker("update");$("#endTime").val(getDate()).datepicker("update");$("#historyHead").on("click",function(){var n=$("#history").hasClass("active");n||(detailPage(null,null,!1),_selectTime=!0)});$("#workShopHistory").on("select2:select",function(){var n=$(this).val();getWorkShopDevice(n,$("#workShopDeviceHistory"),2)});$("#workShopDeviceHistory, #spotPlanHistory").on("select2:select",function(){detailPage(null,null,!1)});$(".selectTime").datepicker({onSelect:selectDate}).on("changeDate",selectDate);$("#imgOldList").on("click",".delImg",function(){$(this).parents(".imgOption").remove();var n=$(this).val();_imgNameData.splice(_imgNameData.indexOf(n),1)})}function selectDate(){_selectTime&&detailPage(null,null,!1)}function getWorkShop(){var t=162,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var u;if(n.errno!=0){layer.msg(n.errmsg);return}$(".workShop").empty();for(var i=n.datas,f=i.length,r="",t=0;t<f;t++)u=i[t],r+='<option value = "{0}">{0}<\/option>'.format(u.SiteName);$(".workShop").append(r);getWorkShopDevice()})}function getWorkShopDevice(n,t,i){var u=163,r;if(!checkPermission(u)){layer.msg("没有权限");return}if(isStrEmptyOrUndefined(n)&&(n=$("#workShopRecent").val(),isStrEmptyOrUndefined(n))){layer.msg("请选择车间");return}r={};r.opType=u;r.opData=JSON.stringify({workshopName:n});ajaxPost("/Relay/Post",r,function(n){var u;if(n.errno!=0){layer.msg(n.errmsg);return}isStrEmptyOrUndefined(t)?$(".workShopDevice").empty():t.empty();for(var e=n.datas,o=e.length,s='<option value = "{0}">{1}<\/option>',f="",h=[],r=0;r<o;r++)u=e[r],f+=s.format(u.Id,u.Code),h.push(u.Id);if(o&&!i&&$("#workShopDeviceRecent").prepend(s.format(h,"所有设备")),isStrEmptyOrUndefined(t)?$(".workShopDevice").append(f):t.append(f),_pageRead)_pageRead=!1,getSpotPlan();else switch(i){case 0:getThisCheckList();getNextExamineList();break;case 1:detailPage(null,null,!0);break;case 2:detailPage(null,null,!1)}})}function getSpotPlan(){var t=600,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var i;if(n.errno!=0){layer.msg(n.errmsg);return}$(".spotPlan").empty();for(var r=n.datas,u=r.length,f='<option value="{0}">{1}<\/option>',e="",o=[],t=0;t<u;t++)i=r[t],e+=f.format(i.Id,i.Plan),o.push(i.Id);u&&$("#spotPlanRecent").prepend(f.format(o,"所有计划"));$(".spotPlan").append(e);getThisCheckList();getNextExamineList()})}function getThisCheckList(){var u=613,n,t,i,r;if(!checkPermission(u)){layer.msg("没有权限");return}if($("#devicePlanDetail").empty(),n={},t=$("#workShopDeviceRecent").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}if(t!=0&&(n.ids=t),i=$("#spotPlanRecent").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择点检计划");return}i!=0&&(n.plans=i);r={};r.opType=u;r.opData=JSON.stringify(n);ajaxPost("/Relay/Post",r,function(n){var t,i;if(n.errno!=0){layer.msg(n.errmsg);return}var h=n.datas,c="",f=0,l=h.length;for(l||$("#devicePlanDetail").append('<div style="font:bold 25px/35px 微软雅黑;color:red">无数据<\/div>');f<l;f++){for(var a=h[f],e=a.Data,v=a.DeviceId,y=e[0].PlanId,r=0,p=e.length,u=null,o=null,s="";r<p;r++){if(t=e[r],u+=t.Done,o+=t.NotPass,r===3){s+="...";break}s+=t.Total==t.Done?`${t.Plan}：${t.Total}/<font style="color: green">${t.Done}</font>/<font style="color: red">${t.NotPass}</font><br>`:`${t.Plan}：${t.Total}/${t.Done}/<font style="color: red">${t.NotPass}</font><br>`}i="";u?(u>0&&o>0&&(i="#FF0000"),u>0&&o===0&&(i="#008000")):i="#FFCC33";c+='<div style="flex-basis: 150px; height: 110px; background:#dcdcdc; margin: 5px;text-align: center;cursor:pointer;box-shadow:2px 2px 3px black" onclick="detailPage({0},{3},{4})"><div style="width: 100%; height: 26%;position: relative"><label class="control-label" style="margin-top: 5px">{0}<\/label><div style="width: 30px; height: 100%; background: {1}; position: absolute; top: 0;right: 0"><\/div><\/div><div style="width: 100%; height: 74%">{2}<\/div><\/div>'.format(v,i,s,y,!0)}$("#devicePlanDetail").append(c)})}function detailPage(n,t,i){var u,r,s,h,f,e,o;if(_isListModal=i,u=null,r={},i){if(u=614,!checkPermission(u)){layer.msg("没有权限");return}if(isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(t))n=$("#workShopDeviceDetail").val(),t=$("#spotPlanDetail").val();else{if(s=$("#workShopRecent").val(),isStrEmptyOrUndefined(s)){layer.msg("请选择车间");return}$("#workShopDeviceDetail").val(n).trigger("change");$("#spotPlanDetail").val(t).trigger("change")}h=getCookieTokenInfo().account;r.account=h}else{if(u=618,!checkPermission(u)){layer.msg("没有权限");return}if(f=$("#startTime").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择开始时间");return}if(exceedTime(f)){layer.msg("开始时间不能大于当前时间");return}if(e=$("#endTime").val(),isStrEmptyOrUndefined(e)){layer.msg("请选择结束时间");return}if(exceedTime(e)){layer.msg("结束时间不能大于当前时间");return}if(compareDate(f,e)){layer.msg("开始时间不能大于结束时间");return}r.startTime=f;r.endTime=e;n=$("#workShopDeviceHistory").val();t=$("#spotPlanHistory").val()}if(isStrEmptyOrUndefined(n)){layer.msg("请选择设备");return}if(isStrEmptyOrUndefined(t)){layer.msg("请选择点检计划");return}r.deviceId=n;r.planId=t;o={};o.opType=u;o.opData=JSON.stringify(r);ajaxPost("/Relay/Post",o,function(n){var t;if(n.errno!=0){layer.msg(n.errmsg);return}i?($("#updateDetailModal").modal("show"),t=$("#devicePlanDetailList")):t=$("#checkLogList");var c=n.datas,r=function(n){return`<input type="checkbox" class="icb_minimal isEnable" id=${n.Id} surveyorId=${n.SurveyorId}>`},l=0,u=function(){return++l},f=function(n){return n.slice(0,n.indexOf(" "))},e=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"&&(t=""),`<span class="textOn">${t}</span><input type="text" class="form_date form-control text-center textIn actualTime hidden" style="width:120px;cursor: pointer">`},o=function(n){return`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn actual hidden" maxlength="10" oninput="value=value.replace(/[^\d]/g,'')" style="width:80px" value=${n}>`},s=function(n){return n===null&&(n=""),`<span class="textOn">${n}</span><textarea class="form-control textIn desc hidden" maxlength="500" style="resize: vertical;width:180px">${n}</textarea>`},h=function(n){var t='<span class="glyphicon glyphicon-{0}" aria-hidden="true" style="color:{1};font-size:25px;vertical-align:middle;margin-right:5px"><\/span><button type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="showImgModel({2},\'{3}\',\'{4}\')">查看<\/button>';return n.ImageList.length?t.format("ok","green",n.Id,escape(n.Item),escape(n.ImageList)):t.format("remove","red",n.Id,escape(n.Item),escape(n.ImageList))},a=i?[{data:null,title:"选择",render:r},{data:null,title:"序号",render:u},{data:"Item",title:"名称"},{data:"Max",title:"上限"},{data:"Min",title:"下限"},{data:"Unit",title:"单位"},{data:"Reference",title:"参考标准"},{data:"PlannedTime",title:"计划时间",render:f},{data:"CheckTime",title:"实际时间",render:e},{data:"Actual",title:"实际",render:o},{data:"Desc",title:"简述",render:s},{data:null,title:"图片",render:h}]:[{data:null,title:"选择",render:r},{data:null,title:"序号",render:u},{data:"Item",title:"名称"},{data:"Max",title:"上限"},{data:"Min",title:"下限"},{data:"Unit",title:"单位"},{data:"Reference",title:"参考标准"},{data:"PlannedTime",title:"计划时间",render:f},{data:"CheckTime",title:"实际时间",render:e},{data:"SurveyorName",title:"检验人"},{data:"Actual",title:"实际",render:o},{data:"Desc",title:"简述",render:s},{data:null,title:"图片",render:h}];t.DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:c,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:a,columnDefs:[{orderable:!1,targets:0}],createdRow:function(n,t){var r=t.CheckTime.slice(0,t.PlannedTime.indexOf(" ")),i=$(n).find(".form_date");i.attr("readonly",!0).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});i.val(r).datepicker("update")},drawCallback:function(){$(this).find(".icb_minimal").iCheck({labelHover:!1,cursor:!0,checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"});$(this).find(".isEnable").on("ifChanged",function(){var n=$(this).parents("tr");if($(this).is(":checked")){n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");var t=n.find(".textOn"),i=t.eq(0).text(),r=t.eq(1).text(),u=t.eq(2).text();n.find(".actualTime").val(i).datepicker("update");n.find(".actual").val(r);n.find(".desc").val(u)}else n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden")})}})})}function updateDeviceCheck(n){var t,o=[],u,f,h,i,e,s,c,l;if(n){if(t=616,!checkPermission(t)){layer.msg("没有权限");return}u=$("#devicePlanDetailList tbody").find("tr")}else{if(t=619,!checkPermission(t)){layer.msg("没有权限");return}u=$("#checkLogList tbody").find("tr")}for(f=0,h=u.length;f<h;f++)if(i=u.eq(f),e=i.find(".isEnable"),e.is(":checked")){var a=e.attr("id"),v=e.attr("surveyorId"),r=i.find(".actualTime").val();if(isStrEmptyOrUndefined(r)){layer.msg("实际时间不能为空");return}if(exceedTime(r)){layer.msg("实际时间不能大于当前时间");return}if(r=`${r} 00:00:00`,s=i.find(".actual").val().trim(),isStrEmptyOrUndefined(s)){layer.msg("实际不能为空");return}c=i.find(".desc").val().trim();o.push({CheckTime:r,Actual:parseInt(s),Desc:c,SurveyorId:v,Id:a})}if(!o.length){layer.msg("请选择需要修改的数据");return}l=function(){var i={};i.opType=t;i.opData=JSON.stringify(o);ajaxPost("/Relay/Post",i,function(t){layer.msg(t.errmsg);t.errno==0&&(n?detailPage(null,null,!0):detailPage(null,null,!1))})};showConfirm("修改",l)}function showImgModel(n,t,i){if(_updateFirmwareUpload==null&&(_updateFirmwareUpload=initFileInputMultiple("addImg",fileEnum.SpotCheck)),$("#addImg").fileinput("clear"),$("#checkId").text(n),t=unescape(t),$("#checkName").text(t),i=unescape(i),$("#imgOld").empty(),$("#imgOldList").empty(),_imgNameData=[],isStrEmptyOrUndefined(i))$("#imgOld").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgOld").append("图片：");i=i.split(",");_imgNameData=i;var r={type:fileEnum.SpotCheck,files:JSON.stringify(i)};ajaxPost("/Upload/Path",r,function(n){var u,r,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(u='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><div class="caption text-center"><button type="button" class="btn btn-default glyphicon glyphicon-trash delImg" value="{1}"><\/button><\/div><\/div><\/div>',r="",t=0;t<n.data.length;t++)r+=u.format(n.data[t].path,i[t]);$("#imgOldList").append(r)})}$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择张图片...");$("#showImgModel").modal("show")}function updateImg(){var n=_isListModal?617:620,t;if(!checkPermission(n)){layer.msg("没有权限");return}fileCallBack[fileEnum.SpotCheck]=function(t){var u,f,i,e,r;if(t.errno==0){u=[];for(f in t.data)u.push(t.data[f].newName);i=_imgNameData.concat(u);i=JSON.stringify(i);e=$("#checkId").text();r={};r.opType=n;r.opData=JSON.stringify({Images:i,Id:e});ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);$("#showImgModel").modal("hide");n.errno==0&&(_isListModal?detailPage(null,null,!0):detailPage(null,null,!1))})}};t=function(){$("#addImg").fileinput("upload")};showConfirm("操作",t)}function getNextExamineList(){var u=615,n,t,i,f,r;if(!checkPermission(u)){layer.msg("没有权限");return}if(n={},t=$("#workShopDeviceRecent").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}if(t!=0&&(n.ids=t),i=$("#spotPlanRecent").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择点检计划");return}i!=0&&(n.plans=i);f=getCookieTokenInfo().account;n.account=f;r={};r.opType=u;r.opData=JSON.stringify(n);ajaxPost("/Relay/Post",r,function(n){var t,r,o;if(n.errno!=0){layer.msg(n.errmsg);return}t=n.datas;t.sort(function(n,t){return n.Plan>t.Plan?1:-1});for(var i={},f=0,h=t.length;f<h;f++)r=t[f].Plan,o=i[r],o?i[r]+=1:i[r]=1;var c=0,l=function(){return++c},a=function(n){return n.slice(0,n.indexOf(" "))},s=null,u=0,e=["#cdcdcd","#daf5fa"];$("#planCheckRecentList").DataTable({destroy:!0,paging:!0,searching:!0,sort:!1,language:{url:"/content/datatables_language.json"},data:t,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Plan",title:"计划"},{data:null,title:"序号",render:l},{data:"Item",title:"点检项"},{data:"Max",title:"上限"},{data:"Min",title:"下限"},{data:"Unit",title:"单位"},{data:"Reference",title:"参考标准"},{data:"PlannedTime",title:"计划时间",render:a},{data:"Devices",title:"机台号"}],createdRow:function(n,t,r){var o=t.Plan,f=$(n).find("td").eq(0);r?o==s?f.remove():(u++,f.attr("rowspan",i[o]),f.css("background",e[u%e.length])):(u=0,f.attr("rowspan",i[o]),f.css("background",e[u]));s=o},columnDefs:[{targets:7,sClass:"text-primary"},{targets:8,render:function(n,t,i){return i.Devices=i.Devices?i.Devices:"",i.Devices.length>tdShowContentLength?i.Devices.substr(0,tdShowContentLength)+"<a href = \"javascript:showDeviceModel('{0}')\">...<\/a> ".format(escape(i.Devices.trim())):i.Devices}}]})})}function showDeviceModel(n=""){n=unescape(n);$("#DeviceList").val(n);$("#showDeviceModel").modal("show")}var _selectTime=!1,_pageRead=!0,_isListModal=null,_updateFirmwareUpload=null,_imgNameData=null;