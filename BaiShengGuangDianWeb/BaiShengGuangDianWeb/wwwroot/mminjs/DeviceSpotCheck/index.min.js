function pageReady(){_permissionList[272]={uIds:["updateDeviceCheckBtn"]};_permissionList[273]={uIds:["updateImgBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();getWorkShop();$("#workShop").on("select2:select",function(){var n=$(this).val();getWorkShopDevice(n,$("#workShopDevice"),0);$("#workShopDetail").val(n).trigger("change");getWorkShopDevice(n,$("#workShopDeviceDetail"),!0)});$("#workShopDevice, #spotPlan").on("select2:select",function(){getThisCheckList()});$("#workShopDetail").on("select2:select",function(){var n=$(this).val();getWorkShopDevice(n,$("#workShopDeviceDetail"),1)});$("#workShopDeviceDetail, #spotPlanDetail").on("select2:select",function(){detailPage()});$("#imgOldList").on("click",".delImg",function(){$(this).parents(".imgOption").remove();var n=$(this).val();_imgNameData.splice(_imgNameData.indexOf(n),1)})}function getWorkShop(){var n={};n.opType=162;ajaxPost("/Relay/Post",n,function(n){var u;if(n.errno!=0){layer.msg(n.errmsg);return}$(".workShop").empty();for(var i=n.datas,f=i.length,r="",t=0;t<f;t++)u=i[t],r+='<option value = "{0}">{0}<\/option>'.format(u.SiteName);$(".workShop").append(r);getWorkShopDevice()})}function getWorkShopDevice(n,t,i){if(isStrEmptyOrUndefined(n)&&(n=$("#workShop").val(),isStrEmptyOrUndefined(n))){layer.msg("请选择车间");return}var r={};r.opType=163;r.opData=JSON.stringify({workshopName:n});ajaxPost("/Relay/Post",r,function(n){var u;if(n.errno!=0){layer.msg(n.errmsg);return}isStrEmptyOrUndefined(t)?$(".workShopDevice").empty():t.empty();for(var e=n.datas,o=e.length,s='<option value = "{0}">{1}<\/option>',f="",h=[],r=0;r<o;r++)u=e[r],f+=s.format(u.Id,u.Code),h.push(u.Id);if(o&&!i&&$("#workShopDevice").prepend(s.format(h,"所有设备")),isStrEmptyOrUndefined(t)?$(".workShopDevice").append(f):t.append(f),_pageRead)_pageRead=!1,getSpotPlan();else switch(i){case 0:getThisCheckList();break;case 1:detailPage()}})}function getSpotPlan(){var n={};n.opType=600;ajaxPost("/Relay/Post",n,function(n){var i;if(n.errno!=0){layer.msg(n.errmsg);return}$(".spotPlan").empty();var r=n.datas,t,u=r.length,f='<option value="{0}">{1}<\/option>',e="";for(u&&$("#spotPlan").append(f.format(0,"所有计划")),t=0;t<u;t++)i=r[t],e+=f.format(i.Id,i.Plan);$(".spotPlan").append(e);getThisCheckList()})}function getThisCheckList(){var n,t,i,r;if($("#devicePlan").empty(),n={},t=$("#workShopDevice").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}if(t!=0&&(n.ids=t),i=$("#spotPlan").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择点检计划");return}i!=0&&(n.plans=i);r={};r.opType=613;r.opData=JSON.stringify(n);ajaxPost("/Relay/Post",r,function(n){var t,i;if(n.errno!=0){layer.msg(n.errmsg);return}var h=n.datas,c="",f=0,l=h.length;for(l||$("#devicePlan").append('<div style="font:bold 25px/35px 微软雅黑;color:red">无数据<\/div>');f<l;f++){for(var a=h[f],e=a.Data,v=a.DeviceId,y=e[0].PlanId,r=0,p=e.length,u=null,o=null,s="";r<p;r++){if(t=e[r],u+=t.Done,o+=t.NotPass,r===3){s+="...";break}s+=t.Total==t.Done?`${t.Plan}：${t.Total}/<font style="color: green">${t.Done}</font>/<font style="color: red">${t.NotPass}</font><br>`:`${t.Plan}：${t.Total}/${t.Done}/<font style="color: red">${t.NotPass}</font><br>`}i="";u?(u>0&&o>0&&(i="#FF0000"),u>0&&o===0&&(i="#008000")):i="#FFCC33";c+='<div style="flex-basis: 150px; height: 110px; background:#dcdcdc; margin: 5px;text-align: center;cursor:pointer;box-shadow:2px 2px 3px black" onclick="detailPage({0},{3})"><div style="width: 100%; height: 26%;position: relative"><label class="control-label" style="margin-top: 5px">{0}<\/label><div style="width: 30px; height: 100%; background: {1}; position: absolute; top: 0;right: 0"><\/div><\/div><div style="width: 100%; height: 74%">{2}<\/div><\/div>'.format(v,i,s,y)}$("#devicePlan").append(c)})}function detailPage(n,t){var i={},u,f,r;if(isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(t)){if(n=$("#workShopDeviceDetail").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择设备");return}if(t=$("#spotPlanDetail").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择点检计划");return}}else{if(u=$("#workShop").val(),isStrEmptyOrUndefined(u)){layer.msg("请选择车间");return}$("#workShopDeviceDetail").val(n).trigger("change");$("#spotPlanDetail").val(t).trigger("change")}i.deviceId=n;i.planId=t;f=getCookieTokenInfo().account;i.account=f;r={};r.opType=614;r.opData=JSON.stringify(i);ajaxPost("/Relay/Post",r,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}$("#updateDetailModal").modal("show");var t=n.datas,i=function(n){return`<input type="checkbox" class="icb_minimal isEnable" id=${n.Id} surveyorId=${n.SurveyorId}>`},r=0,u=function(){return++r},f=function(n){return n.slice(0,n.indexOf(" "))},e=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"&&(t=""),`<span class="textOn">${t}</span><input type="text" class="form_date form-control text-center textIn actualTime hidden" style="width:120px;cursor: pointer">`},o=function(n){return`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn actual hidden" oninput="onInput(this, 10, 0)" onblur="onInputEnd(this)" style="width:80px" value=${n}>`},s=function(n){return n===null&&(n=""),`<span class="textOn">${n}</span><textarea class="form-control textIn desc hidden" maxlength="500" style="resize: vertical;width:180px">${n}</textarea>`},h=function(n){var t='<span class="glyphicon glyphicon-{0}" aria-hidden="true" style="color:{1};font-size:25px;vertical-align:middle;margin-right:5px"><\/span><button type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="showImgModel({2},\'{3}\',\'{4}\')">查看<\/button>';return n.ImageList.length?t.format("ok","green",n.Id,escape(n.Item),escape(n.ImageList)):t.format("remove","red",n.Id,escape(n.Item),escape(n.ImageList))};$("#devicePlanDetailList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"选择",render:i,orderable:!1},{data:null,title:"序号",render:u},{data:"Item",title:"名称"},{data:"Max",title:"上限"},{data:"Min",title:"下限"},{data:"Unit",title:"单位"},{data:"Reference",title:"参考标准"},{data:"PlannedTime",title:"计划时间",render:f},{data:"CheckTime",title:"实际时间",render:e},{data:"Actual",title:"实际",render:o},{data:"Desc",title:"简述",render:s},{data:null,title:"图片",render:h}],createdRow:function(n,t){var r=t.CheckTime.slice(0,t.PlannedTime.indexOf(" ")),i=$(n).find(".form_date");i.attr("readonly",!0).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});i.val(r).datepicker("update")},drawCallback:function(){$(this).find(".icb_minimal").iCheck({labelHover:!1,cursor:!0,checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"});$(this).find(".isEnable").on("ifChanged",function(){var n=$(this).parents("tr");if($(this).is(":checked")){n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");var t=n.find(".textOn"),i=t.eq(0).text(),r=t.eq(1).text(),u=t.eq(2).text();n.find(".actualTime").val(i).datepicker("update");n.find(".actual").val(r);n.find(".desc").val(u)}else n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden")})}})})}function updateDeviceCheck(){for(var e=$("#devicePlanDetailList tbody").find("tr"),r=[],u=0,h=e.length,n,i,f,o,s;u<h;u++)if(n=e.eq(u),i=n.find(".isEnable"),i.is(":checked")){var c=i.attr("id"),l=i.attr("surveyorId"),t=n.find(".actualTime").val();if(isStrEmptyOrUndefined(t)){layer.msg("实际时间不能为空");return}if(exceedTime(t)){layer.msg("实际时间不能大于当前时间");return}if(t=`${t} 00:00:00`,f=n.find(".actual").val().trim(),isStrEmptyOrUndefined(f)){layer.msg("实际不能为空");return}o=n.find(".desc").val().trim();r.push({CheckTime:t,Actual:parseInt(f),Desc:o,SurveyorId:l,Id:c})}if(!r.length){layer.msg("请选择需要修改的数据");return}s=function(){var n={};n.opType=616;n.opData=JSON.stringify(r);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&detailPage()})};showConfirm("修改",s)}function showImgModel(n,t,i){var r,u;if(_updateFirmwareUpload==null&&(_updateFirmwareUpload=initFileInputMultiple("addImg",fileEnum.SpotCheck)),$("#addImg").fileinput("clear"),$("#checkId").text(n),t=unescape(t),$("#checkName").text(t),i=unescape(i),$("#imgOld").empty(),$("#imgOldList").empty(),_imgNameData=[],isStrEmptyOrUndefined(i))$("#imgOld").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgOld").append("图片：");i=i.split(",");_imgNameData=i;r={type:fileEnum.SpotCheck,files:JSON.stringify(i)};r.dir="";for(u in fileEnum)if(fileEnum[u]==r.type){r.dir=u;break}if(isStrEmptyOrUndefined(r.dir))return void layer.msg("文件类型不存在！");ajaxPost("/Upload/Path",r,function(n){var u,r,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(u='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><div class="caption text-center"><button type="button" class="btn btn-default glyphicon glyphicon-trash delImg" value="{1}"><\/button><\/div><\/div><\/div>',r="",t=0;t<n.data.length;t++)r+=u.format(n.data[t].path,i[t]);$("#imgOldList").append(r)})}$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","选择 张图片...");$("#showImgModel").modal("show")}function updateImg(){fileCallBack[fileEnum.SpotCheck]=function(n){var r,u,t,f,i;if(n.errno==0){r=[];for(u in n.data)r.push(n.data[u].newName);t=_imgNameData.concat(r);t=JSON.stringify(t);f=$("#checkId").text();i={};i.opType=617;i.opData=JSON.stringify({Images:t,Id:f});ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);$("#showImgModel").modal("hide");n.errno==0&&detailPage(null,null,!0)})}};var n=function(){$("#addImg").fileinput("upload")};showConfirm("操作",n)}var _permissionList=[],_pageRead=!0,_updateFirmwareUpload=null,_imgNameData=null;