function pageReady(){var t,n,i,r,u;permissionList[100]={uIds:[]};permissionList[400]={uIds:["getUsuallyFaultList"]};permissionList[402]={uIds:[]};permissionList[403]={uIds:["showAddUsuallyFaultModel"]};permissionList[404]={uIds:[]};permissionList[405]={uIds:[]};permissionList[406]={uIds:["getFaultTypeList"]};permissionList[408]={uIds:["updateFaultTypeModel"]};permissionList[410]={uIds:["showAddFaultTypeModel"]};permissionList[411]={uIds:[]};permissionList[412]={uIds:["repairListLi"]};permissionList[414]={uIds:[]};permissionList[415]={uIds:["rChange"]};permissionList[416]={uIds:[]};permissionList[417]={uIds:["faultDeviceLi"]};permissionList[420]={uIds:[]};permissionList[423]={uIds:[]};permissionList[424]={uIds:["delFaultDeviceLi"]};permissionList[425]={uIds:["delRepairLi"]};permissionList[430]={uIds:["showMaintainerModel"]};permissionList[431]={uIds:["updateMaintainerBtn"]};permissionList[432]={uIds:["showAddMaintainerModelBtn"]};permissionList[433]={uIds:["delMaintainerBtn"]};permissionList=checkPermissionUi(permissionList);t=$("#tabs li:not(.hidden)").first();t&&(t.addClass("active"),$(t.find("a").attr("href")).addClass("active"));$(".ms2").select2();$("#singleFaultType").select2();getFaultDeviceList();setTimeout(function(){getRepairRecordList(!0,0);getFaultType(0)},3e3);$(".icb_minimal").iCheck({checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"});$("#fStartDate").val(getDate()).datepicker("update");$("#fEndDate").val(getDate()).datepicker("update");$("#rStartDate").val(getDate()).datepicker("update");$("#rEndDate").val(getDate()).datepicker("update");$(".fHead input,.fHead span").css("verticalAlign","middle");$(".rHead input,.rHead span").css("verticalAlign","middle");$(".fHead label").on("ifChanged",function(){$(".fHead .icb_minimal").is(":checked")?($("#fBtn").addClass("hidden"),$("#fTime").removeClass("hidden"),$("#fStartDate").val(getDate()).datepicker("update"),$("#fStartTime").val(getTime()).timepicker("setTime",getTime()),$("#fEndDate").val(getDate()).datepicker("update"),$("#fEndTime").val(getTime()).timepicker("setTime",getTime())):($("#fBtn").removeClass("hidden"),$("#fTime").addClass("hidden"))});$(".rHead label").on("ifChanged",function(){$(".rHead .icb_minimal").is(":checked")?($("#rBtn").addClass("hidden"),$("#rTime").removeClass("hidden"),$("#rStartDate").val(getDate()).datepicker("update"),$("#rStartTime").val(getTime()).timepicker("setTime",getTime()),$("#rEndDate").val(getDate()).datepicker("update"),$("#rEndTime").val(getTime()).timepicker("setTime",getTime())):($("#rBtn").removeClass("hidden"),$("#rTime").addClass("hidden"))});$("#singleFaultType1").on("select2:select",function(){for(var t="",n=0;n<faultData.length;n++)if(faultData[n].Id==$("#singleFaultType1").val()){t=faultData[n].FaultDescription;break}$("#singleFaultDefaultDesc").val(t)});window.onload=function(){(function(n){var t;n[{timeUserFun:"timeUserFun"}.timeUserFun]=function(n){var u=n*60,i={init:0,time:function(){i.init+=1;i.init==u&&(getFaultDeviceList(0),i.init=0)},eventFun:function(){clearInterval(t);i.init=0;t=setInterval(i.time,1e3)}},r;t=setInterval(i.time,1e3);r=document.querySelector("html");r.addEventListener("click",i.eventFun);r.addEventListener("keydown",i.eventFun);r.addEventListener("mousemove",i.eventFun);r.addEventListener("mousewheel",i.eventFun)}})(window);timeUserFun(1)};n=null;i=0;$("#singleFaultModel").on("scroll",function(){n!=document.activeElement&&(n=document.activeElement,i=$(n).offset().top,$(".bootstrap-timepicker-widget").length>0&&(r=$(".bootstrap-timepicker-widget").offset().top),$(".datepicker").length>0&&(u=$(".datepicker").offset().top));var f=$(n).offset().top,t=f-i;$(".bootstrap-timepicker-widget").css("top",r+t+"px");$(".datepicker").css("top",u+t+"px")})}function getFaultType(n=1){var t={};t.opType=406;ajaxPost("/Relay/Post",t,function(n){var r,i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(faultData=n.datas,$("#singleFaultType").empty(),$("#singleFaultType1").empty(),r='<option value="{0}">{1}<\/option>',i=0;i<n.datas.length;i++)t=n.datas[i],i==0&&(fType=t.Id),$("#singleFaultType").append(r.format(t.Id,t.FaultTypeName)),$("#singleFaultType1").append(r.format(t.Id,t.FaultTypeName))},n)}function getFaultDeviceList(n=1){var i=417,t;permissionList[i].have&&(t={},t.opType=i,ajaxPost("/Relay/Post",t,function(n){var u,t,i;if(n.errno!=0){layer.msg(n.errmsg);return}var f=function(n){var t=n.Priority;return t==2?'<span class="text-red"><span class="hidden">2<\/span>高<\/span>':t==1?'<span class="text-warning"><span class="hidden">1<\/span>中<\/span>':'<span class="text-success"><span class="hidden">0<\/span>低<\/span>'},e='<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button >    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">        <span class="caret"><\/span>        <span class="sr-only">Toggle Dropdown<\/span>    <\/button>    <ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}    <\/ul><\/div>',o=function(n){var t='<button type="button" class="btn btn-danger" onclick="sChange({0}, 1)">确认故障<\/button>'.format(n.Id),i='<button type="button" class="btn btn-info" onclick="sChange({0}, 2)">开始维修<\/button>'.format(n.Id),r='<button type="button" class="btn btn-success" onclick="sChange({0}, 3)">维修完成<\/button>'.format(n.Id),u='<li><a onclick="sChange({0}, 0)">修改<\/a><\/li>'.format(n.Id),f="<li><a onclick=\"delChange({0}, '{1}')\">删除<\/a><\/li>".format(n.Id,escape(n.DeviceCode));return"{0}{1}{2}{3}".format(e.format(permissionList[420].have?u:"",permissionList[423].have?f:""),permissionList[420].have&&n.State==0?t:"",permissionList[420].have&&n.State==1?i:"",permissionList[420].have&&n.State==2?r:"")},s=function(n,t,i,r){return r.row+1},h=function(n){var t=n.State;return t==0?'<span class="text-red"><span class="hidden">0<\/span>未确认<\/span>':t==1?'<span class="text-warning"><span class="hidden">1<\/span>已确认<\/span>':'<span class="text-success"><span class="hidden">2<\/span>维修中<\/span>'},c=function(n){var t=n.FaultDescription,i=n.FaultTypeId;return`<span title = "${t}" onclick = "showFaultTypeDetailModel(${i}, '${escape(t.trim())}')">${t.length>tdShowLength?t.substring(0,tdShowLength):t}...</span>`},r=[{data:null,title:"序号",render:s},{data:"DeviceCode",title:"机台号"},{data:"FaultTime",title:"故障时间"},{data:null,title:"优先级",render:f},{data:null,title:"状态",render:h},{data:"Name",title:"维修工"},{data:"Phone",title:"联系方式"},{data:"Proposer",title:"报修人"},{data:"FaultTypeName",title:"故障类型"},{data:null,title:"故障描述",render:c}];for((permissionList[420].have||permissionList[423].have)&&r.push({data:null,title:"操作",render:o,orderable:!1}),$("#faultDeviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:r}),$("#singleFaultCode").empty(),u='<option value="{0}">{1}<\/option>',t=0;t<n.datas.length;t++)i=n.datas[t],$("#singleFaultCode").append(u.format(i.Id,i.DeviceCode))},n))}function sChange(n,t){var r,i;if(hideClassTip("adt"),$(".dd").attr("disabled","disabled"),$(".db").addClass("hidden"),$("#solveDiv").addClass("hidden"),$("#faultOtherDiv").addClass("hidden"),$("#singleFaultType").val(fType).trigger("change"),$("#rFaultCodeDiv").addClass("hidden"),$("#singleFaultCode").removeClass("hidden"),r=417,!permissionList[r].have){layer.msg("没有权限");return}i={};i.opType=r;i.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",i,function(i){var r,f,e,u,o;if(i.errno!=0){layer.msg(i.errmsg);return}if(i.datas.length>0){for(r=i.datas[0],$("#singleUpdateId").html(n),$("#singleUpdateState").html(r.State),$("#singleUpdateCodeId").html(r.DeviceId),$("#singleFaultCode").val(r.DeviceCode),$("#singleProposer").val(r.Proposer),$("#singleFaultType1").val(r.FaultTypeId).trigger("change"),f=r.FaultTime.split(" "),$("#singleFaultDate").val(f[0]),$("#singleFaultTime").val(f[1]),e="",u=0;u<faultData.length;u++)if(faultData[u].Id==$("#singleFaultType1").val()){e=faultData[u].FaultDescription;break}$("#singleFaultDefaultDesc").val(e);$("#singleFaultDesc").val(r.FaultDescription);$("#singleFaultPriority").val(r.Priority);t==0&&($("#singleFaultPriority").removeAttr("disabled"),$("#singleChange").removeClass("hidden"));t==1&&$("#singleSure").removeClass("hidden");t==2&&$("#singleRepairing").removeClass("hidden");t==3&&($("#solveDiv").removeClass("hidden"),$("#singleRepaired").removeClass("hidden"),$("#singleFaultType").val(r.FaultTypeId).trigger("change"))}t==3&&($("#singleSolveDate").val(getDate()),$("#singleSolveDate").datepicker("update"),$("#singleSolveTime").val(getTime()),o=getCookieTokenInfo(),$("#singleFaultSolver").val(o.name),$("#singleSolvePlan").val(""));$("#singleFaultModel").modal("show")})}function delChange(n,t){var i,r;if(t=unescape(t),i=423,!permissionList[i].have){layer.msg("没有权限");return}r=function(){var t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getFaultDeviceList()})};showConfirm("删除故障设备："+t,r)}function getDelFaultDeviceList(){var r=424,n,t,i;if(permissionList[r].have){if(n={},n.opType=r,$(".fHead .icb_minimal").is(":checked")){if(t=$("#fStartDate").val()+" "+$("#fStartTime").val(),i=$("#fEndDate").val()+" "+$("#fEndTime").val(),exceedTime(t)||exceedTime(i)){layer.msg("所选时间不能大于当前时间");return}if(compareDate(t,i)){layer.msg("结束时间不能小于开始时间");return}n.opData=JSON.stringify({StartTime:t,EndTime:i})}ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=0,i=function(){return++t},r=function(n){var t=n.FaultDescription,i=n.FaultTypeId;return`<span title = "${t}" onclick = "showFaultTypeDetailModel(${i}, '${escape(t.trim())}')">${t.length>tdShowLength?t.substring(0,tdShowLength):t}...</span>`};$("#delFaultDeviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',destroy:!0,paging:!0,searching:!0,autoWidth:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:i},{data:"Id",title:"Id",bVisible:!1},{data:"DeviceCode",title:"机台号"},{data:"FaultTime",title:"故障时间"},{data:"Name",title:"维修工"},{data:"Phone",title:"联系方式"},{data:"Proposer",title:"报修人"},{data:"FaultTypeName",title:"故障类型"},{data:null,title:"故障描述",render:r}]})})}}function singleChange(n){var u=parseInt($("#singleUpdateId").html()),c=parseInt($("#singleUpdateState").html()),o=parseInt($("#singleUpdateCodeId").html()),f=$("#singleFaultCode").val(),r;if(!isStrEmptyOrUndefined(f)&&(r=$("#singleProposer").val().trim(),!isStrEmptyOrUndefined(r))){var a=$("#singleFaultDate").val(),v=$("#singleFaultTime").val(),e="{0} {1}".format(a,v),s=$("#singleFaultDesc").val().trim(),h=$("#singleFaultPriority").val().trim(),i,t;if(n<3){if(i=420,!permissionList[i].have){layer.msg("没有权限");return}t={};t.opType=i;t.opData=JSON.stringify([{id:u,DeviceCode:f,DeviceId:o,FaultTime:e,Proposer:r,FaultDescription:s,Priority:h,State:n==0?c:n}]);$("#singleFaultModel").modal("hide");ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getFaultDeviceList()})}else{var y=$("#singleFaultSolver").val(),p=$("#singleSolvePlan").val(),w=$("#singleSolveDate").val(),b=$("#singleSolveTime").val(),l="{0} {1}".format(w,b),k=$("#singleFaultType").val(),d=$("#singleFaultType1").val();if(compareDate(e,l)){layer.msg("解决时间不能小于故障时间");return}if(i=420,!permissionList[i].have){layer.msg("没有权限");return}if(t={},t.opType=i,t.opData=JSON.stringify([{id:u,DeviceCode:f,DeviceId:o,FaultTime:e,Proposer:r,FaultDescription:s,Priority:h,State:c,FaultLogId:u,MarkedDelete:!0}]),$("#singleFaultModel").modal("hide"),ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getFaultDeviceList()}),i=415,!permissionList[i].have){layer.msg("没有权限");return}t={};t.opType=i;t.opData=JSON.stringify({DeviceCode:f,DeviceId:o,FaultTime:e,Proposer:r,FaultDescription:s,Priority:h,FaultSolver:y,SolveTime:l,SolvePlan:p,FaultTypeId:k,FaultTypeId1:d,FaultLogId:u});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getRepairRecordList()})}}}function getRepairRecordList(n=false,t=1){var i,r;n&&getRepairRecordListFlag||(getRepairRecordListFlag=!0,i=412,permissionList[i].have)&&(r={},r.opType=i,ajaxPost("/Relay/Post",r,function(n){var i,r;if(n.errno!=0){layer.msg(n.errmsg);return}var u=0,f=function(){return++u},e='<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button >    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">        <span class="caret"><\/span>        <span class="sr-only">Toggle Dropdown<\/span>    <\/button>    <ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}    <\/ul><\/div>',o=function(n){var t='<li><a onclick="rChange({0}, 0)">修改<\/a><\/li>'.format(n.Id),i="<li><a onclick=\"deleteChange({0}, '{1}')\">删除<\/a><\/li>".format(n.Id,escape(n.FaultTypeName));return e.format(permissionList[414].have?t:"",permissionList[416].have?i:"")},s=function(n){var t=n.FaultDescription,i=n.FaultTypeId;return`<span title = "${t}" onclick = "showFaultTypeDetailModel(${i}, '${escape(t.trim())}')">${t.length>tdShowLength?t.substring(0,tdShowLength):t}...</span>`},h=function(n){var t=n.SolvePlan;return`<span title = "${t}" onclick = "showAllContent('${escape(t)}', '解决方案')">${t.substring(0,tdShowLength)}...</span>`},c=function(n){return n==!1?"否":"是"},t=[{data:"Id",title:"序号",render:f},{data:"DeviceCode",title:"机台号"},{data:"FaultTime",title:"故障时间"},{data:"Name",title:"维修工"},{data:"Phone",title:"联系方式"},{data:"Proposer",title:"报修人"},{data:"FaultSolver",title:"解决人员"},{data:null,title:"故障描述",render:s},{data:"SolveTime",title:"解决时间"},{data:"FaultTypeName",title:"故障类型"},{data:null,title:"解决方案",render:h},{data:"IsAdd",title:"维修工添加",render:c}];(permissionList[414].have||permissionList[416].have)&&t.push({data:null,title:"操作",render:o,orderable:!1});i=[0,1,2,3,4,5,6,7,8,9];r=[5,8];$("#repairRecordList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rtip',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",exportOptions:{columns:i,format:{body:function(n,t,i,u){if(r.indexOf(i)>-1){var f=$(u).find("span").attr("title");if(f!=null)return"‌"+unescape(f)}return"‌"+u.textContent}}}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:t})},t))}function getDelRepairList(){var r=425,n,t,i;if(permissionList[r].have){if(n={},n.opType=r,$(".rHead .icb_minimal").is(":checked")){if(t=$("#rStartDate").val()+" "+$("#rStartTime").val(),i=$("#rEndDate").val()+" "+$("#rEndTime").val(),exceedTime(t)||exceedTime(i)){layer.msg("所选时间不能大于当前时间");return}if(compareDate(t,i)){layer.msg("结束时间不能小于开始时间");return}n.opData=JSON.stringify({StartTime:t,EndTime:i})}ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=0,i=function(){return++t},r=function(n){var t=n.FaultDescription,i=n.FaultTypeId;return`<span title = "${t}" onclick = "showFaultTypeDetailModel(${i}, '${escape(t.trim())}')">${t.length>tdShowLength?t.substring(0,tdShowLength)+"...":t}</span>`},u=function(n){var t=n.SolvePlan;return`<span title = "${t}" onclick = "showAllContent('${escape(t)}', '解决方案')">${t.length>tdShowLength?t.substring(0,tdShowLength)+"...":t}</span>`},f=function(n){return n==!1?"否":"是"},e=[{data:"Id",title:"序号",render:i},{data:"DeviceCode",title:"机台号"},{data:"FaultTime",title:"故障时间"},{data:"Name",title:"维修工"},{data:"Phone",title:"联系方式"},{data:"Proposer",title:"报修人"},{data:"FaultSolver",title:"解决人员"},{data:null,title:"故障描述",render:r},{data:"SolveTime",title:"解决时间"},{data:"FaultTypeName",title:"故障类型"},{data:null,title:"解决方案",render:u},{data:"IsAdd",title:"维修工添加",render:f}];$("#delRepairList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',destroy:!0,paging:!0,searching:!0,autoWidth:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:e})})}}function rChange(n,t){hideClassTip("adt");$(".db").addClass("hidden");$(".dd").attr("disabled","disabled");$("#rFaultCodeDiv").addClass("hidden");$("#faultOtherDiv").addClass("hidden");$("#singleFaultType").val(fType).trigger("change");var r,i;if(t==0){if(r=412,!permissionList[r].have){layer.msg("没有权限");return}i={};i.opType=r;i.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",i,function(t){var i,f,u,r;if(t.errno!=0){layer.msg(t.errmsg);return}if(t.datas.length>0){for(i=t.datas[0],$("#rFaultCodeDiv").addClass("hidden"),$("#faultOtherDiv").addClass("hidden"),$("#singleFaultCode").removeClass("hidden"),$("#singleUpdateId").html(n),$("#singleUpdateState").html(i.State),$("#singleFaultCode").val(i.DeviceCode),$("#singleProposer").val(i.Proposer),$("#singleFaultType1").val(i.FaultTypeId1).trigger("change"),r=i.FaultTime.split(" "),$("#singleFaultDate").val(r[0]),$("#singleFaultTime").val(r[1]),f="",u=0;u<faultData.length;u++)if(faultData[u].Id==$("#singleFaultType1").val()){f=faultData[u].FaultDescription;break}$("#singleFaultDefaultDesc").val(f);$("#singleFaultDesc").val(i.FaultDescription.trim());$("#singleFaultPriority").val(i.Priority);$("#singleFaultSolver").val(i.FaultSolver);r=i.SolveTime.split(" ");$("#singleSolveDate").val(r[0]).datepicker("update");$("#singleSolveTime").val(r[1]).timepicker("setTime",r[1]);$("#singleSolvePlan").val(i.SolvePlan.trim());$("#singleFaultType").val(i.FaultTypeId).trigger("change");$("#solveDiv").removeClass("hidden");$("#recordChange").removeClass("hidden")}$("#singleFaultModel").modal("show")})}else{if($("#singleUpdateId").html(0),r=100,!permissionList[r].have){layer.msg("没有权限");return}i={};i.opType=r;ajaxPost("/Relay/Post",i,function(t){var u,f,e,i,r;if(t.errno!=0){layer.msg(t.errmsg);return}for($("#faultOtherDiv").removeClass("hidden"),$("#singleSolveDate").val(getDate()).datepicker("update"),$("#singleSolveTime").val(getTime()).timepicker("setTime",getTime()),u=getCookieTokenInfo(),n==0&&$("#singleFaultSolver").val(u.name),$("#singleFaultCode").addClass("hidden"),$("#rFaultCodeDiv").removeClass("hidden"),$("#singleProposer").val(u.name),$("#singleFaultType1").val(fType).trigger("change"),$("#singleFaultDesc").val(""),$("#singleSolvePlan").val(""),$("#singleFaultPriority").val("0"),$("#faultOther").val(""),f="",i=0;i<faultData.length;i++)if(faultData[i].Id==$("#singleFaultType1").val()){f=faultData[i].FaultDescription;break}for($("#singleFaultDefaultDesc").val(f),$("#singleFaultDate").val(getDate()).datepicker("update"),$("#singleFaultTime").val(getTime()).timepicker("setTime",getTime()),$(".dd").removeAttr("disabled"),$("#solveDiv").removeClass("hidden"),$("#rFaultCode").empty(),$("#rFaultCode").select2({allowClear:!0,placeholder:"请选择"}),e='<option value="{0}" id="{2}">{1}<\/option>',$("#rFaultCode").append("<option><\/option>"),i=0;i<t.datas.length;i++)r=t.datas[i],$("#rFaultCode").append(e.format(r.Code,r.Code,r.Id));$("#recordAdd").removeClass("hidden");$("#singleFaultModel").modal("show")})}}function deleteChange(n,t){var i,r;if(t=unescape(t),i=416,!permissionList[i].have){layer.msg("没有权限");return}r=function(){var t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getRepairRecordList()})};showConfirm("删除维修记录："+t,r)}function recordChange(n){var h=parseInt($("#singleUpdateId").html()),i,t=$("#rFaultCode").val(),r=$("#faultOther").val().trim(),u,e,a,v,o,f,s;if(n!=0){if(isStrEmptyOrUndefined(t)&&isStrEmptyOrUndefined(r)){layer.msg("请选择或输入一台机台号");return}if(!isStrEmptyOrUndefined(t)&&!isStrEmptyOrUndefined(r)){layer.msg("只能选择或输入一台机台号");return}isStrEmptyOrUndefined(t)&&!isStrEmptyOrUndefined(r)&&(i=r);!isStrEmptyOrUndefined(t)&&isStrEmptyOrUndefined(r)&&(i=t)}else i=$("#singleFaultCode").val();if(u=$("#rFaultCode").find("[value='"+i+"']").attr("id"),u=isStrEmptyOrUndefined(u)||isStrEmptyOrUndefined(t)?0:parseInt(u),e=$("#singleProposer").val().trim(),isStrEmptyOrUndefined(e)){n!=0&&showTip($("#singleProposerTip"),"报修人不能为空");return}var y=$("#singleFaultDate").val(),p=$("#singleFaultTime").val(),c="{0} {1}".format(y,p);if(exceedTime(c)){layer.msg("故障时间不能大于当前时间");return}var w=$("#singleFaultDesc").val().trim(),b=$("#singleFaultPriority").val(),k=$("#singleFaultSolver").val(),d=$("#singleSolvePlan").val().trim(),g=$("#singleSolveDate").val(),nt=$("#singleSolveTime").val(),l="{0} {1}".format(g,nt);if(exceedTime(l)){layer.msg("解决时间不能大于当前时间");return}if(a=$("#singleFaultType1").val(),v=$("#singleFaultType").val(),$("#singleFaultModel").modal("hide"),o=n==0?414:415,!permissionList[o].have){layer.msg("没有权限");return}f={};f.opType=o;s={DeviceCode:i,FaultTime:c,Proposer:e,FaultDescription:w,Priority:b,FaultSolver:k,SolveTime:l,SolvePlan:d,FaultTypeId:v,FaultTypeId1:a,FaultLogId:h,DeviceId:u,IsAdd:!0};n==0&&(s.id=h);f.opData=JSON.stringify(s);ajaxPost("/Relay/Post",f,function(n){layer.msg(n.errmsg);n.errno==0&&getRepairRecordList()})}function getUsuallyFaultList(){var t=400,n;if(!permissionList[t].have){layer.msg("没有权限");return}$("#usuallyFaultList").empty();n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var i='<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button ><button type = "button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">   <span class="caret"><\/span>   <span class="sr-only">Toggle Dropdown<\/span><\/button><ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}<\/ul><\/div>',r=function(n){var t='<li><a onclick="showUpdateUsuallyFaultModel({0})">修改<\/a><\/li>'.format(n.Id),r="<li><a onclick=\"deleteUsuallyFault({0}, '{1}')\">删除<\/a><\/li>".format(n.Id,escape(n.UsuallyFaultDesc));return i.format(permissionList[402].have?t:"",permissionList[405].have?r:"")},u=function(n){var t=n.SolvePlan;return`<span title = "${t}" onclick = "showAllContent('${escape(t)}', '解决方案')">${t.length>tdShowLength?t.substring(0,tdShowLength)+"...":t}</span>`},t=[{data:"Id",title:"序号"},{data:"UsuallyFaultDesc",title:"常见故障"},{data:null,title:"解决方案",render:u}];(permissionList[402].have||permissionList[405].have)&&t.push({data:null,title:"操作",render:r,orderable:!1});$("#usuallyFaultList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[10,20,30],iDisplayLength:10,columns:t,bAutoWidth:!0});$("#usuallyFaultModel").modal("show")})}function deleteUsuallyFault(n,t){var i,r;if(t=unescape(t),i=405,!permissionList[i].have){layer.msg("没有权限");return}r=function(){var t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getUsuallyFaultList()})};showConfirm("删除常见故障："+t,r)}function showAddUsuallyFaultModel(){hideClassTip("adt");$("#addUsuallyFaultDesc").val("");$("#addSolvePlan").val("");$("#addUsuallyFaultModel").modal("show")}function addUsuallyFault(){var r=403,n,t,i,u;if(!permissionList[r].have){layer.msg("没有权限");return}(n=!0,t=$("#addUsuallyFaultDesc").val().trim(),isStrEmptyOrUndefined(t)&&(showTip("addUsuallyFaultDescTip","故障描述不能为空"),n=!1),i=$("#addSolvePlan").val().trim(),isStrEmptyOrUndefined(i)&&(showTip("addSolvePlanTip","解决方案不能为空"),n=!1),n)&&(u=function(){$("#addUsuallyFaultModel").modal("hide");var n={};n.opType=r;n.opData=JSON.stringify({UsuallyFaultDesc:t,SolvePlan:i});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getUsuallyFaultList()})},showConfirm("添加",u))}function showUpdateUsuallyFaultModel(n){var i=400,t;if(!permissionList[i].have){layer.msg("没有权限");return}$("#updateId").html(n);t={};t.opType=i;t.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&($("#updateUsuallyFaultDesc").val(n.datas[0].UsuallyFaultDesc),$("#updateSolvePlan").val(n.datas[0].SolvePlan));hideClassTip("adt");$("#updateUsuallyFaultModel").modal("show")})}function updateUsuallyFault(){var r=402,n,t,i,u,f;if(!permissionList[r].have){layer.msg("没有权限");return}(n=!0,t=$("#updateUsuallyFaultDesc").val().trim(),isStrEmptyOrUndefined(t)&&(showTip($("#updateUsuallyFaultDescTip"),"故障描述不能为空"),n=!1),i=$("#updateSolvePlan").val().trim(),isStrEmptyOrUndefined(i)&&(showTip($("#updateSolvePlanTip"),"解决方案不能为空"),n=!1),n)&&(u=parseInt($("#updateId").html()),f=function(){$("#updateUsuallyFaultModel").modal("hide");var n={};n.opType=r;n.opData=JSON.stringify({id:u,UsuallyFaultDesc:t,SolvePlan:i});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getUsuallyFaultList()})},showConfirm("修改",f))}function getFaultTypeList(n=null){var i=406,t;if(!permissionList[i].have){layer.msg("没有权限");return}$("#faultTypeList").empty();t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var u,r,i;if(n!=null&&n("success"),t.errno!=0){layer.msg(t.errmsg);return}faultData=t.datas;var e='<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button ><button type = "button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">   <span class="caret"><\/span>   <span class="sr-only">Toggle Dropdown<\/span><\/button><ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}<\/ul><\/div>',o=0,s=function(){return++o},h=function(n){var t=n.FaultDescription;return`<span title = "${t}" onclick = "showAllContent('${escape(t)}', '故障类型描述')">${t.length>tdShowLength?t.substring(0,tdShowLength)+"...":t}</span>`},c=function(n){var t='<li><a onclick="showUpdateFaultTypeModel({0})">修改<\/a><\/li>'.format(n.Id),i="<li><a onclick=\"deleteFaultType({0}, '{1}')\">删除<\/a><\/li>".format(n.Id,escape(n.FaultTypeName));return e.format(permissionList[408].have?t:"",permissionList[411].have?i:"")},f=[{data:null,title:"序号",render:s},{data:"Id",title:"Id",bVisible:!1},{data:"FaultTypeName",title:"故障类型"},{data:null,title:"故障类型描述",render:h}];for((permissionList[408].have||permissionList[411].have)&&f.push({data:null,title:"操作",render:c,orderable:!1}),$("#faultTypeList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,aaSorting:[[0,"asc"]],aLengthMenu:[10,20,30],iDisplayLength:10,columns:f}),$("#singleFaultType").empty(),$("#singleFaultType1").empty(),u='<option value="{0}">{1}<\/option>',r=0;r<t.datas.length;r++)i=t.datas[r],r==0&&(fType=i.Id),$("#singleFaultType").append(u.format(i.Id,i.FaultTypeName)),$("#singleFaultType1").append(u.format(i.Id,i.FaultTypeName));$("#faultTypeModel").modal("show")})}function showFaultTypeDetailModel(n,t=""){var r=406,i;if(!permissionList[r].have){layer.msg("没有权限");return}t=unescape(t);$("#faultTypeDetail1Div").addClass("hidden");isStrEmptyOrUndefined(t)||($("#faultTypeDetail1Div").removeClass("hidden"),$("#faultTypeDetail1").html(t));i={};i.opType=r;i.opData=JSON.stringify({qId:n,menu:!0});ajaxPost("/Relay/Post",i,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&$("#faultTypeDetail").html(n.datas[0].FaultDescription);$("#faultTypeDetailModel").modal("show")})}function deleteFaultType(n,t){var i,r;if(t=unescape(t),i=411,!permissionList[411].have){layer.msg("没有权限");return}r=function(){var t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getFaultTypeList()})};showConfirm("删除故障类型："+t,r)}function showAddFaultTypeModel(){hideClassTip("adt");$("#addFaultTypeName").val("");$("#addFaultTypeDesc").val("");$("#addFaultTypeModel").modal("show")}function addFaultType(){var i=410,n,t,r,u;if(!permissionList[i].have){layer.msg("没有权限");return}(n=!0,t=$("#addFaultTypeName").val().trim(),isStrEmptyOrUndefined(t)&&(showTip("addFaultTypeNameTip","故障类型不能为空"),n=!1),r=$("#addFaultTypeDesc").val(),n)&&(u=function(){$("#addFaultTypeModel").modal("hide");var n={};n.opType=i;n.opData=JSON.stringify([{FaultTypeName:t,FaultDescription:r}]);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getFaultTypeList()})},showConfirm("添加",u))}function showUpdateFaultTypeModel(n){var i=406,t;if(!permissionList[i].have){layer.msg("没有权限");return}$("#updateTypeId").html(n);t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&($("#updateFaultTypeName").val(n.datas[0].FaultTypeName),$("#updateFaultTypeDesc").val(n.datas[0].FaultDescription));hideClassTip("adt");$("#updateFaultTypeModel").modal("show")})}function updateFaultType(){var i=408,n,t,r,u,f;if(!permissionList[i].have){layer.msg("没有权限");return}(n=!0,t=$("#updateFaultTypeName").val().trim(),isStrEmptyOrUndefined(t)&&(showTip("updateFaultTypeNameTip","故障类型不能为空"),n=!1),r=$("#updateFaultTypeDesc").val(),n)&&(u=parseInt($("#updateTypeId").html()),f=function(){$("#updateFaultTypeModel").modal("hide");var n={};n.opType=i;n.opData=JSON.stringify({id:u,FaultTypeName:t,FaultDescription:r});ajaxPost("/Relay/Post",n,function(n){if(layer.msg(n.errmsg),n.errno==0){var t=new Promise(function(n){getFaultTypeList(n)});Promise.all([t]).then(()=>{getFaultDeviceList(0),getRepairRecordList(!1,0)})}})},showConfirm("修改",f))}function showMaintainerModel(n=1,t=true){var r=430,i;if(!permissionList[r].have){layer.msg("没有权限");return}maintainers=[];choseMaintainer=[];$("#maintainerList").empty();i={};i.opType=r;i.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",i,function(n){var i,r,f,e;if(n.errno!=0){layer.msg(n.errmsg);return}for(i=0;i<n.datas.length;i++)r=n.datas[i],maintainers[r.Id]=r;var o=function(n,t,i,r){var u=r.row+1;return`<input type="checkbox" class="icb_minimal chose" value="${u}" id="${n}">`},s=function(n,t,i,r){return r.row+1},h=function(n,t,i,r){var u=r.row+1;return`<span class="chose1" id="userPhone1${u}">${n}</span >
                        <input class="chose2 hidden form-control text-center" old="${n}" id="userPhone2${u}" onkeyup="onInput(this, 11, 0)" onblur="onInputEnd(this)" maxlength="11" onchange="changeMaintainer(this, 'Phone')">`},c=function(n,t,i,r){var u=r.row+1;return`<span class="chose1" title="${n}" id ="userRemark1${u}" onclick = "showAllContent('${escape(n)}')">${n.length>tdShowLength?n.substring(0,tdShowLength)+"...":n}</span>
                        <input class="chose2 hidden form-control" style="width: 100%;" old="${n}" id ="userRemark2${u}" onchange="changeMaintainer(this, 'Remark')">`},u=[{data:"Id",title:"序号",render:s,sWidth:"80px"},{data:"Name",title:"姓名",sWidth:"120px"},{data:"Phone",title:"手机号",render:h,sWidth:"130px"},{data:"Remark",title:"备注",render:c}];(permissionList[431].have||permissionList[433].have)&&u.unshift({data:"Id",title:"选择",render:o,sWidth:"80px",orderable:!1});f=[0,1,2,3,4];e=[4];$("#maintainerList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rtip',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",exportOptions:{columns:f,format:{body:function(n,t,i,r){if(e.indexOf(i)>-1){var u=$(r).find("span").attr("title");if(u!=null)return"‌"+unescape(u)}return"‌"+r.textContent}}}}],bAutoWidth:!1,destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:u,createdRow:function(){},drawCallback:function(){$(this).find(".icb_minimal").iCheck({labelHover:!1,cursor:!0,checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"});$(this).find(".chose").on("ifChanged",function(){var t=$(this).parents("tr:first"),n=$(this).attr("value"),i=$(this).attr("id");$(this).is(":checked")?(t.find(".chose1").addClass("hidden"),t.find(".chose2").removeClass("hidden"),$("#userPhone2"+n).val($("#userPhone2"+n).attr("old")),$("#userRemark2"+n).val($("#userRemark2"+n).attr("old")),choseMaintainer[i]={Id:i,Phone:$("#userPhone2"+n).val(),Remark:$("#userRemark2"+n).val()}):(t.find(".chose1").removeClass("hidden"),t.find(".chose2").addClass("hidden"),choseMaintainer=removeArrayObj(choseMaintainer,i))})}});t&&$("#maintainerModel").modal("show")},n)}function changeMaintainer(n,t){var u=$(n).parents("tr:first"),r=$(u).find(".chose").attr("value"),i=$(u).find(".chose").attr("id");$("#"+i).is(":checked")&&(choseMaintainer[i]?choseMaintainer[i][t]=$(`#user${t}2${r}`).val():choseMaintainer[i]={Id:i,Phone:$("#userPhone2"+r).val(),Remark:$("#userRemark2"+r).val()})}function initList(){$("#addList").empty();addMax=addMaxV=0}function showAddMaintainerModel(n=1){initList();$("#addOneBtn").attr("disabled","disabled");$("#addMaintainerBtn").attr("disabled","disabled");ajaxGet("/AccountManagement/List",null,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}$("#addOneBtn").removeAttr("disabled");$("#addMaintainerBtn").removeAttr("disabled");users=n.datas;$("#addMaintainerModel").modal("show")},n)}function addOne(){var f,t,n,u,i,r;if(addMax++,addMaxV++,f=`<tr id="add{0}" value="{0}" xh="{1}">
            <td style="vertical-align: addherit;" id="addXh{0}">{1}</td>
            <td><select class="ms2 form-control" id="addUser{0}"></select></td>
            <td><input class="form-control" type="tel" id="addPhone{0}" onkeyup="onInput(this, 11, 0)" onblur="onInputEnd(this)" maxlength="11"></td>
            <td><input class="form-control" id="addRk{0}" maxlength="100"></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="delOne({0})"><i class="fa fa-minus"></i></button></td>
        </tr>`.format(addMax,addMaxV),$("#addList").append(f),t=addMax,n="#addUser"+t,$(n).empty(),users&&users.length>0){for(u="",i=0;i<users.length;i++)r=users[i],u+=`<option value="${r.account}" title="${r.account}">${r.name}</option>`;$(n).append(u);$("#addPhone"+t).val(users[0].phone);$(n).on("select2:select",function(){var r=$(this).val(),i=$(this).parents("tr:first").attr("value"),n,t;for($("#addPhone"+i).val(""),n=0;n<users.length;n++)if(t=users[n],r==t.account){$("#addPhone"+i).val(t.phone);break}})}n="#add"+t;$(n).find(".ms2").css("width","100%");$(n).find(".ms2").select2({width:"120px"});$("#addTable").scrollTop($("#addTable")[0].scrollHeight)}function delOne(n){var i,r,t,u;for($("#addList").find(`tr[value=${n}]:first`).remove(),addMaxV--,i=1,r=$("#addList tr"),t=0;t<r.length;t++)$(r[t]).attr("xh",i),u=$(r[t]).attr("value"),$("#addXh"+u).html(i),i++}function addMaintainer(){for(var i,s,h=432,r=$("#addList tr"),u=[],n=0;n<r.length;n++){var t=$(r[n]).attr("value"),l=$(r[n]).attr("xh"),e=$("#addUser"+t).find("option:checked").text(),o=$("#addUser"+t).find("option:checked").val(),f=$("#addPhone"+t).val(),c=$("#addRk"+t).val();if(isStrEmptyOrUndefined(e)){layer.msg("请输入姓名");return}if(isStrEmptyOrUndefined(o))return;if(isStrEmptyOrUndefined(f)){layer.msg("请输入手机号");return}if(!isPhone(f)){layer.msg("手机号错误");return}u.push({Name:e,Account:o,Phone:f,Remark:c})}u.length<=0||(i=null,s=function(){$("#addMaintainerBtn").attr("disabled","disabled");var n={};n.opType=h;n.opData=JSON.stringify(u);ajaxPost("/Relay/Post",n,function(n){i&&clearTimeout(i);$("#addMaintainerBtn").removeAttr("disabled");layer.msg(n.errmsg);n.errno==0&&(showMaintainerModel(0,!1),$("#addMaintainerModel").modal("hide"))});i=setTimeout(function(){$("#addMaintainerBtn").removeAttr("disabled")},5e3)},showConfirm("添加",s))}function updateMaintainer(){var r=431,i,t,n,u;if(!permissionList[r].have){layer.msg("没有权限");return}if(choseMaintainer&&!(choseMaintainer.length<=0)){i=[];for(t in choseMaintainer)if(n=choseMaintainer[t],maintainers&&maintainers[t]&&(maintainers[t].Phone!=n.Phone||maintainers[t].Remark!=n.Remark)){if(isStrEmptyOrUndefined(n.Phone)){layer.msg("请输入手机号");return}if(!isPhone(n.Phone)){layer.msg("手机号错误");return}n.Account=maintainers[t].Account;n.Name=maintainers[t].Name;i.push(n)}i.length&&(u=function(){var t={},n;t.opType=r;t.opData=JSON.stringify(i);n=null;ajaxPost("/Relay/Post",t,function(t){layer.msg(t.errmsg);n&&clearTimeout(n);$("#updateMaintainerBtn").removeAttr("disabled");t.errno==0&&showMaintainerModel(0,!1)});n=setTimeout(function(){$("#delMaintainerBtn").removeAttr("disabled")},5e3)},showConfirm("保存",u))}}function delMaintainer(){var u=433,r,t,i,n,f;if(!permissionList[u].have){layer.msg("没有权限");return}if(choseMaintainer&&!(choseMaintainer.length<=0)){if(r=[],t=[],choseMaintainer&&choseMaintainer.length>0){for(n in choseMaintainer)maintainers&&maintainers[n]&&t.push(n);for(i=0;i<t.length;i++)n=t[i],maintainers&&maintainers[n]&&r.push(maintainers[n].Name)}f=function(){var n,i;$("#delMaintainerBtn").attr("disabled","disabled");n={};n.opType=u;n.opData=JSON.stringify({ids:t});i=null;ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);i&&clearTimeout(i);$("#delMaintainerBtn").removeAttr("disabled");n.errno==0&&showMaintainerModel(0,!1)});i=setTimeout(function(){$("#delMaintainerBtn").removeAttr("disabled")},5e3)};showConfirm("删除维修工："+r.join(","),f)}}var permissionList=[],getRepairRecordListFlag=!1,faultData=null,fType=0,maintainers=null,addMax=0,addMaxV=0,choseMaintainer=null,users=null;