function pageReady(){getRoleList();checkPermission(78)||$("#showAddRoles").addClass("hidden")}function getRoleList(){ajaxGet("/RoleManagement/List",null,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var i=function(n){var t="<li><a onclick=\"showUpdateRole({0}, '{1}', '{2}')\">修改<\/a><\/li>".format(n.id,escape(n.name),escape(n.permissions)),i="<li><a onclick=\"deleteRole({0}, '{1}')\">删除<\/a><\/li>".format(n.id,escape(n.name));return'<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button >    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">        <span class="caret"><\/span>        <span class="sr-only">Toggle Dropdown<\/span>    <\/button>    <ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}    <\/ul><\/div>'.format(checkPermission(80)?t:"",checkPermission(79)?i:"")},r=0,t=function(){return++r},u=checkPermission(80)||checkPermission(79)?[{data:null,title:"序号",render:t},{data:"id",title:"Id",bVisible:!1},{data:"name",title:"角色名称"},{data:null,title:"操作",render:i,orderable:!1}]:[{data:null,title:"序号",render:t},{data:"id",title:"Id",bVisible:!1},{data:"name",title:"角色名称"}];$("#rolesList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[10,20,30],iDisplayLength:10,columns:u})})}function showAddRoles(){$("#addRoleName").val("");$("#add_per_body").empty();ajaxGet("/Account/Permissions",null,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&showPermissions("add_per_body",n.datas);$("#addRoleModel").modal("show")})}function addRole(){var e=$("#addRoleName").val().trim(),t,i,n,r,u,f,o;if(isStrEmptyOrUndefined(e)){layer.msg("角色名不能为空");return}for(t=[],i=$("#add_per_body .on_cb"),n=0;n<i.length;n++)r=i[n],u=parseInt($(r).attr("value")),$(r).is(":checked")&&u>0&&t.push(u);if(f=t.join(","),isStrEmptyOrUndefined(f)){layer.msg("请选择权限");return}o=function(){$("#addRoleModel").modal("hide");var n={name:e,permissions:f};ajaxPost("/RoleManagement/Add",n,function(n){layer.msg(n.errmsg);n.errno==0&&getRoleList()})};showConfirm("添加",o)}function deleteRole(n,t){t=unescape(t);var i=function(){var t={id:n};ajaxPost("/RoleManagement/Delete",t,function(n){layer.msg(n.errmsg);n.errno==0&&getRoleList()})};showConfirm("删除角色："+t,i)}function showUpdateRole(n,t,i){t=unescape(t);i=unescape(i);var r=i.split(",");$("#update_protoDiv").click();$("#updateRoleName").val(t);$("#update_per_body").empty();$("#updateId").html(n);ajaxGet("/Account/Permissions",null,function(n){var i,e,u,f,t;if(n.errno!=0){layer.msg(n.errmsg);return}if(n.datas.length>0){for(showPermissions("update_per_body",n.datas),i=0;i<r.length;i++)e=r[i],$("#update_per_body .on_cb").filter("[value="+e+"]").iCheck("check");if(r.length>0){for(u=$("#update_per_body .4"),t=0;t<u.length;t++)$(u[t]).is(":checked")&&updateCheckBoxState("update_per_body",u[t],!1);for(f=$("#update_per_body .3"),t=0;t<f.length;t++)$(f[t]).is(":checked")&&updateCheckBoxState("update_per_body",f[t],!1)}}$("#updateRoleModal").modal("show")})}function updateRole(){var e=$("#updateRoleName").val(),t,i,n,r,u,f,o,s;if(isStrEmptyOrUndefined(e)){layer.msg("角色名不能为空");return}for(t=[],i=$("#update_per_body .on_cb"),n=0;n<i.length;n++)r=i[n],u=parseInt($(r).attr("value")),$(r).is(":checked")&&u>0&&t.push(u);if(f=t.join(","),isStrEmptyOrUndefined(f)){layer.msg("你还未选择权限");return}o=parseInt($("#updateId").html());s=function(){$("#updateRoleModal").modal("hide");var n={id:o,name:e,permissions:f};ajaxPost("/RoleManagement/Update",n,function(n){layer.msg(n.errmsg);n.errno==0&&getRoleList()})};showConfirm("修改",s)}function showPermissions(n,t){for(var r,p,c,u,e,w,s,b,f,o,k,l,h,a=`<div class="box box-solid noShadow" style="margin-bottom: 0;">
            <div class="box-header no-padding">
                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="on_i fa fa-minus"></i></button>
                <input type="checkbox" class="on_cb" style="width: 15px;"/>
                <h3 class="box-title" style="vertical-align: middle;font-size: 16px;"></h3>
            </div>
            <div class="box-body no-padding">
                <ul class="on_ul nav nav-pills nav-stacked mli" style="margin-left: 20px"></ul>
            </div>
        </div>`,g=`<div class="box box-solid noShadow" style="margin-bottom: 0;">
            <div class="box-header no-padding">
                <a type="button" class="btn btn-box-tool disabled" data-widget="collapse" style="opacity:0;"><i class="on_i fa fa-minus"></i></a>
                <input type="checkbox" class="on_cb" style="width: 15px;"/>
                <h3 class="box-title" style="vertical-align: middle;font-size: 16px;"></h3>
            </div>
            <div class="box-body no-padding">
                <ul class="on_ul nav nav-pills nav-stacked mli" style="margin-left: 20px"></ul>
            </div>
        </div>`,v=`<li>
            <div class="box box-solid noShadow" style="margin-bottom: 0;">
                <div class="box-header no-padding">
                    <a type="button" class="btn btn-box-tool disabled" data-widget="collapse"><i class="fa fa-chevron-right"></i></a>
                    <input type="checkbox" class="on_cb" style="width: 15px;" />
                    <h3 class="box-title" style="vertical-align: middle;font-size: 16px;"></h3>
                </div>
            </div>
         </li>`,d=PermissionTypes,i=null,y=0;y<d.length;y++)for(r=d[y],i=$(a).clone(),i.find("h3").text(r.name),i.find(".on_cb").attr("value",r.id),i.find(".on_cb").addClass("1"),i.find(".on_ul").attr("id",`${r.isPage?"t":"f"}ul`+r.id),$("#"+n).append(i),p=getMenus(t,r),c=0;c<p.length;c++)if(u=p[c],e=getMenuData(t,u),e.length>0)if(r.isPage&&u.noChild)w=e[0],i=$(v).clone(),i.find("h3").text(w.name),i.find(".on_cb").attr("value",w.id),i.find(".on_cb").attr("pid",r.id),i.find(".on_cb").addClass("1"),$("#"+n).find(`[id=${r.isPage?"t":"f"}ul${u.parent}]`).append(i);else if(i=$("<li>"+a+"<li>").clone(),i.find("h3").text(u.name),i.find(".on_cb").attr("value",u.id),i.find(".on_cb").attr("pid",u.parent),i.find(".on_cb").addClass("2"),i.find(".on_ul").attr("id",`${r.isPage?"t":"f"}ul`+u.id),i.find("div:first").addClass("collapsed-box"),i.find(".on_i").removeClass("fa-minus"),i.find(".on_i").addClass("fa-plus"),$("#"+n).find(`[id=${r.isPage?"t":"f"}ul${u.parent}]`).append(i),r.isPage)for(f=0;f<e.length;f++)s=e[f],i=$(v).clone(),i.find("h3").text(s.name),i.find(".on_cb").attr("value",s.id),i.find(".on_cb").attr("pid",s.parent),i.find(".on_cb").addClass("3"),$("#"+n).find(`[id=${r.isPage?"t":"f"}ul${s.parent}]`).append(i);else for(b=getLabels(e,u),f=0;f<b.length;f++)for(o=b[f],i=$("<li>"+a+"<li>").clone(),i.find("h3").text(o.name),i.find(".on_cb").attr("value",o.id),i.find(".on_cb").attr("pid",o.parent),i.find(".on_cb").addClass("3"),i.find(".on_ul").attr("id",`${r.isPage?"t":"f"}ul`+o.id),i.find("div:first").addClass("collapsed-box"),i.find(".on_i").removeClass("fa-minus"),i.find(".on_i").addClass("fa-plus"),$("#"+n).find(`[id=${r.isPage?"t":"f"}ul${o.parent}]`).append(i),k=getLabelData(e,o),l=0;l<k.length;l++)h=k[l],i=$(v).clone(),i.find("h3").text(h.name),i.find(".on_cb").attr("value",h.id),i.find(".on_cb").attr("pid",h.parent),i.find(".on_cb").addClass("4"),$("#"+n).find(`[id=${r.isPage?"t":"f"}ul${h.parent}]`).append(i);$(".on_cb").iCheck({checkboxClass:"icheckbox_minimal",increaseArea:"20%"});$(".on_cb").on("ifClicked",function(){var t=$(this).is(":checked");$(this).parents(".box-solid:first").find(".on_cb").iCheck(t?"uncheck":"check");updateCheckBoxState(n,this,t)})}function rule(n,t){return n.parent!=t.parent?n.parent>t.parent?1:-1:n.order!=t.order?n.order>t.order?1:-1:n.id>t.id?1:-1}function getMenus(n,t){for(var i,f,r,e,u,s=[],o=0;o<PermissionPageTypes.length;o++)for(i=PermissionPageTypes[o],f=0;f<n.length;f++)if(r=n[f],e=!1,t.isPage?r.isPage==t.isPage&&r.label==i.name&&(e=!0):r.isPage==t.isPage&&r.type==i.type&&(e=!0),e){u=clone(i);u.id=t.isPage?i.id:lid--;u.isPage=t.isPage;u.parent=t.id;s.push(u);break}return s}function getMenuData(n,t){for(var i,r,u,e=[],f=0;f<n.length;f++)i=n[f],r=!1,t.isPage?i.isPage==t.isPage&&i.label==t.name&&(r=!0):i.isPage==t.isPage&&i.type==t.type&&(r=!0),r&&(u=clone(i),u.isPage=t.isPage,u.parent=t.id,e.push(u));return e.sort(rule)}function getLabels(n,t){for(var i,r,u=[],f=0;f<n.length;f++)i=n[f],i.isPage!=t.isPage||i.type!=t.type||existArrayObj(u,"name",i.label)||(r=clone(i),r.id=lid--,r.name=i.label,r.parent=t.id,u.push(r));return u.sort(rule)}function getLabelData(n,t){for(var i,u,f=[],r=0;r<n.length;r++)i=n[r],i.isPage==t.isPage&&i.type==t.type&&i.label==t.name&&(u=clone(i),u.parent=t.id,f.push(u));return f.sort(rule)}function updateCheckBoxState(n,t,i){var r=$(t).attr("pid"),f,u;if(i){for($("#"+n).find(".on_cb").filter("[value="+r+"]").iCheck("uncheck"),f=$("#"+n).find(".on_cb").filter("[pid="+r+"]"),u=0;u<f.length;u++)if($(f[u]).is(":checked")){$("#"+n).find(".on_cb").filter("[value="+r+"]").iCheck("check");break}}else $("#"+n).find(".on_cb").filter("[value="+r+"]").iCheck("check");(r=$(t).attr("pid"),r!=null)&&(t=$("#"+n).find(".on_cb").filter("[value="+r+"]"),updateCheckBoxState(n,t,i))}var lid=-PermissionPageTypes.length;