function pageReady(){$(".ms2").select2();getOrganizationUnits();$("#rdo1").on("ifChanged",function(){$(this).is(":checked")?$("#cbDiv").addClass("hidden"):$("#cbDiv").removeClass("hidden")});checkPermission(66)||$("#showAddOrganizationUnitModal").addClass("hidden")}function getOrganizationUnits(){$("#organizationUnits").empty();ajaxGet("/OrganizationUnitManagement/List",null,function(n){var r,e,u;if(n.errno!=0){layer.msg(n.errmsg);return}var s='<div class="box box-solid noShadow"  style="margin-bottom: 0;">    <div class="box-header" style="padding: 2px;">        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="on_i fa fa-minus"><\/i><\/button>        <h3 class="box-title" style="vertical-align: middle;font-size: 16px;" onclick="onClick(\'{0}\',\'{1}\')"><\/h3>    <\/div>    <div class="box-body no-padding">        <ul class="on_ul nav nav-pills nav-stacked mli" style="margin-left: 20px"><\/ul>    <\/div><\/div>',h=n.datas,c=getOrganizationUnitsParent(h);for(r=0;r<c.length;r++)for(e=getOrganizationUnitsChild(h,c[r]),u=0;u<e.length;u++){var t=e[u],f,i,l="<li><a onclick=\"showUpdateOrganizationUnit({0}, '{1}')\">修改<\/a><\/li>".format(t.id,escape(t.name)),a="<li><a onclick=\"deleteOrganizationUnit({0}, '{1}')\">删除<\/a><\/li>".format(t.id,escape(t.name)),o="";(checkPermission(67)||checkPermission(68))&&(o='<div class="btn-group pull-right"><button type = "button" class="btn btn-default btn-sm" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button >    <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-expanded="false">        <span class="caret"><\/span>        <span class="sr-only">Toggle Dropdown<\/span>    <\/button>    <ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}    <\/ul><\/div>'.format(checkPermission(67)?l:"",checkPermission(68)?a:""));t.parentId==0?(f=s.format(t.id,escape(t.name)),i=$(f).clone(),i.find("h3").text(t.name).append("(<span>"+t.memberCount+"<\/span>)"),i.find("h3").after(o),i.find(".on_ul").attr("id","on"+t.id),$("#organizationUnits").append(i)):(f="<li>"+s.format(t.id,escape(t.name))+"<\/li>",i=$(f).clone(),i.find("h3").text(t.name).append("(<span>"+t.memberCount+"<\/span>)"),i.find("h3").after(o),i.find(".on_ul").attr("id","on"+t.id),$("#organizationUnits").find("[id=on"+t.parentId+"]").append(i))}})}function rule(n,t){return n.id>t.id}function getOrganizationUnitsParent(n){for(var r,t=[],i=0;i<n.length;i++)r=n[i],t.indexOf(r.parentId)<0&&t.push(r.parentId);return t.sort(function(n,t){return n>t?1:-1})}function getOrganizationUnitsChild(n,t){for(var r,u=[],i=0;i<n.length;i++)r=n[i],r.parentId==t&&u.push(r);return u.sort(rule)}function showAddOrganizationUnitModal(){$("#rdo2").iCheck("check");$("#cbDiv").removeClass("hidden");$("#addOrganizationUnit").empty();$("#addName").val("");ajaxGet("/OrganizationUnitManagement/List",null,function(n){var u,i,t,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(u='<option value="{0}">{1}<\/option>',i=OrganizationUnitSort(n.datas),t=0;t<i.length;t++)r=i[t],$("#addOrganizationUnit").append(u.format(r.id,r.name));$("#addOrganizationUnitModal").modal("show")})}function OrganizationUnitSort(n){for(var o,u,t,i,f=[],r,s=getOrganizationUnitsParent(n),e=0;e<s.length;e++)for(o=getOrganizationUnitsChild(n,s[e]),u=0;u<o.length;u++)if(t=o[u],i=t.parentId,i==0)f.push({id:t.id,name:t.name});else{for(r=t.name;i!=0;)$.each(n,function(n,t){if(t.id==i)return r=r.replace("",t.name+" - "),i=t.parentId,!1});f.push({id:t.id,name:r})}return f}function addOrganizationUnit(){var n={},t=$("#addName").val().trim(),i,r;if(isStrEmptyOrUndefined(t)){layer.msg("部门名称不能为空");return}$("#rdo1").is(":checked")?(n.parentId=0,n.name=t):(i=$("#addOrganizationUnit").val(),n.parentId=i,n.name=t);r=function(){$("#addOrganizationUnitModal").modal("hide");ajaxPost("/OrganizationUnitManagement/Add",n,function(n){layer.msg(n.errmsg);n.errno==0&&getOrganizationUnits()})};showConfirm("添加",r)}function showUpdateOrganizationUnit(n,t){t=unescape(t);$("#updateId").html(n);$("#organizationName").val(t);$("#updateOrganizationUnitModal").modal("show")}function updateOrganizationUnit(){var t=parseInt($("#updateId").html()),n=$("#organizationName").val().trim(),i;if(isStrEmptyOrUndefined(n)){layer.msg("部门名称不能为空");return}i=function(){$("#updateOrganizationUnitModal").modal("hide");var i={id:t,name:n};ajaxPost("/OrganizationUnitManagement/Update",i,function(i){layer.msg(i.errmsg);i.errno==0&&(getOrganizationUnits(),$("#showAddMemberModal").is(":hidden")||$("#unName").attr("value")!=t||$("#unName").text(n))})};showConfirm("修改",i)}function deleteOrganizationUnit(n,t){t=unescape(t);var i=function(){var t={id:n};ajaxPost("/OrganizationUnitManagement/Delete",t,function(t){layer.msg(t.errmsg);t.errno==0&&($("#on"+n).parents(".box-solid:first").remove(),$("#showAddMemberModal").is(":hidden")||$("#unName").attr("value")!=n||($("#memberDataTable").empty(),$("#memberDataTable").append('<table class="table table-hover table-striped" id="memberListTable"><\/table>'),$("#showAddMemberModal,#showBolModal").addClass("hidden"),$("#unName").text("成员列表"),$("#unName").removeAttr("value")))})};showConfirm("删除部门："+t,i)}function moveOrganizationUnits(){}function onClick(n,t){t=unescape(t);$("#memberListTable").empty();getMemberList(n,t)}function getMemberList(n,t){memberList=[];$("#unName").text(t);$("#unName").attr("value",n);$("#showAddMemberModal").removeClass("hidden");$("#showBolModal").removeClass("hidden");checkPermission(71)||$("#showAddMemberModal").addClass("hidden");ajaxGet("/OrganizationUnitManagement/MemberList",{organizationUnitId:n},function(n){var t;if(n.errno!=0){layer.msg(n.errmsg);return}for(t=0;t<n.datas.length;t++)memberList.push(n.datas[t].Id);var r=function(n){return'<button type="button" class="btn btn-primary btn-sm btn-danger" data-toggle="modal" onclick="deleteMember({0},\'{1}\')">删除<\/button>'.format(n.Id,escape(n.Name))},u=0,i=function(){return++u},f=checkPermission(72)?[{data:null,title:"序号",render:i},{data:"Id",title:"Id",bVisible:!1},{data:"Name",title:"姓名"},{data:"RoleName",title:"角色"},{data:null,title:"操作",render:r}]:[{data:null,title:"序号",render:i},{data:"Id",title:"Id",bVisible:!1},{data:"Name",title:"姓名"},{data:"RoleName",title:"角色"}],e=checkPermission(72)?[{orderable:!1,targets:4}]:"";$("#memberListTable").DataTable({destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:f,columnDefs:e,drawCallback:function(){$("#memberListTable td").css("padding","3px");$("#memberListTable td").css("vertical-align","middle")}})})}function showAddMemberModal(){$("#memberList").empty();addList=[];ajaxGet("/AccountManagement/List",null,function(n){var i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(i=[],t=0;t<n.datas.length;t++)memberList.indexOf(n.datas[t].id)!=-1||n.datas[t].isDeleted||i.push(n.datas[t]);var r=function(n){return'<input type="checkbox" value="{0}" class="icb_minimal" onclick="">'.format(n.id)},u=0,f=function(){return++u};$("#memberList").DataTable({destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aLengthMenu:[20,40,60],iDisplayLength:20,aaSorting:[[0,"asc"]],columns:[{data:null,title:"序号",render:f},{data:"id",title:"id",bVisible:!1},{data:"name",title:"姓名"},{data:"account",title:"账号"},{data:"roleName",title:"角色"},{data:null,title:"选择",sClass:"text-red",render:r}],columnDefs:[{orderable:!1,targets:5}],drawCallback:function(){$("#memberList td").css("padding","3px");$("#memberList td").css("vertical-align","middle");$("#memberList .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});$("#memberList .icb_minimal").on("ifChanged",function(){var n=$(this),t=n.attr("value");n.is(":checked")?(n.parents("tr:first").css("background-color","gray"),addList.push(t)):(n.parents("tr:first").hasClass("odd")?n.parents("tr:first").css("background-color","#f9f9f9"):n.parents("tr:first").css("background-color",""),addList.splice(addList.indexOf(t),1))})}});$("#addMemberModal").modal("show")})}function addMember(){var n=$("#unName").attr("value"),u=$("#unName").text(),t,i,r;if(addList==null||addList.length==0){layer.msg("请选择成员");return}t=addList.join(",");i=addList.length;addList=[];r=function(){$("#addMemberModal").modal("hide");var r={organizationUnitId:n,memberId:t};ajaxPost("/OrganizationUnitManagement/AddMember",r,function(t){if(layer.msg(t.errmsg),t.errno==0){getMemberList(n,u);var r=$("#on"+n).parents(".box-solid:first").find("span:first");r.html(parseInt(r.text())+i)}})};showConfirm("添加",r)}function deleteMember(n,t){t=unescape(t);var i=$("#unName").attr("value"),r=$("#unName").text(),u=function(){var t={organizationUnitId:i,memberId:n};ajaxPost("/OrganizationUnitManagement/DeleteMember",t,function(n){if(layer.msg(n.errmsg),n.errno==0){getMemberList(i,r);var t=$("#on"+i).parents(".box-solid:first").find("span:first");t.html(parseInt(t.text()-1))}})};showConfirm("删除成员："+t,u)}var memberList=null,addList=null;