function pageReady(){_permissionList[116]={uIds:["showAddUserModal"]};_permissionList[117]={uIds:[]};_permissionList[118]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);getUsersList();$(".ms2").select2();$("#add_perDiv").click(function(){var n=$("#addRole").val();n=n==null?"":n.join();$("#add_per_body").empty();isStrEmptyOrUndefined(n)||getOtherPermission("add_per_body",n,null)});$("#update_perDiv").click(function(){var n=$("#updateRole").val();n=n==null?"":n.join();getOtherPermission("update_per_body",n,permission)});$("#updatePassword").on("ifChanged",function(){$(this).is(":checked")?$("#updateNewPassword").removeAttr("disabled"):$("#updateNewPassword").attr("disabled","disabled").val("")});$("#addEmail,#updateEmail").on("input",function(){$(this)[0].value=$(this)[0].value.replace(/[^\w\@\.\-]+/g,"")});$("#add_per_body,#update_per_body").on("ifClicked",".on_cb",function(){var n=!$(this).is(":checked"),t=$(this).parents(".box-solid");t.eq(0).find(".on_cb").iCheck(n?"check":"uncheck");n&&t.find(".on_cb:first").iCheck("check")})}function getUsersList(){$("#userTable").empty();var n=new Promise(function(n){ajaxGet("/AccountManagement/List",null,function(t){if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}var i=_permissionList[117].have,r=_permissionList[118].have,f='<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button >    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">        <span class="caret"><\/span>        <span class="sr-only">Toggle Dropdown<\/span>    <\/button>    <ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}    <\/ul><\/div>',e="<li><a onclick=\"showUpdateUserModal({0}, '{1}', '{2}', '{3}', '{4}', '{5}', '{6}', '{7}','{8}','{9}','{10}')\">修改<\/a><\/li>",o="<li><a onclick=\"deleteUser({0}, '{1}')\">删除<\/a><\/li>",s=function(n){var t=e.format(n.id,n.role,escape(n.account),escape(n.name),escape(n.phone),escape(n.emailAddress),escape(n.permissions),escape(n.deviceIds),escape(n.productionRole),escape(n.emailType),escape(n.allDevice)),u=o.format(n.id,escape(n.account));return!i&&!r||n.isDeleted?"":f.format(i?t:"",r?u:"")},h=function(n){return n.isDeleted?"<span class='text-red'>是<\/span>":"否"},c=function(n,t,i,r){return r.row+1},u=[{data:"id",title:"id",render:c},{data:"account",title:"用户名"},{data:"number",title:"编号"},{data:"name",title:"姓名"},{data:"roleName",title:"角色"},{data:"phone",title:"手机号"},{data:"emailAddress",title:"邮箱"},{data:null,title:"删除",render:h}];(i||r)&&u.push({data:null,title:"操作",render:s,orderable:!1});$("#userTable").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:u})})});Promise.all([n]).then(()=>{})}function deleteUser(n,t){t=unescape(t);var i=function(){var i={id:n,account:t};ajaxPost("/AccountManagement/Delete",i,function(n){layer.msg(n.errmsg);n.errno==0&&getUsersList()})};showConfirm("删除用户："+t,i)}function roleRule(n,t){return n.id<t.id?1:-1}function addReset(){addList=[];$(".dd").val("");$("#addProcessor").iCheck("uncheck");$("#addSurveyor").iCheck("uncheck");lastAddRole=0;addList=[];showAddUserModal(-1)}function showAddUserModal(n=0){emailType();addList=[];$("#add_protoDiv").click();$(".dd").val("");$("#addProcessor").iCheck("uncheck");$("#addSurveyor").iCheck("uncheck");$("#addRole").empty();var t=new Promise(function(n){ajaxGet("/RoleManagement/List",null,function(t){var i,r;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas.sort(roleRule),f="";for(i=0;i<u.length;i++)r=u[i],f+='<option value="{0}">{1}<\/option>'.format(r.id,r.name);$("#addRole").append(f)})}),i=new Promise(function(n){deviceId=[];var t={};t.opType=100;ajaxPost("/Relay/Post",t,function(t){var i;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}for(i in t.datas)deviceId.push(t.datas[i].Id.toString());var r=function(n){return'<input type="checkbox" value="{0}" class="icb_minimal">'.format(n.Id)},u=0,f=function(){return++u};$("#addDeviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,aLengthMenu:[20,40,60],iDisplayLength:20,aaSorting:[[1,"asc"]],columns:[{data:null,title:"全选<input type='checkbox' class='icb_minimal' id='checkAll'>",render:r,orderable:!1},{data:"Id",title:"Id",render:f},{data:"Code",title:"机台号"},{data:"DeviceName",title:"设备名"}],drawCallback:function(){var t,n;$("#addDeviceList td").css("padding","3px");$("#addDeviceList .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});$("#addDeviceList .icb_minimal").on("ifChanged",function(){var n=$(this),t=n.attr("value"),i;if(!isStrEmptyOrUndefined(t))if(n.is(":checked"))n.parents("tr:first").css("background-color","gray"),addList.indexOf(t)==-1&&addList.push(t),$("#checkAll").is(":checked")&&(addList=[]),addList.length==deviceId.length&&$("#checkAll").iCheck("check");else if(n.parents("tr:first").hasClass("odd")?n.parents("tr:first").css("background-color","#f9f9f9"):n.parents("tr:first").css("background-color",""),addList.indexOf(t)!=-1&&addList.splice(addList.indexOf(t),1),$("#checkAll").is(":checked")){for(i=0;i<deviceId.length;i++)deviceId[i]!=t&&addList.push(deviceId[i]);$("#checkAll").iCheck("uncheck")}});$("#checkAll").on("ifChanged",function(){$(this).is(":checked")?($("#addDeviceList .icb_minimal").iCheck("check"),addList=[]):addList.length==0&&$("#addDeviceList .icb_minimal").iCheck("uncheck")});if($("#checkAll").is(":checked"))addList=[],$("#addDeviceList .icb_minimal").iCheck("check");else for(t=$("#addDeviceList .icb_minimal"),n=0;n<t.length;n++)isNumber(t[n].value)&&(addList.indexOf(t[n].value)==-1?$(t[n]).iCheck("uncheck"):$(t[n]).iCheck("check"))}})})});Promise.all([t,i]).then(()=>{n!=-1&&$("#addUserModal").modal("show")})}function emailType(){ajaxGet("/AccountManagement/EmailType",null,function(n){var u,i,t,r;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#addEmailType").empty(),tf&&(tf=!1,$("#addEmailType").before('<label class="control-label">邮件类型：<\/label>')),u='<label class="control-label" style="margin-left:10px">{1}：<\/label><input type="checkbox" value="{0}" class="icb_minimal">',i="",t=0;t<n.datas.length;t++)r=n.datas[t],i+=u.format(r.type,r.name);$("#addEmailType").append(i);$("#addEmailType .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal",increaseArea:"20%"});emailTypeData=[];$("#addEmailType .icb_minimal").on("ifChanged",function(){$(this).is(":checked")?emailTypeData.push($(this).val()):emailTypeData.splice(emailTypeData.indexOf($(this).val()),1)})})}function addUser(){var s=$("#addAccount").val().trim(),h=$("#addName").val().trim(),u=$("#addPhone").val().trim(),t=$("#addEmail").val().trim(),c=emailTypeData.join(),l=$("#addPassword").val().trim(),n=$("#addRole").val(),i,r,y,f,e,p,o,w;n=n==null?"":n.join();i=[];$("#addProcessor").is(":checked")&&i.push(0);$("#addSurveyor").is(":checked")&&i.push(1);var b=i.join(","),a=[],v=$("#add_per_body .on_cb");for(r=0,y=v.length;r<y;r++)f=v.eq(r),e=f.val(),f.is(":checked")&&e>0&&a.push(e);if(p=a.join(","),o="",o=$("#checkAll").is(":checked")?deviceId.join(","):addList.join(","),isStrEmptyOrUndefined(s)){layer.msg("用户名不能为空");return}if(isStrEmptyOrUndefined(h)){layer.msg("姓名不能为空");return}if(!isStrEmptyOrUndefined(u)&&!isPhone(u)){layer.msg("手机号错误");return}if(!isEmail(t)&&!isStrEmptyOrUndefined(t)){showTip("addEmailTip","邮箱格式不正确，请输入：登录名@主机名.域名的格式");return}if(isStrEmptyOrUndefined(l)){layer.msg("密码不能为空");return}if(isStrEmptyOrUndefined(t)&&!isStrEmptyOrUndefined(c)){layer.msg("选择邮件类型邮箱不能为空");return}if(isStrEmptyOrUndefined(n)){layer.msg("请选择角色");return}w=function(){$("#addUserModal").modal("hide");var i={account:s,password:l,name:h,phone:u,email:t,emailType:c,role:n,permissions:p,isProcessor:b,allDevice:$("#checkAll").is(":checked")?"1":"0",deviceIds:o};ajaxPost("/AccountManagement/Add",i,function(n){layer.msg(n.errmsg);n.errno==0&&getUsersList()})};showConfirm("添加",w)}function showUpdateUserModal(n,t,i,r,u,f,e,o,s,h,c){var l,a,v,y;t=t.split(",");i=unescape(i);r=unescape(r);u=unescape(u);f=unescape(f);e=unescape(e);o=unescape(o);s=unescape(s);h=unescape(h);c=unescape(c);isStrEmptyOrUndefined(o)||(updateList=o.split(","));$("#update_protoDiv").click();permission=e;$("#updateId").html(n);$("#updateAccount").val(i);$("#updateName").val(r);$("#updatePhone").val(u);$("#updateEmail").val(f);$("#updatePassword").iCheck("uncheck");$("#updateNewPassword").val("");l=s.split(",");$("#updateProcessor").iCheck(l.indexOf("0")>-1?"check":"uncheck");$("#updateSurveyor").iCheck(l.indexOf("1")>-1?"check":"uncheck");a=new Promise(function(n){ajaxGet("/AccountManagement/EmailType",null,function(t){var o,f,u,e,s,r,i;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}for($("#upEmailType").empty(),tf1&&(tf1=!1,$("#upEmailType").before('<label class="control-label">邮件类型：<\/label>')),o='<label class="control-label" style="margin-left:10px">{1}：<\/label><input type="checkbox" value="{0}" class="icb_minimal">',f="",u=0;u<t.datas.length;u++)e=t.datas[u],f+=o.format(e.type,e.name);for($("#upEmailType").append(f),$("#upEmailType .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal",increaseArea:"20%"}),s=h.split(","),r=$("#upEmailType .icb_minimal"),i=0;i<r.length;i++)s.indexOf(r[i].value)==-1?$(r[i]).iCheck("uncheck"):$(r[i]).iCheck("check")})});$("#updateRole").empty();v=new Promise(function(n){ajaxGet("/RoleManagement/List",null,function(i){var r,u;if(n("success"),i.errno!=0){layer.msg(i.errmsg);return}var f=i.datas.sort(roleRule),o="";for(r=0;r<f.length;r++)u=f[r],o+='<option value="{0}">{1}<\/option>'.format(u.id,u.name);$("#updateRole").append(o);$("#updateRole").val(t).trigger("update");getOtherPermission("update_per_body",$("#updateRole").val(),e)})});y=new Promise(function(n){deviceId=[];var t={};t.opType=100;ajaxPost("/Relay/Post",t,function(t){var i;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}c=="true"&&(updateList=[]);for(i in t.datas)deviceId.push(t.datas[i].Id.toString()),c=="true"&&updateList.push(t.datas[i].Id);var r=function(n){return'<input type="checkbox" value="{0}" class="icb_minimal" onclick="">'.format(n.Id)},u=0,f=function(){return++u};$("#updateDeviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,aLengthMenu:[20,40,60],iDisplayLength:20,aaSorting:[[1,"asc"]],columns:[{data:null,title:"全选<input type='checkbox' class='icb_minimal' id='upCheckAll'>",render:r,orderable:!1},{data:"Id",title:"Id",render:f},{data:"Code",title:"机台号"},{data:"DeviceName",title:"设备名"}],drawCallback:function(){var t,n;$("#updateDeviceList td").css("pupdateing","3px");$("#updateDeviceList .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});updateList.length==deviceId.length&&$("#upCheckAll").iCheck("check");$("#updateDeviceList .icb_minimal").on("ifChanged",function(){var n=$(this),t=n.attr("value"),i;if(!isStrEmptyOrUndefined(t))if(n.is(":checked"))n.parents("tr:first").css("background-color","gray"),updateList.indexOf(t)==-1&&updateList.push(t),$("#upCheckAll").is(":checked")&&(updateList=[]),updateList.length==deviceId.length&&$("#upCheckAll").iCheck("check");else if(n.parents("tr:first").hasClass("odd")?n.parents("tr:first").css("background-color","#f9f9f9"):n.parents("tr:first").css("background-color",""),updateList.indexOf(t)!=-1&&updateList.splice(updateList.indexOf(t),1),$("#upCheckAll").is(":checked")){for(i=0;i<deviceId.length;i++)deviceId[i]!=t&&updateList.push(deviceId[i]);$("#upCheckAll").iCheck("uncheck")}});$("#upCheckAll").on("ifChanged",function(){$(this).is(":checked")?($("#updateDeviceList .icb_minimal").iCheck("check"),updateList=[]):updateList.length==0&&$("#updateDeviceList .icb_minimal").iCheck("uncheck")});if($("#upCheckAll").is(":checked"))updateList=[],$("#updateDeviceList .icb_minimal").iCheck("check");else for(t=$("#updateDeviceList .icb_minimal"),n=0;n<t.length;n++)isNumber(t[n].value)&&(updateList.indexOf(t[n].value)==-1?$(t[n]).iCheck("uncheck"):$(t[n]).iCheck("check"))}})})});Promise.all([a,v,y]).then(()=>{$("#updateUserModal").modal("show")})}function updateUser(){for(var e,o,n,i,r,k,s,h,d,c,l,a,g,nt=parseInt($("#updateId").html()),v=$("#updateName").val(),t=$("#updateEmail").val(),u=$("#updatePhone").val(),y=[],p=$("#upEmailType .icb_minimal"),f=0;f<p.length;f++)e=p[f],$(e).is(":checked")&&y.push(e.value);o=y.join();n=$("#updateRole").val();n=n==null?"":n.join();i=[];$("#updateProcessor").is(":checked")&&i.push(0);$("#updateSurveyor").is(":checked")&&i.push(1);var tt=i.join(","),w=[],b=$("#update_per_body .on_cb");for(r=0,k=b.length;r<k;r++)s=b.eq(r),h=s.val(),s.is(":checked")&&h>0&&w.push(h);if(d=w.join(","),c="",c=$("#upCheckAll").is(":checked")?"":updateList.join(","),isStrEmptyOrUndefined(v)){layer.msg("姓名不能为空");return}if(!isStrEmptyOrUndefined(u)&&!isPhone(u)){layer.msg("手机号错误");return}if(l={id:nt,name:v,phone:u,email:t,emailType:o,role:n,permissions:d,isProcessor:tt,allDevice:$("#upCheckAll").is(":checked")?"1":"0",deviceIds:c},!isEmail(t)&&!isStrEmptyOrUndefined(t)){showTip("updateEmailTip","邮箱格式不正确，请输入：登录名@主机名.域名的格式");return}if($("#updatePassword").is(":checked")){if(a=$("#updateNewPassword").val(),isStrEmptyOrUndefined(a)){layer.msg("密码不能为空");return}l.password=a}if(isStrEmptyOrUndefined(t)&&!isStrEmptyOrUndefined(o)){layer.msg("选择邮件类型邮箱不能为空");return}if(isStrEmptyOrUndefined(addRole)){layer.msg("请选择角色");return}g=function(){$("#updateUserModal").modal("hide");ajaxPost("/AccountManagement/Update",l,function(n){layer.msg(n.errmsg);n.errno==0&&getUsersList()})};showConfirm("修改",g)}function getOtherPermission(n,t,i,r=0){if(r==0){if(lastAddRole==t)return;lastAddRole=t}else{if(lastUpdateRole==t)return;lastUpdateRole=t}var u=null;isStrEmptyOrUndefined(i)||(u=i.split(",").map(Number));$(`#${n}`).empty();ajaxGet("/Account/OtherPermissions",{role:t},function(t){var f,i,e,r,o;if(t.errno!=0){layer.msg(t.errmsg);return}for(f=t.datas,i=[],u!=null&&$.each(f,(n,t)=>{u.indexOf(t.id)>-1&&i.push(t.id)}),showPermissions(n,f),e=$("#update_per_body .on_cb"),i.length&&e.filter("[value=0]").iCheck("check"),r=0,o=i.length;r<o;r++)e.filter(`[value=${i[r]}]`).iCheck("check")})}function showPermissions(n,t){for(var r,u,e,o=`<div class="box box-solid noShadow" style="margin-bottom: 0;">
                            <div class="box-header no-padding">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="on_i fa fa-minus"></i></button>
                                <label class="pointer" style="margin:0;font-weight:inherit">
                                    <input type="checkbox" class="on_cb" style="width: 15px" value="0">
                                    <span class="textOverTop" style="vertical-align: middle;font-size: 16px">权限管理</span>
                                </label>
                            </div>
                            <div class="box-body no-padding">
                                <ul class="on_ul nav nav-pills nav-stacked mli" style="margin-left: 20px">{0}</ul>
                            </div>
                        </div>`,s=`<li><div class="box box-solid noShadow collapsed-box" style="margin-bottom: 0;">
                        <div class="box-header no-padding">
                            <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="on_i fa fa-plus"></i></button>
                            <label class="pointer" style="margin:0;font-weight:inherit">
                                <input type="checkbox" class="on_cb" style="width: 15px" value="{0}">
                                <span class="textOverTop" style="vertical-align: middle;font-size: 16px">{1}</span>
                            </label>
                        </div>
                        <div class="box-body no-padding">
                            <ul class="on_ul nav nav-pills nav-stacked mli" style="margin-left: 20px">{2}</ul>
                        </div>
                    </div></li>`,h=`<li><div class="box box-solid noShadow" style="margin-bottom: 0;">
                            <div class="box-header no-padding">
                                <a type="button" class="btn btn-box-tool disabled" data-widget="collapse"><i class="fa fa-chevron-right"></i></a>
                                <label class="pointer" style="margin:0;font-weight:inherit">
                                    <input type="checkbox" class="on_cb" style="width: 15px" value="{0}">
                                    <span class="textOverTop" style="vertical-align: middle;font-size: 16px">{1}</span>
                                </label>
                            </div>
                        </div></li>`,i={parent:[]},f=0,c=t.length;f<c;f++)r=t[f],u=r.parent,u==0?i.parent.push(r):i[u]?i[u].push(r):i[u]=[r];e=n=>(n.sort((n,t)=>n.order-t.order),n.map(n=>{return""+(i[n.id]?s.format(n.id,n.name,e(i[n.id])):h.format(n.id,n.name))}).join(""));$(`#${n}`).empty().append(i.parent.length?o.format(e(i.parent)):"");$(".on_cb").iCheck({checkboxClass:"icheckbox_minimal",increaseArea:"20%"})}var _permissionList=[],addList=null,deviceId=null,emailTypeData=[],tf=!0,updateList=[],permission=null,tf1=!0,lastAddRole=0,lastUpdateRole=0;