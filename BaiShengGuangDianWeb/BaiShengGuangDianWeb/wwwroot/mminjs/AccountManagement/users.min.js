function pageReady(){_permissionList[116]={uIds:["showAddUserModal"]};_permissionList[117]={uIds:[]};_permissionList[118]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);getUsersList();$(".ms2").select2();$("#add_perDiv").on("click",function(){var n=$("#addRole").val();n=n==null?"":n.join();getOtherPermission("add_per_body",n,null)});$("#update_perDiv").on("click",function(){var n=$("#updateRole").val();n=n==null?"":n.join();getOtherPermission("update_per_body",n,permission,1)});$("#updatePassword").on("ifChanged",function(){$(this).is(":checked")?$("#updateNewPassword").removeAttr("disabled"):$("#updateNewPassword").attr("disabled","disabled").val("")});$("#addEmail,#updateEmail").on("input",function(){$(this)[0].value=$(this)[0].value.replace(/[^\w\@\.\-]+/g,"")});$("#add_per_body,#update_per_body").on("ifClicked",".on_cb",function(){var n=!$(this).is(":checked"),t=$(this).parents(".box-solid");t.eq(0).find(".on_cb").iCheck(n?"check":"uncheck");n&&t.find(".on_cb:first").iCheck("check")});$("#updateAccount,#addAccount").on("input",function(){$(this).val($(this).val().replace(/\W/g,""))})}function getUsersList(){var n=new Promise(function(n){ajaxPost("/Relay/Post",{opType:75,opData:JSON.stringify({all:!0})},t=>{if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}const f=t.datas,i="userTable",e=`#${i}`,o=`${i}Arr`,s=`${i}Data`;if(tableTmp[o]=[],tableTmp[s]=[],tableTmp[i])updateTable(tableTmp[i],f);else{const n=dataTableConfig(f);var r=_permissionList[117].have,u=_permissionList[118].have,h=function(n){return n.MarkedDelete?"<span class='text-red'>是<\/span>":"否"};if(n.addColumns([{data:"Account",title:"用户名"},{data:"Number",title:"编号"},{data:"Name",title:"姓名"},{data:"RoleName",title:"角色"},{data:"Phone",title:"手机号"},{data:"EmailAddress",title:"邮箱"},{data:null,title:"删除",render:h}]),r||u){const t=function(n){const t=`<li><a onclick="showUpdateUserModal(${n.Id}, '${n.Role}', '${escape(n.Account)}', 
                                            '${escape(n.Name)}', '${escape(n.Phone)}', '${escape(n.EmailAddress)}', 
                                            '${escape(n.SelfPermissions)}', '${escape(n.DeviceIds)}','${escape(n.ProductionRole)}','${escape(n.EmailType)}','${escape(n.AllDevice)}')">修改</a></li>`,i=`<li><a onclick="deleteUser(${n.Id}, '${escape(n.Account)}')">删除</a></li>`;return n.MarkedDelete||!r&&!u?"":`<div class="btn-group">
                                <button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"></i>操作</button >
                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                        <span class="caret"></span>
                                        <span class="sr-only">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" role="menu" style="cursor:pointer">${r?t:""}${u?i:""}
                                    </ul>
                                </div>`};n.addColumns([{data:null,title:"操作",render:t,orderable:!1}])}tableTmp[i]=$(e).DataTable(n)}})});Promise.all([n]).then(()=>{})}function deleteUser(n,t){t=unescape(t);showConfirm(`删除用户：${t}`,()=>{ajaxPost("/Relay/Post",{opType:78,opData:JSON.stringify({ids:[n]})},n=>{layer.msg(n.errmsg),n.errno==0&&getUsersList()})})}function roleRule(n,t){return n.Id<t.Id?1:-1}function addReset(){addList=[];$(".dd").val("");$("#addProcessor").iCheck("uncheck");$("#addSurveyor").iCheck("uncheck");lastAddRole="";addList=[];showAddUserModal(-1)}function showAddUserModal(n=0){lastAddRole="";emailType();addList=[];$("#add_protoDiv").click();$(".dd").val("");$("#addProcessor").iCheck("uncheck");$("#addSurveyor").iCheck("uncheck");$("#addRole").empty();var t=new Promise(function(n){ajaxPost("/Relay/Post",{opType:81},t=>{var i,r;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas.sort(roleRule),f="";for(i=0;i<u.length;i++)r=u[i],f+='<option value="{0}">{1}<\/option>'.format(r.Id,r.Name);$("#addRole").append(f)})}),i=new Promise(function(n){deviceId=[];ajaxPost("/Relay/Post",{opType:100},t=>{var i;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}for(i in t.datas)deviceId.push(t.datas[i].Id.toString());var r=function(n){return'<input type="checkbox" value="{0}" class="icb_minimal">'.format(n.Id)},u=0,f=function(){return++u};$("#addDeviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,aLengthMenu:[20,40,60],iDisplayLength:20,aaSorting:[[1,"asc"]],columns:[{data:null,title:"全选<input type='checkbox' class='icb_minimal' id='checkAll'>",render:r,orderable:!1},{data:"Id",title:"Id",render:f},{data:"Code",title:"机台号"},{data:"DeviceName",title:"设备名"}],drawCallback:function(){var t,n;$("#addDeviceList td").css("padding","3px");$("#addDeviceList .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});$("#addDeviceList .icb_minimal").on("ifChanged",function(){var n=$(this),t=n.attr("value"),i;if(!isStrEmptyOrUndefined(t))if(n.is(":checked"))n.parents("tr:first").css("background-color","gray"),addList.indexOf(t)==-1&&addList.push(t),$("#checkAll").is(":checked")&&(addList=[]),addList.length==deviceId.length&&$("#checkAll").iCheck("check");else if(n.parents("tr:first").hasClass("odd")?n.parents("tr:first").css("background-color","#f9f9f9"):n.parents("tr:first").css("background-color",""),addList.indexOf(t)!=-1&&addList.splice(addList.indexOf(t),1),$("#checkAll").is(":checked")){for(i=0;i<deviceId.length;i++)deviceId[i]!=t&&addList.push(deviceId[i]);$("#checkAll").iCheck("uncheck")}});$("#checkAll").on("ifChanged",function(){$(this).is(":checked")?($("#addDeviceList .icb_minimal").iCheck("check"),addList=[]):addList.length==0&&$("#addDeviceList .icb_minimal").iCheck("uncheck")});if($("#checkAll").is(":checked"))addList=[],$("#addDeviceList .icb_minimal").iCheck("check");else for(t=$("#addDeviceList .icb_minimal"),n=0;n<t.length;n++)isNumber(t[n].value)&&(addList.indexOf(t[n].value)==-1?$(t[n]).iCheck("uncheck"):$(t[n]).iCheck("check"))}})})});Promise.all([t,i]).then(()=>{n!=-1&&$("#addUserModal").modal("show")})}function emailType(){ajaxPost("/Relay/Post",{opType:79},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#addEmailType").empty();tf&&(tf=!1,$("#addEmailType").before('<label class="control-label">邮件类型：<\/label>'));$("#addEmailType").append(n.datas.reduce((n,t)=>`${n}<label class="control-label" style="margin-left:10px">${t.Name}：</label><input type="checkbox" value=${t.Type} class="icb_minimal">`,"")).iCheck({checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal",increaseArea:"20%"});emailTypeData=[];$("#addEmailType .icb_minimal").on("ifChanged",function(){$(this).is(":checked")?emailTypeData.push($(this).val()):emailTypeData.splice(emailTypeData.indexOf($(this).val()),1)})})}function addUser(n){var h=$("#addAccount").val().trim(),c=$("#addName").val().trim(),f=$("#addPhone").val().trim(),i=$("#addEmail").val().trim(),l=emailTypeData.join(),a=$("#addPassword").val().trim(),t=$("#addRole").val(),r,u,p,e,o,w,s;t=t==null?"":t.join();r=[];$("#addProcessor").is(":checked")&&r.push(0);$("#addSurveyor").is(":checked")&&r.push(1);var b=r.join(","),v=[],y=$("#add_per_body .on_cb");for(u=0,p=y.length;u<p;u++)e=y.eq(u),o=e.val(),e.is(":checked")&&o>0&&v.push(o);if(w=v.join(","),s="",s=$("#checkAll").is(":checked")?deviceId.join(","):addList.join(","),isStrEmptyOrUndefined(h)){layer.msg("用户名不能为空");return}if(isStrEmptyOrUndefined(c)){layer.msg("姓名不能为空");return}if(!isStrEmptyOrUndefined(f)&&!isPhone(f)){layer.msg("手机号错误");return}if(!isEmail(i)&&!isStrEmptyOrUndefined(i)){showTip("addEmailTip","邮箱格式不正确，请输入：登录名@主机名.域名的格式");return}if(isStrEmptyOrUndefined(a)){layer.msg("密码不能为空");return}if(isStrEmptyOrUndefined(i)&&!isStrEmptyOrUndefined(l)){layer.msg("选择邮件类型邮箱不能为空");return}if(isStrEmptyOrUndefined(t)){layer.msg("请选择角色");return}showConfirm("添加",()=>{ajaxPost("/Relay/Post",{opType:77,opData:JSON.stringify([{Account:h,Password:a,Name:c,Phone:f,EmailAddress:i,EmailType:l,Role:t,Permissions:w,ProductionRole:b,AllDevice:$("#checkAll").is(":checked"),DeviceIds:s}])},t=>{(layer.msg(t.errmsg),t.errno==0)&&(n&&$("#addUserModal").modal("hide"),getUsersList())})})}function showUpdateUserModal(n,t,i,r,u,f,e,o,s,h,c){var l,a,v,y;lastUpdateRole="";t=t.split(",");i=unescape(i);r=unescape(r);u=unescape(u);f=unescape(f);e=unescape(e);o=unescape(o);s=unescape(s);h=unescape(h);c=unescape(c);isStrEmptyOrUndefined(o)||(updateList=o.split(","));$("#update_protoDiv").click();permission=e;$("#updateId").html(n);$("#updateAccount").val(i);$("#updateName").val(r);$("#updatePhone").val(u);$("#updateEmail").val(f);$("#updatePassword").iCheck("uncheck");$("#updateNewPassword").val("");l=s.split(",");$("#updateProcessor").iCheck(l.indexOf("0")>-1?"check":"uncheck");$("#updateSurveyor").iCheck(l.indexOf("1")>-1?"check":"uncheck");a=new Promise(function(n){ajaxPost("/Relay/Post",{opType:79},t=>{var u,r,i;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}for($("#upEmailType").empty(),tf1&&(tf1=!1,$("#upEmailType").before('<label class="control-label">邮件类型：<\/label>')),$("#upEmailType").html(t.datas.reduce((n,t)=>`${n}<label class="control-label" style="margin-left:10px">${t.Name}：</label><input type="checkbox" value=${t.Type} class="icb_minimal">`,"")).iCheck({checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal",increaseArea:"20%"}),u=h.split(","),r=$("#upEmailType .icb_minimal"),i=0;i<r.length;i++)u.indexOf(r[i].value)==-1?$(r[i]).iCheck("uncheck"):$(r[i]).iCheck("check")})});$("#updateRole").empty();v=new Promise(function(n){ajaxPost("/Relay/Post",{opType:81},i=>{if(n("success"),i.errno!=0){layer.msg(i.errmsg);return}var r=i.datas.sort(roleRule);$("#updateRole").html(setOptions(r,"Name"));$("#updateRole").val(t).trigger("update");getOtherPermission("update_per_body",t,e,1)})});y=new Promise(function(n){deviceId=[];var t={};t.opType=100;ajaxPost("/Relay/Post",t,function(t){var i;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}c=="true"&&(updateList=[]);for(i in t.datas)deviceId.push(t.datas[i].Id.toString()),c=="true"&&updateList.push(t.datas[i].Id);var r=function(n){return'<input type="checkbox" value="{0}" class="icb_minimal" onclick="">'.format(n.Id)},u=0,f=function(){return++u};$("#updateDeviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,aLengthMenu:[20,40,60],iDisplayLength:20,aaSorting:[[1,"asc"]],columns:[{data:null,title:"全选<input type='checkbox' class='icb_minimal' id='upCheckAll'>",render:r,orderable:!1},{data:"Id",title:"Id",render:f},{data:"Code",title:"机台号"},{data:"DeviceName",title:"设备名"}],drawCallback:function(){var t,n;$("#updateDeviceList td").css("pupdateing","3px");$("#updateDeviceList .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});updateList.length==deviceId.length&&$("#upCheckAll").iCheck("check");$("#updateDeviceList .icb_minimal").on("ifChanged",function(){var n=$(this),t=n.attr("value"),i;if(!isStrEmptyOrUndefined(t))if(n.is(":checked"))n.parents("tr:first").css("background-color","gray"),updateList.indexOf(t)==-1&&updateList.push(t),$("#upCheckAll").is(":checked")&&(updateList=[]),updateList.length==deviceId.length&&$("#upCheckAll").iCheck("check");else if(n.parents("tr:first").hasClass("odd")?n.parents("tr:first").css("background-color","#f9f9f9"):n.parents("tr:first").css("background-color",""),updateList.indexOf(t)!=-1&&updateList.splice(updateList.indexOf(t),1),$("#upCheckAll").is(":checked")){for(i=0;i<deviceId.length;i++)deviceId[i]!=t&&updateList.push(deviceId[i]);$("#upCheckAll").iCheck("uncheck")}});$("#upCheckAll").on("ifChanged",function(){$(this).is(":checked")?($("#updateDeviceList .icb_minimal").iCheck("check"),updateList=[]):updateList.length==0&&$("#updateDeviceList .icb_minimal").iCheck("uncheck")});if($("#upCheckAll").is(":checked"))updateList=[],$("#updateDeviceList .icb_minimal").iCheck("check");else for(t=$("#updateDeviceList .icb_minimal"),n=0;n<t.length;n++)isNumber(t[n].value)&&(updateList.indexOf(t[n].value)==-1?$(t[n]).iCheck("uncheck"):$(t[n]).iCheck("check"))}})})});Promise.all([a,v,y]).then(()=>{$("#updateUserModal").modal("show")})}function updateUser(n){for(var o,s,t,r,u,d,h,c,g,l,a,v,nt=parseInt($("#updateId").html()),y=$("#updateName").val(),i=$("#updateEmail").val(),f=$("#updatePhone").val(),p=[],w=$("#upEmailType .icb_minimal"),e=0;e<w.length;e++)o=w[e],$(o).is(":checked")&&p.push(o.value);s=p.join();t=$("#updateRole").val();t=t==null?"":t.join();r=[];$("#updateProcessor").is(":checked")&&r.push(0);$("#updateSurveyor").is(":checked")&&r.push(1);var tt=r.join(","),b=[],k=$("#update_per_body .on_cb");for(u=0,d=k.length;u<d;u++)h=k.eq(u),c=h.val(),h.is(":checked")&&c>0&&b.push(c);if(g=b.join(","),l="",l=$("#upCheckAll").is(":checked")?"":updateList.join(","),isStrEmptyOrUndefined(y)){layer.msg("姓名不能为空");return}if(!isStrEmptyOrUndefined(f)&&!isPhone(f)){layer.msg("手机号错误");return}if(!isEmail(i)&&!isStrEmptyOrUndefined(i)){showTip("updateEmailTip","邮箱格式不正确，请输入：登录名@主机名.域名的格式");return}if(a={Id:nt,Name:y,Phone:f,EmailAddress:i,EmailType:s,Role:t,Permissions:g,ProductionRole:tt,AllDevice:$("#checkAll").is(":checked"),DeviceIds:l},$("#updatePassword").is(":checked")){if(v=$("#updateNewPassword").val(),isStrEmptyOrUndefined(v)){layer.msg("密码不能为空");return}a.NewPassword=v}if(isStrEmptyOrUndefined(i)&&!isStrEmptyOrUndefined(s)){layer.msg("选择邮件类型邮箱不能为空");return}if(isStrEmptyOrUndefined(addRole)){layer.msg("请选择角色");return}showConfirm("修改",()=>{ajaxPost("/Relay/Post",{opType:76,opData:JSON.stringify([a])},t=>{(layer.msg(t.errmsg),t.errno==0)&&(n&&$("#updateUserModal").modal("hide"),getUsersList())})})}function getOtherPermission(n,t,i,r=0){if(r==0){if(lastAddRole===t)return;$("#add_per_body").empty();lastAddRole=t}else{if(lastUpdateRole===t)return;$("#update_per_body").empty();lastUpdateRole=t}var u=null;isStrEmptyOrUndefined(i)||(u=i.split(",").map(Number));$(`#${n}`).empty();ajaxPost("/Relay/Post",{opType:53,opData:JSON.stringify({role:t})},t=>{var e=t.datas,i=[],f,r,o;for(u!=null&&$.each(e,(n,t)=>{u.indexOf(t.Id)>-1&&i.push(t.Id)}),showPermissions(n,e),f=$("#update_per_body .on_cb"),i.length&&f.filter("[value=0]").iCheck("check"),r=0,o=i.length;r<o;r++)f.filter(`[value = ${i[r]}]`).iCheck("check")})}var _permissionList=[],tableTmp=[],addList=null,deviceId=null,emailTypeData=[],tf=!0,updateList=[],permission=null,tf1=!0,lastAddRole=0,lastUpdateRole=0;