function pageReady(){_permissionList[161]={uIds:["showAddModel"]};_permissionList[162]={uIds:[]};_permissionList[163]={uIds:[]};_permissionList[164]={uIds:["showBatchUpgradeModelBtn"]};_permissionList[148]={uIds:[]};_permissionList[147]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);getDeviceList();$(".ads").css("width","100%").select2();$(".col-sm-2").addClass("mcolsm2");$("#addIp").inputmask("ip");$("#updateIp").inputmask("ip");$("#addDeviceCategory").on("select2:select",function(){var r,i,n,t;for(hideTip("addDeviceModelTip"),hideTip("addScriptTip"),r=parseInt($("#addDeviceCategory option:checked").val()),$("#addDeviceModel").empty(),i=0,t=0;t<models.length;t++)n=models[t],n.DeviceCategoryId==r&&(i=i==0?n.Id:i,$("#addDeviceModel").append(option.format(n.Id,n.ModelName)));for($("#addScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#addScript").append(option.format(n.Id,n.ScriptName))});$("#addDeviceModel").on("select2:select",function(){var i,t,n;for(hideTip("addScriptTip"),i=parseInt($("#addDeviceModel option:checked").val()),$("#addScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#addScript").append(option.format(n.Id,n.ScriptName))});$("#updateDeviceCategory").on("select2:select",function(){var r,i,n,t;for(hideTip("updateDeviceModelTip"),hideTip("updateScriptTip"),r=parseInt($("#updateDeviceCategory option:checked").val()),$("#updateDeviceModel").empty(),i=0,t=0;t<models.length;t++)n=models[t],n.DeviceCategoryId==r&&(i=i==0?n.Id:i,$("#updateDeviceModel").append(option.format(n.Id,n.ModelName)));for($("#updateScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#updateScript").append(option.format(n.Id,n.ScriptName))});$("#updateDeviceModel").on("select2:select",function(){var i=parseInt($("#updateDeviceModel option:checked").val()),t,n;for($("#updateScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&(hideTip("updateScriptTip"),$("#updateScript").append(option.format(n.Id,n.ScriptName)))});$("#scriptList,#firmwareList").on("select2:select",".code",function(n){var s=n.delegateTarget.id,c=$("#batchType li[class~=active]").prevAll().length,u=_batchCodeData[c],f=$(this).val(),e,o,l,i,t,h,r;for(u.push(f),e=$(this).data("last"),$(this).data("last",f),isStrEmptyOrUndefined(e)||(u.splice(u.indexOf(e),1),$(`#${s} .code option[value=${e}]`).prop("disabled",!1)),o=0,l=u.length;o<l;o++)$(`#${s} .code option[value=${u[o]}]`).prop("disabled",!0);if($(`#${s} .code`).select2(),i=$(this).parents("tr"),i.find(".delTr").val(f),t=_deviceData[f],t){h=t.DeviceStateStr;switch(h){case"待加工":r="success";break;case"加工中":r="success";break;case"已确认":r="warning";break;case"维修中":r="info";break;default:r="red"}i.find(".devState").html(`<span class="text-${r}">${h}</span>`);switch(c){case 0:i.find(".devModel").text(`${t.CategoryName}-${t.ModelName}`);new Promise(n=>getUpgrade(n,113,"ScriptFile","ScriptName",t.DeviceModelId)).then(n=>{i.find(".script").empty().append(n).val(t.ScriptId).trigger("change")});break;case 1:new Promise(n=>getUpgrade(n,130,"FilePath","FirmwareName")).then(n=>{i.find(".firmware").empty().append(n).val(t.FirmwareId).trigger("change")})}i.find(".result").empty()}});$("#batchUpgradeModel").on("hidden.bs.modal",()=>{clearInterval($("#scriptList")[0].time),clearInterval($("#firmwareList")[0].time),getDeviceList()});$("#script_nav_table,#firmware_nav_table").css("maxHeight",innerHeight*.7)}function getDeviceList(n,t){var i={};i.opType=100;i.opData=JSON.stringify({hard:!0});ajaxPost("/Relay/Post",i,function(i){var r,u,e,f;if(i.errno!=0){layer.msg(i.errmsg);return}for(r=i.datas,_deviceData={state:0},u=0,e=r.length;u<e;u++)f=r[u],_deviceData[f.Id]=f,f.DeviceStateStr=="待加工"&&_deviceData.state++;if(!isStrEmptyOrUndefined(n)&&t){n("success");return}var o=_permissionList[148].have,s=_permissionList[147].have,h=_permissionList[162].have,c=_permissionList[164].have,l=_permissionList[163].have,a=function(n){var t="<li><a onclick=\"showControl({0},'{1}')\">控制<\/a><\/li>".format(n.Id,escape(n.DeviceStateStr)),i='<li><a onclick="showDetail({0})">详情<\/a><\/li>'.format(n.Id),r="<li><a onclick=\"showUpdateModel({0}, '{1}', '{2}', '{3}', '{4}', '{5}', '{6}', {7}, {8}, {9}, {10}, {11}, {12}, '{13}', '{14}', {15},{16}, '{17}')\">修改<\/a><\/li>".format(n.Id,escape(n.DeviceName),escape(n.Code),escape(n.MacAddress),escape(n.Ip),escape(n.Port),escape(n.Identifier),escape(n.DeviceModelId),escape(n.ScriptId),escape(n.FirmwareId),escape(n.ApplicationId),escape(n.HardwareId),escape(n.SiteId),escape(n.Administrator),escape(n.Remark),escape(n.DeviceCategoryId),escape(n.ClassId),escape(n.Icon)),u='<li><a onclick="showUpgrade({0})">升级<\/a><\/li>'.format(n.Id),f="<li><a onclick=\"deleteDevice({0}, '{1}')\">删除<\/a><\/li>".format(n.Id,escape(n.Code));return'<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button ><button type = "button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">   <span class="caret"><\/span>   <span class="sr-only">Toggle Dropdown<\/span><\/button><ul class="dropdown-menu pointer" role="menu">{0}{1}{2}{3}{4}<\/ul><\/div>'.format(o?t:"",s?i:"",h?r:"",c?u:"",l?f:"")},v=function(n){return`${n.Ip}:${n.Port}`},y=function(n){var t=n.StateStr;return t=="连接正常"?'<span class="text-success">'+t+"<\/span>":'<span class="text-danger">'+t+"<\/span>"},p=function(n){var t=n.DeviceStateStr;return t=="待加工"?'<span class="text-success">'+t+"<\/span>":t=="加工中"?'<span class="text-success">'+t+"<\/span>":t=="已确认"?'<span class="text-warning">'+t+"<\/span>":t=="维修中"?'<span class="text-info">'+t+"<\/span>":'<span class="text-red">'+t+"<\/span>"},w=function(n){return n.CategoryName+"-"+n.ModelName},b=function(n,t,i,r){return++r.row},k=function(n){var t=n.SiteName+n.RegionDescription;return(""+t).length>tdShowContentLength?t.substr(0,tdShowContentLength)+' <a href = "javascript:showPlaceNameModel({0})">...<\/a> '.format(n.Id):t};$("#deviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:r,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:b},{data:"Code",title:"机台号",type:"html-percent"},{data:"Class",title:"设备分类"},{data:null,title:"设备型号",render:w},{data:null,title:"摆放位置",render:k},{data:null,title:"IP地址",render:v},{data:"AdministratorName",title:"管理员"},{data:null,title:"运行状态",render:y},{data:null,title:"设备状态",render:p},{data:null,title:"操作",render:a,orderable:!1,visible:o||s||h||c||l}]})})}function showPlaceNameModel(n){var t={};t.opType=100;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&($("#siteName").html(n.datas[0].SiteName),$("#regionDescription").html(n.datas[0].RegionDescription));$("#placeNameModel").modal("show")})}function initAddSelect(){var t,n,r,i;for($("#addDeviceCategory").append(setOptions(categories,"CategoryName")),r=categories[0].Id,i=0,t=0;t<models.length;t++)n=models[t],n.DeviceCategoryId==r&&(i==0&&(i=n.Id),$("#addDeviceModel").append(option.format(n.Id,n.ModelName)));if(i!=0)for(t=0;t<scripts.length;t++)n=scripts[t],n.DeviceModelId.indexOf(i)!=-1&&$("#addScript").append(option.format(n.Id,n.ScriptName))}function showAddModel(){_addUpload==null&&(_addUpload=initFileInput("addImg",fileEnum.Device));$("#addImg").fileinput("clear");$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");var n={};n.opType=107;ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}$("#addModel .ads").empty();$("#addCode,#addDeviceName,#addMacAddress,#addIp,#addIdentifier,#addAdministrator,#addRemark").val("");$("#addPort").val("60000");$("#addDeviceClass").append(setOptions(n.classes,"Class"));$("#addFirmware").append(setOptions(n.firmwareLibraries,"FirmwareName"));$("#addApplication").append(setOptions(n.applicationLibraries,"ApplicationName"));$("#addHardware").append(setOptions(n.hardwareLibraries,"HardwareName"));for(var i,r="",t=0;t<n.sites.length;t++)i=n.sites[t],r+=option.format(i.Id,i.SiteName+i.RegionDescription);for($("#addSite").append(r),r="",t=0;t<n.maintainers.length;t++)i=n.maintainers[t],r+=option.format(i.Account,i.Name);$("#addAdministrator").append(r);categories=n.deviceCategories;models=n.deviceModels;scripts=n.scriptVersions;initAddSelect();hideClassTip("adt");$("#addModel").modal("show")})}function addDevice(){var n=!0,i=$("#addCode").val().trim(),r,t,u,f,v,e,y,o,s,h,c,l,a,p,w,k;if(isStrEmptyOrUndefined(i)&&(showTip("addCodeTip","机台号不能为空"),n=!1),r=$("#addDeviceName").val().trim(),isStrEmptyOrUndefined(r)&&(showTip("addDeviceNameTip","设备名不能为空"),n=!1),t=$("#addMacAddress").val().trim(),isMac(t)||isStrEmptyOrUndefined(t)||(showTip("addMacAddressTip","MAC地址格式不正确，请以xx:xx:xx:xx:xx:xx或xx-xx-xx-xx-xx-xx的形式输入，x为数字或字母（A-F大小写均可）"),n=!1),u=$("#addIp").val().trim().replace("_",""),isIp(u)||(showTip("addIpTip","IP非法"),n=!1),f=$("#addPort").val().trim(),isPort(f)||(showTip("addPortTip","端口非法"),n=!1),v=$("#addIdentifier").val(),e=$("#addDeviceClass").val(),isStrEmptyOrUndefined(e)&&(showTip("addDeviceClassTip","设备分类错误"),n=!1),y=$("#addDeviceCategory").val(),isStrEmptyOrUndefined(y)&&(showTip("addDeviceCategoryTip","设备类型错误"),n=!1),o=$("#addDeviceModel").val(),isStrEmptyOrUndefined(o)&&(showTip("addDeviceModelTip","设备型号错误"),n=!1),s=$("#addScript").val(),isStrEmptyOrUndefined(s)&&(showTip("addScriptTip","流程脚本版本错误"),n=!1),h=$("#addFirmware").val(),isStrEmptyOrUndefined(h)&&(showTip("addFirmwareTip","固件版本错误"),n=!1),c=$("#addApplication").val(),isStrEmptyOrUndefined(c)&&(showTip("addApplicationTip","应用层版本错误"),n=!1),l=$("#addHardware").val(),isStrEmptyOrUndefined(l)&&(showTip("addHardwareTip","硬件版本错误"),n=!1),a=$("#addSite").val(),isStrEmptyOrUndefined(a)&&(showTip("addSiteTip","场地错误"),n=!1),p=$("#addAdministrator").val(),w=$("#addRemark").val(),n){let b={Code:i,DeviceName:r,MacAddress:t,Ip:u,Port:f,Identifier:v,ClassId:e,DeviceModelId:o,ScriptId:s,FirmwareId:h,ApplicationId:c,HardwareId:l,SiteId:a,Administrator:p,Remark:w,Icon:""};k=function(){var n=function(n){var t=$("#addImg").val();isStrEmptyOrUndefined(t)?n("success"):($("#addImg").fileinput("upload"),fileCallBack[fileEnum.Device]=t=>{t.errno==0&&(b.Icon=t.data,n("success"))})};new Promise(function(t){n(t)}).then(function(){const n={};n.opType=103;n.opData=JSON.stringify(b);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&($("#addModel").modal("hide"),getDeviceList())})})};showConfirm("添加机台号："+i,k)}}function initUpdateSelect(n,t,i){$("#updateDeviceCategory").append(setOptions(categories,"CategoryName")).val(n).trigger("change");for(var u,r=0;r<models.length;r++)u=models[r],u.DeviceCategoryId==n&&$("#updateDeviceModel").append(option.format(u.Id,u.ModelName));for($("#updateDeviceModel").val(t).trigger("change"),r=0;r<scripts.length;r++)u=scripts[r],u.DeviceModelId.indexOf(t)!=-1&&$("#updateScript").append(option.format(u.Id,u.ScriptName));$("#updateScript").val(i).trigger("change")}function showUpdateModel(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b){t=unescape(t);i=unescape(i);r=unescape(r);u=unescape(u);f=unescape(f);e=unescape(e);o=unescape(o);s=unescape(s);h=unescape(h);c=unescape(c);a=unescape(a);v=unescape(v);y=unescape(y);p=unescape(p);w=unescape(w);b=unescape(b);_updateUpload==null&&(_updateUpload=initFileInput("updateImg",fileEnum.Device));$("#updateImg").fileinput("clear");$("#updateImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");var k=new Promise(n=>{var t,i;if($("#oldUpdateImg").addClass("hidden"),!isStrEmptyOrUndefined(b)){$(".file-caption-name").val(b);$(".file-caption-name").prop("disabled",!0);$("#oldUpdateFilePath").val(b);t={type:fileEnum.Device,files:JSON.stringify([b])};t.dir="";for(i in fileEnum)if(fileEnum[i]==t.type){t.dir=i;break}if(isStrEmptyOrUndefined(t.dir))return void layer.msg("文件类型不存在！");getFilePath(t,n=>{const t=n.length;if(!(t<=0))$("#oldUpdateImg").removeClass("hidden").attr("src",n[0].path).off("click").on("click",function(){showBigImg(n[0].path)})})}n("success")}),d=new Promise(b=>{var k={};k.opType=107;ajaxPost("/Relay/Post",k,function(b){if(b.errno!=0){layer.msg(b.errmsg);return}$("#updateModel .ads").empty();$("#updateDeviceClass").append(setOptions(b.classes,"Class")).val(w).trigger("change");$("#updateFirmware").append(setOptions(b.firmwareLibraries,"FirmwareName")).val(h).trigger("change");$("#updateApplication").append(setOptions(b.applicationLibraries,"ApplicationName")).val(c).trigger("change");$("#updateHardware").append(setOptions(b.hardwareLibraries,"HardwareName")).val(l).trigger("change");for(var d,g="",k=0;k<b.sites.length;k++)d=b.sites[k],g+=option.format(d.Id,d.SiteName+d.RegionDescription);for($("#updateSite").append(g),g="",k=0;k<b.maintainers.length;k++)d=b.maintainers[k],g+=option.format(d.Account,d.Name);$("#updateAdministrator").append(g);g="";categories=b.deviceCategories;models=b.deviceModels;scripts=b.scriptVersions;initUpdateSelect(p,o,s);hideClassTip("adt");$("#updateId").html(n);$("#updateDeviceName").val(t);$("#updateCode").val(i);$("#updateMacAddress").val(r);$("#updateIp").val(u);$("#updatePort").val(f);$("#updateIdentifier").val(e);$("#updateDeviceModel").val(o);$("#updateScript").val(s);$("#updateSite").val(a);$("#updateAdministrator").val(v);$("#updateRemark").val(y)});b("success")});Promise.all([k,d]).then(()=>{$("#updateModel").modal("show")})}function updateDevice(){var d=parseInt($("#updateId").html()),n=!0,v=$("#updateCode").val().trim(),r,t,u,f,y,e,p,o,s,h,c,l,a,i,k;isStrEmptyOrUndefined(v)&&(showTip("updateCodeTip","机台号不能为空"),n=!1);r=$("#updateDeviceName").val().trim();isStrEmptyOrUndefined(r)&&(showTip("updateDeviceNameTip","设备名不能为空"),n=!1);t=$("#updateMacAddress").val().trim();isMac(t)||isStrEmptyOrUndefined(t)||(showTip("updateMacAddressTip","MAC地址格式不正确，请以xx:xx:xx:xx:xx:xx或xx-xx-xx-xx-xx-xx的形式输入，x为数字或字母（A-F大小写均可）"),n=!1);u=$("#updateIp").val().trim().replace("_","");isIp(u)||(showTip("updateIpTip","IP非法"),n=!1);f=$("#updatePort").val().trim();isPort(f)||(showTip("updatePortTip","端口非法"),n=!1);y=$("#updateIdentifier").val();e=$("#updateDeviceClass").val();isStrEmptyOrUndefined(e)&&(showTip("updateDeviceClassTip","设备分类错误"),n=!1);p=$("#updateDeviceCategory").val();isStrEmptyOrUndefined(p)&&(showTip("updateDeviceCategoryTip","设备类型错误"),n=!1);o=$("#updateDeviceModel").val();isStrEmptyOrUndefined(o)&&(showTip("updateDeviceModelTip","设备型号错误"),n=!1);s=$("#updateScript").val();isStrEmptyOrUndefined(s)&&(showTip("updateScriptTip","流程脚本版本错误"),n=!1);h=$("#updateFirmware").val();isStrEmptyOrUndefined(h)&&(showTip("updateFirmwareTip","固件版本错误"),n=!1);c=$("#updateApplication").val();isStrEmptyOrUndefined(c)&&(showTip("updateApplicationTip","应用层版本错误"),n=!1);l=$("#updateHardware").val();isStrEmptyOrUndefined(l)&&(showTip("updateHardwareTip","硬件版本错误"),n=!1);a=$("#updateSite").val();isStrEmptyOrUndefined(a)&&(showTip("updateSiteTip","场地错误"),n=!1);var g=$("#updateAdministrator").val(),nt=$("#updateRemark").val(),tt=$("#updateImg").val().trim(),w=$("#oldUpdateFilePath").val().trim(),b=!1;(tt!=w&&(b=!0),n)&&(i={id:d,Code:v,DeviceName:r,MacAddress:t,Ip:u,Port:f,Identifier:y,ClassId:e,DeviceModelId:o,ScriptId:s,FirmwareId:h,ApplicationId:c,HardwareId:l,SiteId:a,Administrator:g,Remark:nt},k=function(){var n=function(n){var t=$("#updateImg").val();b&&!isStrEmptyOrUndefined(t)?($("#updateImg").fileinput("upload"),fileCallBack[fileEnum.Device]=t=>{t.errno==0&&(i.Icon=t.data,n("success"))}):(i.Icon=w,n("success"))};new Promise(function(t){n(t)}).then(function(){const n={};n.opType=102;n.opData=JSON.stringify(i);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&($("#updateModel").modal("hide"),getDeviceList())})})},showConfirm("修改",k))}function showDetail(n){window.location="/DeviceManagement/Detail?id="+n}function showControl(n,t){t=unescape(t);t=="待加工"||t=="加工中"?window.location="/DeviceManagement/Control?id="+n:layer.msg("该设备"+t)}function getUpgrade(n,t,i,r,u){var f={};f.opType=t;u&&(f.opData=JSON.stringify({deviceModelId:u}));ajaxPost("/Relay/Post",f,function(t){var u,s,f;if(t.errno!=0){layer.msg(t.errmsg);return}var e=t.datas,o="";for(u=0,s=e.length;u<s;u++)f=e[u],o+='<option value="{0}" path="{1}">{2}<\/option>'.format(f.Id,f[i],f[r]);n(o)},0)}function showUpgrade(n){var t=_deviceData[n];$("#upgradeModel .upgrade-btn").val(n);$("#upgradeCode").val(t.Code);$("#upgradeDeviceName").val(t.DeviceName);$("#upgradeDeviceState").val(t.DeviceStateStr);$("#upgradeMacAddress").val(t.MacAddress);$("#upgradeIp").val(t.Ip);$("#upgradePort").val(t.Port);$("#upgradeIdentifier").val(t.Identifier);$("#upgradeDeviceCategory").val(t.CategoryName);$("#upgradeDeviceModel").val(t.ModelName);var i=new Promise(n=>getUpgrade(n,113,"ScriptFile","ScriptName",t.DeviceModelId)),r=new Promise(n=>getUpgrade(n,130,"FilePath","FirmwareName")),u=new Promise(n=>getUpgrade(n,135,"FilePath","HardwareName")),f=new Promise(n=>getUpgrade(n,145,"FilePath","ApplicationName"));$("#upgradeScript,#upgradeFirmware,#upgradeHardware,#upgradeApplication").empty();Promise.all([i,r,u,f]).then(n=>{$("#upgradeScript").append(n[0]).val(t.ScriptId).trigger("change"),$("#upgradeFirmware").append(n[1]).val(t.FirmwareId).trigger("change"),$("#upgradeHardware").append(n[2]).val(t.HardwareId).trigger("change"),$("#upgradeApplication").append(n[3]).val(t.ApplicationId).trigger("change")});$("#upgradeSite").val(t.SiteName);$("#upgradeAdministrator").val(t.AdministratorName);$("#upgradeRemark").val(t.Remark);$("#upgradeModel").modal("show")}function deviceUpgrade(n=0){var f=$(this).val(),e;if(_deviceData[f].DeviceStateStr!="待加工"){layer.msg("非待加工设备不能升级");return}var t=null,r="",u=null,i="";switch(n){case 1:t=$("#upgradeScript").val();r=fileEnum.Script;u=$("#upgradeScript :selected").attr("path");i="流程脚本版本";break;case 2:t=$("#upgradeFirmware").val();r=fileEnum.FirmwareLibrary;u=$("#upgradeFirmware :selected").attr("path");i="固件版本";break;case 3:t=$("#upgradeHardware").val();r=fileEnum.Hardware;u=$("#upgradeHardware :selected").attr("path");i="硬件版本";break;case 4:t=$("#upgradeApplication").val();r=fileEnum.ApplicationLibrary;u=$("#upgradeApplication :selected").attr("path");i="应用层版本"}if(isStrEmptyOrUndefined(t)){layer.msg(`请选择：<span style="font-weight:bold">${i}</span>`);return}e=()=>{var i={type:fileEnum[r],files:JSON.stringify([u])},e;i.dir="";for(e in fileEnum)if(fileEnum[e]==i.type){i.dir=e;break}if(isStrEmptyOrUndefined(i.dir))return void layer.msg("文件类型不存在！");getFilePath(i,r=>{const e=r.length;if(!(e<=0)){i={};i.opType=108;i.opData=JSON.stringify({Type:n,Infos:[{Type:1,FileId:t,FileUrl:`${location.origin}${r[0].path}`,DeviceId:f}]});var u=addFakeProgress();ajaxPost("/Relay/Post",i,n=>{u();u=null;var t=n.datas[0];layer.msg(t.errmsg);t.errno==0&&($("#upgradeModel").modal("hide"),getDeviceList())})}},0)};showConfirm(`升级${i}`,e)}function showBatchUpgradeModel(){new Promise(n=>getDeviceList(n,!0)).then(()=>$("#addScriptListBtn,#addFirmwareListBtn").removeAttr("disabled"));_batchCodeData=[[],[],[],[]];$("#scriptList,#firmwareList").empty();$("#batchUpgradeModel").modal("show")}function addBatchUpgradeTr(n,t){var u="",i,r,f;for(i in _deviceData)r=_deviceData[i],r.DeviceStateStr=="待加工"&&(u+='<option value="{0}" {2}>{1}<\/option>'.format(i,r.Code,_batchCodeData[n].indexOf(i)==-1?"":"disabled"));f=`<tr>
                <td class="num"></td>
                <td style="width:100px"><select class="ms2 form-control code">${u}</select></td>
                <td class="devState"></td>
                ${n==0?'<td class="devModel"><\/td>':""}
                <td style="min-width:120px"><select class="ms2 form-control ${t}"></select></td>
                <td class="result"></td>
                <td><button type="button" class="btn btn-danger btn-sm delTr" onclick="delBatchUpgradeTr.call(this,${n},'${t}')"><i class="fa fa-minus"></i></button></td>
              </tr>`;$(`#${t}List`).append(f).find(".ms2").select2();batchUpgradeSort(t);$(`#${t}List .code:last`).trigger("select2:select");_deviceData.state==_batchCodeData[n].length-(_deviceData.batchState||0)&&$(`#add${t[0].toUpperCase()+t.slice(1)}ListBtn`).attr("disabled",!0);$(`#${t}_nav_table`).scrollTop($(`#${t}_nav_table`)[0].scrollHeight)}function batchUpgradeSort(n){for(var i=$(`#${n}List tr`),t=0,r=i.length;t<r;t++)i.eq(t).find(".num").text(t+1)}function delBatchUpgradeTr(n,t){var r=$(this).parents("tr"),u=!0,i;r.find(".devState").text()!="待加工"&&(_deviceData.batchState--,u=!1);r.remove();batchUpgradeSort(t);i=$(this).val();_batchCodeData[n].splice(_batchCodeData[n].indexOf(i),1);u&&($(`#${t}List .code option[value=${i}]`).prop("disabled",!1),$(`#add${t[0].toUpperCase()+t.slice(1)}ListBtn`).attr("disabled",!1),$(`#${t}List .code`).select2())}function batchRefresh(n,t){var i={};i.opType=100;i.opData=JSON.stringify({hard:!0,ids:_batchCodeData[n].join(",")});ajaxPost("/Relay/Post",i,n=>{var c=n.datas,r,e,u,o,s,l,a,h,f;for(i={},r=0,e=c.length;r<e;r++)u=c[r],i[u.Id]=u,o=u.DeviceStateStr,o!=_deviceData[u.Id].DeviceStateStr&&(o=="待加工"?_deviceData.state++:_deviceData.state--),_deviceData[u.Id]=u;for(_deviceData.batchState=0,s=$(`#${t}List .delTr`),l=$(`#${t}List .devState`),r=0,e=s.length;r<e;r++){a=s.eq(r).val();h=_deviceData[a].DeviceStateStr;switch(h){case"待加工":f="success";break;case"加工中":f="success";_deviceData.batchState++;break;case"已确认":f="warning";_deviceData.batchState++;break;case"维修中":f="info";_deviceData.batchState++;break;default:f="red";_deviceData.batchState++}l.eq(r).html(`<span class="text-${f}">${h}</span>`)}},0)}function batchUpgrade(n,t){var s=$(`#${t}List tr`),r={codeId:[],fileId:[],filePath:[]},i=0,e=s.length,o,h,u,f,a;if(!e){layer.msg("请先添加设备");return}for(;i<e;i++){if(o=s.eq(i),h=o.find(".delTr").val(),o.find(".devState span").text()!="待加工"){layer.msg(`序列${i+1}：非待加工设备不能升级`);return}var c=o.find(`.${t}`),v=c.val(),l=c.find(":selected").attr("path");if(isStrEmptyOrUndefined(l)){layer.msg(`序列${i+1}：请选择流程脚本版本`);return}r.codeId.push(h);r.fileId.push(v);r.filePath.push(l)}clearInterval($(`#${t}List`)[0].time);$(`#${t}List .result`).text("");u=null;f="";switch(n){case 0:u=fileEnum.Script;f="流程脚本版本";break;case 1:u=fileEnum.FirmwareLibrary;f="固件版本";break;case 2:u=fileEnum.Hardware;f="硬件版本";break;case 3:u=fileEnum.ApplicationLibrary;f="应用层版本"}a=()=>{var f={type:u,files:JSON.stringify(r.filePath)},o;f.dir="";for(o in fileEnum)if(fileEnum[o]==f.type){f.dir=o;break}if(isStrEmptyOrUndefined(f.dir))return void layer.msg("文件类型不存在！");getFilePath(f,u=>{var o,h,c,s;const l=u.length;if(!(l<=0)){for(o=[],h=location.origin,i=0;i<e;i++)c=`${h}${u[i].path}`,o.push({Type:1,FileId:r.fileId[i],FileUrl:c,DeviceId:r.codeId[i]});f={};f.opType=108;f.opData=JSON.stringify({Type:n+1,Infos:o});s=addFakeProgress();ajaxPost("/Relay/Post",f,r=>{var u,o,f,h;for(s(),s=null,u=r.datas,e=u.length,o=$(`#${t}List .result`),i=0;i<e;i++)f=u[i],h=f.errno==0?"success":"red",o.eq(i).html(`<span class="text-${h}">升级${f.errmsg}</span>`);batchRefresh(n,t);$(`#${t}List`)[0].time=setInterval(()=>{batchRefresh(n,t)},5e3)})}},0)};showConfirm(`升级${f}`,a)}function deleteDevice(n,t){t=unescape(t);var i=function(){var t={};t.opType=104;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceList()})};showConfirm("删除机台号："+t,i)}var _permissionList=[],_deviceData=null,categories,models,scripts,option='<option value="{0}">{1}<\/option>',_addUpload=null,_updateUpload=null,_batchCodeData=null;