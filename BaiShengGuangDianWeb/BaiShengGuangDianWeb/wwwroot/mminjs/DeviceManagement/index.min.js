function pageReady(){_permissionList[161]={uIds:["showAddModel"]};_permissionList[162]={uIds:[]};_permissionList[163]={uIds:[]};_permissionList[164]={uIds:["showBatchUpgradeModelBtn"]};_permissionList[148]={uIds:[]};_permissionList[147]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);getDeviceList();$(".ads").css("width","100%").select2();$(".col-sm-2").addClass("mcolsm2");$("#addIp").inputmask("ip");$("#updateIp").inputmask("ip");$("#addDeviceCategory").on("select2:select",function(){var r,i,n,t;for(hideTip("addDeviceModelTip"),hideTip("addScriptTip"),r=parseInt($("#addDeviceCategory option:checked").val()),$("#addDeviceModel").empty(),i=0,t=0;t<models.length;t++)n=models[t],n.DeviceCategoryId==r&&(i=i==0?n.Id:i,$("#addDeviceModel").append(option.format(n.Id,n.ModelName)));for($("#addScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#addScript").append(option.format(n.Id,n.ScriptName))});$("#addDeviceModel").on("select2:select",function(){var i,t,n;for(hideTip("addScriptTip"),i=parseInt($("#addDeviceModel option:checked").val()),$("#addScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#addScript").append(option.format(n.Id,n.ScriptName))});$("#updateDeviceCategory").on("select2:select",function(){var r,i,n,t;for(hideTip("updateDeviceModelTip"),hideTip("updateScriptTip"),r=parseInt($("#updateDeviceCategory option:checked").val()),$("#updateDeviceModel").empty(),i=0,t=0;t<models.length;t++)n=models[t],n.DeviceCategoryId==r&&(i=i==0?n.Id:i,$("#updateDeviceModel").append(option.format(n.Id,n.ModelName)));for($("#updateScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#updateScript").append(option.format(n.Id,n.ScriptName))});$("#updateDeviceModel").on("select2:select",function(){var i=parseInt($("#updateDeviceModel option:checked").val()),t,n;for($("#updateScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&(hideTip("updateScriptTip"),$("#updateScript").append(option.format(n.Id,n.ScriptName)))});$("#scriptList,#firmwareList").on("select2:select",".code",function(n){var s=n.delegateTarget.id,c=$("#batchType li[class~=active]").prevAll().length,u=_batchCodeData[c],f=$(this).val(),e,o,l,t,i,h,r;for(u.push(f),e=$(this).data("last"),$(this).data("last",f),isStrEmptyOrUndefined(e)||(u.splice(u.indexOf(e),1),$(`#${s} .code option[value=${e}]`).prop("disabled",!1)),o=0,l=u.length;o<l;o++)$(`#${s} .code option[value=${u[o]}]`).prop("disabled",!0);$(`#${s} .code`).select2();t=$(this).parents("tr");t.find(".delTr").val(f);i=_deviceData[f];h=i.DeviceStateStr;switch(h){case"待加工":r="success";break;case"加工中":r="success";break;case"已确认":r="warning";break;case"维修中":r="info";break;default:r="red"}t.find(".devState").html(`<span class="text-${r}">${h}</span>`);switch(c){case 0:t.find(".devModel").text(`${i.CategoryName}-${i.ModelName}`);new Promise(n=>getUpgrade(n,113,"ScriptFile","ScriptName",i.DeviceModelId)).then(n=>{t.find(".script").empty().append(n).val(i.ScriptId).trigger("change")});break;case 1:new Promise(n=>getUpgrade(n,130,"FilePath","FirmwareName")).then(n=>{t.find(".firmware").empty().append(n).val(i.FirmwareId).trigger("change")})}t.find(".result").empty()});$("#batchUpgradeModel").on("hidden.bs.modal",()=>{clearInterval($("#scriptList")[0].time),clearInterval($("#firmwareList")[0].time),getDeviceList()});$("#script_nav_table,#firmware_nav_table").css("maxHeight",innerHeight*.7)}function getDeviceList(n,t){var i={};i.opType=100;i.opData=JSON.stringify({hard:!0});ajaxPost("/Relay/Post",i,function(i){var r,u,e,f;if(i.errno!=0){layer.msg(i.errmsg);return}for(r=i.datas,_deviceData={state:0},u=0,e=r.length;u<e;u++)f=r[u],_deviceData[f.Id]=f,f.DeviceStateStr=="待加工"&&_deviceData.state++;if(!isStrEmptyOrUndefined(n)&&t){n("success");return}var o=_permissionList[148].have,s=_permissionList[147].have,h=_permissionList[162].have,c=_permissionList[164].have,l=_permissionList[163].have,a=function(n){var t="<li><a onclick=\"showControl({0},'{1}')\">控制<\/a><\/li>".format(n.Id,escape(n.DeviceStateStr)),i='<li><a onclick="showDetail({0})">详情<\/a><\/li>'.format(n.Id),r="<li><a onclick=\"showUpdateModel({0}, '{1}', '{2}', '{3}', '{4}', '{5}', '{6}', {7}, {8}, {9}, {10}, {11}, {12}, '{13}', '{14}', {15})\">修改<\/a><\/li>".format(n.Id,escape(n.DeviceName),escape(n.Code),escape(n.MacAddress),escape(n.Ip),escape(n.Port),escape(n.Identifier),escape(n.DeviceModelId),escape(n.ScriptId),escape(n.FirmwareId),escape(n.ApplicationId),escape(n.HardwareId),escape(n.SiteId),escape(n.Administrator),escape(n.Remark),escape(n.DeviceCategoryId)),u='<li><a onclick="showUpgrade({0})">升级<\/a><\/li>'.format(n.Id),f="<li><a onclick=\"deleteDevice({0}, '{1}')\">删除<\/a><\/li>".format(n.Id,escape(n.Code));return'<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button ><button type = "button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">   <span class="caret"><\/span>   <span class="sr-only">Toggle Dropdown<\/span><\/button><ul class="dropdown-menu pointer" role="menu">{0}{1}{2}{3}{4}<\/ul><\/div>'.format(o?t:"",s?i:"",h?r:"",c?u:"",l?f:"")},v=function(n){return`${n.Ip}:${n.Port}`},y=function(n){var t=n.StateStr;return t=="连接正常"?'<span class="text-success">'+t+"<\/span>":'<span class="text-danger">'+t+"<\/span>"},p=function(n){var t=n.DeviceStateStr;return t=="待加工"?'<span class="text-success">'+t+"<\/span>":t=="加工中"?'<span class="text-success">'+t+"<\/span>":t=="已确认"?'<span class="text-warning">'+t+"<\/span>":t=="维修中"?'<span class="text-info">'+t+"<\/span>":'<span class="text-red">'+t+"<\/span>"},w=function(n){return n.CategoryName+"-"+n.ModelName},b=function(n,t,i,r){return++r.row},k=function(n){var t=n.SiteName+n.RegionDescription;return(""+t).length>tdShowContentLength?t.substr(0,tdShowContentLength)+' <a href = "javascript:showPlaceNameModel({0})">...<\/a> '.format(n.Id):t};$("#deviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:r,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:b},{data:"Code",title:"机台号",type:"html-percent"},{data:null,title:"设备型号",render:w},{data:null,title:"摆放位置",render:k},{data:null,title:"IP地址",render:v},{data:"AdministratorName",title:"管理员"},{data:null,title:"运行状态",render:y},{data:null,title:"设备状态",render:p},{data:null,title:"操作",render:a,orderable:!1,visible:o||s||h||c||l}]})})}function showPlaceNameModel(n){var t={};t.opType=100;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&($("#siteName").html(n.datas[0].SiteName),$("#regionDescription").html(n.datas[0].RegionDescription));$("#placeNameModel").modal("show")})}function initAddSelect(){for(var t,r,i,n=0;n<categories.length;n++)t=categories[n],$("#addDeviceCategory").append(option.format(t.Id,t.CategoryName));for(r=categories[0].Id,i=0,n=0;n<models.length;n++)t=models[n],t.DeviceCategoryId==r&&(i==0&&(i=t.Id),$("#addDeviceModel").append(option.format(t.Id,t.ModelName)));if(i!=0)for(n=0;n<scripts.length;n++)t=scripts[n],t.DeviceModelId.indexOf(i)!=-1&&$("#addScript").append(option.format(t.Id,t.ScriptName))}function showAddModel(){var n={};n.opType=107;ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}$("#addModel .ads").empty();$("#addCode").val("");$("#addDeviceName").val("");$("#addMacAddress").val("");$("#addIp").val("");$("#addPort").val("60000");$("#addIdentifier").val("");$("#addAdministrator").val("");$("#addRemark").val("");for(var t,r="",i=0;i<n.firmwareLibraries.length;i++)t=n.firmwareLibraries[i],r+=option.format(t.Id,t.FirmwareName),$("#addFirmware").append(option.format(t.Id,t.FirmwareName));for($("#addFirmware").append(r),r="",i=0;i<n.applicationLibraries.length;i++)t=n.applicationLibraries[i],r+=option.format(t.Id,t.ApplicationName),$("#addApplication").append(option.format(t.Id,t.ApplicationName));for($("#addApplication").append(r),r="",i=0;i<n.hardwareLibraries.length;i++)t=n.hardwareLibraries[i],r+=option.format(t.Id,t.HardwareName),$("#addHardware").append(option.format(t.Id,t.HardwareName));for($("#addHardware").append(r),r="",i=0;i<n.sites.length;i++)t=n.sites[i],r+=option.format(t.Id,t.SiteName+t.RegionDescription),$("#addSite").append(option.format(t.Id,t.SiteName+t.RegionDescription));for($("#addSite").append(r),r="",i=0;i<n.maintainers.length;i++)t=n.maintainers[i],r+=option.format(t.Account,t.Name);$("#addAdministrator").append(r);categories=n.deviceCategories;models=n.deviceModels;scripts=n.scriptVersions;initAddSelect();hideClassTip("adt");$("#addModel").modal("show")})}function addDevice(){var n=!0,i=$("#addCode").val().trim(),r,t,u,f,a,v,e,o,s,h,c,l,y,p,w;(isStrEmptyOrUndefined(i)&&(showTip("addCodeTip","机台号不能为空"),n=!1),r=$("#addDeviceName").val().trim(),isStrEmptyOrUndefined(r)&&(showTip("addDeviceNameTip","设备名不能为空"),n=!1),t=$("#addMacAddress").val().trim(),isMac(t)||isStrEmptyOrUndefined(t)||(showTip("addMacAddressTip","MAC地址格式不正确，请以xx:xx:xx:xx:xx:xx或xx-xx-xx-xx-xx-xx的形式输入，x为数字或字母（A-F大小写均可）"),n=!1),u=$("#addIp").val().trim().replace("_",""),isIp(u)||(showTip("addIpTip","IP非法"),n=!1),f=$("#addPort").val().trim(),isPort(f)||(showTip("addPortTip","端口非法"),n=!1),a=$("#addIdentifier").val(),v=$("#addDeviceCategory").val(),isStrEmptyOrUndefined(v)&&(showTip("addDeviceCategoryTip","设备类型错误"),n=!1),e=$("#addDeviceModel").val(),isStrEmptyOrUndefined(e)&&(showTip("addDeviceModelTip","设备型号错误"),n=!1),o=$("#addScript").val(),isStrEmptyOrUndefined(o)&&(showTip("addScriptTip","流程脚本版本错误"),n=!1),s=$("#addFirmware").val(),isStrEmptyOrUndefined(s)&&(showTip("addFirmwareTip","固件版本错误"),n=!1),h=$("#addApplication").val(),isStrEmptyOrUndefined(h)&&(showTip("addApplicationTip","应用层版本错误"),n=!1),c=$("#addHardware").val(),isStrEmptyOrUndefined(c)&&(showTip("addHardwareTip","硬件版本错误"),n=!1),l=$("#addSite").val(),isStrEmptyOrUndefined(l)&&(showTip("addSiteTip","场地错误"),n=!1),y=$("#addAdministrator").val(),p=$("#addRemark").val(),n)&&(w=function(){$("#addModel").modal("hide");var n={};n.opType=103;n.opData=JSON.stringify({Code:i,DeviceName:r,MacAddress:t,Ip:u,Port:f,Identifier:a,DeviceModelId:e,ScriptId:o,FirmwareId:s,ApplicationId:h,HardwareId:c,SiteId:l,Administrator:y,Remark:p});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceList()})},showConfirm("添加机台号："+i,w))}function initUpdateSelect(n,t,i){for(var u,r=0;r<categories.length;r++)u=categories[r],$("#updateDeviceCategory").append(option.format(u.Id,u.CategoryName));for($("#updateDeviceCategory").val(n),r=0;r<models.length;r++)u=models[r],u.DeviceCategoryId==n&&$("#updateDeviceModel").append(option.format(u.Id,u.ModelName));for($("#updateDeviceModel").val(t),r=0;r<scripts.length;r++)u=scripts[r],u.DeviceModelId.indexOf(t)!=-1&&$("#updateScript").append(option.format(u.Id,u.ScriptName));$("#updateScript").val(i)}function showUpdateModel(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){t=unescape(t);i=unescape(i);r=unescape(r);u=unescape(u);f=unescape(f);e=unescape(e);o=unescape(o);s=unescape(s);h=unescape(h);c=unescape(c);a=unescape(a);v=unescape(v);y=unescape(y);p=unescape(p);var w={};w.opType=107;ajaxPost("/Relay/Post",w,function(w){if(w.errno!=0){layer.msg(w.errmsg);return}$("#updateModel .ads").empty();for(var k,d="",b=0;b<w.firmwareLibraries.length;b++)k=w.firmwareLibraries[b],d+=option.format(k.Id,k.FirmwareName);for($("#updateFirmware").append(d),d="",b=0;b<w.applicationLibraries.length;b++)k=w.applicationLibraries[b],d+=option.format(k.Id,k.ApplicationName);for($("#updateApplication").append(d),d="",b=0;b<w.hardwareLibraries.length;b++)k=w.hardwareLibraries[b],d+=option.format(k.Id,k.HardwareName);for($("#updateHardware").append(d),d="",b=0;b<w.sites.length;b++)k=w.sites[b],d+=option.format(k.Id,k.SiteName+k.RegionDescription);for($("#updateSite").append(d),d="",b=0;b<w.maintainers.length;b++)k=w.maintainers[b],d+=option.format(k.Account,k.Name);$("#updateAdministrator").append(d);d="";categories=w.deviceCategories;models=w.deviceModels;scripts=w.scriptVersions;initUpdateSelect(p,o,s);hideClassTip("adt");$("#updateId").html(n);$("#updateDeviceName").val(t);$("#updateCode").val(i);$("#updateMacAddress").val(r);$("#updateIp").val(u);$("#updatePort").val(f);$("#updateIdentifier").val(e);$("#updateDeviceModel").val(o);$("#updateScript").val(s);$("#updateFirmware").val(h);$("#updateHardware").val(l);$("#updateApplication").val(c);$("#updateSite").val(a);$("#updateAdministrator").val(v);$("#updateRemark").val(y);$("#updateModel").modal("show")})}function updateDevice(){var b=parseInt($("#updateId").html()),n=!0,l=$("#updateCode").val().trim(),i,t,r,u,a,v,f,e,o,s,h,c,y,p,w;(isStrEmptyOrUndefined(l)&&(showTip("updateCodeTip","机台号不能为空"),n=!1),i=$("#updateDeviceName").val().trim(),isStrEmptyOrUndefined(i)&&(showTip("updateDeviceNameTip","设备名不能为空"),n=!1),t=$("#updateMacAddress").val().trim(),isMac(t)||isStrEmptyOrUndefined(t)||(showTip("updateMacAddressTip","MAC地址格式不正确，请以xx:xx:xx:xx:xx:xx或xx-xx-xx-xx-xx-xx的形式输入，x为数字或字母（A-F大小写均可）"),n=!1),r=$("#updateIp").val().trim().replace("_",""),isIp(r)||(showTip("updateIpTip","IP非法"),n=!1),u=$("#updatePort").val().trim(),isPort(u)||(showTip("updatePortTip","端口非法"),n=!1),a=$("#updateIdentifier").val(),v=$("#updateDeviceCategory").val(),isStrEmptyOrUndefined(v)&&(showTip("updateDeviceCategoryTip","设备类型错误"),n=!1),f=$("#updateDeviceModel").val(),isStrEmptyOrUndefined(f)&&(showTip("updateDeviceModelTip","设备型号错误"),n=!1),e=$("#updateScript").val(),isStrEmptyOrUndefined(e)&&(showTip("updateScriptTip","流程脚本版本错误"),n=!1),o=$("#updateFirmware").val(),isStrEmptyOrUndefined(o)&&(showTip("updateFirmwareTip","固件版本错误"),n=!1),s=$("#updateApplication").val(),isStrEmptyOrUndefined(s)&&(showTip("updateApplicationTip","应用层版本错误"),n=!1),h=$("#updateHardware").val(),isStrEmptyOrUndefined(h)&&(showTip("updateHardwareTip","硬件版本错误"),n=!1),c=$("#updateSite").val(),isStrEmptyOrUndefined(c)&&(showTip("updateSiteTip","场地错误"),n=!1),y=$("#updateAdministrator").val(),p=$("#updateRemark").val(),n)&&(w=function(){$("#updateModel").modal("hide");var n={};n.opType=102;n.opData=JSON.stringify({id:b,Code:l,DeviceName:i,MacAddress:t,Ip:r,Port:u,Identifier:a,DeviceModelId:f,ScriptId:e,FirmwareId:o,ApplicationId:s,HardwareId:h,SiteId:c,Administrator:y,Remark:p});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceList()})},showConfirm("修改",w))}function showDetail(n){window.location="/DeviceManagement/Detail?id="+n}function showControl(n,t){t=unescape(t);t=="待加工"||t=="加工中"?window.location="/DeviceManagement/Control?id="+n:layer.msg("该设备"+t)}function getUpgrade(n,t,i,r,u){var f={};f.opType=t;u&&(f.opData=JSON.stringify({deviceModelId:u}));ajaxPost("/Relay/Post",f,function(t){var u,s,f;if(t.errno!=0){layer.msg(t.errmsg);return}var e=t.datas,o="";for(u=0,s=e.length;u<s;u++)f=e[u],o+='<option value="{0}" path="{1}">{2}<\/option>'.format(f.Id,f[i],f[r]);n(o)},0)}function showUpgrade(n){var t=_deviceData[n];$("#upgradeModel .upgrade-btn").val(n);$("#upgradeCode").val(t.Code);$("#upgradeDeviceName").val(t.DeviceName);$("#upgradeDeviceState").val(t.DeviceStateStr);$("#upgradeMacAddress").val(t.MacAddress);$("#upgradeIp").val(t.Ip);$("#upgradePort").val(t.Port);$("#upgradeIdentifier").val(t.Identifier);$("#upgradeDeviceCategory").val(t.CategoryName);$("#upgradeDeviceModel").val(t.ModelName);var i=new Promise(n=>getUpgrade(n,113,"ScriptFile","ScriptName",t.DeviceModelId)),r=new Promise(n=>getUpgrade(n,130,"FilePath","FirmwareName")),u=new Promise(n=>getUpgrade(n,135,"FilePath","HardwareName")),f=new Promise(n=>getUpgrade(n,145,"FilePath","ApplicationName"));$("#upgradeScript,#upgradeFirmware,#upgradeHardware,#upgradeApplication").empty();Promise.all([i,r,u,f]).then(n=>{$("#upgradeScript").append(n[0]).val(t.ScriptId).trigger("change"),$("#upgradeFirmware").append(n[1]).val(t.FirmwareId).trigger("change"),$("#upgradeHardware").append(n[2]).val(t.HardwareId).trigger("change"),$("#upgradeApplication").append(n[3]).val(t.ApplicationId).trigger("change")});$("#upgradeSite").val(t.SiteName);$("#upgradeAdministrator").val(t.AdministratorName);$("#upgradeRemark").val(t.Remark);$("#upgradeModel").modal("show")}function deviceUpgrade(n=0){var f=$(this).val(),e;if(_deviceData[f].DeviceStateStr!="待加工"){layer.msg("非待加工设备不能升级");return}var t=null,r=null,u=null,i="";switch(n){case 1:t=$("#upgradeScript").val();r=fileEnum.Script;u=$("#upgradeScript :selected").attr("path");i="流程脚本版本";break;case 2:t=$("#upgradeFirmware").val();r=fileEnum.FirmwareLibrary;u=$("#upgradeFirmware :selected").attr("path");i="固件版本";break;case 3:t=$("#upgradeHardware").val();r=fileEnum.Hardware;u=$("#upgradeHardware :selected").attr("path");i="硬件版本";break;case 4:t=$("#upgradeApplication").val();r=fileEnum.ApplicationLibrary;u=$("#upgradeApplication :selected").attr("path");i="应用层版本"}if(isStrEmptyOrUndefined(t)){layer.msg(`请选择：<span style="font-weight:bold">${i}</span>`);return}e=()=>{var i={type:r,files:JSON.stringify([u])};ajaxPost("/Upload/Path",i,r=>{if(r.errno!=0){layer.msg(r.errmsg);return}i={};i.opType=108;i.opData=JSON.stringify({Type:n,Infos:[{Type:1,FileId:t,FileUrl:`${location.origin}${r.data[0].path}`,DeviceId:f}]});var u=addFakeProgress();ajaxPost("/Relay/Post",i,n=>{u();u=null;var t=n.datas[0];layer.msg(t.errmsg);t.errno==0&&($("#upgradeModel").modal("hide"),getDeviceList())})},0)};showConfirm(`升级${i}`,e)}function showBatchUpgradeModel(){new Promise(n=>getDeviceList(n,!0)).then(()=>$("#addScriptListBtn,#addFirmwareListBtn").removeAttr("disabled"));_batchCodeData=[[],[],[],[]];$("#scriptList,#firmwareList").empty();$("#batchUpgradeModel").modal("show")}function addBatchUpgradeTr(n,t){var u="",i,r,f;for(i in _deviceData)r=_deviceData[i],r.DeviceStateStr=="待加工"&&(u+='<option value="{0}" {2}>{1}<\/option>'.format(i,r.Code,_batchCodeData[n].indexOf(i)==-1?"":"disabled"));f=`<tr>
                <td class="num"></td>
                <td style="width:100px"><select class="ms2 form-control code">${u}</select></td>
                <td class="devState"></td>
                ${n==0?'<td class="devModel"><\/td>':""}
                <td style="min-width:120px"><select class="ms2 form-control ${t}"></select></td>
                <td class="result"></td>
                <td><button type="button" class="btn btn-danger btn-sm delTr" onclick="delBatchUpgradeTr.call(this,${n},'${t}')"><i class="fa fa-minus"></i></button></td>
              </tr>`;$(`#${t}List`).append(f).find(".ms2").select2();batchUpgradeSort(t);$(`#${t}List .code:last`).trigger("select2:select");_deviceData.state==_batchCodeData[n].length-(_deviceData.batchState||0)&&$(`#add${t[0].toUpperCase()+t.slice(1)}ListBtn`).attr("disabled",!0);$(`#${t}_nav_table`).scrollTop($(`#${t}_nav_table`)[0].scrollHeight)}function batchUpgradeSort(n){for(var i=$(`#${n}List tr`),t=0,r=i.length;t<r;t++)i.eq(t).find(".num").text(t+1)}function delBatchUpgradeTr(n,t){var r=$(this).parents("tr"),u=!0,i;r.find(".devState").text()!="待加工"&&(_deviceData.batchState--,u=!1);r.remove();batchUpgradeSort(t);i=$(this).val();_batchCodeData[n].splice(_batchCodeData[n].indexOf(i),1);u&&($(`#${t}List .code option[value=${i}]`).prop("disabled",!1),$(`#add${t[0].toUpperCase()+t.slice(1)}ListBtn`).attr("disabled",!1),$(`#${t}List .code`).select2())}function batchRefresh(n,t){var i={};i.opType=100;i.opData=JSON.stringify({hard:!0,ids:_batchCodeData[n].join(",")});ajaxPost("/Relay/Post",i,n=>{var c=n.datas,r,e,u,o,s,l,a,h,f;for(i={},r=0,e=c.length;r<e;r++)u=c[r],i[u.Id]=u,o=u.DeviceStateStr,o!=_deviceData[u.Id].DeviceStateStr&&(o=="待加工"?_deviceData.state++:_deviceData.state--),_deviceData[u.Id]=u;for(_deviceData.batchState=0,s=$(`#${t}List .delTr`),l=$(`#${t}List .devState`),r=0,e=s.length;r<e;r++){a=s.eq(r).val();h=_deviceData[a].DeviceStateStr;switch(h){case"待加工":f="success";break;case"加工中":f="success";_deviceData.batchState++;break;case"已确认":f="warning";_deviceData.batchState++;break;case"维修中":f="info";_deviceData.batchState++;break;default:f="red";_deviceData.batchState++}l.eq(r).html(`<span class="text-${f}">${h}</span>`)}},0)}function batchUpgrade(n,t){var s=$(`#${t}List tr`),r={codeId:[],fileId:[],filePath:[]},i=0,u=s.length,o,h,f,e,a;if(!u){layer.msg("请先添加设备");return}for(;i<u;i++){if(o=s.eq(i),h=o.find(".delTr").val(),o.find(".devState span").text()!="待加工"){layer.msg(`序列${i+1}：非待加工设备不能升级`);return}var c=o.find(`.${t}`),v=c.val(),l=c.find(":selected").attr("path");if(isStrEmptyOrUndefined(l)){layer.msg(`序列${i+1}：请选择流程脚本版本`);return}r.codeId.push(h);r.fileId.push(v);r.filePath.push(l)}clearInterval($(`#${t}List`)[0].time);$(`#${t}List .result`).text("");f=null;e="";switch(n){case 0:f=fileEnum.Script;e="流程脚本版本";break;case 1:f=fileEnum.FirmwareLibrary;e="固件版本";break;case 2:f=fileEnum.Hardware;e="硬件版本";break;case 3:f=fileEnum.ApplicationLibrary;e="应用层版本"}a=()=>{var e={type:f,files:JSON.stringify(r.filePath)};ajaxPost("/Upload/Path",e,f=>{var o,s,c,l,h;if(f.errno!=0){layer.msg(f.errmsg);return}for(o=f.data,u=o.length,s=[],c=location.origin,i=0;i<u;i++)l=`${c}${o[i].path}`,s.push({Type:1,FileId:r.fileId[i],FileUrl:l,DeviceId:r.codeId[i]});e={};e.opType=108;e.opData=JSON.stringify({Type:n+1,Infos:s});h=addFakeProgress();ajaxPost("/Relay/Post",e,r=>{var f,o,e,s;for(h(),h=null,f=r.datas,u=f.length,o=$(`#${t}List .result`),i=0;i<u;i++)e=f[i],s=e.errno==0?"success":"red",o.eq(i).html(`<span class="text-${s}">升级${e.errmsg}</span>`);batchRefresh(n,t);$(`#${t}List`)[0].time=setInterval(()=>{batchRefresh(n,t)},5e3)})},0)};showConfirm(`升级${e}`,a)}function deleteDevice(n,t){t=unescape(t);var i=function(){var t={};t.opType=104;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceList()})};showConfirm("删除机台号："+t,i)}var _permissionList=[],_deviceData=null,categories,models,scripts,option='<option value="{0}">{1}<\/option>',_batchCodeData=null;