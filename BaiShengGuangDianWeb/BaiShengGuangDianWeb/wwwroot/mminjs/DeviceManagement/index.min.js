function pageReady(){getDeviceList();$(".ads").css("width","100%");$(".col-sm-2").addClass("mcolsm2");$("#addIp").inputmask("ip");$("#updateIp").inputmask("ip");checkPermission(103)||$("#showAddModel").addClass("hidden");$("#addDeviceCategory").on("select2:select",function(){var r,i,n,t;for(hideTip("addDeviceModelTip"),hideTip("addScriptTip"),r=parseInt($("#addDeviceCategory option:checked").val()),$("#addDeviceModel").empty(),i=0,t=0;t<models.length;t++)n=models[t],n.DeviceCategoryId==r&&(i=i==0?n.Id:i,$("#addDeviceModel").append(option.format(n.Id,n.ModelName)));for($("#addScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#addScript").append(option.format(n.Id,n.ScriptName))});$("#addDeviceModel").on("select2:select",function(){var i,t,n;for(hideTip("addScriptTip"),i=parseInt($("#addDeviceModel option:checked").val()),$("#addScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#addScript").append(option.format(n.Id,n.ScriptName))});$("#updateDeviceCategory").on("select2:select",function(){var r,i,n,t;for(hideTip("updateDeviceModelTip"),hideTip("updateScriptTip"),r=parseInt($("#updateDeviceCategory option:checked").val()),$("#updateDeviceModel").empty(),i=0,t=0;t<models.length;t++)n=models[t],n.DeviceCategoryId==r&&(i=i==0?n.Id:i,$("#updateDeviceModel").append(option.format(n.Id,n.ModelName)));for($("#updateScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&$("#updateScript").append(option.format(n.Id,n.ScriptName))});$("#updateDeviceModel").on("select2:select",function(){var i=parseInt($("#updateDeviceModel option:checked").val()),t,n;for($("#updateScript").empty(),t=0;t<scripts.length;t++)n=scripts[t],!isStrEmptyOrUndefined(n.DeviceModelId)&&n.DeviceModelId.indexOf(i)>-1&&(hideTip("updateScriptTip"),$("#updateScript").append(option.format(n.Id,n.ScriptName)))})}function getDeviceList(){var t=100,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;n.opData=JSON.stringify({hard:!0});ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=function(n){var t="<li><a onclick=\"showControl({0},'{1}')\">控制<\/a><\/li>".format(n.Id,escape(n.DeviceStateStr)),i='<li><a onclick="showDetail({0})">详情<\/a><\/li>'.format(n.Id),r="<li><a onclick=\"showUpdateModel({0}, '{1}', '{2}', '{3}', '{4}', '{5}', '{6}', {7}, {8}, {9}, {10}, {11}, {12}, '{13}', '{14}', {15})\">修改<\/a><\/li>".format(n.Id,escape(n.DeviceName),escape(n.Code),escape(n.MacAddress),escape(n.Ip),escape(n.Port),escape(n.Identifier),escape(n.DeviceModelId),escape(n.ScriptId),escape(n.FirmwareId),escape(n.ApplicationId),escape(n.HardwareId),escape(n.SiteId),escape(n.Administrator),escape(n.Remark),escape(n.DeviceCategoryId)),u='<li><a onclick="showUpgrade({0})">升级<\/a><\/li>'.format(n.Id),f="<li><a onclick=\"deleteDevice({0}, '{1}')\">删除<\/a><\/li>".format(n.Id,escape(n.Code));return'<div class="btn-group"><button type = "button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"> <i class="fa fa-asterisk"><\/i>操作<\/button ><button type = "button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">   <span class="caret"><\/span>   <span class="sr-only">Toggle Dropdown<\/span><\/button><ul class="dropdown-menu" role="menu" style="cursor:pointer">{0}{1}{2}{3}{4}<\/ul><\/div>'.format(t,checkPermission(101)?i:"",checkPermission(102)?r:"",checkPermission(108)?u:"",checkPermission(104)?f:"")},i=function(n){return n.Ip+":"+n.Port},r=function(n){var t=n.StateStr;return t=="连接正常"?'<span class="text-success">'+t+"<\/span>":'<span class="text-danger">'+t+"<\/span>"},u=function(n){var t=n.DeviceStateStr;return t=="待加工"?'<span class="text-success">'+t+"<\/span>":t=="加工中"?'<span class="text-success">'+t+"<\/span>":t=="已确认"?'<span class="text-warning">'+t+"<\/span>":t=="维修中"?'<span class="text-info">'+t+"<\/span>":'<span class="text-red">'+t+"<\/span>"},f=function(n){return n.CategoryName+"-"+n.ModelName},e=function(n,t,i,r){return r.row+1},o=function(n){var t=n.SiteName+n.RegionDescription;return(""+t).length>tdShowContentLength?t.substr(0,tdShowContentLength)+' <a href = "javascript:showPlaceNameModel({0})">...<\/a> '.format(n.Id):t};$("#deviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:e},{data:"Code",title:"机台号",type:"html-percent"},{data:null,title:"设备型号",render:f},{data:null,title:"摆放位置",render:o},{data:null,title:"IP地址",render:i},{data:"AdministratorName",title:"管理员"},{data:null,title:"运行状态",render:r},{data:null,title:"设备状态",render:u},{data:null,title:"操作",render:t,orderable:!1}]})})}function showPlaceNameModel(n){var i=100,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&($("#siteName").html(n.datas[0].SiteName),$("#regionDescription").html(n.datas[0].RegionDescription));$("#placeNameModel").modal("show")})}function initAddSelect(){for(var t,r,i,n=0;n<categories.length;n++)t=categories[n],$("#addDeviceCategory").append(option.format(t.Id,t.CategoryName));for(r=categories[0].Id,i=0,n=0;n<models.length;n++)t=models[n],t.DeviceCategoryId==r&&(i==0&&(i=t.Id),$("#addDeviceModel").append(option.format(t.Id,t.ModelName)));if(i!=0)for(n=0;n<scripts.length;n++)t=scripts[n],t.DeviceModelId.indexOf(i)!=-1&&$("#addScript").append(option.format(t.Id,t.ScriptName))}function showAddModel(){var t=107,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}$(".ads").empty();$(".ads").select2();$("#addCode").val("");$("#addDeviceName").val("");$("#addMacAddress").val("");$("#addIp").val("");$("#addPort").val("60000");$("#addIdentifier").val("");$("#addAdministrator").val("");$("#addRemark").val("");for(var t,r="",i=0;i<n.firmwareLibraries.length;i++)t=n.firmwareLibraries[i],r+=option.format(t.Id,t.FirmwareName),$("#addFirmware").append(option.format(t.Id,t.FirmwareName));for($("#addFirmware").append(r),r="",i=0;i<n.applicationLibraries.length;i++)t=n.applicationLibraries[i],r+=option.format(t.Id,t.ApplicationName),$("#addApplication").append(option.format(t.Id,t.ApplicationName));for($("#addApplication").append(r),r="",i=0;i<n.hardwareLibraries.length;i++)t=n.hardwareLibraries[i],r+=option.format(t.Id,t.HardwareName),$("#addHardware").append(option.format(t.Id,t.HardwareName));for($("#addHardware").append(r),r="",i=0;i<n.sites.length;i++)t=n.sites[i],r+=option.format(t.Id,t.SiteName+t.RegionDescription),$("#addSite").append(option.format(t.Id,t.SiteName+t.RegionDescription));for($("#addSite").append(r),r="",i=0;i<n.maintainers.length;i++)t=n.maintainers[i],r+=option.format(t.Account,t.Name);$("#addAdministrator").append(r);categories=n.deviceCategories;models=n.deviceModels;scripts=n.scriptVersions;initAddSelect();hideClassTip("adt");$("#addModel").modal("show")})}function addDevice(){var a=103,n,t,r,i,u,f,v,y,e,o,s,h,c,l,p,w,b;if(!checkPermission(a)){layer.msg("没有权限");return}(n=!0,t=$("#addCode").val().trim(),isStrEmptyOrUndefined(t)&&(showTip("addCodeTip","机台号不能为空"),n=!1),r=$("#addDeviceName").val().trim(),isStrEmptyOrUndefined(r)&&(showTip("addDeviceNameTip","设备名不能为空"),n=!1),i=$("#addMacAddress").val().trim(),isMac(i)||isStrEmptyOrUndefined(i)||(showTip("addMacAddressTip","MAC地址格式不正确，请以xx:xx:xx:xx:xx:xx或xx-xx-xx-xx-xx-xx的形式输入，x为数字或字母（A-F大小写均可）"),n=!1),u=$("#addIp").val().trim().replace("_",""),isIp(u)||(showTip("addIpTip","IP非法"),n=!1),f=$("#addPort").val().trim(),isPort(f)||(showTip("addPortTip","端口非法"),n=!1),v=$("#addIdentifier").val(),y=$("#addDeviceCategory").val(),isStrEmptyOrUndefined(y)&&(showTip("addDeviceCategoryTip","设备类型错误"),n=!1),e=$("#addDeviceModel").val(),isStrEmptyOrUndefined(e)&&(showTip("addDeviceModelTip","设备型号错误"),n=!1),o=$("#addScript").val(),isStrEmptyOrUndefined(o)&&(showTip("addScriptTip","流程脚本版本错误"),n=!1),s=$("#addFirmware").val(),isStrEmptyOrUndefined(s)&&(showTip("addFirmwareTip","固件版本错误"),n=!1),h=$("#addApplication").val(),isStrEmptyOrUndefined(h)&&(showTip("addApplicationTip","应用层版本错误"),n=!1),c=$("#addHardware").val(),isStrEmptyOrUndefined(c)&&(showTip("addHardwareTip","硬件版本错误"),n=!1),l=$("#addSite").val(),isStrEmptyOrUndefined(l)&&(showTip("addSiteTip","场地错误"),n=!1),p=$("#addAdministrator").val(),w=$("#addRemark").val(),n)&&(b=function(){$("#addModel").modal("hide");var n={};n.opType=a;n.opData=JSON.stringify({Code:t,DeviceName:r,MacAddress:i,Ip:u,Port:f,Identifier:v,DeviceModelId:e,ScriptId:o,FirmwareId:s,ApplicationId:h,HardwareId:c,SiteId:l,Administrator:p,Remark:w});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceList()})},showConfirm("添加机台号："+t,b))}function initUpdateSelect(n,t,i){for(var u,r=0;r<categories.length;r++)u=categories[r],$("#updateDeviceCategory").append(option.format(u.Id,u.CategoryName));for($("#updateDeviceCategory").val(n),r=0;r<models.length;r++)u=models[r],u.DeviceCategoryId==n&&$("#updateDeviceModel").append(option.format(u.Id,u.ModelName));for($("#updateDeviceModel").val(t),r=0;r<scripts.length;r++)u=scripts[r],u.DeviceModelId.indexOf(t)!=-1&&$("#updateScript").append(option.format(u.Id,u.ScriptName));$("#updateScript").val(i)}function showUpdateModel(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){var w,b;if(t=unescape(t),i=unescape(i),r=unescape(r),u=unescape(u),f=unescape(f),e=unescape(e),o=unescape(o),s=unescape(s),h=unescape(h),c=unescape(c),a=unescape(a),v=unescape(v),y=unescape(y),p=unescape(p),w=107,!checkPermission(w)){layer.msg("没有权限");return}b={};b.opType=w;ajaxPost("/Relay/Post",b,function(w){if(w.errno!=0){layer.msg(w.errmsg);return}$(".ads").empty();$(".ads").select2();for(var k,d="",b=0;b<w.firmwareLibraries.length;b++)k=w.firmwareLibraries[b],d+=option.format(k.Id,k.FirmwareName);for($("#updateFirmware").append(d),d="",b=0;b<w.applicationLibraries.length;b++)k=w.applicationLibraries[b],d+=option.format(k.Id,k.ApplicationName);for($("#updateApplication").append(d),d="",b=0;b<w.hardwareLibraries.length;b++)k=w.hardwareLibraries[b],d+=option.format(k.Id,k.HardwareName);for($("#updateHardware").append(d),d="",b=0;b<w.sites.length;b++)k=w.sites[b],d+=option.format(k.Id,k.SiteName+k.RegionDescription);for($("#updateSite").append(d),d="",b=0;b<w.maintainers.length;b++)k=w.maintainers[b],d+=option.format(k.Account,k.Name);$("#updateAdministrator").append(d);d="";categories=w.deviceCategories;models=w.deviceModels;scripts=w.scriptVersions;initUpdateSelect(p,o,s);hideClassTip("adt");$("#updateId").html(n);$("#updateDeviceName").val(t);$("#updateCode").val(i);$("#updateMacAddress").val(r);$("#updateIp").val(u);$("#updatePort").val(f);$("#updateIdentifier").val(e);$("#updateDeviceModel").val(o);$("#updateScript").val(s);$("#updateFirmware").val(h);$("#updateHardware").val(l);$("#updateApplication").val(c);$("#updateSite").val(a);$("#updateAdministrator").val(v);$("#updateRemark").val(y);$("#updateModel").modal("show")})}function updateDevice(){var l=102,i,t,r,u,v,y,f,e,o,s,h,c,p,w,b;if(!checkPermission(l)){layer.msg("没有权限");return}var k=parseInt($("#updateId").html()),n=!0,a=$("#updateCode").val().trim();(isStrEmptyOrUndefined(a)&&(showTip("updateCodeTip","机台号不能为空"),n=!1),i=$("#updateDeviceName").val().trim(),isStrEmptyOrUndefined(i)&&(showTip("updateDeviceNameTip","设备名不能为空"),n=!1),t=$("#updateMacAddress").val().trim(),isMac(t)||isStrEmptyOrUndefined(t)||(showTip("updateMacAddressTip","MAC地址格式不正确，请以xx:xx:xx:xx:xx:xx或xx-xx-xx-xx-xx-xx的形式输入，x为数字或字母（A-F大小写均可）"),n=!1),r=$("#updateIp").val().trim().replace("_",""),isIp(r)||(showTip("updateIpTip","IP非法"),n=!1),u=$("#updatePort").val().trim(),isPort(u)||(showTip("updatePortTip","端口非法"),n=!1),v=$("#updateIdentifier").val(),y=$("#updateDeviceCategory").val(),isStrEmptyOrUndefined(y)&&(showTip("updateDeviceCategoryTip","设备类型错误"),n=!1),f=$("#updateDeviceModel").val(),isStrEmptyOrUndefined(f)&&(showTip("updateDeviceModelTip","设备型号错误"),n=!1),e=$("#updateScript").val(),isStrEmptyOrUndefined(e)&&(showTip("updateScriptTip","流程脚本版本错误"),n=!1),o=$("#updateFirmware").val(),isStrEmptyOrUndefined(o)&&(showTip("updateFirmwareTip","固件版本错误"),n=!1),s=$("#updateApplication").val(),isStrEmptyOrUndefined(s)&&(showTip("updateApplicationTip","应用层版本错误"),n=!1),h=$("#updateHardware").val(),isStrEmptyOrUndefined(h)&&(showTip("updateHardwareTip","硬件版本错误"),n=!1),c=$("#updateSite").val(),isStrEmptyOrUndefined(c)&&(showTip("updateSiteTip","场地错误"),n=!1),p=$("#updateAdministrator").val(),w=$("#updateRemark").val(),n)&&(b=function(){$("#updateModel").modal("hide");var n={};n.opType=l;n.opData=JSON.stringify({id:k,Code:a,DeviceName:i,MacAddress:t,Ip:r,Port:u,Identifier:v,DeviceModelId:f,ScriptId:e,FirmwareId:o,ApplicationId:s,HardwareId:h,SiteId:c,Administrator:p,Remark:w});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceList()})},showConfirm("修改",b))}function showDetail(n){window.location="/DeviceManagement/Detail?id="+n}function showControl(n,t){t=unescape(t);t=="待加工"||t=="加工中"?window.location="/DeviceManagement/Control?id="+n:layer.msg("该设备"+t)}function showUpgrade(n){window.location="/DeviceManagement/Detail?id="+n}function deleteDevice(n,t){var i,r;if(t=unescape(t),i=104,!checkPermission(i)){layer.msg("没有权限");return}r=function(){var t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceList()})};showConfirm("删除机台号："+t,r)}var categories,models,scripts,option='<option value="{0}">{1}<\/option>';