function pageReady(){_permissionList[200]={uIds:["showManageModelBtn"]};_permissionList[236]={uIds:["showAddScriptVersionModel"]};_permissionList[237]={uIds:[]};_permissionList[238]={uIds:[]};_permissionList[201]={uIds:["showUsuallyDictionaryTypeModelBtn"]};_permissionList[202]={uIds:["showUsuallyVariableTypeModelBtn"]};_permissionList[241]={uIds:["showAddUsuallyVariableTypeModel"]};_permissionList[242]={uIds:[]};_permissionList[243]={uIds:[]};_permissionList[203]={uIds:["showAddModel"]};_permissionList[204]={uIds:[]};_permissionList[205]={uIds:["showScriptSetBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ads").css("width","100%").select2();$(".ms2").select2();var n=new Promise(n=>getDataTypeList(n,0)),t=new Promise(n=>getDeviceModelList(n,0)),i=new Promise(n=>getScriptVersionList(n,0));Promise.all([n,t,i]).then(()=>{const n=scriptData.filter(n=>~n.DeviceModelId.split(",").map(n=>parseInt(n)).indexOf(deModel));$("#sScriptVersion").html(setOptions(n,"ScriptName")).val(0)});$("#fScriptVersion").change(function(){$(".sd ").addClass("hidden");var n=$("#fScriptVersion").val();$("#div"+n).removeClass("hidden")});$("#sScriptVersion").on("select2:select",function(){(sScrId=parseInt($("#sScriptVersion").val()),sScrId!=0)&&getScriptVersionDetailList()});$("#sDeviceModel").on("select2:select",function(){deModel=parseInt($("#sDeviceModel").val());const n=scriptData.filter(n=>~n.DeviceModelId.split(",").map(n=>parseInt(n)).indexOf(deModel));$("#sScriptVersion").html(setOptions(n,"ScriptName")).val(0);$("#valList_wrapper").parent().empty().append('<table class="table table-hover table-striped" id="valList"><\/table>');$("#inList_wrapper").parent().empty().append('<table class="table table-hover table-striped" id="inList"><\/table>');$("#outList_wrapper").parent().empty().append('<table class="table table-hover table-striped" id="outList"><\/table>')});$("#aDeviceModel").on("select2:select",function(){adeModel=parseInt($("#aDeviceModel").val());getScriptVersionList1()});$("#aScriptVersion").on("select2:select",function(){asScrId=parseInt($("#aScriptVersion").val())});$("#jScriptVersion").on("select2:select",function(){var n=$("#jScriptVersion").val();$("#jsonName").val(n)});$("#aDataType").on("select2:select",function(){var n=$("#fScriptVersion").val();n==1&&($("#jsonFile").val(""),initDiv1());$("#siteCount").text($(this).val()==1?700:100)});$("#jsonFile").change(function(n){var t,i;(initDiv1(),t=n.target.files[0],isStrEmptyOrUndefined(t))||window.FileReader&&(i=new FileReader,i.onloadend=function(n){var s=n.target.result,e,i;try{var o=JSON.parse(s),h=$("#fScriptVersion").val(),f=parseInt($("#aDataType").val());for(jsonData=[],e=[],i=0;i<o.length;i++){var r=o[i],u=null,t=null;switch(f){case 1:u=r[2];t=r[0];break;case 2:case 3:u=r[1];t=r[4]}if(!isStrEmptyOrUndefined(u)&&!isStrEmptyOrUndefined(t)){if(f==2){if(t.indexOf("输入")<0)continue;t=t.replace("输入","")}if(f==3){if(t.indexOf("输出")<0)continue;t=t.replace("输出","")}e.indexOf(t)>=0||(e.push(t),jsonData.push({Id:jsonData.length+1,ScriptId:h,VariableName:u,PointerAddress:t}))}}$("#jsonList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:jsonData,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"序号"},{data:"VariableName",title:"名称"},{data:"PointerAddress",title:"地址"}]})}catch(c){layer.msg("json数据格式有误")}},i.readAsText(t,"gb2312"))});$("#addScriptVersionDeviceModel").select2({allowClear:!0,placeholder:"请选择"});$("#updateScriptVersionDeviceModel").select2({allowClear:!0,placeholder:"请选择"});$("#udtScriptVersion").on("select2:select",function(){showUsuallyDictionaryTypeModel(!0)});$("#scriptModel").on("select2:select",()=>getScriptType(!1));$("#showScriptSetModel").on("focus",".precision",function(){$(this).val()==0&&$(this).val("")});$("#showScriptSetModel").on("blur",".precision",function(){isStrEmptyOrUndefined($(this).val())&&$(this).val(0)})}function getScriptVersionAllList(n){var t={};t.opType=113;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}scriptData=t.datas;var i=_permissionList[237].have,r=_permissionList[238].have,f=function(n,t,i,r){return++r.row},e=function(n){var t="<button type=\"button\" class=\"btn btn-primary mbtn-group\" onclick=\"showUpdateScriptVersionModel({0}, '{1}', '{2}','{3}')\">修改<\/button>".format(n.Id,escape(n.DeviceModelId),escape(n.ScriptName),escape(n.ScriptFile)),u='<button type="button" class="btn btn-danger mbtn-group" onclick="deleteScriptVersion({0}, \'{1}\')">删除<\/button>'.format(n.Id,escape(n.ScriptName));return'<div class="btn-group">{0}{1}<\/div>'.format(i?t:"",r?u:"")},u=[{data:null,title:"序号",render:f},{data:"Id",title:"Id",bVisible:!1},{data:"ScriptName",title:"脚本名称"},{data:"ValueNumber",title:"变量数"},{data:"InputNumber",title:"输入口数"},{data:"OutputNumber",title:"输出口数"},{data:"ScriptFile",title:"脚本文件",render:n=>n?`<span style="vertical-align:middle;padding-right:5px">${n.slice(n.indexOf("_")+1)}</span><button type="button" class="btn btn-success btn-xs" onclick="fileDownload('${escape(n)}')" title="下载脚本文件"><span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span></button>`:""}];(i||r)&&u.push({data:null,title:"操作",render:e,orderable:!1});$("#scriptVersionList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:u});n==1&&$("#scriptVersionModel").modal("show")})}function fileDownload(n){var t,i;n=unescape(n);t={type:fileEnum.Script,files:JSON.stringify([n])};t.dir="";for(i in fileEnum)if(fileEnum[i]==t.type){t.dir=i;break}if(isStrEmptyOrUndefined(t.dir))return void layer.msg("文件类型不存在！");getFilePath(t,t=>{const i=t.length;i<=0||downLoad(t[0].path,n.slice(n.indexOf("_")+1))})}function showManageModel(){getScriptVersionAllList(1)}function showAddScriptVersionModel(){_addFirmwareUpload==null&&(_addFirmwareUpload=initFileInput("addFile",fileEnum.Script));$("#addFile").fileinput("clear");$("#addFileBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择.npc文件...");hideClassTip("adt");$("#addScriptVersionDeviceModel").val("").trigger("change");$("#addScriptVersionName").val("");$("#addScriptVersionModel").modal("show")}function addScriptVersion(){var n=$("#addScriptVersionDeviceModel").val(),t=$("#addScriptVersionName").val().trim(),u=$("#addFile").val(),i=n==null?"":n.join(","),r;if(i.length==0){layer.msg("请选择设备型号");return}if(isStrEmptyOrUndefined(t)){showTip($("#addScriptVersionNameTip"),"脚本名称不能为空");return}if(isStrEmptyOrUndefined(u)){layer.msg("请选择.npc文件");return}fileCallBack[fileEnum.Script]=function(n){if(n.errno==0){$("#addScriptVersionModel").modal("hide");var r={};r.opType=114;r.opData=JSON.stringify({DeviceModelId:i,ScriptName:t,ScriptFile:n.data});ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);n.errno==0&&getScriptVersionAllList(0)})}else layer.msg(n.errmsg)};r=function(){$("#addFile").fileinput("upload")};showConfirm("添加",r)}function deleteScriptVersion(n,t){var i=function(){var t={};t.opType=116;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getScriptVersionAllList(0)})};showConfirm("删除脚本："+unescape(t),i)}function showUpdateScriptVersionModel(n,t,i,r){t=unescape(t);i=unescape(i);r=unescape(r);$("#updateId").html(n);hideClassTip("adt");var u=[];isStrEmptyOrUndefined(t)||(u=t.split(",").map(Number));$("#updateScriptVersionDeviceModel").val(u).trigger("change");$("#updateScriptVersionName").val(i);_updateFirmwareUpload==null&&(_updateFirmwareUpload=initFileInput("updateFile",fileEnum.Script));$("#updateFile").fileinput("clear");$("#updateFileBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择.npc文件...").val(r.slice(r.indexOf("_")+1));$("#oldUpdateFile").val(r);$("#updateScriptVersionModel").modal("show")}function updateScriptVersion(){var r=$("#updateScriptVersionDeviceModel").val(),u=$("#updateScriptVersionName").val().trim(),n,t,i,f;if(isStrEmptyOrUndefined(u)){showTip($("#updateScriptVersionNameTip"),"脚本名称不能为空");return}if(n=r==null?"":r.join(","),n.length==0){layer.msg("请选择设备型号");return}t=t=>{$("#updateScriptVersionModel").modal("hide");var i={};i.opType=115;i.opData=JSON.stringify({id:$("#updateId").text()>>0,DeviceModelId:n,ScriptName:u,ScriptFile:t});ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);n.errno==0&&getScriptVersionAllList(0)})};f=$("#updateFile").val();isStrEmptyOrUndefined(f)?i=()=>t($("#oldUpdateFile").val()):(fileCallBack[fileEnum.Script]=n=>n.errno==0?t(n.data):layer.msg(n.errmsg),i=()=>$("#updateFile").fileinput("upload"));showConfirm("修改",i)}function getDataTypeList(n,t=1){ajaxPost("/Relay/Post",{opType:112},function(t){var f,r,e,i,u;if(t.errno!=0){layer.msg(t.errmsg);return}for(valueType=t.datas,$("#aDataType").empty(),f='<option value="{0}">{1}<\/option>',i=0;i<t.datas.length;i++)r=t.datas[i],$("#aDataType").append(f.format(r.Id,r.TypeName));for($("#addDataType").empty(),e='<option value="{0}">{1}<\/option>',i=0;i<t.datas.length;i++)u=t.datas[i],$("#addDataType").append(e.format(u.Id,u.TypeName));n&&n(t.datas)},t)}function getDeviceModelList(n,t=1){ajaxPost("/Relay/Post",{opType:120},function(t){if(t.errno!=0){layer.msg(t.errmsg);return}deModel=deModel==0&&t.datas.length?t.datas[0].Id:t.datas.length==0?0:deModel;var i=setOptionsWithNames(t.datas,["CategoryName","ModelName"],"-");$("#sDeviceModel").html(i);deModel&$("#sDeviceModel").val(deModel);$("#addScriptVersionDeviceModel").html(i);$("#updateScriptVersionDeviceModel").html(i);n&&n(t.datas)},t)}function getScriptVersionList(n,t=1){sScrId=0;var i={};i.opType=113;ajaxPost("/Relay/Post",i,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}scriptData=t.datas;n&&n(t.datas)},t)}function getScriptVersionDetailList(){if(sScrId!=0){var n={};n.opType=106;n.opData=JSON.stringify({sId:sScrId});$("#valList,#inList,#outList").empty();ajaxPost("/Relay/Post",n,function(n){var r,t,i,s,u,e,o;if(n.errno!=0){layer.msg(n.errmsg);return}for(r=n.datas,t={1:[],2:[],3:[]},i=0,s=r.length;i<s;i++)u=r[i],t[u.VariableTypeId].push(u);var c=_permissionList[204].have,f={dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-0"i><"col-sm-12"p>',pagingType:"full",destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,info:!1,searching:!0,autoWidth:!0,language:oLanguage,iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Id",title:"Id",bVisible:!1},{data:"VariableName",title:"名称"},{data:"PointerAddress",title:"地址"},{data:"Remark",title:"备注",bVisible:!1},{data:null,title:"删除",render:n=>`<button type="button" class="btn btn-danger btn-xs" onclick="delVar(${n.Id},'${escape(n.VariableName)}')">删除</button>`,orderable:!1,bVisible:c}]},h=$.extend(!0,{},f);h.data=t[1];$("#valList").DataTable(h);e=$.extend(!0,{},f);e.data=t[2];$("#inList").DataTable(e);o=$.extend(!0,{},f);o.data=t[3];$("#outList").DataTable(o)})}}function delVar(n,t){t=unescape(t);var i=function(){var t={};t.opType=105;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getScriptVersionDetailList()})};showConfirm(`删除：${t}`,i)}function getDeviceModelList1(n){adeModel=0;ajaxPost("/Relay/Post",{opType:120},function(t){var u,r,i;if(t.errno!=0){layer.msg(t.errmsg);return}for($("#aDeviceModel").empty(),u='<option value="{0}">{1}<\/option>',r=0;r<t.datas.length;r++)i=t.datas[r],adeModel==0&&(adeModel=i.Id),$("#aDeviceModel").append(u.format(i.Id,i.CategoryName+"-"+i.ModelName));getScriptVersionList1(n)})}function getScriptVersionList1(n){asScrId=0;var t={};t.opType=113;t.opData=JSON.stringify({deviceModelId:deModel});ajaxPost("/Relay/Post",t,function(t){var u,r,i;if(t.errno!=0){layer.msg(t.errmsg);return}for($("#aScriptVersion").empty(),$("#jScriptVersion").empty(),u='<option value="{0}">{1}<\/option>',r=0;r<t.datas.length;r++)i=t.datas[r],asScrId==0&&(asScrId=i.Id),$("#aScriptVersion").append(u.format(i.Id,i.ScriptName)),$("#jScriptVersion").append(u.format(i.ScriptName,i.ScriptName));n==1&&$("#addModel").modal("show")})}function showAddModel(){reset();getDeviceModelList1(1)}function reset(){var t=$("#fScriptVersion").val(),n;switch(t){case"0":$("#avBody").empty();n='<tr id="av{0}"><td><label class="control-label" id="avx{0}">{0}<\/label><\/td><td><input class="form-control" id="avb{0}" maxlength="20"><\/td><td><input class="form-control" oninput="onInput(this, 5, 0)" onblur="onInputEnd(this)" id="avd{0}"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="delSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(1);$("#avBody").append(n);max=maxV=2;case"1":$("#jsonFile").val("");initDiv1()}}function initDiv1(){jsonData=null;$("#jsonList_wrapper").remove();$("#jsonList").remove();$("#div1").append('<table class="table table-hover table-striped" id="jsonList"><thead>        <tr>           <td>序号<\/td>  <td>变量名<\/td><td>地址<\/td>  <\/tr>          <\/thead>       <\/table>       ')}function addOther(){var n='<tr id="av{0}"><td><label class="control-label" id="avx{0}">{1}<\/label><\/td><td><input class="form-control" id="avb{0}" maxlength="20"><\/td><td><input class="form-control" oninput="value=value.replace(/[^\\d]/g,\'\')" id="avd{0}" maxlength="5"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="delSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(max,maxV);$("#avBody").append(n);max++;maxV++}function delSelf(n){var i,r,t;for($("#avBody").find("[id=av"+n+"]").remove(),max--,maxV--,i=1,r=$("#avBody").find("label"),t=0;t<r.length;t++)r[t].textContent=i,i++}function addValues(){var u=$("#fScriptVersion").val(),e=$("#sDeviceModel").val(),o=$("#aDataType").val(),t=null,n,i,r,f,c;switch(u){case"0":var l=$("#aScriptVersion").val(),s=[],h=$("#siteCount").text();for(n=1;n<max;n++)if($("#av"+n).length>0){if(i=$("#avb"+n).val(),isStrEmptyOrUndefined(i)){layer.msg("名称不能为空");return}if(r=$("#avd"+n).val(),isStrEmptyOrUndefined(r)){layer.msg("地址不能为空");return}if(r>>0>h>>0){layer.msg(`${i}：地址不能超过${h}`);return}s.push({PointerAddress:r,VariableName:i})}t={Type:u,DeviceModelId:e,VariableType:o,ScriptId:l,DataNameDictionaries:s};break;case"1":if(f=$("#jsonName").val(),isStrEmptyOrUndefined(f)){layer.msg("脚本名称不能为空");return}if(jsonData==null||jsonData.length==0){layer.msg("请选择正确的json文件");return}t={Type:u,DeviceModelId:e,VariableType:o,ScriptName:f,DataNameDictionaries:jsonData};break;case"2":return;case"3":return;default:return}if(t.DataNameDictionaries.length==0){layer.msg("请输入数据");return}c=function(){$("#addModel").modal("hide");var n={};n.opType=111;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getDeviceModelList()})};showConfirm("添加",c)}function tableToExcel(){layer.msg("待完善")}function showUsuallyDictionaryTypeModel(n=false){var u,t,r,i;if(scriptData!=null&&scriptData.length>0){if(!n)for($("#udtScriptVersion").empty(),u='<option value="{0}">{1}<\/option>',t=0;t<scriptData.length;t++)r=scriptData[t],$("#udtScriptVersion").append(u.format(r.Id,r.ScriptName));i={};i.opType=118;i.opData=JSON.stringify({sId:$("#udtScriptVersion").val()});ajaxPost("/Relay/Post",i,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}usData=n.datas;showUsuallyDictionary();$("#usuallyDictionaryTypeModel").modal("show")})}else n||$("#usuallyDictionaryTypeModel").modal("show")}function showUsuallyDictionary(){var n={};n.opType=106;n.opData=JSON.stringify({sId:$("#udtScriptVersion").val()});ajaxPost("/Relay/Post",n,function(n){function r(n,t){for(var r,u=[],i=0;i<n.length;i++)r=n[i],r.VariableTypeId==t&&u.push(r);return u}if(n.errno!=0){layer.msg(n.errmsg);return}var t=[];t["1"]=r(n.datas,1);t["2"]=r(n.datas,2);t["3"]=r(n.datas,3);const i=dataTableConfig(usData);i.iDisplayLength=35;i.aLengthMenu=[35,70,105];i.addColumns([{data:"VariableName",title:"变量用途"},{data:null,title:"变量地址",sClass:"text-left",render:n=>`<div class="form-group">
                                    <select class="mSel vt form-control" v="${n.XvHao}" id="val${n.XvHao}" ov="${n.VariableTypeId}" did="${n.Id}" vid="vid1_${n.VariableNameId}"></select>
                                    <select class="mSel vv form-control" v="${n.XvHao}" id="dic${n.XvHao}" ov="${n.DictionaryId}" vid="vid2_${n.VariableNameId}"></select>
                                </div>`}]);i.createdRow=(n,i)=>{n=$(n);var u=i.VariableTypeId,r=setOptions(valueType,"TypeName");n.find(".vt").html(r).val(i.VariableTypeId).on("change",function(){var f=$(this).val();r=setOptionsWithKeyNames(t[f],"PointerAddress",["PointerAddress","VariableName"],"-");n.find(".vv").html(r);f==u&&n.find(".vv").val(i.DictionaryId)});r=setOptionsWithKeyNames(t[u],"PointerAddress",["PointerAddress","VariableName"],"-");n.find(".vv").html(r).val(i.DictionaryId);n.find(".vv").select2({matcher})};_udtListTable=$("#udtList").DataTable(i);$("#usuallyDictionaryTypeModel").modal("show")})}function updateUdt(){var r=$("#udtScriptVersion").val(),u,t,e,i,f;if(r!=null&&usData.length>0){u=!1;t=[];for(e in usData){var n=usData[e],o=$("#udtList").find(".mSel").filter("[vid=vid1_"+n.VariableNameId+"]"),s=$("#udtList").find(".mSel").filter("[vid=vid2_"+n.VariableNameId+"]");o.length>0?(i=$(s).val(),f=$(o).val(),i==null&&(i="0"),(parseInt(f)!=n.VariableTypeId||parseInt(i)!=n.DictionaryId)&&(u=!0),t.push({Id:n.Id,ScriptId:r,VariableNameId:n.VariableNameId,DictionaryId:i,VariableTypeId:f})):t.push({Id:n.Id,ScriptId:r,VariableNameId:n.VariableNameId,DictionaryId:n.DictionaryId,VariableTypeId:n.VariableTypeId})}if(!u)return;showConfirm("修改",()=>{var n={};n.opType=119;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",{opType:119,opData:JSON.stringify(t)},function(n){layer.msg(n.errmsg);n.errno==0&&showUsuallyDictionaryTypeModel(!0)})})}}function showUsuallyVariableTypeModel(){dataStatisticType=[];var n={};n.opType=157;ajaxPost("/Relay/Post",n,function(n){var i,s,t;if(n.errno!=0){layer.msg(n.errmsg);return}var r=_permissionList[242].have,u=_permissionList[243].have,h=function(n){var t='<button type="button" class="btn btn-primary mbtn-group" onclick="showUpdateVariableTypeModel({0}, \'{1}\',\'{2}\')">修改<\/button>'.format(n.Id,escape(n.VariableName),n.StatisticType),i='<button type="button" class="btn btn-danger mbtn-group" onclick="deleteVariableType({0}, \'{1}\')">删除<\/button>'.format(n.Id,escape(n.VariableName));return'<div class="btn-group">{0}{1}<\/div>'.format(r?t:"",u?i:"")},f=function(n,t,i,r){return++r.row},e=function(n,t,i){return i.StatisticType==0?"":i.StatisticType==1?"趋势图":i.StatisticType==2?"加工记录":void 0},o=function(n,t,i){return i.IsDetail==!0?"是":"否"},c=r||u?[{data:null,title:"序号",render:f},{data:"VariableName",title:"变量名称"},{data:"IsDetail",title:"是否为设备详情",render:o},{data:"StatisticType",title:"统计字段",render:e},{data:null,title:"操作",render:h,orderable:!1}]:[{data:null,title:"序号",render:f},{data:"VariableName",title:"变量名称"},{data:"IsDetail",title:"是否为设备详情",render:o},{data:"StatisticType",title:"统计字段",render:e}];for($("#usuallyVariableTypeList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[0,"asc"],aLengthMenu:[15,30,60],iDisplayLength:15,columns:c}),$("#usuallyVariableTypeModel").modal("show"),i=0;i<n.datas.length;i++)dataStatisticType[i]=n.datas[i].StatisticType;for(dataStatisticType=dataStatisticType.filter(function(n,t){return dataStatisticType.indexOf(n)===t}),dataStatisticType=dataStatisticType.sort(function(n,t){return n>t?1:-1}),$("#updateStatisticType").empty(),s='<option value="{0}">{1}<\/option>',t=0;t<dataStatisticType.length;t++)dataStatisticType[t]==0&&(statisticTypeName="无"),dataStatisticType[t]==1&&(statisticTypeName="趋势图"),dataStatisticType[t]==2&&(statisticTypeName="加工记录"),$("#updateStatisticType").append(s.format(dataStatisticType[t],statisticTypeName))})}function deleteVariableType(n,t){var i=function(){var t={};t.opType=161;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&showUsuallyVariableTypeModel()})};showConfirm("删除变量："+unescape(t),i)}function showAddUsuallyVariableTypeModel(){$("#addVariableName").val("");$("#addVariableSite").val("");$("#addDataType").val($("#addDataType option").eq(0).val()).trigger("change");$("#addUsuallyVariableTypeModel").modal("show")}function addVariableType(){var n=$("#addVariableName").val().trim(),r=$("#addDataType").val(),t=$("#addVariableSite").val().replace(/\b(0+)/gi,""),i;if(isStrEmptyOrUndefined(n)){showTip($("#addVariableNameTip"),"变量名称不能为空");return}if(isStrEmptyOrUndefined(t)){showTip($("#addVariableSiteTip"),"变量名称不能为空");return}i=function(){$("#addUsuallyVariableTypeModel").modal("hide");var i={};i.opType=159;i.opData=JSON.stringify({VariableTypeId:r,DictionaryId:t,VariableName:n});ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);n.errno==0&&showUsuallyVariableTypeModel()})};showConfirm("添加",i)}function showUpdateVariableTypeModel(n,t,i){$("#updateVariableId").html(n);t=unescape(t);$("#updateVariableName").val(t);$("#updateStatisticType").val(i).trigger("change");$("#updateUsuallyVariableTypeModel").modal("show")}function updateVariableType(){var n=$("#updateVariableName").val().trim(),r=$("#updateStatisticType").val().trim(),t,i;if(isStrEmptyOrUndefined(n)){showTip($("#updateVariableNameTip"),"变量名称不能为空");return}t=parseInt($("#updateVariableId").html());i=function(){$("#updateUsuallyVariableTypeModel").modal("hide");var i={};i.opType=160;i.opData=JSON.stringify({id:t,VariableName:n,StatisticType:r});ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);n.errno==0&&showUsuallyVariableTypeModel()})};showConfirm("修改",i)}function getScriptType(n){const t={};t.opType=113;t.opData=JSON.stringify({deviceModelId:$("#scriptModel").val()});ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const r=t.datas,u='<option value="{0}">{1}<\/option>';let i="";for(let n=0,f=r.length;n<f;n++){const r=t.datas[n];i+=u.format(r.Id,r.ScriptName)}$("#scriptType").empty().append(i);n&&getScriptDecimals()},0)}function showScriptSetModel(){ajaxPost("/Relay/Post",{opType:120},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const i=n.datas,r='<option value="{0}">{1}<\/option>';let t="";for(let u=0,f=i.length;u<f;u++){const i=n.datas[u];t+=r.format(i.Id,`${i.CategoryName}-${i.ModelName}`)}$("#scriptModel").empty().append(t);getScriptType(!0)});$("#showScriptSetModel").modal("show")}function getScriptDecimals(){const t=$("#scriptType").val();if(isStrEmptyOrUndefined(t)){layer.msg("请选择脚本版本");return}const n={};n.opType=106;n.opData=JSON.stringify({sId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#scriptVarBox,#scriptInBox,#scriptOutBox").addClass("hidden");const r=n.datas,t={1:[],2:[],3:[]};for(let n=0,i=r.length;n<i;n++){const i=r[n];t[i.VariableTypeId].push(i)}_scriptPrecision=[];const u=n=>`<input type="checkbox" class="icb_minimal isEnable" value=${n}>`,f=n=>`<span class="precisionText">${n}</span><input type="text" class="form-control text-center precision hidden" oninput="onInput(this, 1, 0)" onblur="onInputEnd(this)" style="min-width:100px">`,i={dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-0"i><"col-sm-12"p>',pagingType:"full",destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,info:!1,searching:!0,autoWidth:!0,language:oLanguage,aaSorting:[[1,"asc"]],iDisplayLength:20,columns:[{data:"Id",title:"选择",render:u,orderable:!1},{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"VariableName",title:"名称"},{data:"Precision",title:"小数位",render:f}],drawCallback:function(){$(this).find(".icb_minimal").iCheck({labelHover:!1,cursor:!0,checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"}).on("ifChanged",function(){const n=$(this).parents("tr");$(this).is(":checked")?(_scriptPrecision.push(n),n.find(".precision").removeClass("hidden").val(n.find(".precisionText").addClass("hidden").text())):(_scriptPrecision.splice(_scriptPrecision.indexOf(n),1),n.find(".precisionText").removeClass("hidden").siblings(".precision").addClass("hidden"))})}},e=$("#scriptConfig").val();switch(e){case"0":$("#scriptVarBox,#scriptInBox,#scriptOutBox").removeClass("hidden");$("#scriptVarList").DataTable(Object.assign({data:t[1]},i));$("#scriptInList").DataTable(Object.assign({data:t[2]},i));$("#scriptOutList").DataTable(Object.assign({data:t[3]},i));break;case"1":$("#scriptVarBox").removeClass("hidden");$("#scriptVarList").DataTable(Object.assign({data:t[1]},i));break;case"2":$("#scriptInBox").removeClass("hidden");$("#scriptInList").DataTable(Object.assign({data:t[2]},i));break;case"3":$("#scriptOutBox").removeClass("hidden");$("#scriptOutList").DataTable(Object.assign({data:t[3]},i))}})}function updateScriptPrecision(){const t=_scriptPrecision.length;if(!t){layer.msg("请先设置小数位");return}const i=[];for(let n=0;n<t;n++){const t=_scriptPrecision[n],r=t.find(".precision").val().trim()>>0;if(r>4){layer.msg("小数最多设置4位");return}i.push({id:t.find(".isEnable").val(),Precision:r})}const n={};n.opType=167;n.opData=JSON.stringify(i);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&getScriptDecimals()})}var _permissionList=[],jsonData=null,scriptData=null,_addFirmwareUpload=null,_updateFirmwareUpload=null,valueType=null,deModel=0,sScrId=0,adeModel=0,asScrId=0,max=2,maxV=2,usData=null,statisticTypeName,dataStatisticType;let _udtListTable=null;let _scriptPrecision=null;