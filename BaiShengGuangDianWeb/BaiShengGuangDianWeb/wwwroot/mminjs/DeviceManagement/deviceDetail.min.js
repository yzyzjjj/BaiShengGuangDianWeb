function pageReady(){_permissionList[169]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);$(".ads,.ms2").select2();var n=getQueryString("id");n!=null&&(id=parseInt(n));getFirmwareList(function(){getControlList();getStateList()})}function getControlList(){var n={};n.opType=100;n.opData=JSON.stringify({hard:!0});ajaxPost("/Relay/Post",n,function(n){var t,r,e,i;if(n.errno!=0){layer.msg(n.errmsg);return}t=n.datas;$(".ms2").empty();var u=!1,f="";for(_deviceData={},r=0,e=t.length;r<e;r++)i=t[r],_deviceData[i.Id]=i,f+='<option value="{0}">{1}<\/option>'.format(i.Id,i.Code),i.Id==id&&(firstData=i,u=!0);$(".ms2").append(f);!u&&t.length>0&&(firstData=t[0],id=1);selectChange(t);$(".ms2").on("select2:select",function(n){id=parseInt($(`#${n.currentTarget.id} :selected`).val());selectChange(t)})})}function selectChange(n){for(var i,t=0;t<n.length;t++)i=n[t],i.Id==id&&(firstData=i);firstData==null&&n.length>0&&(firstData=n[0],id=1);firstData!=null&&($("#detailScript").empty(),new Promise(n=>getUpgrade(n,113,"ScriptFile","ScriptName",firstData.DeviceModelId)).then(n=>$("#detailScript").append(n).val(firstData.ScriptId).trigger("change")),$(".ms2").val(id).trigger("change"),$("#detailDeviceName").val(firstData.DeviceName),$("#detailMacAddress").val(firstData.MacAddress),$("#detailIp").val(firstData.Ip),$("#detailPort").val(firstData.Port),$("#detailIdentifier").val(firstData.Identifier),$("#detailDeviceModel").val(firstData.ModelName),$("#detailFirmware").val(firstData.FirmwareId).trigger("change"),$("#detailHardware").val(firstData.HardwareId).trigger("change"),$("#detailApplication").val(firstData.ApplicationId).trigger("change"),$("#detailSite").val(firstData.SiteName+firstData.RegionDescription),$("#detailAdministrator").val(firstData.Administrator),$("#detailRemark").val(firstData.Remark));getStateList()}function getStateList(){$("#StateBox input").val("无数据");var n={};n.opType=109;n.opData=JSON.stringify({qId:id});ajaxPost("/Relay/Post",n,function(n){var t;if(n.errno!=0){layer.msg(n.errmsg);return}for(t=0;t<n.datas.length;t++){var r=n.datas[t],i="",u=r.Item1,f=r.Item2;switch(u){case 1:i=firstData.DeviceStateStr;break;default:i=f}$("#StateBox").find("[name="+u+"]").val(i)}})}function getUpgrade(n,t,i,r,u){var f={};f.opType=t;u&&(f.opData=JSON.stringify({deviceModelId:u}));ajaxPost("/Relay/Post",f,function(t){var u,s,f;if(t.errno!=0){layer.msg(t.errmsg);return}var e=t.datas,o="";for(u=0,s=e.length;u<s;u++)f=e[u],o+='<option value="{0}" path="{1}">{2}<\/option>'.format(f.Id,f[i],f[r]);n(o)},0)}function getFirmwareList(n){var t=new Promise(n=>getUpgrade(n,130,"FilePath","FirmwareName")),i=new Promise(n=>getUpgrade(n,135,"FilePath","HardwareName")),r=new Promise(n=>getUpgrade(n,145,"FilePath","ApplicationName"));$("#detailFirmware,#detailHardware,#detailApplication").empty();Promise.all([t,i,r]).then(t=>{$("#detailFirmware").append(t[0]),$("#detailHardware").append(t[1]),$("#detailApplication").append(t[2]),n()})}function deviceUpgrade(n=0){var f=$("#detailCode2").val(),e;if(isStrEmptyOrUndefined(f)){layer.msg("请选择机台号");return}if(_deviceData[f].DeviceStateStr!="待加工"){layer.msg("非待加工设备不能升级");return}var t=null,r=null,u=null,i="";switch(n){case 1:t=$("#detailScript").val();r=fileEnum.Script;u=$("#detailScript :selected").attr("path");i="流程脚本版本";break;case 2:t=$("#detailFirmware").val();r=fileEnum.Firmware;u=$("#detailFirmware :selected").attr("path");i="固件版本";break;case 3:t=$("#detailHardware").val();r=fileEnum.Hardware;u=$("#detailHardware :selected").attr("path");i="硬件版本";break;case 4:t=$("#detailApplication").val();r=fileEnum.Application;u=$("#detailApplication :selected").attr("path");i="应用层版本"}if(isStrEmptyOrUndefined(t)){layer.msg(`请选择：<span style="font-weight:bold">${i}</span>`);return}e=()=>{var i={type:r,files:JSON.stringify([u])};ajaxPost("/Upload/Path",i,r=>{if(r.errno!=0){layer.msg(r.errmsg);return}i={};i.opType=108;i.opData=JSON.stringify({Type:n,Infos:[{Type:1,FileId:t,FileUrl:`${location.origin}${r.data[0].path}`,DeviceId:f}]});ajaxPost("/Relay/Post",i,n=>{var t=n.datas[0];layer.msg(t.errmsg);t.errno==0&&getControlList()})},0)};showConfirm(`升级${i}`,e)}var _permissionList=[],id=1,_deviceData=null,firstData=null;