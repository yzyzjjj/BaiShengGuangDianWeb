function pageReady(){_permissionList[169]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();const n=new Promise(n=>getDevice(n)),t=new Promise(n=>getUpgrade(n,130,"FilePath","FirmwareName")),i=new Promise(n=>getUpgrade(n,135,"FilePath","HardwareName")),r=new Promise(n=>getUpgrade(n,145,"FilePath","ApplicationName"));Promise.all([n,t,i,r]).then(n=>{$("#detailFirmware").append(n[1]),$("#detailHardware").append(n[2]),$("#detailApplication").append(n[3]),getAssignDevice(getQueryString("id")||n[0])});$("#detailCode1,#detailCode2,#detailCode3").on("select2:select",function(){const n=$(this).val();getAssignDevice(n)})}function resetTable(){const n=$("#detailCode1").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择机台号");return}getAssignDevice(n)}function getDevice(n){ajaxPost("/Relay/Post",{opType:100},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}var i=t.datas;i.sort((n,t)=>n.Code-t.Code);const u='<option value="{0}">{1}<\/option>';let r="";for(let n=0,t=i.length;n<t;n++){const t=i[n];r+=u.format(t.Id,t.Code)}$("#detailCode1,#detailCode2,#detailCode3").empty().append(r);n(i[0].Id)})}function getAssignDevice(n){$("#detailCode1,#detailCode2,#detailCode3").val(n).trigger("change");ajaxPost("/Relay/Post",{opType:100,opData:JSON.stringify({ids:n,hard:!0})},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas[0];getDeviceState(n,i.DeviceStateStr);$("#detailScript").empty();new Promise(n=>getUpgrade(n,113,"ScriptFile","ScriptName",i.DeviceModelId)).then(n=>$("#detailScript").append(n).val(i.ScriptId).trigger("change"));$("#detailDeviceName").val(i.DeviceName);$("#detailClass").val(i.Class);$("#detailMacAddress").val(i.MacAddress);$("#detailIp").val(i.Ip);$("#detailPort").val(i.Port);$("#detailIdentifier").val(i.Identifier);$("#detailDeviceModel").val(i.ModelName);$("#detailFirmware").val(i.FirmwareId).trigger("change");$("#detailHardware").val(i.HardwareId).trigger("change");$("#detailApplication").val(i.ApplicationId).trigger("change");$("#detailSite").val(`${i.SiteName}${i.RegionDescription}`);$("#detailAdministrator").val(i.Administrator);$("#detailRemark").val(i.Remark)})}function getDeviceState(n,t){$("#StateBox input").val("无数据");ajaxPost("/Relay/Post",{opType:109,opData:JSON.stringify({qId:n})},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#name1").val(t);var i=n.datas;for(let n=0,r=i.length;n<r;n++){const r=i[n],u=r.Item1;$(`#name${u}`).val(u===1?t:r.Item2)}})}function getUpgrade(n,t,i,r,u){const f={};f.opType=t;u&&(f.opData=JSON.stringify({deviceModelId:u}));ajaxPost("/Relay/Post",f,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const u=t.datas,e='<option value="{0}" path="{1}">{2}<\/option>';let f="";for(let n=0,t=u.length;n<t;n++){const t=u[n];f+=e.format(t.Id,t[i],t[r])}n(f)},0)}function deviceUpgrade(n=0){var f=$("#detailCode2").val();if(isStrEmptyOrUndefined(f)){layer.msg("请选择机台号");return}if($("#name1").val().trim()!="待加工"){layer.msg("非待加工设备不能升级");return}var t=null,r=null,u=null,i="";switch(n){case 1:t=$("#detailScript").val();r=fileEnum.Script;u=$("#detailScript :selected").attr("path");i="流程脚本版本";break;case 2:t=$("#detailFirmware").val();r=fileEnum.FirmwareLibrary;u=$("#detailFirmware :selected").attr("path");i="固件版本";break;case 3:t=$("#detailHardware").val();r=fileEnum.Hardware;u=$("#detailHardware :selected").attr("path");i="硬件版本";break;case 4:t=$("#detailApplication").val();r=fileEnum.ApplicationLibrary;u=$("#detailApplication :selected").attr("path");i="应用层版本"}if(isStrEmptyOrUndefined(t)){layer.msg(`请选择：<span style="font-weight:bold">${i}</span>`);return}const e=()=>{var i={type:r,files:JSON.stringify([u])};ajaxPost("/Upload/Path",i,r=>{if(r.errno!=0){layer.msg(r.errmsg);return}i={};i.opType=108;i.opData=JSON.stringify({Type:n,Infos:[{Type:1,FileId:t,FileUrl:`${location.origin}${r.data[0].path}`,DeviceId:f}]});var u=addFakeProgress();ajaxPost("/Relay/Post",i,n=>{u();u=null;var t=n.datas[0];layer.msg(t.errmsg);t.errno==0&&getAssignDevice(f)})},0)};showConfirm(`升级${i}`,e)}var _permissionList=[];