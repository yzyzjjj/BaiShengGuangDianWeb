function pageReady(){_permissionList[312]={uIds:["getFlowCardListBtn"]};_permissionList[319]={uIds:["showAddFlowCardModel"]};_permissionList[320]={uIds:[]};_permissionList[321]={uIds:[]};_permissionList[322]={uIds:[]};_permissionList[313]={uIds:["getProductionProcessListBtn"]};_permissionList[327]={uIds:["showProductionProcessModel"]};_permissionList[328]={uIds:[]};_permissionList[329]={uIds:[]};_permissionList[314]={uIds:["getRawMateriaListBtn"]};_permissionList[334]={uIds:["showAddRawMateriaModel"]};_permissionList[335]={uIds:[]};_permissionList[336]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").css("width","100%");$(".ms2").select2();$("#flowCardStartDate,#flowCardEndDate,#jhStartDate,#jhEndDate,#ylStartDate,#ylEndDate").val(getDate()).datepicker("update");selectPlan();selectRaw();$(".fcHead input,.fcHead span").css("verticalAlign","middle");$(".jhHead input,.jhHead span").css("verticalAlign","middle");$(".ylHead input,.ylHead span").css("verticalAlign","middle");$(".icb_minimal").iCheck({checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"});$(".fcHead label").on("ifChanged",function(){var n=$(this).index();$(this).find(".icb_minimal").is(":checked")?($(".fcBody").eq(n).removeClass("hidden"),n==1&&($("#flowCardStartDate").val(getDate()).datepicker("update"),$("#flowCardEndDate").val(getDate()).datepicker("update"))):($(".fcBody").eq(n).addClass("hidden"),n==0&&$("#flowCardId").val(""),n==2&&$("#selectPlanList").val($("#selectPlanList").find("option:first").val()).trigger("change"));$(".fcHead .icb_minimal").is(":checked")?$("#fcBtn").addClass("hidden"):$("#fcBtn").removeClass("hidden")});$(".jhHead label").on("ifChanged",function(){var n=$(this).index();$(this).find(".icb_minimal").is(":checked")?($(".jhBody").eq(n).removeClass("hidden"),n==1&&($("#jhStartDate").val(getDate()).datepicker("update"),$("#jhEndDate").val(getDate()).datepicker("update"))):($(".jhBody").eq(n).addClass("hidden"),n==0&&$("#selectJhList").val($("#selectJhList").find("option:first").val()).trigger("change"));$(".jhHead .icb_minimal").is(":checked")?$("#jhBtn").addClass("hidden"):$("#jhBtn").removeClass("hidden")});$(".ylHead label").on("ifChanged",function(){var n=$(this).index();$(this).find(".icb_minimal").is(":checked")?($(".ylBody").eq(n).removeClass("hidden"),n==1&&($("#ylStartDate").val(getDate()).datepicker("update"),$("#ylEndDate").val(getDate()).datepicker("update"))):($(".ylBody").eq(n).addClass("hidden"),n==0&&$("#selectYlList").val($("#selectYlList").find("option:first").val()).trigger("change"));$(".ylHead .icb_minimal").is(":checked")?$("#ylBtn").addClass("hidden"):$("#ylBtn").removeClass("hidden")})}function showAddFlowCardModel(){hideClassTip("adt");$("#afRawMaterialQuantity").val("");$("#afStartFlowCard").val("");$("#afFlowCardNumber").val("1");$("#afSender").val("");$("#afInboundNum").val("");$("#afRemarks").val("");var n=new Promise(function(n){var t={};t.opType=215;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var f,r,i,u;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}for($("#afProductionProcess").empty(),f='<option value="{0}">{1}<\/option>',r="",i=0;i<t.datas.length;i++)u=t.datas[i],r+=f.format(u.Id,u.ProductionProcessName);$("#afProductionProcess").append(r)},0)}),t=new Promise(function(n){var t={};t.opType=232;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,function(t){var f,r,i,u;if(n("success"),t.errno!=0){layer.msg(t.errmsg);return}for($("#afRawMateria").empty(),f='<option value="{0}">{1}<\/option>',r="",i=0;i<t.datas.length;i++)u=t.datas[i],r+=f.format(u.Id,u.RawMateriaName);$("#afRawMateria").append(r)},0)});Promise.all([n,t]).then(()=>{$("#addFlowCardModel").modal("show")})}function addFlowCard(){var o=$("#afProductionProcess").val().trim(),s=$("#afRawMateria").val().trim(),t=$("#afRawMaterialQuantity").val().trim(),h=$("#afPriority").val().trim(),c=$("#afInboundNum").val().trim(),l=$("#afRemarks").val().trim(),a=$("#afSender").val().trim(),i=$("#afStartFlowCard").val().trim(),r=$("#afFlowCardNumber").val().trim(),u,n,e;if(isStrEmptyOrUndefined(t)){showTip($("#afRawMaterialQuantityTip"),"原料数量不能为空");return}if(u=parseInt(t),u<=0){showTip($("#afRawMaterialQuantityTip"),"原料数量必须大于0");return}if(isStrEmptyOrUndefined(i)){showTip($("#afStartFlowCardTip"),"起始流程卡号不能为空");return}if(isStrEmptyOrUndefined(r)){showTip($("#afFlowCardNumberTip"),"流程卡数不能为空");return}var v=parseInt(i),y=parseInt(r),f=[];for(n=0;n<y;n++)f.push({FlowCardName:v+n,ProductionProcessId:o,RawMateriaId:s,RawMaterialQuantity:t,Sender:a,InboundNum:c,Priority:h,Remarks:l});e=function(){$("#addFlowCardModel").modal("hide");var n={};n.opType=210;n.opData=JSON.stringify(f);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg)})};showConfirm("添加",e)}function selectPlan(){var n={};n.opType=215;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,function(n){var r,i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#selectPlanList").empty(),$("#selectJhList").empty(),r="<option value='{0}'>{0}<\/option>",i=0;i<n.datas.length;i++)t=n.datas[i],$("#selectPlanList").append(r.format(t.ProductionProcessName,t.ProductionProcessName)),$("#selectJhList").append(r.format(t.ProductionProcessName,t.ProductionProcessName))})}function selectRaw(){var n={};n.opType=232;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,function(n){var u,t,i,r;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#selectYlList").empty(),u="<option value='{0}'>{0}<\/option>",t=[],i=0;i<n.datas.length;i++)r=n.datas[i],t.push(u.format(r.RawMateriaName,r.RawMateriaName));t=t.join("");$("#selectYlList").append(t)},0)}function getFlowCardList(){var r={},n={},u,t,i,f;if(r.opType=200,$(".fcHead .icb_minimal").is(":checked")){if(u=$("#flowCardId").val().trim(),$(".fcHead .icb_minimal").eq(0).is(":checked")){if(isStrEmptyOrUndefined(u)){layer.msg("请输入流程卡号");return}n.flowCardName=u}if(t=$("#flowCardStartDate").val()+" 00:00:00",i=$("#flowCardEndDate").val()+" 23:59:59",exceedTime(t)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(t,i)){layer.msg("结束时间不能小于开始时间");return}if($(".fcHead .icb_minimal").eq(1).is(":checked")){if(isStrEmptyOrUndefined(t)||isStrEmptyOrUndefined(i)){layer.msg("请选择创建时间");return}n.startTime=t;n.endTime=i}if(f=$("#selectPlanList").val(),$(".fcHead .icb_minimal").eq(2).is(":checked")){if(isStrEmptyOrUndefined(f)){layer.msg("请选择计划号");return}n.productionProcessName=f}r.opData=JSON.stringify(n)}ajaxPost("/Relay/Post",r,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=_permissionList[320].have,i=_permissionList[321].have,r=_permissionList[322].have,h=function(n){var u='<button type="button" class="btn btn-primary" onclick="showUpdateFlowCard({0})">修改<\/button>'.format(n.Id),f='<button type="button" class="btn btn-info" onclick="showChangeFlowCard({0}, \'{1}\')">更新<\/button>'.format(n.Id,escape(n.FlowCardName)),e='<button type="button" class="btn btn-danger" onclick="deleteFlowCard({0}, \'{1}\')">删除<\/button>'.format(n.Id,escape(n.FlowCardName));return"{0}{1}{2}".format(t?u:"",i?f:"",r?e:"")},u=function(n,t,i,r){return++r.row},f=function(n){return n.ProcessTime=="0001-01-01 00:00:00"&&(n.ProcessTime=""),n.ProcessTime},e=function(n){return isStrEmptyOrUndefined(n.StepName)?"未开始加工":n.CategoryName+"-"+n.StepName},o=function(n){var t=n.Priority;return t==2?'<span class="text-red"><span class="hidden">2<\/span>高<\/span>':t==1?'<span class="text-warning"><span class="hidden">1<\/span>中<\/span>':'<span class="text-success"><span class="hidden">0<\/span>低<\/span>'},s=t||i||r,c=s?[{data:null,title:"操作",render:h,orderable:!1},{data:null,title:"序号",render:u},{data:"Id",title:"Id",bVisible:!1},{data:"CreateTime",title:"创建时间"},{data:"TypeName",title:"卡类型"},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardName",title:"流程卡号"},{data:"RawMateriaName",title:"原料批次"},{data:null,title:"优先级",render:o},{data:null,title:"当前工序",render:e,sClass:"text-info"},{data:null,title:"加工时间",render:f,sClass:"text-info"},{data:"QualifiedNumber",title:"当前合格数",sClass:"text-info"},{data:"Code",title:"当前机台号",sClass:"text-info"}]:[{data:null,title:"序号",render:u},{data:"Id",title:"Id",bVisible:!1},{data:"CreateTime",title:"创建时间"},{data:"TypeName",title:"卡类型"},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardName",title:"流程卡号"},{data:"RawMateriaName",title:"原料批次"},{data:null,title:"优先级",render:o},{data:null,title:"当前工序",render:e,sClass:"text-info"},{data:null,title:"加工时间",render:f,sClass:"text-info"},{data:"QualifiedNumber",title:"当前合格数",sClass:"text-info"},{data:"Code",title:"当前机台号",sClass:"text-info"}];$("#flowCardList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,autoWidth:!0,language:oLanguage,data:n.datas,aaSorting:[[s?1:0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:c});$("#flowCardList tbody").on("focus","tr",function(){trOne=this})})}function deleteFlowCard(n,t){t=unescape(t);var i=function(){var t={};t.opType=211;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getFlowCardList()})};showConfirm("删除流程卡："+t,i)}function showUpdateFlowCard(n){var t=function(){if(hideClassTip("adt"),$("#ufGGBody").empty(),$("#ufGXBody").empty(),ufGGmax=ufGGmaxV=ufGXmax=ufGXmaxV=1,n!=-1||ufRecover!=1){n==-1&&(ufRecover=1);var i=n==-1?$("#updateFCId").html():n,t={};t.opType=201;t.opData=JSON.stringify({id:i});ajaxPost("/Relay/Post",t,function(t){var r,e,o,f,c,s,h,u,l;if(t.errno!=0){layer.msg(t.errmsg);return}for(r=t.datas[0],$("#updateFCId").html(i),$("#ufProductionProcess").val(r.ProductionProcessName),$("#ufRawMateria").val(r.RawMateriaName),$("#ufPriority").val(r.Priority),$("#ufRawMaterialQuantity").val(r.RawMaterialQuantity),$("#ufFlowCardName").val(r.FlowCardName),$("#ufSender").val(r.Sender),$("#ufInboundNum").val(r.InboundNum),$("#ufRemarks").val(r.Remarks),u=0;u<r.Specifications.length;u++)o=r.Specifications[u],e='<tr id="ufGG{0}" value="{2}"><td><label class="control-label" id="ufGGx{0}">{1}<\/label><\/td><td><input class="form-control" value="{3}" id="ufGGm{0}" maxlength="20"><\/td><td><input class="form-control" value="{4}" id="ufGGz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="ufGGDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(ufGGmax,ufGGmaxV,o.Id,o.SpecificationName,o.SpecificationValue),$("#ufGGBody").append(e),ufGGmax++,ufGGmaxV++;for(u=0;u<r.ProcessSteps.length;u++)f=r.ProcessSteps[u],e='<tr id="ufGX{0}" value="{2}"><td><label class="control-label" id="ufGXx{0}">{1}<\/label><\/td><td><select class="ms2 yc form-control" id="ufGXm{0}"><\/td><td><input class="form-control" value="{3}" id="ufGXz{0}" onblur="autoCal(this, \'ufGXh{0}\')" maxlength="100"><\/td><td><input class="form-control text-center" value="{4}" id="ufGXh{0}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="ufGXDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(ufGXmax,ufGXmaxV,f.Id,f.ProcessStepRequirements,f.ProcessStepRequirementMid),$("#ufGXBody").append(e),ufGXmax++,ufGXmaxV++;if(DeviceProcessData!=null){for($(".yc").empty(),c='<option value="{0}">{1}-{2}<\/option>',s=0;s<DeviceProcessData.length;s++)h=DeviceProcessData[s],$(".yc").append(c.format(h.Id,h.CategoryName,h.StepName));for($(".yc").css("width","100%"),$(".yc").select2(),u=0;u<r.ProcessSteps.length;u++)f=r.ProcessSteps[u],l="#ufGXm"+(u+1),$(l).val(f.ProcessStepId).trigger("change")}n!=-1?$("#updateFlowCardModel").modal("show"):ufRecover=0})}};checkDeviceProcessData(t)}function updateFlowCard(){var y=$("#ufPriority").val().trim(),h=$("#ufRawMaterialQuantity").val().trim(),p=$("#ufSender").val().trim(),w=$("#ufInboundNum").val().trim(),b=$("#ufRemarks").val().trim(),u,f,n,t,e,o,i,c,s,l,r,a,v;if(isStrEmptyOrUndefined(h)){showTip($("#ufRawMaterialQuantityTip"),"原料数量不能为空");return}if(u=parseInt(h),u<=0){showTip($("#ufRawMaterialQuantityTip"),"原料数量必须大于0");return}for(f=[],n=1;n<ufGGmax;n++)if($("#ufGG"+n).length>0){if(e=$("#ufGGm"+n).val().trim(),isStrEmptyOrUndefined(e)){layer.msg("规格名不能为空");return}if(o=$("#ufGGz"+n).val().trim(),isStrEmptyOrUndefined(o)){layer.msg("规格值不能为空");return}t=$("#ufGG"+n).attr("value");f.push({Id:t,SpecificationName:e,SpecificationValue:o})}for(i=[],c=1,n=1;n<ufGXmax;n++)if($("#ufGX"+n).length>0){if(s=$("#ufGXm"+n).val().trim(),isStrEmptyOrUndefined(s)){layer.msg("工序名称不能为空");return}if(l=$("#ufGXz"+n).val().trim(),r=$("#ufGXh"+n).val().trim(),isStrEmptyOrUndefined(r)||parseFloat(r)<=0){layer.msg("合格值必须大于0");return}t=$("#ufGX"+n).attr("value");i.push({Id:t,ProcessStepOrder:c++,ProcessStepId:s,ProcessStepRequirements:l,ProcessStepRequirementMid:r})}if(i.length<=0){layer.msg("请填写工序");return}a={id:parseInt($("#updateFCId").html()),RawMaterialQuantity:u,Sender:p,InboundNum:w,Remarks:b,Priority:y,Specifications:f,ProcessSteps:i};v=function(){$("#updateFlowCardModel").modal("hide");var n={};n.opType=207;n.opData=JSON.stringify(a);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getFlowCardList()})};showConfirm("修改",v)}function ufResetGG(){$("#ufGGBody").empty();var n='<tr id="ufGG{0}"><td><label class="control-label" id="ufGGx{0}">{0}<\/label><\/td><td><input class="form-control" id="ufGGm{0}" maxlength="20"><\/td><td><input class="form-control" id="ufGGz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="ufGGDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(1);$("#ufGGBody").append(n);ufGGmax=ufGGmaxV=2}function ufAddOtherGG(){var n='<tr id="ufGG{0}" value="0"><td><label class="control-label" id="ufGGx{0}">{1}<\/label><\/td><td><input class="form-control" id="ufGGm{0}" maxlength="20"><\/td><td><input class="form-control" id="ufGGz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="ufGGDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(ufGGmax,ufGGmaxV);$("#ufGGBody").append(n);ufGGmax++;ufGGmaxV++}function ufGGDelSelf(n){var i,r,t;for($("#ufGGBody").find("[id=ufGG"+n+"]").remove(),ufGGmaxV--,i=1,r=$("#ufGGBody").find("label"),t=0;t<r.length;t++)r[t].textContent=i,i++}function ufResetGX(){var r,n,u,t,i;if(ufGXmax=ufGXmaxV=1,$("#ufGXBody").empty(),r='<tr id="ufGX{0}" value="0"><td><label class="control-label" id="ufGXx{0}">{0}<\/label><\/td><td><select class="ms2 form-control" id="ufGXm{0}"><\/select> <td><input class="form-control" id="ufGXz{0}" onblur="autoCal(this, \'ufGXh{0}\')" maxlength="100"><\/td><td><input class="form-control text-center" id="ufGXh{0}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="ufGXDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(ufGXmax),$("#ufGXBody").append(r),DeviceProcessData!=null){for(n="#ufGXm"+ufGXmax,$(n).empty(),u='<option value="{0}">{1}-{2}<\/option>',t=0;t<DeviceProcessData.length;t++)i=DeviceProcessData[t],$(n).append(u.format(i.Id,i.CategoryName,i.StepName));$(n).css("width","100%");$(n).select2()}ufGXmax=ufGXmaxV=2}function ufAddOtherGX(){var u='<tr id="ufGX{0}" value="0"><td><label class="control-label" id="ufGXx{0}">{1}<\/label><\/td><td><select class="ms2 form-control" id="ufGXm{0}"><\/select> <td><input class="form-control" id="ufGXz{0}" onblur="autoCal(this, \'ufGXh{0}\')" maxlength="100"><\/td><td><input class="form-control text-center" id="ufGXh{0}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="ufGXDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(ufGXmax,ufGXmaxV),n,r,t,i;if($("#ufGXBody").append(u),DeviceProcessData!=null){for(n="#ufGXm"+ufGXmax,$(n).empty(),r='<option value="{0}">{1}-{2}<\/option>',t=0;t<DeviceProcessData.length;t++)i=DeviceProcessData[t],$(n).append(r.format(i.Id,i.CategoryName,i.StepName));$(n).css("width","100%");$(n).select2()}ufGXmax++;ufGXmaxV++}function ufGXDelSelf(n){var i,r,t;for($("#ufGXBody").find("[id=ufGX"+n+"]").remove(),ufGXmaxV--,i=1,r=$("#ufGXBody").find("label"),t=0;t<r.length;t++)r[t].textContent=i,i++}function showChangeFlowCard(n,t){if($("#cfGXBody").empty(),gxLength=1,n!=-1||cfRecover!=1){n==-1&&(cfRecover=1);var r=n==-1?$("#changeFCId").html():n,i={};i.opType=202;i.opData=JSON.stringify({Id:r});ajaxPost("/Relay/Post",i,function(i){function ut(n,t){return n.ProcessStepOrder>t.ProcessStepOrder?1:-1}var o,s,h;if(i.errno!=0){layer.msg(i.errmsg);return}$("#changeFCId").html(r);$("#changeFCName").html(t);for(var e='<option value="{0}">{1}<\/option>',u=0,v=function(n){return n.CategoryName+"-"+n.StepName},y=function(n){return u=n.ProcessStepOrder,'<span oValue="{1}" id="c1f{0}">{0}<\/span>'.format(u,n.Id)},c=e.format(0,"无"),f=0;f<i.processors.length;f++)o=i.processors[f],c+=e.format(o.Id,o.ProcessorName);var p=function(n){return'<select class="can1 ms2 form-control" id="c2f{0}" oValue="{2}">{1}<\/select>'.format(u,c,n.ProcessorId)},w=function(n){var i='<input type="text" id="c31f{0}" class="can1 form_date form-control {4}" value="{2}" style="width:90px"><input type="text" id="c32f{0}" class="can1 form_time form-control {4}" value="{3}" style="width:75px"><input type="text" id="c3f{0}" value="{1}" oValue="{1}" class="hidden">',t;return n.ProcessTime=="0001-01-01 00:00:00"||n.ProcessTime==null?(n.ProcessTime="",i.format(u,n.ProcessTime,"","","hidden")):(t=n.ProcessTime.split(" "),i.format(u,n.ProcessTime,t[0],t[1],""))},l=e.format(0,"无");for(f=0;f<i.surveyors.length;f++)s=i.surveyors[f],l+=e.format(s.Id,s.SurveyorName);var b=function(n){return'<select class="can2 ms2 form-control" id="c4f{0}" oValue="{2}">{1}<\/select>'.format(u,l,n.SurveyorId)},k=function(n){var i='<input type="text" id="c51f{0}" class="can2 form_date form-control {4}" value="{2}" style="width:90px"><input type="text" id="c52f{0}" class="can2 form_time form-control {4}" value="{3}" style="width:75px"><input type="text" id="c5f{0}" value="{1}" oValue="{1}" class="hidden">',t;return n.SurveyTime=="0001-01-01 00:00:00"||n.SurveyTime==null?(n.SurveyTime="",i.format(u,n.SurveyTime,"","","hidden")):(t=n.SurveyTime.split(" "),i.format(u,n.SurveyTime,t[0],t[1],""))},d=function(n){return'<input class="can1 can2 form-control" id="c6f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="onInput(this, 9, 0)" onblur="onInputEnd(this)">'.format(u,n.QualifiedNumber)},g=function(n){return'<input class="can1 can2 form-control" id="c7f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="onInput(this, 9, 0)" onblur="onInputEnd(this)">'.format(u,n.UnqualifiedNumber)},a=e.format(0,"无");for(f=0;f<i.deviceIds.length;f++)h=i.deviceIds[f],a+=e.format(h.Id,h.Code);var nt=function(n){return'<select class="can1 ms2 form-control" id="c8f{0}" oValue="{2}">{1}<\/select>'.format(u,a,n.DeviceId)},tt=function(n){return'<input class="can1 can2 form-control" id="c9f{0}" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(u,n.QualifiedRange)},it=function(n){return'<input class="can1 can2 form-control" id="c10f{0}" style="width:100%" value="{1}" oValue="{1}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10">'.format(u,n.QualifiedMode)},rt=function(n){return n.IsSurvey?'<button class="btn btn-info edit2-btn" type="button" id="c11f{0}">检验<\/button>'.format(u):'<button class="btn btn-success edit1-btn" type="button" id="c11f{0}">加工<\/button>'.format(u)};$("#gxList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,bSort:!1,paging:!1,deferRender:!1,bLengthChange:!1,info:!1,searching:!1,language:oLanguage,data:i.processSteps.sort(ut),aaSorting:[[0,"asc"]],columns:[{data:null,title:"序号",render:y},{data:"MarkedDateTime",title:"修改时间"},{data:null,title:"工序名称",render:v},{data:"ProcessStepRequirements",title:"加工要求"},{data:null,title:"加工人",render:p},{data:null,title:"加工时间",render:w},{data:null,title:"机台号",render:nt},{data:null,title:"检验人",render:b},{data:null,title:"检验时间",render:k},{data:null,title:"合格数",render:d},{data:null,title:"不合格数",render:g},{data:null,title:'成厚范围(<span class="text-info">例:0.2～0.3mm<\/span>)',render:tt},{data:null,title:'成厚均值(<span class="text-info">例:0.25<\/span>)',render:it},{data:null,title:"操作",render:rt}],drawCallback:function(){var r;for($(".ms2").select2(),$(".can1").attr("disabled","disabled"),$(".can2").attr("disabled","disabled"),$("#gxList th").css("padding-right","8px"),r=0;r<i.processSteps.length;r++){var u=r+1,n=$("#c2f"+u),t=n.attr("ovalue");n.val(t).trigger("change");n=$("#c4f"+u);t=n.attr("ovalue");n.val(t).trigger("change");n=$("#c8f"+u);t=n.attr("ovalue");n.val(t).trigger("change")}$("#gxList tbody").on("click",".edit1-btn",function(){var f=$(this).parents("tr").children().find(".can1"),n=$($(this).parents("tr").children()[0]).text(),t=$("#c31f"+n),i=$("#c32f"+n),e=$("#c3f"+n),r,u;t.removeClass("hidden");i.removeClass("hidden");r=e.attr("ovalue");isStrEmptyOrUndefined(r)?(t.val(getDate()).datepicker("update"),i.val(getTime())):(u=r.split(" "),t.val(u[0]),i.val(u[1]));f.removeAttr("disabled");f.css("background-color","white");$(this).html("取消");$(this).removeClass("edit1-btn");$(this).addClass("cancel1-btn");$(this).removeClass("btn-success");$(this).addClass("btn-danger")});$("#gxList tbody").on("click",".edit2-btn",function(){var f=$(this).parents("tr").children().find(".can2"),n=$($(this).parents("tr").children()[0]).text(),t=$("#c51f"+n),i=$("#c52f"+n),e=$("#c5f"+n),r,u;t.removeClass("hidden");i.removeClass("hidden");r=e.attr("ovalue");isStrEmptyOrUndefined(r)?(t.val(getDate()).datepicker("update"),i.val(getTime())):(u=r.split(" "),t.val(u[0]),i.val(u[1]));f.removeAttr("disabled");f.css("background-color","white");$(this).html("取消");$(this).removeClass("edit2-btn");$(this).addClass("cancel2-btn");$(this).removeClass("btn-info");$(this).addClass("btn-danger")});$("#gxList tbody").on("click",".cancel1-btn",function(){var n=$(this).parents("tr").children().find(".can1"),r,u;n.attr("disabled","disabled");r=n.filter("input");$.each(r,function(n,t){var i=$(t).attr("ovalue");$(t).val(i)});u=n.filter("select");$.each(u,function(n,t){var i=$(t).attr("ovalue");$(t).val(i).trigger("change")});var t=$($(this).parents("tr").children()[0]).text(),f=$("#c31f"+t),e=$("#c32f"+t),s=$("#c3f"+t),o=s.attr("ovalue"),i;isStrEmptyOrUndefined(o)?(f.addClass("hidden"),e.addClass("hidden")):(i=o.split(" "),f.val(i[0]),e.val(i[1]));n.css("background-color","#eee");$(this).html("加工");$(this).removeClass("cancel1-btn");$(this).addClass("edit1-btn");$(this).removeClass("btn-danger");$(this).addClass("btn-success")});$("#gxList tbody").on("click",".cancel2-btn",function(){var n=$(this).parents("tr").children().find(".can2"),r,u,i;n.attr("disabled","disabled");r=n.filter("input");$.each(r,function(n,t){var i=$(t).attr("ovalue");$(t).val(i)});u=n.filter("select");$.each(u,function(n,t){var i=$(t).attr("ovalue");$(t).val(i).trigger("change")});var t=$($(this).parents("tr").children()[0]).text(),f=$("#c51f"+t),e=$("#c52f"+t),s=$("#c5f"+t),o=s.attr("ovalue");isStrEmptyOrUndefined(o)?(f.addClass("hidden"),e.addClass("hidden")):(i=o.split(" "),f.val(i[0]),e.val(i[1]));n.css("background-color","#eee");$(this).html("检验");$(this).removeClass("cancel2-btn");$(this).addClass("edit2-btn");$(this).removeClass("btn-danger");$(this).addClass("btn-info")});initTime()}});n!=-1?$("#changeFlowCardModel").modal("show"):cfRecover=0})}}function initTime(){$("#gxList .form_date,.form_time").attr("readonly",!0);$("#gxList .form_date").datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});$("#gxList .form_time").timepicker({language:"zh-CN",showMeridian:!1,minuteStep:1,showSeconds:!0,secondStep:1})}function changeFlowCard(){for(var l,a,s,v,h,y,p,w,b,u,i,c,n,r,f,e,k,d=parseInt($("#changeFCId").html()),g=$("#gxList tbody").children(),o=[],t=1;t<=g.length;t++){for(i=1;i<=10;i++){c=$("#c{1}f{0}".format(t,i));n=c.val();switch(i){case 1:n=$(c).attr("ovalue");l=n;break;case 2:a=n;break;case 3:r=$("#c{1}1f{0}".format(t,i));f=$("#c{1}2f{0}".format(t,i));n=r.hasClass("hidden")?n:"{0} {1}".format($(r).val(),$(f).val());s=isStrEmptyOrUndefined(n)?null:n;break;case 4:v=n;break;case 5:r=$("#c{1}1f{0}".format(t,i));f=$("#c{1}2f{0}".format(t,i));n=r.hasClass("hidden")?n:"{0} {1}".format($(r).val(),$(f).val());h=isStrEmptyOrUndefined(n)?null:n;break;case 6:y=n;break;case 7:p=n;break;case 8:w=n;break;case 9:b=n;break;case 10:if(u=n,($("#c11f{0}".format(t)).hasClass("cancel1-btn")||$("#c11f{0}".format(t)).hasClass("cancel2-btn"))&&(isStrEmptyOrUndefined(u)||parseFloat(u)<=0)){layer.msg("成厚均值必须大于0");return}}}e={Id:l,FlowCardId:d,ProcessorId:a,SurveyorId:v,QualifiedNumber:y,UnqualifiedNumber:p,DeviceId:w,QualifiedRange:b,QualifiedMode:u};s!=null&&(e.ProcessTime=s);h!=null&&(e.SurveyTime=h);o.push(e)}o.length<=0||$("#gxList").find(".cancel1-btn").length<=0&&$("#gxList").find(".cancel2-btn").length<=0||(k=function(){var n={};n.opType=208;n.opData=JSON.stringify(o);ajaxPost("/Relay/Post",n,function(n){if(layer.msg(n.errmsg),n.errno==0){showChangeFlowCard(-1);var t=$("#changeFCName").html();getChangeFCName(t)}})},showConfirm("修改",k))}function getChangeFCName(n){var t={};t.opType=200;t.opData=JSON.stringify({flowCardName:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=n.datas[0],i=t.CategoryName+"-"+t.StepName,r=t.QualifiedNumber;$(trOne).find(".text-info").eq(0).html(i);$(trOne).find(".text-info").eq(2).html(r)})}function getProductionProcessList(){var r={},t={},u,n,i;if(r.opType=215,$(".jhHead .icb_minimal").is(":checked")){if(u=$("#selectJhList").val(),$(".jhHead .icb_minimal").eq(0).is(":checked")){if(isStrEmptyOrUndefined(u)){layer.msg("请选择计划号");return}t.productionName=u}if(n=$("#jhStartDate").val()+" 00:00:00",i=$("#jhEndDate").val()+" 23:59:59",exceedTime(n)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(n,i)){layer.msg("结束时间不能小于开始时间");return}if($(".jhHead .icb_minimal").eq(1).is(":checked")){if(isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(i)){layer.msg("请选择修改时间");return}t.startTime=n;t.endTime=i}r.opData=JSON.stringify(t)}ajaxPost("/Relay/Post",r,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=_permissionList[328].have,i=_permissionList[329].have,f='<button type="button" class="btn btn-primary" onclick="showProductionProcessModel({0})">详情<\/button>',e='<button type="button" class="btn btn-danger" onclick="deleteProductionProcess({0}, \'{1}\')">删除<\/button>',o=function(n){return(t?f.format(n.Id):"")+(i?e.format(n.Id,escape(n.ProductionProcessName)):"")},r=function(n,t,i,r){return++r.row},u=t||i,s=u?[{data:null,title:"操作",render:o,orderable:!1},{data:null,title:"序号",render:r},{data:"Id",title:"Id",bVisible:!1},{data:"MarkedDateTime",title:"修改时间"},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardCount",title:"总流程卡数",sClass:"text-info"},{data:"AllRawMaterialQuantity",title:"总原料数",sClass:"text-info"},{data:"Complete",title:"已完成流程卡数",sClass:"text-success"},{data:"RawMaterialQuantity",title:"已完成原料数",sClass:"text-success"},{data:"QualifiedNumber",title:"总产量",sClass:"text-warning"},{data:"PassRate",title:"总合格率",sClass:"text-warning"}]:[{data:null,title:"序号",render:r},{data:"Id",title:"Id",bVisible:!1},{data:"MarkedDateTime",title:"修改时间"},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardCount",title:"总流程卡数",sClass:"text-info"},{data:"AllRawMaterialQuantity",title:"总原料数",sClass:"text-info"},{data:"Complete",title:"已完成流程卡数",sClass:"text-success"},{data:"RawMaterialQuantity",title:"已完成原料数",sClass:"text-success"},{data:"QualifiedNumber",title:"总产量",sClass:"text-warning"},{data:"PassRate",title:"总合格率",sClass:"text-warning"}];$("#productionProcessList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,autoWidth:!0,language:oLanguage,data:n.datas,aaSorting:[[u?1:0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:s})})}function deleteProductionProcess(n,t){t=unescape(t);var i=function(){var t={};t.opType=221;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&(selectPlan(),getProductionProcessList())})};showConfirm("删除计划号："+t+"<p style='color:red'>该计划号的所有工艺也会被删除<\/p>",i)}function showProductionProcess(n){hideClassTip("adt");var t={};t.opType=216;ajaxPost("/Relay/Post",t,function(t){var u,r,i;if(t.errno!=0){layer.msg(t.errmsg);return}for($("#addSiteName").empty(),u='<option value="{0}">{1}<\/option>',r=0;r<t.datas.length;r++)i=t.datas[r],$("#addSiteName").append(u.format(i.Id,i.SiteName,i.RegionDescription,i.Manager));$("#updateId").html(n);$("#updateSiteName").val(adSiteNames);$("#updateRegions").val(locationsReg);$("#updateManager").val(manergerMan);$("#updateSite").modal("show")})}function showProductionProcessModel(n){var t=function(){var t,i;if(hideClassTip("adt"),$(".pp").addClass("hidden"),n!=0){if($("#uppBtn").removeClass("hidden"),$("#ppReBtn").removeClass("hidden"),$("#apGGBody").empty(),$("#apGXBody").empty(),apGGmax=apGGmaxV=apGXmax=apGXmaxV=1,n==-1&&recover==1)return;n==-1&&(recover=1);t={};t.opType=216;i=n==-1?$("#updateppId").html():n;t.opData=JSON.stringify({id:i});ajaxPost("/Relay/Post",t,function(t){var u,e,f,o,c,s,h,r,l;if(t.errno!=0){layer.msg(t.errmsg);return}for(u=t.datas[0],$("#updateppId").html(i),$("#productionProcessName").val(u.ProductionProcessName),r=0;r<u.Specifications.length;r++)e=u.Specifications[r],o='<tr id="apGG{0}" value="{2}"><td><label class="control-label" id="apGGx{0}">{1}<\/label><\/td><td><input class="form-control" value="{3}" id="apGGm{0}" maxlength="20"><\/td><td><input class="form-control" value="{4}" id="apGGz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="apGGDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(apGGmax,apGGmaxV,e.Id,e.SpecificationName,e.SpecificationValue),$("#apGGBody").append(o),apGGmax++,apGGmaxV++;for(r=0;r<u.ProcessSteps.length;r++)f=u.ProcessSteps[r],o='<tr id="apGX{0}" value="{2}"><td><label class="control-label" id="apGXx{0}">{1}<\/label><\/td><td><select class="ms2 yc form-control" id="apGXm{0}"><\/td><td><input class="form-control" value="{3}" id="apGXz{0}" onblur="autoCal(this, \'apGXh{0}\')" maxlength="100"><\/td><td><input class="form-control text-center" value="{4}" id="apGXh{0}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="apGXDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(apGXmax,apGXmaxV,f.Id,f.ProcessStepRequirements,f.ProcessStepRequirementMid),$("#apGXBody").append(o),apGXmax++,apGXmaxV++;if(DeviceProcessData!=null){for($(".yc").empty(),c='<option value="{0}">{1}-{2}<\/option>',s=0;s<DeviceProcessData.length;s++)h=DeviceProcessData[s],$(".yc").append(c.format(h.Id,h.CategoryName,h.StepName));for($(".yc").css("width","100%"),$(".yc").select2(),r=0;r<u.ProcessSteps.length;r++)f=u.ProcessSteps[r],l="#apGXm"+(r+1),$(l).val(f.ProcessStepId).trigger("change")}$(".dd").addClass("hidden");n!=-1?$("#productionProcessModel").modal("show"):recover=0})}else $("#appBtn").removeClass("hidden"),$("#productionProcessName").val(""),addResetGG(),addResetGX(),lastType!=n&&($("#productionProcessName").val(""),$("#appBtn").removeClass("hidden"),addResetGG(),addResetGX(),$(".dd").removeClass("hidden")),$("#productionProcessModel").modal("show");lastType=n};checkDeviceProcessData(t)}function checkDeviceProcessData(n){DeviceProcessData==null?ajaxPost("/Relay/Post",{opType:150},function(t){if(t.errno!=0){layer.msg(t.errmsg);return}DeviceProcessData=t.datas;n()}):n()}function addResetGG(){$("#apGGBody").empty();var n='<tr id="apGG{0}"><td><label class="control-label" id="apGGx{0}">{0}<\/label><\/td><td><input class="form-control" id="apGGm{0}" maxlength="20"><\/td><td><input class="form-control" id="apGGz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="apGGDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(1);$("#apGGBody").append(n);lastType==0?$(".dd").removeClass("hidden"):$(".dd").addClass("hidden");apGGmax=apGGmaxV=2}function addOtherGG(){var n='<tr id="apGG{0}" value="0"><td><label class="control-label" id="apGGx{0}">{1}<\/label><\/td><td><input class="form-control" id="apGGm{0}" maxlength="20"><\/td><td><input class="form-control" id="apGGz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="apGGDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(apGGmax,apGGmaxV);$("#apGGBody").append(n);apGGmax++;apGGmaxV++}function apGGDelSelf(n){var i,r,t;for($("#apGGBody").find("[id=apGG"+n+"]").remove(),apGGmaxV--,i=1,r=$("#apGGBody").find("label"),t=0;t<r.length;t++)r[t].textContent=i,i++}function addResetGX(){var r,n,u,t,i;if(apGXmax=apGXmaxV=1,$("#apGXBody").empty(),r='<tr id="apGX{0}" value="0"><td><label class="control-label" id="apGXx{0}">{0}<\/label><\/td><td><select class="ms2 form-control" id="apGXm{0}"><\/select> <td><input class="form-control" id="apGXz{0}" onblur="autoCal(this, \'apGXh{0}\')" maxlength="100"><\/td><td><input class="form-control text-center" id="apGXh{0}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="apGXDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(apGXmax),$("#apGXBody").append(r),DeviceProcessData!=null){for(n="#apGXm"+apGXmax,$(n).empty(),u='<option value="{0}">{1}-{2}<\/option>',t=0;t<DeviceProcessData.length;t++)i=DeviceProcessData[t],$(n).append(u.format(i.Id,i.CategoryName,i.StepName));$(n).css("width","100%");$(n).select2()}lastType==0?$(".dd").removeClass("hidden"):$(".dd").addClass("hidden");apGXmax++;apGXmaxV++}function addOtherGX(){var u='<tr id="apGX{0}" value="0"><td><label class="control-label" id="apGXx{0}">{1}<\/label><\/td><td><select class="ms2 form-control" id="apGXm{0}"><\/select> <td><input class="form-control" id="apGXz{0}" onblur="autoCal(this, \'apGXh{0}\')" maxlength="100"><\/td><td><input class="form-control text-center" id="apGXh{0}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="apGXDelSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(apGXmax,apGXmaxV),n,r,t,i;if($("#apGXBody").append(u),DeviceProcessData!=null){for(n="#apGXm"+apGXmax,$(n).empty(),r='<option value="{0}">{1}-{2}<\/option>',t=0;t<DeviceProcessData.length;t++)i=DeviceProcessData[t],$(n).append(r.format(i.Id,i.CategoryName,i.StepName));$(n).css("width","100%");$(n).select2()}apGXmax++;apGXmaxV++}function apGXDelSelf(n){var i,r,t;for($("#apGXBody").find("[id=apGX"+n+"]").remove(),apGXmaxV--,i=1,r=$("#apGXBody").find("label"),t=0;t<r.length;t++)r[t].textContent=i,i++}function addProductionProcess(){var o=$("#productionProcessName").val().trim(),r,n,u,f,t,s,e,h,i,c,l;if(isStrEmptyOrUndefined(o)){showTip($("#productionProcessNameTip"),"计划号不能为空");return}for(r=[],n=1;n<apGGmax;n++)if($("#apGG"+n).length>0){if(u=$("#apGGm"+n).val().trim(),isStrEmptyOrUndefined(u)){layer.msg("规格名不能为空");return}if(f=$("#apGGz"+n).val().trim(),isStrEmptyOrUndefined(f)){layer.msg("规格值不能为空");return}r.push({SpecificationName:u,SpecificationValue:f})}for(t=[],s=1,n=1;n<apGXmax;n++)if($("#apGX"+n).length>0){if(e=$("#apGXm"+n).val().trim(),isStrEmptyOrUndefined(e)){layer.msg("工序名称不能为空");return}if(h=$("#apGXz"+n).val().trim(),i=$("#apGXh"+n).val().trim(),isStrEmptyOrUndefined(i)||parseFloat(i)<=0){layer.msg("合格值必须大于0");return}t.push({ProcessStepOrder:s++,ProcessStepId:e,ProcessStepRequirements:h,ProcessStepRequirementMid:i})}if(t.length<=0){layer.msg("请填写工序");return}c={ProductionProcessName:o,Specifications:r,ProcessSteps:t};l=function(){$("#productionProcessModel").modal("hide");var n={};n.opType=220;n.opData=JSON.stringify(c);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&selectPlan()})};showConfirm("添加",l)}function updateProductionProcess(){var s=$("#productionProcessName").val().trim(),u,n,t,f,e,i,h,o,c,r,l,a;if(isStrEmptyOrUndefined(s)){showTip($("#productionProcessNameTip"),"计划号不能为空");return}for(u=[],n=1;n<apGGmax;n++)if($("#apGG"+n).length>0){if(f=$("#apGGm"+n).val().trim(),isStrEmptyOrUndefined(f)){layer.msg("规格名不能为空");return}if(e=$("#apGGz"+n).val().trim(),isStrEmptyOrUndefined(e)){layer.msg("规格值不能为空");return}t=$("#apGG"+n).attr("value");u.push({Id:t,SpecificationName:f,SpecificationValue:e})}for(i=[],h=1,n=1;n<apGXmax;n++)if($("#apGX"+n).length>0){if(o=$("#apGXm"+n).val().trim(),isStrEmptyOrUndefined(o)){layer.msg("工序名称不能为空");return}if(c=$("#apGXz"+n).val().trim(),r=$("#apGXh"+n).val().trim(),isStrEmptyOrUndefined(r)||parseFloat(r)<=0){layer.msg("合格值必须大于0");return}t=$("#apGX"+n).attr("value");i.push({Id:t,ProcessStepOrder:h++,ProcessStepId:o,ProcessStepRequirements:c,ProcessStepRequirementMid:r})}if(i.length<=0){layer.msg("请填写工序");return}l={id:parseInt($("#updateppId").html()),ProductionProcessName:s,Specifications:u,ProcessSteps:i};a=function(){$("#productionProcessModel").modal("hide");var n={};n.opType=218;n.opData=JSON.stringify(l);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getProductionProcessList()})};showConfirm("修改",a)}function getRawMateriaList(){var r={},t={},u,n,i;if(r.opType=232,$(".ylHead .icb_minimal").is(":checked")){if(u=$("#selectYlList").val(),$(".ylHead .icb_minimal").eq(0).is(":checked")){if(isStrEmptyOrUndefined(u)){layer.msg("请选择原料批号");return}t.rawMateriaName=u}if(n=$("#ylStartDate").val()+" 00:00:00",i=$("#ylEndDate").val()+" 23:59:59",exceedTime(n)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(n,i)){layer.msg("结束时间不能小于开始时间");return}if($(".ylHead .icb_minimal").eq(1).is(":checked")){if(isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(i)){layer.msg("请选择修改时间");return}t.startTime=n;t.endTime=i}r.opData=JSON.stringify(t)}ajaxPost("/Relay/Post",r,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=_permissionList[335].have,i=_permissionList[336].have,f=function(n){var r='<button type="button" class="btn btn-primary" onclick="showUpdateRawMateriaModel({0})">详情<\/button>'.format(n.Id),u='<button type="button" class="btn btn-danger" onclick="deleteRawMateria({0}, \'{1}\')">删除<\/button>'.format(n.Id,escape(n.RawMateriaName));return"{0}{1}".format(t?r:"",i?u:"")},r=function(n,t,i,r){return++r.row},u=t||i,e=u?[{data:null,title:"操作",render:f,orderable:!1},{data:null,title:"序号",render:r},{data:"Id",title:"Id",bVisible:!1},{data:"MarkedDateTime",title:"修改时间"},{data:"RawMateriaName",title:"原料批号"}]:[{data:null,title:"序号",render:r},{data:"Id",title:"Id",bVisible:!1},{data:"MarkedDateTime",title:"修改时间"},{data:"RawMateriaName",title:"原料批号"}];$("#rawMateriaList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,autoWidth:!0,language:oLanguage,data:n.datas,aaSorting:[[u?1:0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:e})})}function deleteRawMateria(n,t){t=unescape(t);var i=function(){var t={};t.opType=239;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&(selectRaw(),getRawMateriaList())})};showConfirm("删除原料："+t,i)}function showUpdateRawMateriaModel(n,t=0){$("#urRawMateriaName").val("");$("#urBody").empty();uMax=uMaxV=1;var i={};(i.opType=233,i.opData=JSON.stringify({id:n}),t!=1||rec!=1)&&(t==1&&(rec=1),ajaxPost("/Relay/Post",i,function(i){var r,u,f,e;if(i.errno!=0){layer.msg(i.errmsg);return}for(r=i.datas[0],$("#updateId").html(n),$("#urRawMateriaName").val(r.RawMateriaName),u=0;u<r.RawMateriaSpecifications.length;u++)f=r.RawMateriaSpecifications[u],e='<tr id="ur{0}" value="{2}"><td><label class="control-label" id="urx{0}">{1}<\/label><\/td><td><input class="form-control" value="{3}" id="urm{0}" maxlength="20"><\/td><td><input class="form-control" value="{4}" id="urz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="delSelf1({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(uMax,uMaxV,f.Id,f.SpecificationName,f.SpecificationValue),$("#urBody").append(e),uMax++,uMaxV++;t==0?$("#updateRawMateriaModel").modal("show"):rec=0}))}function updateRawMateria(){var u=$("#urRawMateriaName").val().trim(),t,n,f,i,r,e,o;if(isStrEmptyOrUndefined(u)){showTip($("#urRawMateriaNameTip"),"原料批次不能为空");return}for(t=[],n=1;n<uMax;n++)if($("#ur"+n).length>0){if(f=$("#ur"+n).attr("value"),i=$("#urm"+n).val().trim(),isStrEmptyOrUndefined(i)){layer.msg("规格名不能为空");return}if(r=$("#urz"+n).val().trim(),isStrEmptyOrUndefined(r)){layer.msg("规格值不能为空");return}t.push({Id:f,SpecificationName:i,SpecificationValue:r})}e={id:parseInt($("#updateId").html()),RawMateriaName:u,RawMateriaSpecifications:t};o=function(){$("#updateRawMateriaModel").modal("hide");var n={};n.opType=235;n.opData=JSON.stringify(e);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getRawMateriaList()})};showConfirm("修改",o)}function recovery(){var n=parseInt($("#updateId").html());showUpdateRawMateriaModel(n,1)}function addOther1(){var n='<tr id="ur{0}" value="0"><td><label class="control-label" id="urx{0}">{1}<\/label><\/td><td><input class="form-control" id="urm{0}" maxlength="20"><\/td><td><input class="form-control" id="urz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="delSelf1({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(uMax,uMaxV);$("#urBody").append(n);uMax++;uMaxV++}function delSelf1(n){var i,r,t;for($("#urBody").find("[id=ur"+n+"]").remove(),uMaxV--,i=1,r=$("#urBody").find("label"),t=0;t<r.length;t++)r[t].textContent=i,i++}function reset1(){$("#urBody").empty();uMax=uMaxV=1}function showAddRawMateriaModel(){hideClassTip("adt");$("#arRawMateriaName").val("");reset();$("#addRawMateriaModel").modal("show")}function reset(){$("#arBody").empty();var n='<tr id="ar{0}"><td><label class="control-label" id="arx{0}">{0}<\/label><\/td><td><input class="form-control" id="arm{0}" maxlength="20"><\/td><td><input class="form-control" id="arz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="delSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(1);$("#arBody").append(n);max=maxV=2}function addOther(){var n='<tr id="ar{0}"><td><label class="control-label" id="arx{0}">{1}<\/label><\/td><td><input class="form-control" id="arm{0}" maxlength="20"><\/td><td><input class="form-control" id="arz{0}" maxlength="20"><\/td><td><button type="button" class="btn btn-default btn-sm" onclick="delSelf({0})"><i class="fa fa-minus"><\/i> 删除<\/button><\/td><\/tr>'.format(max,maxV);$("#arBody").append(n);max++;maxV++}function delSelf(n){var i,r,t;for($("#arBody").find("[id=ar"+n+"]").remove(),maxV--,i=1,r=$("#arBody").find("label"),t=0;t<r.length;t++)r[t].textContent=i,i++}function addRawMateria(){var u=$("#arRawMateriaName").val().trim(),t,n,i,r,f,e;if(isStrEmptyOrUndefined(u)){showTip($("#arRawMateriaNameTip"),"原料批次不能为空");return}for(t=[],n=1;n<max;n++)if($("#ar"+n).length>0){if(i=$("#arm"+n).val().trim(),isStrEmptyOrUndefined(i)){layer.msg("规格名不能为空");return}if(r=$("#arz"+n).val().trim(),isStrEmptyOrUndefined(r)){layer.msg("规格值不能为空");return}t.push({SpecificationName:i,SpecificationValue:r})}f={RawMateriaName:u,RawMateriaSpecifications:t};e=function(){$("#addRawMateriaModel").modal("hide");var n={};n.opType=237;n.opData=JSON.stringify(f);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&selectRaw()})};showConfirm("添加",e)}var _permissionList=[],trOne=null,ufRecover=0,ufGGmax=1,ufGGmaxV=1,ufGXmax=1,ufGXmaxV=1,cfRecover=0,gxLength=1,DeviceProcessData=null,recover=0,lastType=-2,apGGmax=2,apGGmaxV=2,apGXmax=2,apGXmaxV=2,uMax=1,uMaxV=1,rec=0,max=2,maxV=2;