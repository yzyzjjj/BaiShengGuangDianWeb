function pageReady(){var n,i,r;$(".sidebar-mini").addClass("sidebar-collapse");_permissionList[675]={uIds:[]};_permissionList[676]={uIds:["firstNavLi","setKanBan"]};_permissionList=checkPermissionUi(_permissionList);$("#kanBanList").select2();$("#deviceSelect").select2({allowClear:!0,placeholder:"请选择",multiple:!0});$("#navUl").on("click","a",function(){var n=$(this).attr("href").replace("#",""),f=n.replace("kanBan_","");const u=parseInt(f);if(curId!=u){curId=u;let r=-1;const i=kanBans[curId];i&&(r=i.Type);timeEl=n;r==2&&$(`#${n}_deviceState`).empty();curId>-1?(dsDivs[curId]=[],dsPaths[curId]=[],page[curId]=0,setChart(n,curId,r),clearInterval(uiTime),clearInterval(dataTime),t=(i.UI<1?1:i.UI)*1e3,uiTime=setInterval(()=>{run||setChart(n,curId,r,!0)},t),t=(i.Second<1?1:i.Second)*1e3,dataTime=setInterval(()=>{run||setChart(n,curId,r)},t)):(kanBanProductItemsEl.forEach(n=>{for(var t in n)~t.indexOf("_timer")&&stopScrollTable(n,t,t.replace("_timer",""))}),clearInterval(uiTime),clearInterval(dataTime))}});$(".content").on("click",".fullScreenBtn",function(){var t=`#${$(this).attr("target")}`,n;$(t).toggleClass("panel-fullscreen");n=$(t).hasClass("panel-fullscreen");$(this).toggleClass("glyphicon-fullscreen glyphicon-repeat").prop("title",n?"还原":"全屏放大");n?$(this).addClass("fsb"):$(this).removeClass("fsb");fullScreen(n);n||kanBanProductItemsEl.forEach(n=>{for(var t in n)~t.indexOf("_timer")&&stopScrollTable(n,t,t.replace("_timer",""))})});setInterval(()=>{$(`#${timeEl}_time`).length>0&&$(`#${timeEl}_time`).text(getFullTime()),$(`#${carouselFlag}_time`).length>0&&$(`#${carouselFlag}_time`).text(getFullTime())},1e3);n=function(){$("#kanBanLength").val(($("#kanBanRow").val()>>0)*($("#kanBanCol").val()>>0));let n=$(this).val()>>0;n==0&&(n=1,$(this).val(n));n>15&&(n=15,$(this).val(n));const t=$("#kanBanType").val()>>0;t==3&&initColSet(!1)};$("#kanBanRow").on("input",n);$("#kanBanCol").on("input",n);$("#kanBanList").on("select2:select",function(){var t=$(this).val(),n,i,r;t&&(n=kanBans[t],$("#kanBanName").val(n.Name),$("#kanBanOrder").val(n.Order),$("#isShow").iCheck(n.IsShow?"check":"uncheck"),$("#setKanBan .stateEl").addClass("hidden"),$("#setKanBan .stateEl1").addClass("hidden"),$("#setKanBan .productEl").addClass("hidden"),$("#kanBanUI").val(n.UI),$("#kanBanSecond").val(n.Second),n.Type==2?($("#kanBanRow").val(n.Row),$("#kanBanCol").val(n.Col),$("#kanBanContentCol").val(n.ContentCol),$("#kanBanLength").val(n.Length),$("#setKanBan .stateEl").removeClass("hidden"),scriptIndexTmp=[],scriptTmp=[],n.ContentCol>2&&($("#kanBanItemColNameDiv").removeClass("hidden"),i=getFirstOrders(n.ContentCol),r=`（首列顺序：${i.join()}）`,$("#kanBanContentColDesc").text(r),initColName(!0)),$("#kanBanScript").html("")):n.Type==3&&($("#kanBanRow").val(n.Row),$("#kanBanCol").val(n.Col),$("#setKanBan .productEl").removeClass("hidden"),initColSet(!0),initProduct(n.Type),showPreProduct()),$("#deviceSelect").val(n.DeviceIdList).trigger("change"))});$("#deviceSelect").on("select2:select",function(){var n=$(this).val();~n.indexOf("0")&&$(this).val(deviceIds).trigger("change")}).on("change",function(){const n=$(this).val();if(isStrEmptyOrUndefined(n)){scriptIndexTmp=[];scriptTmp=[];$("#kanBanScript").html("");return}var t=[];n.forEach(n=>{if(n!=0){var i=deviceTmp[n].ScriptId;~t.indexOf(i)||t.push(i);~scriptIndexTmp.indexOf(i)?existArrayObj(scriptTmp[i].ds,"id",n)||scriptTmp[i].ds.push({id:n,code:deviceTmp[n].Code}):(scriptIndexTmp.push(i),scriptTmp[i]={sId:i,sName:deviceTmp[n].ScriptName,ds:[{id:n,code:deviceTmp[n].Code}]})}});scriptIndexTmp=t;scriptTmp.forEach(t=>{const i=t.sId;if(~scriptIndexTmp.indexOf(i)){const t=scriptTmp[i].ds.map(n=>n.id);t.forEach(t=>{~n.indexOf(t)||removeArray(scriptTmp[i].ds,"id",t)});scriptTmp[i].ds.length==0&&delete scriptTmp[i]}else scriptTmp[i].div&&$(`#${scriptTmp[i].div}`).remove(),delete scriptTmp[i]});const i=$("#kanBanType").val();i==2&&getScriptList()});i=new Promise(n=>getDevice(n));r=new Promise(n=>getKanBanList(n));Promise.all([i,r]).then(n=>{const i=n[0],t=n[1];t.length>0&&$("#kanBanList").trigger("select2:select")});$("#kanBanType").on("change",function(){const n=$(this).val(),i=$(this).find(`[value=${n}]`).css("color");$(this).css("color",i);$("#setKanBan .stateEl").addClass("hidden");$("#setKanBan .productEl").addClass("hidden");const t=kanBans.filter(t=>t.Type==n&&t.Id!=0);let r=0;const u=t.reduce((t,i)=>i.Id!==0&&i.Type==n?`${t}<option value=${i.Id}>${++r}-${i.Name}</option>`:"","");if($("#kanBanList").html(u),t.length>0){const n=t[0];$("#kanBanList").val(n.Id).trigger("select2:select")}});$("#kanBanItemColSet").on("input",".kb_item_col2",function(){let n=$(this).val()>>0;const r=$(this).attr("id");let t=0;$("#kanBanItemColSet .kb_item_col2").each((n,i)=>{let u=$(i).attr("id");r!=u&&(t+=$(i).val()>>0)});const i=100-t;n>i&&(n=i,$(this).val(n));initColSet(!1)});$("#kanBanContentCol").on("input",function(){const n=$(this).val();let t="";if(n>2){var i=getFirstOrders(n);t=`（首列顺序：${i.join()}）`;$("#kanBanItemColNameDiv").removeClass("hidden");initColName(!1)}else $("#kanBanItemColNameDiv").addClass("hidden");$("#kanBanContentColDesc").text(t);scriptIndexTmp.forEach(n=>{if(scriptTmp[n]){const t=scriptTmp[n],u=`${t.divVal}Data`,f=`${t.divIn}Data`,e=`${t.divOut}Data`,o=`${t.divProduct}Data`,i=[t.divVal,t.divIn,t.divOut,t.divProduct],r=[u,f,e,o];disabledChose(t,r,i);enableChose(t,r,i)}})});$("#kanBanItems").on("ifChanged",".icb_minimal",function(){const t=$(this),n=t.val().trim()>>0,i=t.attr("name");if(t.is(":checked")&&!existArray(kanBanItemsTmp,n)){kanBanItemsTmp.push(n);const t=colSet[0].chose.length;colSet[0].chose.push({name:i,val:n,col:0,order:t,height:-1})}else!t.is(":checked")&&existArray(kanBanItemsTmp,n)&&(kanBanItemsTmp=kanBanItemsTmp.filter(t=>t!=n),colSet.forEach(t=>{var i=[],r=0;t.chose.forEach(t=>{t.val!==n&&(t.order=r++,i.push(t))});t.chose=i}));showPreProduct()});$("#kanBanProductDetail").on("change",".colSet",function(){var n=colSet.map(n=>({width:n.width,chose:[]}));const t=$("#kanBanProductDetail .kb_div1");t.each((t,i)=>{var r=$(i).attr("val")>>0,e=$(i).find(`.N_${r}`).text(),u=($(i).find(`.C_${r}`).val()>>0)-1,o=($(i).find(`.O_${r}`).val()>>0)-1,f=$(i).find(`.H_${r}`).val();n[u]&&n[u].chose.push({name:e,val:r,col:u,order:o,height:isStrEmptyOrUndefined(f)?-1:f>>0})});n.forEach(n=>{n.chose=n.chose.sort(sortOrder);for(let t=0,i=n.chose.length;t<i;t++)n.chose[t].order=t});colSet=n;showPreProduct()});$("#kanBanProductDetail").on("click",".upTr",function(){const i=$(this).closest(".kb_div1"),r=$(i).attr("val")>>0,n=($(i).find(`.C_${r}`).val()>>0)-1,t=($(i).find(`.O_${r}`).val()>>0)-1;colSet[n]&&colSet[n].chose&&(colSet[n].chose[t].order=t-1,colSet[n].chose[t-1].order=t,colSet[n].chose=colSet[n].chose.sort(sortOrder));showPreProduct()});$("#kanBanProductDetail").on("click",".downTr",function(){const i=$(this).closest(".kb_div1"),r=$(i).attr("val")>>0,n=($(i).find(`.C_${r}`).val()>>0)-1,t=($(i).find(`.O_${r}`).val()>>0)-1;colSet[n]&&colSet[n].chose&&(colSet[n].chose[t].order=t+1,colSet[n].chose[t+1].order=t,colSet[n].chose=colSet[n].chose.sort(sortOrder));showPreProduct()})}function initColName(n=true){let t=$("#kanBanContentCol").val()>>0;const u=$("#kanBanList").val(),i=kanBans[u];i&&(n&&(t=i.ContentCol),n&&(colName=i.ColName?i.ColName.split(","):[]));let r=colName.length;if(t>r)for(let n=colName.length,i=t;n<i;n++)colName[n]||(colName[n]="");else colName=sliceArray(colName,t);var f=Array.from($("#kanBanItemColName .kb_item_col2").map((n,t)=>t.value));for(let n=0,t=colName.length;n<t;n++){const t=f[n];t&&(colName[n]=t)}if(n){let n="";for(let i=0;i<t;i++){const t=colName[i];n+=`<div class="input-group kb_item_div1">
                    <span class="text-bold input-group-addon kb_item_col1">列${i+1}：</span>
                    <input class="form-control kb_item_col2" id="kanBanItemColName${i}" value=${t}>
                </div>`}$("#kanBanItemColName").html(n);return}if(r=$("#kanBanItemColName .kb_item_col2").length,t>r){let n="";for(let i=0,r=t;i<r;i++)$(`#kanBanItemColName${i}`).length||(n+=`<div class="input-group kb_item_div1">
                        <span class="text-bold input-group-addon kb_item_col1">列${i+1}：</span>
                        <input class="form-control kb_item_col2" id="kanBanItemColName${i}">
                    </div>`);$("#kanBanItemColName").append(n)}else{for(let n=r-1;n>=t;n--)$(`#kanBanItemColName${n}`).closest(".kb_item_div1").addClass("rm");$("#kanBanItemColName .rm").remove()}}function initColSet(n=true){var u,f,e;let t=$("#kanBanCol").val()>>0;const o=$("#kanBanList").val(),r=kanBans[o];r&&(n&&(t=r.Col),n&&(colSet=r.ColSet?JSON.parse(r.ColSet):[]));let i=colSet.length;if(t>i)for(let n=colSet.length,i=t;n<i;n++)colSet[n]||(colSet[n]={width:0,chose:[]});else{for(let n=i-1;n>=t;n--){let t=colSet[n].chose.length;if(t)for(u=0,f=colSet[n].chose.length;u<f;u++){const i=colSet[n].chose[u];i.order=t++;colSet[0].chose.push(i)}}colSet=sliceArray(colSet,t)}if(!n){e=Array.from($("#kanBanItemColSet .kb_item_col2").map((n,t)=>({width:t.value>>0})));for(let n=0,t=colSet.length;n<t;n++){const t=e[n];t&&(colSet[n].width=t.width)}}if(n){let n="";for(let i=0;i<t;i++){const t=colSet[i];n+=`<div class="input-group kb_item_div1">
                    <span class="text-bold input-group-addon kb_item_col1">列${i+1}：</span>
                    <input class="form-control kb_item_col2" id="kanBanItemCol${i}" value=${t.width} oninput="onInput(this, 3, 0);">
                    <span class="input-group-addon kb_item_col3">%</span>
                </div>`}$("#kanBanItemColSet").html(n);return}if(i=$("#kanBanItemColSet .kb_item_col2").length,t>i){let n="";for(let i=0,r=t;i<r;i++)$(`#kanBanItemCol${i}`).length||(n+=`<div class="input-group kb_item_div1">
                        <span class="text-bold input-group-addon kb_item_col1">列${i+1}：</span>
                        <input class="form-control kb_item_col2" id="kanBanItemCol${i}" value=0 oninput="onInput(this, 3, 0);">
                        <span class="input-group-addon kb_item_col3">%</span>
                    </div>`);$("#kanBanItemColSet").append(n)}else{for(let n=i-1;n>=t;n--)$(`#kanBanItemCol${n}`).closest(".kb_item_div1").addClass("rm");$("#kanBanItemColSet .rm").remove()}showPreProduct()}function initProduct(n){const i=$("#kanBanList").val(),t=kanBans[i];kanBanItemsTmp=[];t&&t.ItemList&&(kanBanItemsTmp=t.ItemList);const r=kanBanItems[n]?kanBanItems[n]:[],u=r.reduce((t,i)=>`${t}<div class="flexStyle pointer choseBox">
                        <label class="flexStyle pointer">
                            <input type="checkbox" class="icb_minimal" ${~kanBanItemsTmp.indexOf(i.Id)?'checked="checked"':""} value="${i.Id}" type="${n}" name="${i.Type}">
                            <span class="textOverTop mPadding">${i.Type}</span>
                        </label>
                    </div>`,"");$("#kanBanItems").empty().append(u);$(`#kanBanItems .icb_minimal`).iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"})}function showPreProduct(){$("#kanBanProduct h3").text($("#kanBanName").val());const n=colSet.length,t=colSet.reduce((t,i)=>{i.chose=i.chose.sort(sortOrder);const r=i.chose.length,u=r>1?4:3,f=r>1?"":" hidden",e=i.chose.reduce((t,i,e)=>`${t}<div class="kb_div1" style="height: ${i.height==-1?"auto":`${i.height}%`}" val="${i.val}">
                    <div class="kb_border1">
                        <div class="kb_border2" style="padding: 5px;">
                            <table class="table table-striped no-margin">
                                <thead>
                                    <tr role="row">
                                        <th colspan="${u}" class="bg-gray N_${i.val}" style="padding: 4px; border: 1px solid gray; width: auto;">${i.name}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr role="row" class="odd">
                                        <td style="padding: 4px; border: 1px solid gray;" class="form-inline">
                                            列<input class="form-control text-center colSet C_${i.val}" style="width: 50%;" value=${i.col+1} oninput="onInput(this, 3, 0, 1, ${n});">
                                        </td>
                                        <td style="padding: 4px; border: 1px solid gray;" class="form-inline">
                                            顺序<input class="form-control text-center colSet O_${i.val}" readonly="readonly" style="width: 50%;" value=${i.order+1} oninput="onInput(this, 3, 0, 1);">
                                        </td>
                                        <td style="padding: 4px; border: 1px solid gray;" class="form-inline">
                                            高度<input class="form-control text-center colSet H_${i.val}" style="width: 50%;" value="${i.height==-1?"":i.height}" oninput="onInput(this, 3, 0, 0, 100);">%
                                        </td>
                                        <td style="padding: 4px; border: 1px solid gray;" class="form-inline ${f}">
                                            <span class="glyphicon glyphicon-arrow-up pointer text-green${e==0?" hidden":""} upTr" aria-hidden="true" title="上移"></span>
                                            <span class="glyphicon glyphicon-arrow-down pointer text-red${e+1==r?" hidden":""} downTr" aria-hidden="true" title="下移"></span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`,"");return`${t}<div class="kb_item_pre_div3" style="width: ${i.width}%; overflow-y: auto;">
                    ${e}
                 </div>`},"");$("#kanBanProductDetail").html(t)}function getDevice(n){if(_permissionList[676].have){var t={opType:100,opData:JSON.stringify({detail:!0,other:!0,state:!1})};ajaxPost("/Relay/Post",t,t=>{var i,e;if(t.errno!=0){layer.msg(t.errmsg);return}var r=SortNumberString(t.datas,"Code"),u='<option value="0">全部<\/option>',f=[];for(i=0,e=r.length;i<e;i++){const n=r[i];deviceTmp[n.Id]=n;u+=`<option value=${n.Id}>${n.Code}</option>`;f.push(n.Id)}$("#deviceSelect").empty().append(u);n(f)},0)}}function getKanBanList(n){const t=$("#kanBanList").val();var i={opType:509,opData:JSON.stringify({init:!0})};ajaxPost("/Relay/Post",i,i=>{var e,f,l,u,o,g,nt,r,c,tt;if(i.errno!=0){layer.msg(i.errmsg);return}e=$("#kanBanType").val();$("#kanBanType").html(`${setOptions(i.menu,"Type",!0)}`);e?$("#kanBanType").val(e):$("#kanBanType").trigger("change");e=$("#kanBanType").val();kanBanItems=i.item;f=i.data;const p=f.length;if(!(p<=0)){l=`<div class="box box-primary">
                    <div class="box-header with-border">
                        <label class="control-label textOverTop no-margin middle">时间信息：<span id="{0}_time"></span></label>
                        <span class="glyphicon glyphicon-fullscreen pointer fullScreenBtn {1}" target="{0}"
                            style="position: absolute; right: 15px; top: 15px; font-size: 20px;z-index:1" title="全屏放大" aria-hidden="true"></span>
                    </div>
                    <div>
                         <div class="row">
                            <div class="col-md-4">
                                <div class="box box-info">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">设备详情</h3>
                                    </div>
                                    <div class="box-body">
                                        <div class="flexStyle">
                                            <div id="{0}_detail" class="chart" style="width: 40%; height: 140px"></div>
                                            <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                                <label class="control-label textOverTop">运行时间：<span class="spanStyle" id="{0}_yxTime"></span></label>
                                                <label class="control-label textOverTop">加工时间：<span class="spanStyle" id="{0}_jgTime"></span></label>
                                                <label class="control-label textOverTop">闲置时间：<span class="spanStyle" id="{0}_xzTime"></span></label>
                                                <label class="control-label textOverTop">所有利用率：<span class="spanStyle" id="{0}_lly"></span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="box box-warning">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">日最大使用率</h3>
                                    </div>
                                    <div class="box-body">
                                        <div class="flexStyle">
                                            <div id="{0}_max" class="chart" style="width: 40%; height: 140px"></div>
                                            <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                                <label class="control-label textOverTop">日最大同时使用台数：<span class="spanStyle" id="{0}_maxTs"></span></label>
                                                <label class="control-label textOverTop">日最大使用台数：<span class="spanStyle" id="{0}_maxTNum"></span></label>
                                                <label class="control-label textOverTop">日最大使用率：<span class="spanStyle" id="{0}_maxSyl"></span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="box box-warning">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">日最小使用率</h3>
                                    </div>
                                    <div class="box-body">
                                        <div class="flexStyle">
                                            <div id="{0}_min" class="chart" style="width: 40%; height: 140px"></div>
                                            <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                                <label class="control-label textOverTop">日最小同时使用台数：<span class="spanStyle" id="{0}_minTs"></span></label>
                                                <label class="control-label textOverTop">日最小使用台数：<span class="spanStyle" id="{0}_minTNum"></span></label>
                                                <label class="control-label textOverTop">日最小使用率：<span class="spanStyle" id="{0}_minSyl"></span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="box box-info">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">设备状态</h3>
                                    </div>
                                    <div class="box-body">
                                        <div style="width: 100%;display:flex;flex-wrap:wrap">
                                            <div id="{0}_state_all" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_normal" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_process" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_idle" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_fault" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_error" class="chart" style="height:180px;width:33.33%"></div>
                                        </div>
                                        <label class="control-label textOverTop">当前加工设备：</label>
                                        <div id="{0}_dev" style="width: 100%;display:flex;flex-wrap:wrap"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="box box-success">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">单台加工利用率</h3>
                                    </div>
                                    <div class="box-body">
                                        <div id="{0}_bar" class="chart" style="width: 100%; height: 480px"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="box box-success">
                            <div class="box-header with-border">
                                <h3 class="box-title">生产数据</h3>
                            </div>
                            <div class="box-body">
                                <div>
                                    <label class="control-label textOverTop"><span class="text-red">加工设备数：</span><span class="spanStyle" id="{0}_devs"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">加工数：</span><span class="spanStyle" id="{0}_pros"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">合格数：</span><span class="spanStyle" id="{0}_heGes"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">裂片数：</span><span class="spanStyle" id="{0}_liePians"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">合格率：</span><span class="spanStyle" id="{0}_rates"></span></label>
                                </div>
                                <div style="overflow-y: auto">
                                    <table border="1" class="table-td">
                                        <tbody>
                                            <tr id="{0}_devOps">
                                                <td class="text-red bg-info">机台号</td>
                                            </tr>
                                            <tr id="{0}_proOps">
                                                <td class="text-red bg-info">加工数</td>
                                            </tr>
                                            <tr id="{0}_heGeOps">
                                                <td class="text-red bg-info">合格数</td>
                                            </tr>
                                            <tr id="{0}_liePianOps">
                                                <td class="text-red bg-info">裂片数</td>
                                            </tr>
                                            <tr id="{0}_rateOps">
                                                <td class="text-red bg-info">合格率</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;const w=`<div class="kb_div1">
                <div class="kb_border1">
                <div class="kb_border2">
                <div class="form-group no-margin ttDiv">
                    <label class="control-label textOverTop no-margin middle kb_time1">时间信息：<span id="{0}_time"></span></label>
                    <h3 class="text-bold kb_title1" style="color: cyan; padding: 10px;">监控平台</h3>
                    <span class="glyphicon glyphicon-fullscreen pointer kb_fullscreen1 fullScreenBtn {1}" target="{0}" title="全屏放大" aria-hidden="true"></span>
                    <div class="form-group no-margin mPadding">
                        <label class="control-label text-bold no-margin bg-green mPadding text-center" style="width: 15%; font-size: 17px;">
                            加工：<label class="control-label no-margin" id="{0}_jg" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin mPadding text-center" style="width: 15%; font-size: 17px; background: #f47920; color:white;">
                            闲置：<label class="control-label no-margin" id="{0}_xz" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin bg-blue mPadding text-center" style="width: 15%; font-size: 17px;">
                            正常：<label class="control-label no-margin" id="{0}_zc" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin bg-red mPadding text-center" style="width: 15%; font-size: 17px;">
                            故障：<label class="control-label no-margin" id="{0}_gz" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin mPadding text-center" style="width: 15%; font-size: 17px; background: gray; color:white;">
                            未连接：<label class="control-label no-margin" id="{0}_wlj" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin mPadding text-center" style="width: 15%; color: cyan; font-size: 17px;">
                            共：<label class="control-label no-margin" id="{0}_sum" style="font-size: 17px;">0</label>台
                        </label>
                    </div>
                </div>
                <div class="box box-primary no-box-shadow no-margin kb_div2 dsDiv">
                    <div class="box-header no-padding">
                    </div>
                    <div class="box-body no-padding">
                        <div class="kb_flex_div1" id="{0}_deviceState">
                        </div>
                    </div>
                </div>
                </div>
                </div>
            </div>`,b=`<div class="form-group no-margin">
                        <div class="form-group text-center no-margin">
                <label class="control-label textOverTop no-margin middle kb_time1" style="transform: translateY(-50%);">时间信息：<span id="{0}_time"></span></label>
                <h3 class="text-bold kb_title1" style="color: cyan; padding: 10px;">{1}</h3>
                <span class="glyphicon glyphicon-fullscreen pointer kb_fullscreen2 fullScreenBtn {2}" target="{0}" title="全屏放大" aria-hidden="true"></span>
                        </div>
                <div class="box box-primary kb_body no-border-top no-margin">
                    <div class="box-body kb_item_pre_div2" id="{0}_productDiv">{3}
                    </div>
                </div>
            </div>`;u=`<div class="kb_div1" style="height: {2}" val="{3}">
                <div class="kb_border1">
                    <div class="kb_border2">
                        <div class="form-group text-center no-margin" style="">
                            <h4 class="text-bold kb_title2">{1}</h4>
                        </div>
                        <div class="table-responsive mailbox-messages no-margin" style="width:100%">
                            {0}
                        </div>
                    </div>
                </div>
            </div>`;kanBanProductItemsEl[1]={name:"合格率异常报警",isTable:!0,dataSource:"WarningLogs",trFlag:"Id",order:"desc",cols:[{data:"XvHao",title:"序号"},{data:null,title:"时间",render:n=>convertTimeHMS(n.WarningTime)},{data:"Code",title:"机台号"},{data:"Value",title:"合格率",suffix:"%"},{data:null,title:"信息",render:n=>n.WarningData&&n.WarningData.length>0?JSON.parse(n.WarningData[0].Param).join():""}],div:"itemRateWarningDiv",op:u};kanBanProductItemsEl[2]={name:"合格率异常统计",isTable:!0,dataSource:"WarningStatistics",order:"asc",trFlag:"XvHao",cols:[{data:"XvHao",title:"序号"},{data:null,title:"时间",render:n=>getDate(n.Time)},{data:"SetName",title:"预警设置"},{data:"Item",title:"名称"},{data:"Range",title:"条件"},{data:"Count",title:"预警次数",suffix:"次"},],div:"itemRateWarningSumDiv",op:u};kanBanProductItemsEl[3]={name:"设备状态反馈",isTable:!0,dataSource:"DeviceStateInfos",trFlag:"DeviceId",order:"asc",cols:[{data:"XvHao",title:"序号"},{data:"Code",title:"机台号"},{data:null,title:"待机时间",render:n=>codeTime(n.IdleSecond)}],div:"itemDeviceSateDiv",op:u};kanBanProductItemsEl[4]={name:"设备预警状态",isTable:!0,dataSource:"WarningDeviceInfos",trFlag:"DeviceId",order:"desc",cols:[{data:"XvHao",title:"序号"},{data:"Code",title:"机台号"},{data:"Time",title:"时间"},{data:"Item",title:"名称"},{data:"Range",title:"条件"},{data:"Value",title:"预警值"},],div:"itemDeviceWarningSateDiv",op:u};kanBanProductItemsEl[5]={name:"计划号日进度表",isTable:!0,dataSource:"ProductionSchedules",trFlag:"ProductionId",order:"asc",cols:[{data:"XvHao",title:"序号"},{data:"Production",title:"计划号"},{data:"Plan",title:"计划"},{data:"Actual",title:"实际"},],div:"itemProductionDayScheduleDiv",op:u};kanBanProductItemsEl[6]={name:"设备日进度表",isTable:!0,dataSource:"DeviceSchedules",trFlag:"DeviceId",order:"asc",cols:[{data:"XvHao",title:"序号"},{data:"Code",title:"机台号"},{data:"Plan",title:"计划"},{data:"Actual",title:"实际"},],div:"itemDeviceDayScheduleDiv",op:u};kanBanProductItemsEl[7]={name:"操作工日进度表",isTable:!0,dataSource:"ProcessorSchedules",trFlag:"ProcessorId",order:"asc",cols:[{data:"XvHao",title:"序号"},{data:"Processor",title:"操作工"},{data:"Plan",title:"计划"},{data:"Actual",title:"实际"},],div:"itemProcessorDayScheduleDiv",op:u};o=`<div class="tab-pane {2} {3}" id="{0}">{1}</div>`;const a=`<div class="item kb_body" id="{0}">{1}<div class="carousel-caption text-primary"><h3 class="text-primary isShow hidden">{2}</h3></div></div>`;let v=!_permissionList[676].have;const y=f.filter(n=>n.Type==e&&n.Id!=0);let it=0;const rt=y.reduce((n,t)=>t.Id!==0&&t.Type==e?`${n}<option value=${t.Id}>${++it}-${t.Name}</option>`:"","");if($("#kanBanList").html(rt),t)$("#kanBanList").val(t);else if(y.length>0){const n=y[0];$("#kanBanList").val(n.Id)}var k="",d="",s="",h="";carouselTmp=[];g=0;for(let n=0;n<p;n++){const t=f[n];kanBans[t.Id]=t;const i=$("#kanBanType").find(`[value=${t.Type}]`).css("color");if(k+=`<div class="flexStyle pointer choseBox mPadding">
                        <label class="flexStyle pointer">
                            <input type="checkbox" class="icb_minimal" value=${t.Id}>
                            <span style="margin-left: 5px">${t.Name}</span>
                        </label>
                    </div>`,t.IsShow){nt=v&&n==0?' class="active"':"";r=`kanBan_${t.Id}`;d+=`<li${nt}><a href="#${r}" class="kanBan text-bold" data-toggle="tab" aria-expanded="false" style="${i?`color: ${i};`:""}">${t.Name}(${t.Order})</a></li>`;const u=`carousel_${r}`;c=v&&n==0?" active":" fade in";switch(t.Type){case 1:s+=o.format(r,l.format(r,""),"",c);h=a.format(u,l.format(u,"hidden"),t.Name);break;case 2:s+=o.format(r,w.format(r,""),"kb_body",c);h=a.format(u,w.format(u,"hidden"),t.Name);break;case 3:t.ColSet||(t.ColSet="[]");tt=JSON.parse(t.ColSet);function n(n){return tt.reduce((t,i)=>{var r=i.chose.reduce((t,i)=>{var r="";if(kanBanProductItemsEl[i.val]&&kanBanProductItemsEl[i.val].isTable){const t=kanBanProductItemsEl[i.val];r=t.op.format(getTable(`${n}_${t.div}`,t.cols.map(n=>n.title),3),t.name,i.height==-1?"auto":`${i.height}%`,i.val)}return t+r},"");return`${t}<div class="" style="width: ${i.width}%; height: 100%;">
                                            ${r}
                                        </div>`},"")}s+=o.format(r,b.format(r,t.Name,"",n(r)),"kb_body",c);h=a.format(u,b.format(u,t.Name,"hidden",n(u)),t.Name)}carouselTmp[t.Id]||(carouselTmp[t.Id]={});carouselTmp[t.Id]={carouselLi:`<li data-target="#carousel-example-generic" data-slide-to=${g++}></li>`,carouselTab:h}}}$("#carouselDiv").empty().append(k).find(`.icb_minimal`).iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"}).on("ifChanged",function(){const n=$(this).val();$(this).is(":checked")?carouselChose.push({id:n,Order:kanBans[n].Order}):removeArray(carouselChose,"id",n);carouselChose.sort(sortOrder)});$("#firstNavLi").nextAll().remove().end().after(d).end();v&&$("#tabBox a:not(:first)").first().click();$("#setKanBan").nextAll().remove().end().after(s);f=f.filter(n=>n.Id!==0);n&&n(f)}},0)}function setAddKanBan(n){const u=$("#kanBanName").val().trim();if(isStrEmptyOrUndefined(u))return void layer.msg("看板名称不能为空");const i=$("#kanBanType").val()>>0;if(isStrEmptyOrUndefined(i))return void layer.msg("看板类型错误");const o=$("#kanBanOrder").val()>>0,f=$("#deviceSelect").val();if(isStrEmptyOrUndefined(f))return void layer.msg("请选择设备");const s=$("#kanBanUI").val()>>0,h=$("#kanBanSecond").val()>>0,c=$("#kanBanRow").val()>>0,l=$("#kanBanCol").val()>>0,e=$("#kanBanContentCol").val()>>0,a=Array.from($("#kanBanItemColName .kb_item_col2").map((n,t)=>t.value)),v=$("#isShow").is(":checked");let r=[];scriptIndexTmp.forEach(n=>{var t=scriptTmp[n];const i=`${t.divVal}Data`,u=`${t.divIn}Data`,f=`${t.divOut}Data`;t&&t[i]&&t[u]&&t[f]&&(r=r.concat(t[i],t[u],t[f]))});const t={Type:i,IsShow:v,Name:u,DeviceIds:f.join(","),Order:o,UI:s,Second:h,Row:c,Col:l,ContentCol:e,ColName:"",ColSet:"[]",Variables:"[]",Items:"[]"};if(i==2){t.ColName=a.join();const n=getMaxSet(e);t.Variables=JSON.stringify(r.filter(t=>t.Order<=n))}else i==3&&(t.Items=JSON.stringify(kanBanItemsTmp),t.ColSet=JSON.stringify(colSet));if(!n){const n=$("#kanBanList").val();if(isStrEmptyOrUndefined(n))return void layer.msg("请选择需要修改的看板");t.Id=n>>0}const y={opType:n?510:511,opData:JSON.stringify(t)};ajaxPost("/Relay/Post",y,n=>{layer.msg(n.errmsg),n.errno==0&&getKanBanList()})}function delKanBanList(){var n=$("#kanBanList").val(),t;if(isStrEmptyOrUndefined(n)){layer.msg("请选择需要删除的看板");return}t=()=>{var t={opType:512,opData:JSON.stringify({id:n})};ajaxPost("/Relay/Post",t,n=>{layer.msg(n.errmsg),n.errno==0&&getKanBanList()})};showConfirm(`删除：${$("#kanBanList :selected").text()}`,t)}function getMaxSet(n){return n==2?6:(n-3)*5+10}function getFirstOrders(n){var i,t,r;if(n>2){const u=n-1,f=getMaxSet(n),e=Math.floor(f/u);for(i=[],t=0;t<e;t++)r=1+u*t,i.push(r)}return i}function getScriptList(){var n={opType:106,opData:JSON.stringify({sIds:scriptIndexTmp.join()})};ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}var r=`<div class="box box-info" id="{0}">
                <div class="box-header with-border">
                    <h3 class="box-title"><lable class="text-red text-bold name">{1}</lable> - <lable class="text-blue text-bold code" title="{2}">{3}</lable></h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>
                    <h4>
                        <lable class="text-red text-bold">已选:<lable class="text-blue text-bold chosed"></lable></lable>
                    </h4>
                </div>
                <div class="box-body">
                    <div class="nav-tabs-custom">
                        <ul class="nav nav-tabs ui-sortable-handle">
                            <li class="active"><a href="#{0}_kanBanDeviceDataDiv" data-toggle="tab" aria-expanded="true">设备数据</a></li>
                            <li><a href="#{0}_kanBanProductDataDiv" data-toggle="tab" aria-expanded="true">生产数据</a></li>
                        </ul>
                        <div class="tab-content no-padding" style="position: relative">
                            <div class="tab-pane active" id="{0}_kanBanDeviceDataDiv">
                                <div class="form-group">
                                    <div class="col-md-4">
                                        <label class="control-label">变量：</label>
                                        <div class="flexStyle" style="justify-content: flex-end">
                                            <select class="form-control thText" style="max-width: 80px" onchange="dataTableSearch.call(this, '{4}')">
                                                <option value="0">序号</option>
                                                <option value="1">名称</option>
                                                <option value="2">地址</option>
                                            </select>
                                            <select class="form-control sym" style="max-width: 100px" onchange="dataTableSearch.call(this, '{4}')">
                                                <option value="0">等于</option>
                                                <option value="1">不等于</option>
                                                <option value="2">包含</option>
                                            </select>
                                            <input type="text" class="form-control val" placeholder="搜索" style="max-width: 150px" oninput="dataTableSearch.call(this, '{4}')">
                                        </div>
                                        <div class="table-responsive mailbox-messages">
                                            <table class="table table-hover table-striped table-condensed" id="{4}"></table>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="control-label">输入：</label>
                                        <div class="flexStyle" style="justify-content: flex-end">
                                            <select class="form-control thText" style="max-width: 80px" onchange="dataTableSearch.call(this, '{5})'">
                                                <option value="0">序号</option>
                                                <option value="1">名称</option>
                                                <option value="2">地址</option>
                                            </select>
                                            <select class="form-control sym" style="max-width: 100px" onchange="dataTableSearch.call(this, '{5}')">
                                                <option value="0">等于</option>
                                                <option value="1">不等于</option>
                                                <option value="2">包含</option>
                                            </select>
                                            <input type="text" class="form-control val" placeholder="搜索" style="max-width: 150px" oninput="dataTableSearch.call(this, '{5}')">
                                        </div>
                                        <div class="table-responsive mailbox-messages">
                                            <table class="table table-hover table-striped table-condensed" id="{5}"></table>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="control-label">输出：</label>
                                        <div class="flexStyle" style="justify-content: flex-end">
                                            <select class="form-control thText" style="max-width: 80px" onchange="dataTableSearch.call(this, '{6}')">
                                                <option value="0">序号</option>
                                                <option value="1">名称</option>
                                                <option value="2">地址</option>
                                            </select>
                                            <select class="form-control sym" style="max-width: 100px" onchange="dataTableSearch.call(this, '{6}')">
                                                <option value="0">等于</option>
                                                <option value="1">不等于</option>
                                                <option value="2">包含</option>
                                            </select>
                                            <input type="text" class="form-control val" placeholder="搜索" style="max-width: 150px" oninput="dataTableSearch.call(this, '{6}')">
                                        </div>
                                        <div class="table-responsive mailbox-messages">
                                            <table class="table table-hover table-striped table-condensed" id="{6}"></table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade in" id="{0}_kanBanProductDataDiv">
                                <div class="table-responsive mailbox-messages">
                                    <table class="table table-hover table-striped table-condensed" id="{7}"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;const u=$("#kanBanList").val(),t=kanBans[u],i=n.datas;scriptIndexTmp.forEach(n=>{if(scriptTmp[n]){const s=scriptTmp[n],p=s.sName;let l=SortNumberString(s.ds,"code").map(n=>n.code).join(),b=`${l.length>tdShowLengthLong?`${l.substring(0,tdShowLengthLong)}...`:l}`;var u=i.filter(t=>t.ScriptId==n&&t.VariableTypeId==1),f=i.filter(t=>t.ScriptId==n&&t.VariableTypeId==2),e=i.filter(t=>t.ScriptId==n&&t.VariableTypeId==3),o=kanBanItems[t.Type]?kanBanItems[t.Type]:[];s.divVal=`valList_${n}`;s.divIn=`insList_${n}`;s.divOut=`outList_${n}`;s.divProduct=`productList_${n}`;const v=`${s.divVal}Data`,y=`${s.divIn}Data`,a=`${s.divOut}Data`,w=`${s.divProduct}Data`,c=[s.divVal,s.divIn,s.divOut,s.divProduct],h=[v,y,a,w];if(s.div)$(`#${s.div}>.box-header .name`).text(p),$(`#${s.div}>.box-header .code`).text(l),$(`#${s.div} .val`).text(""),updateTable(_dataTableData[s.divVal],u),updateTable(_dataTableData[s.divIn],f),updateTable(_dataTableData[s.divOut],e),updateTable(_dataTableData[s.divProduct],o);else{s.div=`sc_${n}`;s[`${s.divVal}Trs`]=[];s[`${s.divIn}Trs`]=[];s[`${s.divOut}Trs`]=[];s[`${s.divProduct}Trs`]=[];s[`${s.divVal}Data`]=[];s[`${s.divIn}Data`]=[];s[`${s.divOut}Data`]=[];s[`${s.divProduct}Data`]=[];$("#kanBanScript").append(r.format(s.div,p,l,b,s.divVal,s.divIn,s.divOut,s.divProduct));let i=dataTableConfig(0,!0);i.bLengthChange=!1;i.iDisplayLength=20;i.dom='<"pull-left"l><"pull-right hidden"f>rt<"text-center"i><"table-flex"p>';i.addColumns([{data:"VariableName",title:"名称"},{data:"PointerAddress",title:"地址",sClass:"add"},{data:null,title:"自定义名称",render:n=>{const r=0;var i=t.VariableList.filter(t=>t.Type==r&&t.ScriptId==n.ScriptId&&t.VariableTypeId==n.VariableTypeId&&t.PointerAddress==n.PointerAddress),u=i.length>0?i[0].VariableName:"";return tableSet.input("name",u)}},{data:null,title:"显示顺序",render:n=>{const r=0;var i=t.VariableList.filter(t=>t.Type==r&&t.ScriptId==n.ScriptId&&t.VariableTypeId==n.VariableTypeId&&t.PointerAddress==n.PointerAddress),u=i.length>0&&i[0].Order>0?i[0].Order:"1";return tableSet.numberInput("order",`50px,5,2,1,99999,0`,u)}}]);i.updateData(u);i.drawCallback=function(){const r=`${s.divVal}Trs`,t=v,i=0;initCheckboxAddEvent.call(this,s[r],(r,u)=>{const f=$(r).find(".name").val(),o=$("#kanBanContentCol").val()>>0,l=getMaxSet(o);onInput($(r).find(".order"),5,2,1,l);const e=$(r).find(".order").val()>>0;s[t].push({Type:i,Id:u.Id,ScriptId:n,VariableTypeId:1,PointerAddress:u.PointerAddress,VariableName:f?f:"",VName:u.VariableName,Order:e?e:1});disabledChose(s,h,c)},(n,r)=>{removeArray(s[t],"Id",r.Id,"Type",i),enableChose(s,h,c)},!1,"Checked");initInputChangeEvent.call(this,(n,r)=>{const u=$(n).find(".name").val(),f=$("#kanBanContentCol").val()>>0,e=getMaxSet(f);onInput($(n).find(".order"),5,2,1,e);const o=$(n).find(".order").val()>>0;s[t].length>0&&s[t].every(n=>n.Id==r.Id&&n.Type==i?(n.VariableName=u,n.Order=o,!1):!0);updateChoseTitle(s,h)});disabledChose(s,h,c);enableChose(s,h,c)};i.createdRow=function(i,r){var u=!1;const f=0;t.VariableList.every(t=>t.Type==f&&r.ScriptId==t.ScriptId&&r.VariableTypeId==t.VariableTypeId&&r.PointerAddress==t.PointerAddress?(u=!0,s[v].push({Type:f,Id:r.Id,ScriptId:n,VariableTypeId:1,VariableName:t.VariableName,VName:r.VariableName,PointerAddress:r.PointerAddress,Order:t.Order}),!1):!0);$(i).find(".isEnable").iCheck(u?"check":"uncheck");u&&$(i).find(".textOn").text("").addClass("hidden").siblings(".textIn").removeClass("hidden")};_dataTableData[s.divVal]=$(`#${s.divVal}`).DataTable(i);i.updateData(f);i.drawCallback=function(){const r=`${s.divIn}Trs`,t=y,i=0;initCheckboxAddEvent.call(this,s[r],(r,u)=>{const f=$(r).find(".name").val(),o=$("#kanBanContentCol").val()>>0,l=getMaxSet(o);onInput($(r).find(".order"),5,2,1,l);const e=$(r).find(".order").val()>>0;s[t].push({Type:i,Id:u.Id,ScriptId:n,VariableTypeId:2,PointerAddress:u.PointerAddress,VariableName:f?f:"",VName:u.VariableName,Order:e?e:1});disabledChose(s,h,c)},(n,r)=>{removeArray(s[t],"Id",r.Id,"Type",i),enableChose(s,h,c)},!1,"Checked");initInputChangeEvent.call(this,(n,r)=>{const u=$(n).find(".name").val(),f=$("#kanBanContentCol").val()>>0,e=getMaxSet(f);onInput($(n).find(".order"),5,2,1,e);const o=$(n).find(".order").val()>>0;s[t].length>0&&s[t].every(n=>n.Id==r.Id&&n.Type==i?(n.VariableName=u,n.Order=o,!1):!0);updateChoseTitle(s,h)});disabledChose(s,h,c);enableChose(s,h,c)};i.createdRow=function(i,r){var u=!1;t.VariableList.every(t=>t.Type==0&&r.ScriptId==t.ScriptId&&r.VariableTypeId==t.VariableTypeId&&r.PointerAddress==t.PointerAddress?(u=!0,s[y].push({Id:r.Id,ScriptId:n,VariableTypeId:2,VariableName:t.VariableName,VName:r.VariableName,PointerAddress:t.PointerAddress,Order:t.Order}),!1):!0);$(i).find(".isEnable").iCheck(u?"check":"uncheck");u&&$(i).find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden")};_dataTableData[s.divIn]=$(`#${s.divIn}`).DataTable(i);i.updateData(e);i.drawCallback=function(){const r=`${s.divOut}Trs`,t=a,i=0;initCheckboxAddEvent.call(this,s[r],(r,u)=>{const f=$(r).find(".name").val(),o=$("#kanBanContentCol").val()>>0,l=getMaxSet(o);onInput($(r).find(".order"),5,2,1,l);const e=$(r).find(".order").val()>>0;s[t].push({Type:i,Id:u.Id,ScriptId:n,VariableTypeId:3,PointerAddress:u.PointerAddress,VariableName:f?f:"",VName:u.VariableName,Order:e?e:1});disabledChose(s,h,c)},(n,r)=>{removeArray(s[t],"Id",r.Id,"Type",i),enableChose(c)},!1,"Checked");initInputChangeEvent.call(this,(n,r)=>{const u=$(n).find(".name").val(),f=$("#kanBanContentCol").val()>>0,e=getMaxSet(f);onInput($(n).find(".order"),5,2,1,e);const o=$(n).find(".order").val()>>0;s[t].length>0&&s[t].every(n=>n.Id==r.Id&&n.Type==i?(n.VariableName=u,n.Order=o,!1):!0);updateChoseTitle(s,h)});disabledChose(s,h,c);enableChose(s,h,c)};i.createdRow=function(i,r){var u=!1;t.VariableList.every(t=>t.Type==0&&r.ScriptId==t.ScriptId&&r.VariableTypeId==t.VariableTypeId&&r.PointerAddress==t.PointerAddress?(u=!0,s[a].push({Id:r.Id,ScriptId:n,VariableTypeId:3,VariableName:t.VariableName,VName:r.VariableName,PointerAddress:t.PointerAddress,Order:t.Order}),!1):!0);$(i).find(".isEnable").iCheck(u?"check":"uncheck");u&&$(i).find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden")};_dataTableData[s.divOut]=$(`#${s.divOut}`).DataTable(i);i.modifyColumns([{data:"Type",title:"名称"},{data:null,title:"自定义名称",render:n=>{const r=0;var i=t.VariableList.filter(t=>t.Type==r&&t.ItemType==n.Id),u=i.length>0?i[0].Type:"";return tableSet.input("name",u)}},{data:null,title:"显示顺序",render:n=>{const r=0;var i=t.VariableList.filter(t=>t.Type==r&&t.ItemType==n.Id),u=i.length>0&&i[0].Order>0?i[0].Order:"1";return tableSet.numberInput("order",`50px,5,2,1,99999,0`,u)}}]);i.updateData(o);i.drawCallback=function(){const r=`${s.divProduct}Trs`,t=w,i=0;initCheckboxAddEvent.call(this,s[r],(r,u)=>{const f=$(r).find(".name").val(),o=$("#kanBanContentCol").val()>>0,l=getMaxSet(o);onInput($(r).find(".order"),5,2,1,l);const e=$(r).find(".order").val()>>0;s[t].push({Type:i,Id:u.Id,ScriptId:n,ItemType:u.Id,VariableName:f?f:"",VName:u.Type,Order:e?e:1});disabledChose(s,h,c)},(n,r)=>{removeArray(s[t],"Id",r.Id,"Type",i),enableChose(s,h,c)},!1,"Checked");initInputChangeEvent.call(this,(n,r)=>{const u=$(n).find(".name").val(),f=$("#kanBanContentCol").val()>>0,e=getMaxSet(f);onInput($(n).find(".order"),5,2,1,e);const o=$(n).find(".order").val()>>0;s[t].length>0&&s[t].every(n=>n.Id==r.Id&&n.Type==i?(n.VariableName=u,n.Order=o,!1):!0);updateChoseTitle(s,h)});disabledChose(s,h,c);enableChose(s,h,c)};i.createdRow=function(i,r){var u=!1;const f=1;t.VariableList.every(t=>t.Type==f&&r.Id==t.Id&&r.ItemType==t.ItemType?(u=!0,s[a].push({Type:f,Id:r.Id,ScriptId:n,ItemType:r.Id,VariableName:t.VariableName,VName:r.Type,Order:t.Order}),!1):!0);$(i).find(".isEnable").iCheck(u?"check":"uncheck");u&&$(i).find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden")};_dataTableData[s.divProduct]=$(`#${s.divProduct}`).DataTable(i)}}})},0)}function getChoseLength(n,t){return t.reduce((t,i)=>t+n[i].length,0)}function updateChoseTitle(n,t){const i=t.reduce((t,i)=>t.concat(n[i]),[]).sort(sortOrder).map(n=>`[${n.Order},${n.VName}]`);$(`#${n.div} .chosed`).text(i.join())}function disabledChose(n,t,i){const r=$("#kanBanContentCol").val()>>0,u=getMaxSet(r),f=getChoseLength(n,t);f>=u&&i.forEach((i,r)=>{disabledTableCheck(i,n[t[r]].map(n=>n.Id))});updateChoseTitle(n,t)}function enableChose(n,t,i){const r=$("#kanBanContentCol").val()>>0,u=getMaxSet(r),f=getChoseLength(n,t);f<u&&i.forEach(n=>{enableTableCheck(n)});updateChoseTitle(n,t)}function dataTableSearch(n){const r=_dataTableData[n],i=$(this).parent();var t=i.find(".val").val().trim();if(r.columns([0,1,2,3]).search("").draw(),!isStrEmptyOrUndefined(t)){const n=i.find(".sym").val();n==0?t=`^${t}$`:n==1&&(t=`^(?!${t}$).+$`);const u=(i.find(".thText").val()>>0)+1;r.columns(u).search(t,!0,!1).draw()}}function fullScreenCarousel(){var n=`<div class="">
            <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                <ol class="carousel-indicators isShow hidden">{0}</ol>
                <div class="carousel-inner">{1}</div>
                <a class="left carousel-control isShow hidden" href="#carousel-example-generic" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left text-primary" aria-hidden="true"></span>
                </a>
                <a class="right carousel-control isShow hidden" href="#carousel-example-generic" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right text-primary" aria-hidden="true"></span>
                </a>
            </div>
        </div>`;if(carouselChose.length){const t=carouselChose.reduce((n,t)=>`${n}${carouselTmp[t.id].carouselLi}`,""),i=carouselChose.reduce((n,t)=>`${n}${carouselTmp[t.id].carouselTab}`,"");_carouselBox=n.format(t,i);carouselChose.forEach(n=>{page[n.id]=0,dsDivs[n.id]=[],dsPaths[n.id]=[]});carouselId=0;carouselIndex=0;$("#fullScreenCarousel").empty().append(_carouselBox);$("#fullScreenCarousel").find("ol li:first").addClass("active");$("#fullScreenCarousel").find(".item:first").addClass("active");$("#fullScreenCarousel").animate({top:0,opacity:1},1e3,"linear",()=>{});carouselFlag=$("#fullScreenCarousel .item:first").attr("id");setFullScreenCarousel(carouselFlag);$("#carousel-example-generic").carousel({interval:1e4}).off("slide.bs.carousel").on("slide.bs.carousel",n=>{if(carouselFlag=n.relatedTarget.id,carouselId=carouselFlag.replace("carousel_kanBan_",""),kanBans[carouselId]){if($(`#fullScreenCarousel .ftitle`).length&&$(`#fullScreenCarousel .ftitle`).text(` - ${kanBans[carouselId].Name}`),carouselFlag=="")return;setChart(carouselFlag,carouselId,kanBans[carouselId].Type,!0)}}).on("mouseenter",()=>$("#carousel-example-generic .isShow").removeClass("hidden")).on("mouseleave",()=>$("#carousel-example-generic .isShow").addClass("hidden")).on("mousemove",()=>{$("html").css({cursor:"default"}),checkMouseMove&&clearTimeout(checkMouseMove),checkMouseMove=setTimeout(function(){console.log("hide");$("html").css({cursor:"none"});$("#carousel-example-generic").trigger("mouseleave")},5e3)})}}function setFullScreenCarousel(){(clearInterval(carouselTime),carouselFlag!="")&&(carouselTime=setInterval(()=>{if(carouselId=carouselFlag.replace("carousel_kanBan_",""),kanBans[carouselId]){if($(`#fullScreenCarousel .ftitle`).text(` - ${kanBans[carouselId].Name}`),carouselFlag=="")return;setChart(carouselFlag,carouselId,kanBans[carouselId].Type,!0)}},5e3))}function cancelFullScreenCarousel(){kanBanProductItemsEl.forEach(n=>{for(var t in n)~t.indexOf("_timer")&&stopScrollTable(n,t,t.replace("_timer",""))});checkMouseMove&&clearTimeout(checkMouseMove);clearInterval(carouselTime);carouselFlag="";$("#carousel-example-generic").carousel("pause").off("slide.bs.carousel mouseenter mouseleave");$("#fullScreenCarousel").animate({top:"-100%",opacity:0},1e3,"linear",function(){$(this).empty();fullScreen(!1)})}function setChart(n,t,i,r=false){var u,f;if(!run){run=!0;u=`#${n}`;const e=page[t]?page[t]:0;f={opType:509,opData:JSON.stringify({qId:t,page:e})};ajaxPost("/Relay/Post",f,e=>{var s,a,o,ut,ft,et,d,ot,g,st,w,nt,tt,bt,l,h,kt,dt,p,gt,it,b,rt,k,ni,ti,ii,ri;run=!1;const v="text-red",y="text-gray";if(e.errno==0?(ut=$(`${u}_time`).text(),ft=e.time,Math.abs(dateDiffSec(ft,ut))>60?($(`${u}_time`).toggleClass(v),$(`${u}_time`).toggleClass(y)&&$(`${u}_time`).removeClass(y)):($(`${u}_time`).toggleClass(y),$(`${u}_time`).hasClass(v)&&$(`${u}_time`).removeClass(v))):($(`${u}_time`).hasClass(v)||$(`${u}_time`).addClass(v),$(`${u}_time`).hasClass(y)&&$(`${u}_time`).removeClass(y),run=!1),o=e.data,i==1){if(e.errno!=0)return;et=setPieChart(`${u}_detail`,"Rate",o.AllProcessRate,"#0099ff");$(`${u}_yxTime`).text(codeTime(o.RunTime));$(`${u}_jgTime`).text(codeTime(o.ProcessTime));$(`${u}_xzTime`).text(codeTime(o.IdleTime));$(`${u}_lly`).text(et);d=`${o.MaxUse}台`;ot=setPieChart(`${u}_max`,`Max
${d}`,o.MaxUseRate,"#00a65a");$(`${u}_maxTs`).text(`${o.MaxSimultaneousUseRate}台`);$(`${u}_maxTNum`).text(d);$(`${u}_maxSyl`).text(ot);g=`${o.MinUse}台`;st=setPieChart(`${u}_min`,`Min
${g}`,o.MinUseRate,"#f39c12");$(`${u}_minTs`).text(`${o.MinSimultaneousUseRate}台`);$(`${u}_minTNum`).text(g);$(`${u}_minSyl`).text(st);var c=o.AllDevice,ht=o.NormalDevice,ct=o.ProcessDevice,lt=o.IdleDevice,at=o.FaultDevice,vt=o.ConnectErrorDevice;for(setPieChart(`${u}_state_all`,`${c}台`,c/c,"green","总设备"),setPieChart(`${u}_state_normal`,`${ht}台`,ht/c,"blue","正常运行"),setPieChart(`${u}_state_process`,`${ct}台`,ct/c,"#0099ff","加工中"),setPieChart(`${u}_state_idle`,`${lt}台`,lt/c,"#cc33ff","闲置中"),setPieChart(`${u}_state_fault`,`${at}台`,at/c,"red","故障中"),setPieChart(`${u}_state_error`,`${vt}台`,vt/c,"#ff00cc","连接异常"),nt=o.UseCodeList||[],a="",s=0,w=nt.length;s<w;s++)a+=`<div style="border:1px solid;padding:5px 10px;margin:3px;border-radius:20%;background:#bfa;font-weight:bold">${nt[s]}</div>`;$(`${u}_dev`).empty().append(a||'<label style="color:red;font-size:18px">无<\/label>');var yt=o.SingleProcessRate,pt=[],wt=[];for(s=0,w=yt.length;s<w;s++)tt=yt[s],pt.push(tt.Code),wt.push((tt.Rate*100).toFixed(2));bt={tooltip:{trigger:"axis",formatter:"{a}<br/>{b} : {c}%",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"3%",top:"6%",bottom:"8%",containLabel:!0},xAxis:{type:"category",axisLine:{onZero:!1},data:pt},yAxis:{name:"百分比",type:"value",scale:!0,axisLabel:{show:!0,formatter:"{value}%"}},series:{name:"利用率",type:"bar",areaStyle:{normal:{}},barWidth:"60%",label:{show:!0,position:"top",formatter:"{c}%"},itemStyle:{color:n=>n.value<30?"red":"green"},data:wt},dataZoom:[{type:"inside"},{handleIcon:_handleIcon,handleSize:"80%",handleStyle:{color:"#fff",shadowBlur:3,shadowColor:"rgba(0, 0, 0, 0.6)",shadowOffsetX:2,shadowOffsetY:2}}]};echarts.init($(`${u}_bar`)[0]).setOption(bt,!0);$(u).off("resize").on("resize",function(){clearTimeout(this.time);this.time=setTimeout(()=>{for(var t=$(this).find(".chart"),n=0,i=t.length;n<i;n++)echarts.init(t[n]).resize()},200)});l=o.ProductionList;const n=l.reduce((n,t)=>`${n}<td class="text-blue">${t.Code}</td>`,""),t=l.reduce((n,t)=>`${n}<td>${t.DayTotal}</td>`,""),i=l.reduce((n,t)=>`${n}<td>${t.DayQualified}</td>`,""),r=l.reduce((n,t)=>`${n}<td>${t.DayUnqualified}</td>`,""),f=l.reduce((n,t)=>`${n}<td>${t.DayQualifiedRate}%</td>`,""),h=l?l.filter(n=>n.DayTotal>0).length:0;$(`${u}_devs`).text(h);$(`${u}_pros`).text(o.DayTotal);$(`${u}_heGes`).text(o.DayQualified);$(`${u}_liePians`).text(o.DayUnqualified);$(`${u}_rates`).text(`${o.DayQualifiedRate}%`);$(`${u}_devOps`).find("td:not(:first)").remove().end().append(n);$(`${u}_proOps`).find("td:not(:first)").remove().end().append(t);$(`${u}_heGeOps`).find("td:not(:first)").remove().end().append(i);$(`${u}_liePianOps`).find("td:not(:first)").remove().end().append(r);$(`${u}_rateOps`).find("td:not(:first)").remove().end().append(f)}else if(i==2){if(h=`${u}_deviceState`,e.errno!=0){dsDivs[t].forEach(n=>{$(`#${n}`).addClass("hi")});$(`${h} .hi`).css("display","none").removeClass("hi");return}kt=`<div id="{0}" class="kb_device_div1 ds" style="display:none;">
                    <div style="height: 33%;position: relative;display: flex;">
                        <div style="width: 35%;position: relative;">
                            <img id="{0}_img" class="kb_img1" src="">
                        </div>
                        <div style="width: 50%;position: relative;">
                            <label id="{0}_code" class="text-blue" style="margin: 0;font-size: 16px;"></label>
                            <br>
                            <label id="{0}_mc" class="" style="margin: 0;white-space: nowrap;color: #f15a22;"></label>
                            <br>
                            <label id="{0}_ws" class="" style="margin: 0;white-space: nowrap;color: #005831;"></label>
                        </div>
                        <div id="{0}_state" style="width: 23px;height: 23px;position: absolute;top: 0;right: 0;/* float: right; */"></div>
                    </div>
                    <div style="top: 2%; height: 65%; position: relative;" id="{0}_detail"></div>
                </div>`;const i=dsDivs[t].length;if(i!==e.len){a="";dt=Math.abs(e.len-i);for(let r=0;r<dt;r++){const u=`${n}_ds${i+r}`;i<e.len?(dsDivs[t].push(u),a+=kt.format(u)):i>e.len&&removeArray(dsDivs[t],u)}i<e.len?$(`${h}`).append(a):i>e.len&&$(`${h} .rm`).remove()}const w=$(`${u} .dsDiv`);w.length>0&&(p=$(window).height(),$(`${u}`).css("height",`${p}px`),p=$(`${u} .kb_border2`).height()>>0,gt=$(`${u} .ttDiv`).height()>>0,$(`${u} .dsDiv`).css("height",`${p-gt}px`));const c=SortNumberString(o,"Code");let l=c.length;if(!l){dsDivs[t].forEach(n=>{$(`#${n}`).addClass("hi")});$(`${h} .hi`).css("display","none").removeClass("hi");$(h).append('<div class="no-data" style="font:bold 25px/35px 微软雅黑;color:red">无数据<\/div>');return}const y=`${h} .no-data`;$(y).length>0&&$(y).remove();it=n=>{function it(n,t,i){var u,f,s;let e="";if(t==2)e=n.reduce((n,t)=>`${n}<div class="form-group no-margin" style="height:calc(100%/6);">
                                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 no-margin text-blue no-padding kb_param1">
                                    <label class=" control-label no-margin text-blue no-padding">${t.VName}</label>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 no-margin text-blue no-padding kb_param1">
                                    <label class="control-label no-margin text-blue no-padding">${t.V}</label>
                                </div>
                            </div>`,"");else if(t>2){const l=t-1;let a="";if(n.length>0){const t=Math.max.apply(null,n.map(n=>n.Order))+1,i=Math.floor(t/l);for(u=0;u<i;u++){var o="",h=l*u,r=n.filter(n=>n.Order==h),c="";for(r.length>0&&(c=r[0].VName),o+=`<td>${c}</td>`,f=1;f<=l;f++)r=n.filter(n=>n.Order==h+f),s="",r.length>0&&(s=r[0].V),o+=`<td>${s}</td>`;a+=`<tr>
                                    ${o}
                                </tr>`}}e=`<table border="0" cellspacing="0" cellpadding="0" style="width:100%;">
                                <thead>
                                    <tr>
                                        ${i.reduce((n,i)=>`${n}<th style="width:calc(100%/${t})">${i}</th>`,"")}
                                    </tr>
                                </thead>
                                    ${a}
                                <tbody>
                                </tbody>
                            </table>`}return e}var a,v,f,o;if(n)for(l=n.length,s=0;s<l;s++)a=n[s],dsPaths[t][a.name]||(dsPaths[t][a.name]=a.path);const tt=Object.keys(dsPaths[t]).length;if(!(tt<=0)){for(v=[],c.forEach(n=>v[n.Id]=1),s=0;s<i;s++){const n=`${u}_ds${s}`;if(f=c[s],f){o="red";switch(f.DeviceStateStr){case"加工中":o="#00A65C";break;case"待机":case"流程升级中":case"固件升级中":case"设备重启中":case"连接正常":o="#f47920";break;case"已报修":case"已确认":case"维修中":o="red";break;default:o="gray"}const i=it(f.Data,e.cCol,e.cName);$(`${n}_img`).attr("src",dsPaths[t][f.Icon]);$(`${n}_code`).text(f.Code);$(`${n}_mc`).text(`${f.CategoryName}-${f.ModelName}`);$(`${n}_ws`).text(f.SiteName);$(`${n}_state`).css("background",o);$(`${n}_detail`).html(i);$(`${n}`).addClass("sh")}else $(`${n}`).addClass("hi")}$(`${h} .sh`).css("display","block").removeClass("sh");$(`${h} .hi`).css("display","none").removeClass("hi");$(`${u}_jg`).text(e.jg);$(`${u}_xz`).text(e.xz);$(`${u}_zc`).text(e.zc);$(`${u}_gz`).text(e.gz);$(`${u}_wlj`).text(e.wlj);$(`${u}_sum`).text(e.sum);var y=$(".ds"),p=y.length>0?($(y[0]).css("margin").replace("px","")>>0)*2:5,rt=($(h).css("padding").replace("px","")>>0)*2;if(e.row>0){var w=$(h).width(),b=Math.floor(w/(def+p)),ut=e.col>b?b:e.col,k=Math.floor(w/ut)-p,ft=$(window).height();$(`${u}`).css("height",`${ft}px`);var d=$(h).closest(".dsDiv").height(),g=Math.floor(d/def),et=e.row>g?g:e.row,nt=Math.floor(d/et)-rt;$(".ds").css("flex-basis",`${k<def?def:k}px`).css("height",`${nt<def?def:nt}px`)}r&&(page[t]=++e.cp)}};const v=[];for(s=0;s<l;s++)b=c[s],dsPaths[t][b.Icon]||~v.lastIndexOf(b.Icon)||v.push(b.Icon);if(v.length>0){f={type:fileEnum.Device,files:JSON.stringify(v)};f.dir="";for(rt in fileEnum)if(fileEnum[rt]==f.type){f.dir=rt;break}if(isStrEmptyOrUndefined(f.dir))return void layer.msg("文件类型不存在！");getFilePath(f,it,0)}else it()}else if(i==3){if(e.errno!=0)return;var o=e.data.WarningLogs,ui=`${u}_productDiv`,p=$(window).height(),fi=$(`${u} .kb_title1`).closest("div").height()>>0;for($(`${ui}`).css("height",`${p-fi}px`),k=0,ni=e.items.length;k<ni;k++){const t=e.items[k];if(kanBanProductItemsEl[t]){const i=kanBanProductItemsEl[t],r=`${u}_${i.div}`,f=e.data[i.dataSource];$(`${r}`).closest(".kb_border2").find(".kb_title2").text(`${i.name}（${f.length}）`);addOrderData(f);let o=$(`${r} tbody tr`);if(i.isTable){const t=i.cols;if(o.length==0){const n=f.reduce((n,r,u)=>{const o=t.reduce((n,t)=>{var i=t.data?r[t.data]:t.render(r),u=t.suffix?t.suffix:"";return n+`<td>${i}${u}</td>`},"");var e="";return(i.order=="asc"&&f.length==u+1||i.order=="desc"&&u==0)&&(e=` class="max"`),n+`<tr${e} order=${r.XvHao} ${i.trFlag}=${r[i.trFlag]}>${o}</tr>`},"");$(`${r} tbody`).html(n)}else{const n=$(`${r} tr[class='max']`),u=$(n).attr("order")>>0,e=f.length-o.length;let s=[];if(s=i.order=="asc"?f.filter(n=>n.XvHao<=u):sliceArray(f,f.length,e-1),s.forEach(n=>{const f=$(`${r} tr[${i.trFlag}=${n[i.trFlag]}]`);for(var u=0,e=t.length;u<e;u++){const i=t[u],o=i.data?n[i.data]:i.render(n),s=i.suffix?i.suffix:"",r=`${o}${s}`,e=n.XvHao,h=$(f.find("td")[u]).text(),c=$(f).attr("order")>>0;h!=r&&$(f.find("td")[u]).text(r);c!=e&&$(f).attr("order",e)}}),f.length>o.length){n.removeClass("max");let r=[];r=i.order=="asc"?f.filter(n=>n.Order>u):sliceArray(f,e);const o=r.reduce((n,u,f)=>{const o=t.reduce((n,t)=>{var i=t.data?u[t.data]:t.render(u),r=t.suffix?t.suffix:"";return n+`<td>${i}${r}</td>`},"");var e="";return(i.order=="asc"&&f+1==r.length||i.order=="desc"&&f==0)&&(e=` class="max"`),n+`<tr${e} order=${u.XvHao} ${i.trFlag}=${u[i.trFlag]}>${o}</tr>`},"");i.order=="asc"?n.after(o):n.before(o)}else f.length<o.length&&$(`${r} tbody`).html("")}const u=$(`${r}`).closest(".kb_border2").height(),h=$(`${r}`).closest(".kb_border2").find("h4").height(),e=u-h;$(`${r}`).closest(".table-responsive").css("height",`${Math.floor(e*100/u)}%`);ti=$(`${r} tr`).height();ii=e-$(`${r} tbody`).closest(".kb_item_tablebox").css("padding").replace("px","")*2;o=$(`${r} tbody tr`);ri=Math.floor(ii/ti);const s=`${n}_${i.div}_timer`;o.length>ri&&!i[s]&&scrollTable(i,s,`${n}_${i.div}`)}}}}},0)}}function setPieChart(n,t,i,r,u){i=i||0;var e=`${(i*100).toFixed(2)}%`,f={color:["#cdcdcd",r],series:{type:"pie",center:["50%","50%"],radius:["65%","100%"],hoverAnimation:!1,animation:!1,silent:!0,label:{show:!0,position:"center",formatter:`${t}
${e}`,textStyle:{color:r,fontSize:18,fontWeight:700}},data:[1-i,i]}};return u&&(f.title={text:u,left:"center",textStyle:{color:r,fontSize:16}},f.series.center=["50%","57%"],f.series.radius=["57%","85%"]),echarts.init($(n)[0]).setOption(f,!0),e}var def=175,curId=-1,t=0,uiTime=0,dataTime=0,run=!1,page=[],timeEl="",deviceTmp,_carouselBox,_dataTableData,pTable;let dsDivs=[],dsPaths=[],carouselTmp=[],carouselChose=[],carouselIndex=0,carouselId=0;var carouselTime=0,carouselFlag="",scriptIndexTmp=[],scriptTmp=[],kanBans=[],kanBanItems=[],kanBanItemsTmp=[],kanBanProductItemsEl=[],kanBanProductItemsTables=[],tableSet=tableDefault(),_permissionList=[];let colName=[];let colSet=[];deviceTmp=[];_dataTableData={};let checkMouseMove;pTable=[];