function pageReady(){$("#kanBanList").select2();$("#deviceSelect").select2({allowClear:!0,placeholder:"请选择",multiple:!0});new Promise(n=>getDevice(n)).then(n=>{$("#deviceSelect").on("select2:select",function(){var t=$(this).val();t.indexOf("0")!=-1&&$(this).val(n).trigger("change")});kanBanChange()});var n=0;$("#navUl").on("click",".kanBan",function(){$("#fullScreenBtn").removeClass("hidden");var t=$(this).attr("href"),i=t.replace("#kanBan","");setChart(t,i);clearInterval(n);n=setInterval(()=>setChart(t,i),5e3)});$("#fullScreenBtn").on("click",function(){$("#tabBox").toggleClass("panel-fullscreen");var n=$("#tabBox").hasClass("panel-fullscreen");$(this).toggleClass("glyphicon-fullscreen glyphicon-repeat").prop("title",n?"还原":"全屏放大");n?$("#firstNavLi").addClass("hidden"):$("#firstNavLi").removeClass("hidden");fullScreen(n)});$("#firstNavLi").on("click",function(){clearInterval(n);$("#fullScreenBtn").addClass("hidden")})}function fullScreenCarousel(){$("#fullScreenCarousel").empty().append(_carouselBox).animate({top:0,opacity:1},1e3,"linear",()=>fullScreen(!0));setFullScreenCarousel($("#carouselInner .item:first").attr("id"));$("#carousel-example-generic").carousel({interval:1e4}).on("slide.bs.carousel",n=>setFullScreenCarousel(n.relatedTarget.id)).on("mouseenter",()=>$("#carousel-example-generic .isShow").removeClass("hidden")).on("mouseleave",()=>$("#carousel-example-generic .isShow").addClass("hidden"))}function setFullScreenCarousel(n){var t=n.replace("carousel_kanBan","");setChart(`#${n}`,t)}function cancelFullScreenCarousel(){$("#carousel-example-generic").carousel("pause").off("slide.bs.carousel mouseenter mouseleave");$("#fullScreenCarousel").animate({top:"-100%",opacity:0},1e3,"linear",function(){$(this).empty();fullScreen(!1)})}function setChart(n,t){var i={opType:509,opData:JSON.stringify({type:t})};ajaxPost("/Relay/Post",i,t=>{var i,l,e,a,o,v,u,f,s,h,c,tt;if(t.errno!=0){layer.msg(t.errmsg);return}i=t.data;l=setPieChart(`${n}_detail`,"Rate",i.AllProcessRate,"#0099ff");$(`${n}_yxTime`).text(codeTime(i.RunTime));$(`${n}_jgTime`).text(codeTime(i.ProcessTime));$(`${n}_xzTime`).text(codeTime(i.IdleTime));$(`${n}_lly`).text(l);e=`${i.MaxUse}台`;a=setPieChart(`${n}_max`,`Max
${e}`,i.MaxUseRate,"#00a65a");$(`${n}_maxTs`).text(`${i.MaxSimultaneousUseRate}台`);$(`${n}_maxTNum`).text(e);$(`${n}_maxSyl`).text(a);o=`${i.MinUse}台`;v=setPieChart(`${n}_min`,`Min
${o}`,i.MinUseRate,"#f39c12");$(`${n}_minTs`).text(`${i.MinSimultaneousUseRate}台`);$(`${n}_minTNum`).text(o);$(`${n}_minSyl`).text(v);var r=i.AllDevice,y=i.NormalDevice,p=i.ProcessDevice,w=i.IdleDevice,b=i.FaultDevice,k=i.ConnectErrorDevice;for(setPieChart(`${n}_state_all`,`${r}台`,r/r,"green","总设备"),setPieChart(`${n}_state_normal`,`${y}台`,y/r,"blue","正常运行"),setPieChart(`${n}_state_process`,`${p}台`,p/r,"#0099ff","加工中"),setPieChart(`${n}_state_idle`,`${w}台`,w/r,"#cc33ff","闲置中"),setPieChart(`${n}_state_fault`,`${b}台`,b/r,"red","故障中"),setPieChart(`${n}_state_error`,`${k}台`,k/r,"#ff00cc","连接异常"),s=i.UseCodeList||[],h="",u=0,f=s.length;u<f;u++)h+=`<div style="border:1px solid;padding:5px 10px;margin:3px;border-radius:20%;background:#bfa;font-weight:bold">${s[u]}</div>`;$(`${n}_dev`).empty().append(h||'<label style="color:red;font-size:18px">无<\/label>');var d=i.SingleProcessRate,g=[],nt=[];for(u=0,f=d.length;u<f;u++)c=d[u],g.push(c.Code),nt.push((c.Rate*100).toFixed(2));tt={tooltip:{trigger:"axis",formatter:"{a}<br/>{b} : {c}%",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"3%",top:"6%",bottom:"8%",containLabel:!0},xAxis:{type:"category",axisLine:{onZero:!1},data:g},yAxis:{name:"百分比",type:"value",scale:!0,axisLabel:{show:!0,formatter:"{value}%"}},series:{name:"利用率",type:"bar",areaStyle:{normal:{}},barWidth:"60%",label:{show:!0,position:"top",formatter:"{c}%"},itemStyle:{color:n=>n.value<30?"red":"green"},data:nt},dataZoom:[{type:"inside"},{handleIcon:_handleIcon,handleSize:"80%",handleStyle:{color:"#fff",shadowBlur:3,shadowColor:"rgba(0, 0, 0, 0.6)",shadowOffsetX:2,shadowOffsetY:2}}]};echarts.init($(`${n}_bar`)[0]).setOption(tt,!0);$(n).off("resize").on("resize",function(){clearTimeout(this.time);this.time=setTimeout(()=>{for(var t=$(this).find(".chart"),n=0,i=t.length;n<i;n++)echarts.init(t[n]).resize()},200)})},0)}function setPieChart(n,t,i,r,u){i=i||0;var e=`${(i*100).toFixed(2)}%`,f={color:["#cdcdcd",r],series:{type:"pie",center:["50%","50%"],radius:["65%","100%"],hoverAnimation:!1,animation:!1,silent:!0,label:{show:!0,position:"center",formatter:`${t}
${e}`,textStyle:{color:r,fontSize:18,fontWeight:700}},data:[1-i,i]}};return u&&(f.title={text:u,left:"center",textStyle:{color:r,fontSize:16}},f.series.center=["50%","57%"],f.series.radius=["57%","85%"]),echarts.init($(n)[0]).setOption(f,!0),e}function kanBanChange(){new Promise(n=>getKanBanList(n)).then(n=>{$("#kanBanList").off("select2:select").on("select2:select",function(){var i=$(this).val(),t=n[i];$("#kanBanName").val(t.Name);$("#deviceSelect").val(t.DeviceIdList).trigger("change");$("#isShow").iCheck(t.IsShow?"check":"uncheck")});$("#kanBanList").trigger("select2:select")})}function getKanBanList(n){var t={opType:509,opData:JSON.stringify({type:-1})};ajaxPost("/Relay/Post",t,t=>{var r,y,i,p,u;if(t.errno!=0){layer.msg(t.errmsg);return}var f=`<div class="row">
                    <div class="col-md-4">
                        <div class="box box-info">
                            <div class="box-header with-border">
                                <h3 class="box-title">设备详情</h3>
                            </div>
                            <div class="box-body">
                                <div class="flexStyle">
                                    <div id="{0}_detail" class="chart" style="width: 40%; height: 140px"></div>
                                    <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                        <label class="control-label textOverTop">运行时间：<span class="spanStyle" id="{0}_yxTime"></span></label>
                                        <label class="control-label textOverTop">加工时间：<span class="spanStyle" id="{0}_jgTime"></span></label>
                                        <label class="control-label textOverTop">闲置时间：<span class="spanStyle" id="{0}_xzTime"></span></label>
                                        <label class="control-label textOverTop">所有利用率：<span class="spanStyle" id="{0}_lly"></span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="box box-warning">
                            <div class="box-header with-border">
                                <h3 class="box-title">日最大使用率</h3>
                            </div>
                            <div class="box-body">
                                <div class="flexStyle">
                                    <div id="{0}_max" class="chart" style="width: 40%; height: 140px"></div>
                                    <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                        <label class="control-label textOverTop">日最大同时使用台数：<span class="spanStyle" id="{0}_maxTs"></span></label>
                                        <label class="control-label textOverTop">日最大使用台数：<span class="spanStyle" id="{0}_maxTNum"></span></label>
                                        <label class="control-label textOverTop">日最大使用率：<span class="spanStyle" id="{0}_maxSyl"></span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="box box-warning">
                            <div class="box-header with-border">
                                <h3 class="box-title">日最小使用率</h3>
                            </div>
                            <div class="box-body">
                                <div class="flexStyle">
                                    <div id="{0}_min" class="chart" style="width: 40%; height: 140px"></div>
                                    <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                        <label class="control-label textOverTop">日最小同时使用台数：<span class="spanStyle" id="{0}_minTs"></span></label>
                                        <label class="control-label textOverTop">日最小使用台数：<span class="spanStyle" id="{0}_minTNum"></span></label>
                                        <label class="control-label textOverTop">日最小使用率：<span class="spanStyle" id="{0}_minSyl"></span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="box box-info">
                            <div class="box-header with-border">
                                <h3 class="box-title">设备状态</h3>
                            </div>
                            <div class="box-body">
                                <div style="width: 100%;display:flex;flex-wrap:wrap">
                                    <div id="{0}_state_all" class="chart" style="height:180px;width:33.33%"></div>
                                    <div id="{0}_state_normal" class="chart" style="height:180px;width:33.33%"></div>
                                    <div id="{0}_state_process" class="chart" style="height:180px;width:33.33%"></div>
                                    <div id="{0}_state_idle" class="chart" style="height:180px;width:33.33%"></div>
                                    <div id="{0}_state_fault" class="chart" style="height:180px;width:33.33%"></div>
                                    <div id="{0}_state_error" class="chart" style="height:180px;width:33.33%"></div>
                                </div>
                                <label class="control-label textOverTop">当前加工设备：</label>
                                <div id="{0}_dev" style="width: 100%;display:flex;flex-wrap:wrap"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="box box-success">
                            <div class="box-header with-border">
                                <h3 class="box-title">单台加工利用率</h3>
                            </div>
                            <div class="box-body">
                                <div id="{0}_bar" class="chart" style="width: 100%; height: 480px"></div>
                            </div>
                        </div>
                    </div>
                </div>`,o=`<div class="tab-pane fade in" id="{0}">${f}</div>`,w=`<div class="item" id="{0}">${f}<div class="carousel-caption text-primary"><h3 class="text-primary isShow hidden">{1}</h3></div></div>`,b=`<div class="box box-primary">
                        <div class="box-header with-border">
                            <h3 class="box-title" style="margin-top:8px">看板轮播</h3>
                            <button class="btn btn-primary pull-right" onclick="cancelFullScreenCarousel()">取消轮播</button>
                        </div>
                        <div class="box-body">
                            <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                                <ol class="carousel-indicators isShow hidden">{0}</ol>
                                <div class="carousel-inner" id="carouselInner">{1}</div>
                                <a class="left carousel-control isShow hidden" href="#carousel-example-generic" data-slide="prev">
                                    <span class="glyphicon glyphicon-chevron-left text-primary" aria-hidden="true"></span>
                                </a>
                                <a class="right carousel-control isShow hidden" href="#carousel-example-generic" data-slide="next">
                                    <span class="glyphicon glyphicon-chevron-right text-primary" aria-hidden="true"></span>
                                </a>
                            </div>
                        </div>
                    </div>`,e=t.data;e.sort((n,t)=>n.Order-t.Order);var s="",h='<li><a href="#kanBan0" class="kanBan" data-toggle="tab" aria-expanded="false">所有设备<\/a><\/li>',c="",l='<li data-target="#carousel-example-generic" data-slide-to="0" class="active"><\/li>',a="",v={},k=0;for(r=0,y=e.length;r<y;r++)i=e[r],v[i.Id]=i,p=`${r+1}-${i.Name}`,s+=`<option value=${i.Id} order=${i.Order}>${p}</option>`,i.IsShow&&(u=`kanBan${i.Id}`,h+=`<li><a href="#${u}" class="kanBan" data-toggle="tab" aria-expanded="false">${i.Name}</a></li>`,c+=o.format(u),l+=`<li data-target="#carousel-example-generic" data-slide-to=${++k}></li>`,a+=w.format(`carousel_${u}`,i.Name));$("#kanBanList").empty().append(s);$("#firstNavLi").nextAll().remove().end().after(h);$("#setKanBan").nextAll().remove().end().after(`${o.format("kanBan0")}${c}`);_carouselBox=b.format(l,`<div class="item active" id="carousel_kanBan0">${f.format("carousel_kanBan0")}<div class="carousel-caption text-primary"><h3 class="text-primary isShow hidden">所有设备</h3></div></div>${a}`);n(v)})}function fullScreen(n){if(n){var t=document.body;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen?t.webkitRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen()}else document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():document.exitFullscreen&&document.exitFullscreen()}function getDevice(n){ajaxPost("/Relay/Post",{opType:100},t=>{var i,s,r,u;if(t.errno!=0){layer.msg(t.errmsg);return}var f=t.datas,e='<option value="0">全部<\/option>',o=[];for(i=0,s=f.length;i<s;i++)r=f[i],u=r.Id,e+=`<option value=${u}>${r.Code}</option>`,o.push(u);$("#deviceSelect").empty().append(e);n(o)})}function delKanBanList(){var n=$("#kanBanList").val(),t;if(isStrEmptyOrUndefined(n)){layer.msg("请选择需要删除的看板");return}t=()=>{var t={opType:512,opData:JSON.stringify({id:n})};ajaxPost("/Relay/Post",t,n=>{layer.msg(n.errmsg),n.errno==0&&kanBanChange()})};showConfirm(`删除：${$("#kanBanList :selected").text()}`,t)}function setAddKanBan(n){var o=n?($("#kanBanList option:last").attr("order")>>0)+1:$("#kanBanList :selected").attr("order"),u=$("#kanBanName").val().trim(),t,f,i,r,e;if(isStrEmptyOrUndefined(u)){layer.msg("看板名称不能为空");return}if(t=$("#deviceSelect").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}if(f=$("#isShow").is(":checked"),i={Name:u,DeviceIds:t.join(","),Order:o>>0,IsShow:f},!n){if(r=$("#kanBanList").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择需要设置的看板");return}i.Id=r>>0}e={opType:n?510:511,opData:JSON.stringify(i)};ajaxPost("/Relay/Post",e,n=>{layer.msg(n.errmsg),n.errno==0&&kanBanChange()})}var _carouselBox;