function pageReady(){var n,i,r;$(".sidebar-mini").addClass("sidebar-collapse");$("#kanBanList").select2();$("#deviceSelect").select2({allowClear:!0,placeholder:"请选择",multiple:!0});$("#navUl").on("click","a",function(){var n=$(this).attr("href").replace("#",""),f=n.replace("kanBan_","");const u=parseInt(f);if(curId!=u){curId=u;let r=-1;const i=kanBans[curId];i&&(r=i.Type);timeEl=n;r==2&&$(`#${n}_deviceState`).empty();curId>-1?(dsDivs[curId]=[],dsPaths[curId]=[],page[curId]=0,setChart(n,curId,r),clearInterval(uiTime),clearInterval(dataTime),t=(i.UI<1?1:i.UI)*1e3,uiTime=setInterval(()=>{run||setChart(n,curId,r,!0)},t),t=(i.Second<1?1:i.Second)*1e3,dataTime=setInterval(()=>{run||setChart(n,curId,r)},t)):(clearInterval(uiTime),clearInterval(dataTime))}});$(".content").on("click",".fullScreenBtn",function(){var t=`#${$(this).attr("target")}`,n;$(t).toggleClass("panel-fullscreen");n=$(t).hasClass("panel-fullscreen");$(this).toggleClass("glyphicon-fullscreen glyphicon-repeat").prop("title",n?"还原":"全屏放大");n?$(this).addClass("fsb"):$(this).removeClass("fsb");fullScreen(n)});setInterval(()=>{$(`#${timeEl}_time`).length>0&&$(`#${timeEl}_time`).text(getFullTime()),$(`#${carouselFlag}_time`).length>0&&$(`#${carouselFlag}_time`).text(getFullTime())},1e3);n=function(){$("#kanBanLength").val(($("#kanBanRow").val()>>0)*($("#kanBanCol").val()>>0))};$("#kanBanRow").on("input",n);$("#kanBanCol").on("input",n);i=new Promise(n=>getDevice(n));r=new Promise(n=>getKanBanList(n));Promise.all([i,r]).then(n=>{const i=n[0],t=n[1];$("#kanBanList").off("select2:select").on("select2:select",function(){var t=$(this).val(),n;if(t){n=kanBans[t];$("#kanBanName").val(n.Name);$("#kanBanOrder").val(n.Order);$("#isShow").iCheck(n.IsShow?"check":"uncheck");$("#setKanBan .stateEl").addClass("hidden");$("#kanBanType").val(n.Type).off("change").on("change",function(){var t=$(this).val();$("#setKanBan .stateEl").addClass("hidden");t==2&&($("#kanBanLength").val(n.Length),$("#setKanBan .stateEl").removeClass("hidden"),getScriptList())});$("#kanBanUI").val(n.UI);$("#kanBanSecond").val(n.Second);n.Type==2&&($("#kanBanRow").val(n.Row),$("#kanBanCol").val(n.Col),$("#kanBanLength").val(n.Length),$("#setKanBan .stateEl").removeClass("hidden"),scriptIndexTmp=[],scriptTmp=[],$("#kanBanScript").html(""));$("#deviceSelect").val(n.DeviceIdList).trigger("change")}});$("#deviceSelect").on("select2:select",function(){var n=$(this).val();~n.indexOf("0")&&$(this).val(i).trigger("change")}).on("change",function(){const n=$(this).val();if(isStrEmptyOrUndefined(n)){scriptIndexTmp=[];scriptTmp=[];$("#kanBanScript").html("");return}var t=[];n.forEach(n=>{if(n!=0){var i=deviceTmp[n].ScriptId;~t.indexOf(i)||t.push(i);~scriptIndexTmp.indexOf(i)?existArrayObj(scriptTmp[i].ds,"id",n)||scriptTmp[i].ds.push({id:n,code:deviceTmp[n].Code}):(scriptIndexTmp.push(i),scriptTmp[i]={sId:i,sName:deviceTmp[n].ScriptName,ds:[{id:n,code:deviceTmp[n].Code}]})}});scriptIndexTmp=t;scriptTmp.forEach(t=>{const i=t.sId;if(~scriptIndexTmp.indexOf(i)){const t=scriptTmp[i].ds.map(n=>n.id);t.forEach(t=>{~n.indexOf(t)||removeArray(scriptTmp[i].ds,"id",t)});scriptTmp[i].ds.length==0&&delete scriptTmp[i]}else scriptTmp[i].div&&$(`#${scriptTmp[i].div}`).remove(),delete scriptTmp[i]});const i=$("#kanBanType").val();i==2&&getScriptList()});t.length>0&&$("#kanBanList").val(t[0].Id).trigger("select2:select")})}function getDevice(n){var t={opType:100,opData:JSON.stringify({detail:!0,state:!1})};ajaxPost("/Relay/Post",t,t=>{var i,e;if(t.errno!=0){layer.msg(t.errmsg);return}var r=SortNumberString(t.datas,"Code"),u='<option value="0">全部<\/option>',f=[];for(i=0,e=r.length;i<e;i++){const n=r[i];deviceTmp[n.Id]=n;u+=`<option value=${n.Id}>${n.Code}</option>`;f.push(n.Id)}$("#deviceSelect").empty().append(u);n(f)},0)}function getKanBanList(n){const t=$("#kanBanList").val();var i={opType:509,opData:JSON.stringify({init:!0})};ajaxPost("/Relay/Post",i,i=>{var r,f,h,p,u;if(i.errno!=0){layer.msg(i.errmsg);return}$("#kanBanType").html(`${setOptions(i.menu,"Type")}`);r=i.data;const s=r.length;if(!(s<=0)){f=`<div class="box box-primary">
                    <div class="box-header with-border">
                        <label class="control-label textOverTop no-margin middle">时间信息：<span id="{0}_time"></span></label>
                        <span class="glyphicon glyphicon-fullscreen pointer fullScreenBtn {1}" target="{0}"
                            style="position: absolute; right: 15px; top: 15px; font-size: 20px;z-index:1" title="全屏放大" aria-hidden="true"></span>
                    </div>
                    <div>
                         <div class="row">
                            <div class="col-md-4">
                                <div class="box box-info">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">设备详情</h3>
                                    </div>
                                    <div class="box-body">
                                        <div class="flexStyle">
                                            <div id="{0}_detail" class="chart" style="width: 40%; height: 140px"></div>
                                            <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                                <label class="control-label textOverTop">运行时间：<span class="spanStyle" id="{0}_yxTime"></span></label>
                                                <label class="control-label textOverTop">加工时间：<span class="spanStyle" id="{0}_jgTime"></span></label>
                                                <label class="control-label textOverTop">闲置时间：<span class="spanStyle" id="{0}_xzTime"></span></label>
                                                <label class="control-label textOverTop">所有利用率：<span class="spanStyle" id="{0}_lly"></span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="box box-warning">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">日最大使用率</h3>
                                    </div>
                                    <div class="box-body">
                                        <div class="flexStyle">
                                            <div id="{0}_max" class="chart" style="width: 40%; height: 140px"></div>
                                            <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                                <label class="control-label textOverTop">日最大同时使用台数：<span class="spanStyle" id="{0}_maxTs"></span></label>
                                                <label class="control-label textOverTop">日最大使用台数：<span class="spanStyle" id="{0}_maxTNum"></span></label>
                                                <label class="control-label textOverTop">日最大使用率：<span class="spanStyle" id="{0}_maxSyl"></span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="box box-warning">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">日最小使用率</h3>
                                    </div>
                                    <div class="box-body">
                                        <div class="flexStyle">
                                            <div id="{0}_min" class="chart" style="width: 40%; height: 140px"></div>
                                            <div class="flexStyle" style="width: 60%;height: 150px;flex-flow: column;justify-content: space-around; align-items: flex-start;padding-left:5%">
                                                <label class="control-label textOverTop">日最小同时使用台数：<span class="spanStyle" id="{0}_minTs"></span></label>
                                                <label class="control-label textOverTop">日最小使用台数：<span class="spanStyle" id="{0}_minTNum"></span></label>
                                                <label class="control-label textOverTop">日最小使用率：<span class="spanStyle" id="{0}_minSyl"></span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="box box-info">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">设备状态</h3>
                                    </div>
                                    <div class="box-body">
                                        <div style="width: 100%;display:flex;flex-wrap:wrap">
                                            <div id="{0}_state_all" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_normal" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_process" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_idle" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_fault" class="chart" style="height:180px;width:33.33%"></div>
                                            <div id="{0}_state_error" class="chart" style="height:180px;width:33.33%"></div>
                                        </div>
                                        <label class="control-label textOverTop">当前加工设备：</label>
                                        <div id="{0}_dev" style="width: 100%;display:flex;flex-wrap:wrap"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="box box-success">
                                    <div class="box-header with-border">
                                        <h3 class="box-title">单台加工利用率</h3>
                                    </div>
                                    <div class="box-body">
                                        <div id="{0}_bar" class="chart" style="width: 100%; height: 480px"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="box box-success">
                            <div class="box-header with-border">
                                <h3 class="box-title">生产数据</h3>
                            </div>
                            <div class="box-body">
                                <div>
                                    <label class="control-label textOverTop"><span class="text-red">加工设备数：</span><span class="spanStyle" id="{0}_devs"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">加工数：</span><span class="spanStyle" id="{0}_pros"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">合格数：</span><span class="spanStyle" id="{0}_heGes"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">裂片数：</span><span class="spanStyle" id="{0}_liePians"></span></label>
                                    <label class="control-label textOverTop"><span class="text-red">合格率：</span><span class="spanStyle" id="{0}_rates"></span></label>
                                </div>
                                <div style="overflow-y: auto">
                                    <table border="1" class="table-td">
                                        <tbody>
                                            <tr id="{0}_devOps">
                                                <td class="text-red bg-info">机台号</td>
                                            </tr>
                                            <tr id="{0}_proOps">
                                                <td class="text-red bg-info">加工数</td>
                                            </tr>
                                            <tr id="{0}_heGeOps">
                                                <td class="text-red bg-info">合格数</td>
                                            </tr>
                                            <tr id="{0}_liePianOps">
                                                <td class="text-red bg-info">裂片数</td>
                                            </tr>
                                            <tr id="{0}_rateOps">
                                                <td class="text-red bg-info">合格率</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;h=`<div class="tab-pane fade in" id="{0}">${f}</div>`;const c=`<div class="kb_div1">
                <div class="kb_border1">
                <div class="kb_border2">
                <div class="form-group no-margin ttDiv">
                    <label class="control-label textOverTop no-margin middle kb_time1">时间信息：<span id="{0}_time"></span></label>
                    <h3 class="text-center text-bold kb_title1" style="color: cyan; padding: 10px;">监控平台</h3>
                    <span class="glyphicon glyphicon-fullscreen pointer kb_fullscreen1 fullScreenBtn {1}" target="{0}" title="全屏放大" aria-hidden="true"></span>
                    <div class="form-group no-margin mPadding">
                        <label class="control-label text-bold no-margin bg-green mPadding text-center" style="width: 15%; font-size: 17px;">
                            加工：<label class="control-label no-margin" id="{0}_jg" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin mPadding text-center" style="width: 15%; font-size: 17px; background: #f47920; color:white;">
                            闲置：<label class="control-label no-margin" id="{0}_xz" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin bg-blue mPadding text-center" style="width: 15%; font-size: 17px;">
                            正常：<label class="control-label no-margin" id="{0}_zc" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin bg-red mPadding text-center" style="width: 15%; font-size: 17px;">
                            故障：<label class="control-label no-margin" id="{0}_gz" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin mPadding text-center" style="width: 15%; font-size: 17px; background: gray; color:white;">
                            未连接：<label class="control-label no-margin" id="{0}_wlj" style="font-size: 17px;">0</label>
                        </label>
                        <label class="control-label text-bold no-margin mPadding text-center" style="width: 15%; color: cyan; font-size: 17px;">
                            共：<label class="control-label no-margin" id="{0}_sum" style="font-size: 17px;">0</label>台
                        </label>
                    </div>
                </div>
                <div class="box box-primary no-box-shadow no-margin kb_div2 dsDiv">
                    <div class="box-header no-padding">
                    </div>
                    <div class="box-body no-padding">
                        <div class="kb_flex_div1" id="{0}_deviceState">
                        </div>
                    </div>
                </div>
                </div>
                </div>
            </div>`,w=`<div class="tab-pane kb_body fade in" id="{0}">${c}</div>`,l=`<div class="item kb_body" id="{0}">{1}<div class="carousel-caption text-primary"><h3 class="text-primary isShow hidden">{2}</h3></div></div>`;var a="",v="",y="",e="",o="";carouselTmp=[];p=0;for(let n=0;n<s;n++){const t=r[n];kanBans[t.Id]=t;const i=`${n+1}-${t.Name}`;if(v+=`<div class="flexStyle pointer choseBox mPadding">
                        <label class="flexStyle pointer">
                            <input type="checkbox" class="icb_minimal" value=${t.Id}>
                            <span style="margin-left: 5px">${t.Name}</span>
                        </label>
                    </div>`,t.Id!==0&&(a+=`<option value=${t.Id} order=${t.Order}>${i}</option>`),t.IsShow){u=`kanBan_${t.Id}`;y+=`<li><a href="#${u}" class="kanBan" data-toggle="tab" aria-expanded="false">${t.Name}</a></li>`;const n=`carousel_${u}`;switch(t.Type){case 1:e+=h.format(u,"");o=l.format(n,f.format(n,"hidden"),t.Name);break;case 2:e+=w.format(u,"");o=l.format(n,c.format(n,"hidden"),t.Name)}carouselTmp[t.Id]||(carouselTmp[t.Id]={});carouselTmp[t.Id]={carouselLi:`<li data-target="#carousel-example-generic" data-slide-to=${p++}></li>`,carouselTab:o}}}$("#carouselDiv").empty().append(v).find(`.icb_minimal`).iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"}).on("ifChanged",function(){var n=$(this).val();$(this).is(":checked")?carouselChose.push({id:n,Order:kanBans[n].Order}):removeArray(carouselChose,"id",n);carouselChose.sort(sortOrder)});$("#kanBanList").empty().append(a);t&&$("#kanBanList").val(t).trigger("select2:select");$("#firstNavLi").nextAll().remove().end().after(y);$("#setKanBan").nextAll().remove().end().after(e);r=r.filter(n=>n.Id!==0);n&&n(r)}},0)}function setAddKanBan(n){const i=$("#kanBanName").val().trim();if(isStrEmptyOrUndefined(i))return void layer.msg("看板名称不能为空");const r=$("#kanBanType").val()>>0;if(isStrEmptyOrUndefined(r))return void layer.msg("看板类型错误");const e=$("#kanBanOrder").val()>>0,u=$("#deviceSelect").val();if(isStrEmptyOrUndefined(u))return void layer.msg("请选择设备");const o=$("#kanBanUI").val()>>0,s=$("#kanBanSecond").val()>>0,h=$("#kanBanRow").val()>>0,c=$("#kanBanCol").val()>>0,l=$("#isShow").is(":checked");let t=[];scriptIndexTmp.forEach(n=>{var i=scriptTmp[n];const r=`${i.divVal}Data`,u=`${i.divIn}Data`,f=`${i.divOut}Data`;i&&i[r]&&i[u]&&i[f]&&(t=t.concat(i[r],i[u],i[f]))});const f={Type:r,IsShow:l,Name:i,DeviceIds:u.join(","),Order:e,UI:o,Second:s,Row:h,Col:c,Variables:JSON.stringify(t)};if(!n){const n=$("#kanBanList").val();if(isStrEmptyOrUndefined(n))return void layer.msg("请选择需要修改的看板");f.Id=n>>0}const a={opType:n?510:511,opData:JSON.stringify(f)};ajaxPost("/Relay/Post",a,n=>{layer.msg(n.errmsg),n.errno==0&&getKanBanList()})}function delKanBanList(){var n=$("#kanBanList").val(),t;if(isStrEmptyOrUndefined(n)){layer.msg("请选择需要删除的看板");return}t=()=>{var t={opType:512,opData:JSON.stringify({id:n})};ajaxPost("/Relay/Post",t,n=>{layer.msg(n.errmsg),n.errno==0&&getKanBanList()})};showConfirm(`删除：${$("#kanBanList :selected").text()}`,t)}function getScriptList(){var n={opType:106,opData:JSON.stringify({sIds:scriptIndexTmp.join()})};ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}var r=`<div class="box box-info" id="{0}">
                <div class="box-header with-border">
                    <h3 class="box-title"><lable class="text-red text-bold name">{1}</lable> - <lable class="text-blue text-bold code" title="{2}">{3}</lable></h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="col-md-4">
                        <label class="control-label">变量：</label>
                        <div class="flexStyle" style="justify-content: flex-end">
                            <select class="form-control thText" style="max-width: 80px" onchange="dataTableSearch.call(this, '{4}')">
                                <option value="0">序号</option>
                                <option value="1">名称</option>
                                <option value="2">地址</option>
                            </select>
                            <select class="form-control sym" style="max-width: 100px" onchange="dataTableSearch.call(this, '{4}')">
                                <option value="0">等于</option>
                                <option value="1">不等于</option>
                                <option value="2">包含</option>
                            </select>
                            <input type="text" class="form-control val" placeholder="搜索" style="max-width: 150px" oninput="dataTableSearch.call(this, '{4}')">
                        </div>
                        <div class="table-responsive mailbox-messages">
                            <table class="table table-hover table-striped table-condensed" id="{4}"></table>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="control-label">输入：</label>
                        <div class="flexStyle" style="justify-content: flex-end">
                            <select class="form-control thText" style="max-width: 80px" onchange="dataTableSearch.call(this, '{5})'">
                                <option value="0">序号</option>
                                <option value="1">名称</option>
                                <option value="2">地址</option>
                            </select>
                            <select class="form-control sym" style="max-width: 100px" onchange="dataTableSearch.call(this, '{5}')">
                                <option value="0">等于</option>
                                <option value="1">不等于</option>
                                <option value="2">包含</option>
                            </select>
                            <input type="text" class="form-control val" placeholder="搜索" style="max-width: 150px" oninput="dataTableSearch.call(this, '{5}')">
                        </div>
                        <div class="table-responsive mailbox-messages">
                            <table class="table table-hover table-striped table-condensed" id="{5}"></table>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="control-label">输出：</label>
                        <div class="flexStyle" style="justify-content: flex-end">
                            <select class="form-control thText" style="max-width: 80px" onchange="dataTableSearch.call(this, '{6}')">
                                <option value="0">序号</option>
                                <option value="1">名称</option>
                                <option value="2">地址</option>
                            </select>
                            <select class="form-control sym" style="max-width: 100px" onchange="dataTableSearch.call(this, '{6}')">
                                <option value="0">等于</option>
                                <option value="1">不等于</option>
                                <option value="2">包含</option>
                            </select>
                            <input type="text" class="form-control val" placeholder="搜索" style="max-width: 150px" oninput="dataTableSearch.call(this, '{6}')">
                        </div>
                        <div class="table-responsive mailbox-messages">
                            <table class="table table-hover table-striped table-condensed" id="{6}"></table>
                        </div>
                    </div>
                </div>
            </div>`;const u=$("#kanBanList").val(),t=kanBans[u],i=n.datas;scriptIndexTmp.forEach(n=>{if(scriptTmp[n]){const o=scriptTmp[n],h=o.sName;let s=SortNumberString(o.ds,"code").map(n=>n.code).join(),c=`${s.length>tdShowLengthLong?`${s.substring(0,tdShowLengthLong)}...`:s}`;var u=i.filter(t=>t.ScriptId==n&&t.VariableTypeId==1),f=i.filter(t=>t.ScriptId==n&&t.VariableTypeId==2),e=i.filter(t=>t.ScriptId==n&&t.VariableTypeId==3);if(o.divVal=`valList_${n}`,o.divIn=`insList_${n}`,o.divOut=`outList_${n}`,o.div)$(`#${o.div}>.box-header .name`).text(h),$(`#${o.div}>.box-header .code`).text(s),$(`#${o.div} .val`).text(""),updateTable(_dataTableData[o.divVal],u),updateTable(_dataTableData[o.divIn],f),updateTable(_dataTableData[o.divOut],e);else{o.div=`sc_${n}`;o[`${o.divVal}Trs`]=[];o[`${o.divIn}Trs`]=[];o[`${o.divOut}Trs`]=[];o[`${o.divVal}Data`]=[];o[`${o.divIn}Data`]=[];o[`${o.divOut}Data`]=[];s=s.repeat(5);$("#kanBanScript").append(r.format(o.div,h,s,c,o.divVal,o.divIn,o.divOut));let i=dataTableConfig(0,!0);i.bLengthChange=!1;i.iDisplayLength=20;i.dom='<"pull-left"l><"pull-right hidden"f>rt<"text-center"i><"table-flex"p>';i.addColumns([{data:"VariableName",title:"名称"},{data:"PointerAddress",title:"地址",sClass:"add"},{data:null,title:"自定义名称",render:n=>{var i=t.VariableList.filter(t=>t.ScriptId==n.ScriptId&&t.VariableTypeId==n.VariableTypeId&&t.PointerAddress==n.PointerAddress),r=i.length>0?i[0].VariableName:"";return tableSet.input("name",r)}},{data:null,title:"显示顺序",render:n=>{var i=t.VariableList.filter(t=>t.ScriptId==n.ScriptId&&t.VariableTypeId==n.VariableTypeId&&t.PointerAddress==n.PointerAddress),r=i.length>0?i[0].Order:"";return tableSet.numberInput("order","50px",r)}}]);const l=`${o.divVal}Data`,a=`${o.divIn}Data`,v=`${o.divOut}Data`;i.updateData(u);i.drawCallback=function(){const i=`${o.divVal}Trs`,t=l;initCheckboxAddEvent.call(this,o[i],(i,r)=>{const u=$(i).find(".name").val(),f=$(i).find(".order").val()>>0;o[t].push({Id:r.Id,ScriptId:n,VariableTypeId:1,PointerAddress:r.PointerAddress,VariableName:u?u:"",Order:f?f:0});disabledChose(o,l,a,v)},(n,i)=>{removeArray(o[t],"Id",i.Id),enableChose(o.divVal,o.divIn,o.divOut)},!1,"Checked");initInputChangeEvent.call(this,(n,i)=>{const r=$(n).find(".name").val(),u=$(n).find(".order").val()>>0;o[t].length>0&&o[t].every(n=>n.Id==i.Id?(n.VariableName=r,n.Order=u,!1):!0)});o[l].length+o[a].length+o[v].length>=maxSet?disabledChose(o,l,a,v):enableChose(o.divVal,o.divIn,o.divOut)};i.createdRow=function(i,r){var u=!1;t.VariableList.every(t=>r.ScriptId==t.ScriptId&&r.VariableTypeId==t.VariableTypeId&&r.PointerAddress==t.PointerAddress?(u=!0,o[l].push({Id:r.Id,ScriptId:n,VariableTypeId:1,VariableName:t.VariableName,PointerAddress:t.PointerAddress,Order:t.Order}),!1):!0);$(i).find(".isEnable").iCheck(u?"check":"uncheck");u&&$(i).find(".textOn").text("").addClass("hidden").siblings(".textIn").removeClass("hidden")};_dataTableData[o.divVal]=$(`#${o.divVal}`).DataTable(i);i.updateData(f);i.drawCallback=function(){const i=`${o.divIn}Trs`,t=a;initCheckboxAddEvent.call(this,o[i],(i,r)=>{const u=$(i).find(".name").val(),f=$(i).find(".order").val()>>0;o[t].push({Id:r.Id,ScriptId:n,VariableTypeId:2,PointerAddress:r.PointerAddress,VariableName:u?u:"",Order:f?f:0});disabledChose(o,l,a,v)},(n,i)=>{removeArray(o[t],"Id",i.Id),enableChose(o.divVal,o.divIn,o.divOut)},!1,"Checked");initInputChangeEvent.call(this,(n,i)=>{const r=$(n).find(".name").val(),u=$(n).find(".order").val()>>0;o[t].length>0&&o[t].every(n=>n.Id==i.Id?(n.VariableName=r,n.Order=u,!1):!0)});o[l].length+o[a].length+o[v].length>=maxSet?disabledChose(o,l,a,v):enableChose(o.divVal,o.divIn,o.divOut)};i.createdRow=function(i,r){var u=!1;t.VariableList.every(t=>r.ScriptId==t.ScriptId&&r.VariableTypeId==t.VariableTypeId&&r.PointerAddress==t.PointerAddress?(u=!0,o[a].push({Id:r.Id,ScriptId:n,VariableTypeId:2,VariableName:t.VariableName,PointerAddress:t.PointerAddress,Order:t.Order}),!1):!0);$(i).find(".isEnable").iCheck(u?"check":"uncheck");u&&$(i).find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden")};_dataTableData[o.divIn]=$(`#${o.divIn}`).DataTable(i);i.updateData(e);i.drawCallback=function(){const i=`${o.divOut}Trs`,t=v;initCheckboxAddEvent.call(this,o[i],(i,r)=>{const u=$(i).find(".name").val(),f=$(i).find(".order").val()>>0;o[t].push({Id:r.Id,ScriptId:n,VariableTypeId:3,PointerAddress:r.PointerAddress,VariableName:u?u:"",Order:f?f:0});disabledChose(o,l,a,v)},(n,i)=>{removeArray(o[t],"Id",i.Id),enableChose(o.divVal,o.divIn,o.divOut)},!1,"Checked");initInputChangeEvent.call(this,(n,i)=>{const r=$(n).find(".name").val(),u=$(n).find(".order").val()>>0;o[t].length>0&&o[t].every(n=>n.Id==i.Id?(n.VariableName=r,n.Order=u,!1):!0)});o[l].length+o[a].length+o[v].length>=maxSet?disabledChose(o,l,a,v):enableChose(o.divVal,o.divIn,o.divOut)};i.createdRow=function(i,r){var u=!1;t.VariableList.every(t=>r.ScriptId==t.ScriptId&&r.VariableTypeId==t.VariableTypeId&&r.PointerAddress==t.PointerAddress?(u=!0,o[v].push({Id:r.Id,ScriptId:n,VariableTypeId:3,VariableName:t.VariableName,PointerAddress:t.PointerAddress,Order:t.Order}),!1):!0);$(i).find(".isEnable").iCheck(u?"check":"uncheck");u&&$(i).find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden")};_dataTableData[o.divOut]=$(`#${o.divOut}`).DataTable(i)}}})},0)}function disabledChose(n,t,i,r){n[t].length+n[i].length+n[r].length>=maxSet&&(disabledTableCheck(n.divVal,n[t].map(n=>n.Id)),disabledTableCheck(n.divIn,n[i].map(n=>n.Id)),disabledTableCheck(n.divOut,n[r].map(n=>n.Id)))}function enableChose(n,t,i){enableTableCheck(n);enableTableCheck(t);enableTableCheck(i)}function dataTableSearch(n){const r=_dataTableData[n],i=$(this).parent();var t=i.find(".val").val().trim();if(r.columns([0,1,2,3]).search("").draw(),!isStrEmptyOrUndefined(t)){const n=i.find(".sym").val();n==0?t=`^${t}$`:n==1&&(t=`^(?!${t}$).+$`);const u=(i.find(".thText").val()>>0)+1;r.columns(u).search(t,!0,!1).draw()}}function fullScreenCarousel(){var n=`<div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title" style="margin-top:8px">看板轮播<span class="ftitle"></span></h3>
                <button class="btn btn-primary pull-right" onclick="cancelFullScreenCarousel()">取消轮播</button>
            </div>
            <div class="box-body">
                <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators isShow hidden">{0}</ol>
                    <div class="carousel-inner">{1}</div>
                    <a class="left carousel-control isShow hidden" href="#carousel-example-generic" data-slide="prev">
                        <span class="glyphicon glyphicon-chevron-left text-primary" aria-hidden="true"></span>
                    </a>
                    <a class="right carousel-control isShow hidden" href="#carousel-example-generic" data-slide="next">
                        <span class="glyphicon glyphicon-chevron-right text-primary" aria-hidden="true"></span>
                    </a>
                </div>
            </div>
        </div>`;if(carouselChose.length){const t=carouselChose.reduce((n,t)=>`${n}${carouselTmp[t.id].carouselLi}`,""),i=carouselChose.reduce((n,t)=>`${n}${carouselTmp[t.id].carouselTab}`,"");_carouselBox=n.format(t,i);carouselChose.forEach(n=>{page[n.id]=0,dsDivs[n.id]=[],dsPaths[n.id]=[]});carouselId=0;carouselIndex=0;$("#fullScreenCarousel").empty().append(_carouselBox);$("#fullScreenCarousel").find("ol li:first").addClass("active");$("#fullScreenCarousel").find(".item:first").addClass("active");$("#fullScreenCarousel").animate({top:0,opacity:1},1e3,"linear",()=>{});carouselFlag=$("#fullScreenCarousel .item:first").attr("id");setFullScreenCarousel(carouselFlag);$("#carousel-example-generic").carousel({interval:1e4}).off("slide.bs.carousel").on("slide.bs.carousel",n=>{if(carouselFlag=n.relatedTarget.id,carouselId=carouselFlag.replace("carousel_kanBan_",""),kanBans[carouselId]){if($(`#fullScreenCarousel .ftitle`).text(` - ${kanBans[carouselId].Name}`),carouselFlag=="")return;setChart(carouselFlag,carouselId,kanBans[carouselId].Type,!0)}}).on("mouseenter",()=>$("#carousel-example-generic .isShow").removeClass("hidden")).on("mouseleave",()=>$("#carousel-example-generic .isShow").addClass("hidden"))}}function setFullScreenCarousel(){(clearInterval(carouselTime),carouselFlag!="")&&(carouselTime=setInterval(()=>{if(carouselId=carouselFlag.replace("carousel_kanBan_",""),kanBans[carouselId]){if($(`#fullScreenCarousel .ftitle`).text(` - ${kanBans[carouselId].Name}`),carouselFlag=="")return;setChart(carouselFlag,carouselId,kanBans[carouselId].Type,!0)}},5e3))}function cancelFullScreenCarousel(){clearInterval(carouselTime);carouselFlag="";$("#carousel-example-generic").carousel("pause").off("slide.bs.carousel mouseenter mouseleave");$("#fullScreenCarousel").animate({top:"-100%",opacity:0},1e3,"linear",function(){$(this).empty();fullScreen(!1)})}function setChart(n,t,i,r=false){var u,f;if(!run){run=!0;u=`#${n}`;const e=page[t]?page[t]:0;f={opType:509,opData:JSON.stringify({qId:t,page:e})};ajaxPost("/Relay/Post",f,e=>{var o,l,s,rt,ut,ft,b,et,k,ot,a,g,nt,pt,h,ti,ii,ri,p,ui,tt,w,it;run=!1;const v="text-red",y="text-gray";if(e.errno==0?(rt=$(`${u}_time`).text(),ut=e.time,Math.abs(dateDiffSec(ut,rt))>10?($(`${u}_time`).toggleClass(v),$(`${u}_time`).toggleClass(y)&&$(`${u}_time`).removeClass(y)):($(`${u}_time`).toggleClass(y),$(`${u}_time`).hasClass(v)&&$(`${u}_time`).removeClass(v))):($(`${u}_time`).hasClass(v)||$(`${u}_time`).addClass(v),$(`${u}_time`).hasClass(y)&&$(`${u}_time`).removeClass(y)),s=e.data,i==1){if(e.errno!=0)return;ft=setPieChart(`${u}_detail`,"Rate",s.AllProcessRate,"#0099ff");$(`${u}_yxTime`).text(codeTime(s.RunTime));$(`${u}_jgTime`).text(codeTime(s.ProcessTime));$(`${u}_xzTime`).text(codeTime(s.IdleTime));$(`${u}_lly`).text(ft);b=`${s.MaxUse}台`;et=setPieChart(`${u}_max`,`Max
${b}`,s.MaxUseRate,"#00a65a");$(`${u}_maxTs`).text(`${s.MaxSimultaneousUseRate}台`);$(`${u}_maxTNum`).text(b);$(`${u}_maxSyl`).text(et);k=`${s.MinUse}台`;ot=setPieChart(`${u}_min`,`Min
${k}`,s.MinUseRate,"#f39c12");$(`${u}_minTs`).text(`${s.MinSimultaneousUseRate}台`);$(`${u}_minTNum`).text(k);$(`${u}_minSyl`).text(ot);var c=s.AllDevice,st=s.NormalDevice,d=s.ProcessDevice,ht=s.IdleDevice,ct=s.FaultDevice,lt=s.ConnectErrorDevice;for(setPieChart(`${u}_state_all`,`${c}台`,c/c,"green","总设备"),setPieChart(`${u}_state_normal`,`${st}台`,st/c,"blue","正常运行"),setPieChart(`${u}_state_process`,`${d}台`,d/c,"#0099ff","加工中"),setPieChart(`${u}_state_idle`,`${ht}台`,ht/c,"#cc33ff","闲置中"),setPieChart(`${u}_state_fault`,`${ct}台`,ct/c,"red","故障中"),setPieChart(`${u}_state_error`,`${lt}台`,lt/c,"#ff00cc","连接异常"),g=s.UseCodeList||[],l="",o=0,a=g.length;o<a;o++)l+=`<div style="border:1px solid;padding:5px 10px;margin:3px;border-radius:20%;background:#bfa;font-weight:bold">${g[o]}</div>`;$(`${u}_dev`).empty().append(l||'<label style="color:red;font-size:18px">无<\/label>');var at=s.SingleProcessRate,vt=[],yt=[];for(o=0,a=at.length;o<a;o++)nt=at[o],vt.push(nt.Code),yt.push((nt.Rate*100).toFixed(2));pt={tooltip:{trigger:"axis",formatter:"{a}<br/>{b} : {c}%",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"3%",top:"6%",bottom:"8%",containLabel:!0},xAxis:{type:"category",axisLine:{onZero:!1},data:vt},yAxis:{name:"百分比",type:"value",scale:!0,axisLabel:{show:!0,formatter:"{value}%"}},series:{name:"利用率",type:"bar",areaStyle:{normal:{}},barWidth:"60%",label:{show:!0,position:"top",formatter:"{c}%"},itemStyle:{color:n=>n.value<30?"red":"green"},data:yt},dataZoom:[{type:"inside"},{handleIcon:_handleIcon,handleSize:"80%",handleStyle:{color:"#fff",shadowBlur:3,shadowColor:"rgba(0, 0, 0, 0.6)",shadowOffsetX:2,shadowOffsetY:2}}]};echarts.init($(`${u}_bar`)[0]).setOption(pt,!0);$(u).off("resize").on("resize",function(){clearTimeout(this.time);this.time=setTimeout(()=>{for(var t=$(this).find(".chart"),n=0,i=t.length;n<i;n++)echarts.init(t[n]).resize()},200)});var wt=s.ProductionList,bt="",kt="",dt="",gt="",ni="";for(o=0,a=wt.length;o<a;o++){const n=wt[o];bt+=`<td class="text-blue">${n.Code}</td>`;kt+=`<td>${n.FaChu}</td>`;dt+=`<td>${n.HeGe}</td>`;gt+=`<td>${n.LiePian}</td>`;ni+=`<td>${(n.Rate*100).toFixed(2)}%</td>`}$(`${u}_devs`).text(d);$(`${u}_pros`).text(s.FaChu);$(`${u}_heGes`).text(s.HeGe);$(`${u}_liePians`).text(s.LiePian);$(`${u}_rates`).text(`${(s.Rate*100).toFixed(2)}%`);$(`${u}_devOps`).find("td:not(:first)").remove().end().append(bt);$(`${u}_proOps`).find("td:not(:first)").remove().end().append(kt);$(`${u}_heGeOps`).find("td:not(:first)").remove().end().append(dt);$(`${u}_liePianOps`).find("td:not(:first)").remove().end().append(gt);$(`${u}_rateOps`).find("td:not(:first)").remove().end().append(ni)}else if(i==2){if(h=`${u}_deviceState`,e.errno!=0){dsDivs[t].forEach(n=>{$(`#${n}`).addClass("hi")});$(`${h} .hi`).css("display","none").removeClass("hi");return}ti=`<div id="{0}" class="kb_device_div1 ds" style="display:none;">
                    <div style="height: 33%;position: relative;display: flex;">
                        <div style="width: 35%;position: relative;">
                            <img id="{0}_img" class="kb_img1" src="">
                        </div>
                        <div style="width: 50%;position: relative;">
                            <label id="{0}_code" class="text-blue" style="margin: 0;font-size: 16px;"></label>
                            <br>
                            <label id="{0}_mc" class="" style="margin: 0;white-space: nowrap;color: #f15a22;"></label>
                            <br>
                            <label id="{0}_ws" class="" style="margin: 0;white-space: nowrap;color: #005831;"></label>
                        </div>
                        <div id="{0}_state" style="width: 23px;height: 23px;position: absolute;top: 0;right: 0;/* float: right; */"></div>
                    </div>
                    <div style="top: 2%; height: 65%; position: relative;" id="{0}_detail"></div>
                </div>`;ii=`<div class="form-group no-margin" style="height:calc(100%/6);">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 no-margin text-blue no-padding kb_param1">
                        <label class=" control-label no-margin text-blue no-padding">{0}</label>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 no-margin text-blue no-padding kb_param1">
                        <label class="control-label no-margin text-blue no-padding">{1}</label>
                    </div>
                </div>`;const i=dsDivs[t].length;if(i!==e.len){l="";ri=Math.abs(e.len-i);for(let r=0;r<ri;r++){const u=`${n}_ds${i+r}`;i<e.len?(dsDivs[t].push(u),l+=ti.format(u)):i>e.len&&removeArray(dsDivs[t],u)}i<e.len?$(`${h}`).append(l):i>e.len&&$(`${h} .rm`).remove()}const b=$(`${u} .dsDiv`);b.length>0&&(p=$(window).height(),$(`${u}`).css("height",`${p}px`),p=$(`${u} .kb_border2`).height()>>0,ui=$(`${u} .ttDiv`).height()>>0,$(`${u} .dsDiv`).css("height",`${p-ui}px`));const c=SortNumberString(s,"Code");let a=c.length;if(!a){dsDivs[t].forEach(n=>{$(`#${n}`).addClass("hi")});$(`${h} .hi`).css("display","none").removeClass("hi");$(h).append('<div class="no-data" style="font:bold 25px/35px 微软雅黑;color:red">无数据<\/div>');return}const y=`${h} .no-data`;$(y).length>0&&$(y).remove();tt=n=>{var l,v,f,s;if(n)for(a=n.length,o=0;o<a;o++)l=n[o],dsPaths[t][l.name]||(dsPaths[t][l.name]=l.path);const nt=Object.keys(dsPaths[t]).length;if(!(nt<=0)){for(v=[],c.forEach(n=>v[n.Id]=1),o=0;o<i;o++){const n=`${u}_ds${o}`;if(f=c[o],f){s="red";switch(f.DeviceStateStr){case"加工中":s="#00A65C";break;case"待机":case"流程升级中":case"固件升级中":case"设备重启中":case"连接正常":s="#f47920";break;case"已报修":case"已确认":case"维修中":s="red";break;default:s="gray"}const i=f.Data.reduce((n,t)=>n+ii.format(t.VName,t.V),"");$(`${n}_img`).attr("src",dsPaths[t][f.Icon]);$(`${n}_code`).text(f.Code);$(`${n}_mc`).text(`${f.CategoryName}-${f.ModelName}`);$(`${n}_ws`).text(f.SiteName);$(`${n}_state`).css("background",s);$(`${n}_detail`).html(i);$(`${n}`).addClass("sh")}else $(`${n}`).addClass("hi")}$(`${h} .sh`).css("display","block").removeClass("sh");$(`${h} .hi`).css("display","none").removeClass("hi");$(`${u}_jg`).text(e.jg);$(`${u}_xz`).text(e.xz);$(`${u}_zc`).text(e.zc);$(`${u}_gz`).text(e.gz);$(`${u}_wlj`).text(e.wlj);$(`${u}_sum`).text(e.sum);var y=$(".ds"),tt=y.length>0?($(y[0]).css("margin").replace("px","")>>0)*2:5,it=($(h).css("padding").replace("px","")>>0)*2;if(e.row>0){var p=$(h).width(),w=Math.floor(p/def),rt=e.col>w?w:e.col,b=Math.floor(p/rt)-tt,ut=$(window).height();$(`${u}`).css("height",`${ut}px`);var k=$(h).closest(".dsDiv").height(),d=Math.floor(k/def),ft=e.row>d?d:e.row,g=Math.floor(k/ft)-it;$(".ds").css("flex-basis",`${b<def?def:b}px`).css("height",`${g<def?def:g}px`)}r&&(page[t]=++e.cp)}};const v=[];for(o=0;o<a;o++)w=c[o],dsPaths[t][w.Icon]||~v.lastIndexOf(w.Icon)||v.push(w.Icon);if(v.length>0){f={type:fileEnum.Device,files:JSON.stringify(v)};f.dir="";for(it in fileEnum)if(fileEnum[it]==f.type){f.dir=it;break}if(isStrEmptyOrUndefined(f.dir))return void layer.msg("文件类型不存在！");getFilePath(f,tt,0)}else tt()}},0)}}function setPieChart(n,t,i,r,u){i=i||0;var e=`${(i*100).toFixed(2)}%`,f={color:["#cdcdcd",r],series:{type:"pie",center:["50%","50%"],radius:["65%","100%"],hoverAnimation:!1,animation:!1,silent:!0,label:{show:!0,position:"center",formatter:`${t}
${e}`,textStyle:{color:r,fontSize:18,fontWeight:700}},data:[1-i,i]}};return u&&(f.title={text:u,left:"center",textStyle:{color:r,fontSize:16}},f.series.center=["50%","57%"],f.series.radius=["57%","85%"]),echarts.init($(n)[0]).setOption(f,!0),e}var def=180,curId=-1,t=0,uiTime=0,dataTime=0,run=!1,page=[],maxSet=6,timeEl="",deviceTmp,_carouselBox,_dataTableData;let dsDivs=[],dsPaths=[],carouselTmp=[],carouselChose=[],carouselIndex=0,carouselId=0;var carouselTime=0,carouselFlag="",scriptIndexTmp=[],scriptTmp=[],kanBans=[],tableSet=tableDefault();deviceTmp=[];_dataTableData={};