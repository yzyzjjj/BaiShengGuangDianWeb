function pageReady(){$(".ms2").select2();getDevice();$("#chartTypeSelect").on("change",()=>$("#chartTypeSelect").val()==0?$("#chartSelect").addClass("hidden"):$("#chartSelect").removeClass("hidden"));$("#selectCodeHistory").on("select2:select",()=>getHistoryScript());$("#historyPage").one("click",()=>getHistoryScript())}function getDevice(){var n={};n.opType=100;n.opData=JSON.stringify({hard:!0});ajaxPost("/Relay/Post",n,function(n){var i,t;if(n.errno!=0){layer.msg(n.errmsg);return}_codeData={};var r=n.datas,u="";for(i=0;i<r.length;i++)t=r[i],_codeData[t.Id]=t,u+='<option value="{0}" script="{1}">{2}<\/option>'.format(t.Id,t.ScriptId,t.Code);$("#selectCode,#selectCodeHistory").empty().append(u);getCodeDetail()})}function getCodeDetail(){var t,n;if($("#script").text(_codeData[$("#selectCode").val()].ScriptName),t=$("#selectCode :selected").attr("script"),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}n={};n.opType=106;n.opData=JSON.stringify({id:t});ajaxPost("/Relay/Post",n,function(n){var i,t,u,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(i=n.datas,_codeDetailObj={1:[],2:[],3:[]},t=0,u=i.length;t<u;t++)r=i[t],_codeDetailObj[r.VariableTypeId].push(r);getScriptValue()})}function getScriptValue(){var t=$("#selectCode").val(),n;if(isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}n={};n.opType=109;n.opData=JSON.stringify({all:!0,qId:t});ajaxPost("/Relay/Post",n,function(n){var t,i;if(n.errno!=0){layer.msg(n.errmsg);return}var r=n.datas[0]||[],o=r.vals||[],s=r.ins||[],h=r.outs||[],u=(n,t,i,r,u)=>n[u.row]||"",f={dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-0"i><"col-sm-12"p>',pagingType:"full",destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,sort:!0,info:!1,searching:!0,autoWidth:!0,language:oLanguage,iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"VariableName",title:"名称"},{data:"PointerAddress",title:"地址"},{data:null,title:"值"}]},e=$.extend(!0,{},f);e.data=_codeDetailObj[1];e.columns[3].render=u.bind(null,o);$("#valList").DataTable(e);t=$.extend(!0,{},f);t.data=_codeDetailObj[2];t.columns[3].render=u.bind(null,s);$("#insList").DataTable(t);i=$.extend(!0,{},f);i.data=_codeDetailObj[3];i.columns[3].render=u.bind(null,h);$("#outList").DataTable(i)})}function getHistoryScript(){var t,n;if($("#historyScript").text(_codeData[$("#selectCodeHistory").val()].ScriptName),t=$("#selectCodeHistory :selected").attr("script"),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}n={};n.opType=106;n.opData=JSON.stringify({id:t});ajaxPost("/Relay/Post",n,function(n){var e,t,r,c,i,l,u,f;if(n.errno!=0){layer.msg(n.errmsg);return}for(e=n.datas,t={1:[],2:[],3:[]},_historyData={},r=0,c=e.length;r<c;r++)i=e[r],l=i.VariableTypeId,t[l].push(i),_historyData[i.Id]=i;var o=(n,t)=>`<button type="button" class="btn btn-success btn-xs" onclick="addVar('${n}',${t})"><i class="fa fa-plus"></i></button>`,s={dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-0"i><"col-sm-12"p>',pagingType:"full",destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,sort:!0,info:!1,searching:!0,autoWidth:!0,language:oLanguage,iDisplayLength:10,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"VariableName",title:"名称"},{data:"PointerAddress",title:"地址"},{data:"Id",title:"添加",orderable:!1}]},h=$.extend(!0,{},s);h.data=t[1];h.columns[3].render=o.bind(null,"vals");$("#historyValList").DataTable(h);u=$.extend(!0,{},s);u.data=t[2];u.columns[3].render=o.bind(null,"ins");$("#historyInsList").DataTable(u);f=$.extend(!0,{},s);f.data=t[3];f.columns[3].render=o.bind(null,"outs");$("#historyOutList").DataTable(f)})}function getHistoryData(){var i=$("#selectCodeHistory").val(),n;if(isStrEmptyOrUndefined(i)){layer.msg("请选择设备");return}if(n=$("#reservationTime").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择时间");return}n=n.split(" 至 ");var r=n[0],u=n[1],t={};t.opType=507;t.opData=JSON.stringify({StartTime:r,EndTime:u,DeviceId:i,DeviceData:_deviceData});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=n.datas})}function addVar(n,t){var f,i,e,u,r;_deviceData[n].indexOf(t)==-1&&_deviceData[n].push(t);f=$("#chartTypeSelect").val();switch(f){case"0":_flag++;i=`table${_flag}`;_tableType[i]={id:[t],data:[_historyData[t]]};$("#chartSelect").append(`<option value=${_flag}>表${_flag}</option>`);e=`<div class="box box-success">
                        <div class="box-header with-border">
                            <h3 class="box-title">表${_flag}</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="删除"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="nav-tabs-custom">
                                        <ul class="nav nav-tabs ui-sortable-handle">
                                            <li class="active hidden"><a href="#${i}_val" data-toggle="tab" aria-expanded="true">变量</a></li>
                                            <li class="hidden"><a href="#${i}_ins" data-toggle="tab" aria-expanded="false">输入</a></li>
                                            <li class="hidden"><a href="#${i}_out" data-toggle="tab" aria-expanded="false">输出</a></li>
                                        </ul>
                                        <div class="tab-content no-padding">
                                            <div class="tab-pane active in" id="${i}_val"></div>
                                            <div class="tab-pane fade in" id="${i}_ins"></div>
                                            <div class="tab-pane fade in" id="${i}_out"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="chart" style="width: 100%;height:400px;"></div>
                                </div>
                            </div>
                        </div>
                     </div>`;$("#tableChart").append(e);break;case"1":u=$("#chartSelect").val();isStrEmptyOrUndefined(u)?layer.msg("目前未存在相关表"):(r=_tableType[`table${u}`],r.id.indexOf(t)==-1?(r.id.push(t),r.data.push(_historyData[t])):layer.msg(`${$("#chartSelect :selected").text()}已存在该名称`))}}var _codeData=null,_codeDetailObj=null,_historyData=null,_deviceData={vals:[],ins:[],outs:[]},_tableType={},_flag=0;