function pageReady(){$(".ms2").select2();getDevice();$("#chartTypeSelect").on("change",()=>$("#chartTypeSelect").val()==0?$("#chartSelect").addClass("hidden"):$("#chartSelect").removeClass("hidden"));$("#selectCodeHistory").on("select2:select",()=>{getHistoryScript(),$("#tableChart,#chartSelect").empty(),_tableType={},_flag=0,$("#tableChart").off("resize")});$("#historyPage").one("click",()=>getHistoryScript());$("#sDate,#eDate").val(getDate()).datepicker("update");$(window).on("scroll",()=>$(document).scrollTop()>900?$("#backTop").fadeIn():$("#backTop").fadeOut());$("#backTop").on("click",()=>{$("html,body").stop().animate({scrollTop:0})})}function dataTableSearch(n){var u=_dataTableData[n],i=$(this).parent(),t=i.find(".val").val().trim(),r,f;u.columns([0,1,2,3]).search("").draw();isStrEmptyOrUndefined(t)||(r=i.find(".sym").val(),r==0?t=`^${t}$`:r==1&&(t=`^(?!${t}$).+$`),f=i.find(".thText").val(),u.columns(f).search(t,!0,!1).draw())}function getDevice(){var n={};n.opType=100;n.opData=JSON.stringify({hard:!0});ajaxPost("/Relay/Post",n,function(n){var i,f,u,r,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(_codeData={},i=n.datas,i.sort((n,t)=>n.Code-t.Code),f='<option value="{0}" script="{1}">{2}<\/option>',u="",r=0;r<i.length;r++)t=i[r],_codeData[t.Id]=t,u+=f.format(t.Id,t.ScriptId,t.Code);$("#selectCode,#selectCodeHistory").empty().append(u);getCodeDetail()})}function getCodeDetail(){var t,n;if($("#script").text(_codeData[$("#selectCode").val()].ScriptName),t=$("#selectCode :selected").attr("script"),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}n={};n.opType=106;n.opData=JSON.stringify({id:t});ajaxPost("/Relay/Post",n,function(n){var i,t,u,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(i=n.datas,_codeDetailObj={1:[],2:[],3:[]},t=0,u=i.length;t<u;t++)r=i[t],_codeDetailObj[r.VariableTypeId].push(r);getScriptValue()})}function getScriptValue(){var t=$("#selectCode").val(),n;if(isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}n={};n.opType=109;n.opData=JSON.stringify({all:!0,qId:t});ajaxPost("/Relay/Post",n,function(n){var i,r,u;if(n.errno!=0){layer.msg(n.errmsg);return}var f=n.datas[0]||[],o=f.vals||[],s=f.ins||[],h=f.outs||[],e=(n,t,i,r,u)=>n[u.row]||0,t=$.extend(!0,{},_tablesConfig);t.iDisplayLength=20;t.columns[3]={data:null,title:"值"};i=$.extend(!0,{},t);i.data=_codeDetailObj[1];i.columns[3].render=e.bind(null,o);_dataTableData.valList=$("#valList").DataTable(i);r=$.extend(!0,{},t);r.data=_codeDetailObj[2];r.columns[3].render=e.bind(null,s);_dataTableData.insList=$("#insList").DataTable(r);u=$.extend(!0,{},t);u.data=_codeDetailObj[3];u.columns[3].render=e.bind(null,h);_dataTableData.outList=$("#outList").DataTable(u)})}function getHistoryScript(){var i=$("#selectCodeHistory").val(),t,n;if(!isStrEmptyOrUndefined(i)){if($("#historyScript").text(_codeData[i].ScriptName),t=$("#selectCodeHistory :selected").attr("script"),isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}n={};n.opType=106;n.opData=JSON.stringify({id:t});ajaxPost("/Relay/Post",n,function(n){var h,i,u,c,r,l,f,t,e,o,s;if(n.errno!=0){layer.msg(n.errmsg);return}for(h=n.datas,i={1:[],2:[],3:[]},_historyData={},u=0,c=h.length;u<c;u++)r=h[u],l=r.VariableTypeId,i[l].push(r),_historyData[r.Id]=r;f=(n,t)=>`<button type="button" class="btn btn-success btn-xs" onclick="addVar('${n}',${t.Id})"><i class="fa fa-plus"></i></button>`;t=$.extend(!0,{},_tablesConfig);t.iDisplayLength=10;t.columns[3]={data:null,title:"添加",orderable:!1};e=$.extend(!0,{},t);e.data=i[1];e.columns[3].render=f.bind(null,"vals");_dataTableData.historyValList=$("#historyValList").DataTable(e);o=$.extend(!0,{},t);o.data=i[2];o.columns[3].render=f.bind(null,"ins");_dataTableData.historyInsList=$("#historyInsList").DataTable(o);s=$.extend(!0,{},t);s.data=i[3];s.columns[3].render=f.bind(null,"outs");_dataTableData.historyOutList=$("#historyOutList").DataTable(s)})}}function getHistoryData(){var s=$("#selectCodeHistory").val(),n,o,t,i,e,r;if(isStrEmptyOrUndefined(s)){layer.msg("请选择设备");return}var h=$("#sDate").val().trim(),u=$("#sTime").val().trim(),c=$("#eDate").val().trim(),f=$("#eTime").val().trim();if(isStrEmptyOrUndefined(h)||isStrEmptyOrUndefined(u)||isStrEmptyOrUndefined(c)||isStrEmptyOrUndefined(f)){layer.msg("请选择时间");return}if(u=`${h} ${u}`,f=`${c} ${f}`,compareDate(u,f)){layer.msg("开始时间不能大于结束时间");return}if(new Date(f)-new Date(u)>36e5){layer.msg("时间不能超过一小时");return}for(n={vals:[],ins:[],outs:[]},o=Object.values(_tableType).flat(),i=0,e=o.length;i<e;i++){const t=o[i];switch(t.VariableTypeId){case 1:n.vals.push(t.PointerAddress);break;case 2:n.ins.push(t.PointerAddress);break;case 3:n.outs.push(t.PointerAddress)}}for(t in n)n[t]=[...new Set(n[t])];if(!n.vals.length&&!n.ins.length&&!n.outs.length){layer.msg("请先添加地址");return}r={};r.opType=507;r.opData=JSON.stringify({StartTime:u,EndTime:f,DeviceId:s,DeviceData:n});ajaxPost("/Relay/Post",r,function(u){var o,s,l,a;if(u.errno!=0){layer.msg(u.errmsg);return}var h=u.data,c=[],f={};for(t in h){c.push(t.replace(" ","\n"));const i=h[t];$.each(n.vals,(n,t)=>{f[`vals${t}`]?f[t].push(i.vals[n]):f[t]=[i.vals[n]]});$.each(n.ins,(n,t)=>{f[`ins${t}`]?f[t].push(i.ins[n]):f[t]=[i.ins[n]]});$.each(n.outs,(n,t)=>{f[`outs${t}`]?f[t].push(i.outs[n]):f[t]=[i.outs[n]]})}for(t in _tableType){for(r=_tableType[t],o=[],s=[],i=0,e=r.length;i<e;i++){const t=r[i],u=t.VariableName;o.push(u);let n="";switch(t.VariableTypeId){case 1:n="vals";break;case 2:n="ins";break;case 3:n="outs"}s.push({name:u,type:"line",data:f[`${n}${t.PointerAddress}`],showSymbol:!1,sampling:"average",showAllSymbol:!1})}l={tooltip:{trigger:"axis"},grid:{left:"3%",right:"3%",top:"6%",bottom:"18%",containLabel:!0},legend:{data:o},xAxis:{type:"category",data:c},yAxis:{type:"value"},series:s,dataZoom:[{type:"slider",start:0,end:20,bottom:0},{type:"inside",start:0,end:20}],toolbox:{top:20,left:"center",feature:{dataZoom:{yAxisIndex:"none"},restore:{}}}};echarts.init($(`#${t}_chart`)[0]).setOption(l,!0)}a=()=>{var n=new Date;return()=>{var t=new Date,i;if(t-n>=200){for(i in _tableType)echarts.init($(`#${i}_chart`)[0]).resize();n=t}}};$("#tableChart").off("resize").on("resize",a())})}function addVar(n,t){var u=`<div class="flexStyle box-header" style="justify-content: flex-end">
                        <select class="form-control thText" style="max-width:80px" onchange="searchTr.call(this,'{0}','{1}')">
                            <option value="num">序号</option>
                            <option value="name">名称</option>
                            <option value="res">地址</option>
                        </select>
                        <select class="form-control sym" style="max-width:100px" onchange="searchTr.call(this,'{0}','{1}')">
                            <option value="0">等于</option>
                            <option value="1">不等于</option>
                            <option value="2">包含</option>
                        </select>
                        <input type="text" class="form-control val" placeholder="搜索" style="max-width:150px" oninput="searchTr.call(this,'{0}','{1}')">
                    </div>
                    <div style="overflow: auto;max-height:300px">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>名称</th>
                                    <th>地址</th>
                                    <th>删除</th>
                                </tr>
                            </thead>
                            <tbody id="{0}_{1}_tbody"></tbody>
                        </table>
                    </div>`,o='<tr><td class="num">1<\/td><td class="name">{0}<\/td><td class="res">{4}<\/td><td><button type="button" class="btn btn-danger btn-xs" onclick="delVarTr.call(this,{1},\'{2}\',\'{3}\')"><i class="fa fa-minus"><\/i><\/button><\/td><\/tr>',i,h=$("#chartTypeSelect").val(),r=_historyData[t],s,f,e;switch(h){case"0":_flag++;i=`table${_flag}`;_tableType[i]=[r];$("#chartSelect").append(`<option value=${_flag}>表${_flag}</option>`);s=`<div class="box box-success {0}">
                        <div class="box-header with-border">
                            <h3 class="box-title">表${_flag}</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="删除" onclick="delTableBox.call(this,'{0}')"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="nav-tabs-custom">
                                        <ul class="nav nav-tabs ui-sortable-handle">
                                            <li class="active hidden" id="{0}_vals_li"><a href="#{0}_vals" data-toggle="tab" aria-expanded="true">变量</a></li>
                                            <li class="hidden" id="{0}_ins_li"><a href="#{0}_ins" data-toggle="tab" aria-expanded="false">输入</a></li>
                                            <li class="hidden" id="{0}_outs_li"><a href="#{0}_outs" data-toggle="tab" aria-expanded="false">输出</a></li>
                                        </ul>
                                        <div class="tab-content no-padding">
                                            <div class="tab-pane active in" id="{0}_vals">{1}</div>
                                            <div class="tab-pane fade in" id="{0}_ins">{2}</div>
                                            <div class="tab-pane fade in" id="{0}_outs">{3}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div id="{0}_chart" style="width: 100%;height:400px"></div>
                                </div>
                            </div>
                        </div>
                     </div>`;$("#tableChart").append(s.format(i,u.format(i,"vals"),u.format(i,"ins"),u.format(i,"outs")));$(`#${i}_${n}_tbody`).append(o.format(r.VariableName,r.Id,n,i,r.PointerAddress));$(`#${i}_${n}_li`).removeClass("hidden").find("a").click();break;case"1":f=$("#chartSelect").val();isStrEmptyOrUndefined(f)?layer.msg("目前未存在相关表"):(i=`table${f}`,e=_tableType[i],e.includes(r)?layer.msg(`${$("#chartSelect :selected").text()}已存在名称：<span style="font-weight:bold">${r.VariableName}</span>`):(e.push(r),$(`#${i}_${n}_tbody`).append(o.format(r.VariableName,r.Id,n,i,r.PointerAddress)),setNumTotalOrder(`${i}_${n}_tbody`),$(`#${i}_${n}_li`).removeClass("hidden")))}}function searchTr(n,t){var f=$(this).parent(),o=f.find(".val").val().trim(),e=$(`#${n}_${t}_tbody tr`),i,s,h,r,c,u,l;if(isStrEmptyOrUndefined(o))e.removeClass("hidden");else{i=new Function;s=f.find(".sym").val();switch(s){case"0":i=(n,t)=>n==t;break;case"1":i=(n,t)=>n!=t;break;case"2":i=(n,t)=>n.indexOf(t)!=-1}for(h=f.find(".thText").val(),r=0,c=e.length;r<c;r++)u=e.eq(r),l=u.find(`.${h}`).text(),i(l,o)?u.removeClass("hidden"):u.addClass("hidden")}}function setNumTotalOrder(n){for(var i=$(`#${n}`).find(".num"),t=0,r=i.length;t<r;t++)i.eq(t).text(t+1)}function delTableBox(n){setTimeout(()=>$(this).parents(`.${n}`).remove(),2e3);$(`#chartSelect option[value=${n.split("table")[1]}]`).remove();delete _tableType[n]}function delVarTr(n,t,i){$(this).parents("tr").remove();var r=_tableType[i];r.splice(r.indexOf(_historyData[n]),1);setNumTotalOrder(`${i}_${t}_tbody`)}var _dataTableData={},_codeData=null,_codeDetailObj=null,_tablesConfig={dom:'<"pull-left"l><"pull-right hidden"f>rt<"text-center"i><"table-flex"p>',destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,sort:!0,searching:!0,autoWidth:!0,language:oLanguage,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"VariableName",title:"名称"},{data:"PointerAddress",title:"地址"}]},_historyData=null,_tableType={},_flag=0;