function pageReady(){var n,t;_permissionList[700]={uIds:[]};_permissionList[701]={uIds:["getProcessDetailBtn"]};_permissionList=checkPermissionUi(_permissionList);_permissionList[700].have||$(".createChart").addClass("hidden");$(".ms2").select2();$("#selectDevice,#selectDevice1").select2({allowClear:!0,placeholder:"请选择"});$(".icb_minimal").iCheck({checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"});$("#selectDevice").on("select2:select",function(){const n=$(this).val();n.indexOf("0,所有设备")>-1&&$(this).val("0,所有设备").trigger("change")});getWorkShopList();getDeviceList();$(".form_date").val(getDate()).datepicker("update");$("#selectWorkShop").on("select2:select",function(){$("#recordChart").empty();var n=$(this).val();new Promise(t=>n=="所有车间"?getDeviceList(t):getWorkShopDevice(t,n)).then(n=>$("#selectDevice").empty().append(`<option value="0">所有设备</option>${n}`))});n=!0;$("#selectWorkShop1").on("select2:select",function(){$("#processDetailList").empty();$("#checkAll").iCheck("uncheck");var n=$(this).val();new Promise(t=>n=="所有车间"?getDeviceList(t):getWorkShopDevice(t,n)).then(n=>$("#selectDevice1").empty().append(n))});$("#checkAll").on("ifChanged",function(){var t,u=$("#selectDevice1").find("option").length,i,r;if($(this).is(":checked")){for(i=[],t=0;t<u;t++)r=$("#selectDevice1").find("option").eq(t).val(),i.push(r);$("#selectDevice1").val(i).trigger("change");n=!0;$(".select2-selection__clear").css("marginTop","9px")}else n&&$("#selectDevice1").val([]).trigger("change")});$("#selectDevice1").on("select2:unselect",function(){n=!1;$("#checkAll").iCheck("uncheck")});$("#selectDevice1").on("select2:select",function(){$(".select2-selection__clear").css("marginTop","9px");var n=$("#selectDevice1").find("option").length,t=$("#selectDevice1").val().length;n==t&&$("#checkAll").iCheck("check")});$("#selectDevice1").next(".select2-container").css("maxHeight","37px").css("overflowY","auto");$("#parTime input,#parTime span,#par input,#par span").css("verticalAlign","middle");radioTime();$("#selectStartDate,#selectStartTime,#selectEndDate,#selectEndTime").on("change",function(){radioTime()});$("#selectJhList").select2();selectPlan();$(".planHead").on("ifChanged",function(){$(this).is(":checked")?$(".planBody").removeClass("hidden"):($(".planBody").addClass("hidden"),$("#selectJhList").val($("#selectJhList").find("option:first").val()).trigger("change"))});$("#productionWorkShop").on("select2:select",function(){var n=$(this).val();new Promise(t=>n=="所有车间"?getDeviceList(t):getWorkShopDevice(t,n)).then(n=>$("#productionDevice").empty().append(n).trigger("select2:select"))});$("#productionDevice").on("select2:select",function(){$("#deviceType").text(_deviceType[$(this).val()])});t=0;$("#production_chart").on("resize",function(){clearTimeout(t);t=setTimeout(()=>echarts.init($(this)[0]).resize(),200)})}function radioTime(){var t=$("#selectStartDate").val()+" "+$("#selectStartTime").val(),n,i;t.slice(t.indexOf(" ")+1,t.indexOf(":")).length==1&&(t=$("#selectStartDate").val()+" 0"+$("#selectStartTime").val());n=$("#selectEndDate").val()+" "+$("#selectEndTime").val();n.slice(n.indexOf(" ")+1,n.indexOf(":")).length==1&&(n=$("#selectEndDate").val()+" 0"+$("#selectEndTime").val());exceedTime(t)||exceedTime(n)||compareDate(t,n)?$("#parTime label").removeClass("hidden"):($("#parTime label").removeClass("hidden"),i=new Date(n)-new Date(t),i>leadTimeDay?($("#parTime label").eq(0).addClass("hidden"),$("#parTime label").eq(0).iCheck("uncheck"),i>leadTimeMonth&&($("#parTime label").eq(1).addClass("hidden"),$("#parTime label").eq(1).iCheck("uncheck"))):($("#parTime label").eq(3).addClass("hidden"),$("#parTime label").eq(3).iCheck("uncheck"),i<=leadTimeHour&&($("#parTime label").eq(2).addClass("hidden"),$("#parTime label").eq(2).iCheck("uncheck"),i<=leadTimeMinute&&($("#parTime label").eq(1).addClass("hidden"),$("#parTime label").eq(1).iCheck("uncheck")))))}function getWorkShopList(){var n={};n.opType=162;ajaxPost("/Relay/Post",n,function(n){var t,u,f;if(n.errno!=0){layer.msg(n.errmsg);return}var i=n.datas,r='<option value = "所有车间">所有车间<\/option>';for(t=0,u=i.length;t<u;t++)f=i[t],r+='<option value = "{0}">{0}<\/option>'.format(f.Name);$("#selectWorkShop,#selectWorkShop1,#productionWorkShop").empty().append(r)})}function getDeviceList(n){var t={};t.opType=100;t.opData=JSON.stringify({detail:!0,work:!0});ajaxPost("/Relay/Post",t,function(t){var u,e,i,f,o,r;if(t.errno!=0){layer.msg(t.errmsg);return}for(_deviceType={},u=t.datas,u.sort((n,t)=>n.Code-t.Code),e='<option value="{0}">{1}<\/option>',i="",f=0,o=u.length;f<o;f++)r=u[f],i+=e.format(r.Id,r.Code),_deviceType[r.Id]=r.CategoryName;n?n(i):($("#selectDevice").empty().append(`<option value="0">所有设备</option>${i}`),$("#selectDevice1,#productionDevice").empty().append(i),$("#deviceType").text(_deviceType[$("#productionDevice").val()]))})}function getWorkShopDevice(n,t){var i={};i.opType=163;i.opData=JSON.stringify({workshopName:t});ajaxPost("/Relay/Post",i,t=>{var i,e,r;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,f="";for(i=0,e=u.length;i<e;i++)r=u[i],f+='<option value="{0}">{1}<\/option>'.format(r.Id,r.Code);n(f)})}function createChart(n,t){var i=$("#selectDevice").val(),o,c,u,s,l,f,r,e,h;if(isStrEmptyOrUndefined(i)){layer.msg("请选择设备");return}if(!$("#par label").find(".icb_minimal").is(":checked")){layer.msg("请选择参数");return}if(o=$("#selectWorkShop").val(),isStrEmptyOrUndefined(o)){layer.msg("请选择车间");return}for(c=$("#selectDevice :selected"),u=[],s=0,l=c.length;s<l;s++)u.push(c.eq(s).text());if(isStrEmptyOrUndefined(n)?f=$("#selectStartDate").val()+" "+$("#selectStartTime").val():(f=n,$("#selectStartDate").val(n.split(" ")[0]).datepicker("update"),$("#selectStartTime").val(n.split(" ")[1]).timepicker("setTime",n.split(" ")[1])),isStrEmptyOrUndefined(t)?r=$("#selectEndDate").val()+" "+$("#selectEndTime").val():(r=t,$("#selectEndDate").val(r.split(" ")[0]).datepicker("update"),$("#selectEndTime").val(r.split(" ")[1]).timepicker("setTime",r.split(" ")[1])),exceedTime(f)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(f,r)){layer.msg("结束时间不能小于开始时间");return}dataTime=0;e=new Date(r)-new Date(f);leadTimeMonth>e&&e>=leadTimeDay&&(dataTime=1);e>=leadTimeMonth&&(dataTime=2);e>=leadTimeHour&&e<leadTimeDay&&(dataTime=3);$("#parTime .icb_minimal").is(":checked")&&(dataTime=$("#parTime").find("input:checked").val());h={};h.opType=502;h.opData=JSON.stringify({WorkshopName:o=="所有车间"?"":o,DeviceId:i.join(","),StartTime:f,EndTime:r,DataType:dataTime,Compare:i.length==1?0:1});ajaxPost("/Relay/Post",h,function(n){var v,t,k,y,p,nt,tt,it;if(n.errno!=0){layer.msg(n.errmsg);return}$("#recordChart").empty();for(var w=$("#par label").find(".icb_minimal").length,h=-1,rt=function(n){for(var r,i="",t=0,u=n.length;t<u;t++)r=n[t].name,i+="{0}: {1}<br/>".format(n[t].seriesName,n[t].seriesName=="使用率"?n[t].value+"%":n[t].value);return r+"<br/>"+i},c=[],f=0;f<w;f++){var d=$("#par label").find(".icb_minimal")[f],g=$("#par label")[f],e=[],o,r=[],s,l,b,a;if($(d).is(":checked")){h++;e[$(g).text()]=$(d).val();o=$(g).text();v=o=="同时加工台数"||o=="总台数"||o=="使用率"?!0:!1;for(t in e)e.hasOwnProperty(t)&&(r[t]=[]);for(objectSort(n.datas,"DeviceId"),objectSort(n.datas,"Time"),s=0;s<n.datas.length;s++){h==0&&(k=n.datas[s].Time,dataTime==2?c.push(k.split(" ")[0]):c.push(k.replace(" ","\n")));y=n.datas[s];for(t in e)if(e.hasOwnProperty(t))if(v)r[t].push(y[e[t]]);else for(l=r[t].length%i.length;l<i.length;l++)if(i[l]==y.DeviceId)if(r[t].push(y[e[t]]),s==n.datas.length-1&&r[t].length%i.length!=0){for(b=0;b<r[t].length%i.length;b++)r[t].push("x");break}else break;else r[t].push("x"),t==o&&l==i.length-1&&s--}h==0&&(c=distinct(c));p=[];for(t in e)if(e.hasOwnProperty(t))if(v)p.push({name:o,type:"line",data:r[t],showSymbol:!1,sampling:"average",showAllSymbol:!1});else for(a=0;a<u.length;a++)p.push({name:u[a],type:"line",data:r[t].filter(function(n,t){return t%u.length==a}),showSymbol:!1,sampling:"average",showAllSymbol:!1});nt='<div id="chart'+h+'" style="width: 100%; height: 500px"><\/div>';$("#recordChart").append(nt);tt=echarts.init(document.getElementById("chart"+h));it={title:{text:o},tooltip:{trigger:"axis",formatter:rt},grid:{bottom:70},xAxis:{type:"category",data:c,axisLine:{onZero:!1}},yAxis:{type:"value"},legend:{data:v?[o]:u},series:p,dataZoom:[{type:"slider",start:0,end:100},{type:"inside",start:0,end:100}],toolbox:{top:20,left:"center",feature:{dataZoom:{yAxisIndex:"none"},restore:{},magicType:{type:["line","bar"]}}}};tt.setOption(it,!0)}}$("#recordChart").resize(function(){for(w=$("#recordChart").children().length,f=0;f<w;f++)echarts.init(document.getElementById("chart"+f)).resize()})})}function hourChart(){var t=getFullTime(),n=(new Date).format(" hh"),i=(new Date).format("dd "),r;r=(n-1).toString().length==1?t.replace(n," 0"+(n-1)):t.replace(n," "+(n-1));n==" 00"&&(r=t.replace(n," 23").replace(i,i-1+" "),(i-1).toString().length!=1&&(r=t.replace(n," 23").replace(i,"0"+(i-1)+" ")));createChart(r,t)}function dayChart(){var n=getFullTime(),t=getDayAgo(1)+" "+getTime();createChart(t,n)}function monthChart(){var n=getFullTime(),i=(new Date).format("-MM"),t=(new Date).format("MM"),r;r=(t-1).toString().length==1?n.replace(i,"-0"+(t-1)):n.replace(i,"-"+(t-1));createChart(r,n)}function selectPlan(){const n={opType:215,opData:JSON.stringify({menu:!0})};ajaxPost("/Relay/Post",n,function(n){var t,f,i;if(n.errno!=0){layer.msg(n.errmsg);return}var r=n.datas,u="";for(t=0,f=r.length;t<f;t++)i=r[t],u+="<option value='{0}'>{1}<\/option>".format(i.Id,i.ProductionProcessName);$("#selectJhList").empty().append(u)})}function getProcessDetail(){var i=$("#selectDevice1").val(),r,s,e,h,n,t,o,u,f;if(isStrEmptyOrUndefined(i)){layer.msg("请选择车间设备");return}for(s=i.length,e=[],r=0;r<s;r++)h=i[r],e.push($("#selectDevice1").find("option[value="+h+"]").text());if(n=$("#selectDayDate").val(),t=$("#selectDay2Date").val(),compareDate(n,t)){layer.msg("结束时间不能小于开始时间");return}if(exceedTime(n)||exceedTime(t)){layer.msg("所选时间不能大于当前时间");return}o={DeviceId:i.join(","),StartTime:n,EndTime:t};u=0;$(".planHead").is(":checked")&&(u=$("#selectJhList").val(),o.ProductionId=u);f={};f.opType=506;f.opData=JSON.stringify(o);ajaxPost("/Relay/Post",f,function(i){var h,r,c,f,a,o,s;if(i.errno!=0){layer.msg(i.errmsg);return}h=`<div class="panel panel-primary">
                    <div class="panel-heading flexStyle" style="justify-content:space-between;flex-wrap:wrap">
                    <div>
                        <h3 class="panel-title badge" id="code{0}" style="color:green"></h3>
                        <h3 class="panel-title badge" id="time1_{0}"></h3>
                        <h3 class="panel-title badge" id="time2_{0}"></h3>
                    </div>
                    <div>
                        <h3 class="panel-title badge" id="num1_{0}"></h3>
                        <h3 class="panel-title badge" id="num2_{0}"></h3>
                        <h3 class="panel-title badge pointer" onclick="rateList({0},{1},'{2}','{3}', '{4}')">刷新</h3>
                    </div>
                </div>
                <div class="table-responsive mailbox-messages" style="padding:10px">
                    <table class="table table-hover table-striped" id="processList{0}"></table>
                </div>`;c=i.datas.length;$("#processDetailData").empty();var v=function(n){return n.OpName=="加工"?'<button type="button" class="btn btn-info btn-xs" onclick="showProcessDetailModel(\'{0}\')">详情<\/button>'.format(escape(n.ProcessData)):""},y=function(n,t,i,r){return++r.row},p=function(n){return n.ProcessType==0?`<span class="text-red">${n.OpName}</span>`:n.OpName},w=function(n){return n.EndTime=="0001-01-01 00:00:00"?`${n.OpName}中`:n.EndTime},b=function(n){return codeTime(n.TotalTime)},k=function(n){return n.ActualThickness=="0"?"":n.ActualThickness},d=function(n){return n.RequirementMid=="0"?"":n.RequirementMid},l=[];for(r=0;r<c;r++)f=i.datas[r],f.Logs.length>0&&(a=$(h.format(r,f.DeviceId,escape(n),escape(t),escape(u))).clone(),$("#processDetailData").append(a),o=f.Logs[0].Code,l.push(o),$("#code"+r).prepend(o),$(`#num1_${r}`).text(`总加工次数：${f.Count}次`),$(`#num2_${r}`).text(`日均加工次数：${f.CountAvg}次`),$(`#time1_${r}`).text("总加工时间："+codeTime(f.Time)),$(`#time2_${r}`).text("单次加工时间："+codeTime(f.TimeAvg)),$("#processList"+r).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,searching:!1,language:oLanguage,data:f.Logs,aLengthMenu:[5,10,15],iDisplayLength:5,columns:[{data:null,title:"序号",render:y},{data:null,title:"操作",render:p},{data:"StartTime",title:"开始时间"},{data:null,title:"结束时间",render:w},{data:null,title:"加工时间",render:b},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardName",title:"流程卡号"},{data:null,title:"工艺",render:v},{data:null,title:"片厚",render:k},{data:null,title:"要求",render:d},{data:"ProcessorName",title:"加工人"}]}));s=e.filter(function(n){return l.indexOf(n)===-1});$("#noProcessDetailData").empty();s.length>0?($("#noProcessDetailData").removeClass("hidden"),$("#noProcessDetailData").append('<label class="control-label">无加工记录设备:<\/label>'),$.each(s,function(n,t){$("#noProcessDetailData").append('<span style="margin-left:5px;color:red;font-weight:bold">'+t+"<\/span>")})):$("#noProcessDetailData").addClass("hidden")})}function rateList(n,t,i,r,u){var f={},e={DeviceId:t,StartTime:i,EndTime:r};u!=0&&(e.ProductionId=u);f.opType=506;f.opData=JSON.stringify(e);ajaxPost("/Relay/Post",f,function(t){var o,i,e,h;if(t.errno!=0){layer.msg(t.errmsg);return}o=t.datas[0].Count+"次";i=t.datas[0].Logs;$("#num"+n).text("每日加工次数："+o);var c=function(n,t,i,r){return++r.row},l=function(n){return n=="闲置"?`<span class="text-red">${n}</span>`:n},a=function(n){return n.EndTime=="0001-01-01 00:00:00"?"加工中":n.EndTime},v=function(n){return codeTime(n.TotalTime)},y=function(n){return n.OpName=="加工"?'<button type="button" class="btn btn-info btn-xs" onclick="showProcessDetailModel(\'{0}\')">详情<\/button>'.format(escape(n.ProcessData)):""},p=function(n){return n.ActualThickness=="0"?"":n.ActualThickness},w=function(n){return n.RequirementMid=="0"?"":n.RequirementMid};$("#processList"+n).empty();$("#processList"+n).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,searching:!1,language:oLanguage,data:i,aLengthMenu:[5,10,15],iDisplayLength:5,columns:[{data:null,title:"序号",render:c},{data:"OpName",title:"操作",render:l},{data:"StartTime",title:"开始时间"},{data:null,title:"结束时间",render:a},{data:null,title:"加工时间",render:v},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardName",title:"流程卡号"},{data:null,title:"工艺",render:y},{data:null,title:"片厚",render:p},{data:null,title:"要求",render:w},{data:"ProcessorName",title:"加工人"}]});for(var r=0,f=i.length,s=[],u=0;u<f;u++)e=i[u],e.OpName=="加工"&&(h=e.TotalTime,r+=h,s.push(e.FlowCardName));f=distinct(s).length;f&&(r=Math.round(r/f));$("#meanTime"+n).text("平均加工时间："+codeTime(r))})}function showProcessDetailModel(n){var t,o,s,e,h;n=unescape(n);n=JSON.parse(n);for(var i=[],u=0,f=0,c=Object.keys(n).length,r=0;r<c;r++)t=Object.keys(n)[r],u+=n[t][0]*60+n[t][1],f+=n[t][2]*60+n[t][3],i.push({forcing:n[t][0]+" : "+n[t][1],process:n[t][2]+" : "+n[t][3],stress:n[t][4],rotate:n[t][5]});o=Math.floor(u/60)+" : "+u%60;s=Math.floor(f/60)+" : "+f%60;i.push({forcing:o,process:s,stress:"",rotate:""});e=0;h=function(){return e==i.length-1?"总计":++e};$("#processList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!1,deferRender:!1,bLengthChange:!1,info:!1,searching:!1,bSort:!1,language:oLanguage,data:i,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"NO",render:h},{data:"forcing",title:"加压时间(分:秒)"},{data:"process",title:"工序时间(分:秒)"},{data:"stress",title:"设定压力(Kg)"},{data:"rotate",title:"下盘速度(rpm)"}]});$("#processModel").modal("show")}function getProductionChart(){var u=$("#productionDevice").val(),n,t,i,r;if(isStrEmptyOrUndefined(u)){layer.msg("请选择设备");return}if(n=$("#productionSTime").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择开始时间");return}if(t=$("#productionETime").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择结束时间");return}if(compareDate(n,t)){layer.msg("结束时间不能小于开始时间");return}if(n+=" 00:00:00",t+=" 23:59:59",i=$("#production_par input"),!i.is(":checked")){layer.msg("请选择参数");return}r={};r.opType=508;r.opData=JSON.stringify({DeviceId:u,StartTime:n,EndTime:t});ajaxPost("/Relay/Post",r,function(n){var e,t,f,r,u,o,l,s,a;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#production_chart").removeClass("hidden"),e=n.datas,u={Time:[],FaChu:[],HeGe:[],LiePian:[],Rate:[],ProcessTime:[]},t=0,f=e.length;t<f;t++)r=e[t],u.Time.push(r.Time.replace(" ","\n")),u.FaChu.push(r.FaChu),u.HeGe.push(r.HeGe),u.LiePian.push(r.LiePian),u.Rate.push(r.Rate),u.ProcessTime.push(r.ProcessTime);var h=[],c=[],v=$("#production_par span");for(t=0,f=i.length;t<f;t++)o=i.eq(t),o.is(":checked")&&(l=o.val(),s=v.eq(t).text(),c.push(s),h.push({name:s,type:"line",data:u[l]}));a={tooltip:{trigger:"axis",formatter:n=>{var u="",i;for(t=0,f=n.length;t<f;t++)r=n[t],i=r.seriesName,u+=`${r.marker}${i}：${i=="合格率"?r.value*100+"%":r.value}<br>`;return`${n[0].name}<br>${u}`}},legend:{data:c},grid:{left:"3%",right:"3%",top:"10%",bottom:"8%",containLabel:!0},xAxis:{type:"category",data:u.Time},yAxis:{type:"value"},series:h,dataZoom:[{type:"inside"},{handleIcon:_handleIcon,handleSize:"80%",handleStyle:{color:"#fff",shadowBlur:3,shadowColor:"rgba(0, 0, 0, 0.6)",shadowOffsetX:2,shadowOffsetY:2}}],toolbox:{left:"center",top:"3%",feature:{dataZoom:{yAxisIndex:"none"},restore:{}}}};echarts.init($("#production_chart")[0]).setOption(a,!0)})}var _permissionList=[],leadTimeMinute=6e4,leadTimeHour=36e5,leadTimeDay=864e5,leadTimeMonth=2592e6,_deviceType=null,dataTime;