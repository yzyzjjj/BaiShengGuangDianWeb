function pageReady(){_permissionList[700]={uIds:[]};_permissionList[701]={uIds:["getProcessDetailBtn"]};_permissionList=checkPermissionUi(_permissionList);_permissionList[700].have||$(".createChart").addClass("hidden");$(".ms2").select2();$("#selectDevice").select2({allowClear:!0,placeholder:"请选择"});$("#selectDevice1").select2({allowClear:!0,placeholder:"请选择"});$(".icb_minimal").iCheck({checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"});$("#selectDevice").on("select2:select",function(){var n=$("#selectDevice").val();n.indexOf("0,所有设备")>-1&&$("#selectDevice").val("0,所有设备").trigger("change")});getDeviceList(1);getDeviceList(2);getWorkShopList();$("#selectStartDate").val(getDate()).datepicker("update");$("#selectEndDate").val(getDate()).datepicker("update");$("#selectDayDate").val(getDate()).datepicker("update");$("#selectDay2Date").val(getDate()).datepicker("update");$("#selectWorkShop").on("select2:select",function(){$("#recordChart").empty();getWorkShopDeviceList()});var n=!0;$("#selectWorkShop1").on("select2:select",function(){$("#processDetailList").empty();getWorkShopDevList();$("#checkAll").iCheck("uncheck")});$("#checkAll").on("ifChanged",function(){var t,u=$("#selectDevice1").find("option").length,i,r;if($(this).is(":checked")){for(i=[],t=0;t<u;t++)r=$("#selectDevice1").find("option").eq(t).val(),i.push(r);$("#selectDevice1").val(i).trigger("change");n=!0;$(".select2-selection__clear").css("marginTop","9px")}else n&&$("#selectDevice1").val([]).trigger("change")});$("#selectDevice1").on("select2:unselect",function(){n=!1;$("#checkAll").iCheck("uncheck")});$("#selectDevice1").on("select2:select",function(){$(".select2-selection__clear").css("marginTop","9px");var n=$("#selectDevice1").find("option").length,t=$("#selectDevice1").val().length;n==t&&$("#checkAll").iCheck("check")});$("#selectDevice1").next(".select2-container").css("maxHeight","37px").css("overflowY","auto");$("#par input,#par span").css("verticalAlign","middle");$("#parTime input,#parTime span").css("verticalAlign","middle");radioTime();$("#selectStartDate,#selectStartTime,#selectEndDate,#selectEndTime").on("change",function(){radioTime()});$("#selectJhList").select2();selectPlan();$(".planHead").on("ifChanged",function(){$(this).is(":checked")?$(".planBody").removeClass("hidden"):($(".planBody").addClass("hidden"),$("#selectJhList").val($("#selectJhList").find("option:first").val()).trigger("change"))})}function radioTime(){var t=$("#selectStartDate").val()+" "+$("#selectStartTime").val(),n,i;t.slice(t.indexOf(" ")+1,t.indexOf(":")).length==1&&(t=$("#selectStartDate").val()+" 0"+$("#selectStartTime").val());n=$("#selectEndDate").val()+" "+$("#selectEndTime").val();n.slice(n.indexOf(" ")+1,n.indexOf(":")).length==1&&(n=$("#selectEndDate").val()+" 0"+$("#selectEndTime").val());exceedTime(t)||exceedTime(n)||compareDate(t,n)?$("#parTime label").removeClass("hidden"):($("#parTime label").removeClass("hidden"),i=new Date(n)-new Date(t),i>leadTimeDay?($("#parTime label").eq(0).addClass("hidden"),$("#parTime label").eq(0).iCheck("uncheck"),i>leadTimeMonth&&($("#parTime label").eq(1).addClass("hidden"),$("#parTime label").eq(1).iCheck("uncheck"))):($("#parTime label").eq(3).addClass("hidden"),$("#parTime label").eq(3).iCheck("uncheck"),i<=leadTimeHour&&($("#parTime label").eq(2).addClass("hidden"),$("#parTime label").eq(2).iCheck("uncheck"),i<=leadTimeMinute&&($("#parTime label").eq(1).addClass("hidden"),$("#parTime label").eq(1).iCheck("uncheck")))))}function getDeviceList(n){var t={};t.opType=100;ajaxPost("/Relay/Post",t,function(t){var u,f,i,r,e;if(t.errno!=0){layer.msg(t.errmsg);return}if(u=t.datas,u.sort((n,t)=>n.Code-t.Code),e=u.length,n==1)for($("#selectDevice").empty(),f='<option value="{0},{1}">{1}<\/option>',$("#selectDevice").append(f.format(0,"所有设备")),i=0;i<e;i++)r=u[i],$("#selectDevice").append(f.format(r.Id,r.Code));else for($("#selectDevice1").empty(),f='<option value="{0}">{1}<\/option>',i=0;i<e;i++)r=u[i],$("#selectDevice1").append(f.format(r.Id,r.Code))})}function getWorkShopList(){var n={};n.opType=162;ajaxPost("/Relay/Post",n,function(n){var i,t,r;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#selectWorkShop,#selectWorkShop1").empty(),i='<option value = "{0}">{1}<\/option>',$("#selectWorkShop,#selectWorkShop1").append(i.format("","所有车间")),t=0;t<n.datas.length;t++)r=n.datas[t],$("#selectWorkShop,#selectWorkShop1").append(i.format(r.SiteName,r.SiteName))})}function getWorkShopDeviceList(){var t=$("#selectWorkShop").val(),n;if(isStrEmptyOrUndefined(t)){$("#selectDevice").empty();getDeviceList(1);return}n={};n.opType=163;n.opData=JSON.stringify({workshopName:t});ajaxPost("/Relay/Post",n,function(n){var i,t,r;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#selectDevice").empty(),i='<option value = "{0},{1}">{1}<\/option>',n.datas.length>1&&$("#selectDevice").append(i.format(0,"所有设备")),t=0;t<n.datas.length;t++)r=n.datas[t],$("#selectDevice").append(i.format(r.Id,r.Code))})}function getWorkShopDevList(){var t=$("#selectWorkShop1").val(),n;if(isStrEmptyOrUndefined(t)){$("#selectDevice1").empty();getDeviceList(2);return}n={};n.opType=163;n.opData=JSON.stringify({workshopName:t});ajaxPost("/Relay/Post",n,function(n){var r,t,i;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#selectDevice1").empty(),r='<option value = "{0}">{1}<\/option>',t=0;t<n.datas.length;t++)i=n.datas[t],$("#selectDevice1").append(r.format(i.Id,i.Code))})}function createChart(n,t){var c=$("#selectDevice").val(),u,f,r,e,s;if(isStrEmptyOrUndefined(c)){layer.msg("请选择设备");return}if(!$("#par label").find(".icb_minimal").is(":checked")){layer.msg("请选择参数");return}var l=$("#selectWorkShop").val(),a=c.join(),h=a.split(","),i=[],o=[];for(u=0;u<h.length;u++)u%2==0?i.push(h[u]):o.push(h[u]);if(isStrEmptyOrUndefined(n)?f=$("#selectStartDate").val()+" "+$("#selectStartTime").val():(f=n,$("#selectStartDate").val(n.split(" ")[0]).datepicker("update"),$("#selectStartTime").val(n.split(" ")[1]).timepicker("setTime",n.split(" ")[1])),isStrEmptyOrUndefined(t)?r=$("#selectEndDate").val()+" "+$("#selectEndTime").val():(r=t,$("#selectEndDate").val(r.split(" ")[0]).datepicker("update"),$("#selectEndTime").val(r.split(" ")[1]).timepicker("setTime",r.split(" ")[1])),exceedTime(f)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(f,r)){layer.msg("结束时间不能小于开始时间");return}dataTime=0;e=new Date(r)-new Date(f);leadTimeMonth>e&&e>=leadTimeDay&&(dataTime=1);e>=leadTimeMonth&&(dataTime=2);e>=leadTimeHour&&e<leadTimeDay&&(dataTime=3);$("#parTime .icb_minimal").is(":checked")&&(dataTime=$("#parTime").find("input:checked").val());s={};s.opType=502;s.opData=JSON.stringify({WorkshopName:l,DeviceId:i.join(","),StartTime:f,EndTime:r,DataType:dataTime,Compare:i.length==1?0:1});ajaxPost("/Relay/Post",s,function(n){var v,t,k,y,p,nt,tt,it;if(n.errno!=0){layer.msg(n.errmsg);return}$("#recordChart").empty();for(var w=$("#par label").find(".icb_minimal").length,h=-1,rt=function(n){for(var r,i="",t=0,u=n.length;t<u;t++)r=n[t].name,i+="{0}: {1}<br/>".format(n[t].seriesName,n[t].seriesName=="使用率"?n[t].value+"%":n[t].value);return r+"<br/>"+i},c=[],u=0;u<w;u++){var d=$("#par label").find(".icb_minimal")[u],g=$("#par label")[u],f=[],e,r=[],s,l,b,a;if($(d).is(":checked")){h++;f[$(g).text()]=$(d).val();e=$(g).text();v=e=="同时加工台数"||e=="总台数"||e=="使用率"?!0:!1;for(t in f)f.hasOwnProperty(t)&&(r[t]=[]);for(objectSort(n.datas,"DeviceId"),objectSort(n.datas,"Time"),s=0;s<n.datas.length;s++){h==0&&(k=n.datas[s].Time,dataTime==2?c.push(k.split(" ")[0]):c.push(k.replace(" ","\n")));y=n.datas[s];for(t in f)if(f.hasOwnProperty(t))if(v)r[t].push(y[f[t]]);else for(l=r[t].length%i.length;l<i.length;l++)if(i[l]==y.DeviceId)if(r[t].push(y[f[t]]),s==n.datas.length-1&&r[t].length%i.length!=0){for(b=0;b<r[t].length%i.length;b++)r[t].push("x");break}else break;else r[t].push("x"),t==e&&l==i.length-1&&s--}h==0&&(c=distinct(c));p=[];for(t in f)if(f.hasOwnProperty(t))if(v)p.push({name:e,type:"line",data:r[t],showSymbol:!1,sampling:"average",showAllSymbol:!1});else for(a=0;a<o.length;a++)p.push({name:o[a],type:"line",data:r[t].filter(function(n,t){return t%o.length==a}),showSymbol:!1,sampling:"average",showAllSymbol:!1});nt='<div id="chart'+h+'" style="width: 100%; height: 500px"><\/div>';$("#recordChart").append(nt);tt=echarts.init(document.getElementById("chart"+h));it={title:{text:e},tooltip:{trigger:"axis",formatter:rt},grid:{bottom:70},xAxis:{type:"category",data:c,axisLine:{onZero:!1}},yAxis:{type:"value"},legend:{data:v?[e]:o},series:p,dataZoom:[{type:"slider",start:0,end:100},{type:"inside",start:0,end:100}],toolbox:{top:20,left:"center",feature:{dataZoom:{yAxisIndex:"none"},restore:{},magicType:{type:["line","bar"]}}}};tt.setOption(it,!0)}}$("#recordChart").resize(function(){for(w=$("#recordChart").children().length,u=0;u<w;u++)echarts.init(document.getElementById("chart"+u)).resize()})})}function hourChart(){var t=getFullTime(),n=(new Date).format(" hh"),i=(new Date).format("dd "),r;r=(n-1).toString().length==1?t.replace(n," 0"+(n-1)):t.replace(n," "+(n-1));n==" 00"&&(r=t.replace(n," 23").replace(i,i-1+" "),(i-1).toString().length!=1&&(r=t.replace(n," 23").replace(i,"0"+(i-1)+" ")));createChart(r,t)}function dayChart(){var n=getFullTime(),t=getDayAgo(1)+" "+getTime();createChart(t,n)}function monthChart(){var n=getFullTime(),i=(new Date).format("-MM"),t=(new Date).format("MM"),r;r=(t-1).toString().length==1?n.replace(i,"-0"+(t-1)):n.replace(i,"-"+(t-1));createChart(r,n)}function selectPlan(){var n={};n.opType=215;ajaxPost("/Relay/Post",n,function(n){var u,t,i,r;if(n.errno!=0){layer.msg(n.errmsg);return}for($("#selectJhList").empty(),u="<option value='{0}'>{1}<\/option>",t=[],i=0;i<n.datas.length;i++)r=n.datas[i],t.push(u.format(r.Id,r.ProductionProcessName));t=t.join("");$("#selectJhList").append(t)})}function getProcessDetail(){var i=$("#selectDevice1").val(),r,s,e,h,n,t,o,u,f;if(isStrEmptyOrUndefined(i)){layer.msg("请选择车间设备");return}for(s=i.length,e=[],r=0;r<s;r++)h=i[r],e.push($("#selectDevice1").find("option[value="+h+"]").text());if(n=$("#selectDayDate").val(),t=$("#selectDay2Date").val(),compareDate(n,t)){layer.msg("结束时间不能小于开始时间");return}if(exceedTime(n)||exceedTime(t)){layer.msg("所选时间不能大于当前时间");return}o={DeviceId:i.join(","),StartTime:n,EndTime:t};u=0;$(".planHead").is(":checked")&&(u=$("#selectJhList").val(),o.ProductionId=u);f={};f.opType=506;f.opData=JSON.stringify(o);ajaxPost("/Relay/Post",f,function(i){var f,k,v,a,g,y;if(i.errno!=0){layer.msg(i.errmsg);return}var p='<div class="row" id="row{0}"><\/div>',r,nt=i.datas.length;$("#processDetailData").empty();var tt=function(n){return n.OpName=="加工"?'<button type="button" class="btn btn-info btn-xs" onclick="showProcessDetailModel(\'{0}\')">详情<\/button>'.format(escape(n.ProcessData)):""},w,it=function(){return++w},rt=function(n){return n.EndTime=="0001-01-01 00:00:00"?"加工中":n.EndTime},ut=function(n){return codeTime(n.TotalTime)},ft=function(n){return n.ActualThickness=="0"?"":n.ActualThickness},et=function(n){return n.RequirementMid=="0"?"":n.RequirementMid},o=0,b=[],s=$(p.format(o)).clone();for($("#processDetailData").append(s),r=0;r<nt;r++)if(f=i.datas[r],f.ProcessLog.length!=0){$(s).children().length==2&&(o++,s=$(p.format(o)).clone(),$("#processDetailData").append(s));k=$('<div class="col-md-6"><div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title badge" id="code{0}" style="color:green"><\/h3><h3 class="panel-title badge" id="meanTime{0}"><\/h3><h3 class="panel-title pull-right badge" style="cursor:pointer" onclick="rateList({0},{1},\'{2}\',\'{3}\', \'{4}\')">刷新<\/h3><h3 class="panel-title pull-right badge" id="num{0}"><\/h3><\/div><div class="table-responsive mailbox-messages" style="padding:10px"><table class="table table-hover table-striped" id="processList{0}"><\/table><\/div><\/div><\/div>'.format(r,f.DeviceId,escape(n),escape(t),escape(u))).clone();$("#row"+o).append(k);v=f.ProcessLog[0].Code;b.push(v);$("#code"+r).prepend(v);$("#num"+r).text("每日加工次数："+f.ProcessCount+"次");w=0;$("#processList"+r).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,searching:!1,language:oLanguage,data:f.ProcessLog,aLengthMenu:[5,10,15],iDisplayLength:5,columns:[{data:null,title:"序号",render:it},{data:"OpName",title:"操作"},{data:"StartTime",title:"开始时间"},{data:null,title:"结束时间",render:rt},{data:null,title:"加工时间",render:ut},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardName",title:"流程卡号"},{data:null,title:"片厚",render:ft},{data:null,title:"要求",render:et},{data:"ProcessorName",title:"加工人"},{data:null,title:"工艺",render:tt}]});for(var h=0,l=f.ProcessLog.length,d=[],c=0;c<l;c++)a=f.ProcessLog[c],a.OpName=="加工"&&(g=a.TotalTime,h+=g,d.push(a.FlowCardName));l=distinct(d).length;l&&(h=Math.round(h/l));$("#meanTime"+r).text("平均加工时间："+codeTime(h))}y=e.filter(function(n){return b.indexOf(n)===-1});$("#noProcessDetailData").empty();y.length>0?($("#noProcessDetailData").removeClass("hidden"),$("#noProcessDetailData").append('<label class="control-label">无加工详情设备:<\/label>'),$.each(y,function(n,t){$("#noProcessDetailData").append('<span style="margin-left:5px;color:red;font-weight:bold">'+t+"<\/span>")})):$("#noProcessDetailData").addClass("hidden")})}function rateList(n,t,i,r,u){var f={},e={DeviceId:t,StartTime:i,EndTime:r};u!=0&&(e.ProductionId=u);f.opType=506;f.opData=JSON.stringify(e);ajaxPost("/Relay/Post",f,function(t){var o,i,e,h;if(t.errno!=0){layer.msg(t.errmsg);return}o=t.datas[0].ProcessCount+"次";i=t.datas[0].ProcessLog;$("#num"+n).text("每日加工次数："+o);var c=0,l=function(){return++c},a=function(n){return n.EndTime=="0001-01-01 00:00:00"?"加工中":n.EndTime},v=function(n){return codeTime(n.TotalTime)},y=function(n){return n.OpName=="加工"?'<button type="button" class="btn btn-info btn-xs" onclick="showProcessDetailModel(\'{0}\')">详情<\/button>'.format(escape(n.ProcessData)):""},p=function(n){return n.ActualThickness=="0"?"":n.ActualThickness},w=function(n){return n.RequirementMid=="0"?"":n.RequirementMid};$("#processList"+n).empty();$("#processList"+n).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,deferRender:!1,bLengthChange:!1,searching:!1,language:oLanguage,data:i,aLengthMenu:[5,10,15],iDisplayLength:5,columns:[{data:null,title:"序号",render:l},{data:"OpName",title:"操作"},{data:"StartTime",title:"开始时间"},{data:null,title:"结束时间",render:a},{data:null,title:"加工时间",render:v},{data:"ProductionProcessName",title:"计划号"},{data:"FlowCardName",title:"流程卡号"},{data:null,title:"片厚",render:p},{data:null,title:"要求",render:w},{data:"ProcessorName",title:"加工人"},{data:null,title:"工艺",render:y}]});for(var r=0,f=i.length,s=[],u=0;u<f;u++)e=i[u],e.OpName=="加工"&&(h=e.TotalTime,r+=h,s.push(e.FlowCardName));f=distinct(s).length;f&&(r=Math.round(r/f));$("#meanTime"+n).text("平均加工时间："+codeTime(r))})}function showProcessDetailModel(n){var t,o,s,e,h;n=unescape(n);n=JSON.parse(n);for(var i=[],u=0,f=0,c=Object.keys(n).length,r=0;r<c;r++)t=Object.keys(n)[r],u+=n[t][0]*60+n[t][1],f+=n[t][2]*60+n[t][3],i.push({forcing:n[t][0]+" : "+n[t][1],process:n[t][2]+" : "+n[t][3],stress:n[t][4],rotate:n[t][5]});o=Math.floor(u/60)+" : "+u%60;s=Math.floor(f/60)+" : "+f%60;i.push({forcing:o,process:s,stress:"",rotate:""});e=0;h=function(){return e==i.length-1?"总计":++e};$("#processList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!1,deferRender:!1,bLengthChange:!1,info:!1,searching:!1,bSort:!1,language:oLanguage,data:i,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"NO",render:h},{data:"forcing",title:"加压时间(分:秒)"},{data:"process",title:"工序时间(分:秒)"},{data:"stress",title:"设定压力(Kg)"},{data:"rotate",title:"下盘速度(rpm)"}]});$("#processModel").modal("show")}var _permissionList=[],leadTimeMinute=6e4,leadTimeHour=36e5,leadTimeDay=864e5,leadTimeMonth=2592e6,dataTime;