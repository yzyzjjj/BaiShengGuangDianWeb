function pageReady(){$(".ms2").select2();$("#run").addClass("disabled");getDeviceList();$("#flowCard").change(function(){$("#run").addClass("disabled")});$("#processCode").on("select2:select",function(){$("#run").addClass("disabled")});$("#addCraftOp").change(function(){var n=$("#addCraftOp").val();n=="片厚"?$("#addCraftThickness").parent().removeAttr("hidden"):$("#addCraftThickness").parent().attr("hidden","hidden")});$("#faultType").on("select2:select",function(){for(var t="",n=0;n<faultData.length;n++)if(faultData[n].Id==$("#faultType").val()){t=faultData[n].FaultDescription;break}$("#faultDefaultDesc").val(t);$("#faultDefaultDesc").attr("disabled","disabled")});$("#faultCode").select2({allowClear:!0,placeholder:"请选择"});$("#isChange").on("ifChanged",function(){var t=$(this),n=$("#difference").val();(n||n=="")&&(n=$("#difference").val().trim());isStrEmptyOrUndefined(n)&&$("#isDifference").iCheck("uncheck");t.is(":checked")?$("#refresh").removeClass("hidden"):$("#refresh").addClass("hidden");showProcessData(t.is(":checked"))});$("#refresh").on("click",function(){$("#pData").find("input").val(0)});$("#flowCardEmpty").click(function(){$("#flowCard").val("")});$("#file").change(function(){addCover();loads==0?($("#flowCard").val(""),$("#fcBody").addClass("hidden"),$("#isChangeDiv").addClass("hidden"),$("#processSteps").empty(),$("#info").empty(),$("#pData").empty(),$("#run").addClass("disabled")):($("#rpFlowCard").val(""),$("#gxList").empty(),$("#tableFlowCard").addClass("hidden"));fileImg=setInterval("fileUp()",1e3)});$(document).on("visibilitychange",function(){var n=this.visibilityState;n!="hidden"||$("#video").is(":hidden")&&$("#video1").is(":hidden")||(clearCanvas(),closeVideo.stop(),clearInterval(canImg),videos=0,$("#video").addClass("hidden"),$("#video1").addClass("hidden"))});pcAndroid()?($("#upload").addClass("hidden"),$("#upload1").addClass("hidden")):($("#scanning").addClass("hidden"),$("#scanning1").addClass("hidden"));$("#inputReportModel").on("hidden.bs.modal",function(){clearCanvas();videos%2!=0&&(closeVideo.stop(),clearInterval(canImg),$("#video1").addClass("hidden"),videos=0)});$("#opUl").on("click","a",function(){$(this).css("backgroundColor","#d3d3d3").parent().siblings().find("a").css("backgroundColor","");$("#addCraftDate").val(getDate()).datepicker("update");$("#addCraftTime").val(getTime()).timepicker("setTime",getTime());$(this).text()=="片厚"?$("#thick").removeClass("hidden"):$("#thick").addClass("hidden")})}function upload(n){loads=n;videos%2!=0&&closeVideo.stop();clearInterval(canImg);n==0?$("#video").addClass("hidden"):$("#video1").addClass("hidden");var t=setInterval($("#file").click(),1e3);clearInterval(t);videos=0}function scanning(n){if(videos++,videos%2==0){clearCanvas();closeVideo.stop();clearInterval(canImg);n==0?(scans=0,$("#video").addClass("hidden"),videos=0):(scans=1,$("#video1").addClass("hidden"),videos=0);return}navigator.mediaDevices.getUserMedia||navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia?getUserMedia({video:{width:290,height:290,facingMode:"environment"}},success,error):layer.msg("不支持访问用户媒体");n==0?(scans=0,$("#video").removeClass("hidden"),$("#flowCard").val(""),$("#fcBody").addClass("hidden"),$("#isChangeDiv").addClass("hidden"),$("#processSteps").empty(),$("#info").empty(),$("#pData").empty(),$("#run").addClass("disabled")):(scans=1,$("#video1").removeClass("hidden"),$("#rpFlowCard").val(""),$("#gxList").empty(),$("#tableFlowCard").addClass("hidden"));canImg=setInterval("capture()",500)}function getDeviceList(){var t=100,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;n.opData=JSON.stringify({hard:!0,work:!0});ajaxPost("/Relay/Post",n,function(n){var r,i,t,u;if(n.errno!=0){layer.msg(n.errmsg);return}var f=function(n){var t=n.DeviceStateStr;return t=="待加工"?'<span class="text-success">'+t+"<\/span>":t=="加工中"?'<span class="text-success">'+t+"<\/span>":t=="已确认"?'<span class="text-warning">'+t+"<\/span>":t=="维修中"?'<span class="text-info">'+t+"<\/span>":'<span class="text-red">'+t+"<\/span>"},e=function(n,t,i,r){return r.row+1},o=function(){$("#deviceList th").css("paddingRight","22px").css("paddingLeft",0)};for($("#deviceList").DataTable({pagingType:"full",destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:e},{data:"Id",title:"Id",bVisible:!1},{data:"Code",title:"机台号"},{data:"CategoryName",title:"类型"},{data:null,title:"设备状态",render:f},{data:"FlowCard",title:"流程卡号"},{data:"ProcessTime",title:"加工时间"},{data:"LeftTime",title:"剩余时间"}],columnDefs:[{type:"html-percent",targets:[2]}],drawCallback:o}),$(".ms2").empty(),r='<option value="{0}" id="{2}" index="{3}">{1}<\/option>',i=0;i<n.datas.length;i++)t=n.datas[i],u=t.DeviceStateStr,(u=="待加工"||u=="加工中")&&$("#processCode,#addCraftCode").append(r.format(t.Id,t.Code,"")),$("#faultCode").append(r.format(t.Code,t.Code,t.AdministratorUser,t.Id))})}function queryFlowCard(){var r,n,t,u,i;if(hideTip("processCodeTip"),r=260,!checkPermission(r)){layer.msg("没有权限");return}($("#fcBody").addClass("hidden"),$("#isChangeDiv").addClass("hidden"),$("#processSteps").empty(),$("#info").empty(),$("#pData").empty(),$("#run").addClass("disabled"),$("#isChange").iCheck("uncheck"),n=!0,t=$("#processCode").val(),isStrEmptyOrUndefined(t)&&(showTip("processCodeTip","请选择设备"),n=!1),u=$("#flowCard").val().trim(),isStrEmptyOrUndefined(u)&&(layer.msg("流程卡号不能为空"),n=!1),n)&&(i={},i.opType=r,i.opData=JSON.stringify({Id:t,FlowCardName:u}),ajaxPost("/Relay/Post",i,function(n){var h,e,s,r,c,o,u;if(n.errno!=0){layer.msg(n.errmsg);return}checkPermission(156)&&$("#isChangeDiv").removeClass("hidden");$("#fcBody").removeClass("hidden");checkPermission(323)&&(h='<div class="form-group border-left"><label for="isDifference" class="text-danger">是否微调：<\/label><input type="checkbox" id="isDifference" class="icb_minimal"><\/div><div class="form-group form-inline hidden" id="differenceDiv"><label class="control-label" for="difference">当前厚度(mm)：<\/label><div class="from-group no-margin" style="display:-webkit-inline-box"><input type="tel" class="form-control" id="difference" autocomplete="off" placeholder="请输入当前厚度" style="width:150px" onfocusin="focusIn($(this))" maxlength="9" onkeyup="onInput(this)" oninput="value=value.replace(/[^\\d\\.]/g,\'\')" onblur="onInputEnd(this); queryProcessData();" maxlength="6"><label class="label-danger hidden" id="differenceTip" style="display:table-cell;height:34px;vertical-align:middle"><\/label><\/div><\/div>',$("#info").append(h));$("#isDifference").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});$("#isDifference").on("ifChanged",function(){var n=$(this);n.is(":checked")?(hideTip("differenceTip"),$("#differenceDiv").removeClass("hidden")):$("#differenceDiv").addClass("hidden");showProcessData()});var i=n.flowCard,f="<p><b>计划号：<\/b>{0}<\/p><p><b>紧急程度：<\/b>{1}<\/p>";for(f=f.format(i.ProductionProcessName,i.Priority==0?"低":i.Priority==1?"中":"高"),e=0;e<i.RawMateriaSpecifications.length;e++)s=i.RawMateriaSpecifications[e],f+="<p><b>{0}：<\/b>{1}<\/p> ".format(s.SpecificationName,s.SpecificationValue);if(f+="<p><b>工艺编号：<\/b>{0}<\/p>".format(i.ProcessNumber),$("#info").append(f),id=t,processId=i.ProcessId,flowCardId=i.flowCardId,processData=i.processData.sort(function(n,t){return n.ProcessOrder>t.ProcessOrder?1:-1}),newProcessData=null,showProcessData(),r=i.processSteps.sort(function(n,t){return n.ProcessStepOrder>t.ProcessStepOrder?1:-1}),r.length>0){for(c="<tr><td>{0}<\/td><td>{1}<\/td><td>{2}<\/td><td>{5}<\/td><td>{3}<\/td><td>{4}<\/td><\/tr>",o=0;o<r.length;o++)u=r[o],$("#processSteps").append(c.format(u.ProcessStepOrderName,u.StepName,u.ProcessStepRequirements,u.QualifiedRange,u.QualifiedMode==0?"":u.QualifiedMode,u.ProcessStepRequirementMid));r.length==2&&(LastLand=r[0].QualifiedMode!=0?r[0].QualifiedMode:r[0].ProcessStepRequirementMid,TarLand=r[1].ProcessStepRequirementMid)}}))}function queryProcessData(){var i,n,r,t;if($("#isDifference").is(":checked")){if(i=323,!checkPermission(i)){layer.msg("没有权限");return}if(newProcessData=null,n=$("#difference").val().trim(),isStrEmptyOrUndefined(n)){showTip("differenceTip","当前厚度不能为空");return}if(n=parseFloat(n),n==0||n>20){showTip("differenceTip","当前厚度必须在0-20之间");return}if(LastLand==0){layer.msg("上道工序厚度缺失");return}if(TarLand==0){layer.msg("当前工序加工厚度缺失");return}if(n<TarLand){layer.msg("当前厚度必须大于加工要求");return}r={Id:processId,CurLand:n,LastLand:LastLand,TarLand:TarLand};$("#pData").empty();t={};t.opType=i;t.opData=JSON.stringify(r);ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}newProcessData=n.datas.sort(function(n,t){return n.ProcessOrder>t.ProcessOrder?1:-1});showProcessData()})}}function showProcessData(n=false){var f,r,t;n||(n=$("#isChange").is(":checked"));var i=$("#isDifference").is(":checked")?newProcessData:processData,u='<tr>    <td style="vertical-align: middle;"><span class="num">{0}<\/span><\/td>    <td class="form-inline">        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{1}" maxlength="9" />        <span style="width: 10%;">:<\/span>        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{2}" onblur="value=isStrEmptyOrUndefined(value)?\'\':(parseInt(value)>59?59:parseInt(value))" maxlength="9" />    <\/td>    <td class="form-inline">        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{3}" maxlength="9" />        <span style="width: 10%;">:<\/span>        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{4}" onblur="value=isStrEmptyOrUndefined(value)?\'\':(parseInt(value)>59?59:parseInt(value))" maxlength="9" />    <\/td>    <td><input type="tel" class="text-center" style="width: 80%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{5}" maxlength="9" /><\/td>    <td><input type="tel" class="text-center" style="width: 80%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{6}" maxlength="9" /><\/td>    <td><button type="button" class="minus btn btn-danger btn-xs"><i class="fa fa-minus"><\/i><\/button><button type="button" class="plus btn btn-success btn-xs"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>';if(i!=null&&i.length>0){for($("#pData").empty(),f=n?u:"<tr><td>{0}<\/td><td>{1}&nbsp;:&nbsp;{2}<\/td><td>{3}&nbsp;:&nbsp;{4}<\/td><td>{5}<\/td><td>{6}<\/td><\/tr>",$("#run").removeClass("disabled"),r=0;r<i.length;r++)t=i[r],$("#pData").append(f.format(t.ProcessOrder,t.PressurizeMinute,t.PressurizeSecond,t.ProcessMinute,t.ProcessSecond,t.Pressure,t.Speed));$("#tableP td").css("padding","2px");$("#tableP td").css("paddingTop","8px").css("paddingBottom","8px")}$("#pData").off("click").on("click",".plus",function(){var i=$(this).parents("tr"),n,t;for(i.after(u.format(0,0,0,0,0,0,0)),$("#tableP td").css("padding","2px"),$("#tableP td").css("paddingTop","8px").css("paddingBottom","8px"),t=$("#pData .num").length,n=0;n<t;n++)$($("#pData .num")[n]).text(n+1);t==8&&$(".plus").addClass("hidden")});$("#pData").on("click",".minus",function(){var i=$(this).parents("tr"),n,t;for(i.remove(),$(".plus").removeClass("hidden"),t=$("#pData .num").length,n=0;n<t;n++)$($("#pData .num")[n]).text(n+1)});$("#pData").off("focusin").on("focusin","input",function(){var n=$(this).val();n==0&&$(this).val("")});$("#pData").off("focusout").on("focusout","input",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")})}function minus(){var n=$(this).parents("tr");n.remove()}function setProcessData(){var r,i,u,n,o;if(!isStrEmptyOrUndefined(id)&&!isStrEmptyOrUndefined(flowCardId)&&!isStrEmptyOrUndefined(processId)){if(r={DeviceId:id,ProcessId:processId,FlowCardId:flowCardId},i=110,$("#isDifference").is(":checked")){if(u=$("#difference").val().trim(),isStrEmptyOrUndefined(u)){showTip("differenceTip","当前厚度不能为空");return}if(i=155,newProcessData==null||newProcessData.length==0){layer.msg("缺少工艺数据");return}r.ProcessDatas=newProcessData}if($("#isChange").is(":checked")){i=156;var f=[],t=$("#pData input"),e=6;if(t.length>0)for(n=0;n<t.length;n++)if(!isStrEmptyOrUndefined(t[n].value)&&isNumber(t[n].value))(n+1)%e==0&&f.push({ProcessOrder:parseInt(n/e)+1,PressurizeMinute:t[n-5].value,PressurizeSecond:t[n-4].value,ProcessMinute:t[n-3].value,ProcessSecond:t[n-2].value,Pressure:t[n-1].value,Speed:t[n].value});else{layer.msg("工艺数据错误");return}else{layer.msg("缺少工艺数据");return}r.ProcessDatas=f}if(!checkPermission(i)){layer.msg("没有权限");return}o=function(){var n={};n.opType=i;n.opData=JSON.stringify(r);ajaxPost("/Relay/Post",n,function(t){if(layer.msg(t.errmsg),t.errno==0&&(addCraftModal(),$("#isDifference").is(":checked"))){var i=$("#difference").val().trim();if(isStrEmptyOrUndefined(i))return;i=parseFloat(i);n={};n.opType=166;n.opData=JSON.stringify({DeviceId:id,Time:getFullTime(),OpName:"微调",Thickness:i});ajaxPost("/Relay/Post",n,function(){})}})};showConfirm("设置",o)}}function showFaultModel(){var t=406,i,n;if(!checkPermission(t)){layer.msg("没有权限");return}hideClassTip("adt");$("#faultCode").val("").trigger("change");$("#faultOther").val("");$("#faultDate").val(getDate()).datepicker("update");$("#faultTime").val(getTime()).timepicker("setTime",getTime());i=getCookieTokenInfo();$("#proposer").val(i.name);$("#faultDesc").val("");n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var u,t,i,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(faultData=n.datas,$("#faultType").empty(),u='<option value="{0}">{1}<\/option>',t=0,i=0;i<n.datas.length;i++)r=n.datas[i],t==0&&(t=r.Id),$("#faultType").append(u.format(r.Id,r.FaultTypeName));$("#faultType").val(t).trigger("select2:select");$("#faultModel").modal("show")})}function reportFault(){var a=422,s,h,c,e,t,r,u,l,o;if(!checkPermission(a)){layer.msg("没有权限");return}var f=!0,n=$("#faultCode").val(),i=$("#faultOther").val().trim().split(",");if(isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(i))!isStrEmptyOrUndefined(n)&&isStrEmptyOrUndefined(i)?codes=n:isStrEmptyOrUndefined(n)&&!isStrEmptyOrUndefined(i)?codes=i:(layer.msg("请选择或输入机台号"),f=!1);else for(codes=n.concat(i),t=0;t<n.length;t++)i==n[t]&&(showTip($("#faultOtherTip"),"该机台号已选择，请重新输入"),f=!1);s=$("#proposer").val().trim();isStrEmptyOrUndefined(s)&&(showTip($("#proposerTip"),"报修人不能为空"),f=!1);var v=$("#faultDate").val(),y=$("#faultTime").val(),p=$("#faultType").val(),w=$("#faultDesc").val().trim();if(f){if(h="{0} {1}".format(v,y),exceedTime(h)){layer.msg("所选时间不能大于当前时间");return}for($("#faultModel").modal("hide"),c=[],e=[],t=0;t<codes.length;t++)r=codes[t],u=$("#faultCode").find("option[value='"+r+"']").attr("index"),u=isStrEmptyOrUndefined(u)||isStrEmptyOrUndefined(n)?0:parseInt(u),c.push({DeviceCode:r,FaultTime:h,Proposer:s,FaultDescription:w,Priority:0,FaultTypeId:p,DeviceId:u}),l=$("#faultCode").find("option[value='"+r+"']").attr("id"),isStrEmptyOrUndefined(l)||e.push({Code:r,Admin:l});o={};o.opType=a;o.opData=JSON.stringify(c);ajaxPost("/Relay/Post",o,function(n){var t,i,r;if(layer.msg(n.errmsg),n.errno==0)for(getDeviceList(),t=0;t<e.length;t++)i=e[t],r={ChatEnum:chatEnum.FaultDevice,Message:{Admin:i.Admin,Code:i.Code}},hubConnection.invoke("SendMsg",r)})}}function getUsuallyFaultList(){var t=400,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}$("#usuallyFaultList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"序号"},{data:"UsuallyFaultDesc",title:"常见故障"},{data:"SolverPlan",title:"解决方法"}],columnDefs:[{targets:[2],render:function(n,t,i){return i.SolverPlan=i.SolverPlan?i.SolverPlan:"",i.SolverPlan.length>tdShowContentLength?i.SolverPlan.substr(0,tdShowContentLength)+' <a href = "javascript:showUsuallyFaultDetailModel({0})">. . .<\/a> '.format(i.Id):i.SolverPlan}}]});$("#usuallyFaultModel").modal("show")})}function showUsuallyFaultDetailModel(n){var i=401,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&$("#usuallyFaultDetail").html(n.datas[0].SolverPlan);$("#usuallyFaultDetailModel").modal("show")})}function showInputReport(){var n,t,i;clearCanvas();videos%2!=0&&(closeVideo.stop(),clearInterval(canImg),$("#video").addClass("hidden"),videos=0);n=getCookieTokenInfo();clearRpFlowCard();$("#rpFlowCardTip").addClass("hidden");$("#tableFlowCard").addClass("hidden");t=n.proleList.indexOf(0)==-1;i=n.proleList.indexOf(1)==-1;$("#reportFlowCard").addClass("hidden");t&&i||$("#reportFlowCard").removeClass("hidden");$("#inputReportModel").modal("show")}function queryRpFlowCard(){var t,i,n;if($("#gxList").empty(),$("#tableFlowCard").removeClass("hidden"),t=202,!checkPermission(t)){layer.msg("没有权限");return}if(i=$("#rpFlowCard").val().trim(),isStrEmptyOrUndefined(i)){showTip("rpFlowCardTip","流程卡号不能为空");$("#tableFlowCard").addClass("hidden");return}n={};n.opType=t;n.opData=JSON.stringify({FlowCard:i});ajaxPost("/Relay/Post",n,function(n){function s(n,t){return n.ProcessStepOrder>t.ProcessStepOrder}var f,o,r;if(n.errno!=0){layer.msg(n.errmsg);return}f=getCookieTokenInfo();f.proleList=[0,1];var h=f.proleList.indexOf(0)>-1,c=f.proleList.indexOf(1)>-1,u=-1,i=-1,e=n.processSteps.sort(s);for(e.length>0&&(rpFcId=e[0].FlowCardId),o=0;o<e.length;o++)(r=e[o],r.IsReport)||(r.IsSurvey||!h||r.ProcessTime=="0001-01-01 00:00:00"||r.ProcessTime==null?r.IsSurvey&&c&&(r.SurveyTime=="0001-01-01 00:00:00"||r.SurveyTime==null)&&i==-1&&(i=r.ProcessStepOrder):u=r.ProcessStepOrder);u!=-1&&i!=-1&&(u<i?i=-1:u=-1);var t=0,l=function(n){return n.CategoryName+"-"+n.StepName},a=function(n){return t++,'<span id="c1f{0}" oValue="{1}">{2}<\/span>'.format(n.ProcessStepOrder,n.Id,t)},v=function(n){return'<span id="c2f{0}" oValue="{2}">{1}<\/span>'.format(t,n.ProcessorName,n.ProcessorId)},y=function(n){return n.ProcessTime=="0001-01-01 00:00:00"||n.ProcessTime==null?'<span id="c3f{0}" oValue="{1}"><\/span>'.format(t,n.ProcessTime):'<span id="c3f{0}" oValue="{1}">{1}<\/span>'.format(t,n.ProcessTime)},p=function(r){var e,u,o;if(i==r.ProcessStepOrder){for(e=0,u=0;u<n.surveyors.length;u++)if(o=n.surveyors[u],o.SurveyorName==f.name){e=o.Id;break}return'<span id="c4f{0}" oValue="{2}">{1}<\/span>'.format(t,f.name,e)}return'<span id="c4f{0}" oValue="{2}">{1}<\/span>'.format(t,r.SurveyorName,r.SurveyorId)},w=function(n){return i!=n.ProcessStepOrder?n.SurveyTime=="0001-01-01 00:00:00"||n.SurveyTime==null?'<span id="c5f{0}" oValue="{1}"><\/span>'.format(t,n.SurveyTime):'<span id="c5f{0}" oValue="{1}">{1}<\/span>'.format(t,n.SurveyTime):'<input type="text" id="c51f{0}" class="form_date form-control" value="{2}" style="width:90px;background-color:white;"><input type="text" id="c52f{0}" class="form_time form-control" value="{3}" style="width:75px;background-color:white;"><span id="c5f{0}" oValue="{1}" class="hidden">{1}<\/span>'.format(t,n.SurveyTime,getDate(),getTime())},b=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c6f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c6f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber);return'<input class="form-control" id="c6f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber)},k=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c7f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c7f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber);return'<input class="form-control" id="c7f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber)},d=function(n){return'<span id="c8f{0}" oValue="{2}">{1}<\/span>'.format(t,n.Code,n.DeviceId)},g=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c9f{0}" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c9f{0}" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange);return'<input class="form-control" id="c9f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange)},nt=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c10f{0}" style="width:100%" value="{1}" oValue="{1}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10">'.format(t,n.QualifiedMode)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c10f{0}" style="width:100%" value="{1}" oValue="{1}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10">'.format(t,n.QualifiedMode);return'<input class="form-control" id="c10f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedMode)};$("#gxList").DataTable({destroy:!0,bSort:!1,paging:!1,deferRender:!1,bLengthChange:!1,info:!1,searching:!1,language:{url:"/content/datatables_language.json"},data:e,aaSorting:[[0,"asc"]],columns:[{data:null,title:"序号",render:a},{data:null,title:"工序名称",render:l},{data:"ProcessStepRequirements",title:"加工要求"},{data:null,title:"加工人",render:v},{data:null,title:"加工时间",render:y},{data:null,title:"机台号",render:d},{data:null,title:"检验人",render:p},{data:null,title:"检验时间",render:w},{data:null,title:"合格数",render:b},{data:null,title:"不合格数",render:k},{data:null,title:'成厚范围(<span class="text-info">例:0.2～0.3mm<\/span>)',render:g},{data:null,title:'成厚均值(<span class="text-info">例:0.25<\/span>)',render:nt},],drawCallback:function(){$("#gxList th").css("padding-right","8px");initTime()}})})}function initTime(){$("#gxList .form_date,.form_time").attr("readonly",!0);$("#gxList .form_date").datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});$("#gxList .form_time").timepicker({language:"zh-CN",showMeridian:!1,minuteStep:1,showSeconds:!0,secondStep:1})}function reportFlowCard(){var c=208,t,a,v,o,y,s,p,w,b,k,u,i,r,n,h,d,f,g;if(!checkPermission(c)){layer.msg("没有权限");return}var nt=parseInt(rpFcId),tt=$("#gxList tbody").children(),e=[],l=!1;for(t=1;t<=tt.length;t++){for(i=1;i<=10;i++){r=$("#c{1}f{0}".format(t,i));n=r.attr("ovalue");switch(i){case 1:a=n;break;case 2:v=n;break;case 3:o=isStrEmptyOrUndefined(n)?null:n;break;case 4:y=n;break;case 5:r.parent().find("input").length>0&&(h=$("#c{1}1f{0}".format(t,i)),d=$("#c{1}2f{0}".format(t,i)),n=h.hasClass("hidden")?n:"{0} {1}".format($(h).val(),$(d).val()));s=isStrEmptyOrUndefined(n)?null:n;break;case 6:n=r.val();p=n;break;case 7:n=r.val();w=n;break;case 8:b=n;break;case 9:n=r.val();k=n;break;case 10:if(n=r.val(),u=n,isStrEmptyOrUndefined($("#c10f{0}".format(t)).attr("disabled"))&&(l=!0,isStrEmptyOrUndefined(u)||parseFloat(u)<=0)){layer.msg("成厚均值必须大于0");return}}}f={Id:a,FlowCardId:nt,ProcessorId:v,SurveyorId:y,QualifiedNumber:p,UnqualifiedNumber:w,DeviceId:b,QualifiedRange:k,QualifiedMode:u};o!=null&&(f.ProcessTime=o);s!=null&&(f.SurveyTime=s);e.push(f)}e.length<=0||l&&(g=function(){var n={};n.opType=c;n.opData=JSON.stringify(e);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&queryRpFlowCard()})},showConfirm("保存",g))}function clearRpFlowCard(){$("#rpFlowCard").val("");$("#gxList").empty();$("#tableFlowCard").addClass("hidden")}function addCraftModal(){var n=$("#processCode").val();$("#addCraftCode").val(n).trigger("change");$("#addCraftDate").val(getDate()).datepicker("update");$("#addCraftTime").val(getTime()).timepicker("setTime",getTime());$("#addCraftThickness").val("");$("#op1").click();$("#addCraftModel").modal("show")}function addCraft(){var o=166,i,r,t,s,u,f,e,n,h;if(!checkPermission(o)){layer.msg("没有权限");return}if(i=$("#addCraftCode").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择设备");return}if(isStrEmptyOrUndefined($("#addCraftDate").val())){layer.msg("请选择完整的时间");return}if(r=$("#addCraftDate").val()+" "+$("#addCraftTime").val(),exceedTime(r)){layer.msg("操作时间不能大于当前时间");return}for(s=$("#opUl a").length,t=0;t<s;t++)f=$("#opUl a")[t],$(f).attr("aria-expanded")=="true"&&(u=$(f).text());if(e=0,u=="片厚"){if(n=$("#addCraftThickness").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请输入片厚");return}if(n==parseFloat(n))n=parseFloat(n);else{layer.msg("请输入正确的数值");return}if(n==0||n>20){layer.msg("片厚范围在0-20之间");return}e=n}h=function(){$("#addCraftModel").modal("hide");var n={};n.opType=o;n.opData=JSON.stringify({DeviceId:i,Time:r,OpName:u,Thickness:e});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg)})};showConfirm("添加",h)}function getUserMedia(n,t,i){navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(n).then(t).catch(i):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(n).then(t).catch(i):navigator.mozGetUserMedia?navigator.mozGetUserMedia(n).then(t).catch(i):navigator.getUserMedia&&navigator.getUserMedia(n).then(t).catch(i)}function capture(){var n=document.getElementById("canvas"),t=n.getContext("2d");scans==0?t.drawImage(video,0,0,290,290):t.drawImage(video1,0,0,290,290);qrcode.decode(n.toDataURL("image/png"));qrcode.callback=function(n){n!="error decoding QR Code"&&typeof Number(n.split(",")[2])=="number"&&(addCover(),scans==0?($("#video").addClass("hidden"),$("#flowCard").val(n.split(",")[2]),clearCanvas()):($("#video1").addClass("hidden"),$("#rpFlowCard").val(n.split(",")[2]),clearCanvas()),clearInterval(canImg),removeCover(),closeVideo.stop(),videos=0)}}function success(n){var t;t=scans==0?document.getElementById("video"):document.getElementById("video1");t.srcObject=n;t.play();closeVideo=n.getTracks()[0]}function error(){scans==0?$("#video").addClass("hidden"):$("#video1").addClass("hidden");layer.msg("访问用户媒体设备失败");clearInterval(canImg);videos=0}function clearCanvas(){var n=document.getElementById("canvas"),t=n.getContext("2d");t.clearRect(0,0,n.width,n.height)}function getObjectURL(n){var t=null;return window.createObjectURL!=undefined?t=window.createObjectURL(n):window.URL!=undefined?t=window.URL.createObjectURL(n):window.webkitURL!=undefined&&(t=window.webkitURL.createObjectURL(n)),t}function fileUp(){var n=document.getElementById("file");qrcode.decode(getObjectURL(n.files[0]));qrcode.callback=function(n){n!="error decoding QR Code"&&typeof Number(n.split(",")[2])=="number"?(loads==0?($("#video").addClass("hidden"),$("#flowCard").val(n.split(",")[2])):($("#video1").addClass("hidden"),$("#rpFlowCard").val(n.split(",")[2])),clearInterval(fileImg),$("#file").val(""),removeCover()):(clearInterval(fileImg),layer.msg("请上传正确的二维码图片"),$("#file").val(""),loads==0?$("#flowCard").val(""):$("#rpFlowCard").val(""),removeCover())}}var loads,scans,videos=0,x=0,faultData=null,oProcessData=null,processData=null,newProcessData=null,LastLand=0,TarLand=0,id=null,processId=null,flowCardId=null,codes=null,rpFcId,canImg,fileImg,closeVideo;