function pageReady(){$(".ms2").select2();$("#run").addClass("disabled");getDeviceList();$("#flowCard").change(function(){$("#run").addClass("disabled")});$("#processCode").on("select2:select",function(){$("#run").addClass("disabled")});$("#addCraftOp").change(function(){var n=$("#addCraftOp").val();n=="片厚"?$("#addCraftThickness").parent().removeAttr("hidden"):$("#addCraftThickness").parent().attr("hidden","hidden")});$("#faultType").on("select2:select",function(){for(var t="",n=0;n<faultData.length;n++)if(faultData[n].Id==$("#faultType").val()){t=faultData[n].FaultDescription;break}$("#faultDefaultDesc").val(t);$("#faultDefaultDesc").attr("disabled","disabled")});$("#faultCode").select2({allowClear:!0,placeholder:"请选择"});$("#isChange").on("ifChanged",function(){var t=$(this),n=$("#difference").val();(n||n=="")&&(n=$("#difference").val().trim());isStrEmptyOrUndefined(n)&&$("#isDifference").iCheck("uncheck");t.is(":checked")?$("#refresh").removeClass("hidden"):$("#refresh").addClass("hidden");showProcessData(t.is(":checked"))});$("#refresh").on("click",function(){$("#pData").find("input").val(0)});$("#flowCardEmpty").click(function(){$("#flowCard").val("")});$("#opUl").on("click","a",function(){$(this).css("backgroundColor","#d3d3d3").parent().siblings().find("a").css("backgroundColor","");$("#addCraftDate").val(getDate()).datepicker("update");$("#addCraftTime").val(getTime()).timepicker("setTime",getTime());$(this).text()=="片厚"?$("#thick").removeClass("hidden"):$("#thick").addClass("hidden")});pcAndroid()?$(".upload").addClass("hidden"):$(".scanning").addClass("hidden");$(".upload").on("click",function(){$("#file").trigger("click")});$("#file").on("change",function(){addCover();new Promise(function(n){printImgUp(n,this)}.bind(this)).then(n=>{if(removeCover(),$(this).val(""),n){var t=n.split(",")[2];$("#inputReportModel").is(":hidden")?$("#flowCard").val(t):$("#rpFlowCard").val(t)}})});$("#stateSelect").on("change",function(){getLogList()})}function scanning(n){new Promise(function(n){showPrintModal(n)}).then(t=>{t&&$(`#${n}`).val(t.split(",")[2])})}function getDeviceList(){var t=100,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;n.opData=JSON.stringify({hard:!0,work:!0});ajaxPost("/Relay/Post",n,function(n){var r,u,i,t,f;if(n.errno!=0){layer.msg(n.errmsg);return}var e=function(n){var t=n.DeviceStateStr;return t=="待加工"?'<span class="text-success">'+t+"<\/span>":t=="加工中"?'<span class="text-success">'+t+"<\/span>":t=="已确认"?'<span class="text-warning">'+t+"<\/span>":t=="维修中"?'<span class="text-info">'+t+"<\/span>":'<span class="text-red">'+t+"<\/span>"},o=function(n,t,i,r){return r.row+1},s=function(){$("#deviceList th").css("paddingRight","22px").css("paddingLeft",0)};for($("#deviceList").DataTable({pagingType:"full",destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:o},{data:"Id",title:"Id",bVisible:!1},{data:"Code",title:"机台号"},{data:"CategoryName",title:"类型"},{data:null,title:"设备状态",render:e},{data:"FlowCard",title:"流程卡号"},{data:"ProcessTime",title:"加工时间"},{data:"LeftTime",title:"剩余时间"}],columnDefs:[{type:"html-percent",targets:[2]}],drawCallback:s}),$(".ms2").empty(),r="",u='<option value="{0}" id="{2}" index="{3}">{1}<\/option>',i=0;i<n.datas.length;i++)t=n.datas[i],f=t.DeviceStateStr,(f=="待加工"||f=="加工中")&&$("#processCode,#addCraftCode").append(u.format(t.Id,t.Code,"")),r+=u.format(t.Code,t.Code,t.Administrator,t.Id);$("#faultCode").append(r)})}function queryFlowCard(){var r,n,t,u,i;if(hideTip("processCodeTip"),r=260,!checkPermission(r)){layer.msg("没有权限");return}($("#fcBody").addClass("hidden"),$("#isChangeDiv").addClass("hidden"),$("#processSteps").empty(),$("#info").empty(),$("#pData").empty(),$("#run").addClass("disabled"),$("#isChange").iCheck("uncheck"),n=!0,t=$("#processCode").val(),isStrEmptyOrUndefined(t)&&(showTip("processCodeTip","请选择设备"),n=!1),u=$("#flowCard").val().trim(),isStrEmptyOrUndefined(u)&&(layer.msg("流程卡号不能为空"),n=!1),n)&&(i={},i.opType=r,i.opData=JSON.stringify({Id:t,FlowCardName:u}),ajaxPost("/Relay/Post",i,function(n){var h,e,s,r,c,o,u;if(n.errno!=0){layer.msg(n.errmsg);return}checkPermission(156)&&$("#isChangeDiv").removeClass("hidden");$("#fcBody").removeClass("hidden");checkPermission(323)&&(h='<div class="form-group border-left"><label for="isDifference" class="text-danger">是否微调：<\/label><input type="checkbox" id="isDifference" class="icb_minimal"><\/div><div class="form-group form-inline hidden" id="differenceDiv"><label class="control-label" for="difference">当前厚度(mm)：<\/label><div class="from-group no-margin" style="display:-webkit-inline-box"><input type="tel" class="form-control" id="difference" autocomplete="off" placeholder="请输入当前厚度" style="width:150px" onfocusin="focusIn($(this))" maxlength="9" onkeyup="onInput(this)" oninput="value=value.replace(/[^\\d\\.]/g,\'\')" onblur="onInputEnd(this); queryProcessData();" maxlength="6"><label class="label-danger hidden" id="differenceTip" style="display:table-cell;height:34px;vertical-align:middle"><\/label><\/div><\/div>',$("#info").append(h));$("#isDifference").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});$("#isDifference").on("ifChanged",function(){var n=$(this);n.is(":checked")?(hideTip("differenceTip"),$("#differenceDiv").removeClass("hidden")):$("#differenceDiv").addClass("hidden");showProcessData()});var i=n.flowCard,f="<p><b>计划号：<\/b>{0}<\/p><p><b>紧急程度：<\/b>{1}<\/p>";for(f=f.format(i.ProductionProcessName,i.Priority==0?"低":i.Priority==1?"中":"高"),e=0;e<i.RawMateriaSpecifications.length;e++)s=i.RawMateriaSpecifications[e],f+="<p><b>{0}：<\/b>{1}<\/p> ".format(s.SpecificationName,s.SpecificationValue);if(f+="<p><b>工艺编号：<\/b>{0}<\/p>".format(i.ProcessNumber),$("#info").append(f),id=t,processId=i.ProcessId,flowCardId=i.flowCardId,processData=i.processData.sort(function(n,t){return n.ProcessOrder>t.ProcessOrder?1:-1}),newProcessData=null,showProcessData(),r=i.processSteps.sort(function(n,t){return n.ProcessStepOrder>t.ProcessStepOrder?1:-1}),r.length>0){for(c="<tr><td>{0}<\/td><td>{1}<\/td><td>{2}<\/td><td>{5}<\/td><td>{3}<\/td><td>{4}<\/td><\/tr>",o=0;o<r.length;o++)u=r[o],$("#processSteps").append(c.format(u.ProcessStepOrderName,u.StepName,u.ProcessStepRequirements,u.QualifiedRange,u.QualifiedMode==0?"":u.QualifiedMode,u.ProcessStepRequirementMid));r.length==2&&(LastLand=r[0].QualifiedMode!=0?r[0].QualifiedMode:r[0].ProcessStepRequirementMid,TarLand=r[1].ProcessStepRequirementMid)}}))}function queryProcessData(){var i,n,r,t;if($("#isDifference").is(":checked")){if(i=323,!checkPermission(i)){layer.msg("没有权限");return}if(newProcessData=null,n=$("#difference").val().trim(),isStrEmptyOrUndefined(n)){showTip("differenceTip","当前厚度不能为空");return}if(n=parseFloat(n),n==0||n>20){showTip("differenceTip","当前厚度必须在0-20之间");return}if(LastLand==0){layer.msg("上道工序厚度缺失");return}if(TarLand==0){layer.msg("当前工序加工厚度缺失");return}if(n<TarLand){layer.msg("当前厚度必须大于加工要求");return}r={Id:processId,CurLand:n,LastLand:LastLand,TarLand:TarLand};$("#pData").empty();t={};t.opType=i;t.opData=JSON.stringify(r);ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}newProcessData=n.datas.sort(function(n,t){return n.ProcessOrder>t.ProcessOrder?1:-1});showProcessData()})}}function showProcessData(n=false){var f,r,t;n||(n=$("#isChange").is(":checked"));var i=$("#isDifference").is(":checked")?newProcessData:processData,u='<tr>    <td style="vertical-align: middle;"><span class="num">{0}<\/span><\/td>    <td class="form-inline">        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{1}" maxlength="9" />        <span style="width: 10%;">:<\/span>        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{2}" onblur="value=isStrEmptyOrUndefined(value)?\'\':(parseInt(value)>59?59:parseInt(value))" maxlength="9" />    <\/td>    <td class="form-inline">        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{3}" maxlength="9" />        <span style="width: 10%;">:<\/span>        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{4}" onblur="value=isStrEmptyOrUndefined(value)?\'\':(parseInt(value)>59?59:parseInt(value))" maxlength="9" />    <\/td>    <td><input type="tel" class="text-center" style="width: 80%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{5}" maxlength="9" /><\/td>    <td><input type="tel" class="text-center" style="width: 80%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{6}" maxlength="9" /><\/td>    <td><button type="button" class="minus btn btn-danger btn-xs"><i class="fa fa-minus"><\/i><\/button><button type="button" class="plus btn btn-success btn-xs"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>';if(i!=null&&i.length>0){for($("#pData").empty(),f=n?u:"<tr><td>{0}<\/td><td>{1}&nbsp;:&nbsp;{2}<\/td><td>{3}&nbsp;:&nbsp;{4}<\/td><td>{5}<\/td><td>{6}<\/td><\/tr>",$("#run").removeClass("disabled"),r=0;r<i.length;r++)t=i[r],$("#pData").append(f.format(t.ProcessOrder,t.PressurizeMinute,t.PressurizeSecond,t.ProcessMinute,t.ProcessSecond,t.Pressure,t.Speed));$("#tableP td").css("padding","2px");$("#tableP td").css("paddingTop","8px").css("paddingBottom","8px")}$("#pData").off("click").on("click",".plus",function(){var i=$(this).parents("tr"),n,t;for(i.after(u.format(0,0,0,0,0,0,0)),$("#tableP td").css("padding","2px"),$("#tableP td").css("paddingTop","8px").css("paddingBottom","8px"),t=$("#pData .num").length,n=0;n<t;n++)$($("#pData .num")[n]).text(n+1);t==8&&$(".plus").addClass("hidden")});$("#pData").on("click",".minus",function(){var i=$(this).parents("tr"),n,t;for(i.remove(),$(".plus").removeClass("hidden"),t=$("#pData .num").length,n=0;n<t;n++)$($("#pData .num")[n]).text(n+1)});$("#pData").off("focusin").on("focusin","input",function(){var n=$(this).val();n==0&&$(this).val("")});$("#pData").off("focusout").on("focusout","input",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")})}function minus(){var n=$(this).parents("tr");n.remove()}function setProcessData(){var r,i,u,n,o;if(!isStrEmptyOrUndefined(id)&&!isStrEmptyOrUndefined(flowCardId)&&!isStrEmptyOrUndefined(processId)){if(r={DeviceId:id,ProcessId:processId,FlowCardId:flowCardId},i=110,$("#isDifference").is(":checked")){if(u=$("#difference").val().trim(),isStrEmptyOrUndefined(u)){showTip("differenceTip","当前厚度不能为空");return}if(i=155,newProcessData==null||newProcessData.length==0){layer.msg("缺少工艺数据");return}r.ProcessDatas=newProcessData}if($("#isChange").is(":checked")){i=156;var f=[],t=$("#pData input"),e=6;if(t.length>0)for(n=0;n<t.length;n++)if(!isStrEmptyOrUndefined(t[n].value)&&isNumber(t[n].value))(n+1)%e==0&&f.push({ProcessOrder:parseInt(n/e)+1,PressurizeMinute:t[n-5].value,PressurizeSecond:t[n-4].value,ProcessMinute:t[n-3].value,ProcessSecond:t[n-2].value,Pressure:t[n-1].value,Speed:t[n].value});else{layer.msg("工艺数据错误");return}else{layer.msg("缺少工艺数据");return}r.ProcessDatas=f}if(!checkPermission(i)){layer.msg("没有权限");return}o=function(){var n={};n.opType=i;n.opData=JSON.stringify(r);ajaxPost("/Relay/Post",n,function(t){if(layer.msg(t.errmsg),t.errno==0&&(addCraftModal(),$("#isDifference").is(":checked"))){var i=$("#difference").val().trim();if(isStrEmptyOrUndefined(i))return;i=parseFloat(i);n={};n.opType=166;n.opData=JSON.stringify({DeviceId:id,Time:getFullTime(),OpName:"微调",Thickness:i});ajaxPost("/Relay/Post",n,function(){})}})};showConfirm("设置",o)}}function getFaultType(){var t=406,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var u,i,t,f,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(faultData=n.datas,$("#faultType").empty(),u='<option value="{0}">{1}<\/option>',i="",t=0,f=faultData.length;t<f;t++)r=faultData[t],i+=u.format(r.Id,r.FaultTypeName);$("#faultType").append(i);$("#faultType").val($("#faultType").val()).trigger("select2:select")})}function getWorkShop(){var t=162,n;if(!checkPermission(t)){layer.msg("没有权限");return}n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){var t,u;if(n.errno!=0){layer.msg(n.errmsg);return}$("#workshop").empty();var i=n.datas,r="";for(t=0;t<i.length;t++)u=i[t],r+='<option value = "{0}">{0}<\/option>'.format(u.SiteName);$("#workshop").append(r)})}function showFaultModel(){getFaultType();getWorkShop();_updateFirmwareUpload==null&&(_updateFirmwareUpload=initFileInputMultiple("addImg",fileEnum.FaultDevice));$("#addImg").fileinput("clear");$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");hideClassTip("adt");$("#faultCode").val("").trigger("change");$("#faultOther").val("");$("#faultDate").val(getDate()).datepicker("update");$("#faultTime").val(getTime()).timepicker("setTime",getTime());var n=getCookieTokenInfo();$("#proposer").val(n.name);$("#faultDesc").val("");$("#faultModel").modal("show")}function reportFault(){var l=422,i,t,n,r,f,e,o,c,p,w;if(!checkPermission(l)){layer.msg("没有权限");return}if(i=$("#faultCode").val(),t=$("#faultOther").val().trim(),isStrEmptyOrUndefined(i)&&isStrEmptyOrUndefined(t)){layer.msg("请选择或输入机台号");return}if(!isStrEmptyOrUndefined(i)&&!isStrEmptyOrUndefined(t))for(n=0,r=i.length;n<r;n++)if(t==i[n]){layer.msg("其他机台号已选择，请重新输入");return}if(!isStrEmptyOrUndefined(t)){if(f=$("#workshop").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择车间");return}t=`${f}-${t}`}if(e=$("#proposer").val().trim(),isStrEmptyOrUndefined(e)){layer.msg("报修人不能为空");return}var b=$("#faultDate").val(),k=$("#faultTime").val(),a=`${b} ${k}`;if(exceedTime(a)){layer.msg("所选时间不能大于当前时间");return}if(o=$("#faultType").val(),isStrEmptyOrUndefined(o)){layer.msg("请选择故障类型");return}var d=$("#faultDesc").val().trim(),u=[],s=[],h={FaultTime:a,Proposer:e,FaultDescription:d,FaultTypeId:o};if(isStrEmptyOrUndefined(t)||(c=$.extend({},h),c.DeviceCode=t,u.push(c)),i!=null)for(n=0,r=i.length;n<r;n++){var v=i[n],y=$("#faultCode").find(`option[value=${v}]`),g=y.attr("index");h.DeviceId=g;u.push($.extend({},h));p=y.attr("id");s.push({Code:v,Admin:p})}w=function(t){var i=$("#addImg").val();isStrEmptyOrUndefined(i)?t("success"):($("#addImg").fileinput("upload"),fileCallBack[fileEnum.FaultDevice]=i=>{var f,e,o;if(i.errno==0){f=[];for(e in i.data)f.push(i.data[e].newName);for(f=JSON.stringify(f),n=0,r=u.length;n<r;n++)o=u[n],o.Images=f;t("success")}})};new Promise(function(n){w(n)}).then(function(){var t={};t.opType=l;t.opData=JSON.stringify(u);ajaxPost("/Relay/Post",t,function(t){if($("#faultModel").modal("hide"),layer.msg(t.errmsg),t.errno==0)for(getDeviceList(),n=0,r=s.length;n<r;n++){var i=s[n],u={ChatEnum:chatEnum.FaultDevice,Message:{Admin:i.Admin,Code:i.Code}};hubConnection.invoke("SendMsg",u)}})})}function getUsuallyFaultList(){var t=400,n;if(!checkPermission(t)){layer.msg("没有权限");return}$("#usuallyFaultList").empty();n={};n.opType=t;ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=function(n){var t=n.SolvePlan;return`<span title = "${t}" onclick = "showAllContent('${escape(t)}', '解决方案')">${t.length>tdShowLength?t.substring(0,tdShowLength)+"...":t}</span>`};$("#usuallyFaultList").DataTable({destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"序号"},{data:"UsuallyFaultDesc",title:"常见故障"},{data:null,title:"解决方案",render:t,orderable:!1}]});$("#usuallyFaultModel").modal("show")})}function showUsuallyFaultDetailModel(n){var i=401,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&$("#usuallyFaultDetail").html(n.datas[0].SolvePlan);$("#usuallyFaultDetailModel").modal("show")})}function showInputReport(){var n=getCookieTokenInfo(),t,i;clearRpFlowCard();$("#rpFlowCardTip").addClass("hidden");$("#tableFlowCard").addClass("hidden");t=n.proleList.indexOf(0)==-1;i=n.proleList.indexOf(1)==-1;$("#reportFlowCard").addClass("hidden");t&&i||$("#reportFlowCard").removeClass("hidden");$("#inputReportModel").modal("show")}function queryRpFlowCard(){var t,i,n;if($("#gxList").empty(),$("#tableFlowCard").removeClass("hidden"),t=202,!checkPermission(t)){layer.msg("没有权限");return}if(i=$("#rpFlowCard").val().trim(),isStrEmptyOrUndefined(i)){showTip("rpFlowCardTip","流程卡号不能为空");$("#tableFlowCard").addClass("hidden");return}n={};n.opType=t;n.opData=JSON.stringify({FlowCard:i});ajaxPost("/Relay/Post",n,function(n){function s(n,t){return n.ProcessStepOrder>t.ProcessStepOrder}var f,o,r;if(n.errno!=0){layer.msg(n.errmsg);return}f=getCookieTokenInfo();f.proleList=[0,1];var h=f.proleList.indexOf(0)>-1,c=f.proleList.indexOf(1)>-1,u=-1,i=-1,e=n.processSteps.sort(s);for(e.length>0&&(rpFcId=e[0].FlowCardId),o=0;o<e.length;o++)(r=e[o],r.IsReport)||(r.IsSurvey||!h||r.ProcessTime=="0001-01-01 00:00:00"||r.ProcessTime==null?r.IsSurvey&&c&&(r.SurveyTime=="0001-01-01 00:00:00"||r.SurveyTime==null)&&i==-1&&(i=r.ProcessStepOrder):u=r.ProcessStepOrder);u!=-1&&i!=-1&&(u<i?i=-1:u=-1);var t=0,l=function(n){return n.CategoryName+"-"+n.StepName},a=function(n){return t++,'<span id="c1f{0}" oValue="{1}">{2}<\/span>'.format(n.ProcessStepOrder,n.Id,t)},v=function(n){return'<span id="c2f{0}" oValue="{2}">{1}<\/span>'.format(t,n.ProcessorName,n.ProcessorId)},y=function(n){return n.ProcessTime=="0001-01-01 00:00:00"||n.ProcessTime==null?'<span id="c3f{0}" oValue="{1}"><\/span>'.format(t,n.ProcessTime):'<span id="c3f{0}" oValue="{1}">{1}<\/span>'.format(t,n.ProcessTime)},p=function(r){var e,u,o;if(i==r.ProcessStepOrder){for(e=0,u=0;u<n.surveyors.length;u++)if(o=n.surveyors[u],o.SurveyorName==f.name){e=o.Id;break}return'<span id="c4f{0}" oValue="{2}">{1}<\/span>'.format(t,f.name,e)}return'<span id="c4f{0}" oValue="{2}">{1}<\/span>'.format(t,r.SurveyorName,r.SurveyorId)},w='<input type="text" id="c51f{0}" class="form_date form-control" value="{2}" style="width:90px;background-color:white;"><input type="text" id="c52f{0}" class="form_time form-control" value="{3}" style="width:75px;background-color:white;"><span id="c5f{0}" oValue="{1}" class="hidden">{1}<\/span>',b=function(n){return i!=n.ProcessStepOrder?n.SurveyTime=="0001-01-01 00:00:00"||n.SurveyTime==null?'<span id="c5f{0}" oValue="{1}"><\/span>'.format(t,n.SurveyTime):'<span id="c5f{0}" oValue="{1}">{1}<\/span>'.format(t,n.SurveyTime):w.format(t,n.SurveyTime,getDate(),getTime())},k=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c6f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c6f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber);return'<input class="form-control" id="c6f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber)},d=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c7f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c7f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber);return'<input class="form-control" id="c7f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber)},g=function(n){return'<span id="c8f{0}" oValue="{2}">{1}<\/span>'.format(t,n.Code,n.DeviceId)},nt=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c9f{0}" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c9f{0}" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange);return'<input class="form-control" id="c9f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange)},tt=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c10f{0}" style="width:100%" value="{1}" oValue="{1}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10">'.format(t,n.QualifiedMode)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c10f{0}" style="width:100%" value="{1}" oValue="{1}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10">'.format(t,n.QualifiedMode);return'<input class="form-control" id="c10f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedMode)};$("#gxList").DataTable({destroy:!0,bSort:!1,paging:!1,deferRender:!1,bLengthChange:!1,info:!1,searching:!1,language:oLanguage,data:e,aaSorting:[[0,"asc"]],columns:[{data:null,title:"序号",render:a},{data:null,title:"工序名称",render:l},{data:"ProcessStepRequirements",title:"加工要求"},{data:null,title:"加工人",render:v},{data:null,title:"加工时间",render:y},{data:null,title:"机台号",render:g},{data:null,title:"检验人",render:p},{data:null,title:"检验时间",render:b},{data:null,title:"合格数",render:k},{data:null,title:"不合格数",render:d},{data:null,title:'成厚范围(<span class="text-info">例:0.2～0.3mm<\/span>)',render:nt},{data:null,title:'成厚均值(<span class="text-info">例:0.25<\/span>)',render:tt},],drawCallback:function(){$("#gxList th").css("padding-right","8px");initTime()}})})}function initTime(){$("#gxList .form_date,.form_time").attr("readonly",!0);$("#gxList .form_date").datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});$("#gxList .form_time").timepicker({language:"zh-CN",showMeridian:!1,minuteStep:1,showSeconds:!0,secondStep:1})}function reportFlowCard(){var c=208,t,a,v,o,y,s,p,w,b,k,u,i,r,n,h,d,f,g;if(!checkPermission(c)){layer.msg("没有权限");return}var nt=parseInt(rpFcId),tt=$("#gxList tbody").children(),e=[],l=!1;for(t=1;t<=tt.length;t++){for(i=1;i<=10;i++){r=$("#c{1}f{0}".format(t,i));n=r.attr("ovalue");switch(i){case 1:a=n;break;case 2:v=n;break;case 3:o=isStrEmptyOrUndefined(n)?null:n;break;case 4:y=n;break;case 5:r.parent().find("input").length>0&&(h=$("#c{1}1f{0}".format(t,i)),d=$("#c{1}2f{0}".format(t,i)),n=h.hasClass("hidden")?n:"{0} {1}".format($(h).val(),$(d).val()));s=isStrEmptyOrUndefined(n)?null:n;break;case 6:n=r.val();p=n;break;case 7:n=r.val();w=n;break;case 8:b=n;break;case 9:n=r.val();k=n;break;case 10:if(n=r.val(),u=n,isStrEmptyOrUndefined($("#c10f{0}".format(t)).attr("disabled"))&&(l=!0,isStrEmptyOrUndefined(u)||parseFloat(u)<=0)){layer.msg("成厚均值必须大于0");return}}}f={Id:a,FlowCardId:nt,ProcessorId:v,SurveyorId:y,QualifiedNumber:p,UnqualifiedNumber:w,DeviceId:b,QualifiedRange:k,QualifiedMode:u};o!=null&&(f.ProcessTime=o);s!=null&&(f.SurveyTime=s);e.push(f)}e.length<=0||l&&(g=function(){var n={};n.opType=c;n.opData=JSON.stringify(e);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&queryRpFlowCard()})},showConfirm("保存",g))}function clearRpFlowCard(){$("#rpFlowCard").val("");$("#gxList").empty();$("#tableFlowCard").addClass("hidden")}function addCraftModal(){var n=$("#processCode").val();$("#addCraftCode").val(n).trigger("change");$("#addCraftDate").val(getDate()).datepicker("update");$("#addCraftTime").val(getTime()).timepicker("setTime",getTime());$("#addCraftThickness").val("");$("#op1").click();$("#addCraftModel").modal("show")}function addCraft(){var o=166,i,r,t,s,u,f,e,n,h;if(!checkPermission(o)){layer.msg("没有权限");return}if(i=$("#addCraftCode").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择设备");return}if(isStrEmptyOrUndefined($("#addCraftDate").val())){layer.msg("请选择完整的时间");return}if(r=$("#addCraftDate").val()+" "+$("#addCraftTime").val(),exceedTime(r)){layer.msg("操作时间不能大于当前时间");return}for(s=$("#opUl a").length,t=0;t<s;t++)f=$("#opUl a")[t],$(f).attr("aria-expanded")=="true"&&(u=$(f).text());if(e=0,u=="片厚"){if(n=$("#addCraftThickness").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请输入片厚");return}if(n==parseFloat(n))n=parseFloat(n);else{layer.msg("请输入正确的数值");return}if(n==0||n>20){layer.msg("片厚范围在0-20之间");return}e=n}h=function(){$("#addCraftModel").modal("hide");var n={};n.opType=o;n.opData=JSON.stringify({DeviceId:i,Time:r,OpName:u,Thickness:e});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg)})};showConfirm("添加",h)}function showMaintainerModel(){var t=430,n;if(!checkPermission(t)){layer.msg("没有权限");return}$("#maintainerList").empty();n={};n.opType=t;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=function(n,t,i,r){return r.row+1},i=function(n){return n.length>tdShowLength?`<span title = "${n}" onclick = "showAllContent('${escape(n)}')">${n.substring(0,tdShowLength)}...</span>`:`<span title = "${n}">${n}</span>`};$("#maintainerList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',bAutoWidth:!1,destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"序号",render:t,sWidth:"80px"},{data:"Name",title:"姓名",sWidth:"120px"},{data:"Phone",title:"手机号",sWidth:"130px"},{data:"Remark",title:"备注",render:i}]});$("#maintainerModel").modal("show")})}function showLogModel(){var n;if(!checkPermission(438)){layer.msg("没有权限");return}n=getMonthScope();$("#logSTime,#logETime").off("changeDate");$("#logSTime").val(n.start).datepicker("update");$("#logETime").val(n.end).datepicker("update");$("#logSTime,#logETime").on("changeDate",function(){getLogList()});$("#stateSelect").val(-1);getLogList();$("#showLogModel").modal("show")}function getLogList(){var u=438,n,t,r,i;if(!checkPermission(u)){layer.msg("没有权限");return}if(n=$("#logSTime").val(),t=$("#logETime").val(),isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(t)){layer.msg("请选择故障时间");return}if(!comTimeDay(n,t)){if(r=$("#stateSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择状态");return}i={};i.opType=u;i.opData=JSON.stringify({startTime:n,endTime:t,state:r});ajaxPost("/Relay/Post",i,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=function(n,t,i,r){return r.row+1},i=function(n){var t="",i="";switch(n){case 0:t="低";i="black";break;case 1:t="中";i="#CC6600";break;case 2:t="高";i="red"}return'<span style="color:{1}">{0}<\/span>'.format(t,i)},r=function(n){var i=`<span style="color:{0}">${n.StateDesc}</span>`,t="";switch(n.State){case 0:t="red";break;case 1:t="#996600";break;case 2:t="green";break;case 3:t="blue"}return i.format(t)},u=function(n){return n==""||n.length<tdShowLength?n:`<span title = "${n}" onclick="showAllContent('${escape(n)}', '维修备注')">${n.substring(0,tdShowLength)+"..."}</span>`},f=function(n){return n=="0001-01-01 00:00:00"?"":n.slice(0,n.indexOf(" "))},e=function(n){return n=="0001-01-01 00:00:00"?"":n.slice(0,n.indexOf(" "))},o=function(n){var t='<button type="button" class="btn btn-{0} btn-sm" onclick="showLogDetailModel({2},{3})"}>{1}<\/button>';return n.State==3&&n.Score==0?t.format("primary","评价",n.Id,0):t.format("success","查看",n.Id,1)};$("#logList").DataTable({dom:'<"pull-left"l><"pull-right"f>rtip',bAutoWidth:!1,destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:t},{data:"DeviceCode",title:"机台号"},{data:"FaultTime",title:"故障时间"},{data:"Priority",title:"优先级",render:i},{data:null,title:"状态",render:r},{data:"Score",title:"评分",sClass:"text-primary"},{data:"Maintainer",title:"维修工"},{data:"Phone",title:"联系方式"},{data:"Remark",title:"维修备注",render:u},{data:"EstimatedTime",title:"预计解决时间",render:f},{data:"SolveTime",title:"解决时间",render:e},{data:null,title:"详情",render:o}]})})}}function showLogDetailModel(n,t){var r=438,i;if(!checkPermission(r)){layer.msg("没有权限");return}i={};i.opType=r;i.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",i,function(n){var r,e,o;if(n.errno!=0){layer.msg(n.errmsg);return}r=n.datas[0];t?($("#showLogDetailModel .lookFalse").addClass("hidden"),$("#scoreText").removeClass("hidden"),$("#scoreText").text(r.Score)):($("#showLogDetailModel .lookFalse").removeClass("hidden"),$("#scoreText").addClass("hidden"),$("#scoreInput").val(""),$("#scoreText").text(""));$("#comment").prop("disabled",t);$("#comment").val(r.Comment);$("#updateCommentBtn").val(r.Id);$("#deviceText").text(r.DeviceCode);$("#proposerText").text(r.Proposer);$("#faultTypeText").text(r.FaultTypeName);$("#faultTimeText").text(r.FaultTime);$("#faultTypeDesc").text(r.FaultDescription);$("#faultSup").text(r.Fault1);var s=r.Priority,u="",f="";switch(s){case 0:u="低";f="black";break;case 1:u="中";f="#CC6600";break;case 2:u="高";f="red"}$("#priorityText").text(u).css("color",f);$("#solveProposerText").text(r.Maintainer);$("#actualFaultTypeText").text(r.FaultTypeName1);e=r.EstimatedTime;$("#estimatedTimeText").text(e=="0001-01-01 00:00:00"?"":e.slice(0,e.indexOf(" ")));o=r.SolveTime;$("#solveTimeText").text(o=="0001-01-01 00:00:00"?"":o.slice(0,o.indexOf(" ")));$("#remark").text(r.Remark);$("#solvePlan").text(r.FaultSolver);$("#detailImgList").empty();r.ImageList>0&&(i={type:fileEnum.FaultDevice,files:r.Images},ajaxPost("/Upload/Path",i,function(n){var r,i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(r='<div class="col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><div class="caption text-center"><\/div><\/div><\/div>',i="",t=0;t<n.data.length;t++)i+=r.format(n.data[t].path);$("#detailImgList").append(i)}))});$("#showLogDetailModel").modal("show")}function updateComment(){var r=439,i,n,u,t;if(!checkPermission(r)){layer.msg("没有权限");return}if(i=parseInt($(this).val()),n=$("#scoreInput").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请输入评分");return}n=parseInt(n);u=$("#comment").val().trim();t={};t.opType=r;t.opData=JSON.stringify({Id:i,Score:n,Comment:u,Account:getCookieTokenInfo().account});ajaxPost("/Relay/Post",t,function(t){layer.msg(t.errmsg);$("#showLogDetailModel").modal("hide");t.errno==0&&(getLogList(),showLogDetailModel(i,n))})}var faultData=null,oProcessData=null,processData=null,newProcessData=null,LastLand=0,TarLand=0,id=null,processId=null,flowCardId=null,_updateFirmwareUpload=null,rpFcId;