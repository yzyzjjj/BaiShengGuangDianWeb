function pageReady(){_permissionList[2]={uIds:["queryFlowCardBtn"]};_permissionList[3]={uIds:["run"]};_permissionList[4]={uIds:["addCraftModalBtn"]};_permissionList[5]={uIds:["showInputReportBtn"]};_permissionList[6]={uIds:["showFaultModelBtn"]};_permissionList[7]={uIds:["showLogModelBtn"]};_permissionList[13]={uIds:[]};_permissionList[8]={uIds:["showMaintainerModelBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();$("#run").addClass("disabled");getDeviceList();$("#flowCard").change(function(){$("#run").addClass("disabled")});$("#flowCard").on("keydown",function(n){n.keyCode==13&&queryFlowCard()});$("#rpFlowCard").on("keydown",function(n){n.keyCode==13&&queryRpFlowCard()});$("#processCode").on("select2:select",function(){$("#run").addClass("disabled")});$("#addCraftOp").change(function(){var n=$("#addCraftOp").val();n=="片厚"?$("#addCraftThickness").parent().removeAttr("hidden"):$("#addCraftThickness").parent().attr("hidden","hidden")});$("#faultType").on("select2:select",function(){for(var t="",n=0;n<faultData.length;n++)if(faultData[n].Id==$("#faultType").val()){t=faultData[n].FaultDescription;break}$("#faultDefaultDesc").val(t);$("#faultDefaultDesc").attr("disabled","disabled")});$("#faultCode").select2({allowClear:!0,placeholder:"请选择"});$("#isChange").on("ifChanged",function(){var t=$(this),n=$("#difference").val();(n||n=="")&&(n=$("#difference").val().trim());isStrEmptyOrUndefined(n)&&$("#isDifference").iCheck("uncheck");t.is(":checked")?$("#refresh").removeClass("hidden"):$("#refresh").addClass("hidden");showProcessData(t.is(":checked"))});$("#refresh").on("click",function(){$("#pData").find("input").val(0)});$("#flowCardEmpty").click(function(){$("#flowCard").val("").trigger("focus")});$("#opUl").on("click","a",function(){$(this).css("backgroundColor","#d3d3d3").parent().siblings().find("a").css("backgroundColor","");$("#addCraftDate").val(getDate()).datepicker("update");$("#addCraftTime").val(getTime()).timepicker("setTime",getTime());$(this).text()=="片厚"?$("#thick").removeClass("hidden"):$("#thick").addClass("hidden")});$("#stateSelect").on("change",function(){getLogList()});$("#workshop").on("change",function(){setWorkSiteSelect()});$("#devSite").select2({allowClear:!0,placeholder:"请选择(可不选)"});pcAndroid()||$(".scanning").addClass("hidden")}function scanning(n){new Promise(function(n){showPrintModal(n)}).then(t=>{t&&$(`#${n}`).val(t.split(",")[2])})}function getDeviceList(){var n={};n.opType=100;n.opData=JSON.stringify({hard:!0,work:!0});ajaxPost("/Relay/Post",n,function(n){var u,f,r,o,t,e;if(n.errno!=0){layer.msg(n.errmsg);return}var i=n.datas,s=function(n){var t=n.DeviceStateStr;return t=="待加工"?'<span class="text-success">'+t+"<\/span>":t=="加工中"?'<span class="text-success">'+t+"<\/span>":t=="已确认"?'<span class="text-warning">'+t+"<\/span>":t=="维修中"?'<span class="text-info">'+t+"<\/span>":'<span class="text-red">'+t+"<\/span>"},h=function(n,t,i,r){return++r.row};for($("#deviceList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',pagingType:"full",destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:h},{data:"Id",title:"Id",bVisible:!1},{data:"Code",title:"机台号",type:"html-percent"},{data:"CategoryName",title:"类型"},{data:null,title:"设备状态",render:s},{data:"FlowCard",title:"流程卡号"},{data:"ProcessTime",title:"加工时间"},{data:"LeftTime",title:"剩余时间"}],drawCallback:function(){$("#deviceList th").css("paddingRight","22px").css("paddingLeft",0)}}),$(".ms2").empty(),i.sort((n,t)=>n.Code-t.Code),u="",f='<option value="{0}" id="{2}" index="{3}">{1}<\/option>',r=0,o=i.length;r<o;r++)t=i[r],e=t.DeviceStateStr,(e=="待加工"||e=="加工中")&&$("#processCode,#addCraftCode").append(f.format(t.Id,t.Code,"")),u+=f.format(t.Code,t.Code,t.Administrator,t.Id);$("#faultCode").append(u)})}function queryFlowCard(){var n,t,r,i;(hideTip("processCodeTip"),$("#fcBody").addClass("hidden"),$("#isChangeDiv").addClass("hidden"),$("#processSteps").empty(),$("#info").empty(),$("#pData").empty(),$("#run").addClass("disabled"),$("#isChange").iCheck("uncheck"),n=!0,t=$("#processCode").val(),isStrEmptyOrUndefined(t)&&(showTip("processCodeTip","请选择设备"),n=!1),r=$("#flowCard").val().trim(),isStrEmptyOrUndefined(r)&&(layer.msg("流程卡号不能为空"),n=!1),n)&&(i={},i.opType=260,i.opData=JSON.stringify({Id:t,FlowCardName:r}),ajaxPost("/Relay/Post",i,function(n){var h,e,s,r,c,o,u;if(n.errno!=0){layer.msg(n.errmsg);return}$("#fcBody").removeClass("hidden");h='<div class="form-group border-left"><label for="isDifference" class="text-danger">是否微调：<\/label><input type="checkbox" id="isDifference" class="icb_minimal"><\/div><div class="form-group form-inline hidden" id="differenceDiv"><label class="control-label" for="difference">当前厚度(mm)：<\/label><div class="from-group no-margin" style="display:-webkit-inline-box"><input type="tel" class="form-control" id="difference" autocomplete="off" placeholder="请输入当前厚度" style="width:150px" onfocusin="focusIn($(this))" oninput="onInput(this, 9, 0)" onblur="onInputEnd(this); queryProcessData();" maxlength="6"><label class="label-danger hidden" id="differenceTip" style="display:table-cell;height:34px;vertical-align:middle"><\/label><\/div><\/div>';$("#info").append(h);$("#isDifference").iCheck({checkboxClass:"icheckbox_minimal",radioClass:"iradio_minimal",increaseArea:"20%"});$("#isDifference").on("ifChanged",function(){var n=$(this);n.is(":checked")?(hideTip("differenceTip"),$("#differenceDiv").removeClass("hidden")):$("#differenceDiv").addClass("hidden");showProcessData()});var i=n.flowCard,f="<p><b>计划号：<\/b>{0}<\/p><p><b>紧急程度：<\/b>{1}<\/p>";for(f=f.format(i.ProductionProcessName,i.Priority==0?"低":i.Priority==1?"中":"高"),e=0;e<i.RawMateriaSpecifications.length;e++)s=i.RawMateriaSpecifications[e],f+="<p><b>{0}：<\/b>{1}<\/p> ".format(s.SpecificationName,s.SpecificationValue);if(f+="<p><b>工艺编号：<\/b>{0}<\/p>".format(i.ProcessNumber),$("#info").append(f),id=t,processId=i.ProcessId,flowCardId=i.flowCardId,processData=i.processData.sort(function(n,t){return n.ProcessOrder>t.ProcessOrder?1:-1}),newProcessData=null,showProcessData(),r=i.processSteps.sort(function(n,t){return n.ProcessStepOrder>t.ProcessStepOrder?1:-1}),r.length>0){for(c="<tr><td>{0}<\/td><td>{1}<\/td><td>{2}<\/td><td>{5}<\/td><td>{3}<\/td><td>{4}<\/td><\/tr>",o=0;o<r.length;o++)u=r[o],$("#processSteps").append(c.format(u.ProcessStepOrderName,u.StepName,u.ProcessStepRequirements,u.QualifiedRange,u.QualifiedMode==0?"":u.QualifiedMode,u.ProcessStepRequirementMid));r.length==2&&(LastLand=r[0].QualifiedMode!=0?r[0].QualifiedMode:r[0].ProcessStepRequirementMid,TarLand=r[1].ProcessStepRequirementMid)}}))}function queryProcessData(){var n,i,t;if($("#isDifference").is(":checked")){if(newProcessData=null,n=$("#difference").val().trim(),isStrEmptyOrUndefined(n)){showTip("differenceTip","当前厚度不能为空");return}if(n=parseFloat(n),n==0||n>20){showTip("differenceTip","当前厚度必须在0-20之间");return}if(LastLand==0){layer.msg("上道工序厚度缺失");return}if(TarLand==0){layer.msg("当前工序加工厚度缺失");return}if(n<TarLand){layer.msg("当前厚度必须大于加工要求");return}i={Id:processId,CurLand:n,LastLand:LastLand,TarLand:TarLand};$("#pData").empty();t={};t.opType=323;t.opData=JSON.stringify(i);ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}newProcessData=n.datas.sort(function(n,t){return n.ProcessOrder>t.ProcessOrder?1:-1});showProcessData()})}}function showProcessData(n=false){var f,r,t;n||(n=$("#isChange").is(":checked"));var i=$("#isDifference").is(":checked")?newProcessData:processData,u='<tr>    <td style="vertical-align: middle;"><span class="num">{0}<\/span><\/td>    <td class="form-inline">        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{1}" maxlength="9" />        <span style="width: 10%;">:<\/span>        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{2}" onblur="value=isStrEmptyOrUndefined(value)?\'\':(parseInt(value)>59?59:parseInt(value))" maxlength="9" />    <\/td>    <td class="form-inline">        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{3}" maxlength="9" />        <span style="width: 10%;">:<\/span>        <input type="tel" class="text-center" style="width: 45%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{4}" onblur="value=isStrEmptyOrUndefined(value)?\'\':(parseInt(value)>59?59:parseInt(value))" maxlength="9" />    <\/td>    <td><input type="tel" class="text-center" style="width: 80%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{5}" maxlength="9" /><\/td>    <td><input type="tel" class="text-center" style="width: 80%;" oninput="value=value.replace(/[^\\d]/g,\'\')" value="{6}" maxlength="9" /><\/td>    <td><button type="button" class="minus btn btn-danger btn-xs"><i class="fa fa-minus"><\/i><\/button><button type="button" class="plus btn btn-success btn-xs"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>';if($("#run").removeClass("disabled"),i!=null&&i.length>0){for($("#pData").empty(),f=n?u:"<tr><td>{0}<\/td><td>{1}&nbsp;:&nbsp;{2}<\/td><td>{3}&nbsp;:&nbsp;{4}<\/td><td>{5}<\/td><td>{6}<\/td><\/tr>",r=0;r<i.length;r++)t=i[r],$("#pData").append(f.format(t.ProcessOrder,t.PressurizeMinute,t.PressurizeSecond,t.ProcessMinute,t.ProcessSecond,t.Pressure,t.Speed));$("#tableP td").css("padding","2px");$("#tableP td").css("paddingTop","8px").css("paddingBottom","8px")}$("#pData").off("click").on("click",".plus",function(){var i=$(this).parents("tr"),n,t;for(i.after(u.format(0,0,0,0,0,0,0)),$("#tableP td").css("padding","2px"),$("#tableP td").css("paddingTop","8px").css("paddingBottom","8px"),t=$("#pData .num").length,n=0;n<t;n++)$($("#pData .num")[n]).text(n+1);t==8&&$(".plus").addClass("hidden")});$("#pData").on("click",".minus",function(){var i=$(this).parents("tr"),n,t;for(i.remove(),$(".plus").removeClass("hidden"),t=$("#pData .num").length,n=0;n<t;n++)$($("#pData .num")[n]).text(n+1)});$("#pData").off("focusin").on("focusin","input",function(){var n=$(this).val();n==0&&$(this).val("")});$("#pData").off("focusout").on("focusout","input",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")})}function minus(){var n=$(this).parents("tr");n.remove()}function setProcessData(){var i,r,u,n,o;if(!isStrEmptyOrUndefined(id)&&!isStrEmptyOrUndefined(flowCardId)&&!isStrEmptyOrUndefined(processId)){if(i={DeviceId:id,ProcessId:processId,FlowCardId:flowCardId},r=110,$("#isDifference").is(":checked")){if(u=$("#difference").val().trim(),isStrEmptyOrUndefined(u)){showTip("differenceTip","当前厚度不能为空");return}if(r=155,newProcessData==null||newProcessData.length==0){layer.msg("缺少工艺数据");return}i.ProcessDatas=newProcessData}if($("#isChange").is(":checked")){r=156;var f=[],t=$("#pData input"),e=6;if(t.length>0)for(n=0;n<t.length;n++)if(!isStrEmptyOrUndefined(t[n].value)&&isNumber(t[n].value))(n+1)%e==0&&f.push({ProcessOrder:parseInt(n/e)+1,PressurizeMinute:t[n-5].value,PressurizeSecond:t[n-4].value,ProcessMinute:t[n-3].value,ProcessSecond:t[n-2].value,Pressure:t[n-1].value,Speed:t[n].value});else{layer.msg("工艺数据错误");return}else{layer.msg("缺少工艺数据");return}i.ProcessDatas=f}o=function(){var n={};n.opType=r;n.opData=JSON.stringify(i);ajaxPost("/Relay/Post",n,function(t){if(layer.msg(t.errmsg),t.errno==0&&(addCraftModal(),$("#isDifference").is(":checked"))){var i=$("#difference").val().trim();if(isStrEmptyOrUndefined(i))return;i=parseFloat(i);n={};n.opType=166;n.opData=JSON.stringify({DeviceId:id,Time:getFullTime(),OpName:"微调",Thickness:i});ajaxPost("/Relay/Post",n,function(){})}})};showConfirm("设置",o)}}function getFaultType(){var n={};n.opType=406;ajaxPost("/Relay/Post",n,function(n){var u,i,t,f,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(faultData=n.datas,$("#faultType").empty(),u='<option value="{0}">{1}<\/option>',i="",t=0,f=faultData.length;t<f;t++)r=faultData[t],i+=u.format(r.Id,r.FaultTypeName);$("#faultType").append(i);$("#faultType").val($("#faultType").val()).trigger("select2:select")})}function getWorkShop(){var n={};n.opType=162;ajaxPost("/Relay/Post",n,function(n){var t,u;if(n.errno!=0){layer.msg(n.errmsg);return}$("#workshop").empty();var i=n.datas,r="";for(t=0;t<i.length;t++)u=i[t],r+='<option value = "{0}">{0}<\/option>'.format(u.SiteName);$("#workshop").append(r);getSite()})}function getSite(){var n={};n.opType=125;ajaxPost("/Relay/Post",n,function(n){var r,i,u,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(_siteData={},r=n.datas,i=0,u=r.length;i<u;i++)t=r[i],_siteData[t.SiteName]?_siteData[t.SiteName].push(t.RegionDescription):_siteData[t.SiteName]=[t.RegionDescription];setWorkSiteSelect()})}function setWorkSiteSelect(){var t,i,r,n,f,u;if($("#devSite").empty(),t=$("#workshop").val(),!isStrEmptyOrUndefined(t)){for(i=_siteData[t],r="",n=0,f=i.length;n<f;n++)u=i[n],r+=`<option value=${u}>${u}</option>`;$("#devSite").append(r);$("#devSite").val(0).trigger("change")}}function showFaultModel(){getFaultType();getWorkShop();_updateFirmwareUpload==null&&(_updateFirmwareUpload=initFileInputMultiple("addImg",fileEnum.FaultDevice));$("#addImg").fileinput("clear");$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");$("#faultCode").val("").trigger("change");$("#faultOther").val("");$("#faultDate").val(getDate()).datepicker("update");$("#faultTime").val(getTime()).timepicker("setTime",getTime());var n=getCookieTokenInfo();$("#proposer").val(n.name);$("#faultDesc").val("");$("#faultModel").modal("show")}function reportFault(){var r=$("#faultCode").val(),t=$("#faultOther").val().trim(),n,i,f,e,o,s,l,p,w;if(isStrEmptyOrUndefined(r)&&isStrEmptyOrUndefined(t)){layer.msg("请选择或输入设备");return}if(!isStrEmptyOrUndefined(r)&&!isStrEmptyOrUndefined(t))for(n=0,i=r.length;n<i;n++)if(t==r[n]){layer.msg("其他机台号已选择，请重新输入");return}if(!isStrEmptyOrUndefined(t)){if(f=$("#workshop").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择车间");return}e=$("#devSite").val();t=`${f}-${e?e+"-":""}${t}`}if(o=$("#proposer").val().trim(),isStrEmptyOrUndefined(o)){layer.msg("报修人不能为空");return}var b=$("#faultDate").val(),k=$("#faultTime").val(),a=`${b} ${k}`;if(exceedTime(a)){layer.msg("所选时间不能大于当前时间");return}if(s=$("#faultType").val(),isStrEmptyOrUndefined(s)){layer.msg("请选择故障类型");return}var d=$("#faultDesc").val().trim(),u=[],h=[],c={FaultTime:a,Proposer:o,FaultDescription:d,FaultTypeId:s};if(isStrEmptyOrUndefined(t)||(l=$.extend({},c),l.DeviceCode=t,u.push(l)),r!=null)for(n=0,i=r.length;n<i;n++){var v=r[n],y=$("#faultCode").find(`option[value=${v}]`),g=y.attr("index");c.DeviceId=g;u.push($.extend({},c));p=y.attr("id");h.push({Code:v,Admin:p})}w=function(t){var r=$("#addImg").val();isStrEmptyOrUndefined(r)?t("success"):($("#addImg").fileinput("upload"),fileCallBack[fileEnum.FaultDevice]=r=>{var f,e,o;if(r.errno==0){f=[];for(e in r.data)f.push(r.data[e].newName);for(f=JSON.stringify(f),n=0,i=u.length;n<i;n++)o=u[n],o.Images=f;t("success")}})};new Promise(function(n){w(n)}).then(function(){var t={};t.opType=422;t.opData=JSON.stringify(u);ajaxPost("/Relay/Post",t,function(t){if($("#faultModel").modal("hide"),layer.msg(t.errmsg),t.errno==0)for(getDeviceList(),n=0,i=h.length;n<i;n++){var r=h[n],u={ChatEnum:chatEnum.FaultDevice,Message:{Admin:r.Admin,Code:r.Code}};hubConnection.invoke("SendMsg",u)}})})}function getUsuallyFaultList(){$("#usuallyFaultList").empty();var n={};n.opType=400;ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=function(n){var t=n.SolvePlan;return`<span title = "${t}" onclick = "showAllContent('${escape(t)}', '解决方案')">${t.length>tdShowLength?t.substring(0,tdShowLength)+"...":t}</span>`};$("#usuallyFaultList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"序号"},{data:"UsuallyFaultDesc",title:"常见故障"},{data:null,title:"解决方案",render:t,orderable:!1}]});$("#usuallyFaultModel").modal("show")})}function showUsuallyFaultDetailModel(n){var t={};t.opType=401;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}n.datas.length>0&&$("#usuallyFaultDetail").html(n.datas[0].SolvePlan);$("#usuallyFaultDetailModel").modal("show")})}function showInputReport(){var n=getCookieTokenInfo(),t,i;clearRpFlowCard();$("#rpFlowCardTip").addClass("hidden");$("#tableFlowCard").addClass("hidden");t=n.proleList.indexOf(0)==-1;i=n.proleList.indexOf(1)==-1;$("#reportFlowCard").addClass("hidden");t&&i||$("#reportFlowCard").removeClass("hidden");$("#inputReportModel").modal("show");setTimeout(()=>$("#rpFlowCard").trigger("focus"),500)}function queryRpFlowCard(){var t,n;if($("#gxList").empty(),$("#tableFlowCard").removeClass("hidden"),t=$("#rpFlowCard").val().trim(),isStrEmptyOrUndefined(t)){showTip("rpFlowCardTip","流程卡号不能为空");$("#tableFlowCard").addClass("hidden");return}n={};n.opType=202;n.opData=JSON.stringify({FlowCard:t});ajaxPost("/Relay/Post",n,function(n){function s(n,t){return n.ProcessStepOrder>t.ProcessStepOrder}var f,o,r;if(n.errno!=0){layer.msg(n.errmsg);return}f=getCookieTokenInfo();f.proleList=[0,1];var h=f.proleList.indexOf(0)>-1,c=f.proleList.indexOf(1)>-1,u=-1,i=-1,e=n.processSteps.sort(s);for(e.length>0&&(rpFcId=e[0].FlowCardId),o=0;o<e.length;o++)(r=e[o],r.IsReport)||(r.IsSurvey||!h||r.ProcessTime=="0001-01-01 00:00:00"||r.ProcessTime==null?r.IsSurvey&&c&&(r.SurveyTime=="0001-01-01 00:00:00"||r.SurveyTime==null)&&i==-1&&(i=r.ProcessStepOrder):u=r.ProcessStepOrder);u!=-1&&i!=-1&&(u<i?i=-1:u=-1);var t=0,l=function(n){return n.CategoryName+"-"+n.StepName},a=function(n){return t++,'<span id="c1f{0}" oValue="{1}">{2}<\/span>'.format(n.ProcessStepOrder,n.Id,t)},v=function(n){return'<span id="c2f{0}" oValue="{2}">{1}<\/span>'.format(t,n.ProcessorName,n.ProcessorId)},y=function(n){return n.ProcessTime=="0001-01-01 00:00:00"||n.ProcessTime==null?'<span id="c3f{0}" oValue="{1}"><\/span>'.format(t,n.ProcessTime):'<span id="c3f{0}" oValue="{1}">{1}<\/span>'.format(t,n.ProcessTime)},p=function(r){var e,u,o;if(i==r.ProcessStepOrder){for(e=0,u=0;u<n.surveyors.length;u++)if(o=n.surveyors[u],o.SurveyorName==f.name){e=o.Id;break}return'<span id="c4f{0}" oValue="{2}">{1}<\/span>'.format(t,f.name,e)}return'<span id="c4f{0}" oValue="{2}">{1}<\/span>'.format(t,r.SurveyorName,r.SurveyorId)},w='<input type="text" id="c51f{0}" class="form_date form-control" value="{2}" style="width:90px;background-color:white;"><input type="text" id="c52f{0}" class="form_time form-control" value="{3}" style="width:75px;background-color:white;"><span id="c5f{0}" oValue="{1}" class="hidden">{1}<\/span>',b=function(n){return i!=n.ProcessStepOrder?n.SurveyTime=="0001-01-01 00:00:00"||n.SurveyTime==null?'<span id="c5f{0}" oValue="{1}"><\/span>'.format(t,n.SurveyTime):'<span id="c5f{0}" oValue="{1}">{1}<\/span>'.format(t,n.SurveyTime):w.format(t,n.SurveyTime,getDate(),getTime())},k=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c6f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c6f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber);return'<input class="form-control" id="c6f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.QualifiedNumber)},d=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c7f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c7f{0}" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber);return'<input class="form-control" id="c7f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" oninput="value=value.replace(/[^\\d]/g,\'\')">'.format(t,n.UnqualifiedNumber)},g=function(n){return'<span id="c8f{0}" oValue="{2}">{1}<\/span>'.format(t,n.Code,n.DeviceId)},nt=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c9f{0}" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c9f{0}" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange);return'<input class="form-control" id="c9f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedRange)},tt=function(n){if(n.IsSurvey){if(i==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c10f{0}" style="width:100%" value="{1}" oValue="{1}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10">'.format(t,n.QualifiedMode)}else if(u==n.ProcessStepOrder&&!n.IsReport)return'<input class="form-control" id="c10f{0}" style="width:100%" value="{1}" oValue="{1}" onkeyup="onInput(this)" onblur="onInputEnd(this)" maxlength="10">'.format(t,n.QualifiedMode);return'<input class="form-control" id="c10f{0}" disabled="disabled" style="width:100%" value="{1}" oValue="{1}" onblur="autoCal(this, \'c10f{0}\')" maxlength="20">'.format(t,n.QualifiedMode)};$("#gxList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,bSort:!1,paging:!1,deferRender:!1,bLengthChange:!1,info:!1,searching:!1,language:oLanguage,data:e,aaSorting:[[0,"asc"]],columns:[{data:null,title:"序号",render:a},{data:null,title:"工序名称",render:l},{data:"ProcessStepRequirements",title:"加工要求"},{data:null,title:"加工人",render:v},{data:null,title:"加工时间",render:y},{data:null,title:"机台号",render:g},{data:null,title:"检验人",render:p},{data:null,title:"检验时间",render:b},{data:null,title:"合格数",render:k},{data:null,title:"不合格数",render:d},{data:null,title:'成厚范围(<span class="text-info">例:0.2～0.3mm<\/span>)',render:nt},{data:null,title:'成厚均值(<span class="text-info">例:0.25<\/span>)',render:tt},],drawCallback:function(){$("#gxList th").css("padding-right","8px");initTime()}})})}function initTime(){$("#gxList .form_date,.form_time").attr("readonly",!0);$("#gxList .form_date").datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});$("#gxList .form_time").timepicker({language:"zh-CN",showMeridian:!1,minuteStep:1,showSeconds:!0,secondStep:1})}function reportFlowCard(){for(var l,a,o,v,s,y,p,w,b,u,t,i,n,h,k,f,d,g=parseInt(rpFcId),nt=$("#gxList tbody").children(),e=[],c=!1,r=1;r<=nt.length;r++){for(t=1;t<=10;t++){i=$("#c{1}f{0}".format(r,t));n=i.attr("ovalue");switch(t){case 1:l=n;break;case 2:a=n;break;case 3:o=isStrEmptyOrUndefined(n)?null:n;break;case 4:v=n;break;case 5:i.parent().find("input").length>0&&(h=$("#c{1}1f{0}".format(r,t)),k=$("#c{1}2f{0}".format(r,t)),n=h.hasClass("hidden")?n:"{0} {1}".format($(h).val(),$(k).val()));s=isStrEmptyOrUndefined(n)?null:n;break;case 6:n=i.val();y=n;break;case 7:n=i.val();p=n;break;case 8:w=n;break;case 9:n=i.val();b=n;break;case 10:if(n=i.val(),u=n,isStrEmptyOrUndefined($("#c10f{0}".format(r)).attr("disabled"))&&(c=!0,isStrEmptyOrUndefined(u)||parseFloat(u)<=0)){layer.msg("成厚均值必须大于0");return}}}f={Id:l,FlowCardId:g,ProcessorId:a,SurveyorId:v,QualifiedNumber:y,UnqualifiedNumber:p,DeviceId:w,QualifiedRange:b,QualifiedMode:u};o!=null&&(f.ProcessTime=o);s!=null&&(f.SurveyTime=s);e.push(f)}e.length<=0||c&&(d=function(){var n={};n.opType=208;n.opData=JSON.stringify(e);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&queryRpFlowCard()})},showConfirm("保存",d))}function clearRpFlowCard(){$("#rpFlowCard").val("").trigger("focus");$("#gxList").empty();$("#tableFlowCard").addClass("hidden")}function addCraftModal(){var n=$("#processCode").val();$("#addCraftCode").val(n).trigger("change");$("#addCraftDate").val(getDate()).datepicker("update");$("#addCraftTime").val(getTime()).timepicker("setTime",getTime());$("#addCraftThickness").val("");$("#op1").click();$("#addCraftModel").modal("show")}function addCraft(){var e=$("#addCraftCode").val(),i,t,o,r,u,f,n,s;if(isStrEmptyOrUndefined(e)){layer.msg("请选择设备");return}if(isStrEmptyOrUndefined($("#addCraftDate").val())){layer.msg("请选择完整的时间");return}if(i=$("#addCraftDate").val()+" "+$("#addCraftTime").val(),exceedTime(i)){layer.msg("操作时间不能大于当前时间");return}for(o=$("#opUl a").length,t=0;t<o;t++)u=$("#opUl a")[t],$(u).attr("aria-expanded")=="true"&&(r=$(u).text());if(f=0,r=="片厚"){if(n=$("#addCraftThickness").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请输入片厚");return}if(n==parseFloat(n))n=parseFloat(n);else{layer.msg("请输入正确的数值");return}if(n==0||n>20){layer.msg("片厚范围在0-20之间");return}f=n}s=function(){$("#addCraftModel").modal("hide");var n={};n.opType=166;n.opData=JSON.stringify({DeviceId:e,Time:i,OpName:r,Thickness:f});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg)})};showConfirm("添加",s)}function showMaintainerModel(){$("#maintainerList").empty();var n={};n.opType=430;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=function(n,t,i,r){return r.row+1},i=function(n){return n.length>tdShowLength?`<span title = "${n}" onclick = "showAllContent('${escape(n)}')">${n.substring(0,tdShowLength)}...</span>`:`<span title = "${n}">${n}</span>`};$("#maintainerList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',bAutoWidth:!1,destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"序号",render:t,sWidth:"80px"},{data:"Name",title:"姓名",sWidth:"120px"},{data:"Phone",title:"手机号",sWidth:"130px"},{data:"Remark",title:"备注",render:i}]});$("#maintainerModel").modal("show")})}function showLogModel(){var n=getMonthScope();$("#logSTime,#logETime").off("changeDate");$("#logSTime").val(n.start).datepicker("update");$("#logETime").val(n.end).datepicker("update");$("#logSTime,#logETime").on("changeDate",function(){getLogList()});$("#stateSelect").val(-1);getLogList();$("#showLogModel").modal("show")}function getLogList(){var t=$("#logSTime").val(),i=$("#logETime").val(),r,n;if(isStrEmptyOrUndefined(t)||isStrEmptyOrUndefined(i)){layer.msg("请选择故障时间");return}if(!comTimeDay(t,i)){if(r=$("#stateSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择状态");return}n={};n.opType=438;n.opData=JSON.stringify({startTime:t,endTime:i,state:r});ajaxPost("/Relay/Post",n,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var i=getCookieTokenInfo().account,r=function(n,t,i,r){return r.row+1},u=function(n){var t="",i="";switch(n){case 0:t="低";i="black";break;case 1:t="中";i="#CC6600";break;case 2:t="高";i="red"}return'<span style="color:{1}">{0}<\/span>'.format(t,i)},f=function(n){var i=`<span style="color:{0}">${n.StateDesc}</span>`,t="";switch(n.State){case 0:t="red";break;case 1:t="#996600";break;case 2:t="green";break;case 3:t="blue"}return i.format(t)},e=function(n){return n==""||n.length<tdShowLength?n:`<span title = "${n}" onclick="showAllContent('${escape(n)}', '维修备注')">${n.substring(0,tdShowLength)+"..."}</span>`},t=function(n){return n=="0001-01-01 00:00:00"?"":n.slice(0,n.lastIndexOf(":"))},o=function(n){var t='<button type="button" class="btn btn-{0} btn-sm" onclick="showLogDetailModel({2},{3})"}>{1}<\/button>';return _permissionList[13].have&&n.State==3&&n.Score==0&&n.Account==i?t.format("primary","评价",n.Id,0):t.format("success","查看",n.Id,1)};$("#logList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',bAutoWidth:!1,destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:r},{data:"DeviceCode",title:"机台号"},{data:"FaultTime",title:"故障时间",render:t},{data:"Priority",title:"优先级",render:u},{data:null,title:"状态",render:f},{data:"Score",title:"评分",sClass:"text-primary"},{data:"Name",title:"维修工"},{data:"Phone",title:"联系方式"},{data:"Remark",title:"维修备注",render:e},{data:"EstimatedTime",title:"预计解决时间",render:t},{data:"SolveTime",title:"解决时间",render:t},{data:null,title:"详情",render:o}]})})}}function showLogDetailModel(n,t){var i={};i.opType=438;i.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",i,function(n){var r,e,o;if(n.errno!=0){layer.msg(n.errmsg);return}r=n.datas[0];t?($("#showLogDetailModel .lookFalse").addClass("hidden"),$("#scoreText").removeClass("hidden"),$("#scoreText").text(r.Score)):($("#showLogDetailModel .lookFalse").removeClass("hidden"),$("#scoreText").addClass("hidden"),$("#scoreInput").val(""),$("#scoreText").text(""));$("#comment").prop("disabled",t);$("#comment").val(r.Comment);$("#updateCommentBtn").val(r.Id);$("#deviceText").text(r.DeviceCode);$("#proposerText").text(r.Proposer);$("#faultTypeText").text(r.FaultTypeName);$("#faultTimeText").text(r.FaultTime.slice(0,r.FaultTime.lastIndexOf(":")));$("#faultTypeDesc").text(r.FaultDescription);$("#faultSup").text(r.Fault1);var s=r.Priority,u="",f="";switch(s){case 0:u="低";f="black";break;case 1:u="中";f="#CC6600";break;case 2:u="高";f="red"}$("#priorityText").text(u).css("color",f);$("#solveProposerText").text(r.FaultSolver);$("#actualFaultTypeText").text(r.FaultTypeName1);e=r.EstimatedTime;$("#estimatedTimeText").text(e=="0001-01-01 00:00:00"?"":e.slice(0,e.lastIndexOf(":")));o=r.SolveTime;$("#solveTimeText").text(o=="0001-01-01 00:00:00"?"":o.slice(0,o.lastIndexOf(":")));$("#costTimeText").text(r.CostTime);$("#fault2").val(r.Fault2);$("#remark").text(r.Remark);$("#solvePlan").text(r.SolvePlan);$("#detailImgList").empty();r.ImageList>0&&(i={type:fileEnum.FaultDevice,files:r.Images},ajaxPost("/Upload/Path",i,function(n){var r,i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(r='<div class="col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><div class="caption text-center"><\/div><\/div><\/div>',i="",t=0;t<n.data.length;t++)i+=r.format(n.data[t].path);$("#detailImgList").append(i)}))});$("#showLogDetailModel").modal("show")}function updateComment(){var i=parseInt($(this).val()),n=$("#scoreInput").val().trim(),r,t;if(isStrEmptyOrUndefined(n)){layer.msg("请输入评分");return}n=parseInt(n);r=$("#comment").val().trim();t={};t.opType=439;t.opData=JSON.stringify({Id:i,Score:n,Comment:r,Account:getCookieTokenInfo().account});ajaxPost("/Relay/Post",t,function(t){layer.msg(t.errmsg);$("#showLogDetailModel").modal("hide");t.errno==0&&(getLogList(),showLogDetailModel(i,n))})}var _permissionList=[],faultData=null,oProcessData=null,processData=null,newProcessData=null,LastLand=0,TarLand=0,id=null,processId=null,flowCardId=null,_siteData=null,_updateFirmwareUpload=null,rpFcId;