function pageReady(){$(".ms2").select2();$("#deviceSelect").select2({allowClear:!0,placeholder:"请选择",multiple:!0,width:"100%"});const n=new Promise(n=>getWarnSet(n)),t=new Promise(n=>getClass(n)),i=new Promise(n=>getScript(n));Promise.all([n,t,i]).then(n=>{n[0].length?showAppointWarnSet(n[0][0]):(getDevice(),getScriptItem())});$("#deviceWarn").on("select2:select",()=>getAppointWarnSet());$("#scriptSelect").on("select2:select",()=>{getDevice(),getScriptItem()});$("#deviceSelect").on("select2:select",function(){const n=$(this).val();if(~n.indexOf("0")){const t=$(this).find("option"),n=[];for(let i=0,r=t.length;i<r;i++)n.push(t.eq(i).val());n.splice(n.indexOf("0"),1);$(this).val(n).trigger("change")}});$("#npcVarList,#npcInsList,#npcOutList").on("focus",".zeroNum",function(){$(this).val()==0&&$(this).val("")});$("#npcVarList,#npcInsList,#npcOutList").on("blur",".zeroNum",function(){isStrEmptyOrUndefined($(this).val())&&$(this).val(0)})}function getWarnSet(n){const t=$("#navUl li.active").val();ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({first:!0,type:t})},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas;$("#deviceWarn").empty().append(setOptions(i,"Name"));n(i)})}function getAppointWarnSet(){_scriptTrData=[];const n=$("#deviceWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}const t=$("#navUl li.active").val();ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({qId:n,first:!0,type:t})},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas[0];showAppointWarnSet(t)})}function showAppointWarnSet(n){setThreeTable(n.Items,!1);$("#warnName").val(n.Name);$("#isStart").iCheck(n.Enable?"check":"uncheck");$("#deviceType").val(n.ClassId).trigger("change");$("#scriptSelect").val(n.ScriptId).trigger("change");new Promise(n=>getDevice(n)).then(()=>$("#deviceSelect").val(n.DeviceList).trigger("change"))}function resetTable(){$("#deviceWarn").val()?getAppointWarnSet():getScriptItem()}function getClass(n){ajaxPost("/Relay/Post",{opType:168},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#deviceType").empty().append(setOptions(t.datas,"Class"));n()})}function getScript(n){ajaxPost("/Relay/Post",{opType:113},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#scriptSelect").empty().append(setOptions(t.datas,"ScriptName"));n()})}function getDevice(n){const t=$("#scriptSelect").val();if(isStrEmptyOrUndefined(t)){layer.msg("请选择脚本");return}ajaxPost("/Relay/Post",{opType:100,opData:JSON.stringify({scriptId:t})},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas;let r="";i.length>1&&(r='<option value="0">全部<\/option>');$("#deviceSelect").empty().append(`${r}${setOptions(i,"Code")}`);n&&n()})}function getScriptItem(){_scriptTrData=[];const n=$("#scriptSelect").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择脚本");return}ajaxPost("/Relay/Post",{opType:1204,opData:JSON.stringify({sId:n,isNew:!0})},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas;setThreeTable(t,!0)})}function setThreeTable(n,t){const r={1:[],2:[],3:[]};for(let t=0,i=n.length;t<i;t++){const i=n[t];r[i.VariableTypeId].push(i)}const e=n=>{const i=n.Frequency,r=n.Count;let u="";if(!t&&i&&r)u=`<span class="textOn">${i}${["","秒","分","小时","天","周","月","年"][n.Interval]}${r}次</span>`;return`${u}<div class="flexStyle hidden textIn" style="justify-content:center">
                                <input class="form-control text-center zeroNum frequency" style="min-width:80px" oninput="onInput(this, 4, 0)" value=${i}>
                                <select class="form-control interval" style="min-width:70px">
                                    <option value="1">秒</option>
                                    <option value="2">分</option>
                                    <option value="3">小时</option>
                                    <option value="4">天</option>
                                    <option value="5">周</option>
                                    <option value="6">月</option>
                                    <option value="7">年</option>
                                </select>
                                <span class="flexStyle">
                                    <input class="form-control text-center zeroNum count" style="min-width:80px" oninput="onInput(this, 4, 0)" value=${r}>
                                    <label style="margin:0 0 0 3px">次</label>
                                </span>
                            </div>`},u=(n,i)=>{let r="";if(!t&&i)r=`<span class="textOn">${["","大于","大于等于","小于","小于等于"][i]}</span>`;return`${r}<select class="form-control hidden textIn condition${n}" style="min-width:90px">
                                  ${n===2?'<option value="0">不设置<\/option>':""}
                                  <option value="1">大于</option>
                                  <option value="2">大于等于</option>
                                  <option value="3">小于</option>
                                  <option value="4">小于等于</option>
                              </select>`},f=(n,i)=>{const u=i[`Value${n}`];let r="";return t||(r=`<span class="textOn">${u}</span>`,n!==2||i.Condition2||(r="")),`${r}<input class="form-control text-center textIn zeroNum hidden value${n}" style="min-width:80px" oninput="onInput(this, 4, 4)" value=${u}>`},o=n=>{let i="";if(!t&&n)i=`<span class="textOn">${["","并且","或者"][n]}</span>`;return`${i}<select class="form-control hidden textIn logic" style="min-width:70px">
                                  <option value="0">不设置</option>
                                  <option value="1">并且</option>
                                  <option value="2">或者</option>
                              </select>`},i={dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"选择",render:n=>`<input type="checkbox" class="icb_minimal isEnable" value=${n.Id} dictionary=${n.DictionaryId}>`,orderable:!1},{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"VariableName",title:"名称"},{data:null,title:"出现频率",render:e},{data:"Condition1",title:"条件1",render:u.bind(null,1)},{data:null,title:"数值",render:f.bind(null,1)},{data:"Logic",title:"逻辑",render:o},{data:"Condition2",title:"条件2",render:u.bind(null,2)},{data:null,title:"数值",render:f.bind(null,2)}],drawCallback:function(){const n=this.api();$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"}).on("ifChanged",function(){const t=$(this).parents("tr"),i=t[0];if($(this).is(":checked")){_scriptTrData.push(i);t.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");const r=n.row(i).data();t.find(".frequency").val(r.Frequency);t.find(".interval").val(r.Interval||1);t.find(".count").val(r.Count);t.find(".condition1").val(r.Condition1||1);t.find(".value1").val(r.Value1);t.find(".logic").val(r.Logic);t.find(".condition2").val(r.Condition2);t.find(".value2").val(r.Value2)}else _scriptTrData.splice(_scriptTrData.indexOf(i),1),t.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden")})}};i.data=r[1];$("#npcVarList").DataTable(i);i.data=r[2];$("#npcInsList").DataTable(i);i.data=r[3];$("#npcOutList").DataTable(i)}function addUpDeviceWarning(n){const f=$("#warnName").val().trim();if(isStrEmptyOrUndefined(f)){layer.msg("请选择脚本");return}const h=$("#isStart").is(":checked"),e=$("#deviceType").val();if(isStrEmptyOrUndefined(e)){layer.msg("请选择设备分类");return}const o=$("#scriptSelect").val();if(isStrEmptyOrUndefined(o)){layer.msg("请选择脚本");return}let t=$("#deviceSelect").val();if(isStrEmptyOrUndefined(t)){layer.msg("请选择设备");return}t=t.toString();const c=$("#navUl li.active").val(),i={Type:c,Name:f,Enable:h,ClassId:e,ScriptId:o,DeviceIds:t};let r,u;if(n){const n=$("#deviceWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}i.Id=n;r=1201;u="保存"}else r=1202,u="添加";if(!_scriptTrData.length&&!n){layer.msg("请设置变量/输入/输出，至少一项");return}const s=[],l=$("#navChildUl li.active").val();for(let t=0,i=_scriptTrData.length;t<i;t++){const i=$(_scriptTrData[t]),r=i.find("td:nth-child(2)").text(),u=i.find(".frequency").val(),c=i.find(".interval").val(),f=i.find(".count").val();if(u==0||f==0){layer.msg(`序号${r}：出现频率数值都必须大于0`);return}const a=i.find(".condition1").val(),v=i.find(".value1").val(),e=i.find(".logic").val(),o=i.find(".condition2").val();if(o!=0&&e==0){layer.msg(`序号${r}：两个条件必须选择逻辑`);return}const y=i.find(".value2").val(),h=i.find(".isEnable"),p=h.attr("dictionary"),w=n?h.val():0;s.push({DataType:l,Frequency:u,Interval:c,Count:f,Condition1:a,Value1:v,Logic:e,Condition2:o,Value2:y,DictionaryId:p>>0,Id:w>>0})}i.Items=s;const a=()=>{const t={};t.opType=r;t.opData=JSON.stringify(i);ajaxPost("/Relay/Post",t,t=>{layer.msg(t.errmsg),t.errno==0&&(n?getAppointWarnSet():new Promise(n=>getWarnSet(n)).then(n=>showAppointWarnSet(n[0])))})};showConfirm(u,a)}let _scriptTrData=null;