function pageReady(){$(".ms2").select2();$("#deviceSelect,#productionDeviceSelect").select2({allowClear:!0,placeholder:"请选择",multiple:!0,width:"100%"});const n=new Promise(n=>getWarnSet(n,"#deviceWarn",1)),t=new Promise(n=>getClass(n)),i=new Promise(n=>getScript(n));Promise.all([n,t,i]).then(n=>{n[0].length?showAppointWarnSet(n[0][0]):(getDevice(null,{scriptId:n[2]},"#deviceSelect"),getScriptItem())});$("#deviceSelect,#productionDeviceSelect").on("select2:select",function(){const n=$(this).val();if(~n.indexOf("0")){const t=$(this).find("option"),n=[];for(let i=0,r=t.length;i<r;i++)n.push(t.eq(i).val());n.splice(n.indexOf("0"),1);$(this).val(n).trigger("change")}});$("#npcVarList,#npcInsList,#npcOutList,#productionList,#productionCollectList").on("focus",".zeroNum",function(){$(this).val()==0&&$(this).val("")});$("#npcVarList,#npcInsList,#npcOutList,#productionList,#productionCollectList").on("blur",".zeroNum",function(){isStrEmptyOrUndefined($(this).val())&&$(this).val(0)});$("#deviceWarn").on("select2:select",()=>getDeviceWarnSet());$("#scriptSelect").on("select2:select",function(){getDevice(null,{scriptId:$(this).val()},"#deviceSelect");getScriptItem()});$("#productionLi").one("click",function(){const n=new Promise(n=>getWarnSet(n,"#productionWarn",2)),t=new Promise(n=>getDeviceType(n));Promise.all([n,t]).then(n=>{n[0].length?showProductionWarnSet(n[0][0]):(getDevice(null,{categoryId:n[1]},"#productionDeviceSelect"),getProductionItem())})});$("#productionDeviceType").on("select2:select",function(){getDevice(null,{categoryId:$(this).val()},"#productionDeviceSelect")});$("#productionIsCollect").on("ifChanged",function(){_productionCollectTrData=[];$(this).is(":checked")?($("#collectBox").removeClass("hidden"),setDataTable("#productionCollectList",_productionCollect,!$("#productionWarn").val(),"Item",_productionCollectTrData)):$("#collectBox").addClass("hidden")});$("#productionWarn").on("select2:select",()=>getProductionWarnSet())}function getWarnSet(n,t,i){const r=$("#typeBox li.active").val();ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({first:!0,dataType:i,type:r})},i=>{if(i.errno!=0){layer.msg(i.errmsg);return}const r=i.datas;$(t).empty().append(setOptions(r,"Name"));n(r)})}function getDeviceWarnSet(){_scriptTrData=[];const n=$("#deviceWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}getAppointWarnSet(n,n=>showAppointWarnSet(n))}function getProductionWarnSet(){_productionCollect=[];_productionTrData=[];const n=$("#productionWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}getAppointWarnSet(n,n=>showProductionWarnSet(n))}function getAppointWarnSet(n,t){const i=$("#typeBox li.active").val(),r=$("#navUl li.active").val();ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({qId:n,first:!0,dataType:r,type:i})},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}t(n.datas[0])})}function showAppointWarnSet(n){setThreeTable(n.Items,!1);$("#warnName").val(n.Name);$("#isStart").iCheck(n.Enable?"check":"uncheck");$("#deviceType").val(n.ClassId).trigger("change");$("#scriptSelect").val(n.ScriptId).trigger("change");new Promise(t=>getDevice(t,{scriptId:n.ScriptId},"#deviceSelect")).then(()=>$("#deviceSelect").val(n.DeviceList).trigger("change"))}function showProductionWarnSet(n){setProductionSum(n.Items,!1);$("#productionWarnName").val(n.Name);$("#productionIsStart").iCheck(n.Enable?"check":"uncheck");$("#productionIsCollect").iCheck(n.IsSum?"check":"uncheck").trigger("ifChanged");$("#productionDeviceClass").val(n.ClassId).trigger("change");$("#productionDeviceType").val(n.CategoryId).trigger("change");new Promise(t=>getDevice(t,{categoryId:n.CategoryId},"#productionDeviceSelect")).then(()=>$("#productionDeviceSelect").val(n.DeviceList).trigger("change"))}function deviceRefreshTable(){$("#deviceWarn").val()?getDeviceWarnSet():getScriptItem()}function productionRefreshTable(){$("#productionWarn").val()?getProductionWarnSet():getProductionItem()}function productionSumRefreshTable(){$("#productionIsCollect").trigger("ifChanged")}function getClass(n){ajaxPost("/Relay/Post",{opType:168},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#deviceType,#productionDeviceClass").empty().append(setOptions(t.datas,"Class"));n()})}function getScript(n){ajaxPost("/Relay/Post",{opType:113},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#scriptSelect").empty().append(setOptions(t.datas,"ScriptName"));n(t.datas[0].Id)})}function getDeviceType(n){ajaxPost("/Relay/Post",{opType:140},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#productionDeviceType").empty().append(setOptions(t.datas,"CategoryName"));n(t.datas[0].Id)})}function getDevice(n,t,i){ajaxPost("/Relay/Post",{opType:100,opData:JSON.stringify(t)},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const r=t.datas;let u="";r.length>1&&(u='<option value="0">全部<\/option>');$(i).empty().append(`${u}${setOptions(r,"Code")}`);n&&n()})}function getScriptItem(){const n=$("#scriptSelect").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择脚本");return}getWarnAllItem({sId:n,isNew:!0,dataType:1},n=>setThreeTable(n,!0))}function getProductionItem(){_productionCollect=[];_productionTrData=[];getWarnAllItem({isNew:!0,dataType:2},n=>setProductionSum(n,!0))}function setProductionSum(n,t){_productionCollect=[];_productionTrData=[];const i=[];for(let t=0,r=n.length;t<r;t++){const r=n[t];r.IsSum?_productionCollect.push(r):i.push(r)}setDataTable("#productionList",i,t,"Item",_productionTrData)}function getWarnAllItem(n,t){ajaxPost("/Relay/Post",{opType:1204,opData:JSON.stringify(n)},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}t(n.datas)})}function setDataTable(n,t,i,r,u){const o=n=>{const t=n.Frequency,r=n.Count;let u="";if(!i&&t&&r)u=`<span class="textOn">${t}${["","秒","分","小时","天","周","月","年"][n.Interval]}${r}次</span>`;return`${u}<div class="flexStyle hidden textIn" style="justify-content:center">
                                <input class="form-control text-center zeroNum frequency" style="min-width:80px" oninput="onInput(this, 4, 0)" value=${t}>
                                <select class="form-control interval" style="min-width:70px">
                                    <option value="1">秒</option>
                                    <option value="2">分</option>
                                    <option value="3">小时</option>
                                    <option value="4">天</option>
                                    <option value="5">周</option>
                                    <option value="6">月</option>
                                    <option value="7">年</option>
                                </select>
                                <span class="flexStyle">
                                    <input class="form-control text-center zeroNum count" style="min-width:80px" oninput="onInput(this, 4, 0)" value=${r}>
                                    <label style="margin:0 0 0 3px">次</label>
                                </span>
                            </div>`},f=(n,t)=>{let r="";if(!i&&t)r=`<span class="textOn">${["","大于","大于等于","小于","小于等于"][t]}</span>`;return`${r}<select class="form-control hidden textIn condition${n}" style="min-width:90px">
                                  ${n===2?'<option value="0">不设置<\/option>':""}
                                  <option value="1">大于</option>
                                  <option value="2">大于等于</option>
                                  <option value="3">小于</option>
                                  <option value="4">小于等于</option>
                              </select>`},e=(n,t)=>{const r=t[`Value${n}`],u=!i&&!(n===2&&!t.Condition2||n===1&&!t.Condition1)?`<span class="textOn">${r}</span>`:"";return`${u}<input class="form-control text-center textIn zeroNum hidden value${n}" style="min-width:80px" oninput="onInput(this, 4, 4)" value=${r}>`},s=n=>{let t="";if(!i&&n)t=`<span class="textOn">${["","并且","或者"][n]}</span>`;return`${t}<select class="form-control hidden textIn logic" style="min-width:70px">
                                  <option value="0">不设置</option>
                                  <option value="1">并且</option>
                                  <option value="2">或者</option>
                              </select>`};$(n).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"选择",render:n=>`<input type="checkbox" class="icb_minimal isEnable" value=${n.Id} dictionary=${n.DictionaryId}>`,orderable:!1},{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:r,title:"名称"},{data:null,title:"出现频率",render:o},{data:"Condition1",title:"条件1",render:f.bind(null,1)},{data:null,title:"数值",render:e.bind(null,1)},{data:"Logic",title:"逻辑",render:s},{data:"Condition2",title:"条件2",render:f.bind(null,2)},{data:null,title:"数值",render:e.bind(null,2)}],drawCallback:function(){const n=this.api();$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"}).on("ifChanged",function(){const t=$(this).parents("tr"),i=t[0];if($(this).is(":checked")){u.push(i);t.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");const r=n.row(i).data();t.find(".frequency").val(r.Frequency);t.find(".interval").val(r.Interval||1);t.find(".count").val(r.Count);t.find(".condition1").val(r.Condition1||1);t.find(".value1").val(r.Value1);t.find(".logic").val(r.Logic);t.find(".condition2").val(r.Condition2);t.find(".value2").val(r.Value2)}else u.splice(u.indexOf(i),1),t.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden")})}})}function setThreeTable(n,t){_scriptTrData=[];const i={1:[],2:[],3:[]};for(let t=0,r=n.length;t<r;t++){const r=n[t];i[r.VariableTypeId].push(r)}const r="VariableName";setDataTable("#npcVarList",i[1],t,r,_scriptTrData);setDataTable("#npcInsList",i[2],t,r,_scriptTrData);setDataTable("#npcOutList",i[3],t,r,_scriptTrData)}function addUpWarn(n){const t=$("#navUl li.active").val(),i=[addUpDeviceWarning,addUpProductionWarning];i[t-1](n,t)}function getItems(n){const t=[];for(let i=0,r=n.length;i<r;i++){const r=$(n[i]),u=r.find("td:nth-child(2)").text(),f=r.find(".frequency").val(),h=r.find(".interval").val(),e=r.find(".count").val();if(f==0||e==0)return layer.msg(`序号${u}：出现频率数值都必须大于0`),!1;const c=r.find(".condition1").val(),l=r.find(".value1").val(),o=r.find(".logic").val(),s=r.find(".condition2").val();if(s!=0&&o==0)return layer.msg(`序号${u}：两个条件必须选择逻辑`),!1;const a=r.find(".value2").val();t.push({Frequency:f,Interval:h,Count:e,Condition1:c,Value1:l,Logic:o,Condition2:s,Value2:a})}return t}function currentItemFn(n,t,i,r,u){const f=n.columns(0).nodes()[0];for(let e=0,o=f.length;e<o;e++){const o=$(f[e]),s=o.find(".isEnable");if(!s.is(":checked")&&s.val()!=0){const f=n.row(o.parents("tr")[0]).data(),e={Frequency:f.Frequency,Interval:f.Interval,Count:f.Count,Condition1:f.Condition1,Value1:f.Value1,Logic:f.Logic,Condition2:f.Condition2,Value2:f.Value2,Id:r?f.Id:0};switch(i){case 1:e.DictionaryId=f.DictionaryId;break;case 2:e.Item=f.Item;u&&(e.IsSum=!0)}t.push(e)}}}function addUpDeviceWarning(n,t){const o=$("#warnName").val().trim();if(isStrEmptyOrUndefined(o)){layer.msg("请输入预警名");return}const c=$("#isStart").is(":checked"),s=$("#deviceType").val();if(isStrEmptyOrUndefined(s)){layer.msg("请选择设备分类");return}const h=$("#scriptSelect").val();if(isStrEmptyOrUndefined(h)){layer.msg("请选择脚本");return}let r=$("#deviceSelect").val();if(isStrEmptyOrUndefined(r)){layer.msg("请选择设备");return}r=r.join();const l=$("#typeBox li.active").val(),u={Type:l,DataType:t,Name:o,Enable:c,ClassId:s,ScriptId:h,DeviceIds:r};let f,e;if(n){const n=$("#deviceWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}u.Id=n;f=1201;e="保存"}else f=1202,e="添加";const i=getItems(_scriptTrData);if(i){for(let t=0,r=_scriptTrData.length;t<r;t++){const r=$(_scriptTrData[t]).find(".isEnable"),u=r.attr("dictionary"),f=n?r.val():0;i[t].DictionaryId=u>>0;i[t].Id=f>>0}currentItemFn($("#npcVarList").DataTable(),i,1,n);currentItemFn($("#npcInsList").DataTable(),i,1,n);currentItemFn($("#npcOutList").DataTable(),i,1,n);i.length&&(u.Items=i);const a=()=>{const t={};t.opType=f;t.opData=JSON.stringify(u);ajaxPost("/Relay/Post",t,t=>{layer.msg(t.errmsg),t.errno==0&&new Promise(n=>getWarnSet(n,"#deviceWarn",1)).then(t=>{n?($("#deviceWarn").val(u.Id).trigger("change"),getDeviceWarnSet()):showAppointWarnSet(t[0])})})};showConfirm(e,a)}}function addUpProductionWarning(n,t){const s=$("#productionWarnName").val().trim();if(isStrEmptyOrUndefined(s)){layer.msg("请输入预警名");return}const y=$("#productionIsStart").is(":checked"),h=$("#productionDeviceClass").val();if(isStrEmptyOrUndefined(h)){layer.msg("请选择设备分类");return}const c=$("#productionDeviceType").val();if(isStrEmptyOrUndefined(c)){layer.msg("请选择设备类型");return}let r=$("#productionDeviceSelect").val();if(isStrEmptyOrUndefined(r)){layer.msg("请选择设备");return}r=r.join();const p=$("#typeBox li.active").val(),l=$("#productionIsCollect").is(":checked"),u={Type:p,DataType:t,Name:s,Enable:y,ClassId:h,CategoryId:c,DeviceIds:r,IsSum:l};let e,o;if(n){const n=$("#productionWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}u.Id=n;e=1201;o="保存"}else e=1202,o="添加";const a=(t,i,r)=>{for(let u=0,f=t.length;u<f;u++){const f=$(t[u]),e=f.find("td:nth-child(3)").text(),o=n?f.find(".isEnable").val():0;i[u].Item=e;i[u].Id=o>>0;r&&(i[u].IsSum=!0)}},f=getItems(_productionTrData);if(f){a(_productionTrData,f,!1);currentItemFn($("#productionList").DataTable(),f,2,n,!1);let i=[];if(l){if(i=getItems(_productionCollectTrData),!i)return;a(_productionCollectTrData,i,!0);currentItemFn($("#productionCollectList").DataTable(),i,2,n,!0)}const v=f.concat(i);v.length&&(u.Items=v);const w=()=>{const t={};t.opType=e;t.opData=JSON.stringify(u);ajaxPost("/Relay/Post",t,t=>{layer.msg(t.errmsg),t.errno==0&&new Promise(n=>getWarnSet(n,"#productionWarn",2)).then(t=>{n?($("#productionWarn").val(u.Id).trigger("change"),getProductionWarnSet()):showProductionWarnSet(t[0])})})};showConfirm(o,w)}}let _productionCollectTrData=null;let _productionCollect=null,_productionTrData=null;let _scriptTrData=null;