function pageReady(){$(".sidebar-mini").addClass("sidebar-collapse");$(".ms2").select2();$("#deviceSelect,#productionDeviceSelect").select2({allowClear:!0,placeholder:"请选择",multiple:!0,width:"100%"});const n=new Promise(n=>getWarnSet(n,"#deviceWarn",1)),t=new Promise(n=>getClass(n)),i=new Promise(n=>getScript(n));Promise.all([n,t,i]).then(n=>{n[0].length?showAppointWarnSet(n[0][0]):(getDevice(null,{scriptId:n[2]},"#deviceSelect"),getScriptItem())});$("#deviceSelect,#productionDeviceSelect").on("select2:select",function(){const n=$(this).val();if(~n.indexOf("0")){const t=$(this).find("option"),n=[];for(let i=0,r=t.length;i<r;i++)n.push(t.eq(i).val());n.splice(n.indexOf("0"),1);$(this).val(n).trigger("change")}});$("#deviceWarn").on("select2:select",()=>getDeviceWarnSet());$("#scriptSelect").on("select2:select",function(){getDevice(null,{scriptId:$(this).val()},"#deviceSelect");getScriptItem()});$("#productionLi").one("click",function(){const n=new Promise(n=>getWarnSet(n,"#productionWarn",2)),t=new Promise(n=>getDeviceType(n));Promise.all([n,t]).then(n=>{n[0].length?showProductionWarnSet(n[0][0]):(getDevice(null,{categoryId:n[1]},"#productionDeviceSelect"),getProductionItem())})});$("#productionDeviceType").on("select2:select",function(){getDevice(null,{categoryId:$(this).val()},"#productionDeviceSelect")});$("#productionWarn").on("select2:select",()=>getProductionWarnSet());$("#devBox .dTable").on("change",".interval",function(){var n=$(this).val();$(this).siblings().removeClass("hidden");n==1&&$(this).siblings().addClass("hidden")})}function getWarnSet(n,t,i){const r=$("#typeBox li.active").val();ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({first:!0,dataType:i,type:r})},i=>{if(i.errno!=0){layer.msg(i.errmsg);return}const r=i.datas;$(t).empty().append(setOptions(r,"Name"));n(r)})}function getDeviceWarnSet(){_trData[device]=[];const n=$("#deviceWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}getAppointWarnSet(n,n=>showAppointWarnSet(n))}function getProductionWarnSet(){const n=$("#productionWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}getAppointWarnSet(n,n=>showProductionWarnSet(n))}function getAppointWarnSet(n,t){const i=$("#typeBox li.active").val(),r=$("#navUl li.active").val();ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({qId:n,first:!0,dataType:r,type:i})},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}t(n.datas[0])})}function showAppointWarnSet(n){setThreeTable(n.Items,!1);$("#warnName").val(n.Name);$("#isStart").iCheck(n.Enable?"check":"uncheck");$("#deviceType").val(n.ClassId).trigger("change");$("#scriptSelect").val(n.ScriptId).trigger("change");new Promise(t=>getDevice(t,{scriptId:n.ScriptId},"#deviceSelect")).then(()=>$("#deviceSelect").val(n.DeviceList).trigger("change"))}function showProductionWarnSet(n){setProduction(n.Items,!1);$("#productionWarnName").val(n.Name);$("#productionIsStart").iCheck(n.Enable?"check":"uncheck");$("#productionDeviceClass").val(n.ClassId).trigger("change");$("#productionDeviceType").val(n.CategoryId).trigger("change");new Promise(t=>getDevice(t,{categoryId:n.CategoryId},"#productionDeviceSelect")).then(()=>$("#productionDeviceSelect").val(n.DeviceList).trigger("change"))}function deviceRefreshTable(){$("#deviceWarn").val()&&$("#deviceWarn :selected").text()==$("#warnName").val().trim()?getDeviceWarnSet():getScriptItem()}function productionRefreshTable(){$("#productionWarn").val()&&$("#productionWarn :selected").text()==$("#productionWarnName").val().trim()?getProductionWarnSet():getProductionItem()}function productionSumRefreshTable(){$("#productionIsCollect").trigger("ifChanged")}function getClass(n){ajaxPost("/Relay/Post",{opType:168,opData:JSON.stringify({menu:!0})},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#deviceType,#productionDeviceClass").empty().append(setOptions(t.datas,"Class"));n()},0)}function getScript(n){ajaxPost("/Relay/Post",{opType:113,opData:JSON.stringify({menu:!0})},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#scriptSelect").empty().append(setOptions(t.datas,"ScriptName"));n(t.datas[0].Id)},0)}function getDeviceType(n){ajaxPost("/Relay/Post",{opType:140,opData:JSON.stringify({menu:!0})},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#productionDeviceType").empty().append(setOptions(t.datas,"CategoryName"));n(t.datas[0].Id)},0)}function getDevice(n,t,i){ajaxPost("/Relay/Post",{opType:100,opData:JSON.stringify(t)},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const r=t.datas;$(i).html(setOptions(r,"Code"));n&&n()},0)}function getWarnAllItem(n,t){ajaxPost("/Relay/Post",{opType:1204,opData:JSON.stringify(n)},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}t(n.datas)},0)}function getScriptItem(){const n=$("#scriptSelect").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择脚本");return}getWarnAllItem({sId:n,isNew:!0,dataType:1},n=>setThreeTable(n,!0))}function setThreeTable(n){_choseData[device]=[];_trData[device]=[];_dataTable[device]=[];const i={1:[],2:[],3:[]},r={1:"npcVarList",2:"npcInsList",3:"npcOutList"};for(var t in i)i[t]=n.filter(n=>n.VariableTypeId==t),setDataTable(device,r[t],i[t],_trData[device])}function getProductionItem(){getWarnAllItem({isNew:!0,dataType:2},n=>setProduction(n,!0))}function setProduction(n){_choseData[production]=[];_trData[production]=[];_dataTable[production]=[];setDataTable(production,"productionList",n,_trData[production])}function setDataTable(n,t,i,r){let u="";n==device?u="DictionaryId":n==production&&(u="ItemType");const f=t;if(t=`#${t}`,_dataTable[n][f])updateTable(_dataTable[n][f],i);else{const h=n=>{const t=n.Frequency,i=n.Count;return`<span class="textOn"></span>
                    <div class="flexStyle hidden textIn" style="justify-content:center">
                        <input class="form-control text-center no-padding zeroNum frequency" style="min-width:50px;width:50px" oninput="onInput(this, 5, 0)" value=${t}>
                        <select class="form-control interval" style="min-width:70px">
                            ${["不设置","每次","秒","分","小时","天","周","月","年"].reduce((n,t,i)=>n+(i!=0?`<option value="${i}">${t}</option>`:``),"")}
                        </select>
                        <span class="flexStyle">
                            <input class="form-control text-center no-padding zeroNum count" style="min-width:50px;width:50px;" oninput="onInput(this, 4, 0)" value=${i}>
                            <label style="margin:0 0 0 3px">次</label>
                        </span>
                    </div>`},o=n=>{return`<span class="textOn"></span>
                    <select class="form-control hidden textIn condition${n}" style="min-width:80px;">
                        ${["不设置","大于","大于等于","小于","小于等于"].reduce((t,i,r)=>t+(n==1&&r==0?``:`<option value="${r}">${i}</option>`),"")}
                    </select>`},s=(n,t)=>{const i=t[`Value${n}`];return`<span class="textOn"></span>
                    <input class="form-control text-center textIn zeroNum hidden value${n}" style="min-width:60px;" oninput="onInput(this, 6, 4)" value=${i}>`},c=()=>{return`<span class="textOn"></span>
                    <select class="form-control hidden textIn logic" style="min-width:70px">
                        ${["不设置","并且","或者"].reduce((n,t,i)=>`${n}<option value="${i}">${t}</option>`,"")}
                    </select>`},e=dataTableConfig(i,!0);e.addColumns([{data:"Item",title:"名称"},{data:null,title:"出现频率",render:h},{data:"Condition1",title:"条件1",render:o.bind(null,1)},{data:null,title:"数值",render:s.bind(null,1)},{data:"Logic",title:"逻辑",render:c},{data:"Condition2",title:"条件2",render:o.bind(null,2)},{data:null,title:"数值",render:s.bind(null,2)}]);e.drawCallback=function(){initCheckboxAddEvent.call(this,r,(t,i)=>{t.find(".frequency").val(i.Frequency);var r=i.Interval||1;t.find(".interval").val(r);t.find(".count").val(i.Count);t.find(".condition1").val(i.Condition1||1);t.find(".value1").val(i.Value1);t.find(".logic").val(i.Logic);t.find(".condition2").val(i.Condition2);t.find(".value2").val(i.Value2);r==1?t.find(".interval").siblings().addClass("hidden"):t.siblings().removeClass("hidden");_choseData[n].push(i)},(t,i)=>{removeArray(_choseData[n],u,i[u])},!1,"Checked");initInputChangeEvent.call(this,(t,i)=>{const r=$(t).find(".frequency").val()>>0,f=$(t).find(".interval").val()>>0,e=$(t).find(".count").val()>>0,o=$(t).find(".condition1").val()>>0,s=$(t).find(".value1").val(),h=$(t).find(".logic").val()>>0,c=$(t).find(".condition2").val()>>0,l=$(t).find(".value2").val();_choseData[n].length>0&&_choseData[n].every(n=>n[u]==i[u]?(n.Frequency=r,n.Interval=f,n.Count=e,n.Condition1=o,n.Value1=s,n.Logic=h,n.Condition2=c,n.Value2=l,n.Id=i.Id,!1):!0)})};e.createdRow=function(t,i){const r=i.Id>0;r&&_choseData[n].push(i);$(t).find(".isEnable").iCheck(r?"check":"uncheck");r&&$(t).find(".textOn").text("").addClass("hidden").siblings(".textIn").removeClass("hidden");r&&$(t).find(".frequency").val(i.Frequency);r&&$(t).find(".interval").val(i.Interval||1);r&&$(t).find(".count").val(i.Count);r&&$(t).find(".condition1").val(i.Condition1||1);r&&$(t).find(".value1").val(i.Value1);r&&$(t).find(".logic").val(i.Logic);r&&$(t).find(".condition2").val(i.Condition2);r&&$(t).find(".value2").val(i.Value2);$(this).siblings().removeClass("hidden");i.Interval==1&&$(t).find(".interval").siblings().addClass("hidden")};_dataTable[n][f]=$(t).DataTable(e)}}function addUpWarn(n){const t=$("#navUl li.active").val(),i=[addUpDeviceWarning,addUpProductionWarning];i[t-1](n,t)}function getItemFn(n,t,i){for(let r=0,u=n.length;r<u;r++){const u=n[r],e=u.XvHao,c=u.Frequency,l=u.Interval,a=u.Count;if(l!=1&&(c==0||a==0))return layer.msg(`序号${e}：出现频率次数都必须大于0`),!1;const o=u.Condition1,s=u.Logic,h=u.Condition2;if(s==0&&o!=0&&h!=0)return layer.msg(`序号${e}：两个条件时必须选择逻辑`),!1;if(s!=0&&(o==0||h==0))return layer.msg(`序号${e}：选择逻辑时必须有两个条件`),!1;const f={Id:u.Id,Frequency:u.Frequency,Interval:u.Interval,Count:u.Count,Condition1:u.Condition1,Value1:u.Value1,Logic:u.Logic,Condition2:u.Condition2,Value2:u.Value2};switch(i){case device:f.DictionaryId=u.DictionaryId;break;case production:f.Item=u.Item;f.ItemType=u.ItemType}t.push(f)}return!0}function addUpDeviceWarning(n,t){const e=$("#warnName").val().trim();if(isStrEmptyOrUndefined(e)){layer.msg("请输入预警名");return}const c=$("#isStart").is(":checked"),o=$("#deviceType").val();if(isStrEmptyOrUndefined(o)){layer.msg("请选择设备分类");return}const s=$("#scriptSelect").val();if(isStrEmptyOrUndefined(s)){layer.msg("请选择脚本");return}let i=$("#deviceSelect").val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择设备");return}i=i.join();const l=$("#typeBox li.active").val(),r={WarningType:l,DataType:t,Name:e,Enable:c,ClassId:o,ScriptId:s,DeviceIds:i};let u,f;if(n){const n=$("#deviceWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}r.Id=n;u=1201;f="保存"}else u=1202,f="添加";if(_choseData[device].length){const h=[];if(getItemFn(_choseData[device],h,device)){r.Items=h;const a=()=>{const t={};t.opType=u;t.opData=JSON.stringify(r);ajaxPost("/Relay/Post",t,t=>{layer.msg(t.errmsg),t.errno==0&&new Promise(n=>getWarnSet(n,"#deviceWarn",1)).then(t=>{n?($("#deviceWarn").val(r.Id).trigger("change"),getDeviceWarnSet()):showAppointWarnSet(t[0])})})};showConfirm(f,a)}}}function addUpProductionWarning(n,t){const o=$("#productionWarnName").val().trim();if(isStrEmptyOrUndefined(o)){layer.msg("请输入预警名");return}const s=$("#productionDeviceClass").val(),c=$("#productionIsStart").is(":checked");if(isStrEmptyOrUndefined(s)){layer.msg("请选择设备分类");return}const h=$("#productionDeviceType").val();if(isStrEmptyOrUndefined(h)){layer.msg("请选择设备类型");return}let i=$("#productionDeviceSelect").val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择设备");return}i=i.join();const l=$("#typeBox li.active").val(),r={WarningType:l,DataType:t,Name:o,Enable:c,ClassId:s,CategoryId:h,DeviceIds:i};let u,f;if(n){const n=$("#productionWarn").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择预警名");return}r.Id=n;u=1201;f="保存"}else u=1202,f="添加";if(_choseData[production].length){const e=[];if(getItemFn(_choseData[production],e,production)){e.length&&(r.Items=e);const a=()=>{const t={};t.opType=u;t.opData=JSON.stringify(r);ajaxPost("/Relay/Post",t,t=>{layer.msg(t.errmsg),t.errno==0&&new Promise(n=>getWarnSet(n,"#productionWarn",2)).then(t=>{n?($("#productionWarn").val(r.Id).trigger("change"),getProductionWarnSet()):showProductionWarnSet(t[0])})})};showConfirm(f,a)}}}const device=1,production=2;let _choseData=[],_dataTable=[],_trData=[];