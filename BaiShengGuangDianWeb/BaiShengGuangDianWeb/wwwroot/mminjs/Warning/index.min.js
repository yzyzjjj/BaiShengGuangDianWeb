function pageReady(){_permissionList[803]={uIds:["deviceWarnDeal"]};_permissionList=checkPermissionUi(_permissionList);$(".sidebar-mini").addClass("sidebar-collapse");$(".ms2").select2();$(".deviceSelect").select2({allowClear:!0,placeholder:"请选择",multiple:!0,width:"90%"}).on("select2:select",function(){var n=$(this).val();~n.indexOf("0")?n=[0]:n.length>1&&removeArray(n,"0",0);$(this).val(n).trigger("change")});$(".form_date").val(getDate()).datepicker("update");const n=new Promise(n=>getWarnSet(n,1,".device-warn")),t=new Promise(n=>getWarnSet(n,2,".production-warn"));Promise.all([n,t]).then(()=>{});$("#deviceSTime,#deviceETime").on("changeDate",()=>getDeviceData(!1));$("#deviceWarn").on("select2:select",()=>getDeviceData(!1));$("#deviceWarnCurrent").on("select2:select",()=>getDeviceData(!0));$("#productionSTime,#productionETime").on("changeDate",()=>getProductionData(!1));$("#productionWarn").on("select2:select",()=>getProductionData(!1));$("#productionWarnCurrent").on("select2:select",()=>getProductionData(!0))}function getDeviceData(n){n||(top=!0);n?getCurrentWarnLogList("device",1):getWarnLogList("device",1)}function getProductionData(n){n?getCurrentWarnLogList("production",2):getWarnLogList("production",2)}function getDealLog(n){const r=$(`#${n}WarnLog`).val();if(isStrEmptyOrUndefined(r)){layer.msg("请选择预警名");return}let t=$(`#${n}STimeLog`).val().trim();if(isStrEmptyOrUndefined(t)){layer.msg("请选择开始时间");return}let i=$(`#${n}ETimeLog`).val().trim();if(isStrEmptyOrUndefined(i)){layer.msg("请选择结束时间");return}if(compareDate(t,i)){layer.msg("开始时间不能大于结束时间");return}t+=" 00:00:00";i+=" 23:59:59";var u={sId:r,startTime:t,endTime:i,type:1,dataType};if($(`.${n}SelectLog`).length>0){const t=$(`.${n}SelectLog`).val();u.deviceIds=!t||t.length==1&&!!~t.indexOf("0")?"":t.join()}const f={opType:1208,opData:JSON.stringify(u)};ajaxPost("/Relay/Post",f,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}var r=t.datas,i=`${n}ListLog`;if(dataTables[i])updateTable(dataTables[i],r);else{const t=n=>{var t=n.DeviceList.join();return t==""||t.length<tdShowLength?t:`<span title = "${t}" class="pointer" onclick="showAllContent('${escape(t)}', '设备列表')">${t.substring(0,tdShowLength)+"..."}</span>`},n=dataTableConfig(r);n.addColumns([{data:"SetName",title:"预警名"},{data:"Name",title:"解决人"},{data:"DealTime",title:"解决时间",sClass:"text-danger"},{data:null,title:"设备列表",render:t},]);dataTables[i]=$(`#${i}`).DataTable(n)}})}function getWarnSet(n,t,i){ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({type:1,dataType:t})},t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$(i).empty().append(`<option value="0">全部</option>${setOptions(t.datas,"Name")}`);n()})}function getAppointWarnSet(n,t,i,r){ajaxPost("/Relay/Post",{opType:1200,opData:JSON.stringify({type:1,dataType:t,qId:n})},n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$(`.${i}Info${r}`).removeClass("hidden");const u=n.datas[0];if($(`#${i}WarnType${r}`).text(u.Class),t===1){if($(`#${i}WarnScript${r}`).text(u.Script),!r){let n=$(`.${i}Select`).val();top?(top=!1,n=[0]):n||(n=[0]);$(`.${i}Select`).html(u.CodeList?u.CodeList.reduce((n,t)=>`${n}<option value="${t.Item1}">${t.Item2}</option>`,'<option value="0">全部<\/option>'):"").val(n)}}else t===2&&$(`#${i}WarnCategory${r}`).text(u.CategoryName);$(`#${i}WarnDevice${r}`).text(u.CodeList?u.CodeList.map(n=>n.Item2).join():"")})}function getWarnLogList(n,t){const i=$(`#${n}Warn`).val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择预警名");return}let r=$(`#${n}STime`).val().trim();if(isStrEmptyOrUndefined(r)){layer.msg("请选择开始时间");return}let u=$(`#${n}ETime`).val().trim();if(isStrEmptyOrUndefined(u)){layer.msg("请选择结束时间");return}if(compareDate(r,u)){layer.msg("开始时间不能大于结束时间");return}r+=" 00:00:00";u+=" 23:59:59";const f={opType:1206,opData:JSON.stringify({sId:i,startTime:r,endTime:u,type:1,dataType:t})};ajaxPost("/Relay/Post",f,r=>{if(r.errno!=0){layer.msg(r.errmsg);return}i==0?$(`.${n}Info`).addClass("hidden"):getAppointWarnSet(i,t,n,"");setWarnLogList(`#${n}List`,r.datas,!1)})}function getCurrentWarnLogList(n,t){const i=$(`#${n}WarnCurrent`).val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择预警名");return}const r={opType:1205,opData:JSON.stringify({sId:i,type:1,dataType:t})};ajaxPost("/Relay/Post",r,r=>{if(r.errno!=0){layer.msg(r.errmsg);return}i==0?$(`#${n}InfoCurrent`).addClass("hidden"):getAppointWarnSet(i,t,n,"Current");setWarnLogList(`#${n}ListCurrent`,r.datas,!0)})}function setWarnLogList(n,t,i){if(dataTables[n])updateTable(dataTables[n],t);else{const e=n=>n?"是":"否",o=n=>n==1?'<span class="text-black">是<\/span>':"否",s=n=>convertTime0(n.StartTime)==""&&convertTime0(n.EndTime)==""?"":`${n.StartTime}至${n.EndTime}`,h=n=>{const t=["","每次","连续","秒","分","小时","天","周","月","年","连续"];return n.Interval==1?`<span>${t[n.Interval]}</span>`:n.Interval==2?`<span>${t[n.Interval]}${n.Count}次</span>`:`<span>${n.Frequency}${t[n.Interval]}${n.Count}次</span>`},r=n=>{return`<span>${["","大于","大于等于","小于","小于等于"][n]}</span>`},c=n=>{return`<span>${["","并且","或者"][n]}</span>`},l=n=>n.Condition2?n.Value2:"",a=n=>`<button class="btn btn-info btn-sm" onclick='showDetailModel(${n})'>查看</button>`,u=[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"SetName",title:"预警名"},{data:"Item",title:"预警项"},{data:"Code",title:"机台号"}],v=[{data:"IsWarning",title:"是否预警",render:e},{data:"IsDeal",title:"是否解决",sClass:"text-danger",render:o},{data:"WarningTime",title:"预警时间",sClass:"text-danger"}],y=[{data:"CurrentTime",title:"当前时间",sClass:"text-danger",render:n=>convertTime0(n)}],f=[{data:"Current",title:"出现次数",sClass:"text-danger"},{data:null,title:"时间段",sClass:"text-danger",render:s},{data:null,title:"出现频率",render:h},{data:"Condition1",title:"条件1",render:r},{data:"Value1",title:"数值"},{data:"Logic",title:"逻辑",render:c},{data:"Condition2",title:"条件2",render:r},{data:null,title:"数值",render:l},{data:"Values",title:"详情",render:a}],p=i?[...u,...y,...f]:[...u,...v,...f];dataTables[n]=$(n).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,deferRender:!0,data:t,language:oLanguage,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:p})}}function showDetailModel(n){$("#warnLogDetailList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,data:n,language:oLanguage,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"DT",title:"时间"},{data:"V",title:"数值"}]});$("#showDetailModel").modal("show")}function dealWarning(n){if($(`.${n}Select`).length>0){const i=$(`#${n}Warn`).val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择预警名");return}const t=$(`.${n}Select`).val();if(!t.length){layer.msg("请选择设备");return}const r={opType:1207,opData:JSON.stringify({SetId:i,DeviceIds:t.length==1&&!!~t.indexOf("0")?"":t.join()})};ajaxPost("/Relay/Post",r,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}getDeviceData(!1)})}}var _permissionList=[],top;const dataTables=[];top=!1;