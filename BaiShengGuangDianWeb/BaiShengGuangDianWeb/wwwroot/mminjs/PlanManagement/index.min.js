function pageReady(){$(".ms2").select2();getPlanList(!1);$("#addPlanTableBtn").on("click",function(){$(this).addClass("hidden");_planTrCount++;$("#addPlanBody").append(_planTr);setTableTrCount($("#addPlanBody"),_planTrCount);setDefaultCode($("#addPlanBody tr"));$("#addPlanTable").removeClass("hidden")});$("#addPlanBody").on("click",".addPlanTr",function(){var n,t;_planTrCount++;n=$(this).parents("tr");n.after(_planTr);t=n.next();setTableTrCount($("#addPlanBody"),_planTrCount);setDefaultCode(t)});$("#addPlanBody").on("click",".delPlanTr",function(){_planTrCount--;var n=$(this).parents("tr");n.remove();_planTrCount?(setTableTrCount($("#addPlanBody"),_planTrCount),getPriceSum()):($("#addPlanTableBtn").removeClass("hidden"),$("#addPlanTable").addClass("hidden"),$("#planCost").text("0.00"))});$("#addPlanBody").on("select2:select",".code select",function(){var n=$(this).parents("tr");setTableSelect(n)});$("#addPlanBody").on("select2:select",".category select",function(){var n=$(this).parents("tr");setTrSelect(n,1)});$("#addPlanBody").on("select2:select",".name select",function(){var n=$(this).parents("tr");setTrSelect(n,2)});$("#addPlanBody").on("select2:select",".supplier select",function(){var n=$(this).parents("tr");setTrSelect(n,3)});$("#addPlanBody").on("select2:select",".specification select",function(){var n=$(this).parents("tr");setTrSelect(n,4)});$("#addPlanBody").on("select2:select",".site select",function(){var n=$(this).parents("tr");setTrSelect(n,5)});$("#reuse").on("click",function(){var n=$("#addPlanSelect").val(),t,i;if(isStrEmptyOrUndefined(n)){layer.msg("请选择要复用的计划号");return}t=$("#addPlanSelect").find(`[value=${n}]`).text();i=function(){$("#addPlanBody").empty();addUpPlanTable(n,!1)};showConfirm(`复用生产计划：${t}`,i)});$("#addPlanBody").on("ifChanged",".isEnable",function(){var n=$(this).parents("tr"),i,t,r,u,f;$(this).is(":checked")?(i=n.find(".code"),i.children().length==1&&(t='<div class="textOn" style="width:140px;margin:auto"><select class="ms2 form-control">{0}<\/select><\/div>',r='<input type="text" class="form-control text-center textOn" value={0} onkeyup="onInput(this, 8, 1)" onblur="onInputEnd(this)" maxlength="10" style="width:140px;margin:auto">',i.append(t.format(_codeOp)),n.find(".category").append(t.format(_categoryOp)),n.find(".name").append(t.format(_nameOp)),n.find(".supplier").append(t.format(_supplierOp)),n.find(".specification").append(t.format(_specificationOp)),n.find(".site").append(t.format(_siteOp)),u=n.find(".plannedConsumption span").text(),n.find(".plannedConsumption").append(r.format(u)),$(" #addPlanBody .ms2").select2(),setDefaultCode(n),f=n.find(".num").attr("bill"),i.find("select").val(f).trigger("change").trigger("select2:select")),n.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden")):n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");getPriceSum()});$("#addPlanBody").on("focusin",".plannedConsumption input",function(){var n=$(this).val();n==0&&$(this).val("")});$("#addPlanBody").on("focusout",".plannedConsumption input",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#addPlanBody").on("input",".plannedConsumption input",function(){getPriceSum()});$("#PlanDetailSelect").on("select2:select",function(){var n=$(this).val();planDetailModalData(n)});$("#addPlanBody").on("click",".pdModal",function(){var n=$(this).parents("tr"),i=n.find(".category option:selected").text(),r=n.find(".name option:selected").text(),u=n.find(".supplier option:selected").text(),f=n.find(".specification option:selected").text(),e=n.find(".site option:selected").text(),t=n.find(".code option:selected"),o=t.text(),s=t.attr("stock"),h=n.find(".price").text(),c=t.attr("remark"),l=t.attr("img");productDetailModal(escape(i),escape(r),u,f,e,o,s,h,c,l)});$("#updatePlanSelect").on("select2:select",function(){var n=$(this).val();addUpPlanTable(n,!0)});$("#logPlanSelect,#logBillSelect").on("select2:select",function(){getLogList()});$("#logStartDate").val(getDate());$("#logEndDate").val(getDate());$("#logStartDate,#logEndDate").datepicker("update").on("changeDate",function(){getLogList()})}function setDefaultCode(n){n.find(".category select").val(_firstCode.CategoryId).trigger("change");n.find(".name select").val(_firstCode.NameId).trigger("change");n.find(".supplier select").val(_firstCode.SupplierId).trigger("change");n.find(".specification select").val(_firstCode.SpecificationId).trigger("change");n.find(".site select").val(_firstCode.SiteId).trigger("change")}function setTableStyle(){$("#addPlanBody").find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"})}function addUpPlanTable(n,t){new Promise(function(t){getPlanList(!0,t,n,!0)}).then(function(n){var f=n[0],e,u,o,h,s,i,r;if($("#addPlan").val(f.Plan),$("#addRemark").val(f.Remark),e=f.FirstBill,o=e.length,_planTrCount=0,o){for($("#addPlanTableBtn").addClass("hidden"),$("#addPlanTable").removeClass("hidden"),h='<tr style="color:{12}"><td><input type="checkbox" class="icb_minimal isEnable {14}"><\/td><td class="num" style="font-weight:bold" list={15} bill={16}><\/td><td class="code"><span class="textIn">{5}<\/span><\/td><td class="category"><span class="textIn">{0}<\/span><\/td><td class="name"><span class="textIn">{1}<\/span><\/td><td class="supplier"><span class="textIn">{2}<\/span><\/td><td class="specification"><span class="textIn">{3}<\/span><\/td><td class="site"><span class="textIn">{4}<\/span><\/td><td><button type="button" class="btn btn-info btn-sm" onclick="productDetailModal(\'{0}\',\'{1}\',\'{2}\',\'{3}\',\'{4}\',\'{5}\',{6},\'{7}\',\'{8}\',\'{9}\')">详情<\/button><\/td><td class="price">{7}<\/td><td class="plannedConsumption"><span class="textIn">{10}<\/span><\/td><td class="actualConsumption">{11}<\/td><td><button type="button" class="btn btn-danger btn-sm delPlanTr {13}"><i class="fa fa-minus"><\/i><\/button><button type="button" class="btn btn-success btn-sm addPlanTr {14}" style="margin-left:5px"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>',s="",u=0;u<o;u++)i=e[u],_planTrCount++,r=!!_codeData[i.BillId],(r||t)&&(s+=h.format(i.Category,i.Name,i.Supplier,i.Specification,i.Site,i.Code,i.Stock,i.Price,i.Remark,i.ImageList,t?i.PlannedConsumption:i.ActualConsumption,i.ActualConsumption,r?"black":"red",r&&t&&i.ActualConsumption!=0?"hidden":"",r?"":"hidden",i.Id,i.BillId));$("#addPlanBody").append(s);setTableStyle();getPriceSum();setTableTrCount($("#addPlanBody"),_planTrCount,t)}$("#addPlanTableBtn").attr("disabled",!1)})}function setTableTrCount(n,t,i){for(var r=0;r<t;r++)n.find(".num").eq(r).text(r+1);$(" #addPlanBody .ms2").select2();i=$("#addPlanSelect").is(":hidden");i?$(" #addPlanTable .actualConsumption").removeClass("hidden"):$(" #addPlanTable .actualConsumption").addClass("hidden")}function setTableSelect(n){var g=n.find(".code select").val(),f=_codeData[g],y=f.CategoryId,p=f.NameId,w=f.SupplierId,b=f.SpecificationId,nt=f.SiteId,tt=f.Price,o=n.find(".name select"),s=n.find(".supplier select"),h=n.find(".specification select"),c=n.find(".site select"),l,a,v,d;n.find(".category select").val(y).trigger("change");for(var k=_nameData[y],r,u=k.length,e='<option value = "{0}">{1}<\/option>',i="",t=0;t<u;t++)r=k[t],i+=e.format(r.Id,r.Name);for(o.empty(),o.append(i),o.val(p).trigger("change"),i="",l=_supplierData[p],u=l.length,t=0;t<u;t++)r=l[t],i+=e.format(r.Id,r.Supplier);for(s.empty(),s.append(i),s.val(w).trigger("change"),i="",a=_specificationData[w],u=a.length,t=0;t<u;t++)r=a[t],i+=e.format(r.Id,r.Specification);for(h.empty(),h.append(i),h.val(b).trigger("change"),i="",u=_siteData.length,t=0;t<u;t++)v=_siteData[t].Id,d=_siteData[t].Site,_cond[`${b}${v}`]&&(i+=e.format(v,d));c.empty();c.append(i);c.val(nt).trigger("change");n.find(".price").text(tt);setTableTrCount($("#addPlanBody"),_planTrCount);getPriceSum()}function setTrSelect(n,t){var i,u,f,e='<option value = "{0}">{1}<\/option>',r,s=n.find(".name select"),p=n.find(".supplier select"),o=n.find(".specification select"),h=n.find(".site select"),w,c,b,l,k,a,d,v,g,tt;if(t===1){for(r="",w=n.find(".category select").val(),c=_nameData[w],f=c.length,i=0;i<f;i++)u=c[i],r+=e.format(u.Id,u.Name);s.empty();s.append(r)}if(t===1||t===2){for(r="",b=s.val(),l=_supplierData[b],f=l.length,i=0;i<f;i++)u=l[i],r+=e.format(u.Id,u.Supplier);p.empty();p.append(r)}if(t===1||t===2||t===3){for(r="",k=n.find(".supplier select").val(),a=_specificationData[k],f=a.length,i=0;i<f;i++)u=a[i],r+=e.format(u.Id,u.Specification);o.empty();o.append(r)}if(t===1||t===2||t===3||t===4){for(r="",d=o.val(),h.empty(),f=_siteData.length,i=0;i<f;i++)v=_siteData[i].Id,g=_siteData[i].Site,_cond[`${d}${v}`]&&(r+=e.format(v,g));h.append(r)}if(t===1||t===2||t===3||t===4||t===5){var it=o.val(),rt=h.val(),ut=`${it}${rt}`,nt=n.find(".code select"),y=nt.find(`[cond=${ut}]`).val();nt.val(y).trigger("change");isStrEmptyOrUndefined(y)?n.find(".price").text(""):(tt=_codeData[y].Price,n.find(".price").text(tt));getPriceSum()}}function getPriceSum(){for(var u=$("#addPlanBody").find("tr"),r=0,e=u.length,f=0,n,t,i;r<e;r++)n=u.eq(r),t=n.find(".price").text(),isStrEmptyOrUndefined(t)&&(t=0),i=n.find(".textIn").is(":hidden")?n.find(".plannedConsumption input").val():n.find(".plannedConsumption span").text(),isStrEmptyOrUndefined(i)&&(i=0),f+=parseInt(t)*parseInt(i);$("#planCost").text(f.toFixed(2))}function getPlanList(n,t,i,r){var f=700,u;if(!checkPermission(f)){layer.msg("没有权限");return}u={};u.opType=f;n&&(u.opData=JSON.stringify({qId:i,first:!0,simple:r}));ajaxPost("/Relay/Post",u,function(i){var r,f;if(i.errno!=0){layer.msg(i.errmsg);return}if(r=i.datas,n)t(r);else{for(var o=r.length,e="",u=0;u<o;u++)f=r[u],e+='<option value = "{0}">{1}<\/option>'.format(f.Id,f.Plan);$(".planSelect").empty();$(".planSelect").append(e);var s=0,h=function(){return++s},c=function(n){var t=n.ActualConsumption,i=n.PlannedConsumption,r=n.ExtraConsumption,u=`<font style="color:{0}">${t}</font>/<font style="color:blue">${i}</font>/<font style="color:{1}">${r}</font>`;return u.format(t==i?"blue":"green",r>0?"red":"black")},l=function(n){return'<button type="button" class="btn btn-info btn-sm" onclick="planDetailModal({0})">详情<\/button><button type="button" class="btn btn-primary btn-sm" style="margin-left:2px" onclick="updatePlanModal({0})">修改<\/button><button type="button" class="btn btn-success btn-sm" style="margin-left:2px" onclick="logModal(false,{0})">日志<\/button>'.format(n.Id)},a=function(n){return'<i class="glyphicon glyphicon-remove" aria-hidden="true" style="color:red;font-size:25px;cursor:pointer;text-shadow:2px 2px 2px black" onclick="delPlan({0},\'{1}\')"><\/i>'.format(n.Id,escape(n.Plan))};$("#planList").DataTable({destroy:!0,paging:!0,searching:!0,language:oLanguage,data:r,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:h},{data:"Plan",title:"计划"},{data:null,title:"领料状态(<font style='color:green'>已<\/font>/<font style='color:blue'>总<\/font>/<font style='color:red'>超<\/font>)",render:c},{data:"Remark",title:"备注"},{data:"PlannedCost",title:"计划造价"},{data:"ActualCost",title:"实际造价"},{data:null,title:"操作",render:l},{data:null,title:"删除",render:a}],columnDefs:[{orderable:!1,targets:[6,7]}]})}})}function delPlan(n,t){var i=703,r;if(!checkPermission(i)){layer.msg("没有权限");return}t=unescape(t);r=function(){var t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getPlanList(!1)})};showConfirm(`删除生产计划：${t}`,r)}function codeSelect(n){var i=808,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var r,i,f;if(t.errno!=0){layer.msg(t.errmsg);return}r=t.datas;_firstCode=r[0];for(var o=r.length,e="",u=0;u<o;u++)i=r[u],f=`${i.SpecificationId}${i.SiteId}`,e+='<option value="{0}" cond="{2}" remark="{3}" img="{4}" stock="{5}">{1}<\/option>'.format(i.Id,i.Code,f,i.Remark,i.ImageList,i.Stock),_codeData[i.Id]=i,_cond[f]=1;isStrEmptyOrUndefined(n)||n(e)},0)}function categorySelect(n){var i=816,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var r;if(t.errno!=0){layer.msg(t.errmsg);return}for(var u=t.datas,e=u.length,f="",i=0;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Category);isStrEmptyOrUndefined(n)||n(f)},0)}function siteSelect(n){var i=847,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var r,i,f,u;if(t.errno!=0){layer.msg(t.errmsg);return}for(r=t.datas,f=r.length,_siteData=[],i=0;i<f;i++)u=r[i],_siteData.push({Id:u.Id,Site:u.Site});n("success")},0)}function nameSelect(n){var i=824,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var u,r,f,i;if(t.errno!=0){layer.msg(t.errmsg);return}for(u=t.datas,f=u.length,_nameData={},r=0;r<f;r++)i=u[r],_nameData[i.CategoryId]||(_nameData[i.CategoryId]=[]),_nameData[i.CategoryId].push({Id:i.Id,Name:i.Name});n("success")},0)}function supplierSelect(n){var i=831,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var u,r,f,i;if(t.errno!=0){layer.msg(t.errmsg);return}for(u=t.datas,f=u.length,_supplierData={},r=0;r<f;r++)i=u[r],_supplierData[i.NameId]||(_supplierData[i.NameId]=[]),_supplierData[i.NameId].push({Id:i.Id,Supplier:i.Supplier});n("success")},0)}function specificationSelect(n){var i=839,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var u,r,f,i;if(t.errno!=0){layer.msg(t.errmsg);return}for(u=t.datas,f=u.length,_specificationData={},r=0;r<f;r++)i=u[r],_specificationData[i.SupplierId]||(_specificationData[i.SupplierId]=[]),_specificationData[i.SupplierId].push({Id:i.Id,Specification:i.Specification});n("success")},0)}function addPlanTr(n){var t='<tr><td><\/td><td class="num" style="font-weight:bold"><\/td><td class="code"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{0}<\/select><\/div><\/td><td class="category"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{1}<\/select><\/div><\/td><td class="name"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{2}<\/select><\/div><\/td><td class="supplier"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{3}<\/select><\/div><\/td><td class="specification"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{4}<\/select><\/div><\/td><td class="site"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{5}<\/select><\/div><\/td><td><button type="button" class="btn btn-info btn-sm pdModal">详情<\/button><\/td><td class="price">{6}<\/td><td class="plannedConsumption"><span class="textIn hidden"><\/span><input type="text" class="form-control text-center" value="0" onkeyup="onInput(this, 8, 1)" onblur="onInputEnd(this)" maxlength="10" style="width:140px;margin:auto"><\/td><td class="actualConsumption"><\/td><td style="width:100px"><button type="button" class="btn btn-danger btn-sm delPlanTr"><i class="fa fa-minus"><\/i><\/button><button type="button" class="btn btn-success btn-sm addPlanTr" style="margin-left:5px"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>',i=new Promise(function(n){codeSelect(n)}),r=new Promise(function(n){categorySelect(n)}),u=new Promise(function(n){nameSelect(n)}),f=new Promise(function(n){supplierSelect(n)}),e=new Promise(function(n){specificationSelect(n)}),o=new Promise(function(n){siteSelect(n)});Promise.all([i,r,u,f,e,o]).then(function(i){var o,s,l,h,a;_codeOp=i[0];_categoryOp=i[1];_nameOp="";_supplierOp="";_specificationOp="";_siteOp="";for(var e='<option value = "{0}">{1}<\/option>',c=_nameData[_firstCode.CategoryId],u,f=c.length,r=0;r<f;r++)u=c[r],_nameOp+=e.format(u.Id,u.Name);for(o=_supplierData[_firstCode.NameId],f=o.length,r=0;r<f;r++)u=o[r],_supplierOp+=e.format(u.Id,u.Supplier);for(s=_specificationData[_firstCode.SupplierId],f=s.length,r=0;r<f;r++)u=s[r],_specificationOp+=e.format(u.Id,u.Specification);for(l=_firstCode.SpecificationId,f=_siteData.length,r=0;r<f;r++)u=_siteData[r],h=u.Id,_cond[`${l}${h}`]&&(_siteOp+=e.format(h,u.Site));a=t.format(_codeOp,_categoryOp,_nameOp,_supplierOp,_specificationOp,_siteOp,_firstCode.Price);n(a)})}function addPlanModal(){$("#addPlanModal .addPlan").removeClass("hidden");$("#addPlanModal .updatePlan").addClass("hidden");$("#addPlan").val("");var n=$("#addPlanSelect").find("option").eq(0).val();$("#addPlanSelect").val(n).trigger("change");addUpPlanClass();$("#addPlanModal .modal-title").text("添加新计划");$("#addPlanModal").modal("show")}function addUpPlanClass(n,t){$("#addPlanBody").empty();_planTrCount=0;$("#addRemark").val("");$("#planCost").text("0.00");$("#addPlanTableBtn").removeClass("hidden");$("#addPlanTable").addClass("hidden");new Promise(function(n){addPlanTr(n)}).then(function(i){_planTr=i;n&&addUpPlanTable(t,n)})}function addPlan(){var e=702,r,n,i,f,h;if(!checkPermission(e)){layer.msg("没有权限");return}if(r=$("#addPlan").val().trim(),isStrEmptyOrUndefined(r)){layer.msg("请输入新计划");return}for(var c=$("#addRemark").val().trim(),o={Plan:r,Remark:c},u=[],s=$("#addPlanBody").find("tr"),t=0,l=s.length;t<l;t++){if(n=s.eq(t),n.find(".textIn").is(":hidden")){if(i=n.find(".code select").val(),isStrEmptyOrUndefined(i)){layer.msg(`序列${t+1}：请选择货品编号`);return}f=n.find(".plannedConsumption input").val()}else i=n.find(".num").attr("bill"),f=n.find(".plannedConsumption span").text();u.push({BillId:i,PlannedConsumption:f})}u.length&&(o.Bill=u);h=function(){var n={};n.opType=e;n.opData=JSON.stringify(o);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);$("#addPlanModal").modal("hide");n.errno==0&&getPlanList(!1)})};showConfirm("添加",h)}function planDetailModalData(n){new Promise(function(t){getPlanList(!0,t,n,!1)}).then(function(n){var t=n[0];$("#remarkName").text(t.Remark);$("#plannedCostName").text(t.PlannedCost.toFixed(2));$("#actualCostName").text(t.ActualCost.toFixed(2));var i=t.FirstBill,r=0,u=function(n){var t=`<span style="color:{0}">${++r}</span>`;return t.format(n.Extra?"red":"black")},f=function(n){var t=`<span style="color:{0}">${n.Code}</span>`;return t.format(n.Extra?"red":"black")},e=function(n){return"<button type=\"button\" class=\"btn btn-info btn-sm\" onclick=\"productDetailModal('{0}','{1}','{2}','{3}','{4}','{5}',{6},'{7}','{8}','{9}')\">详情<\/button>".format(escape(n.Category),escape(n.Name),escape(n.Supplier),escape(n.Specification),escape(n.Site),escape(n.Code),n.Stock,escape(n.Price),escape(n.Remark),escape(n.ImageList))},o=function(n){var t=n.ActualConsumption,i=n.PlannedConsumption,r=`<span style="color:{0}">${t}</span>`;return r.format(t===0?"black":t>i?"red":"green")};$("#planDetailList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rtip',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",exportOptions:{columns:[0,1,2,3,4,5,6,8,9],format:{body:function(n,t,i,r){return"‌"+r.textContent}}}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:u},{data:null,title:"货品编号",render:f},{data:"Category",title:"货品类别"},{data:"Name",title:"货品名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Price",title:"价格"},{data:null,title:"货品详情",render:e},{data:"PlannedConsumption",title:"计划用量"},{data:null,title:"实际用量",render:o}]})})}function planDetailModal(n){$("#PlanDetailSelect").val(n).trigger("change");planDetailModalData(n);$("#planDetailModal").modal("show")}function productDetailModal(n,t,i,r,u,f,e,o,s,h){if(n=unescape(n),t=unescape(t),i=unescape(i),r=unescape(r),u=unescape(u),f=unescape(f),s=unescape(s),$("#productCategory").text(n),$("#productName").text(t),$("#productSupplier").text(i),$("#productSpecification").text(r),$("#productSite").text(u),$("#productCode").text(f),$("#productStock").text(e),$("#productPrice").text(o),$("#productRemark").text(s),h=unescape(h),$("#imgLabel").empty(),$("#productImg").empty(),isStrEmptyOrUndefined(h))$("#imgLabel").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgLabel").append("图片：");h=h.split(",");var c={type:fileEnum.Material,files:JSON.stringify(h)};ajaxPost("/Upload/Path",c,function(n){var r,i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(r='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><\/div><\/div>',i="",t=0;t<n.data.length;t++)i+=r.format(n.data[t].path);$("#productImg").append(i)})}$("#productDetailModal").modal("show")}function updatePlanModal(n){$("#addPlanTableBtn").attr("disabled",!0);$("#addPlanModal .addPlan").addClass("hidden");$("#addPlanModal .updatePlan").removeClass("hidden");addUpPlanClass(!0,n);$("#updatePlanSelect").val(n).trigger("change");$("#addPlanModal .modal-title").text("修改计划");$("#addPlanModal").modal("show")}function updatePlan(){var o=701,n,i,u,f,e,l;if(!checkPermission(o)){layer.msg("没有权限");return}for(var s=$("#updatePlanSelect").val(),a=$("#updatePlanSelect").find(`option[value=${s}]`).text(),v=$("#addRemark").val().trim(),h={id:s,Plan:a,Remark:v},r=[],c=$("#addPlanBody").find("tr"),t=0,y=c.length;t<y;t++){if(n=c.eq(t),n.find(".textIn").is(":hidden")){if(i=n.find(".code select").val(),isStrEmptyOrUndefined(i)){layer.msg(`序列${t+1}：请选择货品编号`);return}u=n.find(".plannedConsumption input").val()}else i=n.find(".num").attr("bill"),u=n.find(".plannedConsumption span").text();f={BillId:i,PlannedConsumption:u};e=n.find(".num").attr("list");e&&(f.Id=parseInt(e));r.push(f)}r.length&&(h.Bill=r);l=function(){var n={};n.opType=o;n.opData=JSON.stringify(h);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);$("#addPlanModal").modal("hide");n.errno==0&&getPlanList(!1)})};showConfirm("修改",l)}function logPlanSelect(n){var i=700,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var r;if(t.errno!=0){layer.msg(t.errmsg);return}for(var u=t.datas,e=u.length,f="",i=0;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Plan);n(f)})}function logModal(n,t){var i=new Promise(function(n){logPlanSelect(n)}),r=new Promise(function(n){codeSelect(n)});Promise.all([i,r]).then(function(i){var u=i[0],f=i[1],r;$("#logPlanSelect").empty();$("#logBillSelect").empty();r='<option value="0">所有<\/option>';n&&$("#logPlanSelect").append(r);$("#logPlanSelect").append(u);t&&$("#logPlanSelect").val(t).trigger("change");$("#logBillSelect").append(r);$("#logBillSelect").append(f);getLogList()});$("#logModal").modal("show")}function getLogList(){var o=803,n,i,u,f,r,t,e;if(!checkPermission(o)){layer.msg("没有权限");return}if(n=$("#logStartDate").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择开始时间");return}if(i=$("#logEndDate").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择结束时间");return}if(exceedTime(n)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(n,i)){layer.msg("结束时间不能小于开始时间");return}if(n+=" 00:00:00",i+=" 23:59:59",u={startTime:n,endTime:i,isPlan:1,type:2},f=$("#logPlanSelect").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择计划号");return}if(f!=0&&(u.planId=parseInt(f)),r=$("#logBillSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品编号");return}r!=0?(u.billId=parseInt(r),t=_codeData[r],$("#logCategory").text(t.Category),$("#logName").text(t.Name),$("#logSpecification").text(t.Specification),$("#logSupplier").text(t.Supplier),$("#logPrice").text(t.Price),$("#billInfo").removeClass("hidden")):$("#billInfo").addClass("hidden");e={};e.opType=o;e.opData=JSON.stringify(u);ajaxPost("/Relay/Post",e,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=0,i=function(){return++t};$("#logList").DataTable({destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:[{data:null,title:"序号",render:i},{data:"Time",title:"时间"},{data:"Purpose",title:"计划号"},{data:"Code",title:"货品编号"},{data:"Number",title:"数量"},{data:"RelatedPerson",title:"领用人"},{data:"Manager",title:"物管员"}]})})}var _planTr=null,_codeData={},_cond={},_firstCode=null,_siteData=null,_nameData=null,_supplierData=null,_specificationData=null,_codeOp,_categoryOp,_nameOp,_supplierOp,_specificationOp,_siteOp,_planTrCount=0;