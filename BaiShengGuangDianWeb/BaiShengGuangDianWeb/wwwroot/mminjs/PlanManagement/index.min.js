function pageReady(){$(".ms2").select2();getPlanList(!1);$("#addPlanTableBtn").on("click",function(){$(this).addClass("hidden");_planTrCount++;$("#addPlanBody").append(_planTr);setTableSelect($("#addPlanBody"));$("#addPlanTable").removeClass("hidden")});$("#addPlanBody").on("click",".addPlanTr",function(){var t,n,i;_planTrCount++;t=$(this).parents("tr");t.after(_planTr);n=t.next();setTableSelect(n);i=n.find(".code").val();n.find(".num").attr("bill",i)});$("#addPlanBody").on("click",".delPlanTr",function(){_planTrCount--;var n=$(this).parents("tr");n.remove();_planTrCount?(setTableTrCount($("#addPlanBody"),_planTrCount),getPriceSum()):($("#addPlanTableBtn").removeClass("hidden"),$("#addPlanTable").addClass("hidden"),$("#planCost").text("0.00"))});$("#addPlanBody").on("select2:select",".code",function(){var n=$(this).parents("tr");setTableSelect(n)});$("#addPlanBody").on("select2:select",".category",function(){var n=$(this).parents("tr");setTrSelect(n,1)});$("#addPlanBody").on("select2:select",".name",function(){var n=$(this).parents("tr");setTrSelect(n,2)});$("#addPlanBody").on("select2:select",".supplier",function(){var n=$(this).parents("tr");setTrSelect(n,3)});$("#addPlanBody").on("select2:select",".specification",function(){var n=$(this).parents("tr");setTrSelect(n,4)});$("#addPlanBody").on("select2:select",".site",function(){var n=$(this).parents("tr");setTrSelect(n,5)});$("#reuse").on("click",function(){var n=$("#addPlanSelect").val(),t,i;if(isStrEmptyOrUndefined(n)){layer.msg("请选择要复用的计划号");return}t=$("#addPlanSelect").find(`[value=${n}]`).text();i=function(){addUpPlanTable(n,!1)};showConfirm(`复用生产计划：${t}`,i)});$("#addPlanBody").on("focusin",".plannedConsumption",function(){var n=$(this).val();n==0&&$(this).val("")});$("#addPlanBody").on("focusout",".plannedConsumption",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#addPlanBody").on("input",".plannedConsumption",function(){getPriceSum()});$("#PlanDetailSelect").on("select2:select",function(){var n=$(this).val();planDetailModalData(n)});$("#addPlanBody").on("click",".pdModal",function(){var n=$(this).parents("tr"),o=n.find(".category").val(),r,u,f,e;o=n.find(".category").find(`option[value=${o}]`).text();r=n.find(".name").val();r=n.find(".name").find(`option[value=${r}]`).text();u=n.find(".supplier").val();u=n.find(".supplier").find(`option[value=${u}]`).text();f=n.find(".specification").val();f=n.find(".specification").find(`option[value=${f}]`).text();e=n.find(".site").val();e=n.find(".site").find(`option[value=${e}]`).text();var i=n.find(".code"),t=i.val(),s=i.find(`option[value=${t}]`).attr("stock"),h=n.find(".price").text(),c=i.find(`option[value=${t}]`).attr("remark"),l=i.find(`option[value=${t}]`).attr("img");t=i.find(`option[value=${t}]`).text();productDetailModal(escape(o),escape(r),u,f,e,t,s,h,c,l)});$("#updatePlanSelect").on("select2:select",function(){var n=$(this).val();addUpPlanTable(n,!0)});$("#logPlanSelect,#logBillSelect").on("select2:select",function(){getLogList()});$("#logStartDate").val(getDate());$("#logEndDate").val(getDate());$("#logStartDate,#logEndDate").datepicker("update").on("changeDate",function(){getLogList()})}function addUpPlanTable(n,t){new Promise(function(t){getPlanList(!0,t,n,!0)}).then(function(n){var f=n[0],e,u,o,r,s,i,h;if($("#addPlan").val(f.Plan),$("#addRemark").val(f.Remark),e=f.FirstBill,o=e.length,$("#addPlanTableBtn").removeClass("hidden"),$("#addPlanBody").empty(),$("#addPlanTable").addClass("hidden"),_planTrCount=0,o){for($("#addPlanTableBtn").addClass("hidden"),$("#addPlanTable").removeClass("hidden"),r=-1,s='<tr style="color:red"><td class="num" style="font-weight:bold"><\/td><td class="code">{5}<\/td><td>{0}<\/td><td>{1}<\/td><td>{2}<\/td><td>{3}<\/td><td>{4}<\/td><td><button type="button" class="btn btn-info btn-sm" onclick="productDetailModal(\'{0}\',\'{1}\',\'{2}\',\'{3}\',\'{4}\',\'{5}\',{6},\'{7}\',\'{8}\',\'{9}\')">详情<\/button><\/td><td>{7}<\/td><td class="plannedConsumption">{10}<\/td><td class="actualConsumption">{11}<\/td><td><button type="button" class="btn btn-danger btn-sm delPlanTr" style="margin-left:5px"><i class="fa fa-minus"><\/i><\/button><\/td><\/tr>',u=0;u<o;u++)i=e[u],_planTrCount++,r++,_codeData[i.BillId]?($("#addPlanBody").append(_planTr),$("#addPlanBody").find(".code").eq(r).val(i.BillId),$("#addPlanBody").find(".plannedConsumption").eq(r).val(t?i.PlannedConsumption:i.ActualConsumption),$("#addPlanBody").find(".actualConsumption").eq(r).text(i.ActualConsumption),i.ActualConsumption!=0&&t&&$("#addPlanBody").find(".delPlanTr").eq(r).addClass("hidden"),h=$("#addPlanBody").find("tr").eq(r),setTableSelect(h)):t&&$("#addPlanBody").append(s.format(i.Category,i.Name,i.Supplier,i.Specification,i.Site,i.Code,i.Stock,i.Price,i.Remark,i.ImageList,i.PlannedConsumption,i.ActualConsumption)),$("#addPlanBody").find(".num").eq(r).attr("list",i.Id),$("#addPlanBody").find(".num").eq(r).attr("bill",i.BillId);getPriceSum();setTableTrCount($("#addPlanBody"),_planTrCount,t)}})}function setTableTrCount(n,t,i){for(var r=0;r<t;r++)n.find(".num").eq(r).text(r+1);$(" #addPlanBody .ms2").select2();i=$("#addPlanSelect").is(":hidden");i?$(" #addPlanTable .actualConsumption").removeClass("hidden"):$(" #addPlanTable .actualConsumption").addClass("hidden")}function setTableSelect(n){var p=n.find(".code").val(),u=_codeData[p],c=u.CategoryId,l=u.NameId,a=u.SupplierId,v=u.SpecificationId,w=u.SiteId,b=u.Price,e,o,s,h,y;n.find(".category").val(c).trigger("change");var t,r=_nameData.length,f='<option value = "{0}">{1}<\/option>',i="";for(n.find(".name").empty(),t=0;t<r;t++)e=_nameData[t],c==e.CategoryId&&(i+=f.format(e.Id,e.Name));for(n.find(".name").append(i),n.find(".name").val(l).trigger("change"),n.find(".supplier").empty(),i="",r=_supplierData.length,t=0;t<r;t++)o=_supplierData[t],l==o.NameId&&(i+=f.format(o.Id,o.Supplier));for(n.find(".supplier").append(i),n.find(".supplier").val(a).trigger("change"),n.find(".specification").empty(),i="",r=_specificationData.length,t=0;t<r;t++)s=_specificationData[t],a==s.SupplierId&&(i+=f.format(s.Id,s.Specification));for(n.find(".specification").append(i),n.find(".specification").val(v).trigger("change"),n.find(".site").empty(),i="",r=_siteData.length,t=0;t<r;t++)h=_siteData[t].Id,y=_siteData[t].Site,_cond[`${v}${h}`]&&(i+=f.format(h,y));n.find(".site").append(i);n.find(".site").val(w).trigger("change");n.find(".price").text(b);setTableTrCount($("#addPlanBody"),_planTrCount);getPriceSum()}function setTrSelect(n,t){var i,u,f='<option value = "{0}">{1}<\/option>',r,l,e,a,o,v,s,y,h,p,b;if(t===1){for(r="",l=n.find(".category").val(),n.find(".name").empty(),u=_nameData.length,i=0;i<u;i++)e=_nameData[i],l==e.CategoryId&&(r+=f.format(e.Id,e.Name));n.find(".name").append(r)}if(t===1||t===2){for(r="",a=n.find(".name").val(),n.find(".supplier").empty(),u=_supplierData.length,i=0;i<u;i++)o=_supplierData[i],a==o.NameId&&(r+=f.format(o.Id,o.Supplier));n.find(".supplier").append(r)}if(t===1||t===2||t===3){for(r="",v=n.find(".supplier").val(),n.find(".specification").empty(),u=_specificationData.length,i=0;i<u;i++)s=_specificationData[i],v==s.SupplierId&&(r+=f.format(s.Id,s.Specification));n.find(".specification").append(r)}if(t===1||t===2||t===3||t===4){for(r="",y=n.find(".specification").val(),n.find(".site").empty(),u=_siteData.length,i=0;i<u;i++)h=_siteData[i].Id,p=_siteData[i].Site,_cond[`${y}${h}`]&&(r+=f.format(h,p));n.find(".site").append(r)}if(t===1||t===2||t===3||t===4||t===5){var k=n.find(".specification").val(),d=n.find(".site").val(),g=`${k}${d}`,w=n.find(".code"),c=w.find(`[cond=${g}]`).val();w.val(c).trigger("change");isStrEmptyOrUndefined(c)?n.find(".price").text(""):(b=_codeData[c].Price,n.find(".price").text(b));getPriceSum()}}function getPriceSum(){for(var u=$("#addPlanBody").find("tr"),i=0,e=u.length,f=0,r,n,t;i<e;i++)r=u.eq(i),n=r.find(".price").text(),isStrEmptyOrUndefined(n)&&(n=0),t=r.find(".plannedConsumption").val(),isStrEmptyOrUndefined(t)&&(t=0),f+=parseInt(n)*parseInt(t);$("#planCost").text(f.toFixed(2))}function getPlanList(n,t,i,r){var f=700,u;if(!checkPermission(f)){layer.msg("没有权限");return}u={};u.opType=f;n&&(u.opData=JSON.stringify({qId:i,first:!0,simple:r}));ajaxPost("/Relay/Post",u,function(i){var r,f;if(i.errno!=0){layer.msg(i.errmsg);return}if(r=i.datas,n)t(r);else{for(var o=r.length,e="",u=0;u<o;u++)f=r[u],e+='<option value = "{0}">{1}<\/option>'.format(f.Id,f.Plan);$(".planSelect").empty();$(".planSelect").append(e);var s=0,h=function(){return++s},c=function(n){var t=n.ActualConsumption,i=n.PlannedConsumption,r=n.ExtraConsumption,u=`<font style="color:{0}">${t}</font>/<font style="color:blue">${i}</font>/<font style="color:{1}">${r}</font>`;return u.format(t==i?"blue":"green",r>0?"red":"black")},l=function(n){return'<button type="button" class="btn btn-info btn-sm" onclick="planDetailModal({0})">详情<\/button><button type="button" class="btn btn-primary btn-sm" style="margin-left:2px" onclick="updatePlanModal({0})">修改<\/button><button type="button" class="btn btn-success btn-sm" style="margin-left:2px" onclick="logModal(false,{0})">日志<\/button>'.format(n.Id)},a=function(n){return'<i class="glyphicon glyphicon-remove" aria-hidden="true" style="color:red;font-size:25px;cursor:pointer;text-shadow:2px 2px 2px black" onclick="delPlan({0},\'{1}\')"><\/i>'.format(n.Id,escape(n.Plan))};$("#planList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:r,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:h},{data:"Plan",title:"计划"},{data:null,title:"领料状态(<font style='color:green'>已<\/font>/<font style='color:blue'>总<\/font>/<font style='color:red'>超<\/font>)",render:c},{data:"Remark",title:"备注"},{data:"PlannedCost",title:"计划造价"},{data:"ActualCost",title:"实际造价"},{data:null,title:"操作",render:l},{data:null,title:"删除",render:a}],columnDefs:[{orderable:!1,targets:[6,7]}]})}})}function delPlan(n,t){var i=703,r;if(!checkPermission(i)){layer.msg("没有权限");return}t=unescape(t);r=function(){var t={};t.opType=i;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getPlanList(!1)})};showConfirm(`删除生产计划：${t}`,r)}function codeSelect(n){var i=808,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var i,u;if(t.errno!=0){layer.msg(t.errmsg);return}for(var f=t.datas,o=f.length,e="",r=0;r<o;r++)i=f[r],u=`${i.SpecificationId}${i.SiteId}`,e+='<option value="{0}" cond="{2}" remark="{3}" img="{4}" stock="{5}">{1}<\/option>'.format(i.Id,i.Code,u,i.Remark,i.ImageList,i.Stock),_codeData[i.Id]=i,_cond[u]=1;isStrEmptyOrUndefined(n)||n(e)},0)}function categorySelect(n){var i=816,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var r;if(t.errno!=0){layer.msg(t.errmsg);return}for(var u=t.datas,e=u.length,f="",i=0;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Category);isStrEmptyOrUndefined(n)||n(f)},0)}function siteSelect(n){var i=847,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var i;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,r,e=u.length,f="";for(_siteData=[],r=0;r<e;r++)i=u[r],f+='<option value = "{0}">{1}<\/option>'.format(i.Id,i.Site),_siteData.push({Id:i.Id,Site:i.Site});isStrEmptyOrUndefined(n)||n(f)},0)}function nameSelect(n){var i=824,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var i;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,r,e=u.length,f="";for(_nameData=[],r=0;r<e;r++)i=u[r],f+='<option value = "{0}">{1}<\/option>'.format(i.Id,i.Name),_nameData.push({Id:i.Id,CategoryId:i.CategoryId,Name:i.Name});isStrEmptyOrUndefined(n)||n(f)},0)}function supplierSelect(n){var i=831,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var i;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,r,e=u.length,f="";for(_supplierData=[],r=0;r<e;r++)i=u[r],f+='<option value = "{0}">{1}<\/option>'.format(i.Id,i.Supplier),_supplierData.push({Id:i.Id,NameId:i.NameId,Supplier:i.Supplier});isStrEmptyOrUndefined(n)||n(f)},0)}function specificationSelect(n){var i=839,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var i;if(t.errno!=0){layer.msg(t.errmsg);return}var u=t.datas,r,e=u.length,f="";for(_specificationData=[],r=0;r<e;r++)i=u[r],f+='<option value = "{0}">{1}<\/option>'.format(i.Id,i.Specification),_specificationData.push({Id:i.Id,SupplierId:i.SupplierId,Specification:i.Specification});isStrEmptyOrUndefined(n)||n(f)},0)}function addPlanTr(n){var o='<tr><td class="num" style="font-weight:bold"><\/td><td><div style="width:140px;margin:auto"><select class="ms2 form-control code">{0}<\/select><\/div><\/td><td><div style="width:140px;margin:auto"><select class="ms2 form-control category">{1}<\/select><\/div><\/td><td><div style="width:140px;margin:auto"><select class="ms2 form-control name">{2}<\/select><\/div><\/td><td><div style="width:140px;margin:auto"><select class="ms2 form-control supplier">{3}<\/select><\/div><\/td><td><div style="width:140px;margin:auto"><select class="ms2 form-control specification">{4}<\/select><\/div><\/td><td><div style="width:140px;margin:auto"><select class="ms2 form-control site">{5}<\/select><\/div><\/td><td><button type="button" class="btn btn-info btn-sm pdModal">详情<\/button><\/td><td class="price"><\/td><td><input type="text" class="form-control text-center plannedConsumption" maxlength="10" style="width:140px;margin:auto" value="0" oninput="value=value.replace(/[^\\d]/g,\'\')"><\/td><td class="actualConsumption"><\/td><td style="width:100px"><button type="button" class="btn btn-danger btn-sm delPlanTr"><i class="fa fa-minus"><\/i><\/button><button type="button" class="btn btn-success btn-sm addPlanTr" style="margin-left:5px"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>',t,i,r,u,f,e,s=new Promise(function(n){codeSelect(n)}),h=new Promise(function(n){categorySelect(n)}),c=new Promise(function(n){nameSelect(n)}),l=new Promise(function(n){supplierSelect(n)}),a=new Promise(function(n){specificationSelect(n)}),v=new Promise(function(n){siteSelect(n)});Promise.all([s,h,c,l,a,v]).then(function(s){t=s[0];i=s[1];r=s[2];u=s[3];f=s[4];e=s[5];var h=o.format(t,i,r,u,f,e);n(h)})}function addPlanModal(){$("#addPlanModal .addPlan").removeClass("hidden");$("#addPlanModal .updatePlan").addClass("hidden");$("#addPlan").val("");var n=$("#addPlanSelect").find("option").eq(0).val();$("#addPlanSelect").val(n).trigger("change");addUpPlanClass();$("#addPlanModal .modal-title").text("添加新计划");$("#addPlanModal").modal("show")}function addUpPlanClass(n,t){_planTrCount=0;$("#addRemark").val("");$("#planCost").text("0.00");$("#addPlanTableBtn").removeClass("hidden");$("#addPlanTable").addClass("hidden");$("#addPlanBody").empty();new Promise(function(n){addPlanTr(n)}).then(function(i){_planTr=i;n&&addUpPlanTable(t,n)})}function addPlan(){var e=702,n,r,u,f,h;if(!checkPermission(e)){layer.msg("没有权限");return}if(n=$("#addPlan").val().trim(),isStrEmptyOrUndefined(n)){layer.msg("请输入新计划");return}for(var c=$("#addRemark").val().trim(),o={Plan:n,Remark:c},t=[],s=$("#addPlanBody").find("tr"),i=0,l=s.length;i<l;i++){if(r=s.eq(i),u=r.find(".code").val(),isStrEmptyOrUndefined(u)){layer.msg("请选择货品编号");return}if(f=r.find(".plannedConsumption").val(),f==0){layer.msg("计划用量不能为零");return}t.push({BillId:u,PlannedConsumption:f})}t.length&&(o.Bill=t);h=function(){var n={};n.opType=e;n.opData=JSON.stringify(o);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);$("#addPlanModal").modal("hide");n.errno==0&&getPlanList(!1)})};showConfirm("添加",h)}function planDetailModalData(n){new Promise(function(t){getPlanList(!0,t,n,!1)}).then(function(n){var t=n[0];$("#remarkName").text(t.Remark);$("#plannedCostName").text(t.PlannedCost.toFixed(2));$("#actualCostName").text(t.ActualCost.toFixed(2));var i=t.FirstBill,r=0,u=function(n){var t=`<span style="color:{0}">${++r}</span>`;return t.format(n.Extra?"red":"black")},f=function(n){var t=`<span style="color:{0}">${n.Code}</span>`;return t.format(n.Extra?"red":"black")},e=function(n){return"<button type=\"button\" class=\"btn btn-info btn-sm\" onclick=\"productDetailModal('{0}','{1}','{2}','{3}','{4}','{5}',{6},'{7}','{8}','{9}')\">详情<\/button>".format(escape(n.Category),escape(n.Name),escape(n.Supplier),escape(n.Specification),escape(n.Site),escape(n.Code),n.Stock,escape(n.Price),escape(n.Remark),escape(n.ImageList))},o=function(n){var t=n.ActualConsumption,i=n.PlannedConsumption,r=`<span style="color:{0}">${t}</span>`;return r.format(t===0?"black":t>i?"red":"green")};$("#planDetailList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:i,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:u},{data:null,title:"货品编号",render:f},{data:"Category",title:"货品类别"},{data:"Name",title:"货品名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:null,title:"货品详情",render:e},{data:"PlannedConsumption",title:"计划用量"},{data:null,title:"实际用量",render:o}]})})}function planDetailModal(n){$("#PlanDetailSelect").val(n).trigger("change");planDetailModalData(n);$("#planDetailModal").modal("show")}function productDetailModal(n,t,i,r,u,f,e,o,s,h){if(n=unescape(n),t=unescape(t),i=unescape(i),r=unescape(r),u=unescape(u),f=unescape(f),s=unescape(s),$("#productCategory").text(n),$("#productName").text(t),$("#productSupplier").text(i),$("#productSpecification").text(r),$("#productSite").text(u),$("#productCode").text(f),$("#productStock").text(e),$("#productPrice").text(o),$("#productRemark").text(s),h=unescape(h),$("#imgLabel").empty(),$("#productImg").empty(),isStrEmptyOrUndefined(h))$("#imgLabel").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgLabel").append("图片：");h=h.split(",");var c={type:fileEnum.Material,files:JSON.stringify(h)};ajaxPost("/Upload/Path",c,function(n){var r,i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(r='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><\/div><\/div>',i="",t=0;t<n.data.length;t++)i+=r.format(n.data[t].path);$("#productImg").append(i)})}$("#productDetailModal").modal("show")}function updatePlanModal(n){$("#addPlanModal .addPlan").addClass("hidden");$("#addPlanModal .updatePlan").removeClass("hidden");addUpPlanClass(!0,n);$("#updatePlanSelect").val(n).trigger("change");$("#addPlanModal .modal-title").text("修改计划");$("#addPlanModal").modal("show")}function updatePlan(){var s=701,n,t,i,f,e,o,a;if(!checkPermission(s)){layer.msg("没有权限");return}for(var h=$("#updatePlanSelect").val(),v=$("#updatePlanSelect").find(`option[value=${h}]`).text(),y=$("#addRemark").val().trim(),c={id:h,Plan:v,Remark:y},r=[],l=$("#addPlanBody").find("tr"),u=0,p=l.length;u<p;u++){if(n=l.eq(u),f=n.find(".num").attr("bill"),_codeData[f]){if(t=n.find(".code").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择货品编号");return}if(i=n.find(".plannedConsumption").val(),i==0){layer.msg("计划用量不能为零");return}}else t=f,i=n.find(".plannedConsumption").text();e={BillId:t,PlannedConsumption:i};o=n.find(".num").attr("list");o&&(e.Id=parseInt(o));r.push(e)}r.length&&(c.Bill=r);a=function(){var n={};n.opType=s;n.opData=JSON.stringify(c);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);$("#addPlanModal").modal("hide");n.errno==0&&getPlanList(!1)})};showConfirm("修改",a)}function logPlanSelect(n){var i=700,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var r;if(t.errno!=0){layer.msg(t.errmsg);return}for(var u=t.datas,e=u.length,f="",i=0;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Plan);n(f)})}function logModal(n,t){var i=new Promise(function(n){logPlanSelect(n)}),r=new Promise(function(n){codeSelect(n)});Promise.all([i,r]).then(function(i){var u=i[0],f=i[1],r;$("#logPlanSelect").empty();$("#logBillSelect").empty();r='<option value="0">所有<\/option>';n&&$("#logPlanSelect").append(r);$("#logPlanSelect").append(u);t&&$("#logPlanSelect").val(t).trigger("change");$("#logBillSelect").append(r);$("#logBillSelect").append(f);getLogList()});$("#logModal").modal("show")}function getLogList(){var o=803,n,i,u,f,r,t,e;if(!checkPermission(o)){layer.msg("没有权限");return}if(n=$("#logStartDate").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择开始时间");return}if(i=$("#logEndDate").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择结束时间");return}if(exceedTime(n)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(n,i)){layer.msg("结束时间不能小于开始时间");return}if(n+=" 00:00:00",i+=" 23:59:59",u={startTime:n,endTime:i,isPlan:1,type:2},f=$("#logPlanSelect").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择计划号");return}if(f!=0&&(u.planId=parseInt(f)),r=$("#logBillSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品编号");return}r!=0?(u.billId=parseInt(r),t=_codeData[r],$("#logCategory").text(t.Category),$("#logName").text(t.Name),$("#logSpecification").text(t.Specification),$("#logSupplier").text(t.Supplier),$("#logPrice").text(t.Price),$("#billInfo").removeClass("hidden")):$("#billInfo").addClass("hidden");e={};e.opType=o;e.opData=JSON.stringify(u);ajaxPost("/Relay/Post",e,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=0,i=function(){return++t};$("#logList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:[{data:null,title:"序号",render:i},{data:"Time",title:"时间"},{data:"Purpose",title:"计划号"},{data:"Code",title:"货品编号"},{data:"Number",title:"数量"},{data:"RelatedPerson",title:"领用人"},{data:"Manager",title:"物管员"}]})})}var _planTr=null,_codeData={},_cond={},_siteData=null,_nameData=null,_supplierData=null,_specificationData=null,_planTrCount=0;