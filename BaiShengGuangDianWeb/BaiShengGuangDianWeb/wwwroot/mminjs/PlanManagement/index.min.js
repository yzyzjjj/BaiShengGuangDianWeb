function pageReady(){_permissionList[497]={uIds:["logModalBtn"]};_permissionList[498]={uIds:["addPlanModalBtn"]};_permissionList[499]={uIds:["reuse"]};_permissionList[500]={uIds:[]};_permissionList[501]={uIds:[]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();getPlanList(!1);$("#addPlanTableBtn").on("click",function(){$(this).addClass("hidden");_planTrCount++;$("#addPlanBody").append(_planTr);setTableTrCount($("#addPlanBody"),_planTrCount);setDefaultCode($("#addPlanBody tr"));$("#addPlanTable").removeClass("hidden")});$("#addPlanBody").on("click",".addPlanTr",function(){var n,t;_planTrCount++;n=$(this).parents("tr");n.after(_planTr);t=n.next();setTableTrCount($("#addPlanBody"),_planTrCount);setDefaultCode(t)});$("#addPlanBody").on("click",".delPlanTr",function(){_planTrCount--;var n=$(this).parents("tr");n.remove();_planTrCount?(setTableTrCount($("#addPlanBody"),_planTrCount),getPriceSum()):($("#addPlanTableBtn").removeClass("hidden"),$("#addPlanTable").addClass("hidden"),$("#planCost").text("0.00"))});$("#addPlanBody").on("select2:select",".code select",function(){var n=$(this).parents("tr");setTableSelect(n)});$("#addPlanBody").on("select2:select",".category select",function(){var n=$(this).parents("tr");setTrSelect(n,1)});$("#addPlanBody").on("select2:select",".name select",function(){var n=$(this).parents("tr");setTrSelect(n,2)});$("#addPlanBody").on("select2:select",".supplier select",function(){var n=$(this).parents("tr");setTrSelect(n,3)});$("#addPlanBody").on("select2:select",".specification select",function(){var n=$(this).parents("tr");setTrSelect(n,4)});$("#addPlanBody").on("select2:select",".site select",function(){var n=$(this).parents("tr");setTrSelect(n,5)});$("#addPlanBody").on("select2:select",".price select",function(){var n=$(this).parents("tr");setTrSelect(n,6)});$("#reuse").on("click",function(){var n=$("#addPlanSelect").val(),t,i;if(isStrEmptyOrUndefined(n)){layer.msg("请选择要复用的计划号");return}t=$("#addPlanSelect").find(`[value=${n}]`).text();i=function(){$("#addPlanBody").empty();addUpPlanTable(n,!1)};showConfirm(`复用生产计划：${t}`,i)});$("#addPlanBody").on("ifChanged",".isEnable",function(){var n=$(this).parents("tr"),i,t,r,u,f;$(this).is(":checked")?(i=n.find(".code"),i.children().length==1&&(t='<div class="textOn" style="width:140px;margin:auto"><select class="ms2 form-control">{0}<\/select><\/div>',r='<input type="text" class="form-control text-center textOn" value={0} onkeyup="onInput(this, 8, 1)" onblur="onInputEnd(this)" maxlength="10" style="width:140px;margin:auto">',i.append(t.format(_codeOp)),n.find(".category").append(t.format(_categoryOp)),n.find(".name").append(t.format(_nameOp)),n.find(".supplier").append(t.format(_supplierOp)),n.find(".specification").append(t.format(_specificationOp)),n.find(".price").append(t.format(_priceOp)),n.find(".site").append(t.format(_siteOp)),u=n.find(".plannedConsumption span").text(),n.find(".plannedConsumption").append(r.format(u)),$(" #addPlanBody .ms2").select2(),setDefaultCode(n),f=n.find(".num").attr("bill"),i.find("select").val(f).trigger("change").trigger("select2:select")),n.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden")):n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");getPriceSum()});$("#addPlanBody").on("focusin",".plannedConsumption input",function(){var n=$(this).val();n==0&&$(this).val("")});$("#addPlanBody").on("focusout",".plannedConsumption input",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#addPlanBody").on("input",".plannedConsumption input",function(){getPriceSum()});$("#PlanDetailSelect").on("select2:select",function(){var n=$(this).val();planDetailModalData(n)});$("#addPlanBody").on("click",".pdModal",function(){var n=$(this).parents("tr"),i=n.find(".category :selected").text(),r=n.find(".name :selected").text(),u=n.find(".supplier :selected").text(),f=n.find(".specification :selected").text(),e=n.find(".site :selected").text(),t=n.find(".code :selected"),o=t.text(),s=t.attr("stock"),h=n.find(".price").text(),c=t.attr("remark"),l=t.attr("img");productDetailModal(escape(i),escape(r),u,f,e,o,s,h,c,l)});$("#updatePlanSelect").on("select2:select",function(){var n=$(this).val();$("#updatePlanName").val($(this).find(":selected").text());$("#addPlanBody").empty();addUpPlanTable(n,!0)});$("#logPlanSelect,#logBillSelect").on("select2:select",()=>getLogList());$("#logStartDate").val(getDate());$("#logEndDate").val(getDate());$("#logStartDate,#logEndDate").datepicker("update").on("changeDate",()=>getLogList());$("#logPlanType").on("change",()=>getLogList());$("#planSelectFrom").on("select2:select",function(){const n=$(this).val();new Promise(t=>{getPlanList(!0,t,n,!0)}).then(n=>{const t=n[0];$("#planTransferRemark").text(t.Remark);var i=n=>{return"<button type=\"button\" class=\"btn btn-info btn-sm\" onclick=\"productDetailModal('{0}','{1}','{2}','{3}','{4}','{5}',{6},'{7}','{8}','{9}')\">详情<\/button>".format(escape(n.Category),escape(n.Name),escape(n.Supplier),escape(n.Specification),escape(n.Site),escape(n.Code),n.Stock,escape(n.Price),escape(n.Remark),escape(n.ImageList))};const r=n=>`<input type="checkbox" class="icb_minimal isEnable checkBox" value="${n}">`;$("#planTransferList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.FirstBill,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:'<input type="checkbox" class="icb_minimal isEnable isAll"><span class="middle">全选<\/span>',render:r,orderable:!1,sWidth:"80px"},{data:null,title:"序号",render:(n,t,i,r)=>r.row+1},{data:"Code",title:"货品编号"},{data:"Category",title:"货品类别"},{data:"Name",title:"货品名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Price",title:"单价"},{data:null,title:"货品详情",render:i},{data:"ActualConsumption",title:"实际用量"}],drawCallback:function(){$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"})}})})});$("#planTransferList").on("ifChanged",".isAll",function(){const n=$($("#planTransferList").DataTable().columns(0).nodes()[0]).find(".checkBox");if($(this).is(":checked"))n.iCheck("check");else{const t=Array.from($($("#planTransferList").DataTable().columns(0).nodes()[0]).find(".checkBox")).every(n=>$(n).is(":checked"));t&&n.iCheck("uncheck")}});$("#planTransferList").on("ifChanged",".checkBox",function(){if($(this).is(":checked")){const n=Array.from($($("#planTransferList").DataTable().columns(0).nodes()[0]).find(".checkBox")).every(n=>$(n).is(":checked"));n&&$("#planTransferList .isAll").iCheck("check")}else $("#planTransferList .isAll").iCheck("uncheck")})}function setDefaultCode(n){n.find(".category select").val(_firstCode.CategoryId).trigger("change");n.find(".name select").val(_firstCode.NameId).trigger("change");n.find(".supplier select").val(_firstCode.SupplierId).trigger("change");n.find(".specification select").val(_firstCode.SpecificationId).trigger("change");n.find(".price select").val(_firstCode.Price).trigger("change");n.find(".site select").val(_firstCode.SiteId).trigger("change")}function setTableStyle(){$("#addPlanBody").find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"})}function addUpPlanTable(n,t){new Promise(t=>{getPlanList(!0,t,n,!0)}).then(n=>{var f=n[0],e,u,o,h,s,i,r;if($("#addPlan").val(f.Plan),$("#addRemark").val(f.Remark),e=f.FirstBill,o=e.length,_planTrCount=0,o){for($("#addPlanTableBtn").addClass("hidden"),$("#addPlanTable").removeClass("hidden"),h='<tr style="color:{12}"><td><input type="checkbox" class="icb_minimal isEnable {14}"><\/td><td class="num" style="font-weight:bold" list={15} bill={16}><\/td><td class="code"><span class="textIn">{5}<\/span><\/td><td class="category"><span class="textIn">{0}<\/span><\/td><td class="name"><span class="textIn">{1}<\/span><\/td><td class="supplier"><span class="textIn">{2}<\/span><\/td><td class="specification"><span class="textIn">{3}<\/span><\/td><td class="price"><span class="textIn">{7}<\/span><\/td><td class="site"><span class="textIn">{4}<\/span><\/td><td><button type="button" class="btn btn-info btn-sm" onclick="productDetailModal(\'{0}\',\'{1}\',\'{2}\',\'{3}\',\'{4}\',\'{5}\',{6},\'{7}\',\'{8}\',\'{9}\')">详情<\/button><\/td><td class="plannedConsumption"><span class="textIn">{10}<\/span><\/td><td class="actualConsumption">{11}<\/td><td><button type="button" class="btn btn-danger btn-sm delPlanTr {13}"><i class="fa fa-minus"><\/i><\/button><button type="button" class="btn btn-success btn-sm addPlanTr {14}" style="margin-left:5px"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>',s="",u=0;u<o;u++)i=e[u],_planTrCount++,r=!!_codeData[i.BillId],(r||t)&&(s+=h.format(i.Category,i.Name,i.Supplier,i.Specification,i.Site,i.Code,i.Stock,i.Price,i.Remark,i.ImageList,t?i.PlannedConsumption:i.ActualConsumption,i.ActualConsumption,r?"black":"red",r&&t&&i.ActualConsumption!=0?"hidden":"",r?"":"hidden",i.Id,i.BillId));$("#addPlanBody").append(s);setTableStyle();setTableTrCount($("#addPlanBody"),_planTrCount)}getPriceSum();$("#addPlanTableBtn").attr("disabled",!1)})}function setTableTrCount(n,t){for(var i=0;i<t;i++)n.find(".num").eq(i).text(i+1);$(" #addPlanBody .ms2").select2();$("#addPlanSelect").is(":hidden")?$(" #addPlanTable .actualConsumption").removeClass("hidden"):$(" #addPlanTable .actualConsumption").addClass("hidden")}function setTableSelect(n){var k=n.find(".code select").val(),f=_codeData[k],a=f.CategoryId,v=f.NameId,y=f.SupplierId,s=f.SpecificationId,p=f.SiteId,d=f.Price,h,c,l,b,o;n.find(".category select").val(a).trigger("change");for(var w=_nameData[a],r,u=w.length,e='<option value = "{0}">{1}<\/option>',i="",t=0;t<u;t++)r=w[t],i+=e.format(r.Id,r.Name);for(n.find(".name select").empty().append(i).val(v).trigger("change"),i="",h=_supplierData[v],u=h.length,t=0;t<u;t++)r=h[t],i+=e.format(r.Id,r.Supplier);for(n.find(".supplier select").empty().append(i).val(y).trigger("change"),i="",c=_specificationData[y],u=c.length,t=0;t<u;t++)r=c[t],i+=e.format(r.Id,r.Specification);for(n.find(".specification select").empty().append(i).val(s).trigger("change"),i="",u=_siteData.length,t=0;t<u;t++)l=_siteData[t].Id,b=_siteData[t].Site,_cond[`${s}${l}`]&&(i+=e.format(l,b));for(n.find(".site select").empty().append(i).val(p).trigger("change"),i="",o=_priceData[`${s}${p}`],u=o.length,t=0;t<u;t++)i+=e.format(o[t].Price,o[t].Price);n.find(".price select").empty().append(i).val(d).trigger("change");setTableTrCount($("#addPlanBody"),_planTrCount);getPriceSum()}function setTrSelect(n,t){var i,u,f,e='<option value = "{0}">{1}<\/option>',r,p=n.find(".name select"),tt=n.find(".supplier select"),o=n.find(".specification select"),w=n.find(".price select"),s=n.find(".site select"),b,h,k,c,d,l,g,a,nt,y;if(t===1){for(r="",b=n.find(".category select").val(),h=_nameData[b],f=h.length,i=0;i<f;i++)u=h[i],r+=e.format(u.Id,u.Name);p.empty().append(r)}if(t===1||t===2){for(r="",k=p.val(),c=_supplierData[k],f=c.length,i=0;i<f;i++)u=c[i],r+=e.format(u.Id,u.Supplier);tt.empty().append(r)}if(t===1||t===2||t===3){for(r="",d=n.find(".supplier select").val(),l=_specificationData[d],f=l.length,i=0;i<f;i++)u=l[i],r+=e.format(u.Id,u.Specification);o.empty().append(r)}if(t===1||t===2||t===3||t===4){for(r="",g=o.val(),f=_siteData.length,i=0;i<f;i++)a=_siteData[i].Id,nt=_siteData[i].Site,_cond[`${g}${a}`]&&(r+=e.format(a,nt));s.empty().append(r)}if(t===1||t===2||t===3||t===4||t===5){r="";var it=o.val(),rt=s.val(),ut=`${it}${rt}`,v=_priceData[ut];for(f=v.length,i=0;i<f;i++)r+=e.format(v[i].Price,v[i].Price);w.empty().append(r)}if(t===1||t===2||t===3||t===4||t===5||t===6){for(y in _codeData)if(u=_codeData[y],u.SpecificationId==o.val()&&u.SiteId==s.val()&&u.Price==w.val()){n.find(".code select").val(y).trigger("change");break}getPriceSum()}}function getPriceSum(){for(var u=$("#addPlanBody").find("tr"),r=0,e=u.length,f=0,n,t,i;r<e;r++)n=u.eq(r),n.find(".textIn").is(":hidden")?(t=n.find(".price select").val(),i=n.find(".plannedConsumption input").val()):(t=n.find(".price .textIn").text(),i=n.find(".plannedConsumption .textIn").text()),isStrEmptyOrUndefined(t)&&(t=0),isStrEmptyOrUndefined(i)&&(i=0),f+=parseFloat(t)*parseFloat(i);$("#planCost").text(f.toFixed(2))}function getPlanList(n,t,i,r){var u={};u.opType=700;n&&(u.opData=JSON.stringify({qId:i,first:!0,simple:r}));ajaxPost("/Relay/Post",u,function(i){var r,f;if(i.errno!=0){layer.msg(i.errmsg);return}if(r=i.datas,n)t(r);else{for(var s=r.length,o="",u=0;u<s;u++)f=r[u],o+='<option value = "{0}">{1}<\/option>'.format(f.Id,f.Plan);$(".planSelect").empty().append(o);var h=function(n){var t=n.ActualConsumption,i=n.PlannedConsumption,r=n.ExtraConsumption,u=`<font style="color:{0}">${t}</font>/<font style="color:blue">${i}</font>/<font style="color:{1}">${r}</font>`;return u.format(t==i?"blue":"green",r>0?"red":"black")},c=_permissionList[497].have,l=_permissionList[500].have,a=function(n){var t=`<button type="button" class="btn btn-info btn-sm" onclick="planDetailModal({0})">详情</button>
                    ${l?'<button type="button" class="btn btn-primary btn-sm" style="margin-left:2px" onclick="updatePlanModal({0})">修改<\/button>':""}
                    ${c?'<button type="button" class="btn btn-success btn-sm" style="margin-left:2px" onclick="logModal(false,{0})">日志<\/button>':""}`;return t.format(n.Id)},e=_permissionList[501].have,v=function(n){return e?'<i class="glyphicon glyphicon-remove" aria-hidden="true" style="color:red;font-size:25px;cursor:pointer;text-shadow:2px 2px 2px black" onclick="delPlan({0},\'{1}\')"><\/i>'.format(n.Id,escape(n.Plan)):""};$("#planList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",filename:`计划管理_${getDate()}`,exportOptions:{columns:[1,2,3,4,5,6]}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:r,aaSorting:[[e?1:0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"删除",render:v,visible:e,orderable:!1},{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Plan",title:"计划"},{data:null,title:"领料状态(<font style='color:green'>已<\/font>/<font style='color:blue'>总<\/font>/<font style='color:red'>超<\/font>)",render:h},{data:"Remark",title:"备注"},{data:"PlannedCost",title:"计划造价"},{data:"ActualCost",title:"实际造价"},{data:null,title:"操作",render:a,orderable:!1}]})}})}function delPlan(n,t){t=unescape(t);var i=function(){var t={};t.opType=703;t.opData=JSON.stringify({id:n});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getPlanList(!1)})};showConfirm(`删除生产计划：${t}`,i)}function codeSelect(n){var t={};t.opType=808;ajaxPost("/Relay/Post",t,function(t){var r,i,f;if(t.errno!=0){layer.msg(t.errmsg);return}r=t.datas;_firstCode=r[0];for(var o=r.length,e="",u=0;u<o;u++)i=r[u],f=`${i.SpecificationId}${i.SiteId}`,e+='<option value="{0}" cond="{2}" remark="{3}" img="{4}" stock="{5}">{1}<\/option>'.format(i.Id,i.Code,f,i.Remark,i.ImageList,i.Stock),_codeData[i.Id]=i,_cond[f]=1;isStrEmptyOrUndefined(n)||n(e)},0)}function categorySelect(n){var t={};t.opType=816;ajaxPost("/Relay/Post",t,function(t){var r;if(t.errno!=0){layer.msg(t.errmsg);return}for(var u=t.datas,e=u.length,f="",i=0;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Category);isStrEmptyOrUndefined(n)||n(f)},0)}function siteSelect(n){var t={};t.opType=847;ajaxPost("/Relay/Post",t,function(t){var r,i,f,u;if(t.errno!=0){layer.msg(t.errmsg);return}for(r=t.datas,f=r.length,_siteData=[],i=0;i<f;i++)u=r[i],_siteData.push({Id:u.Id,Site:u.Site});n("success")},0)}function nameSelect(n){var t={};t.opType=824;ajaxPost("/Relay/Post",t,function(t){var u,r,f,i;if(t.errno!=0){layer.msg(t.errmsg);return}for(u=t.datas,f=u.length,_nameData={},r=0;r<f;r++)i=u[r],_nameData[i.CategoryId]||(_nameData[i.CategoryId]=[]),_nameData[i.CategoryId].push({Id:i.Id,Name:i.Name});n("success")},0)}function supplierSelect(n){var t={};t.opType=831;ajaxPost("/Relay/Post",t,function(t){var u,r,f,i;if(t.errno!=0){layer.msg(t.errmsg);return}for(u=t.datas,f=u.length,_supplierData={},r=0;r<f;r++)i=u[r],_supplierData[i.NameId]||(_supplierData[i.NameId]=[]),_supplierData[i.NameId].push({Id:i.Id,Supplier:i.Supplier});n("success")},0)}function specificationSelect(n){var t={};t.opType=839;ajaxPost("/Relay/Post",t,function(t){var u,r,f,i;if(t.errno!=0){layer.msg(t.errmsg);return}for(u=t.datas,f=u.length,_specificationData={},r=0;r<f;r++)i=u[r],_specificationData[i.SupplierId]||(_specificationData[i.SupplierId]=[]),_specificationData[i.SupplierId].push({Id:i.Id,Specification:i.Specification});n("success")},0)}function priceSelect(n){var t={};t.opType=852;ajaxPost("/Relay/Post",t,function(t){var f,r,e,i,u;if(t.errno!=0){layer.msg(t.errmsg);return}for(f=t.datas,_priceData={},r=0,e=f.length;r<e;r++)i=f[r],u=`${i.SpecificationId}${i.SiteId}`,_priceData[u]?_priceData[u].push(i):_priceData[u]=[i];n("success")},0)}function addPlanTr(n){var t='<tr><td><\/td><td class="num" style="font-weight:bold"><\/td><td class="code"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{0}<\/select><\/div><\/td><td class="category"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{1}<\/select><\/div><\/td><td class="name"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{2}<\/select><\/div><\/td><td class="supplier"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{3}<\/select><\/div><\/td><td class="specification"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{4}<\/select><\/div><\/td><td class="price"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{6}<\/select><\/div><\/td><td class="site"><span class="textIn hidden"><\/span><div style="width:140px;margin:auto"><select class="ms2 form-control">{5}<\/select><\/div><\/td><td><button type="button" class="btn btn-info btn-sm pdModal">详情<\/button><\/td><td class="plannedConsumption"><span class="textIn hidden"><\/span><input type="text" class="form-control text-center" value="0" onkeyup="onInput(this, 8, 1)" onblur="onInputEnd(this)" maxlength="10" style="width:140px;margin:auto"><\/td><td class="actualConsumption"><\/td><td style="width:100px"><button type="button" class="btn btn-danger btn-sm delPlanTr"><i class="fa fa-minus"><\/i><\/button><button type="button" class="btn btn-success btn-sm addPlanTr" style="margin-left:5px"><i class="fa fa-plus"><\/i><\/button><\/td><\/tr>',i=new Promise(n=>codeSelect(n)),r=new Promise(n=>categorySelect(n)),u=new Promise(n=>nameSelect(n)),f=new Promise(n=>supplierSelect(n)),e=new Promise(n=>specificationSelect(n)),o=new Promise(n=>siteSelect(n)),s=new Promise(n=>priceSelect(n));Promise.all([i,r,u,f,e,o,s]).then(i=>{var s,h,c,v,l,o,y;_codeOp=i[0];_categoryOp=i[1];_nameOp="";_supplierOp="";_specificationOp="";_priceOp="";_siteOp="";for(var e='<option value = "{0}">{1}<\/option>',a=_nameData[_firstCode.CategoryId],u,f=a.length,r=0;r<f;r++)u=a[r],_nameOp+=e.format(u.Id,u.Name);for(s=_supplierData[_firstCode.NameId],f=s.length,r=0;r<f;r++)u=s[r],_supplierOp+=e.format(u.Id,u.Supplier);for(h=_specificationData[_firstCode.SupplierId],f=h.length,r=0;r<f;r++)u=h[r],_specificationOp+=e.format(u.Id,u.Specification);for(c=_firstCode.SpecificationId,v=_firstCode.SiteId,f=_siteData.length,r=0;r<f;r++)u=_siteData[r],l=u.Id,_cond[`${c}${l}`]&&(_siteOp+=e.format(l,u.Site));for(o=_priceData[`${c}${v}`],f=o.length,r=0;r<f;r++)_priceOp+=e.format(o[r].Price,o[r].Price);y=t.format(_codeOp,_categoryOp,_nameOp,_supplierOp,_specificationOp,_siteOp,_priceOp);n(y)})}function addPlanModal(){$("#addPlanTableBtn").attr("disabled",!0);$("#addPlanModal .addPlan").removeClass("hidden");$("#addPlanModal .updatePlan").addClass("hidden");$("#addPlan").val("");var n=$("#addPlanSelect").find("option").eq(0).val();$("#addPlanSelect").val(n).trigger("change");addUpPlanClass();$("#addPlanModal .modal-title").text("添加新计划");$("#addPlanModal").modal("show")}function addUpPlanClass(n,t){$("#addPlanBody").empty();_planTrCount=0;$("#addRemark").val("");$("#planCost").text("0.00");$("#addPlanTableBtn").removeClass("hidden");$("#addPlanTable").addClass("hidden");new Promise(function(n){addPlanTr(n)}).then(function(i){_planTr=i;n?addUpPlanTable(t,n):$("#addPlanTableBtn").attr("disabled",!1)})}function addPlan(){var f=$("#addPlan").val().trim(),n,i,u,s;if(isStrEmptyOrUndefined(f)){layer.msg("请输入新计划");return}for(var h=$("#addRemark").val().trim(),e={Plan:f,Remark:h},r=[],o=$("#addPlanBody").find("tr"),t=0,c=o.length;t<c;t++){if(n=o.eq(t),n.find(".textIn").is(":hidden")){if(i=n.find(".code select").val(),isStrEmptyOrUndefined(i)){layer.msg(`序列${t+1}：请选择货品编号`);return}u=n.find(".plannedConsumption input").val()}else i=n.find(".num").attr("bill"),u=n.find(".plannedConsumption span").text();r.push({BillId:i,PlannedConsumption:u})}r.length&&(e.Bill=r);s=function(){var n={};n.opType=702;n.opData=JSON.stringify(e);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);$("#addPlanModal").modal("hide");n.errno==0&&getPlanList(!1)})};showConfirm("添加",s)}function planDetailModalData(n){new Promise(function(t){getPlanList(!0,t,n,!1)}).then(function(n){var t=n[0];$("#remarkName").text(t.Remark);$("#plannedCostName").text(t.PlannedCost.toFixed(2));$("#actualCostName").text(t.ActualCost.toFixed(2));var i=t.FirstBill,r=0,u=function(n){var t=`<span style="color:{0}">${++r}</span>`;return t.format(n.Extra?"red":"black")},f=function(n){var t=`<span style="color:{0}">${n.Code}</span>`;return t.format(n.Extra?"red":"black")},e=function(n){return"<button type=\"button\" class=\"btn btn-info btn-sm\" onclick=\"productDetailModal('{0}','{1}','{2}','{3}','{4}','{5}',{6},'{7}','{8}','{9}')\">详情<\/button>".format(escape(n.Category),escape(n.Name),escape(n.Supplier),escape(n.Specification),escape(n.Site),escape(n.Code),n.Stock,escape(n.Price),escape(n.Remark),escape(n.ImageList))},o=function(n){var t=n.ActualConsumption,i=n.PlannedConsumption,r=`<span style="color:{0}">${t}</span>`;return r.format(t===0?"black":t>i?"red":"green")};$("#planDetailList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",exportOptions:{columns:[0,1,2,3,4,5,6,8,9]}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:u},{data:null,title:"货品编号",render:f},{data:"Category",title:"货品类别"},{data:"Name",title:"货品名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Price",title:"价格"},{data:null,title:"货品详情",render:e},{data:"PlannedConsumption",title:"计划用量"},{data:null,title:"实际用量",render:o}]})})}function planDetailModal(n){$("#PlanDetailSelect").val(n).trigger("change");planDetailModalData(n);$("#planDetailModal").modal("show")}function productDetailModal(n,t,i,r,u,f,e,o,s,h){if(n=unescape(n),t=unescape(t),i=unescape(i),r=unescape(r),u=unescape(u),f=unescape(f),s=unescape(s),$("#productCategory").text(n),$("#productName").text(t),$("#productSupplier").text(i),$("#productSpecification").text(r),$("#productSite").text(u),$("#productCode").text(f),$("#productStock").text(e),$("#productPrice").text(o),$("#productRemark").text(s),h=unescape(h),$("#imgLabel").empty(),$("#productImg").empty(),isStrEmptyOrUndefined(h))$("#imgLabel").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgLabel").append("图片：");h=h.split(",");var c={type:fileEnum.Material,files:JSON.stringify(h)};ajaxPost("/Upload/Path",c,function(n){var r,i,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(r='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><\/div><\/div>',i="",t=0;t<n.data.length;t++)i+=r.format(n.data[t].path);$("#productImg").append(i)})}$("#productDetailModal").modal("show")}function updatePlanModal(n){$("#addPlanTableBtn").attr("disabled",!0);$("#addPlanModal .addPlan").addClass("hidden");$("#addPlanModal .updatePlan").removeClass("hidden");addUpPlanClass(!0,n);$("#updatePlanSelect").val(n).trigger("change");$("#updatePlanName").val($("#updatePlanSelect :selected").text());$("#addPlanModal .modal-title").text("修改计划");$("#addPlanModal").modal("show")}function updatePlan(){for(var c=$("#updatePlanSelect").val(),l=$("#updatePlanName").val().trim(),a=$("#addRemark").val().trim(),o={id:c,Plan:l,Remark:a},r=[],s=$("#addPlanBody").find("tr"),t=0,v=s.length,n,i,u,f,e,h;t<v;t++){if(n=s.eq(t),n.find(".textIn").is(":hidden")){if(i=n.find(".code select").val(),isStrEmptyOrUndefined(i)){layer.msg(`序列${t+1}：请选择货品编号`);return}u=n.find(".plannedConsumption input").val()}else i=n.find(".num").attr("bill"),u=n.find(".plannedConsumption span").text();f={BillId:i,PlannedConsumption:u};e=n.find(".num").attr("list");e&&(f.Id=parseInt(e));r.push(f)}r.length&&(o.Bill=r);h=function(){var n={};n.opType=701;n.opData=JSON.stringify(o);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);$("#addPlanModal").modal("hide");n.errno==0&&getPlanList(!1)})};showConfirm("修改",h)}function logPlanSelect(n){var t={};t.opType=700;ajaxPost("/Relay/Post",t,function(t){var r;if(t.errno!=0){layer.msg(t.errmsg);return}for(var u=t.datas,e=u.length,f="",i=0;i<e;i++)r=u[i],f+='<option value = "{0}">{1}<\/option>'.format(r.Id,r.Plan);n(f)})}function logModal(n,t){var i=new Promise(n=>logPlanSelect(n)),r=new Promise(n=>codeSelect(n));Promise.all([i,r]).then(i=>{var u=i[0],f=i[1],r;$("#logPlanSelect").empty();$("#logBillSelect").empty();r='<option value="0">所有<\/option>';n&&$("#logPlanSelect").append(r);$("#logPlanSelect").append(u);t&&$("#logPlanSelect").val(t).trigger("change");$("#logBillSelect").append(r);$("#logBillSelect").append(f);getLogList()});$("#logModal").modal("show")}function getLogList(){var t=$("#logStartDate").val(),i,u,f,r,n,e;if(isStrEmptyOrUndefined(t)){layer.msg("请选择开始时间");return}if(i=$("#logEndDate").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择结束时间");return}if(exceedTime(t)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(t,i)){layer.msg("结束时间不能小于开始时间");return}if(t+=" 00:00:00",i+=" 23:59:59",u={startTime:t,endTime:i,isPlan:1,type:$("#logPlanType").val()},f=$("#logPlanSelect").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择计划号");return}if(f!=0&&(u.planId=parseInt(f)),r=$("#logBillSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品编号");return}r!=0?(u.billId=parseInt(r),n=_codeData[r],$("#logCategory").text(n.Category),$("#logName").text(n.Name),$("#logSpecification").text(n.Specification),$("#logSupplier").text(n.Supplier),$("#logPrice").text(n.Price),$("#billInfo").removeClass("hidden")):$("#billInfo").addClass("hidden");e={};e.opType=803;e.opData=JSON.stringify(u);ajaxPost("/Relay/Post",e,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=n.datas,i=n=>n===1?'<span style="color:red">退回<\/span>':n===2?'<span style="color:green">领用<\/span>':"";$("#logList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Time",title:"时间"},{data:"Type",title:"类型",render:i},{data:"Purpose",title:"计划号"},{data:"Code",title:"货品编号"},{data:"Category",title:"类别"},{data:"Name",title:"名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Price",title:"单价"},{data:"Number",title:"数量"},{data:"RelatedPerson",title:"领用人"},{data:"Manager",title:"物管员"}]})})}function showPlanTransferModal(){const n=$("#planSelectFrom option:first").val();$("#planSelectFrom").val(n).trigger("change").trigger("select2:select");$("#planSelectTo").val(n).trigger("change");$("#planTransferModal").modal("show")}function planTransfer(){const t=$("#planSelectFrom").val();if(isStrEmptyOrUndefined(t))return layer.msg("请选择源计划");const i=$("#planSelectTo").val();if(isStrEmptyOrUndefined(i))return layer.msg("请选择目标计划");const n=[];if($($("#planTransferList").DataTable().columns(0).nodes()[0]).find(".checkBox").each((t,i)=>{const r=$(i);r.is(":checked")&&n.push(r.val())}),!n.length)return layer.msg("请选择需要转移的数据");const r=function(){const r={opType:705,opData:JSON.stringify({FromId:t,ToId:i,Bill:n})};ajaxPost("/Relay/Post",r,n=>{layer.msg(n.errmsg),n.errno==0&&($("#planTransferModal").modal("hide"),getPlanList(!1))})};showConfirm("转移",r)}var _permissionList=[],_planTr=null,_codeData={},_cond={},_firstCode=null,_siteData=null,_nameData=null,_supplierData=null,_specificationData=null,_priceData=null,_codeOp,_categoryOp,_nameOp,_supplierOp,_specificationOp,_priceOp,_siteOp,_planTrCount=0;