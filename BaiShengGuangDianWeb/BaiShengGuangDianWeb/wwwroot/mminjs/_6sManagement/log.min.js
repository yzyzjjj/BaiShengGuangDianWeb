function pageReady(){_permissionList[627]={uIds:["reportBtn"]};_permissionList[628]={uIds:["updateImgBtn"]};_permissionList[629]={uIds:["groupRankBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();$("#_6sCondition1").on("change",function(){$("#_6sCondition2").empty();var n=$(this).val(),t="";n==0?t=`<option value="0">等于</option>`:n==1?t=`<option value="0">等于</option>
                <option value="1">包含</option>`:n==2?t=`<option value="0">等于</option>
                <option value="1">大于</option>
                <option value="2">小于</option>`:n==3&&(t=`<option value="0">等于</option>
                <option value="1">大于</option>
                <option value="2">小于</option>`);$("#_6sCondition2").append(t);$("#_6sConditionDiv div").addClass(" hidden");$("#_6sConditionDiv ."+n).removeClass(" hidden")});$("#_6sItemTime").val(getDate());$("#_6sItemTime").datepicker("update").on("changeDate",function(){showItem()});$("#_6sItemCheckTime1").val(getDate());$("#_6sItemCheckTime1").datepicker("update").on("changeDate",function(){getItemList()});$("#_6sItemCheckTime2").val(getDate());$("#_6sItemCheckTime2").datepicker("update").on("changeDate",function(){getItemList()});$("#6sGroupSelect").on("select2:select",function(){getItemList()});$("#_6sItemPerson").on("select2:select",function(){showItem()});init();$("#_6sGroupRankTime1").val(getDate());$("#_6sGroupRankTime1").datepicker("update").on("changeDate",function(){groupRank(!1,!1)});$("#_6sGroupRankTime2").val(getDate());$("#_6sGroupRankTime2").datepicker("update").on("changeDate",function(){groupRank(!1,!1)});$("#_6sGroupPersonRankTime1").val(getDate());$("#_6sGroupPersonRankTime1").datepicker("update").on("changeDate",function(){var n=$("#_6sGroupGroupId").html(),t=$("#_6sGroupGroup").html();groupPersonRank(n,t,!1,!1)});$("#_6sGroupPersonRankTime2").val(getDate());$("#_6sGroupPersonRankTime2").datepicker("update").on("changeDate",function(){var n=$("#_6sGroupGroupId").html(),t=$("#_6sGroupGroup").html();groupPersonRank(n,t,!1,!1)});$("#_6sGroupPersonItemRankTime1").val(getDate());$("#_6sGroupPersonItemRankTime1").datepicker("update").on("changeDate",function(){var n=$("#_6sGroupGroupId").html(),t=$("#_6sGroupPersonId").html();groupPersonItemRank(n,t,!1,!1)});$("#_6sGroupPersonItemRankTime2").val(getDate());$("#_6sGroupPersonItemRankTime2").datepicker("update").on("changeDate",function(){var n=$("#_6sGroupGroupId").html(),t=$("#_6sGroupPersonId").html();groupPersonItemRank(n,t,!1,!1)});$("#imgOldList").on("click",".delImg",function(){$(this).parents(".imgOption").remove();var n=$(this).val();_imgNameData.splice(_imgNameData.indexOf(n),1)})}function init(){var n=new Promise(function(n){getGroupList(n)}),t=new Promise(function(n){getSurveyorList(n)});Promise.all([n,t]).then(()=>{getItemList()})}function getGroupList(n){var t={};t.opType=900;ajaxPost("/Relay/Post",t,function(t){var i,u;if(n!=null&&n("success"),t.errno!=0){layer.msg(t.errmsg);return}$("#6sGroupSelect").empty();i=t.datas;_groups=i;for(var e=i.length,f="",r=0;r<e;r++)u=i[r],f+='<option value = "{0}">{1}<\/option>'.format(u.Id,u.Group);$("#6sGroupSelect").append(f)})}function getSurveyorList(n){var t={};t.opType=254;ajaxPost("/Relay/Post",t,function(t){var i,u;if(n!=null&&n("success"),t.errno!=0){layer.msg(t.errmsg);return}i=t.datas;_surveyors=i;for(var e=i.length,f="",r=0;r<e;r++)u=i[r],f+='<option value = "{0}">{1}<\/option>'.format(u.Id,u.SurveyorName);_surveyorOptions=f})}function getItemList(){var t;$("#6sGroupScore").html(0);$("#6sGroupAll").html(0);$("#6sGroupCount").html(0);$("#itemList").empty();var n=$("#6sGroupSelect").val(),i=$("#_6sItemCheckTime1").val(),r=$("#_6sItemCheckTime2").val();isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(i)||isStrEmptyOrUndefined(r)||(t={},t.opType=920,t.opData=JSON.stringify({gId:n,sTime:i,eTime:r}),ajaxPost("/Relay/Post",t,function(t){var i,o,r;if(t.errno!=0){layer.msg(t.errmsg);return}if(items=t.datas,lastGroupId!=n){$("#_6sItemPerson").empty();var u=[],f='<option value="{0}">{0}<\/option>',e=f.format("所有");for(i=0;i<items.length;i++)o=items[i],r=o.PersonName,u.indexOf(r)==-1&&(u.push(r),e+=f.format(r));$("#_6sItemPerson").append(e)}lastGroupId=n;showItem()}))}function showItem(){var f=$("#_6sCondition1").val(),e=$("#_6sCondition2").val(),r="",n="",u,t,i;switch(f){case"0":r="PersonName";n=$("#_6sItemPerson").val();break;case"1":r="Item";n=$("#_6sItemName").val();break;case"2":if(r="CheckTime",n=$("#_6sItemTime").val(),n=="")return;break;case"3":r="Score";n=$("#_6sItemScore").val()}if(items){for(showItems=[],u=0;u<items.length;u++)if(t=items[u],i=t[r],r=="CheckTime"&&(i=i.Check?i.split(" ")[0]:""),e==0)if(f!=0){if(n==""){showItems.push(t);continue}i==n&&showItems.push(t)}else n!="所有"?i==n&&showItems.push(t):showItems.push(t);else e==1?f!=1?i>n&&showItems.push(t):i.indexOf(n)>-1&&showItems.push(t):e==2&&i<n&&showItems.push(t);initItemList()}}function initItemList(){var n,t;$("#itemList").empty();var i=0,r=0,u=0;if(showItems&&showItems.length>0){for(r=showItems.length,n=0;n<showItems.length;n++)t=showItems[n],t.Check&&(i+=t.Score,u++);var f=function(n,t,i,r){var u=r.row;return`<input type="checkbox" value="${u}" class="icb_minimal chose" id="itemChose${u}">`},e=function(n,t,i,r){return++r.row},o=function(n){return n.length>tdShowLength?`<span title="${n}" onclick = "showAllContent('${escape(n)}', '要求及目标')">${n.substring(0,tdShowLength)}...</span>`:`<span title="${n}">${n}</span>`},s=function(n){return`<span>${n.Interval==0?"":n.Interval==1?`${n.Day}天/次`:`${n.Week}周/次`}</span>`},h=function(n){return n.PlannedTime.slice(0,n.PlannedTime.indexOf(" "))},c=function(n,t,i,r){var u=r.row;return`<span title="${n.SurveyorName}" class="chose1">${n.SurveyorName}</span>
                    <div class="chose2 hidden">
                        <select class="ms2 form-control" id="itemSurveyor${u}" old="${n.SurveyorId}" style="width:60px">
                            ${_surveyorOptions}
                        </select>
                    </div>`},l=function(n,t,i,r){var u=r.row;return`<span class="chose1">${n.Check?n.CheckTime.slice(0,n.CheckTime.indexOf(" ")):""}</span>`+`<input class="chose2 hidden form_date form-control text-center" type="text" itemId="${n.Id}" itemName="${n.Item}" id="itemCheckTime${u}" style="width:120px;cursor: pointer">`},a=function(n,t,i,r){var u=r.row;return`<span class="chose1">${n.Score}</span>`+`<input class="chose2 hidden form-control text-center" id="itemScore${u}" old="${n.Score}" style="width:80px;" type="tel" onkeyup="onInput(this, 8, 0)" onblur="onInputEnd(this)" maxlength="10">`},v=function(n,t,i,r){var u=r.row;return(n.Desc.length>tdShowLength?`<span title="${n.Desc}" class="chose1" onclick = "showAllContent('${escape(n.Desc)}', '评语')">${n.Desc.substring(0,tdShowLength)}...</span>`:`<span title="${n.Desc}" class="chose1">${n.Desc}</span>`)+`<textarea class="chose2 hidden form-control" id="itemDesc${u}" old="${n.Desc}" maxlength = "500" style="resize: vertical;width:100%;margin:auto"></textarea>`},y=function(n){var t='<span id="imgFlag{2}" class="glyphicon glyphicon-{0}" aria-hidden="true" style="color:{1};font-size:25px;vertical-align:middle;margin-right:5px"><\/span><button id="imgBtn{2}" type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="showImgModel({2},\'{3}\',\'{4}\')">查看<\/button>';return n.ImageList.length?t.format("ok","green",n.Id,escape(n.Item),escape(n.ImageList)):t.format("remove","red",n.Id,escape(n.Item),escape(n.ImageList))},p=[4,10];$("#itemList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",exportOptions:{columns:[1,2,3,4,5,6,7,8,9,10,11,13],format:{body:(n,t,i,r)=>p.indexOf(i)>-1?$(r).find("span").attr("title"):r.textContent}}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:items,bAutoWidth:!1,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"选择",render:f},{data:null,title:"序号",render:e,sWidth:"20px"},{data:"Item",title:"检查项目"},{data:"Standard",title:"标准分",sWidth:"20px"},{data:"Reference",title:"要求及目标",render:o},{data:null,title:"频次",render:s},{data:"PersonName",title:"负责人"},{data:null,title:"截止日期",render:h},{data:null,title:"检验员",render:c},{data:null,title:"检查日期",render:l},{data:null,title:"评分",render:a},{data:null,title:"评语",render:v,sClass:"no-padding"},{data:null,title:"图片",render:y},{data:"ModifyName",title:"修改人"}],createdRow:function(n){var t=$(n).find(".form_date");t.attr("readonly",!0).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});t.val(getDate()).datepicker("update")},drawCallback:function(){$(this).find(".ms2").select2({width:"120px"});$(this).find(".chose").iCheck({labelHover:!1,cursor:!0,checkboxClass:"icheckbox_minimal-red",increaseArea:"20%"});$(this).find(".chose").on("ifChanged",function(){var t=$(this).parents("tr:first"),n=$(this).attr("value"),i;$(this).is(":checked")?(t.find(".chose1").addClass("hidden"),t.find(".chose2").removeClass("hidden"),i=$("#itemSurveyor"+n).attr("old"),$("#itemSurveyor"+n).val(i).trigger("change"),$("#itemScore"+n).val($("#itemScore"+n).attr("old")),$("#itemDesc"+n).html($("#itemDesc"+n).attr("old"))):(t.find(".chose1").removeClass("hidden"),t.find(".chose2").addClass("hidden"))})}})}$("#6sGroupAll").html(r);$("#6sGroupCount").html(u);$("#6sGroupScore").html(i)}function report(){for(var o,i=[],u=[],n=0;n<showItems.length;n++)if($("#itemChose"+n).length>0&&$("#itemChose"+n).is(":checked")){var r=$("#itemSurveyor"+n).val(),s=$("#itemCheckTime"+n).attr("itemId"),h=$("#itemCheckTime"+n).attr("itemName"),f=$("#itemCheckTime"+n).val(),t=$("#itemScore"+n).val(),e=$("#itemDesc"+n).val();if(isStrEmptyOrUndefined(t)&&!isStrEmptyOrUndefined(e)){layer.msg("请输入评分");return}if(isStrEmptyOrUndefined(t)&&!isStrEmptyOrUndefined(r)){layer.msg("请输入评分");return}if(!isStrEmptyOrUndefined(t)){if(isStrEmptyOrUndefined(f)){layer.msg("请选择检查时间");return}if(isStrEmptyOrUndefined(r)){layer.msg("请选择检验员");return}u.push(h);i.push({Id:s,SurveyorId:r,CheckTime:f,Score:t,Desc:e,ModifyName:getCookieTokenInfo().name,ModifyAccount:getCookieTokenInfo().account})}}i.length!=0&&(o=function(){var n={};n.opType=921;n.opData=JSON.stringify(i);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getItemList()})},showConfirm("修改以下检查项:<\/br>"+u.join(",<\/br>"),o))}function showImgModel(n,t,i){var r,u;if(tid=n,titem=t,timg=i,_imgUpload==null&&(_imgUpload=initFileInputMultiple("addImg",fileEnum._6s)),$("#addImg").fileinput("clear"),$("#checkId").text(n),t=unescape(t),$("#checkName").text(t),i=unescape(i),$("#imgOld").empty(),$("#imgOldList").empty(),_imgNameData=[],isStrEmptyOrUndefined(i))$("#imgOld").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgOld").append("图片：");i=i.split(",");_imgNameData=i;r={type:fileEnum._6s,files:JSON.stringify(i)};r.dir="";for(u in fileEnum)if(fileEnum[u]==r.type){r.dir=u;break}if(isStrEmptyOrUndefined(r.dir))return void layer.msg("文件类型不存在！");getFilePath(r,n=>{var f,r,t;const u=n.length;if(!(u<=0)){for(f=`<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6">
                        <div class="thumbnail">
                        <img src={0} style="height:200px" onclick="showBigImg('{0}')">
                        <div class="caption text-center">
                            <button type="button" class="btn btn-default glyphicon glyphicon-trash delImg" value="{1}"></button>
                        </div>
                        </div>
                    </div>`,r="",t=0;t<u;t++)r+=f.format(n[t].path,i[t]);$("#imgOldList").append(r)}})}$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");$("#showImgModel").modal("show")}function updateImg(){fileCallBack[fileEnum._6s]=function(n){var i,f;if(n.errno==0){i=[];for(f in n.data)i.push(n.data[f].newName);var r=_imgNameData.concat(i),e=r.length,o=JSON.stringify(r),t=$("#checkId").text(),u={};u.opType=921;u.opData=JSON.stringify([{UpdateImage:!0,Images:o,Id:t,ModifyName:getCookieTokenInfo().name,ModifyAccount:getCookieTokenInfo().account}]);ajaxPost("/Relay/Post",u,function(n){layer.msg(n.errmsg);$("#showImgModel").modal("hide");n.errno==0&&(_imgNameData=r,e>0?($("#imgFlag"+t).removeClass("glyphicon-remove"),$("#imgFlag"+t).addClass("glyphicon-ok"),$("#imgFlag"+t).css("color","green"),$("#imgBtn"+t).attr("onclick","showImgModel({0},'{1}','{2}')".format(tid,titem,escape(_imgNameData)))):($("#imgFlag"+t).removeClass("glyphicon-ok"),$("#imgFlag"+t).addClass("glyphicon-remove"),$("#imgFlag"+t).css("color","red"),$("#imgBtn"+t).attr("onclick","showImgModel({0},'{1}','{2}')".format(tid,titem,""))))})}};var n=function(){$("#addImg").fileinput("upload")};showConfirm("操作",n)}function groupRank(n=true,t=true){var r,u,i;t&&($("#_6sGroupRankTime1").val($("#_6sItemCheckTime1").val()),$("#_6sGroupRankTime1").datepicker("update"),$("#_6sGroupRankTime2").val($("#_6sItemCheckTime2").val()),$("#_6sGroupRankTime2").datepicker("update"));$("#_6sGroupRankList").empty();r=$("#_6sGroupRankTime1").val();u=$("#_6sGroupRankTime2").val();isStrEmptyOrUndefined(r)||isStrEmptyOrUndefined(u)||(i={},i.opType=930,i.opData=JSON.stringify({sTime:r,eTime:u}),ajaxPost("/Relay/Post",i,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}var i=function(n,t,i,r){return++r.row},r=function(n){return`<button type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="groupPersonRank(${n.Id}, '${n.Group}')">查看</button>`};$("#_6sGroupRankList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,bAutoWidth:!1,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"排名",render:i,sWidth:"20px"},{data:"Group",title:"分组"},{data:"Score",title:"评分"},{data:null,title:"详情",render:r}]});n&&$("#_6sGroupRankModel").modal("show")}))}function groupPersonRank(n,t,i=true,r=true){var f,e,u;r&&($("#_6sGroupPersonRankTime1").val($("#_6sGroupRankTime1").val()),$("#_6sGroupPersonRankTime1").datepicker("update"),$("#_6sGroupPersonRankTime2").val($("#_6sGroupRankTime2").val()),$("#_6sGroupPersonRankTime2").datepicker("update"));$("#_6sGroupGroup").html(t);$("#_6sGroupGroupId").html(n);$("#_6sGroupPersonRankList").empty();f=$("#_6sGroupPersonRankTime1").val();e=$("#_6sGroupPersonRankTime2").val();isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(f)||isStrEmptyOrUndefined(e)||(u={},u.opType=931,u.opData=JSON.stringify({gId:n,sTime:f,eTime:e}),ajaxPost("/Relay/Post",u,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}var r=function(n,t,i,r){return++r.row},u=function(t){return`<button type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="groupPersonItemRank(${n}, ${t.Id})">查看</button>`};$("#_6sGroupPersonRankList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t.datas,bAutoWidth:!1,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"排名",render:r,sWidth:"20px"},{data:"SurveyorName",title:"员工"},{data:"Score",title:"评分"},{data:null,title:"详情",render:u}]});i&&$("#_6sGroupPersonRankModel").modal("show")}))}function groupPersonItemRank(n,t,i=true,r=true){var f,e,u;r&&($("#_6sGroupPersonItemRankTime1").val($("#_6sGroupPersonRankTime1").val()),$("#_6sGroupPersonItemRankTime1").datepicker("update"),$("#_6sGroupPersonItemRankTime2").val($("#_6sGroupPersonRankTime2").val()),$("#_6sGroupPersonItemRankTime2").datepicker("update"));$("#_6sGroupPersonId").html(t);$("#_6sGroupPersonItemList").empty();f=$("#_6sGroupPersonItemRankTime1").val();e=$("#_6sGroupPersonItemRankTime2").val();isStrEmptyOrUndefined(n)||isStrEmptyOrUndefined(f)||isStrEmptyOrUndefined(e)||(u={},u.opType=920,u.opData=JSON.stringify({gId:n,pId:t,sTime:f,eTime:e}),ajaxPost("/Relay/Post",u,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=function(n,t,i,r){return++r.row},r=function(n){return n.length>tdShowLength?`<span title="${n}" onclick = "showAllContent('${escape(n)}', '要求及目标')">${n.substring(0,tdShowLength)}...</span>`:`<span title="${n}">${n}</span>`},u=function(n){return`<span>${n.Interval==0?"":n.Interval==1?`${n.Day}天/次`:`${n.Week}周/次`}</span>`},f=function(n){return`<span>${n.PlannedTime.slice(0,n.PlannedTime.indexOf(" "))}</span>`},e=function(n){return`<span>${n.Check?n.CheckTime.slice(0,n.CheckTime.indexOf(" ")):""}</span>`},o=function(n){return n.length>tdShowLength?`<span title="${n}" onclick = "showAllContent('${escape(n)}', '评语')">${n.substring(0,tdShowLength)}...</span>`:`<span title="${n}">${n}</span>`},s=function(n){var t='<span class="glyphicon glyphicon-{0}" aria-hidden="true" style="color:{1};font-size:25px;vertical-align:middle;margin-right:5px"><\/span><button type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="showImgModel({2},\'{3}\',\'{4}\', {5})">查看<\/button>';return n.ImageList.length?t.format("ok","green",n.Id,escape(n.Item),escape(n.ImageList),!0):t.format("remove","red",n.Id,escape(n.Item),escape(n.ImageList),!0)},h=[3,10];$("#_6sGroupPersonItemList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",exportOptions:{columns:[0,1,2,3,4,5,6,7,8,9,10,12],format:{body:(n,t,i,r)=>h.indexOf(i)>-1?$(r).find("span").attr("title"):r.textContent}}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,bAutoWidth:!1,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:t,sWidth:"20px"},{data:"Item",title:"检查项目"},{data:"Standard",title:"标准分",sWidth:"20px"},{data:"Reference",title:"要求及目标",render:r},{data:null,title:"频次",render:u},{data:"PersonName",title:"负责人"},{data:null,title:"截止日期",render:f},{data:"SurveyorName",title:"检验员"},{data:null,title:"检查日期",render:e},{data:"Score",title:"评分"},{data:"Desc",title:"评语",render:o,sClass:"no-padding"},{data:null,title:"图片",render:s},{data:"ModifyName",title:"修改人"}]});i&&$("#_6sGroupPersonItemRankModel").modal("show")}))}var _permissionList=[],_groups=null,_surveyors=null,_surveyorOptions="",lastGroupId=0,items=null,showItems=null,_imgNameData=null,_imgUpload=null,tid,titem,timg;