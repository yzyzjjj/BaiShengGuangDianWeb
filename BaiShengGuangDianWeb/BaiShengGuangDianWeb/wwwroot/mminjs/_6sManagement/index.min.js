function pageReady(){_permissionList[621]={uIds:["reportBtn"]};_permissionList[622]={uIds:["updateImgBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();$("#_6sCondition1").on("change",function(){$("#_6sCondition2").empty();var n=$(this).val(),t="";n==0?t=`<option value="0">等于</option>`:n==1?t=`<option value="0">等于</option>
                <option value="1">包含</option>`:n==2?t=`<option value="0">等于</option>
                <option value="1">大于</option>
                <option value="2">小于</option>`:n==3&&(t=`<option value="0">等于</option>
                <option value="1">大于</option>
                <option value="2">小于</option>`);$("#_6sCondition2").append(t);$("#_6sConditionDiv div").addClass(" hidden");$("#_6sConditionDiv ."+n).removeClass(" hidden")});$("#_6sItemTime").val(getDate());$("#_6sItemTime").datepicker("update").on("changeDate",function(){showItem()});$("#6sGroupSelect").on("select2:select",function(){getItemList()});$("#_6sItemPerson").on("select2:select",function(){showItem()});init();$("#imgOldList").on("click",".delImg",function(){$(this).parents(".imgOption").remove();var n=$(this).val();_imgNameData.splice(_imgNameData.indexOf(n),1)})}function init(){var n=new Promise(function(n){getGroupList(n)});Promise.all([n]).then(()=>{getItemList()})}function getGroupList(n){var t={};t.opType=900;t.opData=JSON.stringify({account:getCookieTokenInfo().account});ajaxPost("/Relay/Post",t,function(t){var i,u;if(n!=null&&n("success"),t.errno!=0){layer.msg(t.errmsg);return}$("#6sGroupSelect").empty();i=t.datas;_groups=i;for(var e=i.length,f="",r=0;r<e;r++)u=i[r],f+='<option value = "{0}">{1}<\/option>'.format(u.Id,u.Group);$("#6sGroupSelect").append(f)})}function getItemList(){var n,t;$("#6sGroupScore").html(0);$("#6sGroupAll").html(0);$("#6sGroupCount").html(0);$("#itemList").empty();n=$("#6sGroupSelect").val();isStrEmptyOrUndefined(n)||(t={},t.opType=910,t.opData=JSON.stringify({gId:n}),ajaxPost("/Relay/Post",t,function(t){var i,o,r;if(t.errno!=0){layer.msg(t.errmsg);return}if(items=t.datas,showItems=items,lastGroupId!=n){$("#_6sItemPerson").empty();var u=[],f='<option value="{0}">{0}<\/option>',e=f.format("所有");for(i=0;i<items.length;i++)o=items[i],r=o.PersonName,u.indexOf(r)==-1&&(u.push(r),e+=f.format(r));$("#_6sItemPerson").append(e)}lastGroupId=n;showItem()}))}function showItem(){var f=$("#_6sCondition1").val(),e=$("#_6sCondition2").val(),r="",n="",u,t,i;switch(f){case"0":r="PersonName";n=$("#_6sItemPerson").val();break;case"1":r="Item";n=$("#_6sItemName").val();break;case"2":if(r="PlannedTime",n=$("#_6sItemTime").val(),n=="")return;break;case"3":r="Score";n=$("#_6sItemScore").val()}if(items){for(showItems=[],u=0;u<items.length;u++)if(t=items[u],i=t[r],r=="PlannedTime"&&(i=i.split(" ")[0]),e==0)if(f!=0){if(n==""){showItems.push(t);continue}i==n&&showItems.push(t)}else n!="所有"?i==n&&showItems.push(t):showItems.push(t);else e==1?f!=1?i>n&&showItems.push(t):i.indexOf(n)>-1&&showItems.push(t):e==2&&i<n&&showItems.push(t);initItemList()}}function initItemList(){var n,t;$("#itemList").empty();var i=0,r=0,u=0;if(showItems&&showItems.length>0){for(r=showItems.length,n=0;n<showItems.length;n++)t=showItems[n],t.Check&&(i+=t.Score,u++);var f=0,e=function(n,t,i,r){return f=r.row+1},o=function(n,t,i,r){var u=r.row;return n.length>tdShowLength?`<span title="${n}" class="chose1" onclick = "showAllContent('${escape(n)}', '要求及目标')">${n.substring(0,tdShowLength)}...</span>`:`<span title="${n}" class="chose1">${n}</span>`},s=function(n){return`<span>${n.Interval==0?"":n.Interval==1?`${n.Day}天/次`:`${n.Week}周/次`}</span>`},h=function(n){return n.PlannedTime.slice(0,n.PlannedTime.indexOf(" "))},c=function(n,t,i,r){var u=r.row;return n.Check?n.CheckTime.slice(0,n.CheckTime.indexOf(" ")):`<input type="text" itemId="${n.Id}" itemName="${n.Item}" itemCheck="${n.Check}" id="itemCheckTime${u}" class="form_date form-control text-center" style="width:120px;cursor: pointer">`},l=function(n,t,i,r){var u=r.row;return n.Check?`<span>${n.Score}</span>`:`<input class="form-control text-center" id="itemScore${u}" style="width:80px;" type="tel" onkeyup="onInput(this, 8, 0)" onblur="onInputEnd(this)" maxlength="10">`},a=function(n,t,i,r){var u=r.row;return n.Check?n.Desc.length>tdShowLength?`<span title="${n.Desc}" class="chose1" onclick = "showAllContent('${escape(n.Desc)}', '评语')">${n.Desc.substring(0,tdShowLength)}...</span>`:`<span title="${n.Desc}" class="chose1">${n.Desc}</span>`:`<textarea class="form-control" id="itemDesc${u}" maxlength = "500" style="resize: vertical;width:100%;margin:auto"></textarea>`},v=function(n){var t='<span id="imgFlag{2}" class="glyphicon glyphicon-{0}" aria-hidden="true" style="color:{1};font-size:25px;vertical-align:middle;margin-right:5px"><\/span><button id="imgBtn{2}" type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="showImgModel({2},\'{3}\',\'{4}\')">查看<\/button>';return n.ImageList.length?t.format("ok","green",n.Id,escape(n.Item),escape(n.ImageList)):t.format("remove","red",n.Id,escape(n.Item),escape(n.ImageList))};$("#itemList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:showItems,bAutoWidth:!1,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:e,sWidth:"20px"},{data:"PersonName",title:"负责人"},{data:"Item",title:"检查项目"},{data:"Standard",title:"标准分",sWidth:"20px"},{data:null,title:"评分",render:l},{data:null,title:"评语",render:a,sClass:"no-padding"},{data:null,title:"图片",render:v},{data:"Reference",title:"要求及目标",render:o},{data:null,title:"频次",render:s},{data:null,title:"截止日期",render:h,sClass:"text-red"},{data:null,title:"检查日期",render:c}],createdRow:function(n){var t=$(n).find(".form_date");t.attr("readonly",!0).datepicker({language:"zh-CN",format:"yyyy-mm-dd",maxViewMode:2,todayBtn:"linked",autoclose:!0});t.val(getDate()).datepicker("update")}})}$("#6sGroupAll").html(r);$("#6sGroupCount").html(u);$("#6sGroupScore").html(i)}function report(){var t=[],r=[],n,o;if(showItems!=null){for(n=0;n<showItems.length;n++){var u=$("#itemCheckTime"+n).attr("itemCheck"),s=$("#itemCheckTime"+n).attr("itemId"),h=$("#itemCheckTime"+n).attr("itemName"),f=$("#itemCheckTime"+n).val(),i=$("#itemScore"+n).val(),e=$("#itemDesc"+n).val();if(u&&u=="false"){if(isStrEmptyOrUndefined(i)&&!isStrEmptyOrUndefined(e)){layer.msg("请输入评分");return}if(!isStrEmptyOrUndefined(i)){if(isStrEmptyOrUndefined(f)){layer.msg("请选择检查时间");return}r.push(h);t.push({Id:s,SurveyorAccount:getCookieTokenInfo().account,CheckTime:f,Score:i,Desc:e})}}}t.length!=0&&(o=function(){var n={};n.opType=911;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getItemList()})},showConfirm("保存以下检查项:<\/br>"+r.join(",<\/br>"),o))}}function showImgModel(n,t,i){if(tid=n,titem=t,timg=i,_imgUpload==null&&(_imgUpload=initFileInputMultiple("addImg",fileEnum._6s)),$("#addImg").fileinput("clear"),$("#checkId").text(n),t=unescape(t),$("#checkName").text(t),i=unescape(i),$("#imgOld").empty(),$("#imgOldList").empty(),_imgNameData=[],isStrEmptyOrUndefined(i))$("#imgOld").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgOld").append("图片：");i=i.split(",");_imgNameData=i;var r={type:fileEnum._6s,files:JSON.stringify(i)};ajaxPost("/Upload/Path",r,function(n){var u,r,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(u=`<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6">
                        <div class="thumbnail">
                        <img src={0} style="height:200px" onclick="showBigImg('{0}')">
                        <div class="caption text-center">
                            <button type="button" class="btn btn-default glyphicon glyphicon-trash delImg" value="{1}"></button>
                        </div>
                        </div>
                    </div>`,r="",t=0;t<n.data.length;t++)r+=u.format(n.data[t].path,i[t]);$("#imgOldList").append(r)})}$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");$("#showImgModel").modal("show")}function updateImg(){fileCallBack[fileEnum._6s]=function(n){var i,f;if(n.errno==0){i=[];for(f in n.data)i.push(n.data[f].newName);var r=_imgNameData.concat(i),e=r.length,o=JSON.stringify(r),t=$("#checkId").text(),u={};u.opType=911;u.opData=JSON.stringify([{UpdateImage:!0,Images:o,Id:t}]);ajaxPost("/Relay/Post",u,function(n){layer.msg(n.errmsg);$("#showImgModel").modal("hide");n.errno==0&&(_imgNameData=r,e>0?($("#imgFlag"+t).removeClass("glyphicon-remove"),$("#imgFlag"+t).addClass("glyphicon-ok"),$("#imgFlag"+t).css("color","green"),$("#imgBtn"+t).attr("onclick","showImgModel({0},'{1}','{2}')".format(tid,titem,escape(_imgNameData)))):($("#imgFlag"+t).removeClass("glyphicon-ok"),$("#imgFlag"+t).addClass("glyphicon-remove"),$("#imgFlag"+t).css("color","red"),$("#imgBtn"+t).attr("onclick","showImgModel({0},'{1}','{2}')".format(tid,titem,""))))})}};var n=function(){$("#addImg").fileinput("upload")};showConfirm("操作",n)}var _permissionList=[],_groups=null,lastGroupId=0,items=null,showItems=null,_imgNameData=null,_imgUpload=null,tid,titem,timg;