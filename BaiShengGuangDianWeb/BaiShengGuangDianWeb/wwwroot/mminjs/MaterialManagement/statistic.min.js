function pageReady(){$(".ms2").select2();$("#materialMonth").val(getNowMonth()).datepicker("update");new Promise(n=>getAllSelect(n)).then(n=>allCodeSelect(n,0));$("#materialCategory").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$(this).val(),siteId:-1})).then(n=>allCodeSelect(n,1))});$("#materialName").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$("#materialCategory").val(),nameId:$(this).val(),siteId:-1})).then(n=>allCodeSelect(n,2))});$("#materialSupplier").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$("#materialCategory").val(),nameId:$("#materialName").val(),supplierId:$(this).val(),siteId:-1})).then(n=>allCodeSelect(n,3))});$("#materialSpecification").on("select2:select",()=>getMaterialList());$("#materialMonth").on("changeDate",()=>getMaterialList())}function getAllSelect(n,t){const i={};i.opType=805;t&&(i.opData=JSON.stringify(t));ajaxPost("/Relay/Post",i,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}n&&n(t)})}function allCodeSelect(n,t){switch(t){case 0:$("#materialCategory").empty().append(`<option value="0">所有类别</option>${setOptions(n.Categories,"Category")}`);case 1:$("#materialName").empty().append(`<option value="0">所有名称</option>${setOptions(n.Names,"Name")}`);case 2:$("#materialSupplier").empty().append(`<option value="0">所有供应商</option>${setOptions(n.Suppliers,"Supplier")}`);case 3:$("#materialSpecification").empty().append(`<option value="0">所有规格</option>${setOptions(n.Specifications,"Specification")}`)}getMaterialList()}function getMaterialList(){$("#materialInfo").addClass("hidden");let n=$("#materialMonth").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择月份");return}n+="-01";const t={};t.opType=891;t.opData=JSON.stringify({day:n,interval:3});ajaxPost("/Relay/Post",t,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}let t=n.datas;const i=$("#materialCategory").val()>>0,r=$("#materialName").val()>>0,u=$("#materialSupplier").val()>>0,f=$("#materialSpecification").val()>>0;t=t.filter(n=>i&&n.CategoryId!==i||r&&n.NameId!==r||u&&n.SupplierId!==u||(!f||n.SpecificationId===f));let e=0,o=0,s=0;for(let n=0,i=t.length;n<i;n++){const i=t[n];e+=i.IncreaseAmount;o+=i.ConsumeAmount;s+=i.CorrectAmount}$("#entryMoney").text(e);$("#consumeMoney").text(o);$("#cashMoney").text(s);$("#materialInfo").removeClass("hidden");$("#materialList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"物料编码"},{data:"Category",title:"类别"},{data:"Name",title:"名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格"},{data:"Site",title:"位置"},{data:"Unit",title:"单位"},{data:"TodayPrice",title:"价格"},{data:"Stock",title:"最低库存"},{data:"LastNumber",title:"月初数量"},{data:"LastPrice",title:"月初金额"},{data:"Increase",title:"本月入库数量"},{data:"IncreaseAmount",title:"本月入库金额"},{data:"Consume",title:"本月领用数量"},{data:"ConsumeAmount",title:"本月领用金额"},{data:"Correct",title:"本月结存数量"},{data:"CorrectAmount",title:"本月结存金额"}]})})}