function pageReady(){_permissionList[534]={uIds:["createQrModalBtn"]};_permissionList[535]={uIds:[]};_permissionList[536]={uIds:["showConsumeModelBtn"]};_permissionList[538]={uIds:["putLogBtn"]};_permissionList[539]={uIds:["receiveLogBtn"]};_permissionList[540]={uIds:["handleLogBtn"]};_permissionList[537]={uIds:[]};_permissionList[541]={uIds:[]};_permissionList[542]={uIds:[]};checkPermissionUi(_permissionList);_permissionList[535].have||$(".fastIncreaseModelBtn").addClass("hidden");_permissionList[537].have||_permissionList[541].have||_permissionList[542].have||$("#showReversalModelBtn").addClass("hidden");$(".ms2").select2({matcher});new Promise(n=>getAllSelect(n)).then(n=>{allCodeSelect("Select",n,!0,1),getMaterialList("Select")});$("#categorySelect").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$(this).val(),siteId:-1})).then(n=>{allCodeSelect("Select",n,!1,1),getMaterialList("Select")})});$("#nameSelect").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$("#categorySelect").val(),nameId:$(this).val(),siteId:-1})).then(n=>{allCodeSelect("Select",n,!1,2),getMaterialList("Select")})});$("#supplierSelect").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$("#categorySelect").val(),nameId:$("#nameSelect").val(),supplierId:$(this).val(),siteId:-1})).then(n=>{allCodeSelect("Select",n,!1,3),getMaterialList("Select")})});$("#specificationSelect").on("select2:select",function(){getMaterialList("Select")});$("#siteSelect").on("select2:select",function(){getMaterialList("Select")});$("#categoryQr").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$(this).val(),siteId:-1})).then(n=>allCodeSelect("Qr",n,!1,1))});$("#nameQr").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$("#categoryQr").val(),nameId:$(this).val(),siteId:-1})).then(n=>allCodeSelect("Qr",n,!1,2))});$("#supplierQr").on("select2:select",function(){new Promise(n=>getAllSelect(n,{categoryId:$("#categoryQr").val(),nameId:$("#nameQr").val(),supplierId:$(this).val(),siteId:-1})).then(n=>allCodeSelect("Qr",n,!1,3))});$("#qrCodeList").on("click",".delQrCode",function(){var t,i,n;for($(this).parent().parent().remove(),t=$("#qrCodeList .printBox"),t.prop("style","float:left"),i=t.length,n=0;n<i;n++)(n+1)%24||t.eq(n).prop("style","page-break-after:always")});$("#increaseList,#consumePlanList,#consumeOtherList,#reversalList,#fastIncreaseList").on("click",".scanPrint",function(){new Promise(n=>showPrintModal(n)).then(n=>{if(n){var t=n.split(",")[0];$(this).next().val(t).trigger("change").trigger("select2:select")}})});$("#increaseList,#consumePlanList,#consumeOtherList,#reversalList,#fastIncreaseList,#reversalEntryList,#reversalConsumeList").on("focus",".zeroNum",function(){var n=$(this).val();n==0&&$(this).val("")});$("#increaseList,#consumePlanList,#consumeOtherList,#reversalList,#fastIncreaseList,#reversalEntryList,#reversalConsumeList").on("blur",".zeroNum",function(){var n=$(this).val();isStrEmptyOrUndefined(n)&&$(this).val("0")});$("#increaseList,#consumePlanList,#consumeOtherList,#reversalList,#fastIncreaseList").on("select2:select",".category,.name,.supplier,.specification,.site,.price,.code",function(n){var t=$(n.delegateTarget).data("index"),i=$(n.target).data("flag");typeof i=="undefined"?codeGanged.call(this,t):codeNoGanged.call(this,i,t);t==0?$("#copyBtn,#exportBtn").attr("disabled",!0):t==4&&$("#fastCopyBtn,#fastExportBtn").attr("disabled",!0)});$("#increaseList").on("change",".source",function(){var t=$(this).val(),n=$(this).parents("tr"),i;t=="计划退回"?($(this).next().removeClass("hidden"),n.find(".planList").trigger("change").trigger("select2:select")):($(this).next().addClass("hidden"),i=selectOp(_codeAllData,"Id","Code"),n.find(".code").empty().append(i).trigger("select2:select"),n.find(".stockNum").prop("placeholder",""));t=="采购"?n.find(".ms2").select2({width:"120px",tags:!0,createTag,matcher}):n.find(".ms2").select2({width:"120px",matcher})});$("#increaseList").on("select2:select",".planList",function(){var t=$(this).val(),n=$(this).parents("tr");new Promise(n=>planSend(n,t)).then(t=>{var i=n.find(".code"),r;i.empty().append(t).trigger("select2:select");r=i.find(":selected").attr("actual");n.find(".stockNum").prop("placeholder",`货品领用数量：${r}`)})});$("#increaseList").on("input",".stockNum",function(){onInput(this,8,1);var t=$(this).val(),i=$(this).parents("tr"),n=i.find(".code :selected").attr("actual");!!n&&parseFloat(t)>parseFloat(n)&&layer.msg("入库数量大于货品领用数量");increasePrice("#increaseList","#increasePrice")});$("#fastIncreaseList").on("input",".stockNum",function(){onInput(this,8,1);increasePrice("#fastIncreaseList","#fastIncreasePrice")});$("#consumePlanSelect").on("select2:select",function(){_materialCheckbox.length||$("#consumePlanList").empty();$("#consumePlanCondition").val("");getPlanCode()});$("#planInto,#otherInto").on("change",function(n){var r=n.target.files,t=new FileReader,i;t.readAsBinaryString(r[0]);$(this).val("");i=$(this).data("index");t.onload=n=>{var t,r,u,f,o,e;try{t=XLSX.read(n.target.result,{type:"binary"})}catch(s){layer.msg("文件类型不正确");return}r=[];for(u in t.Sheets)t.Sheets.hasOwnProperty(u)&&(t.Sheets[u]["!ref"]=t.Sheets[u]["!ref"].replace("A1","A2"),r=r.concat(XLSX.utils.sheet_to_json(t.Sheets[u])));for(f=0,o=r.length;f<o;f++)e=_codeNameData[r[f]["货品编号"]],e&&addListTr(i,e)}});_permissionList[537].have?$("#reversalAllLi").on("click",()=>setReversalBtn("reversalConModal()","冲正")):$("#reversalAllLi,#reversalAll").addClass("hidden");_permissionList[541].have?$("#reversalEntryLi").on("click",()=>setReversalBtn("updateReversalAll(1)","入库修正")):$("#reversalEntryLi,#reversalEntry").addClass("hidden");_permissionList[542].have?$("#reversalConsumeLi").on("click",()=>setReversalBtn("updateReversalAll(2)","领用修正")):$("#reversalConsumeLi,#reversalConsume").addClass("hidden");$("#reversalEntryCode").on("select2:select",()=>getReversalAll(1));$("#reversalConsumeCode").on("select2:select",()=>getReversalAll(2));$("#logPlanSelect").on("select2:select",function(n,t){var i=$(this).val();myPromise({opType:704,opData:JSON.stringify({planId:i,stock:!0})}).then(n=>{var i=selectOp(n,"BillId","Code");$("#logBillSelect").append(`<option value="0">所有</option>${i}`);t&&$("#logBillSelect").val(t).trigger("change");getLogList()})});$("#logBillSelect").on("select2:select",()=>getLogList());pcAndroid()||$(".icon-saoyisao").addClass("hidden");$("#fastIncreaseModal,#increaseModal").on("hidden.bs.modal",()=>$("#increaseBtn,#fastIncreaseBtn").attr("disabled",!1));if($(".maxHeight").css("maxHeight",innerHeight*.7),_materialTable==null){var i=function(n){return`<button type="button" class="btn btn-info btn-sm" onclick="showDetailModel(${n})">查看</button>`},r=function(n){return n.Number<n.Stock?`<strong class="text-red">${n.Number}</strong>`:`<span>${n.Number}</span>`},u=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"?"":t},f=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"?"":t},e=function(n){return n.length>tdShowLength?`<span title="${n}" onclick="showAllContent('${escape(n)}')">${n.substring(0,tdShowLength)}...</span>`:`<span title="${n}">${n}</span>`},n=_permissionList[538].have,t=_permissionList[539].have,o=function(i){var r=`${n?'<button type="button" class="btn btn-success btn-sm" onclick="showLogModel(1, {0})">入库<\/button>':""}
                    ${t?'<button type="button" class="btn btn-success btn-sm" onclick="showLogModel(2, {0})">领用<\/button>':""}`;return r.format(i.Id)};_materialTable=$("#materialList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",filename:`物料详情_${getDate()}`,exportOptions:{columns:[0,1,2,3,4,5,6,7,8,9,10,11,12,13]}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:[],aaSorting:[[1,"asc"]],aLengthMenu:[50,100,150,200],iDisplayLength:50,columns:[{data:null,title:"选择",render:n=>`<input type="checkbox" class="icb_minimal isEnable" value=${n.Id}>`,orderable:!1},{data:"XvHao",title:"序号"},{data:"Code",title:"货品编号"},{data:"Category",title:"类别"},{data:"Name",title:"名称"},{data:null,title:"库存数量",render:r},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格"},{data:"Site",title:"位置"},{data:"Unit",title:"单位"},{data:"Price",title:"价格"},{data:"Stock",title:"最低库存",sClass:"text-blue"},{data:"InTime",title:"上次入库",render:u},{data:"OutTime",title:"上次领用",render:f},{data:"Remark",title:"备注",render:e},{data:"Id",title:"详情",render:i,orderable:!1},{data:null,title:"日志",render:o,orderable:!1,visible:n||t}],drawCallback:function(){$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"}).on("ifChanged",function(){const n=$(this).val();$(this).is(":checked")?_materialCheckbox.push(n):_materialCheckbox.splice(_materialCheckbox.indexOf(n),1)})}});$("#materialList").addClass("hidden")}}function setReversalBtn(n,t){$("#reversalBtn").attr("onclick",n).text(t)}function getAllSelect(n,t){const i={};i.opType=805;t&&(i.opData=JSON.stringify(t));ajaxPost("/Relay/Post",i,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}n&&n(t)})}function allCodeSelect(n,t,i,r){i&&($(`#category${n}`).empty().append(`<option value="0">所有类别</option>${setOptions(t.Categories,"Category")}`),$(`#site${n}`).empty().append(`<option value="0">所有位置</option>${setOptions(t.Sites,"Site")}`));switch(r){case 1:$(`#name${n}`).empty().append(`<option value="0">所有名称</option>${setOptions(t.Names,"Name")}`);case 2:$(`#supplier${n}`).empty().append(`<option value="0">所有供应商</option>${setOptions(t.Suppliers,"Supplier")}`);case 3:$(`#specification${n}`).empty().append(`<option value="0">所有规格</option>${setOptions(t.Specifications,"Specification")}`)}}function scanAdd(n){new Promise(n=>showPrintModal(n)).then(t=>{if(t){var i=t.split(",")[0];addListTr(n,i)}})}function refresh(){getMaterialList("Select")}function planSend(n,t){var i={};i.opType=700;i.opData=JSON.stringify({qId:t,first:!0,simple:!1});ajaxPost("/Relay/Post",i,function(t){var r;if(t.errno!=0){layer.msg(t.errmsg);return}for(var u=t.datas[0].FirstBill,e=u.length,f="",i=0;i<e;i++)r=u[i],f+='<option value = "{0}" actual = "{2}">{1}<\/option>'.format(r.BillId,r.Code,r.ActualConsumption);isStrEmptyOrUndefined(n)||n(f)},0)}function getMaterialList(n,t){var i,r,u,f,e,o,s;if(_materialCheckbox=[],i={},r=$(`#category${n}`).val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品类别");return}if(r!=0&&(i.categoryId=r),u=$(`#name${n}`).val(),isStrEmptyOrUndefined(u)){layer.msg("请选择货品名称");return}if(u!=0&&(i.nameId=u),f=$(`#supplier${n}`).val(),isStrEmptyOrUndefined(f)){layer.msg("请选择供应商名称");return}if(f!=0&&(i.supplierId=f),e=$(`#specification${n}`).val(),isStrEmptyOrUndefined(e)){layer.msg("请选择规格名称");return}if(e!=0&&(i.specificationId=e),o=$(`#site${n}`).val(),isStrEmptyOrUndefined(o)){layer.msg("请选择位置");return}o!=0&&(i.siteId=o);s={};s.opType=800;s.opData=JSON.stringify(i);ajaxPost("/Relay/Post",s,function(i){var r,u,e,f;if(i.errno!=0){layer.msg(i.errmsg);return}if(t!=null&&n=="Qr"){t(i.datas);return}for(_codeIdData={},r=i.datas,u=0,e=r.length;u<e;u++)f=r[u],_codeIdData[f.Id]=f;$("#codeCount").text(i.Count);$("#codeSum").text(i.Sum);updateTable(_materialTable,r);$("#materialList").removeClass("hidden")})}function gangedSelect(n,t){ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}t(n.datas)},0)}function myPromise(n){return new Promise(t=>gangedSelect(n,t))}function gangedObj(n,t){for(var r,u,i={},f=0,e=n.length;f<e;f++)r=n[f],u=r[t],i[u]?i[u].push(r):i[u]=[r];return i}function selectOp(n,t,i){var e,u,r,o,f;for(n=n||[],e='<option value="{0}">{1}<\/option>',u="",r=0,o=n.length;r<o;r++)f=n[r],u+=e.format(f[t],f[i]);return u}function setTableTr(n){for(var i=$(`${n} tr`),t=0,r=i.length;t<r;t++)i.eq(t).find(".num").text(t+1)}function resetList(n,t){$(n).empty();t==0?($("#copyBtn,#exportBtn").attr("disabled",!0),increasePrice(n,"#increasePrice")):t==4&&($("#fastCopyBtn,#fastExportBtn").attr("disabled",!0),increasePrice(n,"#fastIncreasePrice"))}function addListTr(n,t,i){var r="",u="",e={width:"120px",matcher},f;switch(n){case 0:r="#increaseList";u=_gangedTr;e.tags=!0;e.createTag=createTag;$("#copyBtn,#exportBtn").attr("disabled",!0);break;case 1:r="#consumePlanList";u=_gangedPlanTr;consumePlanDittoAuto(r);break;case 2:r="#consumeOtherList";u=_gangedOtherTr;consumePlanDittoAuto(r);break;case 3:r="#reversalList";u=_reversalTr;break;case 4:r="#fastIncreaseList";u=_gangedFastTr;e.tags=!0;e.createTag=createTag;$("#fastCopyBtn,#fastExportBtn").attr("disabled",!0)}i?(i.after(u),f=i.next()):($(r).append(u),f=$(`${r} tr:last`),t?f.find(".code").val(t).trigger("change").trigger("select2:select"):f.find(".code").trigger("select2:select"),$(`${r}Table`).scrollTop($(`${r}Table`)[0].scrollHeight));pcAndroid()||f.find(".scanPrint").addClass("hidden");f.find(".ms2").select2(e);setTableTr(r)}function delTr(n){var t=$(this).parents("tr");t.remove();setTableTr(n);n=="#increaseList"?increasePrice(n,"#increasePrice"):(consumePlanDittoAuto(n),n=="#fastIncreaseList"&&increasePrice(n,"#fastIncreasePrice"))}function initGangedData(n){_codeData={};_codeIdData={};_siteObj={};_priceData={};const t=myPromise({opType:800}),i=new Promise(n=>getAllSelect(n)),r=myPromise({opType:852}),u=myPromise({opType:700});Promise.all([t,i,r,u]).then(t=>{var h,r,i,e,u,o,c,s;const f=t[1];for(_nameData=gangedObj(f.Names,"CategoryId"),_supplierData=gangedObj(f.Suppliers,"NameId"),_specificationData=gangedObj(f.Specifications,"SupplierId"),_siteData=f.Sites,h=gangedObj(_siteData,"Id"),_codeAllData=t[0],r=0,e=_codeAllData.length;r<e;r++)i=_codeAllData[r],u=i.SpecificationId,o=i.SiteId,_codeData[`${u}${o}${i.Price}`]=i,_codeIdData[i.Id]=i,_siteObj[u]?_siteObj[u].push(h[o][0]):_siteObj[u]=h[o],_siteObj[u]=[...new Set(_siteObj[u])];for(c=t[2],r=0,e=c.length;r<e;r++)i=c[r],s=`${i.SpecificationId}${i.SiteId}`,_priceData[s]?_priceData[s].push(i):_priceData[s]=[i];var l=selectOp(t[3],"Id","Plan"),a=selectOp(_codeAllData,"Id","Code"),v=selectOp(f.Categories,"Id","Category");n({planOp:l,codeOp:a,categoryOp:v})})}function codeGanged(n){var y=$(this).val(),t=$(this).parents("tr"),i=_codeIdData[y]||"",f=i.CategoryId||"",e=i.NameId||"",o=i.SupplierId||"",r=i.SpecificationId||"",s=i.SiteId||"",p=t.find(".name"),w=t.find(".supplier"),b=t.find(".specification"),u="<option><\/option>",h,c,l,a,v;t.find(".category").val(f).trigger("change");h=selectOp(_nameData[f],"Id","Name");p.empty().append(h||u).val(e).trigger("change");c=selectOp(_supplierData[e],"Id","Supplier");w.empty().append(c||u).val(o).trigger("change");l=selectOp(_specificationData[o],"Id","Specification");b.empty().append(l||u).val(r).trigger("change");a=selectOp(r==""?_siteData:_siteObj[r],"Id","Site");t.find(".site").empty().append(a).val(s).trigger("change");v=selectOp(_priceData[`${r}${s}`],"Price","Price");t.find(".price").empty().append(v||u).val(i.Price||0).trigger("change");TrNoEqual(n,t,i)}function TrNoEqual(n,t,i){var f,e,r,u;switch(n){case 0:t.find(".unit label").text(i.Unit||"");t.find(".number label").text(i.Number||0);i==""&&t.find(".source").val()==="采购"?t.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden"):t.find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden");f=t.find(".code :selected").attr("actual");f&&t.find(".stockNum").prop("placeholder",`货品领用数量：${f}`);increasePrice("#increaseList","#increasePrice");break;case 1:e=$("#consumePlanSelect").val();r=_planBillData[i.Id]||"";t.find(".planConsume").text(r.PlannedConsumption||0);t.find(".actualConsume").text(r.ActualConsumption||0);t.find(".refresh-btn").attr("onclick",`refreshNumber(${i.Id||0},'#consumePlanList')`);u=t.find(".log-btn");u.attr("onclick",`showLogModel(2,${i.Id},${e})`);r?u.removeClass("hidden"):u.addClass("hidden");break;case 2:t.find(".refresh-btn").attr("onclick",`refreshNumber(${i.Id||0},'#consumeOtherList')`);t.find(".log-btn").attr("onclick",`showLogModel(2,${i.Id||0})`);break;case 3:t.find(".unit").text(i.Unit||"");t.find(".refresh-btn").attr("onclick",`refreshNumber(${i.Id||0},'#reversalList')`);t.find(".log-btn").attr("onclick",`showLogModel(3,${i.Id||0})`);t.find(".remark").val(i.Remark||"");break;case 4:t.find(".unit label").text(i.Unit||"");i==""?t.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden"):t.find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden");increasePrice("#fastIncreaseList","#fastIncreasePrice")}n!=0&&n!=4&&t.find(".number").text(i.Number||0);t.find(".show-btn").attr("onclick",`showDetailModel(${i.Id||0})`)}function codeNoGanged(n,t){var i=$(this).parents("tr"),y=i.find(".code :selected").data("select2Tag"),g=i.find(".name"),nt=i.find(".supplier"),p=i.find(".specification"),r=i.find(".site"),o=i.find(".price"),f=p.val()||"",s=r.val()||"",yt=i.find(".code").val(),h="<option><\/option>",tt,it,rt,ut,ft,et,ot,st,c,u,w,b,a,v,lt,k,d,vt;switch(n){case 0:tt=i.find(".category").val()||"";it=selectOp(_nameData[tt],"Id","Name");g.empty().append(it||h);case 1:rt=g.val()||"";ut=selectOp(_supplierData[rt],"Id","Supplier");nt.empty().append(ut||h);case 2:ft=nt.val()||"";et=selectOp(_specificationData[ft],"Id","Specification");p.empty().append(et||h);case 3:f=p.val()||"";ot=y||!yt?selectOp(_siteData,"Id","Site"):selectOp(_siteObj[f]?_siteObj[f]:_siteData,"Id","Site");r.empty().append(ot);case 4:o.find(":selected").data("select2Tag")||r.find(":selected").data("select2Tag")||(s=r.val()||"",st=y?"":selectOp(_priceData[`${f}${s}`],"Price","Price"),o.empty().append(st||h));case 5:if(o.find(":selected").data("select2Tag")&&n==5&&(r.empty().append(selectOp(_siteData,"Id","Site")),r.find(":selected").data("select2Tag")||r.val(s).trigger("change")),c=o.val()||"",c=c.replace("tag",""),u=_codeData[`${f}${s}${c}`]||"",y?u!=""&&(i.find(".code").val(u.Id).trigger("change"),i.find(".textOn").addClass("hidden").siblings(".textIn").removeClass("hidden")):i.find(".code").val(u.Id||"").trigger("change"),!u.Id&&(i.find(".source").val()==="采购"||t===4)){var ht=i.find(".name :selected").text(),ct=i.find(".supplier :selected").text(),l=i.find(".specification :selected").text();if(!isStrEmptyOrUndefined(ht)&&!isStrEmptyOrUndefined(ct)&&!isStrEmptyOrUndefined(l)){for(l=l.replace(/[&\|\\\*^%$#@\-]/g,""),w=`${ht.toPinYin()}${ct.toPinYin()}${l.toPinYin()}`,b={},t==0?a=$("#increaseList .code :selected"):t==4&&(a=$("#fastIncreaseList .code :selected")),v=0,lt=a.length;v<lt;v++)k=a.eq(v),d=k.text(),k.data("select2Tag")&&i.find(".code :selected").text()!=d&&(b[d]=1);for(var pt=$.extend(!0,{},b,_codeNameData),at=0,e=w;pt[e];)at++,e=`${w}${at}`;vt=`<option value="tag${e}" data-select2-tag="true">${e}</option>`;i.find(".code").append(vt).val(`tag${e}`).trigger("change")}}TrNoEqual(t,i,u)}}function setCheckboxCode(n){for(let t=0,i=_materialCheckbox.length;t<i;t++)addListTr(n,_materialCheckbox[t])}function getCodeName(){var n,i,t;for(_codeNameData={},n=0,i=_codeAllData.length;n<i;n++)t=_codeAllData[n],_codeNameData[t.Code]=t.Id}function showIncreaseModel(){$("#addIncreaseListBtn,#copyBtn,#exportBtn").attr("disabled",!0);$("#increaseList").empty();$("#increasePrice").text("0元");new Promise(n=>initGangedData(n)).then(n=>{getCodeName(),_gangedTr=`<tr>
            <td class="num"></td>
            <td>
                <div class="flexStyle" style="justify-content:center">
                    <select class="form-control source" style="width:110px">
                        <option>采购</option>
                        <option>退回</option>
                        <option>计划退回</option>
                    </select>
                    <div class="hidden" style="width:110px"><select class="ms2 form-control planList">${n.planOp}</select></div>
                </div>
            </td>
            ${_noCodeTds.format(n.categoryOp)}${_increaseEqualTds.format(n.codeOp,0)}
            <td class="number"><label class="control-label textIn"></label><input type="tel" value="0" class="form-control text-center zeroNum hidden textOn" onkeyup="onInput(this, 8, 1)" onblur="onInputEnd(this)" style="min-width:70px"></td>
            <td><button class="btn btn-info btn-sm show-btn" type="button" onclick="showDetailModel()">查看</button></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="delTr.call(this,'#increaseList')"><i class="fa fa-minus"></i></button></td>
            </tr>`,$("#addIncreaseListBtn").attr("disabled",!1),setCheckboxCode(0)});$("#increaseModal").modal("show")}function increasePrice(n,t){const r=$(n).find(".price"),u=$(n).find(".stockNum");let i=0;for(let n=0,t=r.length;n<t;n++){const t=r.eq(n).val()||"",f=parseFloat(t.replace("tag",""))||0,e=parseFloat(u.eq(n).val().trim())||0;i+=f*e}i=parseFloat(i.toFixed(5));$(t).text(`${i}元`)}function showFastIncreaseModel(){$("#addFastIncreaseListBtn,#fastCopyBtn,#fastExportBtn").attr("disabled",!0);$("#fastIncreaseList").empty();$("#fastIncreasePrice").text("0元");new Promise(n=>initGangedData(n)).then(n=>{getCodeName(),_gangedFastTr=`<tr>
            <td class="num"></td>
            ${_noCodeTds.format(n.categoryOp)}${_increaseEqualTds.format(n.codeOp,4)}
            <td><button type="button" class="btn btn-danger btn-sm" onclick="delTr.call(this,'#fastIncreaseList')"><i class="fa fa-minus"></i></button></td>
            </tr>`,$("#addFastIncreaseListBtn").attr("disabled",!1),setCheckboxCode(4)});$("#fastIncreaseModal").modal("show")}function copyTr(n){var t=$(this).parents("tr"),i,e,r,u,f,o;if(addListTr(n,null,t),i=t.next(),e=t.find(".purchase").val().trim(),i.find(".purchase").val(e),i.find(".stockNum").replaceWith(t.find(".stockNum").clone(!0)),r=(n,t)=>t.empty().append(n.html()).val(n.val()).trigger("change"),n===0&&(u=t.find(".source").val(),i.find(".source").val(u),u=="计划退回"&&(i.find(".planList").parent().removeClass("hidden"),i.find(".planList").val(t.find(".planList").val()).trigger("change"),r(t.find(".code"),i.find(".code"))),i.find(".number").replaceWith(t.find(".number").clone(!0)),i.find(".show-btn").replaceWith(t.find(".show-btn").clone(!0))),f=t.find(".code").val(),o=t.find(".code :selected").data("select2Tag"),!o&&f){i.find(".code").val(f).trigger("change").trigger("select2:select");return}r(t.find(".code"),i.find(".code"));r(t.find(".category"),i.find(".category"));r(t.find(".name"),i.find(".name"));r(t.find(".supplier"),i.find(".supplier"));r(t.find(".specification"),i.find(".specification"));r(t.find(".price"),i.find(".price"));r(t.find(".site"),i.find(".site"));i.find(".unit").replaceWith(t.find(".unit").clone(!0))}function increase(n){for(var d,v,u,y,f,p,e,o,w,s,b,tt,h,it,rt,st,k=[],ht=n?"#fastIncrease":"#increase",ut=$(`${ht}List tr`),c=0,ct=ut.length;c<ct;c++){var i=c+1,t=ut.eq(c),l=t.find(".code :selected"),r=l.val();if(isStrEmptyOrUndefined(r)){layer.msg(`序列${i}：货品编号不能为空`);return}d=l.data("select2Tag");r=d?"0":r;var g=l.text(),nt=t.find(".category :selected"),a=nt.val();if(isStrEmptyOrUndefined(a)){layer.msg(`序列${i}：请选择类别`);return}if(a=nt.data("select2Tag")?"0":a,v=t.find(".name :selected"),u=v.val(),isStrEmptyOrUndefined(u)){layer.msg(`序列${i}：请选择名称`);return}if(u=v.data("select2Tag")?"0":u,y=t.find(".supplier :selected"),f=y.val(),isStrEmptyOrUndefined(f)){layer.msg(`序列${i}：请选择供应商`);return}if(f=y.data("select2Tag")?"0":f,p=t.find(".specification :selected"),e=p.val(),isStrEmptyOrUndefined(e)){layer.msg(`序列${i}：请选择规格`);return}if(e=p.data("select2Tag")?"0":e,o=t.find(".price :selected").text(),isStrEmptyOrUndefined(o)){layer.msg(`序列${i}：请选择单价`);return}if(parseFloat(o)!=o){layer.msg(`序列${i}：单价不合法`);return}if(w=t.find(".site :selected"),s=w.val(),isStrEmptyOrUndefined(s)){layer.msg(`序列${i}：请选择位置`);return}if(s=w.data("select2Tag")?"0":s,d){if(b=t.find(".unit input").val().trim(),isStrEmptyOrUndefined(b)){layer.msg(`序列${i}：请输入单位`);return}tt=n?0:t.find(".number input").val().trim()}else b=t.find(".unit label").text(),tt=n?_codeIdData[r].Stock:t.find(".number label").text();if(h=t.find(".stockNum").val(),isStrEmptyOrUndefined(h)){layer.msg(`序列${i}：${g}: 入库数量不能为空`);return}if(parseFloat(h)<=0){layer.msg(`序列${i}：${g}: 入库数量需大于0`);return}if(!n&&(it=l.attr("actual"),!!it&&parseFloat(h)>parseFloat(it))){layer.msg(`序列${i}：入库数量大于货品领用数量`);return}if(rt=t.find(".purchase").val().trim(),isStrEmptyOrUndefined(rt)){layer.msg(`序列${i}：采购/退回人不能为空`);return}var ft=t.find(".source"),et=n?"采购":ft.val(),ot={CategoryId:a,Category:nt.text(),NameId:u,Name:v.text(),SupplierId:f,Supplier:y.text(),SpecificationId:e,Specification:p.text(),SiteId:s,Site:w.text(),Code:g,Unit:b,Price:o,Stock:tt,Purpose:et,RelatedPerson:rt,BillId:r,Number:h};n||et!="计划退回"||(ot.PlanId=ft.next().find(".planList").val());k.push(ot)}if(k.length<=0){layer.msg("请输入货品");return}st=()=>{var t={};t.opType=801;t.opData=JSON.stringify({Bill:k});ajaxPost("/Relay/Post",t,t=>{layer.msg(t.errmsg),t.errno==0&&(n?$("#fastCopyBtn,#fastExportBtn").attr("disabled",!1):$("#copyBtn,#exportBtn").attr("disabled",!1),$(this).attr("disabled",!0),setTimeout(()=>$(this).attr("disabled",!1),1e4),getMaterialList("Select"))})};showConfirm("入库",st)}function exportExcel(n){for(var u=$(`${n} tr`),i=[],r=0,e=u.length;r<e;r++){var t=u.eq(r),f=t.find(".code :selected"),o=f.data("select2Tag");i.push({Code:f.text(),Category:t.find(".category :selected").text(),Name:t.find(".name :selected").text(),Supplier:t.find(".supplier :selected").text(),Specification:t.find(".specification :selected").text(),Price:t.find(".price :selected").text(),Site:t.find(".site :selected").text(),Unit:o?t.find(".unit input").val().trim():t.find(".unit label").text()})}if(!i.length){layer.msg("请先添加货品");return}$("<table><\/table>").DataTable({dom:"B",buttons:[{extend:"excel",filename:`入库日志_${getDate()}`}],destroy:!0,data:i,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"货品编号"},{data:"Category",title:"类别"},{data:"Name",title:"名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Price",title:"单价"},{data:"Site",title:"位置"},{data:"Unit",title:"单位"}]}).buttons(".buttons-excel").trigger()}function copyTable(n){var i=$(`${n} tr`),t,r,u;for(_copyData=[],t=0,r=i.length;t<r;t++)u=i.eq(t).find(".code :selected").text().trim(),_copyData.push(u);layer.msg(_copyData.length?"拷贝成功":"请先添加货品")}function getPlanCode(){$("#addConsumePlanListBtn").attr("disabled",!0);var n=$("#consumePlanSelect").val();_planBillData={};isStrEmptyOrUndefined(n)||myPromise({opType:704,opData:JSON.stringify({planId:n,stock:!0})}).then(n=>{for(var i,t=0,r=n.length;t<r;t++)i=n[t],_planBillData[i.BillId]=i;$("#addConsumePlanListBtn").attr("disabled",!1)})}function showConsumeModel(){$("#addConsumePlanListBtn,#addConsumeOtherListBtn").attr("disabled",!0);$("#planConsumeLi").attr("aria-expanded")=="false"&&$("#planConsumeLi").click();$("#consumePlanCondition,#consumeOther,#consumeOtherCondition").val("");$("#consumePlanSelect,#consumePlanList,#consumeOtherList,#logPlanSelect").empty();new Promise(n=>initGangedData(n)).then(n=>{$("#consumePlanSelect").append(n.planOp);$("#logPlanSelect").append(`<option value="0">所有</option>${n.planOp}`);getPlanCode();getCodeName();var t=`<tr>
            <td class="num"></td>
            <td>
                <span class="iconfont icon-saoyisao scanPrint" style="font-size:30px;cursor:pointer;vertical-align:middle"></span>
                <select class="ms2 form-control code">${n.codeOp}</select>
            </td>
            ${_noCodeTds.format(n.categoryOp)}
            <td><input class="form-control text-center receive zeroNum" type="tel" value="0" onkeyup="onInput(this, 8, 1)" onblur="onInputEnd(this)" style="width:140px;margin:auto"></td>
            {0}
            <td class="form-inline">
                <span class="number"></span>
                <button type="button" class="btn btn-danger btn-xs pull-right refresh-btn" onclick="refreshNumber()"><i class="fa fa-refresh"></i></button>
            </td>
            <td>
                <div class="flexStyle" style="width:150px">
                    <input class="form-control text-center recipient" type="tel" maxlength="64">
                    <button class="btn btn-primary btn-sm conPlanDitto" style="margin-left:3px" onclick="consumePlanDitto.call(this)">同上</button>
                </div>
            </td>
            <td><button class="btn btn-info btn-sm show-btn" type="button" onclick="showDetailModel()">详情</button></td>
            <td><button class="btn btn-success btn-sm log-btn" type="button" onclick="showLogConsumeModel()">查看</button></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="delTr.call(this,'{1}')"><i class="fa fa-minus"></i></button></td>
            </tr>`;_gangedPlanTr=t.format('<td class="planConsume"><\/td><td class="actualConsume"><\/td>',"#consumePlanList");_gangedOtherTr=t.format("","#consumeOtherList");$("#addConsumeOtherListBtn").attr("disabled",!1);setCheckboxCode(1);setCheckboxCode(2)});$("#consumeModal").modal("show")}function refreshNumber(n,t){var i={};i.opType=800;i.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",i,i=>{var f,o,r,e,s,h,u;if(i.errno!=0){layer.msg(i.errmsg);return}for(f=i.datas[0].Number,o=$(`${t} tr`),r=0,e=o.length;r<e;r++)s=o.eq(r),h=s.find(".code :selected").val(),n==h&&s.find(".number").text(f);for(r=0,e=_codeAllData.length;r<e;r++)if(u=_codeAllData[r],u.Id==n){u.Number=f;_codeData[`${u.SpecificationId}${u.SiteId}${u.Price}`].Number=f;_codeIdData[n].Number=f;break}})}function consumePlanDittoAuto(n){$(n).find(".conPlanDitto").css("visibility","visible");$(`${n} tr:not(.hidden):first .conPlanDitto`).css("visibility","hidden")}function searchTr(n){var u=$(this).parent(),e=u.find(".val").val().trim(),f=$(`${n} tr`),t,o,s,i,h,r,c;if(isStrEmptyOrUndefined(e))f.removeClass("hidden");else{t=new Function;o=u.find(".sym").val();switch(o){case"0":t=(n,t)=>n==t;break;case"1":t=(n,t)=>n!=t;break;case"2":t=(n,t)=>n.indexOf(t)!=-1}for(s=u.find(".thText").val(),i=0,h=f.length;i<h;i++)r=f.eq(i),c=r.find(`.${s} :selected`).text(),t(c,e)?r.removeClass("hidden"):r.addClass("hidden")}consumePlanDittoAuto(n)}function consumePlanDitto(){var n=$(this).parents("tr"),t=n.prevAll(":not(.hidden):first"),i=t.find(".recipient").val().trim();n.find(".recipient").val(i)}function consumeConfirm(){var o,t,a=$("#planConsumeLi").attr("aria-expanded")=="true",r,s,i,v,n,f,e,l;if(a){if(o="#consumePlanList",t=$("#consumePlanSelect :selected").text(),isStrEmptyOrUndefined(t)){layer.msg("请选择计划号");return}}else if(o="#consumeOtherList",t=$("#consumeOther").val().trim(),isStrEmptyOrUndefined(t)){layer.msg("请输入用途");return}for(r=[],_consumeConfirmData=[],s=$(`${o} tr`),i=0,v=s.length;i<v;i++){var u=i+1,h=s.eq(i),c=h.find(".code").val();if(isStrEmptyOrUndefined(c)){layer.msg(`序列${u}：请选择货品编号`);return}if(n=_codeIdData[c],isStrEmptyOrUndefined(n)){layer.msg(`序列${u}：货品编号不存在, 无法领用`);return}if(f=h.find(".receive").val().trim(),f>>0<=0){layer.msg(`序列${u}：领用数量必须大于0`);return}if(e=h.find(".recipient").val().trim(),isStrEmptyOrUndefined(e)){layer.msg(`序列${u}：请输入领用人`);return}l={RelatedPerson:e,BillId:c,Number:f};a||(l.Purpose=t);_consumeConfirmData.push(l);r.push({Code:n.Code,Category:n.Category,Name:n.Name,Supplier:n.Supplier,Specification:n.Specification,Price:n.Price,Site:n.Site,Number:f,RelatedPerson:e})}if(!r.length){layer.msg("请先添加货品");return}$("#consumePurpose").text(t);$("#consumeConfirmList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:r,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"货品编号"},{data:"Category",title:"货品类别"},{data:"Name",title:"货品名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Price",title:"单价"},{data:"Site",title:"位置"},{data:"Number",title:"领用数量"},{data:"RelatedPerson",title:"领用人"}]});$("#consumeConfirmModal").modal("show")}function consume(){var n=802,t=function(){var t={},i;t.opType=n;i={Bill:_consumeConfirmData};$("#planConsumeLi").attr("aria-expanded")=="true"&&(i.PlanId=$("#consumePlanSelect").val());t.opData=JSON.stringify(i);ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&($("#consumeConfirmModal,#consumeModal").modal("hide"),getMaterialList("Select"))})};showConfirm("领用",t)}function receiveStick(n){var r=_copyData.length,t,i;if(!r){layer.msg("请先拷贝入库数据");return}for(t=0;t<r;t++)i=_codeNameData[_copyData[t]],i&&addListTr(n,i)}function showReversalModel(){$("#addReversalListBtn").attr("disabled",!0);$("#reversalList").empty();new Promise(n=>initGangedData(n)).then(n=>{_reversalTr=`<tr>
            <td class="num"></td>
            <td>
                <span class="iconfont icon-saoyisao scanPrint" style="font-size:30px;cursor:pointer;vertical-align:middle"></span>
                <select class="ms2 form-control code">${n.codeOp}</select>
            </td>
            ${_noCodeTds.format(n.categoryOp)}
            <td class="unit"></td>
            <td class="form-inline">
                <span class="number"></span>
                <button type="button" class="btn btn-danger btn-xs pull-right refresh-btn" onclick="refreshNumber()"><i class="fa fa-refresh"></i></button>
            </td>
            <td><input type="tel" class="form-control text-center upNumber zeroNum" value="0" onkeyup="onInput(this, 8, 1)" onblur="onInputEnd(this)" style="width:140px;margin:auto"></td>
            <td class="no-padding"><textarea class="form-control remark" maxlength="500" style="resize: vertical;width:150px;margin:auto"></textarea></td>
            <td><button class="btn btn-info btn-sm show-btn" type="button" onclick="showDetailModel()">详情</button></td>
            <td><button class="btn btn-success btn-sm log-btn" type="button" onclick="showLogConsumeModel()">查看</button></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="delTr.call(this,'#reversalList')"><i class="fa fa-minus"></i></button></td>
            </tr>`;$("#addReversalListBtn").attr("disabled",!1);setCheckboxCode(3);$("#reversalEntryCode,#reversalConsumeCode").empty().append(`<option value="0">所有货品编号</option>${n.codeOp}`);$("#reversalEntrySTime,#reversalEntryETime,#reversalConsumeSTime,#reversalConsumeETime").val(getDate()).datepicker("update");$("#reversalEntrySTime,#reversalEntryETime").off("changeDate").on("changeDate",()=>getReversalAll(1));$("#reversalConsumeSTime,#reversalConsumeETime").off("changeDate").on("changeDate",()=>getReversalAll(2));$("#reversalEntryLi > a").off("click").one("click",()=>getReversalAll(1));$("#reversalConsumeLi > a").off("click").one("click",()=>getReversalAll(2));$("#reversalUl li:not(.hidden):first > a").click()});$("#reversalModal").modal("show")}function reversalConModal(){var o=$("#reversalList tr"),t,s=o.length,i,h,n,f,e;if(!s){layer.msg("请添加货品");return}for(i=[],_reversalConList=[],h=getCookieTokenInfo().name,t=0;t<s;t++){var c=t+1,r=o.eq(t),u=r.find(".code").val();if(isStrEmptyOrUndefined(u)){layer.msg("请选择货品编号");return}if(n=_codeIdData[u],isStrEmptyOrUndefined(n)){layer.msg(`序列${c}：货品编号不存在, 请重新选择`);return}f=r.find(".upNumber").val().trim();e=r.find(".remark").val().trim();i.push({code:n.Code,category:n.Category,name:n.Name,supplier:n.Supplier,specification:n.Specification,price:n.Price,site:n.Site,number:f,remark:e});_reversalConList.push({BillId:u,Number:f,Remark:e,RelatedPerson:h})}$("#reversalConList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:i,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"code",title:"货品编号"},{data:"category",title:"货品类别"},{data:"name",title:"货品名称"},{data:"supplier",title:"供应商"},{data:"specification",title:"规格型号"},{data:"price",title:"单价"},{data:"site",title:"位置"},{data:"number",title:"库存修改",sClass:"text-info"},{data:"remark",title:"备注",sClass:"text-info"}]});$("#reversalConModal").modal("show")}function reversalCon(){var n=()=>{var n={},t;n.opType=804;t={Bill:_reversalConList};n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&($("#reversalConModal,#reversalModal").modal("hide"),getMaterialList("Select"))})};showConfirm("冲正",n)}function getReversalAll(n){var r,u,s,f,e;let t="",i=null,o=!1;if(n===1?(t="Entry",i=_entryTrs=[],o=!0):n===2&&(t="Consume",i=_consumeTrs=[]),r=$(`#reversal${t}STime`).val(),u=$(`#reversal${t}ETime`).val(),!isStrEmptyOrUndefined(r)&&!isStrEmptyOrUndefined(u)){if(r+=" 00:00:00",u+=" 23:59:59",compareDate(r,u)){layer.msg("结束时间不能小于开始时间");return}if(s={startTime:r,endTime:u,type:n},f=$(`#reversal${t}Code`).val(),isStrEmptyOrUndefined(f)){layer.msg("请选择货品编号");return}f==0||(s.billId=f);e={};e.opType=803;e.opData=JSON.stringify(s);ajaxPost("/Relay/Post",e,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const r=n=>`<span class="textOn">${n}</span><input class="form-control text-center textIn hidden zeroNum number" style="min-width:80px" oninput="onInput(this, 4, 0)">`;$(`#reversal${t}List`).DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"选择",render:n=>`<input type="checkbox" class="icb_minimal isEnable" value=${n.Id} bill=${n.BillId}>`,orderable:!1},{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Time",title:"时间"},{data:"Purpose",title:o?"货品来源":"用途"},{data:"Code",title:"货品编码"},{data:"Category",title:"类别"},{data:"Name",title:"名称"},{data:"Specification",title:"规格"},{data:"Supplier",title:"供应商"},{data:"Price",title:"单价"},{data:"Number",title:"数量",render:r},{data:"RelatedPerson",title:o?"采购/退回人":"领用人"},{data:"Manager",title:"物管员"}],drawCallback:function(){const n=this.api();$(this).find(".isEnable").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-blue",increaseArea:"20%"}).on("ifChanged",function(){const t=$(this).parents("tr"),r=t[0];if($(this).is(":checked")){i.push(r);t.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden");const u=n.row(r).data();t.find(".number").val(u.Number)}else i.splice(i.indexOf(r),1),t.find(".textIn").addClass("hidden").siblings(".textOn").removeClass("hidden")})}})})}}function updateReversalAll(n){let t=[],i=null,r="";n===1?(t=_entryTrs,i=806,r="入库修正"):n===2&&(t=_consumeTrs,i=807,r="领用修正");const u=t.length;if(!u){layer.msg("请选择需要修改的数据");return}const f=[];for(let i=0;i<u;i++){const r=$(t[i]),e=r.find(".number").val().trim()||0,u=r.find(".isEnable");f.push({Type:n,Id:u.val(),Number:e,BillId:u.attr("bill")})}var e=()=>{var t={};t.opType=i;t.opData=JSON.stringify(f);ajaxPost("/Relay/Post",t,t=>{layer.msg(t.errmsg),t.errno==0&&(getMaterialList("Select"),getReversalAll(n))})};showConfirm(r,e)}function showLogModel(n,t,i){_logType=n;$("#logStartDate,#logEndDate").off("changeDate").val(getDate()).datepicker("update").on("changeDate",()=>getLogList());$("#logBillSelect").empty();$("#logPlanBox,#billInfo").addClass("hidden");$("#billInfo .spanStyle").text("");var r="";switch(n){case 0:r="操作日志";break;case 1:r="入库日志";break;case 2:r="领用日志";break;case 3:r="冲正日志"}if($("#logTitle").text(r),i){if($("#logPlanBox").removeClass("hidden"),isStrEmptyOrUndefined(t)||!_planBillData[t]){layer.msg("计划中不存在该货品编号或货品编号不存在");return}$("#logPlanSelect").val(i).trigger("change").trigger("select2:select",t)}else myPromise({opType:800}).then(n=>{var i=selectOp(n,"Id","Code");$("#logBillSelect").append(`<option value="0">所有编号</option>${i}`);t&&($("#logBillSelect").val(t).trigger("change"),$("#billInfo").removeClass("hidden"));getLogList()})}function getLogList(){var r=$("#logStartDate").val(),u=$("#logEndDate").val(),n,f,i,t,e;if(!isStrEmptyOrUndefined(r)&&!isStrEmptyOrUndefined(u)){if(r+=" 00:00:00",u+=" 23:59:59",compareDate(r,u)){layer.msg("结束时间不能小于开始时间");return}if(n={startTime:r,endTime:u},_logType&&(n.type=_logType,_logType!=2||$("#consumeModal").is(":hidden")||(n.purposeId=$("#planConsumeLi").attr("aria-expanded")=="true"?1:2,$("#logPlanBox").is(":hidden")||(f=$("#logPlanSelect").val(),isStrEmptyOrUndefined(f)||f==0||(n.planId=f)))),i=$("#logBillSelect").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择货品编号");return}i!=0?(n.billId=i,t=_codeIdData[i],$("#logCategory").html(t.Category),$("#logName").html(t.Name),$("#logSupplier").html(t.Supplier),$("#logSpecification").html(t.Specification),$("#logPrice").html(t.Price),$("#billInfo").removeClass("hidden")):$("#billInfo").addClass("hidden");e={};e.opType=803;e.opData=JSON.stringify(n);ajaxPost("/Relay/Post",e,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}var e=n=>n==1?'<span class="text-success">入库<\/span>':'<span class="text-danger">领用<\/span>',f=n=>n.Type==1?`<span class="text-success">+${n.Number}</span>`:`<span class="text-danger">-${n.Number}</span>`,o=n=>`<span class="text-${n.Number>n.OldNumber?"success":"danger"}">${n.Number}</span>`,r=[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Time",title:"时间"}],u=[{data:"Category",title:"类别"},{data:"Name",title:"名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Price",title:"单价"},{data:"Site",title:"位置",bVisible:!1},{data:"Unit",title:"单位",bVisible:!1}],t=null,i=null;switch(_logType){case 0:t=[...r,{data:"Code",title:"货品编号"},{data:"Type",title:"入/出",render:e},{data:"Purpose",title:"来源/用途"},...u,{data:null,title:"数量",render:f},{data:"OldNumber",title:"旧值",bVisible:!1},{data:"RelatedPerson",title:"相关人"},{data:"Manager",title:"物管员"}];i=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];break;case 1:t=[...r,{data:"Code",title:"货品编号"},...u,{data:null,title:"数量",render:f},{data:"OldNumber",title:"旧值",bVisible:!1},{data:"Purpose",title:"货品来源"},{data:"RelatedPerson",title:"采购/退回人"},{data:"Manager",title:"物管员"},{data:null,title:"",bVisible:!1}];i=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14];break;case 2:t=[...r,{data:"Purpose",title:"用途"},{data:"Code",title:"货品编号"},...u,{data:null,title:"数量",render:f},{data:"OldNumber",title:"旧值",bVisible:!1},{data:"RelatedPerson",title:"领用人"},{data:"Manager",title:"物管员"},{data:null,title:"",bVisible:!1}];i=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14];break;case 3:t=[...r,{data:"Code",title:"货品编号"},...u,{data:"OldNumber",title:"修改前"},{data:null,title:"修改后",render:o},{data:"Remark",title:"备注"},{data:"Manager",title:"物管员"},{data:null,title:"",bVisible:!1},{data:null,title:"",bVisible:!1}];i=[0,1,2,3,4,5,6,7,8,9,10,11,12,13]}$("#logList").DataTable({dom:'<"pull-left"l><"pull-right"B><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',buttons:[{extend:"excel",text:"导出Excel",className:"btn-primary btn-sm",filename:`${$("#logTitle").text().trim()}_${getDate()}`,exportOptions:{columns:i}}],destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n.datas,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:t})});$("#logModal").modal("show")}}function showDetailModel(n){if(n!=0){var t={};t.opType=800;t.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",t,n=>{var i,r;if(n.errno==0){if(i=n.datas[0],$("#detailCode").text(i.Code),$("#detailCategory").text(i.Category),$("#detailName").text(i.Name),$("#detailSupplier").text(i.Supplier),$("#detailSpecification").text(i.Specification),$("#detailSite").text(i.Site),$("#detailImgList").empty(),i.ImageList.length>0){t={type:fileEnum.Material,files:i.Images};t.dir="";for(r in fileEnum)if(fileEnum[r]==t.type){t.dir=r;break}if(isStrEmptyOrUndefined(t.dir))return void layer.msg("文件类型不存在！");getFilePath(t,n=>{const t=n.length;if(!(t<=0)){var r='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><div class="caption text-center"><\/div><\/div><\/div>',i="";for(let u=0;u<t;u++)i+=r.format(n[u].path,img[u]);$("#detailImgList").append(i)}})}$("#showDetailModel").modal("show")}else layer.msg(n.errmsg)})}}function createQrModal(){$("#qrCodeList").empty();new Promise(n=>getAllSelect(n)).then(n=>allCodeSelect("Qr",n,!0,1));$("#createQrModal").modal("show")}function getQrList(){new Promise(function(n){getMaterialList("Qr",n)}).then(n=>{for(var u=n.length,f="",e=[],r=0,i,t=0;t<u;t++)r++,r==24&&(r=0),i=n[t],f+='<div class="printBox" style={6}><div style="width: 230px; height: 115px; border: 1px solid; display: flex;position:relative"><div style="width: 50%; height: 100%"><div class="createQrCode" style="margin: 4px"><\/div><\/div><span class="glyphicon glyphicon-remove delQrCode pointer" aria-hidden="true" style="position:absolute;right:3px;top:3px;font-size:20px;color:red"><\/span><div style="width: 50%; height: 100%; text-align: center;display:flex;flex-direction:column;justify-content:center;font-size:12px"><span class="textOverTop">{0}<\/span><span class="textOverTop">{1}<\/span><span class="textOverTop">{2}<\/span><span class="textOverTop">{3}<\/span><span class="textOverTop">{4}<\/span><span class="textOverTop">{5}<\/span><\/div><\/div><\/div>'.format(i.Code,i.Category,i.Name,i.Supplier,i.Specification,i.Site,r?"float:left":"page-break-after:always"),e.push(`${i.BillId},${i.Code}`);for($("#qrCodeList").empty().append(f),t=0;t<u;t++)new QRCode($("#qrCodeList .createQrCode")[t],{text:e[t],width:105,height:105,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});$("#qrCodeList .createQrCode").prop("title","")})}var _permissionList=[],_noCodeTds,_increaseEqualTds,_gangedTr,_gangedFastTr,_copyData,_planBillData,_consumeConfirmData,_reversalTr,_reversalConList,_logType;let _materialCheckbox=null,_materialTable=null;var _codeAllData=null,_codeData=null,_codeIdData=null,_nameData=null,_supplierData=null,_specificationData=null,_siteData=null,_siteObj=null,_priceData=null;_noCodeTds=`<td><select class="ms2 form-control category" data-flag="0">{0}</select></td>
    <td><select class="ms2 form-control name" data-flag="1"></select></td>
    <td><select class="ms2 form-control supplier" data-flag="2"></select></td>
    <td><select class="ms2 form-control specification" data-flag="3"></select></td>
    <td><select class="ms2 form-control price" data-flag="5"></select></td>
    <td><select class="ms2 form-control site" data-flag="4"></select></td>`;_increaseEqualTds=`<td><input class="form-control text-center stockNum zeroNum" type="tel" value="0" style="width:140px;margin:auto"></td>
            <td class="unit"><label class="control-label textIn"></label><input class="form-control text-center hidden textOn" maxlength="4" style="min-width:70px"></td>
            <td>
               <div class="flexStyle" style="width:160px">
                   <input class="form-control text-center purchase" maxlength="64">
                   <button class="btn btn-primary btn-sm pull-right" type="button" onclick="copyTr.call(this,{1})" style="margin-left:3px" title="复制"><i class="fa fa-copy"></i></button>
               </div>
            </td>
            <td>
                <span class="iconfont icon-saoyisao scanPrint" style="font-size:30px;cursor:pointer;vertical-align:middle"></span>
                <select class="ms2 form-control code">{0}</select>
            </td>`;_gangedTr=null;_gangedFastTr=null;_copyData=[];_planBillData=null;var _gangedPlanTr=null,_gangedOtherTr=null,_codeNameData=null;_consumeConfirmData=null;_reversalTr=null;_reversalConList=null;let _entryTrs=null,_consumeTrs=null;_logType=null;