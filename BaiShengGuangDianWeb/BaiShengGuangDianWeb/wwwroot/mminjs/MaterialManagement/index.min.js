function pageReady(){$(".ms2").select2();var n=new Promise(function(n){categorySelect(n)}),t=new Promise(function(n){nameSelect(n,!0,"Select")}),i=new Promise(function(n){supplierSelect(n,!0,"Select")}),r=new Promise(function(n){specificationSelect(n,!0,"Select")}),u=new Promise(function(n){siteSelect(n)});Promise.all([n,t,i,r,u]).then(()=>{getMaterialList("Select")});$("#categorySelect").on("select2:select",function(){var n=new Promise(function(n){nameSelect(n,!1,"Select")}),t=new Promise(function(n){supplierSelect(n,!1,"Select")}),i=new Promise(function(n){specificationSelect(n,!1,"Select")});Promise.all([n,t,i]).then(()=>{getMaterialList("Select")})});$("#nameSelect").on("select2:select",function(){var n=new Promise(function(n){supplierSelect(n,!1,"Select")}),t=new Promise(function(n){specificationSelect(n,!1,"Select")});Promise.all([n,t]).then(()=>{getMaterialList("Select"),qrSiteSet("Select")})});$("#supplierSelect").on("select2:select",function(){var n=new Promise(function(n){specificationSelect(n,!1,"Select")});Promise.all([n]).then(()=>{getMaterialList("Select"),qrSiteSet("Select")})});$("#specificationSelect").on("select2:select",function(){getMaterialList("Select");qrSiteSet("Select")});$("#siteSelect").on("select2:select",function(){getMaterialList("Select")});$("#logBillSelect").on("select2:select",function(){var i=$("#logBillSelect").val(),t,r,n;if(i==0)$("#billInfo").addClass("hidden"),$("#logCategory").html(""),$("#logName").html(""),$("#logSupplier").html(""),$("#logSpecification").html(""),$("#logPrice").html("");else for(r=_materialList.length,t=0;t<r;t++)n=_materialList[t],i==n.Id&&($("#billInfo").removeClass("hidden"),$("#logCategory").html(n.Category),$("#logName").html(n.Name),$("#logSupplier").html(n.Supplier),$("#logSpecification").html(n.Specification),$("#logPrice").html(n.Price));getLogList()});$("#logStartDate").val(getDate());$("#logEndDate").val(getDate());$("#logStartDate").datepicker("update").on("changeDate",function(){getLogList()});$("#logEndDate").datepicker("update").on("changeDate",function(){getLogList()});$("#consumePlanSelect").on("select2:select",function(){var i,n,r,t;if(resetConsumePlanList(),$("#consumePlanCondition").val(""),i=$(this).val(),_consumePlan.length>0){for(r=_consumePlan.length,n=0;n<r;n++)if(t=_consumePlan[n],i==t.Id){isStrEmptyOrUndefined(t.Remark)?($("#consumePlanRemarkDiv").addClass("hidden"),$("#consumePlanRemark").html("")):($("#consumePlanRemarkDiv").removeClass("hidden"),$("#consumePlanRemark").html(t.Remark));break}getPlanBill(!0)}consumePlanActual()});$("#logConsumeStartDate").val(getDate());$("#logConsumeEndDate").val(getDate());$("#logConsumeStartDate").datepicker("update").on("changeDate",function(){getLogConsumeList()});$("#logConsumeEndDate").datepicker("update").on("changeDate",function(){getLogConsumeList()});$("#logConsumePlanSelect").on("select2:select",function(){var n,i,t;$("#logConsumeBillSelect").empty();n={};i=$("#logConsumePlanSelect").val();n.planId=i;n.stock=!0;t={};t.opType=704;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,function(n){var i,r,t,u;if(n.errno!=0){layer.msg(n.errmsg);return}for(_logConsumePlanBill=n.datas,i='<option value = "{0}">{1}<\/option>',r="",t=0;t<_logConsumePlanBill.length;t++)u=_logConsumePlanBill[t],r+=i.format(u.BillId,u.Code);$("#logConsumeBillSelect").append(i.format(0,"所有编号"));$("#logConsumeBillSelect").append(r);getLogConsumeList(!1)})});$("#logConsumeBillSelect").on("select2:select",function(){var i,t,n;for($("#billInfoConsume").addClass("hidden"),i=$(this).val(),t=0;t<_logConsumePlanBill.length;t++)n=_logConsumePlanBill[t],i==n.BillId&&($("#billInfoConsume").removeClass("hidden"),$("#logConsumeCategory").html(n.Category),$("#logConsumeName").html(n.Name),$("#logConsumeSupplier").html(n.Supplier),$("#logConsumeSpecification").html(n.Specification),$("#logConsumePrice").html(n.Price));getLogConsumeList(!1)});$("#categoryQr").on("select2:select",function(){nameSelect(null,!1,"Qr");supplierSelect(null,!1,"Qr");specificationSelect(null,!1,"Qr");qrSiteSet("Qr")});$("#nameQr").on("select2:select",function(){supplierSelect(null,!1,"Qr");specificationSelect(null,!1,"Qr");qrSiteSet("Qr")});$("#supplierQr").on("select2:select",function(){specificationSelect(null,!1,"Qr");qrSiteSet("Qr")});$("#qrCodeList").on("click",".delQrCode",function(){var t,i,n;for($(this).parent().parent().remove(),t=$("#qrCodeList .printBox"),t.prop("style","float:left"),i=t.length,n=0;n<i;n++)(n+1)%24||t.eq(n).prop("style","page-break-after:always")});$("#increaseList,#consumePlanList,#consumeOtherList").on("click",".scanPrint",function(){new Promise(function(n){showPrintModal(n)}).then(n=>{if(n){var t=n.split(",")[0];$(this).next().val(t).trigger("change").trigger("select2:select")}})})}function qrSiteSet(n){new Promise(function(t){getMaterialList(n,t)}).then(t=>{for(var f={},e='<option value = "0">所有位置<\/option>',o=t.length,u,r,i=0;i<o;i++)u=t[i],r=u.SiteId,f[r]||(f[r]=1,e+='<option value = "{0}">{1}<\/option>'.format(r,u.Site));$(`#site${n}`).empty();$(`#site${n}`).append(e)})}function categorySelect(n){var i=816,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var u;if(t.errno!=0){layer.msg(t.errmsg);return}$("#categorySelect").empty();for(var f=t.datas,e=f.length,r='<option value = "0">所有类别<\/option>',i=0;i<e;i++)u=f[i],r+='<option value = "{0}">{1}<\/option>'.format(u.Id,u.Category);$("#categorySelect").append(r);n!=null&&n(r)})}function nameSelect(n,t=false,i){var e=824,f,r,u;if(!checkPermission(e)){layer.msg("没有权限");return}if(f={},!t){if(r=$(`#category${i}`).val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品类别");return}r!=0&&(f.categoryId=r)}u={};u.opType=e;u.opData=JSON.stringify(f);ajaxPost("/Relay/Post",u,function(t){var f;if(t.errno!=0){layer.msg(t.errmsg);return}for(var e=t.datas,o=e.length,u='<option value = "0">所有名称<\/option>',r=0;r<o;r++)f=e[r],u+='<option value = "{0}">{1}<\/option>'.format(f.Id,f.Name);$(`#name${i}`).empty();$(`#name${i}`).append(u);n!=null&&n(u)})}function supplierSelect(n,t=false,i){var o=831,r,u,f,e;if(!checkPermission(o)){layer.msg("没有权限");return}if(r={},!t){if(u=$(`#category${i}`).val(),isStrEmptyOrUndefined(u)){layer.msg("请选择货品类别");return}if(u!=0&&(r.categoryId=u),f=$(`#name${i}`).val(),isStrEmptyOrUndefined(f)){layer.msg("请选择货品名称");return}f!=0&&(r.nameId=f)}e={};e.opType=o;e.opData=JSON.stringify(r);ajaxPost("/Relay/Post",e,function(t){var f;if(t.errno!=0){layer.msg(t.errmsg);return}for(var e=t.datas,o=e.length,u='<option value = "0">所有供应商<\/option>',r=0;r<o;r++)f=e[r],u+='<option value = "{0}">{1}<\/option>'.format(f.Id,f.Supplier);$(`#supplier${i}`).empty();$(`#supplier${i}`).append(u);n!=null&&n(u)})}function specificationSelect(n,t=false,i){var s=839,r,u,f,e,o;if(!checkPermission(s)){layer.msg("没有权限");return}if(r={},!t){if(u=$(`#category${i}`).val(),isStrEmptyOrUndefined(u)){layer.msg("请选择货品类别");return}if(u!=0&&(r.categoryId=u),f=$(`#name${i}`).val(),isStrEmptyOrUndefined(f)){layer.msg("请选择货品名称");return}if(f!=0&&(r.nameId=f),e=$(`#supplier${i}`).val(),isStrEmptyOrUndefined(e)){layer.msg("请选择供应商名称");return}e!=0&&(r.supplierId=e)}o={};o.opType=s;o.opData=JSON.stringify(r);ajaxPost("/Relay/Post",o,function(t){var f;if(t.errno!=0){layer.msg(t.errmsg);return}for(var e=t.datas,o=e.length,u='<option value = "0">所有规格<\/option>',r=0;r<o;r++)f=e[r],u+='<option value = "{0}">{1}<\/option>'.format(f.Id,f.Specification);$(`#specification${i}`).empty();$(`#specification${i}`).append(u);n!=null&&n(u)})}function siteSelect(n){var i=847,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var u;if(t.errno!=0){layer.msg(t.errmsg);return}$("#siteSelect").empty();for(var f=t.datas,e=f.length,r='<option value = "0">所有位置<\/option>',i=0;i<e;i++)u=f[i],r+='<option value = "{0}">{1}<\/option>'.format(u.Id,u.Site);$("#siteSelect").append(r);n!=null&&n(r)})}function getMaterialList(n,t){var h=800,i,r,u,f,e,o,s;if(!checkPermission(h)){layer.msg("没有权限");return}if(i={},r=$(`#category${n}`).val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品类别");return}if(r!=0&&(i.categoryId=r),u=$(`#name${n}`).val(),isStrEmptyOrUndefined(u)){layer.msg("请选择货品名称");return}if(u!=0&&(i.nameId=u),f=$(`#supplier${n}`).val(),isStrEmptyOrUndefined(f)){layer.msg("请选择供应商名称");return}if(f!=0&&(i.supplierId=f),e=$(`#specification${n}`).val(),isStrEmptyOrUndefined(e)){layer.msg("请选择规格名称");return}if(e!=0&&(i.specificationId=e),o=$(`#site${n}`).val(),isStrEmptyOrUndefined(o)){layer.msg("请选择位置");return}o!=0&&(i.siteId=o);s={};s.opType=h;s.opData=JSON.stringify(i);ajaxPost("/Relay/Post",s,function(i){if(i.errno!=0){layer.msg(i.errmsg);return}if(t!=null&&n=="Qr"){t(i.datas);return}_materialList=i.datas;var r=function(n){return`<button type="button" class="btn btn-info btn-sm" onclick="showDetailModel(${n})">查看</button>`},u=function(n){return n.Number<n.Stock?`<strong class="text-red">${n.Number}</strong>`:`<span>${n.Number}</span>`},f=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"?"":t},e=function(n){var t=n.slice(0,n.indexOf(" "));return t=="0001-01-01"?"":t},o=function(n){return n.length>tdShowLength?`<span title="${n}" onclick="showAllContent('${escape(n)}')">${n.substring(0,tdShowLength)}...</span>`:`<span title="${n}">${n}</span>`},s=function(n){return`<button type="button" class="btn btn-success btn-sm" onclick="showLogModel(1, ${n.Id})">入库</button>`+`<button type="button" class="btn btn-success btn-sm" onclick="showLogModel(2, ${n.Id})">领用</button>`},h=0,c=function(){return++h};$("#materialList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:i.datas,aaSorting:[[0,"asc"]],aLengthMenu:[50,100,150,200],iDisplayLength:50,columns:[{data:null,title:"序号",render:c},{data:"Code",title:"货品编号"},{data:"Category",title:"类别"},{data:"Name",title:"名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格"},{data:"Site",title:"位置"},{data:"Unit",title:"单位"},{data:"Id",title:"详情",render:r},{data:"Price",title:"价格"},{data:"Stock",title:"最低库存",sClass:"text-blue"},{data:null,title:"库存数量",render:u},{data:"InTime",title:"上次入库",render:f},{data:"OutTime",title:"上次领用",render:e},{data:"Remark",title:"备注",render:o},{data:null,title:"日志",render:s}]})})}function showLogModel(n=0,t=0){var f,r,i;if($("#logStartDate").val(getDate()),$("#logEndDate").val(getDate()),_type!=n&&($("#logStartDate").val(getDate()),$("#logEndDate").val(getDate())),_type=n,f=803,!checkPermission(f)){layer.msg("没有权限");return}r="";switch(n){case 0:r="操作日志";break;case 1:r="入库日志";break;case 2:r="领用日志"}$("#logModal").find("h4").html(r);$("#billInfo").addClass("hidden");$("#logBillSelect").empty();for(var s=_materialList.length,e='<option value = "{0}">{1}<\/option>',o="",u=0;u<s;u++)i=_materialList[u],o+=e.format(i.Id,i.Code),t==i.Id&&($("#billInfo").removeClass("hidden"),$("#logCategory").html(i.Category),$("#logName").html(i.Name),$("#logSupplier").html(i.Supplier),$("#logSpecification").html(i.Specification),$("#logPrice").html(i.Price));$("#logBillSelect").append(e.format(0,"所有编号"));$("#logBillSelect").append(o);$("#logBillSelect").val(t).trigger("change");getLogList(!0)}function getLogList(n=false){var u,f;$("#logList").empty();var t={},i=$("#logStartDate").val(),r=$("#logEndDate").val();if(!isStrEmptyOrUndefined(i)&&!isStrEmptyOrUndefined(r)){if(i+=" 00:00:00",r+=" 23:59:59",exceedTime(i)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(i,r)){layer.msg("结束时间不能小于开始时间");return}if(u=$("#logBillSelect").val(),isStrEmptyOrUndefined(u)){layer.msg("请选择货品编号");return}u!=0&&(t.billId=u);t.startTime=i;t.endTime=r;_type!=0&&(t.type=_type);f={};f.opType=803;f.opData=JSON.stringify(t);ajaxPost("/Relay/Post",f,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}var f=0,r=function(){return++f},e=function(n){return n==1?`<span class="text-success">入库</span>`:`<span class="text-danger">领用</span>`},u=function(n){return n.Type==1?`<span class="text-success">${n.Number}</span>`:`<span class="text-danger">${n.Number}</span>`},i=null;switch(_type){case 0:i=[{data:null,title:"序号",render:r},{data:"Time",title:"时间"},{data:"Code",title:"货品编号"},{data:"Type",title:"入/出",render:e},{data:null,title:"数量",render:u},{data:"Purpose",title:"来源/用途"},{data:"RelatedPerson",title:"相关人"},{data:"Manager",title:"物管员"}];break;case 1:i=[{data:null,title:"序号",render:r},{data:"Time",title:"时间"},{data:"Code",title:"货品编号"},{data:null,title:"数量",render:u},{data:"Purpose",title:"货品来源"},{data:"RelatedPerson",title:"采购/退回人"},{data:"Manager",title:"物管员"},{data:null,title:"Id",bVisible:!1}];break;case 2:i=[{data:null,title:"序号",render:r},{data:"Time",title:"时间"},{data:"Code",title:"货品编号"},{data:null,title:"数量",render:u},{data:"Purpose",title:"货品用途"},{data:"RelatedPerson",title:"领用人"},{data:"Manager",title:"物管员"},{data:null,title:"Id",bVisible:!1}]}$("#logList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:t.datas,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:i});n&&$("#logModal").modal("show")})}}function showLogConsumeModel(n,t,i=0){var o,s,e,f,u,r;if($("#logConsumeStartDate").val(getDate()),$("#logConsumeEndDate").val(getDate()),t==1?$("#logConsumePlanSelectDiv").removeClass("hidden"):$("#logConsumePlanSelectDiv").addClass("hidden"),_purposeConsume!=t&&($("#logConsumeStartDate").val(getDate()),$("#logConsumeEndDate").val(getDate())),_purposeConsume=t,o=803,!checkPermission(o)){layer.msg("没有权限");return}if(s="领用日志",$("#logConsumeModal").find("h4").html(s),$("#billInfoConsume").addClass("hidden"),$("#logConsumePlanSelect").empty(),$("#logConsumeBillSelect").empty(),e='<option value = "{0}">{1}<\/option>',t==1){for(_logConsumePlanBill=_consumePlanBill,f="",u=0;u<_consumePlan.length;u++)r=_consumePlan[u],f+=e.format(r.Id,r.Plan);for($("#logConsumePlanSelect").append(f),$("#logConsumePlanSelect").val(i).trigger("change"),f="",u=0;u<_consumePlanBill.length;u++)r=_consumePlanBill[u],f+=e.format(r.BillId,r.Code),n==r.BillId&&($("#billInfoConsume").removeClass("hidden"),$("#logConsumeCategory").html(r.Category),$("#logConsumeName").html(r.Name),$("#logConsumeSupplier").html(r.Supplier),$("#logConsumeSpecification").html(r.Specification),$("#logConsumePrice").html(r.Price))}else if(t==2)for(_logConsumePlanBill=_materialList,f="",u=0;u<_materialList.length;u++)r=_materialList[u],f+=e.format(r.BillId,r.Code),n==r.BillId&&($("#billInfoConsume").removeClass("hidden"),$("#logConsumeCategory").html(r.Category),$("#logConsumeName").html(r.Name),$("#logConsumeSupplier").html(r.Supplier),$("#logConsumeSpecification").html(r.Specification),$("#logConsumePrice").html(r.Price));$("#logConsumeBillSelect").append(e.format(0,"所有编号"));$("#logConsumeBillSelect").append(f);$("#logConsumeBillSelect").val(n).trigger("change");getLogConsumeList(!0)}function getLogConsumeList(n=false){var u,f,e;$("#logConsumeList").empty();var t={},i=$("#logConsumeStartDate").val(),r=$("#logConsumeEndDate").val();if(!isStrEmptyOrUndefined(i)&&!isStrEmptyOrUndefined(r)){if(i+=" 00:00:00",r+=" 23:59:59",exceedTime(i)){layer.msg("开始时间不能大于当前时间");return}if(compareDate(i,r)){layer.msg("结束时间不能小于开始时间");return}if(u=$("#logConsumePlanSelect").val(),!$("#logConsumePlanSelectDiv").attr("hidden")){if(isStrEmptyOrUndefined(u)){layer.msg("请选择计划号");return}u!=0&&(t.planId=u)}if(f=$("#logConsumeBillSelect").val(),isStrEmptyOrUndefined(f)){layer.msg("计划中不存在该货品编号或货品编号不存在");return}f!=0&&(t.billId=f);t.startTime=i;t.endTime=r;t.type=2;t.purposeId=_purposeConsume;e={};e.opType=803;e.opData=JSON.stringify(t);ajaxPost("/Relay/Post",e,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}var u=0,i=function(){return++u},r=null;r=_purposeConsume==1?[{data:null,title:"序号",render:i},{data:"Time",title:"时间"},{data:"Purpose",title:"计划号"},{data:"Code",title:"货品编号"},{data:"Number",title:"数量"},{data:"RelatedPerson",title:"领用人"},{data:"Manager",title:"物管员"}]:[{data:null,title:"序号",render:i},{data:"Time",title:"时间"},{data:"Purpose",title:"用途"},{data:"Code",title:"货品编号"},{data:"Number",title:"数量"},{data:"RelatedPerson",title:"领用人"},{data:"Manager",title:"物管员"}];$("#logConsumeList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:t.datas,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:r});n&&$("#logConsumeModal").modal("show")})}}function showIncreaseModel(){if(!checkPermission(801)){layer.msg("没有权限");return}resetIncreaseList();var n=new Promise(function(n){var t={};t.opType=800;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_materialList=t.datas;n("success")},0)}),t=new Promise(function(n){var t={};t.opType=816;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeCategory=t.datas;n("success")},0)}),i=new Promise(function(n){var t={};t.opType=824;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeName=t.datas;n("success")},0)}),r=new Promise(function(n){var t={};t.opType=831;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeSupplier=t.datas;n("success")},0)}),u=new Promise(function(n){var t={};t.opType=839;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeSpecification=t.datas;n("success")},0)}),f=new Promise(function(n){var t={};t.opType=847;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeSite=t.datas;_consumeSiteDict=[];for(var i=0;i<_consumeSite.length;i++)_consumeSiteDict[_consumeSite[i].Id]=_consumeSite[i];n("success")},0)});Promise.all([n,t,i,r,u,f]).then(()=>{$("#addIncreaseListBtn").removeAttr("disabled")});$("#increaseModal").modal("show")}function resetIncreaseList(){$("#increaseList").empty();increaseMax=increaseMaxV=0}function addIncreaseList(){var h,i,c,n,u,r,t;if(increaseMax++,increaseMaxV++,h=`<tr id="in{0}" value="{0}" xh="{1}">
            <td style="vertical-align: inherit;"" id="inXh{0}">{1}</td>
            <td>
                <select class="form-control" id="inLy{0}" style="width:80px">
                    <option>采购</option>
                    <option>退回</option>
                </select>
            </td>
            <td>
                <span class="iconfont icon-saoyisao scanPrint" style="font-size:30px;cursor:pointer;vertical-align:middle"></span>
                <select class="ms2 form-control" id="inBh{0}"></select>
            </td>
            <td><select class="ms2 form-control" id="inLb{0}"></select></td>
            <td><select class="ms2 form-control" id="inMc{0}"></select></td>
            <td><select class="ms2 form-control" id="inGys{0}"></select></td>
            <td><select class="ms2 form-control" id="inGg{0}"></select></td>
            <td><select class="ms2 form-control" id="inWz{0}"></select></td>

            <td style="vertical-align: inherit;"><label class="control-label" id="inDw{0}"></label></td>
            <td style="vertical-align: inherit;"><label class="control-label" id="inJg{0}"></label></td>
            <td style="vertical-align: inherit;"><label class="control-label" id="inKc{0}"></label></td>
            <td><button class="btn btn-info btn-sm" type="button" id="inDetail{0}" onclick="showDetailModel({0})">详情</button></td>
            <td><input class="form-control text-center" type="tel" id="inRk{0}" value="0" onkeyup="onInput(this, 8, 0)" onblur="onInputEnd(this)" maxlength="10"></td>
            <td>
               <div style="display:flex;width:160px">
                   <input class="form-control text-center" id="inCg{0}" maxlength="64" />
                   <button class="btn btn-primary btn-sm pull-right" type="button" id="inDitto{0}" onclick="inDitto({0})" style="margin-left:3px">同上</button>
               </div>
            </td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="delIncreaseList({0})"><i class="fa fa-minus"></i></button></td>
        </tr>`.format(increaseMax,increaseMaxV),$("#increaseList").append(h),pcAndroid()||$("#increaseList").find(".scanPrint").addClass("hidden"),i=increaseMax,_materialList!=null){c='<option value="{0}">{1}<\/option>';n="#inBh"+i;$(n).empty();var l=0,f=0,e=0,o=0,s=0,a=0;for(r=0;r<_materialList.length;r++)t=_materialList[r],$(n).append(c.format(t.Id,t.Code)),r==0&&(l=t.BillId,f=t.CategoryId,e=t.NameId,o=t.SupplierId,s=t.SpecificationId,$("#inDw"+i).html(t.Unit),$("#inJg"+increaseMax).html(t.Price),$("#inKc"+increaseMax).html(t.Number),$("#inRk"+increaseMax).val(0));$(n).on("select2:select",function(){var c=0,e=0,o=0,s=0,h=0,f=0,l=$(this).val(),i=$(this).parents("tr:first").attr("value"),a=_materialList.length,u,r,t;for($("#inDw"+i).html(""),$("#inJg"+i).html(0),$("#inKc"+i).html(0),r=0;r<a;r++)if(t=_materialList[r],l==t.Id){for(c=t.BillId,e=t.CategoryId,o=t.NameId,s=t.SupplierId,h=t.SpecificationId,f=t.SiteId,$("#inWz"+i).val(f).trigger("change"),$("#inLb"+i).val(e).trigger("change"),$("#inDw"+i).html(t.Unit),$("#inJg"+i).html(t.Price),$("#inKc"+i).html(t.Number),n="#inMc"+i,updateConsumeSelect(n,o,_consumeName,"Name","CategoryId",e),n="#inGys"+i,updateConsumeSelect(n,s,_consumeSupplier,"Supplier","NameId",o),n="#inGg"+i,updateConsumeSelect(n,h,_consumeSpecification,"Specification","SupplierId",s),u=[],r=0;r<_materialList.length;r++)t=_materialList[r],t.SpecificationId==h&&_consumeSiteDict[t.SiteId]&&u.push(_consumeSiteDict[t.SiteId]);u.length>0&&(f=u[0].Id);updateConsumeSelect("#inWz"+i,f,u,"Site");break}$("#inDetail"+i).attr("onclick",`showDetailModel(${c})`)});n="#inLb"+i;updateConsumeSelect(n,f,_consumeCategory,"Category");$(n).on("select2:select",function(){var f=0,c=0,e=0,o=0,s=0,h=0,r,u,t,i;for(c=$(this).val(),r=$(this).parents("tr:first").attr("value"),h=$("#inWz"+r).val(),$("#inDw"+r).html(""),$("#inJg"+r).html(0),$("#inKc"+r).html(0),t=0;t<_consumeName.length;t++)if(i=_consumeName[t],i.CategoryId==c){e=i.Id;break}for(n="#inMc"+r,updateConsumeSelect(n,e,_consumeName,"Name","CategoryId",c),t=0;t<_consumeSupplier.length;t++)if(i=_consumeSupplier[t],i.NameId==e){o=i.Id;break}for(n="#inGys"+r,updateConsumeSelect(n,o,_consumeSupplier,"Supplier","NameId",e),t=0;t<_consumeSpecification.length;t++)if(i=_consumeSpecification[t],i.SupplierId==o){s=i.Id;break}for(n="#inGg"+r,updateConsumeSelect(n,s,_consumeSpecification,"Specification","SupplierId",o),u=[],t=0;t<_materialList.length;t++)i=_materialList[t],i.SpecificationId==s&&_consumeSiteDict[i.SiteId]&&u.push(_consumeSiteDict[i.SiteId]);for(u.length>0&&(h=u[0].Id),updateConsumeSelect("#inWz"+r,h,u,"Site"),$("#inBh"+r).val(0).trigger("change"),t=0;t<_materialList.length;t++)if(i=_materialList[t],i.SpecificationId==s&&i.SiteId==h){f=i.BillId;$("#in"+r).attr("billId",f);$("#inBh"+r).val(f).trigger("change");$("#inDw"+r).html(i.Unit);$("#inJg"+r).html(i.Price);$("#inKc"+r).html(i.Number);break}$("#inDetail"+r).attr("onclick",`showDetailModel(${f})`)});n="#inMc"+i;updateConsumeSelect(n,e,_consumeName,"Name","CategoryId",f);$(n).on("select2:select",function(){var f=0,h=0,e=0,o=0,s=0,i,u,r,t;for(h=$(this).val(),i=$(this).parents("tr:first").attr("value"),s=$("#inWz"+i).val(),$("#inDw"+i).html(""),$("#inJg"+i).html(0),$("#inKc"+i).html(0),r=0;r<_consumeSupplier.length;r++)if(t=_consumeSupplier[r],t.NameId==h){e=t.Id;break}for(n="#inGys"+i,updateConsumeSelect(n,e,_consumeSupplier,"Supplier","NameId",h),r=0;r<_consumeSpecification.length;r++)if(t=_consumeSpecification[r],t.SupplierId==e){o=t.Id;break}for(n="#inGg"+i,updateConsumeSelect(n,o,_consumeSpecification,"Specification","SupplierId",e),u=[],r=0;r<_materialList.length;r++)t=_materialList[r],t.SpecificationId==o&&_consumeSiteDict[t.SiteId]&&u.push(_consumeSiteDict[t.SiteId]);for(u.length>0&&(s=u[0].Id),updateConsumeSelect("#inWz"+i,s,u,"Site"),$("#in"+i).attr("billId",0),$("#inBh"+i).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(t=_materialList[r],t.SpecificationId==o&&t.SiteId==s){f=t.BillId;$("#in"+i).attr("billId",f);$("#inBh"+i).val(f).trigger("change");$("#inDw"+i).html(t.Unit);$("#inJg"+i).html(t.Price);$("#inKc"+i).html(t.Number);break}$("#inDetail"+i).attr("onclick",`showDetailModel(${f})`)});n="#inGys"+i;updateConsumeSelect(n,o,_consumeSupplier,"Supplier","NameId",e);$(n).on("select2:select",function(){var f=0,s=0,e=0,o=0,t,u,r,i;for(s=$(this).val(),t=$(this).parents("tr:first").attr("value"),o=$("#inWz"+t).val(),$("#inDw"+t).html(""),$("#inJg"+t).html(0),$("#inKc"+t).html(0),r=0;r<_consumeSpecification.length;r++)if(i=_consumeSpecification[r],i.SupplierId==s){e=i.Id;break}for(n="#inGg"+t,updateConsumeSelect(n,e,_consumeSpecification,"Specification","SupplierId",s),u=[],r=0;r<_materialList.length;r++)i=_materialList[r],i.SpecificationId==e&&_consumeSiteDict[i.SiteId]&&u.push(_consumeSiteDict[i.SiteId]);for(u.length>0&&(o=u[0].Id),updateConsumeSelect("#inWz"+t,o,u,"Site"),$("#in"+t).attr("billId",0),$("#inBh"+t).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(i=_materialList[r],i.SpecificationId==e&&i.SiteId==o){f=i.BillId;$("#in"+t).attr("billId",f);$("#inBh"+t).val(f).trigger("change");$("#inDw"+t).html(i.Unit);$("#inJg"+t).html(i.Price);$("#inKc"+t).html(i.Number);break}$("#inDetail"+t).attr("onclick",`showDetailModel(${f})`)});n="#inGg"+i;updateConsumeSelect(n,s,_consumeSpecification,"Specification","SupplierId",o);$(n).on("select2:select",function(){var f=0,e=0,o=0,t,u,r,i;for(e=$(this).val(),t=$(this).parents("tr:first").attr("value"),u=[],r=0;r<_materialList.length;r++)i=_materialList[r],i.SpecificationId==e&&_consumeSiteDict[i.SiteId]&&u.push(_consumeSiteDict[i.SiteId]);for(u.length>0&&(o=u[0].Id),updateConsumeSelect(n,o,u,"Site"),$("#inDw"+t).html(""),$("#inJg"+t).html(0),$("#inKc"+t).html(0),$("#in"+t).attr("billId",0),$("#inBh"+t).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(i=_materialList[r],i.SpecificationId==e&&i.SiteId==o){f=i.BillId;$("#in"+t).attr("billId",f);$("#inBh"+t).val(f).trigger("change");$("#inDw"+t).html(i.Unit);$("#inJg"+t).html(i.Price);$("#inKc"+t).html(i.Number);break}$("#inDetail"+t).attr("onclick",`showDetailModel(${f})`)});for(n="#inWz"+i,u=[],r=0;r<_materialList.length;r++)t=_materialList[r],t.SpecificationId==s&&_consumeSiteDict[t.SiteId]&&u.push(_consumeSiteDict[t.SiteId]);u.length>0&&(a=u[0].Id);updateConsumeSelect(n,a,u,"Site");$(n).on("select2:select",function(){var i=0,u=0,f=0,n,r,t;for(f=$(this).val(),n=$(this).parents("tr:first").attr("value"),u=$("#inGg"+n).val(),$("#inDw"+n).html(""),$("#inJg"+n).html(0),$("#inKc"+n).html(0),$("#in"+n).attr("billId",0),$("#inBh"+n).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(t=_materialList[r],t.SpecificationId==u&&t.SiteId==f){i=t.BillId;$("#in"+n).attr("billId",i);$("#inBh"+n).val(i).trigger("change");$("#inDw"+n).html(t.Unit);$("#inJg"+n).html(t.Price);$("#inKc"+n).html(t.Number);break}$("#inDetail"+n).attr("onclick",`showDetailModel(${i})`)});$("#in"+i).find(".ms2").css("width","100%");$("#in"+i).find(".ms2").select2({width:"120px"});$("#inDetail"+i).attr("onclick",`showDetailModel(${l})`)}ditto()}function delIncreaseList(n){var i,r,t,u;for($("#increaseList").find(`tr[value=${n}]:first`).remove(),increaseMaxV--,i=1,r=$("#increaseList tr"),t=0;t<r.length;t++)$(r[t]).attr("xh",i),u=$(r[t]).attr("value"),$("#inXh"+u).html(i),i++;ditto()}function ditto(){var n=$("#increaseList").find(`tr[xh=1]:first`).attr("value");$("#inDitto"+n).css("opacity","0")}function inDitto(n){var t=$("#inXh"+n).html(),i=parseInt(t)-1,r=$("#increaseList").find(`tr[xh=${i}]:first`).attr("value"),u=$("#inCg"+r).val();$("#inCg"+n).val(u)}function increase(){for(var e=801,t=[],f,n=1;n<=increaseMax;n++)if($("#inBh"+n).length>0){var r=$("#inBh"+n).val(),o=$("#inLy"+n).val(),i=$("#inRk"+n).val(),u=$("#inCg"+n).val();if(isStrEmptyOrUndefined(r)){layer.msg("货品编号不能为空");return}if(isStrEmptyOrUndefined(i)){layer.msg($(`#inXh${n}`).html()+". "+$(`#inBh${n} option:checked`).text()+": 入库数量不能为空");return}if(parseInt(i)<=0){layer.msg($(`#inXh${n}`).html()+". "+$(`#inBh${n} option:checked`).text()+": 入库数量需大于0");return}if(isStrEmptyOrUndefined(u)){layer.msg("采购/退回人不能为空");return}t.push({BillId:r,Purpose:o,Number:i,RelatedPerson:u})}if(t.length<=0){layer.msg("请输入货品");return}f=function(){$("#increaseModal").modal("hide");var n={};n.opType=e;n.opData=JSON.stringify({Bill:t});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getMaterialList("Select")})};showConfirm("入库",f)}function tabClick(n){_consumeType=n;_consumeActualList=[];n==0?consumePlanActual():n==0&&consumeOtherActual()}function showConsumeModel(){var n,t;if(!checkPermission(802)){layer.msg("没有权限");return}_consumePlanList=[];_consumeOtherList=[];_consumeActualList=[];$("#planConsumeLi").attr("aria-expanded")=="false"&&$("#planConsumeLi").click();$("#consumePlanRemarkDiv").addClass("hidden");$("#consumePlanCondition").val("");$("#consumePlanSelect").empty();$("#consumeOther").val("");resetConsumePlanList();resetConsumeOtherList();n={};n.first=!0;n.simple=!0;t={};t.opType=700;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,function(n){var t;if(n.errno!=0){layer.msg(n.errmsg);return}if(_consumePlan=n.datas,_consumePlan.length>0){for(var u=_consumePlan.length,r="",i=0;i<u;i++)t=_consumePlan[i],r+='<option value = "{0}">{1}<\/option>'.format(t.Id,t.Plan),i==0&&(isStrEmptyOrUndefined(t.Remark)?($("#consumePlanRemarkDiv").addClass("hidden"),$("#consumePlanRemark").html("")):($("#consumePlanRemarkDiv").removeClass("hidden"),$("#consumePlanRemark").html(t.Remark)),_consumePlanBill=t.FirstBill);$("#consumePlanSelect").append(r);getPlanBill()}var f=new Promise(function(n){var t={};t.opType=800;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_materialList=t.datas;n("success")},0)}),e=new Promise(function(n){var t={};t.opType=816;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeCategory=t.datas;n("success")},0)}),o=new Promise(function(n){var t={};t.opType=824;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeName=t.datas;n("success")},0)}),s=new Promise(function(n){var t={};t.opType=831;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeSupplier=t.datas;n("success")},0)}),h=new Promise(function(n){var t={};t.opType=839;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeSpecification=t.datas;n("success")},0)}),c=new Promise(function(n){var t={};t.opType=847;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_consumeSite=t.datas;_consumeSiteDict=[];for(var i=0;i<_consumeSite.length;i++)_consumeSiteDict[_consumeSite[i].Id]=_consumeSite[i];n("success")},0)});Promise.all([f,e,o,s,h,c]).then(()=>{$("#addConsumePlanListBtn").removeAttr("disabled"),$("#addConsumeOtherListBtn").removeAttr("disabled")})});$("#consumeModal").modal("show")}function getPlanBill(n=false){var t,r,i;n?(t={},r=$("#consumePlanSelect").val(),t.planId=r,t.stock=!0,i={},i.opType=704,i.opData=JSON.stringify(t),ajaxPost("/Relay/Post",i,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}_consumePlanBill=n.datas;showPlanBill()})):showPlanBill()}function showPlanBill(n=false){var p=$("#consumePlanSelect").val(),u,s,l,f,e;if(n){var h=$("#consumePlanCondition").val(),a="",v="0";if(isStrEmptyOrUndefined(h))$("#consumePlanList tr").removeClass("hidden");else{a=$("#consumePlanCondition1").val();u="";switch(a){case"Code":u="conPlanBh";break;case"Category":u="conPlanLb";break;case"Name":u="conPlanMc";break;case"Supplier":u="conPlanGys";break;case"Specification":u="conPlanGg";break;case"Site":u="conPlanWz";break;default:return}for(v=$("#consumePlanCondition2").val(),f=$("#consumePlanList tr"),i=0;i<f.length;i++){var o=f[i],y=$(o).attr("value"),c="";c=$(o).hasClass("new")?$(`#${u+y} option:checked`).text():$(`#${u+y}`).html();s=!1;switch(v){case"0":c==h&&(s=!0);break;case"1":c!=h&&(s=!0);break;case"2":c.indexOf(h)!=-1&&(s=!0)}s?$(o).removeClass("hidden"):$(o).addClass("hidden")}}consumePlanDittoAuto()}else if(l=_consumePlanBill,$("#consumePlanList").empty(),l.length>0){for(f="",e=0;e<l.length;e++){var t=e+1,r=l[e],o=`
                <tr id="conPlan${t}" value="${t}" xh="${t}" billId="${r.BillId}">
                    <td style="vertical-align: inherit;">${t}</td>
                    <td style="vertical-align: inherit;" id="conPlanBh${t}" ${r.Extra?'class="text-red"':""}>${r.Code}</td>
                    <td style="vertical-align: inherit;" id="conPlanLb${t}">${r.Category}</td>
                    <td style="vertical-align: inherit;" id="conPlanMc${t}">${r.Name}</td>
                    <td style="vertical-align: inherit;" id="conPlanGys${t}">${r.Supplier}</td>
                    <td style="vertical-align: inherit;" id="conPlanGg${t}">${r.Specification}</td>
                    <td style="vertical-align: inherit;" id="conPlanWz${t}">${r.Site}</td>
                    <td style="vertical-align: inherit;">${r.Unit}</td>
                    <td>
                        <button type="button" class="btn btn-info btn-sm" id="conPlanDetail${t}" onclick="showDetailModel(${r.BillId})">详情</button>
                    </td>
                    <td style="vertical-align: inherit;">${r.PlannedConsumption}</td>
                    <td style="vertical-align: inherit;">${r.ActualConsumption}</td>
                    <td style="vertical-align: inherit;" class="form-inline">
                        <span id="conPlanNum${t}">${r.Number}</span>
                        <button type="button" class="btn btn-danger btn-xs pull-right" onclick="consumePlanUpdateNum(${r.BillId})"><i class="fa fa-refresh"></i></button>
                    </td>
                    <td>
                        <input class="form-control text-center" type="tel" id="conPlanConsume${t}" value="0" onkeyup="onInput(this, 8, 0)" onblur="onInputEnd(this)" onchange="consumePlanActual()" maxlength="10">
                    </td>
                    <td>
                        <div style="display:flex;width:150px">
                            <input class="form-control text-center" id="conPlanLyr${t}" maxlength="64" onchange="consumePlanActual()" />
                            <button class="btn btn-primary btn-sm conPlanDitto" ${e==0?'style="opacity: 0;"':""} type="button" id="consumePlanDitto${t}" style="margin-left:3px" onclick="consumePlanDitto(${t})">同上</button>
                        </div>
                    </td>
                    <td>
                        <button type="button" class="btn btn-success btn-sm" onclick="showLogConsumeModel(${r.BillId}, 1, ${p})">查看</button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm hidden" id="delConsumePlanList${t}" onclick="delConsumePlanList(${t})"><i class="fa fa-minus"></i></button>
                    </td>
                </tr>`;f+=o}$("#consumePlanList").append(f);consumePlanMax=_consumePlanBill.length;consumePlanMaxV=_consumePlanBill.length}}function consumePlanUpdateNum(n){var t={};t.opType=800;t.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",t,function(t){var r,u,e,i,f;if(t.errno!=0){layer.msg(t.errmsg);return}for(r=t.datas[0],u=$(`#consumePlanList [billId=${n}]`),i=0;i<u.length;i++)e=$(u[i]).attr("value"),$("#conPlanNum"+e).html(r.Number);for(i=0;i<_materialList.length;i++)if(f=_materialList[i],f.Id==n){f.Number=r.Number;break}})}function resetConsumePlanList(){$("#consumePlanList").empty();addConsumePlanFrom=consumePlanMax=consumePlanMaxV=0}function addConsumePlanList(){var n,a,v,t,c,f,l,r,i,p;if(_consumePlan&&_consumePlan.length>0){if(consumePlanMax++,consumePlanMaxV++,n=addConsumePlanFrom=consumePlanMax,a=`
        <tr id="conPlan${n}" value="${n}" xh="${consumePlanMaxV}" class="new">
            <td style="vertical-align: inherit;"><span class="control-label xh" id="conPlanXh${n}">${consumePlanMaxV}</span></td>
            <td>
                <span class="iconfont icon-saoyisao scanPrint" style="font-size:30px;cursor:pointer;vertical-align:middle"></span>
                <select class="ms2 form-control" id="conPlanBh${n}"></select>
            </td>
            <td><select class="ms2 form-control" id="conPlanLb${n}"></select></td>
            <td><select class="ms2 form-control" id="conPlanMc${n}"></select></td>
            <td><select class="ms2 form-control" id="conPlanGys${n}"></select></td>
            <td><select class="ms2 form-control" id="conPlanGg${n}"></select></td>
            <td><select class="ms2 form-control" id="conPlanWz${n}"></select></td>
            <td style="vertical-align: inherit;" id="conPlanDw${n}"></td>
            <td>
                <button type="button" class="btn btn-info btn-sm" id="conPlanDetail${n}" onclick="showDetailModel(0)">详情</button>
            </td>
            <td style="vertical-align: inherit;" id="conPlanJh${n}"></td>
            <td style="vertical-align: inherit;" id="conPlanSj${n}"></td>
            <td style="vertical-align: inherit;" class="form-inline">
                <span id="conPlanNum${n}"></span>
                <button type="button" class="btn btn-danger btn-xs pull-right" id="conPlanUpdateNum${n}" onclick="consumePlanUpdateNum(0)"><i class="fa fa-refresh"></i></button>
            </td>
            <td>
                <input class="form-control text-center" id="conPlanConsume${n}" value="0" onkeyup="onInput(this, 8, 0)" onblur="onInputEnd(this)" onchange="consumePlanActual()" maxlength="10">
            </td>
            <td>
                <div style="display:flex;width:150px">
                    <input class="form-control text-center" type="tel" id="conPlanLyr${n}" maxlength="64" onchange="consumePlanActual()" />
                    <button class="btn btn-primary btn-sm" ${n==1?'style="opacity: 0;"':""} type="button" id="consumePlanDitto${n}" style="margin-left:3px" onclick="consumePlanDitto(${n})">同上</button>
                </div>
            </td>
            <td>
                <button type="button" class="btn btn-success btn-sm" id="conPlanLog${n}" onclick="showLogConsumeModel(2, 0)">查看</button>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm ${n==1?" hidden":""}" id="delConsumePlanList${n}" onclick="delConsumePlanList(${n})"><i class="fa fa-minus"></i></button>
            </td>
        </tr>`,$("#consumePlanList").append(a),pcAndroid()||$("#consumePlanList").find(".scanPrint").addClass("hidden"),_materialList!=null){v='<option value="{0}">{1}<\/option>';t="#conPlanBh"+n;$(t).empty();var u=0,e=0,o=0,s=0,h=0,y=0;for(r=0;r<_materialList.length;r++)if(i=_materialList[r],$(t).append(v.format(i.Id,i.Code)),r==0){for(u=i.BillId,$("#conPlan"+n).attr("billId",u),e=i.CategoryId,o=i.NameId,s=i.SupplierId,h=i.SpecificationId,y=i.SiteId,$("#conPlanDw"+n).html(i.Unit),$("#conPlanJh"+n).html(0),$("#conPlanSj"+n).html(0),c=0;c<_consumePlanBill.length;c++)if(f=_consumePlanBill[r],f.BillId==u){$("#conPlanJh"+n).html(f.PlannedConsumption);$("#conPlanSj"+n).html(f.ActualConsumption);break}$("#conPlanNum"+n).html(i.Number)}$(t).on("select2:select",function(){var f=0,h=0,c=0,l=0,a=0,e=0,v=$(this).val(),n=$(this).parents("tr:first").attr("value"),y=_materialList.length,o,s,u,r,i;for($("#conPlanDw"+n).html(""),$("#conPlanNum"+n).html(0),r=0;r<y;r++)if(i=_materialList[r],v==i.Id){if(f=i.BillId,$("#conPlan"+n).attr("billId",f),h=i.CategoryId,c=i.NameId,l=i.SupplierId,a=i.SpecificationId,e=i.SiteId,$("#conPlanWz"+n).val(e).trigger("change"),$("#conPlanLb"+n).val(h).trigger("change"),$("#conPlanDw"+n).html(i.Unit),$("#conPlanJh"+n).html(0),$("#conPlanSj"+n).html(0),_consumePlanBill!=null)for(o=0;o<_consumePlanBill.length;o++)if(s=_consumePlanBill[o],s.BillId==f){$("#conPlanJh"+n).html(s.PlannedConsumption);$("#conPlanSj"+n).html(s.ActualConsumption);break}for($("#conPlanNum"+n).html(i.Number),t="#conPlanMc"+n,updateConsumeSelect(t,c,_consumeName,"Name","CategoryId",h),t="#conPlanGys"+n,updateConsumeSelect(t,l,_consumeSupplier,"Supplier","NameId",c),t="#conPlanGg"+n,updateConsumeSelect(t,a,_consumeSpecification,"Specification","SupplierId",l),u=[],r=0;r<_materialList.length;r++)i=_materialList[r],i.SpecificationId==a&&_consumeSiteDict[i.SiteId]&&u.push(_consumeSiteDict[i.SiteId]);u.length>0&&(e=u[0].Id);updateConsumeSelect($("#conPlanWz"+n),e,u,"Site");break}consumePlanActual();$("#conPlanDetail"+n).attr("onclick",`showDetailModel(${f})`)});t="#conPlanLb"+n;updateConsumeSelect(t,e,_consumeCategory,"Category");$(t).on("select2:select",function(){var u=0,a=0,e=0,o=0,s=0,h=0,i,f,n,r,c,l;for(a=$(this).val(),i=$(this).parents("tr:first").attr("value"),h=$("#conPlanWz"+i).val(),$("#conPlanDw"+i).html(""),$("#conPlanNum"+i).html(0),n=0;n<_consumeName.length;n++)if(r=_consumeName[n],r.CategoryId==a){e=r.Id;break}for(t="#conPlanMc"+i,updateConsumeSelect(t,e,_consumeName,"Name","CategoryId",a),n=0;n<_consumeSupplier.length;n++)if(r=_consumeSupplier[n],r.NameId==e){o=r.Id;break}for(t="#conPlanGys"+i,updateConsumeSelect(t,o,_consumeSupplier,"Supplier","NameId",e),n=0;n<_consumeSpecification.length;n++)if(r=_consumeSpecification[n],r.SupplierId==o){s=r.Id;break}for(t="#conPlanGg"+i,updateConsumeSelect(t,s,_consumeSpecification,"Specification","SupplierId",o),f=[],n=0;n<_materialList.length;n++)r=_materialList[n],r.SpecificationId==s&&_consumeSiteDict[r.SiteId]&&f.push(_consumeSiteDict[r.SiteId]);for(f.length>0&&(h=f[0].Id),updateConsumeSelect($("#conPlanWz"+i),h,f,"Site"),$("#conPlan"+i).attr("billId",0),$("#conPlanBh"+i).val(0).trigger("change"),n=0;n<_materialList.length;n++)if(r=_materialList[n],r.SpecificationId==s&&r.SiteId==h){for(u=r.BillId,$("#conPlan"+i).attr("billId",u),$("#conPlanBh"+i).val(u).trigger("change"),$("#conPlanDw"+i).html(r.Unit),$("#conPlanJh"+i).html(0),$("#conPlanSj"+i).html(0),c=0;c<_consumePlanBill.length;c++)if(l=_consumePlanBill[c],l.BillId==u){$("#conPlanJh"+i).html(l.PlannedConsumption);$("#conPlanSj"+i).html(l.ActualConsumption);break}$("#conPlanNum"+i).html(r.Number);break}consumePlanActual();$("#conPlanDetail"+i).attr("onclick",`showDetailModel(${u})`)});t="#conPlanMc"+n;updateConsumeSelect(t,o,_consumeName,"Name","CategoryId",e);$(t).on("select2:select",function(){var u=0,l=0,e=0,o=0,s=0,n,f,i,r,h,c;for(l=$(this).val(),n=$(this).parents("tr:first").attr("value"),s=$("#conPlanWz"+n).val(),$("#conPlanDw"+n).html(""),$("#conPlanNum"+n).html(0),i=0;i<_consumeSupplier.length;i++)if(r=_consumeSupplier[i],r.NameId==l){e=r.Id;break}for(t="#conPlanGys"+n,updateConsumeSelect(t,e,_consumeSupplier,"Supplier","NameId",l),i=0;i<_consumeSpecification.length;i++)if(r=_consumeSpecification[i],r.SupplierId==e){o=r.Id;break}for(t="#conPlanGg"+n,updateConsumeSelect(t,o,_consumeSpecification,"Specification","SupplierId",e),f=[],i=0;i<_materialList.length;i++)r=_materialList[i],r.SpecificationId==o&&_consumeSiteDict[r.SiteId]&&f.push(_consumeSiteDict[r.SiteId]);for(f.length>0&&(s=f[0].Id),updateConsumeSelect($("#conPlanWz"+n),s,f,"Site"),$("#conPlan"+n).attr("billId",0),$("#conPlanBh"+n).val(0).trigger("change"),i=0;i<_materialList.length;i++)if(r=_materialList[i],r.SpecificationId==o&&r.SiteId==s){for(u=r.BillId,$("#conPlan"+n).attr("billId",u),$("#conPlanBh"+n).val(u).trigger("change"),$("#conPlanDw"+n).html(r.Unit),$("#conPlanJh"+n).html(0),$("#conPlanSj"+n).html(0),h=0;h<_consumePlanBill.length;h++)if(c=_consumePlanBill[h],c.BillId==u){$("#conPlanJh"+n).html(c.PlannedConsumption);$("#conPlanSj"+n).html(c.ActualConsumption);break}$("#conPlanNum"+n).html(r.Number);break}consumePlanActual();$("#conPlanDetail"+n).attr("onclick",`showDetailModel(${u})`)});t="#conPlanGys"+n;updateConsumeSelect(t,s,_consumeSupplier,"Supplier","NameId",o);$(t).on("select2:select",function(){var u=0,e=0,c=0,o=0,n,f,r,i,s,h;for(e=$(this).val(),n=$(this).parents("tr:first").attr("value"),o=$("#conPlanWz"+n).val(),$("#conPlanDw"+n).html(""),$("#conPlanNum"+n).html(0),r=0;r<_consumeSpecification.length;r++)if(i=_consumeSpecification[r],i.SupplierId==e){c=i.Id;break}for(t="#conPlanGg"+n,updateConsumeSelect(t,c,_consumeSpecification,"Specification","SupplierId",e),f=[],r=0;r<_materialList.length;r++)i=_materialList[r],i.SupplierId==e&&_consumeSiteDict[i.SiteId]&&f.push(_consumeSiteDict[i.SiteId]);for(f.length>0&&(o=f[0].Id),updateConsumeSelect($("#conPlanWz"+n),o,f,"Site"),$("#conPlan"+n).attr("billId",0),$("#conPlanBh"+n).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(i=_materialList[r],i.SpecificationId==c&&i.SiteId==o){for(u=i.BillId,$("#conPlan"+n).attr("billId",u),$("#conPlanBh"+n).val(u).trigger("change"),$("#conPlanDw"+n).html(i.Unit),$("#conPlanJh"+n).html(0),$("#conPlanSj"+n).html(0),s=0;s<_consumePlanBill.length;s++)if(h=_consumePlanBill[s],h.BillId==u){$("#conPlanJh"+n).html(h.PlannedConsumption);$("#conPlanSj"+n).html(h.ActualConsumption);break}$("#conPlanNum"+n).html(i.Number);break}consumePlanActual();$("#conPlanDetail"+n).attr("onclick",`showDetailModel(${u})`)});t="#conPlanGg"+n;updateConsumeSelect(t,h,_consumeSpecification,"Specification","SupplierId",s);$(t).on("select2:select",function(){var r=0,s=0,f=0,n,u,i,t,e,o;for(s=$(this).val(),n=$(this).parents("tr:first").attr("value"),f=$("#conPlanWz"+n).val(),u=[],i=0;i<_materialList.length;i++)t=_materialList[i],t.SpecificationId==s&&_consumeSiteDict[t.SiteId]&&u.push(_consumeSiteDict[t.SiteId]);for(u.length>0&&(f=u[0].Id),updateConsumeSelect($("#conPlanWz"+n),f,u,"Site"),$("#conPlanDw"+n).html(""),$("#conPlanNum"+n).html(0),$("#conPlan"+n).attr("billId",0),$("#conPlanBh"+n).val(0).trigger("change"),i=0;i<_materialList.length;i++)if(t=_materialList[i],t.SpecificationId==s&&t.SiteId==f){for(r=t.BillId,$("#conPlan"+n).attr("billId",r),$("#conPlanBh"+n).val(r).trigger("change"),$("#conPlanDw"+n).html(t.Unit),$("#conPlanJh"+n).html(0),$("#conPlanSj"+n).html(0),e=0;e<_consumePlanBill.length;e++)if(o=_consumePlanBill[e],o.BillId==r){$("#conPlanJh"+n).html(o.PlannedConsumption);$("#conPlanSj"+n).html(o.ActualConsumption);break}$("#conPlanNum"+n).html(t.Number);break}consumePlanActual();$("#conPlanDetail"+n).attr("onclick",`showDetailModel(${r})`)});for(t="#conPlanWz"+n,l=[],r=0;r<_materialList.length;r++)i=_materialList[r],i.SpecificationId==h&&_consumeSiteDict[i.SiteId]&&l.push(_consumeSiteDict[i.SiteId]);updateConsumeSelect(t,y,l,"Site");$(t).on("select2:select",function(){var i=0,e=0,o=0,n,r,t,u,f;for(o=$(this).val(),n=$(this).parents("tr:first").attr("value"),e=$("#conPlanGg"+n).val(),$("#conPlanDw"+n).html(""),$("#conPlanNum"+n).html(0),$("#conPlan"+n).attr("billId",0),$("#conPlanBh"+n).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(t=_materialList[r],t.SpecificationId==e&&t.SiteId==o){for(i=t.BillId,$("#conPlan"+n).attr("billId",i),$("#conPlanBh"+n).val(i).trigger("change"),$("#conPlanDw"+n).html(t.Unit),$("#conPlanJh"+n).html(0),$("#conPlanSj"+n).html(0),u=0;u<_consumePlanBill.length;u++)if(f=_consumePlanBill[u],f.BillId==i){$("#conPlanJh"+n).html(f.PlannedConsumption);$("#conPlanSj"+n).html(f.ActualConsumption);break}$("#conPlanNum"+n).html(t.Number);break}consumePlanActual();$("#conPlanDetail"+n).attr("onclick",`showDetailModel(${i})`)});$("#conPlan"+n).find(".ms2").css("width","100%");$("#conPlan"+n).find(".ms2").select2({width:"120px"});$("#conPlanDetail"+n).attr("onclick",`showDetailModel(${u})`);$("#conPlanUpdateNum"+n).attr("onclick",`consumePlanUpdateNum(${u})`);p=$("#consumePlanSelect").val();$("#conPlanLog"+n).attr("onclick",`showLogConsumeModel(${u}, 1, ${p})`)}consumePlanDittoAuto()}}function updateConsumeSelect(n,t,i,r,u="",f=-1){var o,s,e;for($(n).empty(),o="",s=0;s<i.length;s++)e=i[s],f!=-1?f!=0&&e[u]==f&&(o+=`<option value="${e.Id}">${e[r]}</option>`):o+=`<option value="${e.Id}">${e[r]}</option>`;$(n).append(o);t&&t!=0&&$(n).val(t).trigger("change")}function delConsumePlanList(n){var i,r,t,u;for($("#consumePlanList").find(`tr[value=${n}]:first`).remove(),consumePlanMaxV--,i=1,r=$("#consumePlanList tr"),t=0;t<r.length;t++)$(r[t]).attr("xh",i),u=$(r[t]).attr("value"),$("#conPlanXh"+u).html(i),i++;consumePlanDittoAuto()}function consumePlanDittoAuto(){$("#consumePlanList").find(`.conPlanDitto`).css("opacity","100");$("#consumePlanList").find(`.conPlanDitto`).removeAttr("disable","disable");$("#consumePlanList tr").not(".hidden").first().find(`.conPlanDitto`).css("opacity","0");$("#consumePlanList tr").not(".hidden").first().find(`.conPlanDitto`).attr("disable","disable")}function consumePlanDitto(n){var i=$("#consumePlanList tr").not(".hidden"),r,t,u,f,e;if(!(i.length<=1)){for(r=-1,t=i.length-1;t>=0;t--)if(u=i[t],f=$(u).attr("value"),n==f){r=t-1;break}r>-1&&(e=$("#conPlanLyr"+$(i[r]).attr("xh")).val(),$("#conPlanLyr"+n).val(e))}}function consumePlanActual(){var i,c,e,u,h,n,f,t;for(_consumePlanList=[],c=$("#consumePlanSelect option:checked").text(),e=$("#consumePlanList tr"),i=0;i<e.length;i++){var o=e[i],l=$(o).attr("billId"),r=$(o).attr("value"),s=$("#conPlanConsume"+r).val();for(isStrEmptyOrUndefined(s)&&(s=0),u=$("#conPlanLyr"+r).val(),isStrEmptyOrUndefined(u)&&(u=""),h="",h=$(o).hasClass("new")?$(`#conPlanBh${r} option:checked`).text():$(`#conPlanBh${r}`).html(),n={Code:h,Purpose:c,RelatedPerson:u,BillId:l,Number:s,Exist:!1},f=0;f<_materialList.length;f++)if(t=_materialList[f],t.BillId==l){n.Exist=!0;n.Code=t.Code;n.Category=t.Category;n.Name=t.Name;n.Supplier=t.Supplier;n.Specification=t.Specification;n.Site=t.Site;break}_consumePlanList.push(n)}}function consumeOtherUpdateNum(n){var t={};t.opType=800;t.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",t,function(t){var r,u,e,i,f;if(t.errno!=0){layer.msg(t.errmsg);return}for(r=t.datas[0],u=$(`#consumeOtherList [billId=${n}]`),i=0;i<u.length;i++)e=$(u[i]).attr("value"),$("#consumeOtherNum"+e).html(r.Number);for(i=0;i<_materialList.length;i++)if(f=_materialList[i],f.Id==n){f.Number=r.Number;break}})}function resetConsumeOtherList(){$("#consumeOtherList").empty();addConsumeOtherFrom=consumeOtherMax=consumeOtherMaxV=0}function addConsumeOtherList(){var t,l,a,n,f,r,i;if(consumeOtherMax++,consumeOtherMaxV++,t=addConsumeOtherFrom=consumeOtherMax,l=`
        <tr id="conOther${t}" value="${t}" xh="${consumeOtherMaxV}" class="new">
            <td style="vertical-align: inherit;"><span class="control-label xh" id="conOtherXh${t}">${consumeOtherMaxV}</span></td>
            <td>
                <span class="iconfont icon-saoyisao scanPrint" style="font-size:30px;cursor:pointer;vertical-align:middle"></span>
                <select class="ms2 form-control" id="conOtherBh${t}"></select>
            </td>
            <td><select class="ms2 form-control" id="conOtherLb${t}"></select></td>
            <td><select class="ms2 form-control" id="conOtherMc${t}"></select></td>
            <td><select class="ms2 form-control" id="conOtherGys${t}"></select></td>
            <td><select class="ms2 form-control" id="conOtherGg${t}"></select></td>
            <td><select class="ms2 form-control" id="conOtherWz${t}"></select></td>
            <td style="vertical-align: inherit;" id="conOtherDw${t}"></td>
            <td>
                <button type="button" class="btn btn-info btn-sm" id="conOtherDetail${t}" onclick="showDetailModel(0)">详情</button>
            </td>
            <td style="vertical-align: inherit;" class="form-inline">
                <span id="consumeOtherNum${t}"></span>
                <button type="button" class="btn btn-danger btn-xs pull-right" id="consumeOtherUpdateNum${t}" onclick="consumeOtherUpdateNum(0)"><i class="fa fa-refresh"></i></button>
            </td>
            <td>
                <input class="form-control text-center" id="consumeOtherConsume${t}" value="0" onkeyup="onInput(this, 8, 0)" onblur="onInputEnd(this)" onchange="consumeOtherActual()" maxlength="10">
            </td>
            <td>
                <div style="display:flex;width:150px">
                    <input class="form-control text-center" type="tel" id="consumeOtherLyr${t}" maxlength="64" onchange="consumeOtherActual()" />
                    <button class="btn btn-primary btn-sm" ${t==1?'style="opacity: 0;"':""} type="button" id="consumeOtherDitto${t}" style="margin-left:3px" onclick="consumeOtherDitto(${t})">同上</button>
                </div>
            </td>
            <td>
                <button type="button" class="btn btn-success btn-sm" id="consumeOtherLog${t}" onclick="showLogConsumeModel(2, 0)">查看</button>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" id="delConsumeOtherList${t}" onclick="delConsumeOtherList(${t})"><i class="fa fa-minus"></i></button>
            </td>
        </tr>`,$("#consumeOtherList").append(l),pcAndroid()||$("#consumeOtherList").find(".scanPrint").addClass("hidden"),_materialList!=null){a='<option value="{0}">{1}<\/option>';n="#conOtherBh"+t;$(n).empty();var u=0,e=0,o=0,s=0,h=0,c=0;for(r=0;r<_materialList.length;r++)i=_materialList[r],$(n).append(a.format(i.Id,i.Code)),r==0&&(u=i.BillId,$("#conOther"+t).attr("billId",u),e=i.CategoryId,o=i.NameId,s=i.SupplierId,h=i.SpecificationId,c=i.SiteId,$("#conOtherDw"+t).html(i.Unit),$("#consumeOtherNum"+t).html(i.Number));$(n).on("select2:select",function(){var e=0,o=0,s=0,h=0,c=0,f=0,l=$(this).val(),i=$(this).parents("tr:first").attr("value"),a=_materialList.length,u,r,t;for($("#conOtherDw"+i).html(""),$("#consumeOtherNum"+i).html(0),r=0;r<a;r++)if(t=_materialList[r],l==t.Id){for(e=t.BillId,$("#conOther"+i).attr("billId",e),o=t.CategoryId,s=t.NameId,h=t.SupplierId,c=t.SpecificationId,f=t.SiteId,$("#conOtherWz"+i).val(f).trigger("change"),$("#conOtherLb"+i).val(o).trigger("change"),$("#conOtherDw"+i).html(t.Unit),$("#consumeOtherNum"+i).html(t.Number),n="#conOtherMc"+i,updateConsumeSelect(n,s,_consumeName,"Name","CategoryId",o),n="#conOtherGys"+i,updateConsumeSelect(n,h,_consumeSupplier,"Supplier","NameId",s),n="#conOtherGg"+i,updateConsumeSelect(n,c,_consumeSpecification,"Specification","SupplierId",h),u=[],r=0;r<_materialList.length;r++)t=_materialList[r],t.SpecificationId==c&&_consumeSiteDict[t.SiteId]&&u.push(_consumeSiteDict[t.SiteId]);u.length>0&&(f=u[0].Id);updateConsumeSelect("#conOtherWz"+i,f,u,"Site");break}$("#conOtherDetail"+i).attr("onclick",`showDetailModel(${e})`)});n="#conOtherLb"+t;updateConsumeSelect(n,e,_consumeCategory,"Category");$(n).on("select2:select",function(){var f=0,h=0,e=0,o=0,s=0,c=0,r,u,t,i;for(h=$(this).val(),r=$(this).parents("tr:first").attr("value"),$("#conOtherDw"+r).html(""),$("#consumeOtherNum"+r).html(0),t=0;t<_consumeName.length;t++)if(i=_consumeName[t],i.CategoryId==h){e=i.Id;break}for(n="#conOtherMc"+r,updateConsumeSelect(n,e,_consumeName,"Name","CategoryId",h),t=0;t<_consumeSupplier.length;t++)if(i=_consumeSupplier[t],i.NameId==e){o=i.Id;break}for(n="#conOtherGys"+r,updateConsumeSelect(n,o,_consumeSupplier,"Supplier","NameId",e),t=0;t<_consumeSpecification.length;t++)if(i=_consumeSpecification[t],i.SupplierId==o){s=i.Id;break}for(n="#conOtherGg"+r,updateConsumeSelect(n,s,_consumeSpecification,"Specification","SupplierId",o),u=[],t=0;t<_materialList.length;t++)i=_materialList[t],i.SpecificationId==s&&_consumeSiteDict[i.SiteId]&&u.push(_consumeSiteDict[i.SiteId]);for(u.length>0&&(c=u[0].Id),updateConsumeSelect("#conOtherWz"+r,c,u,"Site"),$("#conOther"+r).attr("billId",0),$("#conOtherBh"+r).val(0).trigger("change"),t=0;t<_materialList.length;t++)if(i=_materialList[t],i.SpecificationId==s&&i.SiteId==c){f=i.BillId;$("#conOther"+r).attr("billId",f);$("#conOtherBh"+r).val(f).trigger("change");$("#conOtherDw"+r).html(i.Unit);$("#consumeOtherNum"+r).html(i.Number);break}consumeOtherActual();$("#conOtherDetail"+r).attr("onclick",`showDetailModel(${f})`)});n="#conOtherMc"+t;updateConsumeSelect(n,o,_consumeName,"Name","CategoryId",e);$(n).on("select2:select",function(){var f=0,s=0,e=0,o=0,h=0,r,u,t,i;for(s=$(this).val(),r=$(this).parents("tr:first").attr("value"),$("#conOtherDw"+r).html(""),$("#consumeOtherNum"+r).html(0),t=0;t<_consumeSupplier.length;t++)if(i=_consumeSupplier[t],i.NameId==s){e=i.Id;break}for(n="#conOtherGys"+r,updateConsumeSelect(n,e,_consumeSupplier,"Supplier","NameId",s),t=0;t<_consumeSpecification.length;t++)if(i=_consumeSpecification[t],i.SupplierId==e){o=i.Id;break}for(n="#conOtherGg"+r,updateConsumeSelect(n,o,_consumeSpecification,"Specification","SupplierId",e),u=[],t=0;t<_materialList.length;t++)i=_materialList[t],i.SpecificationId==o&&_consumeSiteDict[i.SiteId]&&u.push(_consumeSiteDict[i.SiteId]);for(u.length>0&&(h=u[0].Id),updateConsumeSelect("#conOtherWz"+r,h,u,"Site"),$("#conOther"+r).attr("billId",0),$("#conOtherBh"+r).val(0).trigger("change"),t=0;t<_materialList.length;t++)if(i=_materialList[t],i.SpecificationId==o&&i.SiteId==h){f=i.BillId;$("#conOther"+r).attr("billId",f);$("#conOtherBh"+r).val(f).trigger("change");$("#conOtherDw"+r).html(i.Unit);$("#consumeOtherNum"+r).html(i.Number);break}consumeOtherActual();$("#conOtherDetail"+r).attr("onclick",`showDetailModel(${f})`)});n="#conOtherGys"+t;updateConsumeSelect(n,s,_consumeSupplier,"Supplier","NameId",o);$(n).on("select2:select",function(){var f=0,o=0,e=0,s=0,i,u,r,t;for(o=$(this).val(),i=$(this).parents("tr:first").attr("value"),$("#conOtherDw"+i).html(""),$("#consumeOtherNum"+i).html(0),r=0;r<_consumeSpecification.length;r++)if(t=_consumeSpecification[r],t.SupplierId==o){e=t.Id;break}for(n="#conOtherGg"+i,updateConsumeSelect(n,e,_consumeSpecification,"Specification","SupplierId",o),u=[],r=0;r<_materialList.length;r++)t=_materialList[r],t.SpecificationId==e&&_consumeSiteDict[t.SiteId]&&u.push(_consumeSiteDict[t.SiteId]);for(u.length>0&&(s=u[0].Id),updateConsumeSelect("#conOtherWz"+i,s,u,"Site"),$("#conOther"+i).attr("billId",0),$("#conOtherBh"+i).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(t=_materialList[r],t.SpecificationId==e&&t.SiteId==s){f=t.BillId;$("#conOther"+i).attr("billId",f);$("#conOtherBh"+i).val(f).trigger("change");$("#conOtherDw"+i).html(t.Unit);$("#consumeOtherNum"+i).html(t.Number);break}consumeOtherActual();$("#conOtherDetail"+i).attr("onclick",`showDetailModel(${f})`)});n="#conOtherGg"+t;updateConsumeSelect(n,h,_consumeSpecification,"Specification","SupplierId",s);$(n).on("select2:select",function(){var u=0,f=0,e=0,n,r,i,t;for(f=$(this).val(),n=$(this).parents("tr:first").attr("value"),r=[],i=0;i<_materialList.length;i++)t=_materialList[i],t.SpecificationId==f&&_consumeSiteDict[t.SiteId]&&r.push(_consumeSiteDict[t.SiteId]);for(r.length>0&&(e=r[0].Id),updateConsumeSelect("#conOtherWz"+n,e,r,"Site"),$("#conOtherDw"+n).html(""),$("#consumeOtherNum"+n).html(0),$("#conOther"+n).attr("billId",0),$("#conOtherBh"+n).val(0).trigger("change"),i=0;i<_materialList.length;i++)if(t=_materialList[i],t.SpecificationId==f&&t.SiteId==e){u=t.BillId;$("#conOther"+n).attr("billId",u);$("#conOtherBh"+n).val(u).trigger("change");$("#conOtherDw"+n).html(t.Unit);$("#consumeOtherNum"+n).html(t.Number);break}consumeOtherActual();$("#conOtherDetail"+n).attr("onclick",`showDetailModel(${u})`)});for(n="#conOtherWz"+t,f=[],r=0;r<_materialList.length;r++)i=_materialList[r],i.SpecificationId==h&&_consumeSiteDict[i.SiteId]&&f.push(_consumeSiteDict[i.SiteId]);f.length>0&&(c=f[0].Id);updateConsumeSelect(n,c,f,"Site");$(n).on("select2:select",function(){var i=0,u=0,f=0,n,r,t;for(f=$(this).val(),n=$(this).parents("tr:first").attr("value"),u=$("#conOtherGg"+n).val(),$("#conOtherDw"+n).html(""),$("#consumeOtherNum"+n).html(0),$("#conOther"+n).attr("billId",0),$("#conOtherBh"+n).val(0).trigger("change"),r=0;r<_materialList.length;r++)if(t=_materialList[r],t.SpecificationId==u&&t.SiteId==f){i=t.BillId;$("#conOther"+n).attr("billId",i);$("#conOtherBh"+n).val(i).trigger("change");$("#conOtherDw"+n).html(t.Unit);$("#consumeOtherNum"+n).html(t.Number);break}consumeOtherActual();$("#conOtherDetail"+n).attr("onclick",`showDetailModel(${i})`)});$("#conOther"+t).find(".ms2").css("width","100%");$("#conOther"+t).find(".ms2").select2({width:"120px"});$("#conOtherDetail"+t).attr("onclick",`showDetailModel(${u})`);$("#consumeOtherUpdateNum"+t).attr("onclick",`consumeOtherUpdateNum(${u})`);$("#consumeOtherLog"+t).attr("onclick",`showLogConsumeModel(${u}, 2)`)}consumeOtherDittoAuto()}function delConsumeOtherList(n){var i,r,t,u;for($("#consumeOtherList").find(`tr[value=${n}]:first`).remove(),consumeOtherMaxV--,i=1,r=$("#consumeOtherList tr"),t=0;t<r.length;t++)$(r[t]).attr("xh",i),u=$(r[t]).attr("value"),$("#conOtherXh"+u).html(i),i++;consumeOtherDittoAuto()}function consumeOtherDittoAuto(){var n=$("#consumeOtherList").find(`tr[xh=1]:first`).attr("value");$("#consumeOtherDitto"+n).css("opacity","0")}function consumeOtherDitto(n){var t=$("#consumeOtherList").find(`tr[value=${n}]:first`).attr("xh"),i=parseInt(t)-1,r=$("#consumeOtherList").find(`tr[xh=${i}]:first`).attr("value"),u=$("#consumeOtherLyr"+r).val();$("#consumeOtherLyr"+n).val(u);consumeOtherActual()}function consumeOtherActual(){var i,l=$("#consumeOther").val(),f,r,c,n,u,t;for(_consumeOtherList=[],f=$("#consumeOtherList tr"),i=0;i<f.length;i++){var s=f[i],h=$(s).attr("billId"),e=$(s).attr("value"),o=$("#consumeOtherConsume"+e).val();for(isStrEmptyOrUndefined(o)&&(o=0),r=$("#consumeOtherLyr"+e).val(),isStrEmptyOrUndefined(r)&&(r=""),c=$(`#conOtherBh${e} option:checked`).text(),n={Code:c,Purpose:l,RelatedPerson:r,BillId:h,Number:o,Exist:!1},u=0;u<_materialList.length;u++)if(t=_materialList[u],t.BillId==h){n.Exist=!0;n.Code=t.Code;n.Category=t.Category;n.Name=t.Name;n.Supplier=t.Supplier;n.Specification=t.Specification;n.Site=t.Site;break}_consumeOtherList.push(n)}}function consumeShow(){var t,i,r,n;if($("#consumePurpose").html(""),isPlan=_consumeType==0,t=_consumeOtherList,i=$("#consumeOther").val(),isPlan&&(t=_consumePlanList,i=$("#consumePlanSelect option:checked").text()),isStrEmptyOrUndefined(i)){layer.msg("请输入用途");return}if($("#consumePurpose").html(i),t.length<=0){layer.msg("请选择货品");return}for(_consumeActualList=[],r=0;r<t.length;r++)if(n=t[r],n.BillId>0&&n.Number>0){if(!n.Exist){layer.msg(`货品编号：${n.Code}不存在, 无法领用`);return}if(isStrEmptyOrUndefined(n.RelatedPerson)){layer.msg("请输入领用人");return}_consumeActualList.push(n)}if(_consumeActualList.length<=0){layer.msg("请选择货品");return}var u=0,f=function(){return++u},e=[{data:null,title:"序号",render:f},{data:"Code",title:"货品编号"},{data:"Category",title:"货品类别"},{data:"Name",title:"货品名称"},{data:"Supplier",title:"供应商"},{data:"Specification",title:"规格型号"},{data:"Site",title:"位置"},{data:"Purpose",title:"用途"},{data:"Number",title:"领用数量"},{data:"RelatedPerson",title:"领用人"}];$("#consumeConfirmList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:_consumeActualList,aaSorting:[[0,"asc"]],aLengthMenu:[40,80,120],iDisplayLength:40,columns:e});$("#consumeConfirmModal").modal("show")}function consume(){var n=802,t=function(){var t,i;$("#consumeConfirmModal").modal("hide");$("#consumeModal").modal("hide");t={};t.opType=n;i={Bill:_consumeActualList};isPlan&&(i.PlanId=$("#consumePlanSelect").val());t.opData=JSON.stringify(i);ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getMaterialList("Select")})};showConfirm("领用",t)}function showDetailModel(n){if(n!=0){var t={};t.opType=800;t.opData=JSON.stringify({qId:n});ajaxPost("/Relay/Post",t,function(n){if(n.errno==0){var i=n.datas[0];$("#detailCode").val(i.Code);$("#detailCategory").val(i.Category);$("#detailName").val(i.Name);$("#detailSupplier").val(i.Supplier);$("#detailSpecification").val(i.Specification);$("#detailSite").val(i.Site);i.ImageList.length>0?(t={type:fileEnum.Material,files:i.Images},ajaxPost("/Upload/Path",t,function(n){var u,r,t;if(n.errno!=0){layer.msg(n.errmsg);return}for(u='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><div class="caption text-center"><button type="button" class="btn btn-default glyphicon glyphicon-trash delImg" value="{1}"><\/button><\/div><\/div><\/div>',r="",t=0;t<n.data.length;t++)r+=u.format(n.data[t].path,i.ImageList[t]);$("#detailImgList").append(r);$("#showDetailModel").modal("show")})):$("#showDetailModel").modal("show")}else layer.msg(n.errmsg)})}}function createQrModal(){$("#qrCodeList").empty();var n=new Promise(function(n){categorySelect(n)}),t=new Promise(function(n){nameSelect(n,!0,"Qr")}),i=new Promise(function(n){supplierSelect(n,!0,"Qr")}),r=new Promise(function(n){specificationSelect(n,!0,"Qr")}),u=new Promise(function(n){siteSelect(n,!0)});Promise.all([n,t,i,r,u]).then(n=>{$("#categoryQr").empty(),$("#categoryQr").append(n[0]),$("#nameQr").empty(),$("#nameQr").append(n[1]),$("#supplierQr").empty(),$("#supplierQr").append(n[2]),$("#specificationQr").empty(),$("#specificationQr").append(n[3]),$("#siteQr").empty(),$("#siteQr").append(n[4])});$("#createQrModal").modal("show")}function getQrList(){new Promise(function(n){getMaterialList("Qr",n)}).then(n=>{for(var u=n.length,f="",e=[],r=0,i,t=0;t<u;t++)r++,r==24&&(r=0),i=n[t],f+='<div class="printBox" style={6}><div style="width: 230px; height: 115px; border: 1px solid; display: flex;position:relative"><div style="width: 50%; height: 100%"><div class="createQrCode" style="margin: 4px"><\/div><\/div><span class="glyphicon glyphicon-remove delQrCode" aria-hidden="true" style="position:absolute;right:3px;top:3px;font-size:20px;color:red;cursor:pointer"><\/span><div style="width: 50%; height: 100%; text-align: center;display:flex;flex-direction:column;justify-content:center;font-size:12px"><span style="width:100%;white-space: nowrap;overflow: hidden;text-overflow: ellipsis">{0}<\/span><span style="width:100%;white-space: nowrap;overflow: hidden;text-overflow: ellipsis">{1}<\/span><span style="width:100%;white-space: nowrap;overflow: hidden;text-overflow: ellipsis">{2}<\/span><span style="width:100%;white-space: nowrap;overflow: hidden;text-overflow: ellipsis">{3}<\/span><span style="width:100%;white-space: nowrap;overflow: hidden;text-overflow: ellipsis">{4}<\/span><span style="width:100%;white-space: nowrap;overflow: hidden;text-overflow: ellipsis">{5}<\/span><\/div><\/div><\/div>'.format(i.Code,i.Category,i.Name,i.Supplier,i.Specification,i.Site,r?"float:left":"page-break-after:always"),e.push(`${i.BillId},${i.Code}`);for($("#qrCodeList").empty(),$("#qrCodeList").append(f),t=0;t<u;t++)new QRCode($("#qrCodeList .createQrCode")[t],{text:e[t],width:105,height:105,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});$("#qrCodeList .createQrCode").prop("title","")})}var _qrCode=null,_logConsumePlanBill=null,_type=0,_purposeConsume=0,increaseMax=0,increaseMaxV=0,_consumeType=0,_consumePlan=null,_consumePlanBill=null,_materialList=null,_consumeCategory=null,_consumeName=null,_consumeSupplier=null,_consumeSpecification=null,_consumeSite=null,_consumeSiteDict=null,_consumePlanList=null,_consumeOtherList=null,_consumeActualList=null,consumePlanMax=0,consumePlanMaxV=0,addConsumePlanFrom=0,consumeOtherMax=0,consumeOtherMaxV=0,addConsumeOtherFrom=0,isPlan=!1;