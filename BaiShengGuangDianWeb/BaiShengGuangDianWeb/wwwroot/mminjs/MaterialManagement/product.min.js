function pageReady(){_permissionList[545]={uIds:["updateMaterialBtn"]};_permissionList[546]={uIds:["addMaterialModalBtn"]};_permissionList[547]={uIds:["batchAddMaterialModalBtn"]};_permissionList[548]={uIds:["delMaterialBtn"]};_permissionList[549]={uIds:["updateImgBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2({matcher});$(".msTag2").select2({tags:!0,createTag:n=>({id:`tag${n.term}`,text:n.term}),matcher});siteSelect();var n,t,i,r=new Promise(function(n){categorySelect(n)}),u=new Promise(function(n){nameSelect(n,"0",!1)}),f=new Promise(function(n){supplierSelect(n,"0","0",!1)}),e=new Promise(function(n){specificationSelect(n,"0","0","0",!1)}),o=new Promise(function(n){siteSelect(n)});Promise.all([r,u,f,e,o]).then(()=>{getMaterialList()});$("#categorySelect").on("select2:select",function(){n=$(this).val();new Promise(function(t){nameSelect(t,n,!1)}).then(function(i){return t=$("#nameSelect").val(),isStrEmptyOrUndefined(t)&&($("#supplierSelect").empty(),$("#specificationSelect").empty()),new Promise(function(r){i(r,n,t,!1)})}).then(function(r){return i=$("#supplierSelect").val(),isStrEmptyOrUndefined(i)&&$("#specificationSelect").empty(),new Promise(function(u){r(u,n,t,i,!1)})}).then(function(n){n()})});$("#nameSelect").on("select2:select",function(){n=$("#categorySelect").val();t=$(this).val();new Promise(function(i){supplierSelect(i,n,t,!1)}).then(function(r){return i=$("#supplierSelect").val(),isStrEmptyOrUndefined(i)&&$("#specificationSelect").empty(),new Promise(function(u){r(u,n,t,i,!1)})}).then(function(n){n()})});$("#supplierSelect").on("select2:select",function(){n=$("#categorySelect").val();t=$("#nameSelect").val();i=$(this).val();new Promise(function(r){specificationSelect(r,n,t,i,!1)}).then(function(n){n()})});$("#specificationSelect").on("select2:select",function(){getMaterialList()});$("#siteSelect").on("select2:select",function(){getMaterialList()});$("#MaterialList").on("select2:select",".category",function(){var r=$(this).parents("tr");n=$(this).val();new Promise(function(t){nameSelect(t,n,!0)}).then(function(i){return r.find(".name").empty(),r.find(".name").append(i),t=r.find(".name").val(),isStrEmptyOrUndefined(i)&&(r.find(".supplier").empty(),r.find(".specification").empty()),new Promise(function(i){supplierSelect(i,n,t,!0)})}).then(function(u){return r.find(".supplier").empty(),r.find(".supplier").append(u),i=r.find(".supplier").val(),isStrEmptyOrUndefined(u)&&r.find(".specification").empty(),new Promise(function(r){specificationSelect(r,n,t,i,!0)})}).then(function(n){r.find(".specification").empty();r.find(".specification").append(n)})});$("#MaterialList").on("select2:select",".name",function(){var r=$(this).parents("tr");n=r.find(".category").val();t=$(this).val();new Promise(function(i){supplierSelect(i,n,t,!0)}).then(function(u){return r.find(".supplier").empty(),r.find(".supplier").append(u),i=r.find(".supplier").val(),isStrEmptyOrUndefined(u)&&r.find(".specification").empty(),new Promise(function(r){specificationSelect(r,n,t,i,!0)})}).then(function(n){r.find(".specification").empty();r.find(".specification").append(n)})});$("#MaterialList").on("select2:select",".supplier",function(){n=tr.find(".category").val();t=tr.find(".name").val();i=$(this).val();new Promise(function(r){specificationSelect(r,n,t,i,!0)}).then(function(n){tr.find(".specification").empty();tr.find(".specification").append(n)})});$("#addCategorySelect").on("select2:select",function(){n=$(this).val();new Promise((t,i)=>{nameSelect(t,n,!0,i)}).then(i=>($("#addNameSelect").empty().append(i),t=$("#addNameSelect").val(),isStrEmptyOrUndefined(i)&&$("#addSupplierSelect,#addSpecificationSelect").empty(),new Promise(i=>{supplierSelect(i,n,t,!0)})),()=>($("#addNameSelect,#addSupplierSelect,#addSpecificationSelect").empty(),Promise.reject())).then(r=>($("#addSupplierSelect").empty().append(r),i=$("#addSupplierSelect").val(),isStrEmptyOrUndefined(r)&&$("#addSpecificationSelect").empty(),new Promise(r=>{specificationSelect(r,n,t,i,!0)})),()=>Promise.reject()).then(n=>{$("#addSpecificationSelect").empty().append(n)},()=>{})});$("#addNameSelect").on("select2:select",function(){n=$("#addCategorySelect").val();t=$(this).val();new Promise((i,r)=>{supplierSelect(i,n,t,!0,r)}).then(r=>($("#addSupplierSelect").empty().append(r),i=$("#addSupplierSelect").val(),isStrEmptyOrUndefined(r)&&$("#addSpecificationSelect").empty(),new Promise(function(r){specificationSelect(r,n,t,i,!0)})),()=>($("#addSupplierSelect,#addSpecificationSelect").empty(),Promise.reject())).then(n=>{$("#addSpecificationSelect").empty().append(n)},()=>{})});$("#addSupplierSelect").on("select2:select",function(){n=$("#addCategorySelect").val();t=$("#addNameSelect").val();i=$(this).val();new Promise((r,u)=>{specificationSelect(r,n,t,i,!0,u)}).then(n=>$("#addSpecificationSelect").empty().append(n),()=>$("#addSpecificationSelect").empty())});$("#imgOldList").on("click",".delImg",function(){$(this).parents(".imgOption").remove();var n=$(this).val();_imgNameData.splice(_imgNameData.indexOf(n),1)});$("#batchAddMaterialModal").attr("data-backdrop","static")}function categorySelect(n){var t={};t.opType=816;ajaxPost("/Relay/Post",t,function(t){var u;if(t.errno!=0){layer.msg(t.errmsg);return}$(".categorySelect").empty();for(var f=t.datas,o=f.length,e='<option value = "{0}">{1}<\/option>',r="",i=0;i<o;i++)u=f[i],r+=e.format(u.Id,u.Category);$("#categorySelect").append(e.format(0,"所有类别"));$(".categorySelect").append(r);_categorySelect=`<select class="ms2 form-control category">${r}</select>`;isStrEmptyOrUndefined(n)||n(nameSelect)})}function nameSelect(n,t,i,r){var f={},u;if(isStrEmptyOrUndefined(t)){layer.msg("请选择货品类别");return}t!=0&&(f.categoryId=t);u={};u.opType=824;u.opData=JSON.stringify(f);ajaxPost("/Relay/Post",u,function(t){var e;if(t.errno!=0){r("error");return}for(var o=t.datas,h=o.length,s='<option value = "{0}">{1}<\/option>',f="",u=0;u<h;u++)e=o[u],f+=s.format(e.Id,e.Name);i||($("#nameSelect").empty(),$("#nameSelect").append(s.format(0,"所有名称")),$("#nameSelect").append(f));isStrEmptyOrUndefined(n)||(i?n(f):n(supplierSelect))},!i)}function supplierSelect(n,t,i,r,u){var e={},f;if(isStrEmptyOrUndefined(t)){layer.msg("请选择货品类别");return}if(t!=0&&(e.categoryId=t),isStrEmptyOrUndefined(i)){layer.msg("请选择货品名称");return}i!=0&&(e.nameId=i);f={};f.opType=831;f.opData=JSON.stringify(e);ajaxPost("/Relay/Post",f,function(t){var e;if(t.errno!=0){u("error");return}for(var o=t.datas,h=o.length,s='<option value = "{0}">{1}<\/option>',f="",i=0;i<h;i++)e=o[i],f+=s.format(e.Id,e.Supplier);r||($("#supplierSelect").empty(),$("#supplierSelect").append(s.format(0,"所有供应商")),$("#supplierSelect").append(f));isStrEmptyOrUndefined(n)||(r?n(f):n(specificationSelect))},!r)}function specificationSelect(n,t,i,r,u,f){var e={},o;if(isStrEmptyOrUndefined(t)){layer.msg("请选择货品类别");return}if(t!=0&&(e.categoryId=t),isStrEmptyOrUndefined(i)){layer.msg("请选择货品名称");return}if(i!=0&&(e.nameId=i),isStrEmptyOrUndefined(r)){layer.msg("请选择货品供应商");return}r!=0&&(e.supplierId=r);o={};o.opType=839;o.opData=JSON.stringify(e);ajaxPost("/Relay/Post",o,function(t){var e;if(t.errno!=0){f("error");return}for(var o=t.datas,h=o.length,s='<option value = "{0}">{1}<\/option>',r="",i=0;i<h;i++)e=o[i],r+=s.format(e.Id,e.Specification);u||($("#specificationSelect").empty(),$("#specificationSelect").append(s.format(0,"所有规格")),$("#specificationSelect").append(r));isStrEmptyOrUndefined(n)||(u?n(r):n(getMaterialList))},!u)}function siteSelect(n){var t={};t.opType=847;ajaxPost("/Relay/Post",t,function(t){var u;if(t.errno!=0){layer.msg(t.errmsg);return}$("#addSiteSelect").empty();for(var f=t.datas,o=f.length,e='<option value = "{0}">{1}<\/option>',r="",i=0;i<o;i++)u=f[i],r+=e.format(u.Id,u.Site);$("#addSiteSelect").append(r);$("#siteSelect").empty();$("#siteSelect").append(e.format(0,"所有位置"));$("#siteSelect").append(r);_siteSelect=`<select class="ms2 form-control site">${r}</select>`;isStrEmptyOrUndefined(n)||n("success")})}function getMaterialList(){var n,t,i,r,u,f,e;if(_materialIdData=[],_materialNameData=[],_codeData={},n={},t=$("#categorySelect").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择货品类别");return}if(t!=0&&(n.categoryId=t),i=$("#nameSelect").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择货品名称");return}if(i!=0&&(n.nameId=i),r=$("#supplierSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品供应商");return}if(r!=0&&(n.supplierId=r),u=$("#specificationSelect").val(),isStrEmptyOrUndefined(u)){layer.msg("请选择货品规格");return}if(u!=0&&(n.specificationId=u),f=$("#siteSelect").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择位置");return}f!=0&&(n.siteId=f);e={};e.opType=808;e.opData=JSON.stringify(n);ajaxPost("/Relay/Post",e,function(n){var t,i,u,r;if(n.errno!=0){layer.msg(n.errmsg);return}for(t=n.datas,i=0,u=t.length;i<u;i++)r=t[i],_codeData[r.Id]=r;var f=n=>`<input type="checkbox" class="icb_minimal isEnable" value=${n}>`,e=n=>`<span class="textOn codeOld">${n}</span><input type="text" class="form-control text-center textIn code hidden" maxlength="20" style="width:120px">`,o=n=>`<span class="textOn">${n}</span><div class="hidden textIn">${_categorySelect}</div>`,s=n=>`<span class="textOn">${n}</span><div class="hidden textIn"><select class="ms2 form-control name"></select></div>`,h=n=>`<span class="textOn">${n}</span><div class="hidden textIn"><select class="ms2 form-control supplier"></select></div>`,c=n=>`<span class="textOn">${n}</span><div class="hidden textIn"><select class="ms2 form-control specification"></select></div>`,l=n=>`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn unit hidden" maxlength="20" style="width:80px">`,a=n=>`<span class="textOn">${n}</span><div class="hidden textIn">${_siteSelect}</div>`,v=n=>`<button type="button" class="btn btn-info btn-sm" style="vertical-align:middle" onclick="showImgModel(${n.Id},'${escape(n.Code)}','${escape(n.Category)}','${escape(n.Name)}','${escape(n.Supplier)}','${escape(n.Specification)}','${escape(n.ImageList)}','${escape(n.Site)}')">查看</button>`,y=n=>`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn price hidden" onkeyup="onInput(this, 8, 4)" onblur="onInputEnd(this)" style="width:80px">`,p=n=>`<span class="textOn">${n}</span><input type="text" class="form-control text-center textIn stock hidden" maxlength="10" style="width:80px">`,w=n=>(n=n||"",(n.length>tdShowLength?`<span title = "${n}" class="textOn" onclick = "showAllContent('${escape(n)}')">${n.substring(0,tdShowLength)}...</span>`:`<span title = "${n}" class="textOn">${n}</span>`)+'<textarea class="form-control textIn remark hidden" maxlength = "500" style = "resize: vertical;width:250px;margin:auto"><\/textarea>');$("#MaterialList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"选择",render:f,orderable:!1},{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"货品编号",render:e},{data:"Category",title:"类别",render:o},{data:"Name",title:"名称",render:s},{data:"Supplier",title:"供应商",render:h},{data:"Specification",title:"规格",render:c},{data:"Unit",title:"单位",render:l},{data:"Site",title:"位置",render:a},{data:null,title:"货品图片",render:v},{data:"Price",title:"参考价格",render:y},{data:"Stock",title:"最低库存",render:p},{data:"Remark",title:"备注",render:w}],drawCallback:function(){$(this).find(".icb_minimal").iCheck({labelHover:!1,cursor:!0,checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"});$(this).find(".ms2").select2({width:"120px",matcher});$("#MaterialList .isEnable").on("ifChanged",function(){var n=$(this).parents("tr"),u=$(this).val(),e=n.find(".codeOld").text();if($(this).is(":checked")){_materialIdData.push(u);_materialNameData.push(e);var t=_codeData[u],o=t.Code,i=t.CategoryId,r,f;new Promise(n=>nameSelect(n,i,!0)).then(u=>(n.find(".name").empty().append(u),r=t.NameId,new Promise(n=>supplierSelect(n,i,r,!0)))).then(u=>(n.find(".supplier").empty().append(u),f=t.SupplierId,new Promise(n=>specificationSelect(n,i,r,f,!0)))).then(u=>{n.find(".specification").empty().append(u),n.find(".code").val(o),n.find(".category").val(i).trigger("change"),n.find(".name").val(r).trigger("change"),n.find(".supplier").val(f).trigger("change"),n.find(".specification").val(t.SpecificationId).trigger("change"),n.find(".unit").val(t.Unit),n.find(".site").val(t.SiteId).trigger("change"),n.find(".price").val(t.Price),n.find(".stock").val(t.Stock),n.find(".remark").val(t.Remark),n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden")})}else _materialIdData.splice(_materialIdData.indexOf(u),1),_materialNameData.splice(_materialNameData.indexOf(e),1),n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden")})}})})}function updateMaterial(){for(var c=$("#MaterialList tbody").find("tr"),t=[],i=0,y=c.length,n,r,l,u,f,e,o,s,h,a,v;i<y;i++)if(n=c.eq(i),r=n.find(".isEnable"),r.is(":checked")){if(l=r.val(),u=n.find(".code").val().trim(),isStrEmptyOrUndefined(u)){layer.msg("货品编号不能为空");return}if(f=n.find(".specification").val(),isStrEmptyOrUndefined(f)){layer.msg("请选择货品规格");return}if(e=n.find(".unit").val().trim(),isStrEmptyOrUndefined(e)){layer.msg("单位不能为空");return}if(o=n.find(".site").val(),isStrEmptyOrUndefined(o)){layer.msg("请选择货品场地");return}if(s=n.find(".price").val().trim(),isStrEmptyOrUndefined(s)){layer.msg("参考价格不能为空");return}if(h=n.find(".stock").val().trim(),isStrEmptyOrUndefined(h)){layer.msg("最低库存不能为空");return}a=n.find(".remark").val().trim();t.push({SpecificationId:f,SiteId:o,Code:u,Unit:e,Price:s,Stock:h,Remark:a,Id:l})}if(!t.length){layer.msg("请选择要保存的数据");return}v=function(){var n={};n.opType=809;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getMaterialList()})};showConfirm("保存",v)}function addMaterialModal(){var n,t,i,r;_addFirmwareUpload==null&&(_addFirmwareUpload=initFileInputMultiple("addImg",fileEnum.Material));$("#addImg").fileinput("clear");$("#addImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择图片...");n=$("#categorySelect").val();n==0&&(n=$("#addCategorySelect option").eq(0).val());$("#addCategorySelect").val(n).trigger("change");new Promise(function(t){nameSelect(t,n,!0)}).then(function(i){return $("#addNameSelect").empty(),$("#addNameSelect").append(i),t=$("#addNameSelect").val(),new Promise(function(i){supplierSelect(i,n,t,!0)})}).then(function(r){return $("#addSupplierSelect").empty(),$("#addSupplierSelect").append(r),i=$("#addSupplierSelect").val(),new Promise(function(r){specificationSelect(r,n,t,i,!0)})}).then(function(n){$("#addSpecificationSelect").empty();$("#addSpecificationSelect").append(n)});r=$("#addSiteSelect option").eq(0).val();$("#addSiteSelect").val(r).trigger("change");$("#addCode").val("");$("#addStock").val("");$("#addUnit").val("");$("#addPrice").val("");$("#addRemark").val("");$("#addMaterialModal").modal("show")}function addMaterial(){var u=$("#addCategorySelect").val(),n,t,i,r,e,o,s,f,h,c;if(isStrEmptyOrUndefined(u)){layer.msg("请选择类别");return}if(u=$("#addCategorySelect :selected").data("select2Tag")?"0":u,n=$("#addNameSelect").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择名称");return}if(n=$("#addNameSelect :selected").data("select2Tag")?"0":n,t=$("#addSupplierSelect").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择供应商");return}if(t=$("#addSupplierSelect :selected").data("select2Tag")?"0":t,i=$("#addSpecificationSelect").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择规格");return}if(i=$("#addSpecificationSelect :selected").data("select2Tag")?"0":i,r=$("#addSiteSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择位置");return}if(r=$("#addSiteSelect :selected").data("select2Tag")?"0":r,e=$("#addCode").val().trim(),isStrEmptyOrUndefined(e)){layer.msg("请输入编号");return}if(o=$("#addStock").val().trim(),isStrEmptyOrUndefined(o)){layer.msg("请输入最低库存");return}if(s=$("#addUnit").val().trim(),isStrEmptyOrUndefined(s)){layer.msg("请输入单位");return}f=$("#addPrice").val().trim();isStrEmptyOrUndefined(f)&&(f=0);h=$("#addRemark").val().trim();fileCallBack[fileEnum.Material]=function(c){var l,v,a;if(c.errno==0){l=[];for(v in c.data)l.push(c.data[v].newName);l=JSON.stringify(l);a={};a.opType=810;a.opData=JSON.stringify([{CategoryId:u,Category:$("#addCategorySelect :selected").text(),NameId:n,Name:$("#addNameSelect :selected").text(),SupplierId:t,Supplier:$("#addSupplierSelect :selected").text(),SpecificationId:i,Specification:$("#addSpecificationSelect :selected").text(),SiteId:r,Site:$("#addSiteSelect :selected").text(),Code:e,Unit:s,Price:f,Stock:o,Images:l,Remark:h}]);ajaxPost("/Relay/Post",a,function(n){layer.msg(n.errmsg);n.errno==0&&($("#addMaterialModal").modal("hide"),getMaterialList())})}};c=function(){$("#addImg").fileinput("upload")};showConfirm("添加",c)}function delMaterial(){if(!_materialIdData.length){layer.msg("请选择要删除的货品编号");return}var n=_materialNameData.join("<br>"),t=function(){var n={};n.opType=811;n.opData=JSON.stringify({ids:_materialIdData});ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getMaterialList()})};showConfirm(`删除以下货品编号：<pre style="color:red">${n}</pre>`,t)}function showImgModel(n,t,i,r,u,f,e,o){var s,h;if(_updateFirmwareUpload==null&&(_updateFirmwareUpload=initFileInputMultiple("updateImg",fileEnum.Material)),$("#updateImg").fileinput("clear"),$("#updateImgBox").find(".file-caption-name").attr("readonly",!0).attr("placeholder","请选择张图片..."),$("#checkId").text(n),t=unescape(t),$("#codeName").text(t),i=unescape(i),$("#categoryName").text(i),r=unescape(r),$("#nameName").text(r),u=unescape(u),$("#supplierName").text(u),f=unescape(f),$("#specificationName").text(f),o=unescape(o),$("#siteName").text(o),e=unescape(e),$("#imgOld").empty(),$("#imgOldList").empty(),_imgNameData=[],isStrEmptyOrUndefined(e))$("#imgOld").append('图片：<font style="color:red" size=5>无<\/font>');else{$("#imgOld").append("图片：");e=e.split(",");_imgNameData=e;s={type:fileEnum.Material,files:JSON.stringify(e)};s.dir="";for(h in fileEnum)if(fileEnum[h]==s.type){s.dir=h;break}if(isStrEmptyOrUndefined(s.dir))return void layer.msg("文件类型不存在！");getFilePath(s,n=>{const t=n.length;if(!(t<=0)){var r='<div class="imgOption col-lg-2 col-md-3 col-sm-4 col-xs-6"><div class="thumbnail"><img src={0} style="height:200px"><div class="caption text-center"><button type="button" class="btn btn-default glyphicon glyphicon-trash delImg" value="{1}"><\/button><\/div><\/div><\/div>',i="";for(let u=0;u<t;u++)i+=r.format(n[u].path,e[u]);$("#imgOldList").append(i)}})}$("#showImgModel").modal("show")}function updateImg(){fileCallBack[fileEnum.Material]=function(n){var r,u,t,f,i;if(n.errno==0){r=[];for(u in n.data)r.push(n.data[u].newName);t=_imgNameData.concat(r);t=JSON.stringify(t);f=$("#checkId").text();i={};i.opType=809;i.opData=JSON.stringify([{UpdateImage:!0,Images:t,Id:f}]);ajaxPost("/Relay/Post",i,function(n){layer.msg(n.errmsg);$("#showImgModel").modal("hide");n.errno==0&&getMaterialList()})}};var n=function(){$("#updateImg").fileinput("upload")};showConfirm("操作",n)}function batchAddMaterialModal(){$("#batchAddMaterial").removeAttr("disabled");$(".batchAddBtn").attr("disabled","disabled");resetBatchAddList();var n=new Promise(function(n){var t={};t.opType=816;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_categoryData=t.datas;n("success")},0)}),t=new Promise(function(n){var t={};t.opType=824;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_nameData=t.datas;n("success")},0)}),i=new Promise(function(n){var t={};t.opType=831;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_supplierData=t.datas;n("success")},0)}),r=new Promise(function(n){var t={};t.opType=839;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_specificationData=t.datas;n("success")},0)}),u=new Promise(function(n){var t={};t.opType=847;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_siteData=t.datas;n("success")},0)});Promise.all([n,t,i,r,u]).then(()=>{$(".batchAddBtn").removeAttr("disabled")});$("#batchAddMaterialModal").modal("show")}function resetBatchAddList(){batchAddMax=batchAddMaxV=0;$("#batchAddList").empty()}function addOneBatchAddList(n=0,t=0,i=0,r=0,u=0){var e,o,f;if(batchAddMax++,batchAddMaxV++,e=batchAddMax,o=`
        <tr id="batchAdd${e}" value="${e}" xh="${batchAddMaxV}">
            <td style="vertical-align: inherit;"><span class="control-label xh" id="batchAddXh${e}">${batchAddMaxV}</span></td>
            <td><select class="ms2 form-control" id="batchAddLb${e}"></select></td>
            <td><select class="ms2 form-control" id="batchAddMc${e}"></select></td>
            <td><select class="ms2 form-control" id="batchAddGys${e}"></select></td>
            <td><select class="ms2 form-control" id="batchAddGg${e}"></select></td>
            <td><select class="ms2 form-control" id="batchAddWz${e}"></select></td>
            <td><input class="form-control text-center" id="batchAddBh${e}" maxlength="50" style="min-width:130px"></td>
            <td><input class="form-control text-center" id="batchAddKc${e}" value="0" onkeyup="onInput(this, 8, 0)" onblur="onInputEnd(this)" style="min-width:80px"></td>
            <td><input class="form-control text-center" id="batchAddDw${e}" maxlength="50" style="min-width:80px"></td>
            <td><input class="form-control text-center" id="batchAddJg${e}" value="0" onkeyup="onInput(this, 8, 2)" onblur="onInputEnd(this)" style="min-width:80px"></td>
            <td>
                <button type="button" class="btn btn-primary btn-sm" id="copyBatchAddList${e}" onclick="copyBatchAddList(${e})"><i class="fa fa-copy"></i></button>
                <button type="button" class="btn btn-danger btn-sm" id="delBatchAddList${e}" onclick="delBatchAddList(${e})"><i class="fa fa-minus"></i></button>
            </td>
        </tr>`,$("#batchAddList").append(o),f="#batchAddLb"+e,_categoryData&&_categoryData.length>0){n==0&&(n=_categoryData[0].Id);updateBatchAddSelect(f,n,_categoryData,"Category");$(f).on("select2:select",function(){var o,u,e;for(n=$(this).find(":selected").data("select2Tag")?0:$(this).val(),o=$(this).parents("tr:first").attr("value"),u=0;u<_nameData.length;u++)if(e=_nameData[u],e.CategoryId==n){t=e.Id;break}for(f="#batchAddMc"+o,t=updateBatchAddSelect(f,t,_nameData,"Name","CategoryId",n),u=0;u<_supplierData.length;u++)if(e=_supplierData[u],e.NameId==t){i=e.Id;break}for(f="#batchAddGys"+o,i=updateBatchAddSelect(f,i,_supplierData,"Supplier","NameId",t),u=0;u<_specificationData.length;u++)if(e=_specificationData[u],e.SupplierId==i){r=e.Id;break}f="#batchAddGg"+o;updateBatchAddSelect(f,r,_specificationData,"Specification","SupplierId",i)});f="#batchAddMc"+e;t==0?t=updateBatchAddSelect(f,t,_nameData,"Name","CategoryId",n):updateBatchAddSelect(f,t,_nameData,"Name","CategoryId",n);$(f).on("select2:select",function(){var e,n,u;for(t=$(this).find(":selected").data("select2Tag")?0:$(this).val(),e=$(this).parents("tr:first").attr("value"),n=0;n<_supplierData.length;n++)if(u=_supplierData[n],u.NameId==t){i=u.Id;break}for(f="#batchAddGys"+e,i=updateBatchAddSelect(f,i,_supplierData,"Supplier","NameId",t),n=0;n<_specificationData.length;n++)if(u=_specificationData[n],u.SupplierId==i){r=u.Id;break}f="#batchAddGg"+e;updateBatchAddSelect(f,r,_specificationData,"Specification","SupplierId",i)});f="#batchAddGys"+e;i==0?i=updateBatchAddSelect(f,i,_supplierData,"Supplier","NameId",t):updateBatchAddSelect(f,i,_supplierData,"Supplier","NameId",t);$(f).on("select2:select",function(){var u,n,t;for(i=$(this).find(":selected").data("select2Tag")?0:$(this).val(),u=$(this).parents("tr:first").attr("value"),n=0;n<_specificationData.length;n++)if(t=_specificationData[n],t.SupplierId==i){r=t.Id;break}f="#batchAddGg"+u;updateBatchAddSelect(f,r,_specificationData,"Specification","SupplierId",i)});f="#batchAddGg"+e;updateBatchAddSelect(f,r,_specificationData,"Specification","SupplierId",i);f="#batchAddWz"+e;updateBatchAddSelect(f,u,_siteData,"Site");$("#batchAdd"+e).find(".ms2").css("width","100%");$("#batchAdd"+e).find(".ms2").select2({width:"120px",tags:!0,createTag:n=>({id:`tag${n.term}`,text:n.term}),matcher})}}function updateBatchAddSelect(n,t,i,r,u="",f=-1){var h=0,o,s,e;for($(n).empty(),o="",s=0;s<i.length;s++)e=i[s],f!=-1?f!=0&&e[u]==f&&(o+=`<option value="${e.Id}">${e[r]}</option>`,h==0&&(h=e.Id)):o+=`<option value="${e.Id}">${e[r]}</option>`;return $(n).append(o),t!=0&&$(n).val(t).trigger("change"),h}function delBatchAddList(n){var i,r,t,u;for($("#batchAddList").find(`tr[value=${n}]:first`).remove(),batchAddMaxV--,i=1,r=$("#batchAddList tr"),t=0;t<r.length;t++)$(r[t]).attr("xh",i),u=$(r[t]).attr("value"),$("#batchAddXh"+u).html(i),i++}function copyBatchAddList(n){var t=$(`#batchAddLb${n}`).val(),i=$(`#batchAddMc${n}`).val(),r=$(`#batchAddGys${n}`).val(),u=$(`#batchAddGg${n}`).val(),f=$(`#batchAddWz${n}`).val();addOneBatchAddList(t,i,r,u,f)}function batchAddMaterial(){for(var l=810,t=[],c,n=1;n<=batchAddMax;n++)if($(`#batchAddBh${n}`).length>0){var a=$(`#batchAddLb${n} :selected`).data("select2Tag")?"0":$(`#batchAddLb${n}`).val(),i=$(`#batchAddMc${n} :selected`).data("select2Tag")?"0":$(`#batchAddMc${n}`).val(),r=$(`#batchAddGys${n} :selected`).data("select2Tag")?"0":$(`#batchAddGys${n}`).val(),u=$(`#batchAddGg${n} :selected`).data("select2Tag")?"0":$(`#batchAddGg${n}`).val(),f=$(`#batchAddWz${n} :selected`).data("select2Tag")?"0":$(`#batchAddWz${n}`).val(),e=$(`#batchAddBh${n}`).val().trim(),o=$(`#batchAddKc${n}`).val().trim(),s=$(`#batchAddDw${n}`).val().trim(),h=$(`#batchAddJg${n}`).val().trim();if(isStrEmptyOrUndefined(i)){layer.msg("请选择名称");return}if(isStrEmptyOrUndefined(r)){layer.msg("请选择供应商");return}if(isStrEmptyOrUndefined(u)){layer.msg("请选择规格");return}if(isStrEmptyOrUndefined(f)){layer.msg("请选择位置");return}if(isStrEmptyOrUndefined(e)){layer.msg("货品编号不能为空");return}if(isStrEmptyOrUndefined(o)){layer.msg("请输入最低库存");return}if(isStrEmptyOrUndefined(s)){layer.msg("请输入单位");return}if(isStrEmptyOrUndefined(h)){layer.msg("请输入价格");return}t.push({CategoryId:a,Category:$(`#batchAddLb${n} :selected`).text(),NameId:i,Name:$(`#batchAddMc${n} :selected`).text(),SupplierId:r,Supplier:$(`#batchAddGys${n} :selected`).text(),SpecificationId:u,Specification:$(`#batchAddGg${n} :selected`).text(),SiteId:f,Site:$(`#batchAddWz${n} :selected`).text(),Code:e,Stock:o,Unit:s,Price:h})}if(t.length<=0){layer.msg("请输入货品");return}c=function(){function i(){$("#batchAddMaterial").removeAttr("disabled")}$("#batchAddMaterial").attr("disabled","disabled");var n={};n.opType=l;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,function(n){var o=n.errmsg,s,r,u,i,f,e,t,h;if(n.errno==0)$("#batchAddMaterialModal").modal("hide"),getMaterialList();else if(n.datas.length>0){for(s=`[{0},{1}]`,r=[],u=0;u<n.datas.length;u++)if(i=n.datas[u],typeof i=="string")r.push(i);else{for(f="",e="",t=0;t<_specificationData.length;t++)_specificationData[t].Id==i.SpecificationId&&(f=_specificationData[t].Specification);for(t=0;t<_siteData.length;t++)_siteData[t].Id==i.SiteId&&(e=_siteData[t].Site);f!=""&&e!=""&&r.push(s.format(f,e))}h=`<span class='text-red'>${r.join(", ")}</span></br>`;o=h+o}layer.msg(o);$("#batchAddMaterial").removeAttr("disabled")});setTimeout(i,1e4)};showConfirm("添加",c)}var _permissionList=[],_categorySelect=null,_siteSelect=null,_codeData=null,_addFirmwareUpload=null,_materialIdData=[],_materialNameData=[],_updateFirmwareUpload=null,_imgNameData=null,_categoryData=null,_nameData=null,_supplierData=null,_specificationData=null,_siteData=null,batchAddMax=0,batchAddMaxV=0;