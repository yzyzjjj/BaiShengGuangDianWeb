function pageReady(){$(".ms2").select2();var n,t;new Promise(function(n){categorySelect(n)}).then(function(t){return n=$("#categorySelect").val(),new Promise(function(i){t(i,n,!1)})}).then(function(i){return t=$("#nameSelect").val(),new Promise(function(r){i(r,n,t,!1)})}).then(function(n){n()});$("#categorySelect").on("select2:select",function(){n=$(this).val();new Promise(function(t){nameSelect(t,n,!1)}).then(function(i){return t=$("#nameSelect").val(),isStrEmptyOrUndefined(t)&&$("#supplierSelect").empty(),new Promise(function(r){i(r,n,t,!1)})}).then(function(n){n()})});$("#nameSelect").on("select2:select",function(){n=$("#categorySelect").val();t=$(this).val();new Promise(function(i){supplierSelect(i,n,t,!1)}).then(function(n){n()})});$("#supplierSelect").on("select2:select",function(){getSpecificationList()});$("#specificationList").on("change",".category",function(){var i=$(this).parents("tr");n=$(this).val();new Promise(function(t){nameSelect(t,n,!0)}).then(function(r){return i.find(".name").empty(),i.find(".name").append(r),t=i.find(".name").val(),isStrEmptyOrUndefined(r)&&i.find(".supplier").empty(),new Promise(function(i){supplierSelect(i,n,t,!0)})}).then(function(n){i.find(".supplier").empty();i.find(".supplier").append(n)})});$("#specificationList").on("change",".name",function(){var i=$(this).parents("tr");n=i.find(".category").val();t=$(this).val();new Promise(function(i){supplierSelect(i,n,t,!0)}).then(function(n){i.find(".supplier").empty();i.find(".supplier").append(n)})});$("#addCategorySelect").on("select2:select",function(){n=$(this).val();new Promise(function(t){nameSelect(t,n,!0)}).then(function(i){return $("#addNameSelect").empty(),$("#addNameSelect").append(i),t=$("#addNameSelect").val(),isStrEmptyOrUndefined(i)&&$("#addSupplierSelect").empty(),new Promise(function(i){supplierSelect(i,n,t,!0)})}).then(function(n){$("#addSupplierSelect").empty();$("#addSupplierSelect").append(n)})});$("#addNameSelect").on("select2:select",function(){n=$("#addCategorySelect").val();t=$(this).val();new Promise(function(i){supplierSelect(i,n,t,!0)}).then(function(n){$("#addSupplierSelect").empty();$("#addSupplierSelect").append(n)})})}function categorySelect(n){var i=816,t;if(!checkPermission(i)){layer.msg("没有权限");return}t={};t.opType=i;ajaxPost("/Relay/Post",t,function(t){var u;if(t.errno!=0){layer.msg(t.errmsg);return}$(".categorySelect").empty();for(var f=t.datas,e=f.length,o='<option value = "{0}">{1}<\/option>',r="",i=0;i<e;i++)u=f[i],r+=o.format(u.Id,u.Category);e&&$("#categorySelect").append(o.format(0,"所有类别"));$(".categorySelect").append(r);_categorySelect=`<select class="form-control textIn category hidden" style="width:100px">${r}</select>`;isStrEmptyOrUndefined(n)||n(nameSelect)})}function nameSelect(n,t,i){var f=824,u,r;if(!checkPermission(f)){layer.msg("没有权限");return}if(u={},isStrEmptyOrUndefined(t)){layer.msg("请选择货品类别");return}t!=0&&(u.categoryId=t);r={};r.opType=f;r.opData=JSON.stringify(u);ajaxPost("/Relay/Post",r,function(t){var f;if(t.errno!=0){layer.msg(t.errmsg);return}for(var e=t.datas,o=e.length,s='<option value = "{0}">{1}<\/option>',u="",r=0;r<o;r++)f=e[r],u+=s.format(f.Id,f.Name);i||($("#nameSelect").empty(),o&&$("#nameSelect").append(s.format(0,"所有名称")),$("#nameSelect").append(u));isStrEmptyOrUndefined(n)||(i?n(u):n(supplierSelect))},!i)}function supplierSelect(n,t,i,r){var e=831,u,f;if(!checkPermission(e)){layer.msg("没有权限");return}if(u={},isStrEmptyOrUndefined(t)){layer.msg("请选择货品类别");return}if(t!=0&&(u.categoryId=t),isStrEmptyOrUndefined(i)){layer.msg("请选择货品名称");return}i!=0&&(u.nameId=i);f={};f.opType=e;f.opData=JSON.stringify(u);ajaxPost("/Relay/Post",f,function(t){var f;if(t.errno!=0){layer.msg(t.errmsg);return}for(var e=t.datas,o=e.length,s='<option value = "{0}">{1}<\/option>',u="",i=0;i<o;i++)f=e[i],u+=s.format(f.Id,f.Supplier);r||($("#supplierSelect").empty(),o&&$("#supplierSelect").append(s.format(0,"所有供应商")),$("#supplierSelect").append(u));isStrEmptyOrUndefined(n)||(r?n(u):n(getSpecificationList))},!r)}function getSpecificationList(){var f=839,n,t,i,r,u;if(!checkPermission(f)){layer.msg("没有权限");return}if(_specificationIdData=[],_specificationNameData=[],n={},t=$("#categorySelect").val(),isStrEmptyOrUndefined(t)){layer.msg("请选择货品类别");return}if(t!=0&&(n.categoryId=t),i=$("#nameSelect").val(),isStrEmptyOrUndefined(i)){layer.msg("请选择货品名称");return}if(i!=0&&(n.nameId=i),r=$("#supplierSelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择货品供应商");return}r!=0&&(n.supplierId=r);u={};u.opType=f;u.opData=JSON.stringify(n);ajaxPost("/Relay/Post",u,function(n){if(n.errno!=0){layer.msg(n.errmsg);return}var t=n.datas,i=function(n){return`<input type="checkbox" class="icb_minimal isEnable" value=${n}>`},r=0,u=function(){return++r},f=function(n){return`<span class="textOn" id=${n.CategoryId}>${n.Category}</span>${_categorySelect}`},e=function(n){return`<span class="textOn" id=${n.NameId}>${n.Name}</span><select class="form-control textIn name hidden" style="width:100px"></select>`},o=function(n){return`<span class="textOn" id=${n.SupplierId}>${n.Supplier}</span><select class="form-control textIn supplier hidden" style="width:100px"></select>`},s=function(n){return`<span class="textOn specificationOld">${n}</span><input type="text" class="form-control text-center textIn specification hidden" maxlength="20" style="width:120px" value=${n}>`},h=function(n){return(n.length>tdShowLength?`<span title = "${n}" class="textOn" onclick = "showAllContent('${escape(n)}')">${n.substring(0,tdShowLength)}...</span>`:`<span title = "${n}" class="textOn">${n}</span>`)+`<textarea class="form-control textIn remark hidden" maxlength = "500" style = "resize: vertical;width:250px;margin:auto"></textarea>`};$("#specificationList").DataTable({destroy:!0,paging:!0,searching:!0,language:{url:"/content/datatables_language.json"},data:t,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:"Id",title:"选择",render:i},{data:null,title:"序号",render:u},{data:null,title:"类别",render:f},{data:null,title:"名称",render:e},{data:null,title:"供应商",render:o},{data:"Specification",title:"规格",render:s},{data:"Remark",title:"备注",render:h}],columnDefs:[{orderable:!1,targets:0}],drawCallback:function(){$(this).find(".icb_minimal").iCheck({labelHover:!1,cursor:!0,checkboxClass:"icheckbox_minimal-blue",radioClass:"iradio_minimal-blue",increaseArea:"20%"});$("#specificationList .isEnable").on("ifChanged",function(){var n=$(this).parents("tr"),u=$(this).val(),f=n.find(".specificationOld").text(),t,i,r;$(this).is(":checked")?(_specificationIdData.push(u),_specificationNameData.push(f),t=n.find(".textOn"),i=t.eq(0).attr("id"),new Promise(function(n){nameSelect(n,i,!0)}).then(function(u){return n.find(".name").empty(),n.find(".name").append(u),r=t.eq(1).attr("id"),new Promise(function(n){supplierSelect(n,i,r,!0)})}).then(function(u){n.find(".supplier").empty();n.find(".supplier").append(u);var f=t.eq(2).attr("id"),e=t.eq(3).text(),o=t.eq(4).attr("title");n.find(".category").val(i);n.find(".name").val(r);n.find(".supplier").val(f);n.find(".specification").val(e);n.find(".remark").val(o);n.find(".textIn").removeClass("hidden").siblings(".textOn").addClass("hidden")})):(_specificationIdData.splice(_specificationIdData.indexOf(u),1),_specificationNameData.splice(_specificationNameData.indexOf(f),1),n.find(".textOn").removeClass("hidden").siblings(".textIn").addClass("hidden"))})}})})}function updateSpecification(){var e=840,n,r,s,u,f,h,c;if(!checkPermission(e)){layer.msg("没有权限");return}for(var o=$("#specificationList tbody").find("tr"),t=[],i=0,l=o.length;i<l;i++)if(n=o.eq(i),r=n.find(".isEnable"),r.is(":checked")){if(s=r.val(),u=n.find(".supplier").val(),isStrEmptyOrUndefined(u)){layer.msg("请选择供应商");return}if(f=n.find(".specification").val().trim(),isStrEmptyOrUndefined(f)){layer.msg("规格不能为空");return}h=n.find(".remark").val().trim();t.push({SupplierId:u,Specification:f,Remark:h,Id:s})}if(!t.length){layer.msg("请选择要保存的数据");return}c=function(){var n={};n.opType=e;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,function(n){layer.msg(n.errmsg);n.errno==0&&getSpecificationList()})};showConfirm("保存",c)}function addSpecificationModal(){var n=$("#categorySelect").val();n==0&&(n=$("#addCategorySelect option").eq(0).val());$("#addCategorySelect").val(n).trigger("change");new Promise(function(t){nameSelect(t,n,!0)}).then(function(t){$("#addNameSelect").empty();$("#addNameSelect").append(t);var i=$("#addNameSelect").val();return new Promise(function(t){supplierSelect(t,n,i,!0)})}).then(function(n){$("#addSupplierSelect").empty();$("#addSupplierSelect").append(n)});$("#addSpecification").val("");$("#addRemark").val("");$("#addSpecificationModal").modal("show")}function addSpecification(){var i=841,r,u,n,t,f,e;if(!checkPermission(i)){layer.msg("没有权限");return}if(r=$("#addCategorySelect").val(),isStrEmptyOrUndefined(r)){layer.msg("请选择类别");return}if(u=$("#addNameSelect").val(),isStrEmptyOrUndefined(u)){layer.msg("请选择名称");return}if(n=$("#addSupplierSelect").val(),isStrEmptyOrUndefined(n)){layer.msg("请选择供应商");return}if(t=$("#addSpecification").val().trim(),isStrEmptyOrUndefined(t)){layer.msg("请输入新规格");return}f=$("#addRemark").val().trim();e=function(){var r={};r.opType=i;r.opData=JSON.stringify([{SupplierId:n,Specification:t,Remark:f}]);ajaxPost("/Relay/Post",r,function(n){layer.msg(n.errmsg);$("#addSpecificationModal").modal("hide");n.errno==0&&getSpecificationList()})};showConfirm("添加",e)}function delSpecification(){var n=842,t,i;if(!checkPermission(n)){layer.msg("没有权限");return}if(!_specificationIdData.length){layer.msg("请选择要删除的货品规格");return}t=_specificationNameData.join("<br>");i=function(){var t={};t.opType=n;t.opData=JSON.stringify({ids:_specificationIdData});ajaxPost("/Relay/Post",t,function(n){layer.msg(n.errmsg);n.errno==0&&getSpecificationList()})};showConfirm(`删除以下货品规格：<pre style="color:red">${t}</pre>`,i)}function batchAddModal(){if(!checkPermission(841)){layer.msg("没有权限");return}$("#batchAdd").removeAttr("disabled");$(".batchAddBtn").attr("disabled","disabled");resetBatchAddList();var n=new Promise(function(n){var t={};t.opType=816;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_categoryData=t.datas;n("success")},0)}),t=new Promise(function(n){var t={};t.opType=824;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_nameData=t.datas;n("success")},0)}),i=new Promise(function(n){var t={};t.opType=831;ajaxPost("/Relay/Post",t,function(t){if(t.errno!=0){layer.msg(t.errmsg);return}_supplierData=t.datas;n("success")},0)});Promise.all([n,t,i]).then(()=>{$(".batchAddBtn").removeAttr("disabled")});$("#batchAddModal").modal("show")}function resetBatchAddList(){batchAddMax=batchAddMaxV=0;$("#batchAddList").empty()}function addOneBatchAddList(n=0,t=0,i=0,r=0){var f,e,u;if(batchAddMax++,batchAddMaxV++,f=batchAddMax,e=`
        <tr id="batchAdd${f}" value="${f}" xh="${batchAddMaxV}">
            <td style="vertical-align: inherit;"><span class="control-label xh" id="batchAddXh${f}">${batchAddMaxV}</span></td>
            <td><select class="ms2 form-control" id="batchAddLb${f}"></select></td>
            <td><select class="ms2 form-control" id="batchAddMc${f}"></select></td>
            <td><select class="ms2 form-control" id="batchAddGys${f}"></select></td>
            <td><input class="form-control text-center" id="batchAddGg${f}" maxlength="50"></td>
            <td><input class="form-control text-center" id="batchAddBz${f}" maxlength="50"></td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" id="delBatchAddList${f}" onclick="delBatchAddList(${f})"><i class="fa fa-minus"></i></button>
            </td>
        </tr>`,$("#batchAddList").append(e),u="#batchAddLb"+f,_categoryData&&_categoryData.length>0){n==0&&(n=_categoryData[0].Id);updateBatchAddSelect(u,n,_categoryData,"Category");$(u).on("select2:select",function(){var o,f,e;for(n=$(this).val(),o=$(this).parents("tr:first").attr("value"),f=0;f<_nameData.length;f++)if(e=_nameData[f],e.CategoryId==n){t=e.Id;break}for(u="#batchAddMc"+o,t=updateBatchAddSelect(u,t,_nameData,"Name","CategoryId",n),f=0;f<_supplierData.length;f++)if(e=_supplierData[f],e.NameId==t){i=e.Id;break}for(u="#batchAddGys"+o,i=updateBatchAddSelect(u,i,_supplierData,"Supplier","NameId",t),f=0;f<_specificationData.length;f++)if(e=_specificationData[f],e.SupplierId==i){r=e.Id;break}u="#batchAddGg"+o;updateBatchAddSelect(u,r,_specificationData,"Specification","SupplierId",i)});u="#batchAddMc"+f;t=updateBatchAddSelect(u,t,_nameData,"Name","CategoryId",n);$(u).on("select2:select",function(){var e,n,f;for(t=$(this).val(),e=$(this).parents("tr:first").attr("value"),n=0;n<_supplierData.length;n++)if(f=_supplierData[n],f.NameId==t){i=f.Id;break}for(u="#batchAddGys"+e,i=updateBatchAddSelect(u,i,_supplierData,"Supplier","NameId",t),n=0;n<_specificationData.length;n++)if(f=_specificationData[n],f.SupplierId==i){r=f.Id;break}u="#batchAddGg"+e;updateBatchAddSelect(u,r,_specificationData,"Specification","SupplierId",i)});u="#batchAddGys"+f;i=updateBatchAddSelect(u,i,_supplierData,"Supplier","NameId",t);$(u).on("select2:select",function(){var f,n,t;for(i=$(this).val(),f=$(this).parents("tr:first").attr("value"),n=0;n<_specificationData.length;n++)if(t=_specificationData[n],t.SupplierId==i){r=t.Id;break}u="#batchAddGg"+f;updateBatchAddSelect(u,r,_specificationData,"Specification","SupplierId",i)});$("#batchAdd"+f).find(".ms2").css("width","100%");$("#batchAdd"+f).find(".ms2").select2({width:"120px"})}}function updateBatchAddSelect(n,t,i,r,u="",f=-1){var h=0,o,s,e;for($(n).empty(),o="",s=0;s<i.length;s++)e=i[s],f!=-1?f!=0&&e[u]==f&&(o+=`<option value="${e.Id}">${e[r]}</option>`,h==0&&(h=e.Id)):o+=`<option value="${e.Id}">${e[r]}</option>`;return $(n).append(o),t!=0&&$(n).val(t).trigger("change"),h}function delBatchAddList(n){var i,r,t,u;for($("#batchAddList").find(`tr[value=${n}]:first`).remove(),batchAddMaxV--,i=1,r=$("#batchAddList tr"),t=0;t<r.length;t++)$(r[t]).attr("xh",i),u=$(r[t]).attr("value"),$("#batchAddXh"+u).html(i),i++}function batchAdd(){for(var f=841,t=[],u,n=1;n<=batchAddMax;n++)if($("#batchAdd"+n).length>0){var i=$("#batchAddGys"+n).val(),r=$("#batchAddGg"+n).val().trim(),e=$("#batchAddBz"+n).val().trim();if(isStrEmptyOrUndefined(i)){layer.msg("请选择供应商");return}if(isStrEmptyOrUndefined(r)){layer.msg("请输入规格");return}t.push({SupplierId:i,Specification:r,Remark:e})}if(t.length<=0){layer.msg("请输入规格");return}u=function(){function i(){$("#batchAdd").removeAttr("disabled")}$("#batchAdd").attr("disabled","disabled");var n={};n.opType=f;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,function(n){var u=n.errmsg,o,f,i,e,r,t,s;if(n.errno==0)$("#batchAddModal").modal("hide"),getSpecificationList();else if(n.datas.length>0){for(o=`[{0},{1}]`,f=[],i=0;i<n.datas.length;i++){for(e=n.datas[i],r="",t=0;t<_supplierData.length;t++)_supplierData[t].Id==e.SupplierId&&(r=_supplierData[t].Supplier);r!=""&&f.push(o.format(r,e.Specification))}s=`<span class='text-red'>${f.join(", ")}</span></br>`;u=s+u}layer.msg(u);$("#batchAdd").removeAttr("disabled")});setTimeout(i,1e4)};showConfirm("添加",u)}var _categorySelect=null,_specificationIdData=[],_specificationNameData=[],_categoryData=null,_nameData=null,_supplierData=null,batchAddMax=0,batchAddMaxV=0;