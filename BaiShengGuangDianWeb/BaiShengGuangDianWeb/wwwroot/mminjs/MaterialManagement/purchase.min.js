function pageReady(){_permissionList[589]={uIds:["updateDepartmentBtn"]};_permissionList[590]={uIds:["finishInWareListBtn"]};_permissionList[591]={uIds:["citePurchaseListBtn"]};_permissionList[592]={uIds:["printPurchaseListBtn"]};_permissionList[593]={uIds:["inWareListSaveBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();$("#cgTime").val(getDate()).datepicker("update");new Promise(n=>getValuer(n)).then(()=>getGroup());$("#groupSelect").on("select2:select",()=>getProcessor());$("#qgProcessor,#formState,#cgProcessor").on("select2:select",()=>getPurchase());$("#inWareList,#purchaseList").on("focus",".zeroNum",function(){$(this).val()==0&&$(this).val("")});$("#inWareList,#purchaseList").on("blur",".zeroNum",function(){isStrEmptyOrUndefined($(this).val())&&$(this).val(0)});$("#purchaseList").on("focus",".numZero",function(){$(this).text().trim()==0&&$(this).text("")});$("#purchaseList").on("blur",".numZero",function(){isStrEmptyOrUndefined($(this).text().trim())&&$(this).text(0)});$("#purchaseList").on("input",".taxTate",function(){onInput(this,2,2);tFootTrCount.call(this)});$("#purchaseList").on("input",".numZero",function(){tFootTrCount.call(this)});$("#departmentAll").on("ifChanged",function(){$(this).is(":checked")?$("#departmentItem .icb_minimal").iCheck("check"):_departmentItem.length==$("#departmentItem").children().length&&$("#departmentItem .icb_minimal").iCheck("uncheck")});$("#departmentItem").on("ifChanged",".icb_minimal",function(){const n=$(this).parents(".departmentLi")[0];$(this).is(":checked")?(_departmentItem.push(n),_departmentItem.length==$("#departmentItem").children().length&&$("#departmentAll").iCheck("check")):(_departmentItem.splice(_departmentItem.indexOf(n),1),_departmentItem.length==$("#departmentItem").children().length-1&&$("#departmentAll").iCheck("uncheck"))})}function tFootTrCount(){const n=$(this).parents("tr"),i=parseFloat(n.find(".number").text())||0,r=parseFloat(n.find(".price").text())||0,u=parseFloat(n.find(".taxTate").val())||0,t=parseFloat((r*(1+u/100)).toFixed(5)),f=parseFloat((i*t).toFixed(5));n.find(".tax-price").text(t);n.find(".tax-amount").text(f);tFootCount()}function tFootCount(){const n=_purchaseDataTable.columns(5).nodes()[0].map(n=>$(n).text()),i=_purchaseDataTable.columns(6).nodes()[0].map(n=>$(n).text()),r=_purchaseDataTable.columns(8).nodes()[0].map(n=>$(n).text()),t=[];for(let u=0,f=n.length;u<f;u++)t[u]={Number:n[u],Price:i[u],TaxAmount:r[u]};computePrice(t)}function pasteTable(n){if(n.originalEvent.clipboardData&&n.originalEvent.clipboardData.items){if(n.target.localName!="input"){const r=(n.originalEvent.clipboardData||window.clipboardData).getData("text"),t=r.split("\n"),i=[];if(_pasteData)for(let n=0,r=_pasteData.length;n<r;n++){const r=_pasteData[n];t[n]?r.push(...t[n].split("\t")):r.push(...new Array(t[0].split("\t").length).fill(""));i.push({Id:0,ItemId:0,Code:r[0]||"",Name:r[1]||"",Specification:r[2]||"",Unit:r[3]||"",Number:r[4]||"",Price:r[5]||"",TaxPrice:r[6]||"",TaxAmount:r[7]||"",TaxTate:r[8]||0})}else{_pasteData=[];for(let n=0,r=t.length;n<r;n++){let r=t[n];isStrEmptyOrUndefined(r)||(r=r.split("\t"),_pasteData[n]=r,i.push({Id:0,ItemId:0,Code:r[0]||"",Name:r[1]||"",Specification:r[2]||"",Unit:r[3]||"",Number:r[4]||"",Price:r[5]||"",TaxPrice:r[6]||"",TaxAmount:r[7]||"",TaxTate:r[8]||0}))}}setPurchaseList(i);for(let n=0,t=_pasteData.length;n<t;n++)if(_pasteData[n].length>8){_pasteData=null;break}}n.stopPropagation();n.preventDefault()}}function getGroup(n){_departmentItem=[];const t={};t.opType=871;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas,f=`<div class="flexStyle departmentLi">
                        <label class="flexStyle pointer">
                            <input type="checkbox" class="icb_minimal {2}" value="{0}">
                            <span class="textOverTop departmentText" style="margin-left: 5px" title="{1}">{1}</span>
                        </label>
                        <input class="form-control hidden departmentName" maxlength="20" style="flex-basis:150px;margin-left:5px">
                      </div>`,e='<option value="{0}">{1}<\/option>';let r="",u="";for(let n=0,t=i.length;n<t;n++){const t=i[n];r+=f.format(t.Id,t.Department,t.Get?"isget":"");t.Get&&(u+=e.format(t.Id,t.Department))}$("#departmentItem").empty().append(r);$("#departmentItem .icb_minimal").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"});$("#departmentItem .isget").iCheck("check");$("#groupSelect").empty().append(u);n?$("#groupSelect").val(n).trigger("change"):getProcessor()})}function updateDepartment(){const t=[],i=$("#departmentItem .departmentLi"),r=$("#groupSelect").val();let u=!1;for(let n=0,f=i.length;n<f;n++){const f=i.eq(n),e=f.find(".icb_minimal"),o=e.val(),s=e.is(":checked");r==o&&s&&(u=!0);t.push({Id:o,Get:s,Department:f.find(".departmentText").prop("title")})}const n={};n.opType=872;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&getGroup(u?r:null)})}function getProcessor(){const t=$("#groupSelect").val(),n={};n.opType=879;n.opData=JSON.stringify({dId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#qgProcessor").empty().append(`<option value="-1">全部</option>${setOptions(n.datas,"Member")}`);getPurchase()})}function getValuer(n){const t={};t.opType=887;ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#cgProcessor").empty().append(`<option value="-1">全部</option>${setOptions(t.datas,"Valuer")}`);n("success")})}function getPurchase(){_inWareDataTable&&(_inWareDataTable.destroy(),_inWareDataTable.clear(),_inWareDataTable=null,$("#inWareList").empty());resetPurchaseList();$("#inWareListSaveBtn,#finishInWareListBtn,#citePurchaseListBtn").prop("disabled",!0);const i=$("#groupSelect").val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择请购部门");return}const n={dId:i},r=$("#qgProcessor").val();if(isStrEmptyOrUndefined(r)){layer.msg("请选择请购人");return}~r&&(n.name=$("#qgProcessor :selected").text());const u=$("#formState").val();~u&&(n.state=u);const f=$("#cgProcessor").val();if(isStrEmptyOrUndefined(f)){layer.msg("请选择核价人");return}~f&&(n.valuer=$("#cgProcessor :selected").text());const t={};t.opType=855;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas,i=n=>{let t="";switch(n.State){case 1:t="#C9C9C9";break;case 2:t="#1890FF";break;case 3:t="#f00";break;case 4:t="#f90";break;case 5:t="#008000"}return`<span style="color:${t}">${n.StateStr}</span>`},r=n=>n.length>6?`<span title="${n}">${n.slice(0,6)}...</span>`:n;_stateDataTable=$("#stateList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"text-center"i><"table-flex"p>',bAutoWidth:!1,destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",sWidth:"20px",render:(n,t,i,r)=>++r.row},{data:"ErpId",title:"编号",sWidth:"20px"},{data:"Purchase",title:"名称",sWidth:"100px",render:r},{data:"Name",title:"请购人",sWidth:"20px"},{data:"Valuer",title:"核价人",sWidth:"20px"},{data:null,title:"状态",sWidth:"20px",render:i}],drawCallback:function(n){if(n.aoData.length){const t=$(n.nTBody).find("tr");t.addClass("pointer").off("click").on("click",function(){resetPurchaseList();const t=n.aoData;for(let n=0,i=t.length;n<i;n++){const i=t[n].nTr;if($(i).css("background",""),i==this){const i=t[n]._aData;_Purchase={Id:i.Id,ErpId:i.ErpId,State:i.State,isShow:[3,4].includes(i.State)};$("#citePurchaseListBtn").prop("disabled",i.State!=5);i.IsQuote?(getQuoteList(!0),$("#addPurchaseListBtn").removeClass("hidden")):$("#addPurchaseListBtn").addClass("hidden")}}$(this).css("background","#d9edf7").siblings("tr").css("background","");getPurchaseMaterial()})}}})})}function getQuoteList(n){const t={};t.opType=860;t.opData=JSON.stringify({pId:_Purchase.Id});ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas;i.length?($("#purchaseCode").val(i[0].Purchase),$("#cgTime").val(i[0].Time.split(" ")[0]).datepicker("update")):($("#purchaseCode").val(""),$("#cgTime").val(getDate()).datepicker("update"));setPurchaseList(i,n)})}function updatePurchaseList(){if(!_purchaseDataTable){layer.msg("入库单为空");return}let n=$("#cgTime").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择入库日期");return}if(n+=` ${getTime()}`,exceedTime(n)){layer.msg("入库日期大于当前时间");return}const t=$("#purchaseCode").val().trim();if(isStrEmptyOrUndefined(t)){layer.msg("订单编号不能为空");return}const i=_purchaseDataTable.rows().nodes(),u=_purchaseDataTable.columns(0).data()[0],r=[];for(let f=0,e=i.length;f<e;f++){const a=i[f],e=$(a).find("td"),v=u[f],o=f+1,y=e.eq(2).text().trim();if(isStrEmptyOrUndefined(y)){layer.msg(`序列${o}：物料名称不能为空`);return}const p=e.eq(3).text().trim();if(isStrEmptyOrUndefined(p)){layer.msg(`序列${o}：规格不能为空`);return}const s=e.eq(5).text().trim();if(s!=parseFloat(s)){layer.msg(`序列${o}：数量不合法`);return}const h=e.eq(6).text().trim();if(h!=parseFloat(h)){layer.msg(`序列${o}：税前单价不合法`);return}const c=e.eq(7).text().trim();if(c!=parseFloat(c)){layer.msg(`序列${o}：税后单价不合法`);return}const l=e.eq(8).text().trim();if(l!=parseFloat(l)){layer.msg(`序列${o}：合计不合法`);return}r[f]={Purchase:t,Time:n,ItemId:v.ItemId,Id:v.Id,PurchaseId:_Purchase.Id,Code:e.eq(1).text().trim(),Name:y,Specification:p,Unit:e.eq(4).text().trim(),Number:s,Price:h,TaxPrice:c,TaxAmount:l,Tax:$(a).find(".taxTate").val().trim()}}const f={Id:_Purchase.Id,Items:r},e=function(){let n={};n.opType=861;n.opData=JSON.stringify(f);ajaxPost("/Relay/Post",n,t=>{if(layer.msg(t.errmsg),t.errno==0){n=_stateDataTable.context[0].aoData;for(let t=0,i=n.length;t<i;t++){const i=n[t]._aData.Id;if(i==_Purchase.Id){n[t]._aData.IsQuote=!0;getQuoteList(!0);break}}}})};showConfirm("保存",e)}function getPurchaseMaterial(){_trChangeData=[];const n={};n.opType=863;n.opData=JSON.stringify({pId:_Purchase.Id});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas;$("#inWareListSaveBtn").prop("disabled",!(t.some(n=>n.ErpId!==0)&&_Purchase.isShow));$("#finishInWareListBtn").prop("disabled",!_Purchase.isShow);const i=n=>`<input class="form-control text-center count zeroNum" oninput="onInput(this, 8, 0)" onblur="onInputEnd(this)" onchange="inWareListChange.call(this)" style="width:80px" value=${n.Count} wid=${n.Id} bill=${n.BillId}>`;_inWareDataTable=$("#inWareList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Unit",title:"单位"},{data:"Number",title:"数量",sClass:"text-red"},{data:"Purchaser",title:"采购人"},{data:"TaxPrice",title:"税后单价"},{data:"TaxAmount",title:"税后总价"},{data:"TaxTate",title:"税率（%)"},{data:"Price",title:"税前单价"},{data:"Stock",title:"已入库",sClass:"text-red"},{data:null,title:"本次入库",render:i,visible:_Purchase.isShow}]})})}function inWareListChange(){const n=$(this).parents("tr")[0];_trChangeData.includes(n)||_trChangeData.push(n)}function inWareListSave(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购和仓库到货才能入库");return}const i=_Purchase.Id,n=[];for(let t=0,r=_trChangeData.length;t<r;t++){const r=$(_trChangeData[t]).find(".count"),u=r.val()>>0;u&&n.push({Id:r.attr("wid")>>0,Count:u,PurchaseId:i,BillId:r.attr("bill")>>0})}if(n.length){const t={};t.opType=867;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,n=>{layer.msg(n.errmsg),n.errno==0&&getPurchaseMaterial()})}}function finishInWareList(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购和仓库到货才能完成采购");return}const n=function(){let n={};n.opType=859;n.opData=JSON.stringify([{Id:_Purchase.Id}]);ajaxPost("/Relay/Post",n,t=>{if(layer.msg(t.errmsg),t.errno==0){n=_stateDataTable.context[0].aoData;for(let t=0,i=n.length;t<i;t++){const i=n[t]._aData.Id;if(i==_Purchase.Id){const i=n[t].nTr;if(~$("#formState").val()){const n=$(i).find("td:first").text()>>0;_stateDataTable.row(i).remove().draw(!1);_stateDataTable.column(0).nodes().each(t=>{const i=$(t).text()>>0;i>n&&$(t).text(i-1)})}else $(i).find("td:last").text("订单完成"),n[t]._aData.State=5;_Purchase.State=5;_Purchase.isShow=!1;getPurchaseMaterial();break}}$("#citePurchaseListBtn").prop("disabled",!1)}})};showConfirm("完成采购订单",n)}function citePurchaseList(){if(!_Purchase){layer.msg("请购单为空");return}const t=_Purchase.Id;$("#purchaseCode").val(_Purchase.ErpId);const n={};n.opType=863;n.opData=JSON.stringify({pId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas;for(let n=0,i=t.length;n<i;n++)t[n].ItemId=t[n].Id,t[n].Id=0;setPurchaseList(t)})}function setPurchaseList(n,t){t?$("#addPurchaseListBtn").removeClass("hidden"):$("#addPurchaseListBtn").addClass("hidden");const i=n=>`<input class="form-control text-center taxTate zeroNum" onblur="onInputEnd(this)" style="width:80px" value=${parseFloat(n)||0}>`,r=()=>`<button type="button" class="btn btn-danger btn-sm" onclick="delPurchaseTr.call(this)"><i class="fa fa-minus"></i></button>`;_purchaseDataTable=$("#purchaseList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Unit",title:"单位"},{data:"Number",title:"数量",sClass:"numZero number"},{data:"Price",title:"税前单价",sClass:"numZero price"},{data:"TaxPrice",title:"税后单价",sClass:"tax-price"},{data:"TaxAmount",title:"合计",sClass:"tax-amount"},{data:t?"Tax":"TaxTate",title:"税率（%)",render:i},{data:null,title:"删除",render:r,visible:!!t}],drawCallback:function(){t&&$("#purchaseList tbody tr td:not(:nth-child(1),:nth-child(10),:nth-child(11),:nth-child(9),:nth-child(8))").prop("contenteditable",!0)},initComplete:function(){t?$("#purchaseList").off("paste"):$("#purchaseList").off("paste").on("paste",pasteTable);const i=`<tfoot>
                              <tr>
                                <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                <th>合计：</th>
                                <th id="purchaseAmount"></th>
                              </tr>
                                <tr>
                                <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                <th>税额：</th>
                                <th id="purchaseTax"></th>
                              </tr>
                           </tfoot>`;this.find("tfoot").remove();this.append(i);computePrice(n);this.find("tfoot tr:last th").css("borderTop",0)}})}function computePrice(n){let t=0,i=0;for(let r=0,u=n.length;r<u;r++){const u=n[r],f=parseFloat(u.TaxAmount);t+=f;i+=f-parseFloat(u.Number)*parseFloat(u.Price)}$("#purchaseAmount").text(t?parseFloat(t.toFixed(5)):0);$("#purchaseTax").text(i?parseFloat(i.toFixed(5)):0)}function addPurchaseTr(){_purchaseDataTable.row.add({Id:0,ItemId:0,Code:"",Name:"",Specification:"",Unit:"",Number:0,Price:0,TaxPrice:0,TaxAmount:0,TaxTate:0}).draw(!1)}function delPurchaseTr(){const n=$(this).parents("tr")[0],t=$(n).find("td:first").text()>>0;_purchaseDataTable.row(n).remove().draw(!1);_purchaseDataTable.column(0).nodes().each(n=>{const i=$(n).text()>>0;i>t&&$(n).text(i-1)});tFootCount()}function resetPurchaseList(){$("#purchaseCode").val("");$("#addPurchaseListBtn").addClass("hidden");_purchaseDataTable&&(_pasteData=null,_purchaseDataTable.destroy(),_purchaseDataTable.clear(),_purchaseDataTable=null,$("#purchaseList").empty())}function printPurchaseList(){if(!_purchaseDataTable){layer.msg("入库单为空");return}const i=$("#purchaseList tfoot").prop("outerHTML");let n="";const t=_purchaseDataTable.rows().nodes();for(let i=0,r=t.length;i<r;i++){const r=$(t[i]),f=r.find(".taxTate").val().trim(),e=r.find("td");let u="";for(let n=0;n<9;n++)u+=e.eq(n).prop("outerHTML");n+=`<tr>${u}<td>${f}</td></tr>`}const r=`<table border="1" style="width:100%;text-align:center;border-collapse:collapse">${"<thead><tr><th>序号<\/th><th>物料编码<\/th><th>物料名称<\/th><th>规格<\/th><th>单位<\/th><th>数量<\/th><th>税前单价<\/th><th>税后单价<\/th><th>合计<\/th><th>税率（%)<\/th><\/tr><\/thead>"}<tbody>${n}</tbody>${i}</table>`,u=$("#purchaseCode").val().trim(),f=$("#cgTime").val().trim(),e=`<label>订单编号：${u}</label><label style="float:right">日期：${f}</label>`,o=`<div>${e}${r}</div>`;printCode(o)}var _permissionList=[],_pasteData=null;let _departmentItem=null;let _stateDataTable=null,_Purchase=null,_inWareDataTable=null;let _trChangeData=null;let _purchaseDataTable=null;