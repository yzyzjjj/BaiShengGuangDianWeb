function pageReady(){$(".ms2").select2();$("#cgTime").val(getDate()).datepicker("update");new Promise(n=>getValuer(n)).then(()=>{getGroup()});$("#groupSelect").on("select2:select",()=>getProcessor());$("#qgProcessor,#formState,#cgProcessor").on("select2:select",()=>getPurchase());$("#inWareList,#purchaseList").on("focus",".zeroNum",function(){$(this).val()==0&&$(this).val("")});$("#inWareList,#purchaseList").on("blur",".zeroNum",function(){isStrEmptyOrUndefined($(this).val())&&$(this).val(0)});$("#purchaseList").on("input",".taxTate",function(){onInput(this,2,2);const r=_purchaseDataTable.columns(5).data()[0],u=_purchaseDataTable.columns(6).data()[0],i=_purchaseDataTable.columns(9).nodes()[0];let n=0,t=0;for(let f=0,e=i.length;f<e;f++){const h=parseFloat($(i[f]).find(".taxTate").val().trim()||0)/100,e=u[f],o=r[f],s=e*h*o;t+=s;n+=s+e*o}$("#purchaseAmount").text(n?n.toFixed(2):0);$("#purchaseTax").text(t?t.toFixed(2):0)});$("#purchaseList").on("paste",n=>{if(n.originalEvent.clipboardData&&n.originalEvent.clipboardData.items){if(n.target.localName!="input"){const r=(n.originalEvent.clipboardData||window.clipboardData).getData("text"),t=r.split("\n"),i=[];if(_pasteData)for(let n=0,r=_pasteData.length;n<r;n++){const r=_pasteData[n];t[n]?r.push(...t[n].split("\t")):r.push(...new Array(t[0].split("\t").length).fill(""));i.push({Code:r[0]||"",Name:r[1]||"",Specification:r[2]||"",Unit:r[3]||"",Number:r[4]||"",Price:r[5]||"",TaxPrice:r[6]||"",TaxAmount:r[7]||"",TaxTate:r[8]||0})}else{_pasteData=[];for(let n=0,r=t.length;n<r;n++){let r=t[n];isStrEmptyOrUndefined(r)||(r=r.split("\t"),_pasteData[n]=r,i.push({Code:r[0]||"",Name:r[1]||"",Specification:r[2]||"",Unit:r[3]||"",Number:r[4]||"",Price:r[5]||"",TaxPrice:r[6]||"",TaxAmount:r[7]||"",TaxTate:r[8]||0}))}}setPurchaseList(i);for(let n=0,t=_pasteData.length;n<t;n++)if(_pasteData[n].length>8){_pasteData=null;break}}n.stopPropagation();n.preventDefault()}});$("#departmentAll").on("ifChanged",function(){$(this).is(":checked")?$("#departmentItem .icb_minimal").iCheck("check"):_departmentItem.length==$("#departmentItem").children().length&&$("#departmentItem .icb_minimal").iCheck("uncheck")});$("#departmentItem").on("ifChanged",".icb_minimal",function(){const n=$(this).parents(".departmentLi")[0];$(this).is(":checked")?(_departmentItem.push(n),_departmentItem.length==$("#departmentItem").children().length&&$("#departmentAll").iCheck("check")):(_departmentItem.splice(_departmentItem.indexOf(n),1),_departmentItem.length==$("#departmentItem").children().length-1&&$("#departmentAll").iCheck("uncheck"))})}function setOptions(n,t){const r='<option value="{0}">{1}<\/option>';let i="";for(let u=0,f=n.length;u<f;u++){const f=n[u];i+=r.format(f.Id,f[t])}return i}function getGroup(n){_departmentItem=[];const t={};t.opType=871;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas,f=`<div class="flexStyle departmentLi">
                        <label class="flexStyle pointer">
                            <input type="checkbox" class="icb_minimal {2}" value="{0}">
                            <span class="textOverTop departmentText" style="margin-left: 5px" title="{1}">{1}</span>
                        </label>
                        <input class="form-control hidden departmentName" maxlength="20" style="flex-basis:150px;margin-left:5px">
                      </div>`,e='<option value="{0}">{1}<\/option>';let r="",u="";for(let n=0,t=i.length;n<t;n++){const t=i[n];r+=f.format(t.Id,t.Department,t.Get?"isget":"");t.Get&&(u+=e.format(t.Id,t.Department))}$("#departmentItem").empty().append(r);$("#departmentItem .icb_minimal").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"});$("#departmentItem .isget").iCheck("check");$("#groupSelect").empty().append(u);n?$("#groupSelect").val(n).trigger("change"):getProcessor()})}function updateDepartment(){const t=[],i=$("#departmentItem .departmentLi"),r=$("#groupSelect").val();let u=!1;for(let n=0,f=i.length;n<f;n++){const f=i.eq(n),e=f.find(".icb_minimal"),o=e.val(),s=e.is(":checked");r==o&&s&&(u=!0);t.push({Id:o,Get:s,Department:f.find(".departmentText").prop("title")})}const n={};n.opType=872;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&getGroup(u?r:null)})}function getProcessor(){const t=$("#groupSelect").val(),n={};n.opType=879;n.opData=JSON.stringify({dId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#qgProcessor").empty().append(setOptions(n.datas,"Member"));getPurchase()})}function getValuer(n){const t={};t.opType=887;ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#cgProcessor").empty().append(setOptions(t.datas,"Valuer"));n("success")})}function getPurchase(){const r=$("#groupSelect").val();if(isStrEmptyOrUndefined(r)){layer.msg("请选择请购部门");return}let n=$("#qgProcessor").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择请购人");return}n=$("#qgProcessor :selected").text();const u=$("#formState").val();let t=$("#cgProcessor").val();if(isStrEmptyOrUndefined(t)){layer.msg("请选择核价人");return}t=$("#cgProcessor :selected").text();const i={};i.opType=855;i.opData=JSON.stringify({dId:r,name:n,state:u,valuer:t});ajaxPost("/Relay/Post",i,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}var t=n.datas;_stateDataTable=$("#stateList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"text-center"i><"table-flex"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"ErpId",title:"编号"},{data:"Purchase",title:"名称"},{data:"Name",title:"请购人"},{data:"Valuer",title:"核价人"},{data:"StateStr",title:"状态"}],drawCallback:n=>{if(n.aoData.length){const t=$(n.nTBody).find("tr");t.addClass("pointer").off("click").on("click",function(){const t=n.aoData;for(let n=0,i=t.length;n<i;n++){const i=t[n].nTr;if($(i).css("background",""),i==this){const i=t[n]._aData;_Purchase={Id:i.Id,ErpId:i.ErpId,State:i.State,isShow:[3,4].includes(i.State)}}}$(this).css("background","#d9edf7").siblings("tr").css("background","");getPurchaseMaterial()})}}})})}function getPurchaseMaterial(){_trChangeData=[];const n={};n.opType=863;n.opData=JSON.stringify({pId:_Purchase.Id});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#inWareListSaveBtn,#finishInWareListBtn").prop("disabled",!_Purchase.isShow);const t=n.datas,i=n=>`<input class="form-control text-center count zeroNum" oninput="onInput(this, 8, 0)" onblur="onInputEnd(this)" onchange="inWareListChange.call(this)" style="width:80px" value=${n.Count} wid=${n.Id}>`;$("#inWareList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Unit",title:"单位"},{data:"Number",title:"数量",sClass:"text-red"},{data:"Purchaser",title:"采购人"},{data:"TaxPrice",title:"税后单价"},{data:"TaxAmount",title:"税后总价"},{data:"TaxTate",title:"税率（%)"},{data:"Price",title:"税前单价"},{data:"Stock",title:"已入库",sClass:"text-red"},{data:null,title:"本次入库",render:i,visible:_Purchase.isShow}]})})}function inWareListChange(){const n=$(this).parents("tr")[0];_trChangeData.includes(n)||_trChangeData.push(n)}function inWareListSave(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购和仓库到货才能入库");return}const i=_Purchase.Id,t=[];for(let n=0,r=_trChangeData.length;n<r;n++){const r=$(_trChangeData[n]).find(".count");t.push({Id:r.attr("wid")>>0,Count:r.val()>>0,PurchaseId:i})}const n={};n.opType=867;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&getPurchaseMaterial()})}function finishInWareList(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购和仓库到货才能完成采购");return}const n=function(){let n={};n.opType=859;n.opData=JSON.stringify([{Id:_Purchase.Id}]);ajaxPost("/Relay/Post",n,t=>{if(layer.msg(t.errmsg),t.errno==0){n=_stateDataTable.context[0].aoData;for(let t=0,i=n.length;t<i;t++){const i=n[t]._aData.Id;if(i==_Purchase.Id){const i=n[t].nTr;$(i).find("td:last").text("订单完成");n[t]._aData.State=5;_Purchase.State=5;_Purchase.isShow=!1;getPurchaseMaterial();break}}}})};showConfirm("完成采购订单",n)}function citePurchaseList(){if(!_Purchase){layer.msg("请购单为空");return}const t=_Purchase.Id;$("#purchaseCode").val(_Purchase.ErpId);const n={};n.opType=863;n.opData=JSON.stringify({pId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}setPurchaseList(n.datas)})}function setPurchaseList(n){const t=n=>`<input class="form-control text-center taxTate zeroNum" onblur="onInputEnd(this)" style="width:80px" value=${parseFloat(n)||0}>`;_purchaseDataTable=$("#purchaseList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Unit",title:"单位"},{data:"Number",title:"数量"},{data:"Price",title:"税前单价"},{data:"TaxPrice",title:"税后单价"},{data:"TaxAmount",title:"合计"},{data:"TaxTate",title:"税率（%)",render:t}],initComplete:function(){let t=0,i=0;for(let r=0,u=n.length;r<u;r++){const u=n[r],f=parseFloat(u.TaxAmount);t+=f;i+=f-parseFloat(u.Number)*parseFloat(u.Price)}const r=`<tfoot>
                                  <tr>
                                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                    <th>合计：</th>
                                    <th id="purchaseAmount">${t?t.toFixed(2):0}</th>
                                  </tr>
                                    <tr>
                                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                    <th>税额：</th>
                                    <th id="purchaseTax">${i?i.toFixed(2):0}</th>
                                  </tr>
                               </tfoot>`;this.find("tfoot").remove();this.append(r);this.find("tfoot tr:last th").css("borderTop",0)}})}function resetPurchaseList(){$("#purchaseCode").val("");_purchaseDataTable&&(_pasteData=null,setPurchaseList([]))}function printPurchaseList(){if(!_purchaseDataTable){layer.msg("入库单为空");return}const i=$("#purchaseList tfoot").prop("outerHTML");let n="";const t=_purchaseDataTable.context[0].aoData;for(let i=0,r=t.length;i<r;i++){const r=t[i],e=$(r.nTr).find(".taxTate").val().trim(),u=r._aFilterData;let f="";for(let n=0,t=u.length-1;n<t;n++)f+=`<td>${u[n]}</td>`;n+=`<tr>${f}<td>${e}</td></tr>`}const r=`<table border="1" style="width:100%;text-align:center;border-collapse:collapse">${"<thead><tr><th>序号<\/th><th>物料编码<\/th><th>物料名称<\/th><th>规格<\/th><th>单位<\/th><th>数量<\/th><th>税前单价<\/th><th>税后单价<\/th><th>合计<\/th><th>税率（%)<\/th><\/tr><\/thead>"}<tbody>${n}</tbody>${i}</table>`,u=$("#purchaseCode").val().trim(),f=$("#cgTime").val().trim(),e=`<label>订单编号：${u}</label><label style="float:right">日期：${f}</label>`,o=`<div>${e}${r}</div>`;printCode(o)}var _pasteData=null;let _departmentItem=null;let _stateDataTable=null,_Purchase=null;let _trChangeData=null;let _purchaseDataTable=null;