function pageReady(){$(".ms2").select2();$("#cgTime").val(getDate()).datepicker("update");getGroup();$("#groupSelect").on("select2:select",()=>getProcessor());$("#qgProcessor,#formState").on("select2:select",()=>getPurchase());$("#inWareList,#purchaseList").on("focus",".zeroNum",function(){$(this).val()==0&&$(this).val("")});$("#inWareList,#purchaseList").on("blur",".zeroNum",function(){isStrEmptyOrUndefined($(this).val())&&$(this).val(0)});$("#purchaseList").on("input",".taxTate",function(){onInput(this,2,2);const r=_purchaseDataTable.columns(5).data()[0],u=_purchaseDataTable.columns(6).data()[0],n=_purchaseDataTable.columns(9).nodes()[0];let t=0,i=0;for(let f=0,e=n.length;f<e;f++){const h=parseFloat($(n[f]).find(".taxTate").val().trim()||0)/100,e=u[f],o=r[f],s=e*h*o;i+=s;t+=s+e*o}$("#purchaseAmount").text(t.toFixed(2));$("#purchaseTax").text(i.toFixed(2))});$("#purchaseList").on("paste",n=>{if(n.originalEvent.clipboardData&&n.originalEvent.clipboardData.items){if(n.target.localName!="input"){const t=(n.originalEvent.clipboardData||window.clipboardData).getData("text");console.log([t]);const i=t.split("\n"),r=[];for(let n=0,t=i.length;n<t;n++){let t=i[n];isStrEmptyOrUndefined(t)||(t=t.split("\t"),r.push({Code:t[0]||"",Name:t[1]||"",Specification:t[2]||"",Unit:t[3]||"",Number:t[4]||0,Price:t[5]||0,TaxPrice:t[6]||0,TaxAmount:t[7]||0,TaxTate:t[8]||0}))}setPurchaseList(r)}n.stopPropagation();n.preventDefault()}});$("#departmentAll").on("ifChanged",function(){$(this).is(":checked")?$("#departmentItem .icb_minimal").iCheck("check"):_departmentItem.length==$("#departmentItem").children().length&&$("#departmentItem .icb_minimal").iCheck("uncheck")});$("#departmentItem").on("ifChanged",".icb_minimal",function(){const n=$(this).parents(".departmentLi")[0];if($(this).is(":checked")){_departmentItem.push(n);const t=$(n).find(".departmentText").prop("title");$(n).find(".departmentName").val(t).removeClass("hidden").end().find(".departmentText").addClass("hidden");_departmentItem.length==$("#departmentItem").children().length&&$("#departmentAll").iCheck("check")}else _departmentItem.splice(_departmentItem.indexOf(n),1),$(n).find(".departmentName").addClass("hidden").end().find(".departmentText").removeClass("hidden"),_departmentItem.length==$("#departmentItem").children().length-1&&$("#departmentAll").iCheck("uncheck")})}function setOptions(n,t){const r='<option value="{0}">{1}<\/option>';let i="";for(let u=0,f=n.length;u<f;u++){const f=n[u];i+=r.format(f.Id,f[t])}return i}function getGroup(){_departmentItem=[];const n={};n.opType=871;n.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",n,n=>{var t,f,r;if(n.errno!=0){layer.msg(n.errmsg);return}var i=n.datas,e=`<div class="flexStyle departmentLi">
                        <label class="flexStyle pointer">
                            <input type="checkbox" class="icb_minimal" value="{0}">
                            <span class="textOverTop departmentText" style="margin-left: 5px" title="{1}">{1}</span>
                        </label>
                        <input class="form-control hidden departmentName" maxlength="20" style="flex-basis:150px;margin-left:5px">
                      </div>`,u="";for(t=0,f=i.length;t<f;t++)r=i[t],u+=e.format(r.Id,r.Department);$("#departmentItem").empty().append(u);$("#departmentItem .icb_minimal").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"});$("#groupSelect").empty().append(setOptions(i,"Department"));getProcessor()})}function updateDepartment(){const t=_departmentItem.length;if(!t){layer.msg("请选择需要修改的请购部门");return}const i=[];for(let n=0;n<t;n++){const t=_departmentItem[n],u=$(t).find(".icb_minimal").val(),r=$(t).find(".departmentName").val().trim();if(isStrEmptyOrUndefined(r)){layer.msg("部门名不能为空");return}i.push({Id:u,Department:r})}const n={};n.opType=872;n.opData=JSON.stringify(i);ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#departmentAll").iCheck("uncheck");getGroup()})}function getProcessor(){const t=$("#groupSelect").val(),n={};n.opType=879;n.opData=JSON.stringify({dId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#qgProcessor,#cgProcessor").empty().append(setOptions(n.datas,"Member"));getPurchase()})}function getPurchase(){const t=$("#groupSelect").val();if(isStrEmptyOrUndefined(t)){layer.msg("请选择请购部门");return}const i=$("#qgProcessor").val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择请购人");return}const u=$("#formState").val(),r=$("#qgProcessor").val();if(isStrEmptyOrUndefined(r)){layer.msg("请选择核价人");return}const n={};n.opType=855;ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}var t=n.datas;_stateDataTable=$("#stateList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"text-center"i><"table-flex"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"ErpId",title:"编号"},{data:"Purchase",title:"名称"},{data:"Name",title:"请购人"},{data:"Valuer",title:"核价人"},{data:"StateStr",title:"状态"}],drawCallback:n=>{if(n.aoData.length){const t=$(n.nTBody).find("tr");t.addClass("pointer").off("click").on("click",function(){const t=n.aoData;for(let n=0,i=t.length;n<i;n++){const i=t[n].nTr;if($(i).css("background",""),i==this){const i=t[n]._aData;_Purchase={Id:i.Id,ErpId:i.ErpId,State:i.State,isShow:[3,4].includes(i.State)}}}$(this).css("background","#d9edf7").siblings("tr").css("background","");getPurchaseMaterial()})}}})})}function getPurchaseMaterial(){_trChangeData=[];const n={};n.opType=863;n.opData=JSON.stringify({pId:_Purchase.Id});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#inWareListSaveBtn,#finishInWareListBtn").prop("disabled",!_Purchase.isShow);const t=n.datas,i=n=>`<input class="form-control text-center count zeroNum" oninput="onInput(this, 8, 0)" onblur="onInputEnd(this)" onchange="inWareListChange.call(this)" style="width:80px" value=${n.Count} wid=${n.Id}>`;$("#inWareList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Unit",title:"单位"},{data:"Number",title:"数量",sClass:"text-red"},{data:"Purchaser",title:"采购人"},{data:"TaxPrice",title:"税后单价"},{data:"TaxAmount",title:"税后总价"},{data:"TaxTate",title:"税率（%)"},{data:"Price",title:"税前单价"},{data:"Stock",title:"已入库",sClass:"text-red"},{data:null,title:"本次入库",render:i,visible:_Purchase.isShow}]})})}function inWareListChange(){const n=$(this).parents("tr")[0];_trChangeData.includes(n)||_trChangeData.push(n)}function inWareListSave(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购和仓库到货才能入库");return}const i=_Purchase.Id,t=[];for(let n=0,r=_trChangeData.length;n<r;n++){const r=$(_trChangeData[n]).find(".count");t.push({Id:r.attr("wid")>>0,Count:r.val()>>0,PurchaseId:i})}const n={};n.opType=867;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&getPurchaseMaterial()})}function finishInWareList(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购和仓库到货才能完成采购");return}const n=function(){let n={};n.opType=859;n.opData=JSON.stringify([{Id:_Purchase.Id}]);ajaxPost("/Relay/Post",n,t=>{if(layer.msg(t.errmsg),t.errno==0){n=_stateDataTable.context[0].aoData;for(let t=0,i=n.length;t<i;t++){const i=n[t]._aData.Id;if(i==_Purchase.Id){const i=n[t].nTr;$(i).find("td:last").text("订单完成");n[t]._aData.State=5;_Purchase.State=5;_Purchase.isShow=!1;getPurchaseMaterial();break}}}})};showConfirm("完成采购订单",n)}function citePurchaseList(){if(!_Purchase){layer.msg("请购单为空");return}const t=_Purchase.Id;$("#purchaseCode").val(_Purchase.ErpId);const n={};n.opType=863;n.opData=JSON.stringify({pId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}setPurchaseList(n.datas)})}function setPurchaseList(n){const t=n=>`<input class="form-control text-center taxTate zeroNum" onblur="onInputEnd(this)" style="width:80px" value=${n}>`;_purchaseDataTable=$("#purchaseList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n,aaSorting:[[0,"asc"]],aLengthMenu:[10,40,60],iDisplayLength:10,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Unit",title:"单位"},{data:"Number",title:"数量"},{data:"Price",title:"税前单价",visible:!1},{data:"TaxPrice",title:"单价"},{data:"TaxAmount",title:"合计"},{data:"TaxTate",title:"税率（%)",render:t}],initComplete:function(){let t=0,i=0;for(let r=0,u=n.length;r<u;r++){const u=n[r],f=u.TaxAmount;t+=f;i+=f-u.Number*u.Price}const r=`<tfoot>
                                  <tr>
                                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                    <th>合计：</th>
                                    <th id="purchaseAmount">${t}</th>
                                  </tr>
                                    <tr>
                                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                                    <th>税额：</th>
                                    <th id="purchaseTax">${i.toFixed(2)}</th>
                                  </tr>
                               </tfoot>`;this.find("tfoot").remove();this.append(r);this.find("tfoot tr:last th").css("borderTop",0)}})}function resetPurchaseList(){$("#purchaseCode").val("");_purchaseDataTable&&(_purchaseDataTable.destroy(),_purchaseDataTable=null,$("#purchaseList").empty())}function printPurchaseList(){if(!_purchaseDataTable){layer.msg("入库单为空");return}const i=$("#purchaseList tfoot").prop("outerHTML");let n="";const t=_purchaseDataTable.context[0].aoData;for(let i=0,r=t.length;i<r;i++){const r=t[i],e=$(r.nTr).find(".taxTate").val().trim(),u=r._aFilterData;let f="";for(let n=0,t=u.length-1;n<t;n++)n===6&&n++,f+=`<td>${u[n]}</td>`;n+=`<tr>${f}<td>${e}</td></tr>`}const r=`<table border="1" style="width:100%;text-align:center;border-collapse:collapse">${"<thead><tr><th>序号<\/th><th>物料编码<\/th><th>物料名称<\/th><th>规格<\/th><th>单位<\/th><th>数量<\/th><th>单价<\/th><th>合计<\/th><th>税率（%)<\/th><\/tr><\/thead>"}<tbody>${n}</tbody>${i}</table>`,u=$("#purchaseCode").val().trim(),f=$("#cgTime").val().trim(),e=`<label>订单编号：${u}</label><label style="float:right">日期：${f}</label>`,o=`<div>${e}${r}</div>`;printCode(o)}let _departmentItem=null;let _stateDataTable=null,_Purchase=null;let _trChangeData=null;let _purchaseDataTable=null;