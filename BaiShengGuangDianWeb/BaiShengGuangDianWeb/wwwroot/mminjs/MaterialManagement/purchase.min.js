function pageReady(){$(".sidebar-mini").addClass("sidebar-collapse");_permissionList[589]={uIds:["updateDepartmentBtn"]};_permissionList[590]={uIds:["finishInWareListBtn"]};_permissionList[591]={uIds:["citePurchaseListBtn"]};_permissionList[592]={uIds:["printPurchaseListBtn"]};_permissionList[593]={uIds:["inWareListSaveBtn"]};_permissionList[594]={uIds:["changePurchaseBtn"]};_permissionList=checkPermissionUi(_permissionList);$(".ms2").select2();$("#cgTime").val(getDate()).datepicker("update");new Promise(n=>getValuer(n)).then(()=>getGroup());$("#groupSelect").on("select2:select",()=>getProcessor());$("#qgProcessor,#formState,#cgProcessor").on("select2:select",()=>getPurchase());$("#formState,#cgProcessor").on("change",()=>getPurchase());$("#inWareList,#purchaseList").on("focus",".zeroNum",function(){$(this).val()==0&&$(this).val("")});$("#inWareList,#purchaseList").on("blur",".zeroNum",function(){isStrEmptyOrUndefined($(this).val())&&$(this).val(0)});$("#purchaseList").on("focus",".numZero",function(){$(this).text().trim()==0&&$(this).text("")});$("#purchaseList").on("blur",".numZero",function(){isStrEmptyOrUndefined($(this).text().trim())&&$(this).text(0)});$("#purchaseList").on("input",".taxRate",function(){onInput(this,2,2);tFootTrCount.call(this)});$("#purchaseList").on("input",".numZero",function(){onInput(this,6,6);tFootTrCount.call(this)});$("#purchaseList").on("input",".tax-amount",function(){onInput(this,6,6);tFootTrCount.call(this,!0)});$("#departmentAll").on("ifChanged",function(){$(this).is(":checked")?$("#departmentItem .icb_minimal").iCheck("check"):_departmentItem.length==$("#departmentItem").children().length&&$("#departmentItem .icb_minimal").iCheck("uncheck")});$("#departmentItem").on("ifChanged",".icb_minimal",function(){const n=$(this).parents(".departmentLi")[0];$(this).is(":checked")?(_departmentItem.push(n),_departmentItem.length==$("#departmentItem").children().length&&$("#departmentAll").iCheck("check")):(_departmentItem.splice(_departmentItem.indexOf(n),1),_departmentItem.length==$("#departmentItem").children().length-1&&$("#departmentAll").iCheck("uncheck"))});const n=dataTableConfig(0,!0,_changePurchase);n.dom='<"pull-left"l><"pull-right"f>rt<"text-center"i><"table-flex"p>';const t=n=>{let t="";switch(n.State){case 1:t="#C9C9C9";break;case 2:t="#1890FF";break;case 3:t="#f00";break;case 4:t="#f90";break;case 5:t="#008000"}return`<span style="color:${t}">${n.StateStr}</span>`},i=n=>(n=n||"",n.length>6?`<span title="${n}">${n.slice(0,6)}...</span>`:n);n.addColumns([{data:"ErpId",title:"编号",sWidth:"20px"},{data:"Purchase",title:"名称",sWidth:"100px",render:i},{data:"Name",title:"请购人",sWidth:"20px"},{data:"Valuer",title:"核价人",sWidth:"20px"},{data:null,title:"状态",sWidth:"20px",render:t}]);n.createdRow=function(n,t){$(n).attr("id",t.Id)};n.drawCallback=function(n){if(initCheckboxAddEvent.call(this,_purchaseTrs),n.aoData.length){const t=$(n.nTBody).find("tr");t.addClass("pointer").off("click").on("click",function(){resetPurchaseList();const t=n.aoData;for(let n=0,i=t.length;n<i;n++){const i=t[n].nTr;if($(i).css("background",""),i==this){const i=t[n]._aData;_Purchase={Id:i.Id,ErpId:i.ErpId,State:i.State,isShow:[3,4,7].includes(i.State),name:i.Name};$("#citePurchaseListBtn").prop("disabled",i.State!=5);i.IsQuote?(getQuoteList(!0),$("#addPurchaseListBtn").removeClass("hidden")):$("#addPurchaseListBtn").addClass("hidden");getPurchaseMaterial()}}$(this).css("background","#d9edf7").siblings("tr").css("background","")})}};_stateDataTable=$("#stateList").DataTable(n);$("#stateList").addClass("hidden")}function tFootTrCount(n){const t=$(this).parents("tr"),i=_purchaseDataTable.row(t).data();if(!n){const u=parseFloat(t.find(".taxRate").val())||0;let f=i.Price,n=i.TaxPrice;f=i.TaxRate==u?i.Price:parseFloat((n*100/(100+u)).toFixed(6));t.find(".price").text(f);const r=parseFloat(t.find(".number").text())||0;let e=parseFloat((r*n).toFixed(6));i.Number==r&&(e=parseFloat((r*n).toFixed(6)));t.find(".tax-amount").text(e)}tFootCount()}function tFootCount(){const n=_purchaseDataTable.rows().nodes().map(n=>$(n).find(".number").text()>>0),i=_purchaseDataTable.rows().nodes().map(n=>$(n).find(".price").text()),r=_purchaseDataTable.rows().nodes().map(n=>$(n).find(".tax-amount").text()),u=_purchaseDataTable.rows().nodes().map(n=>$(n).find(".taxRate").val()),t=[];for(let f=0,e=n.length;f<e;f++)t[f]={Number:n[f],Price:i[f],TaxAmount:r[f],TaxRate:u[f]};computePrice(t)}function pasteTable(n){if(n.originalEvent.clipboardData&&n.originalEvent.clipboardData.items){if(n.target.localName!="input"&&$(n.target).prop("contenteditable")!="true"){const r=(n.originalEvent.clipboardData||window.clipboardData).getData("text"),t=r.split("\n"),i=[];if(_pasteData)for(let n=0,r=_pasteData.length;n<r;n++){const r=_pasteData[n];t[n]?r.push(...t[n].split("\t")):r.push(...new Array(t[0].split("\t").length).fill(""));i.push({Id:0,ItemId:0,Order:r[0]||"",Code:r[1]||"",Name:r[2]||"",Specification:r[3]||"",Class:r[4]||"",Supplier:r[5]||"",Unit:r[6]||"",Number:r[7]||"",Price:r[8]||"",TaxPrice:r[9]||"",TaxAmount:r[10]||"",TaxRate:r[11]||0})}else{_pasteData=[];for(let n=0,r=t.length;n<r;n++){let r=t[n];isStrEmptyOrUndefined(r)||(r=r.split("\t"),_pasteData[n]=r,i.push({Id:0,ItemId:0,Order:r[0]||"",Code:r[1]||"",Name:r[2]||"",Specification:r[3]||"",Class:r[4]||"",Supplier:r[5]||"",Unit:r[6]||"",Number:r[7]||"",Price:r[8]||"",TaxPrice:r[9]||"",TaxAmount:r[10]||"",TaxRate:r[11]||0}))}}setPurchaseList(i);for(let n=0,t=_pasteData.length;n<t;n++)if(_pasteData[n].length>8){_pasteData=null;break}}n.stopPropagation();n.preventDefault()}}function getGroup(n){_departmentItem=[];const t={};t.opType=871;t.opData=JSON.stringify({menu:!0});ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas,f=`<div class="flexStyle departmentLi">
                        <label class="flexStyle pointer">
                            <input type="checkbox" class="icb_minimal {2}" value="{0}">
                            <span class="textOverTop departmentText" style="margin-left: 5px" title="{1}">{1}</span>
                        </label>
                        <input class="form-control hidden departmentName" maxlength="20" style="flex-basis:150px;margin-left:5px">
                      </div>`,e='<option value="{0}">{1}<\/option>';let r="",u="";for(let n=0,t=i.length;n<t;n++){const t=i[n];r+=f.format(t.Id,t.Department,t.Get?"isget":"");t.Get&&(u+=e.format(t.Id,t.Department))}$("#departmentItem").empty().append(r);$("#departmentItem .icb_minimal").iCheck({handle:"checkbox",checkboxClass:"icheckbox_minimal-green",increaseArea:"20%"});$("#departmentItem .isget").iCheck("check");$("#groupSelect").empty().append(u);n?$("#groupSelect").val(n).trigger("change"):getProcessor()})}function updateDepartment(){const t=[],i=$("#departmentItem .departmentLi"),r=$("#groupSelect").val();let u=!1;for(let n=0,f=i.length;n<f;n++){const f=i.eq(n),e=f.find(".icb_minimal"),o=e.val(),s=e.is(":checked");r==o&&s&&(u=!0);t.push({Id:o,Get:s,Department:f.find(".departmentText").prop("title")})}const n={};n.opType=872;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&getGroup(u?r:null)})}function getProcessor(){const t=$("#groupSelect").val(),n={};n.opType=879;n.opData=JSON.stringify({dId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}$("#qgProcessor").empty().append(`<option value="-1">全部</option>${setOptions(n.datas,"Member")}`);getPurchase()})}function getValuer(n){const t={};t.opType=887;ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}$("#cgProcessor").empty().append(`<option value="-1">全部</option>${setOptions(t.datas,"Valuer")}`);n("success")})}function changePurchase(n){_stateDataTable.columns(0).visible(!_changePurchase);_changePurchase?(_purchaseTrs=[],$(n).addClass("btn-warning").removeClass("btn-danger").text("状态"),$(n).siblings(".update").addClass("hidden")):(_stateDataTable.page(_stateDataTable.page()).draw(!1),$(n).removeClass("btn-warning").addClass("btn-danger").text("取消"),$(n).siblings(".update").removeClass("hidden"));_changePurchase=!_changePurchase}function changePurchaseState(){if(_purchaseTrs.length!=0){const t=_purchaseTrs.map(n=>({Id:$(n).find("input").val()>>0})),n={};n.opType=856;n.opData=JSON.stringify(t);ajaxPost("/Relay/Post",n,n=>{layer.msg(n.errmsg),n.errno==0&&getPurchase()})}}function getPurchase(){_purchaseTrs=[];_inWareDataTable&&(_inWareDataTable.destroy(),_inWareDataTable.clear(),_inWareDataTable=null,$("#inWareList").empty());resetPurchaseList();$("#inWareListSaveBtn,#finishInWareListBtn,#citePurchaseListBtn").prop("disabled",!0);const i=$("#groupSelect").val();if(isStrEmptyOrUndefined(i)){layer.msg("请选择请购部门");return}const n={dId:i},r=$("#qgProcessor").val();if(isStrEmptyOrUndefined(r)){layer.msg("请选择请购人");return}~r&&(n.name=$("#qgProcessor :selected").text());const u=$("#formState").val();~u&&(n.state=u);const f=$("#cgProcessor").val();if(isStrEmptyOrUndefined(f)){layer.msg("请选择核价人");return}~f&&(n.valuer=$("#cgProcessor :selected").text());n.order=$("#cgOrder").val();const t={};t.opType=855;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas;$("#stateList").removeClass("hidden");updateTable(_stateDataTable,t)})}function getQuoteList(n){const t={};t.opType=860;t.opData=JSON.stringify({pId:_Purchase.Id});ajaxPost("/Relay/Post",t,t=>{if(t.errno!=0){layer.msg(t.errmsg);return}const i=t.datas;$("#cgTime").val(i.length?i[0].Time.split(" ")[0]:getDate()).datepicker("update");setPurchaseList(i,n)})}function updatePurchaseList(){if(!_purchaseDataTable||!_purchaseDataTable.data().length){layer.msg("入库单为空");return}const t=$("#purchasingCompany").val().trim();let n=$("#cgTime").val();if(isStrEmptyOrUndefined(n)){layer.msg("请选择入库日期");return}if(n+=` ${getTime()}`,exceedTime(n)){layer.msg("入库日期大于当前时间");return}const i=_purchaseDataTable.rows().nodes(),u=_purchaseDataTable.columns(0).data()[0],r=[];for(let f=0,e=i.length;f<e;f++){const y=i[f],e=$(y).find("td"),p=u[f],o=f+1,s=1,w=e.eq(s+1).text().trim();if(isStrEmptyOrUndefined(w)){layer.msg(`序列${o}：订单编号不能为空`);return}const b=e.eq(s+2).text().trim();if(isStrEmptyOrUndefined(b)){layer.msg(`序列${o}：物料编码不能为空`);return}const k=e.eq(s+3).text().trim();if(isStrEmptyOrUndefined(k)){layer.msg(`序列${o}：物料名称不能为空`);return}const d=e.eq(s+4).text().trim();if(isStrEmptyOrUndefined(d)){layer.msg(`序列${o}：规格不能为空`);return}const g=e.eq(s+5).text().trim();if(isStrEmptyOrUndefined(g)){layer.msg(`序列${o}：类别不能为空`);return}const nt=e.eq(s+6).text().trim();if(isStrEmptyOrUndefined(nt)){layer.msg(`序列${o}：供应商不能为空`);return}const tt=e.eq(s+7).text().trim();if(isStrEmptyOrUndefined(tt)){layer.msg(`序列${o}：单位不能为空`);return}const h=e.eq(s+8).text().trim();if(h!=parseFloat(h)){layer.msg(`序列${o}：数量不合法`);return}const c=e.eq(s+9).text().trim();if(c!=parseFloat(c)){layer.msg(`序列${o}：税前单价不合法`);return}const l=e.eq(s+10).text().trim();if(l!=parseFloat(l)){layer.msg(`序列${o}：税后单价不合法`);return}const a=e.eq(s+11).text().trim();if(a!=parseFloat(a)){layer.msg(`序列${o}：合计不合法`);return}const it=e.eq(s+13).text().trim();if(isStrEmptyOrUndefined(it)){layer.msg(`序列${o}：采购人不能为空`);return}let v=e.eq(s+14).text().trim();if(t!=""&&(v=t),isStrEmptyOrUndefined(v)){layer.msg(`序列${o}：采购公司不能为空`);return}r[f]={Purchase:_Purchase.ErpId,Order:w,Time:n,ItemId:p.ItemId,Id:p.Id,PurchaseId:_Purchase.Id,Code:b,Name:k,Specification:d,Class:g,Supplier:nt,Unit:tt,Purchaser:it,Number:h,Price:c,TaxPrice:l,TaxAmount:a,TaxRate:$(y).find(".taxRate").val().trim(),PurchasingCompany:v}}const f={Id:_Purchase.Id,Items:r},e=function(){let n={};n.opType=861;n.opData=JSON.stringify(f);ajaxPost("/Relay/Post",n,t=>{if(layer.msg(t.errmsg),t.errno==0){n=_stateDataTable.context[0].aoData;for(let t=0,i=n.length;t<i;t++){const i=n[t]._aData.Id;if(i==_Purchase.Id){n[t]._aData.IsQuote=!0;break}}getQuoteList(!0)}})};showConfirm("保存",e)}function getPurchaseMaterial(){_trChangeData=[];const n={};n.opType=863;n.opData=JSON.stringify({pId:_Purchase.Id});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas;$("#inWareListSaveBtn").prop("disabled",!(t.some(n=>n.ErpId!==0)&&_Purchase.isShow));$("#finishInWareListBtn").prop("disabled",!_Purchase.isShow);const i=n=>`<input class="form-control text-center count zeroNum" oninput="onInput(this, 10, 3)" onblur="onInputEnd(this)" onchange="inWareListChange.call(this)" style="width:80px" value=${n.Count} wid=${n.Id} bill=${n.BillId}>`;_inWareDataTable=$("#inWareList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:t,aaSorting:[[0,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Order",title:"订单编号"},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Supplier",title:"供应商"},{data:"Unit",title:"单位"},{data:"Purchaser",title:"采购人"},{data:"Number",title:"数量",sClass:"text-red"},{data:"Stock",title:"已入库",sClass:"text-blue"},{data:null,title:"本次入库",render:i,visible:_Purchase.isShow},{data:null,title:"入库编码",sClass:"text-green",render:n=>`<span class="${!isStrEmptyOrUndefined(n.ThisCode)&&n.ThisCode!=n.Code?"text-red text-bold":"text-green"}">${n.ThisCode}</span>`},{data:"TaxPrice",title:"税后单价"},{data:"TaxAmount",title:"税后总价"},{data:"TaxRate",title:"税率（%)"},{data:"Price",title:"税前单价"}]})})}function inWareListChange(){const n=$(this).parents("tr")[0];_trChangeData.includes(n)||_trChangeData.push(n)}function inWareListSave(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购,已入库,仓库到货才能入库");return}const i=_Purchase.Id,n=[];for(let t=0,r=_trChangeData.length;t<r;t++){const r=$(_trChangeData[t]).find(".count"),u=r.val()>>0;u&&n.push({Id:r.attr("wid")>>0,Count:u,PurchaseId:i,BillId:r.attr("bill")>>0})}if(n.length){const t={};t.opType=867;t.opData=JSON.stringify(n);ajaxPost("/Relay/Post",t,n=>{layer.msg(n.errmsg),n.errno==0&&getPurchaseMaterial()})}}function finishInWareList(){if(!_trChangeData){layer.msg("请购单为空");return}if(!_Purchase.isShow){layer.msg("开始采购,已入库,仓库到货才能完成采购");return}const n=function(){let n={};n.opType=859;n.opData=JSON.stringify([{Id:_Purchase.Id}]);ajaxPost("/Relay/Post",n,t=>{if(layer.msg(t.errmsg),t.errno==0){n=_stateDataTable.context[0].aoData;for(let t=0,i=n.length;t<i;t++){const i=n[t]._aData.Id;if(i==_Purchase.Id){const i=n[t].nTr;if(~$("#formState").val()){const n=$(i).find("td:first").text()>>0;_stateDataTable.row(i).remove().draw(!1);_stateDataTable.column(0).nodes().each(t=>{const i=$(t).text()>>0;i>n&&$(t).text(i-1)})}else $(i).find("td:last").text("订单完成").css("color","#008000"),n[t]._aData.State=5;_Purchase.State=5;_Purchase.isShow=!1;getPurchaseMaterial();break}}$("#citePurchaseListBtn").prop("disabled",!1)}})};showConfirm("完成采购订单",n)}function citePurchaseList(){if(!_Purchase){layer.msg("请购单为空");return}const t=_Purchase.Id,n={};n.opType=863;n.opData=JSON.stringify({pId:t});ajaxPost("/Relay/Post",n,n=>{if(n.errno!=0){layer.msg(n.errmsg);return}const t=n.datas;for(let n=0,i=t.length;n<i;n++){const i=t[n];i.ItemId=i.Id;i.Number=i.Stock;i.TaxPrice=i.TaxPrice;i.TaxAmount=i.Number>0&&i.Number==i.Stock?i.TaxAmount:parseFloat(floatObj.multiply(i.Stock,i.TaxPrice).toFixed(6));i.Id=0}_pasteData=null;setPurchaseList(t)})}function setPurchaseList(n,t){t?$("#addPurchaseListBtn").removeClass("hidden"):$("#addPurchaseListBtn").addClass("hidden");const r=n=>`<input class="form-control text-center taxRate zeroNum" onblur="onInputEnd(this)" 
                            style="width:80px" value=${parseFloat(n.TaxRate)||0} old=${parseFloat(n.TaxRate)||0} taxAmount=${n.TaxAmount}>`,u=()=>`<button type="button" class="btn btn-danger btn-sm" onclick="delPurchaseTr.call(this)"><i class="fa fa-minus"></i></button>`;$("#purchasingCompany").val("");var f=distinct(n.map(n=>n.Order)),e=n.length,i=0;_purchaseDataTable=$("#purchaseList").DataTable({dom:'<"pull-left"l><"pull-right"f>rt<"col-sm-5"i><"col-sm-7"p>',destroy:!0,paging:!0,searching:!0,language:oLanguage,data:n,aaSorting:[[1,"asc"]],aLengthMenu:[20,40,60],iDisplayLength:20,columns:[{data:null,title:"全选<input type='checkbox' class='icb_minimal' id='checkAll'>",render:()=>`<input type="checkbox" class="icb_minimal isEnable">`,orderable:!1},{data:null,title:"序号",render:(n,t,i,r)=>++r.row},{data:"Order",title:"订单编号",sClass:"order text-bold"},{data:"Code",title:"物料编码"},{data:"Name",title:"物料名称"},{data:"Specification",title:"规格"},{data:"Class",title:"类别"},{data:"Supplier",title:"供应商"},{data:"Unit",title:"单位"},{data:"Number",title:"数量",sClass:"numZero number"},{data:"Price",title:"税前单价",sClass:"numZero price"},{data:"TaxPrice",title:"税后单价",sClass:"tax-price"},{data:"TaxAmount",title:"合计",sClass:"tax-amount"},{data:null,title:"税率（%)",render:r},{data:"Purchaser",title:"采购人"},{data:"PurchasingCompany",title:"采购公司"},{data:null,title:"删除",render:u,visible:!!t}],drawCallback:function(){t?$("#purchaseList tbody tr td:not(:nth-child(1),:nth-child(11),:nth-child(12))").prop("contenteditable",!0):$("#purchaseList tbody tr td:nth-child(10)").prop("contenteditable",!0);$("#purchaseList td").css("padding","3px");$("#purchaseList .icb_minimal").iCheck({checkboxClass:"icheckbox_minimal-red",radioClass:"iradio_minimal",increaseArea:"20%"}).on("ifChanged",function(){$(this).is(":checked")?i++:(i--,$("#checkAll").iCheck("uncheck"))});$("#checkAll").on("ifChanged",function(){$(this).is(":checked")?$("#purchaseList .icb_minimal").iCheck("check"):e==i&&$("#purchaseList .icb_minimal").iCheck("uncheck")});$("#checkAll").is(":checked")&&$("#purchaseList .icb_minimal").iCheck("check")},initComplete:function(){t?$("#purchaseList").off("paste"):$("#purchaseList").off("paste").on("paste",pasteTable);const i=`<tfoot>
                              <tr>
                                <th colspan="11"></th>
                                <th>合计：</th>
                                <th id="purchaseAmount"></th>
                              </tr>
                              <tr>
                                <th colspan="11"></th>
                                <th>税额：</th>
                                <th id="purchaseTax"></th>
                              </tr>
                           </tfoot>`;this.find("tfoot").remove();this.append(i);computePrice(n);this.find("tfoot tr:last th").css("borderTop",0)},createdRow:function(n,t){const i=f.indexOf(t.Order);$(n).find(`.order`).css("color",optionColors[i>optionColors.length?i%optionColors.length:i])}})}function computePrice(n){let t=0,i=0;for(let r=0,u=n.length;r<u;r++){const u=n[r];isStrEmptyOrUndefined(u.TaxRate)&&(u.TaxRate=0);t=decimalObj.add(t,u.TaxAmount);i=decimalObj.add(i,decimalObj.divide(decimalObj.multiply(u.TaxAmount,u.TaxRate),decimalObj.add(100,u.TaxRate)))}$("#purchaseAmount").text(t?parseFloat(t.toFixed(6)):0);$("#purchaseTax").text(i?parseFloat(i.toFixed(6)):0)}function addPurchaseTr(){_purchaseDataTable.row.add({Id:0,ItemId:0,Order:"",Code:"",Name:"",Specification:"",Class:"",Supplier:"",Unit:"",Number:0,Price:0,TaxPrice:0,TaxAmount:0,TaxRate:0}).draw(!1)}function delPurchaseTr(){const n=$(this).parents("tr")[0],t=$(n).find("td:first").text()>>0;_purchaseDataTable.row(n).remove().draw(!1);_purchaseDataTable.column(0).nodes().each(n=>{const i=$(n).text()>>0;i>t&&$(n).text(i-1)});tFootCount()}function resetPurchaseList(){$("#purchasingCompany").val("");$("#addPurchaseListBtn").addClass("hidden");_purchaseDataTable&&(_pasteData=null,_purchaseDataTable.destroy(),_purchaseDataTable.clear(),_purchaseDataTable=null,$("#purchaseList").empty())}function printPurchaseList(){if(!_purchaseDataTable||!_purchaseDataTable.data().length){layer.msg("入库单为空");return}let n=$("#purchasingCompany").val().trim(),u="";const t=[],i=_purchaseDataTable.rows().nodes();for(let n=0,r=i.length;n<r;n++){const f=$(i[n]),r=f.find("td");if(r.eq(0).find(".isEnable").is(":checked")){const n=r.eq(2).text().trim();u.includes(n)||(u+=`<option value=${n}>${n}</option>`);t.includes(n)||t.push(n)}}const f=t.length;if(f<=0){layer.msg("请选择订单号");return}const o=$("#checkAll").is(":checked");let e="";for(var r=0;r<f;r++){const h=t[r];let f="";const c=[3,4,5,6,8,9,10];let l=0,u=0,a="";for(let t=0,r=i.length;t<r;t++){const e=$(i[t]),r=e.find("td");if((o||r.eq(0).find(".isEnable").is(":checked"))&&r.eq(2).text().trim()==h){n==""&&(n=r.eq(15).text().trim());l++;let t=`<td>${l}</td>`;for(let n=0,i=c.length;n<i;n++)t+=r.eq(c[n]).prop("outerHTML");const e=floatObj.multiply(parseFloat(r.eq(9).text().trim()),parseFloat(r.eq(10).text().trim())).toFixed(2);t+=`<td>${e}</td>`;const i=parseFloat(r.eq(12).text().trim());u=floatObj.add(u,i);t+=`<td>${floatObj.subtract(i,e).toFixed(2)}</td>`;t+=`<td>${i.toFixed(2)}</td>`;t+=`<td>${_Purchase.name}</td>`;f+=`<tr style="height:40px">${t}</tr>`;a=r.eq(7).text().trim()}}if(isStrEmptyOrUndefined(n)){layer.msg("采购公司不能为空");return}f+='<tr style="height:40px"><td>备注：<\/td><td colspan="11"><\/td><\/tr>';u=u.toFixed(2);f+=`<tr style="height:40px"><td colspan="8">合计金额：${convertCurrency(u)}</td><td colspan="4">￥${u}</td></tr>`;const v=`<table border="1" style="width:100%;text-align:center;border-collapse:collapse">${"<thead><tr><th>编号<\/th><th>物料编码<\/th><th>名称<\/th><th>类别<\/th><th>规格<\/th><th>单位<\/th><th>入库数量<\/th><th>单价<\/th><th>不含税金额<\/th><th>税额<\/th><th>合计金额<\/th><th>请购人<\/th><\/tr><\/thead>"}<tbody>${f}</tbody></table>`;let s=$("#cgTime").val().trim();const y=["年","月","日"];s&&(s=s.split("-").map((n,t)=>`${n}${y[t]}`).join(""));const p=`<div style="text-align:center">${n}</div><h3 style="text-align:center;margin:5px;letter-spacing:8px">采购入库单</h3>`,w=`<div style="text-align:right">订单号：${h}</div>`,b=`<div style="position:absolute;right:0">供应商：${a}</div><div style="text-align:center;width:100%">日期：${s}</div>`,k=`<div style="display:flex;margin:8px 0"><label style="flex:1">主管：</label><label style="flex:1">仓库：<span style="margin-left:20px">${getCookieTokenInfo().name}</span></label><label style="flex:1">记账：</label><label style="flex:1">采购人：<span style="margin-left:20px">${_purchaseDataTable.data()[0].Purchaser||""}</span></label></div>`;e+=`<div style="position:relative">${p}${w}${b}${v}${k}</div>`}printCode(e)}var _permissionList=[],_pasteData;let _stateDataTable=null;_pasteData=null;let _departmentItem=null;let _changePurchase=!1,_purchaseTrs=[];let _Purchase=null,_inWareDataTable=null;let _trChangeData=null;let _purchaseDataTable=null;